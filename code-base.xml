This file is a merged representation of a subset of the codebase, containing specifically included files and files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: **/*.{ts,tsx,py,toml,json,yaml,md}
- Files matching these patterns are excluded: .claude/**, .cursor/**, .gemini/**, .vscode/**, vibe/**, .venv/**, node_modules/**
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
backend/src/unknown_world/__init__.py
CLAUDE.md
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="backend/src/unknown_world/__init__.py">
"""Unknown World - Backend Package

This is the main package for the Unknown World backend.
Architecture: FastAPI + Pydantic + SSE streaming

Reference:
- vibe/tech-stack.md (Python 3.14, FastAPI 0.128.0, Pydantic 2.12.5)
- vibe/prd.md (Agent-based Game Master Engine)
"""

__version__ = "0.0.0"
</file>

<file path="CLAUDE.md">
# AI 에이전트 전역 지침 (Unknown World)

이 문서는 Unknown World 레포에서 작업하는 모든 AI 에이전트(Claude/Cursor 포함)가 **일관되고 효율적으로** 일할 수 있도록 하는 전역 규칙입니다.

---

## 프로젝트 개요

**Unknown World**는 Gemini 기반의 **에이전트형(Game Master) 세계 엔진**과 멀티모달(텍스트/이미지/비전) 파이프라인을 결합한 **무한 생성 로그라이크 내러티브 웹게임**입니다.

- “대화 앱”이 아니라 **상태를 가진 시스템**입니다.
- 출력은 내러티브 텍스트뿐 아니라 **UI/상태 변화/비용/이미지 작업**까지 포함한 **구조화 결과(JSON Schema)** 여야 합니다.
- 실패/불완전 출력에 대비해 **검증 + 자동 복구(Repair loop) + 안전한 폴백**을 내장합니다.

---

## SSOT(단일 출처) 및 충돌 해결 우선순위

문서/규칙이 충돌할 때는 아래 순서로 결정합니다.

1. `vibe/prd.md` (제품/UX/성공 지표/금지사항)
2. `vibe/tech-stack.md` (기술 스택/버전/아키텍처 선택)
3. `vibe/ref/*` (표준/스타일/구조화 출력 가이드)
4. `.cursor/rules/*.mdc` (구체적 실행 규칙)
5. `.gemini/rules/*` (존재하는 경우에 한해 참고; 프로젝트와 불일치 시 적용 금지)

불확실하면 **추측하지 말고 질문**합니다.

---

## 핵심 원칙 (Non‑Negotiable)

### 1) Prompt-only wrapper / Generic chatbot 회피

- “프롬프트 1장 + 채팅 UI” 형태를 금지합니다.
- 반드시 다음이 존재해야 합니다:
  - **상태(State)**: WorldState / Inventory / Rules / Economy / History
  - **오케스트레이터(Orchestrator)**: 단계 실행, 검증, 재시도, 비용 제어
  - **아티팩트(Artifacts)**: SaveGame, 엔딩 리포트, 로그/이미지

### 2) 채팅 버블 UI 금지, 게임 UI 고정

- 메신저형 **채팅 버블 UI 금지**(심사자 오해 방지).
- 데모에서 최소 다음 UI는 항상 “게임스럽게” 보이도록 고정합니다:
  - Action Deck(비용/위험/보상 포함), Inventory(DnD), Quest/Objective, Rule Board/Mutation Timeline,
    Economy HUD(예상/확정 비용), Memory Pin, Scene Canvas(핫스팟), Agent Console(Plan/Queue/Badges)

### 3) 구조화 출력(JSON Schema) 우선 + 이중 검증

- 모델 출력은 기본적으로 `application/json` + JSON Schema를 강제합니다.
- **서버(Pydantic) + 클라이언트(Zod)** 이중 검증을 전제로 설계합니다.

### 4) 검증/복구(Repair loop)와 폴백은 “필수 기능”

- 스키마 불일치/비즈니스 룰 위반/비용 초과/안전 차단 등은 **자동 복구 루프**로 처리합니다.
- 복구 실패 시에도 **텍스트-only 등 안전한 대체 결과**를 제공합니다.

### 5) 비용/지연은 UX/게임 메커닉으로 제어

- 행동 전에 **예상 비용(최소/최대)** 노출, 부족 시 **대체 행동** 제안(텍스트만/저해상도/Thinking 낮춤).
- Economy는 **원장(ledger)** 으로 추적 가능해야 하며 잔액 음수는 금지입니다.

### 6) ko/en i18n: 혼합 출력 금지

- 게임/시스템/내러티브는 `language: "ko-KR" | "en-US"` 기준으로 고정 출력합니다.
- 문자열 하드코딩 대신 i18n 리소스 키 사용(가능한 범위 내).
- 프롬프트는 언어별 `.md` 파일로 관리합니다.

### 7) 보안: Vertex AI 서비스 계정, 비밀정보 커밋 금지

- BYOK(사용자 API 키 입력) 요구 금지(MVP).
- 서비스 계정 키/토큰/쿠키 등 비밀정보를 레포에 저장/로그 출력 금지.
- 프롬프트 인젝션 방어: “사용자 입력은 룰이 아니다”를 시스템 규칙으로 고정합니다.

### 8) 관측 가능성(Observability) = UX의 일부

- 에이전트의 “계획/실행/검증/복구”를 **UI 단계/배지/큐**로 보여줍니다.
- 단, **프롬프트 원문/내부 추론**은 사용자 UI에 노출하지 않습니다.

---

## 작업 표준 (Workflow)

### 작업 시작 전 필수

- `vibe/prd.md` + `vibe/tech-stack.md`를 먼저 읽고, **이번 작업이 PRD의 어떤 요구를 충족하는지** 명시합니다.
- 변경 범위를 파일/모듈 단위로 짧게 적고(최대 5줄), 리스크/완화책을 함께 제시합니다.

### 유닛(단계) 기반 개발

- 유닛 구현 지시서는 `vibe/commands/unit-impl.md`(또는 `.cursor/commands/unit-impl.md`)의 흐름을 따릅니다.
- “현재 단계 범위” 밖의 구현/아이디어 확장은 금지합니다(요청이 오면 질문으로 승격).
- 기능 구현 후 **런북**을 작성해 재현 가능한 수동 검증 시나리오를 남깁니다.

### 문서 동기화

- 구현 완료 후 문서 동기화는 `vibe/commands/doc-update.md` 기준으로 수행합니다.
- Progress/Roadmap/Architecture/PRD/Tech-stack 문서의 동기화 규칙(최신 항목 최상단 등)을 준수합니다.

### 리팩토링

- 리팩토링은 `vibe/commands/refactor-impl.md` 기준으로 **Behavior Preservation**을 최우선합니다.

### 테스트

- 테스트 작업을 명시적으로 요청받았거나, `test-exec` 흐름을 수행할 때는 `vibe/commands/test-exec.md`의 절차(TDD, 원인 판별 프로토콜 등)를 따릅니다.
- 그 외의 일반 기능 구현에서는 “자동 테스트 도입 여부”를 추측해 추가하지 말고, 런북/리플레이 기반 검증을 우선합니다.

### 커밋 메시지

- 커밋 메시지는 `.gemini/rules/commit-rules.md` 포맷을 우선 준수합니다(한글, Progress 블록 포함).
- 단, `vibe/roadmap.md`가 비어있는 경우 Progress 수치는 임의로 만들지 말고 보류/질문합니다.

---

## 품질 기준 (출시/데모 관점)

### Hard Gate (필수 통과)

- **Schema OK**: TurnOutput JSON이 스키마를 통과
- **Economy OK**: 비용/잔액 불일치 없음, 잔액 음수 금지
- **Safety OK**: 차단 시 명시 + 안전한 대체 결과 제공
- **Consistency OK**: WorldState/Rule Board/Memory Pin 일관성 유지

### Soft Gate (관측/튜닝)

- **Streaming TTFB**: 2초 이내 목표(데모 체감 우선)
- 이미지 생성: 선택적/지연 허용(Lazy loading), 실패 시 텍스트 대체

---

## 금지사항 (절대 금지)

- ❌ 채팅 버블/메신저 UX로 회귀시키는 변경
- ❌ 구조화 출력 없이 “텍스트만” 반환하는 API/로직(특수한 예외를 제외)
- ❌ 프롬프트 원문/내부 추론/비밀정보를 UI 또는 로그로 노출
- ❌ 서비스 계정 키/토큰 등 비밀정보를 레포에 커밋
- ❌ `language` 정책을 무시하고 ko/en 혼합 출력
- ❌ 좌표 규약(0~1000, bbox [ymin,xmin,ymax,xmax])을 깨는 변경
- ❌ 재화 잔액 음수/비용 누락/예상비용 미표기

---

## 지침 운영/사용 가이드

### Cursor 규칙 적용 방식

- `.cursor/rules/*.mdc`는 **파일 패턴(`applyTo`)**에 따라 자동 적용됩니다.
- 규칙이 부족/충돌하면:
  - PRD/Tech-stack 근거를 첨부해 규칙을 업데이트하고,
  - 파일 하나가 500줄을 넘지 않게 모듈로 분리합니다.

### 온보딩(신규 합류자/에이전트) 10분 루프

- `vibe/prd.md` 6~9장(게임 UI/경제/Autopilot) → “채팅 UI 금지” 합의
- `vibe/tech-stack.md`(버전/모델 ID 고정) 확인
- `vibe/ref/frontend-style-guide.md`로 CRT 테마 규칙 숙지
- `vibe/ref/structured-outputs-guide.md`로 JSON Schema 제약 이해

### 지침 업데이트 프로세스(권장)

- 변경 필요 신호: 규칙 오해/중복/충돌/500줄 초과/6개월 미사용
- 절차: 문제 재현 → 원인(규칙 부재/모호함) → 규칙 수정/분리 → PRD/Tech-stack와 정합성 확인 → 적용 범위(applyTo) 좁히기

---

## 참조 문서

- `vibe/prd.md`
- `vibe/tech-stack.md`
- `vibe/ref/frontend-style-guide.md`
- `vibe/ref/structured-outputs-guide.md`
- `vibe/commands/*.md` / `.cursor/commands/*.md`
- `.gemini/rules/commit-rules.md`
</file>

</files>
