This file is a merged representation of a subset of the codebase, containing specifically included files and files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: **/*.{ts,tsx,css,json,md}
- Files matching these patterns are excluded: .claude/**, .cursor/**, .gemini/**, .vscode/**, vibe/**, node_modules/**, dist/**, coverage/**
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
backend/prompts/image/scene_prompt.en.md
backend/prompts/image/scene_prompt.ko.md
backend/prompts/scan/scan_instructions.en.md
backend/prompts/scan/scan_instructions.ko.md
backend/prompts/system/game_master.en.md
backend/prompts/system/game_master.ko.md
backend/prompts/turn/turn_output_instructions.en.md
backend/prompts/turn/turn_output_instructions.ko.md
backend/prompts/vision/scene_affordances.en.md
backend/prompts/vision/scene_affordances.ko.md
backend/test_real_vision.json
backend/tests/fixtures/image_request_fast.json
backend/tests/fixtures/image_request_quality.json
backend/tests/fixtures/turn_request.json
CLAUDE.md
frontend/coverage/base.css
frontend/coverage/coverage-final.json
frontend/coverage/prettify.css
frontend/package.json
frontend/public/ui/manifest.json
frontend/public/ui/manifest.schema.json
frontend/public/ui/QA_CHECKLIST.md
frontend/public/ui/README.md
frontend/src/api/image.ts
frontend/src/api/scanner.test.ts
frontend/src/api/scanner.ts
frontend/src/api/turnStream.economy.test.ts
frontend/src/api/turnStream.test.ts
frontend/src/api/turnStream.ts
frontend/src/App.inputLock.test.tsx
frontend/src/App.test.tsx
frontend/src/App.tsx
frontend/src/components/ActionDeck.test.tsx
frontend/src/components/ActionDeck.tsx
frontend/src/components/AgentConsole.test.tsx
frontend/src/components/AgentConsole.tsx
frontend/src/components/DemoProfileSelect.tsx
frontend/src/components/DndInteraction.test.tsx
frontend/src/components/EconomyHud.i18n.test.tsx
frontend/src/components/EconomyHud.test.tsx
frontend/src/components/EconomyHud.tsx
frontend/src/components/GameHeader.tsx
frontend/src/components/Hotspot.test.tsx
frontend/src/components/Hotspot.tsx
frontend/src/components/InteractionHint.test.tsx
frontend/src/components/InteractionHint.tsx
frontend/src/components/InventoryPanel.test.tsx
frontend/src/components/InventoryPanel.tsx
frontend/src/components/MutationTimeline.test.tsx
frontend/src/components/MutationTimeline.tsx
frontend/src/components/NarrativeFeed.test.tsx
frontend/src/components/NarrativeFeed.tsx
frontend/src/components/ObjectiveTracker.test.tsx
frontend/src/components/ObjectiveTracker.tsx
frontend/src/components/Panel.tsx
frontend/src/components/QuestPanel.test.tsx
frontend/src/components/QuestPanel.tsx
frontend/src/components/ResetButton.tsx
frontend/src/components/RuleBoard.test.tsx
frontend/src/components/RuleBoard.tsx
frontend/src/components/ScannerSlot.test.tsx
frontend/src/components/ScannerSlot.tsx
frontend/src/components/SceneCanvas.hotspot.test.tsx
frontend/src/components/SceneCanvas.rendering.test.tsx
frontend/src/components/SceneCanvas.test.tsx
frontend/src/components/SceneCanvas.tsx
frontend/src/components/SceneImage.test.tsx
frontend/src/components/SceneImage.tsx
frontend/src/components/UIControls.tsx
frontend/src/data/demoProfiles.ts
frontend/src/data/itemIconPresets.ts
frontend/src/demo/demoFixtures.ts
frontend/src/demo/useDemoInitializer.ts
frontend/src/dnd/types.ts
frontend/src/i18n.ts
frontend/src/locales/en-US/translation.json
frontend/src/locales/ko-KR/translation.json
frontend/src/locales/README.md
frontend/src/main.tsx
frontend/src/save/constants.ts
frontend/src/save/saveGame.ts
frontend/src/save/sessionLifecycle.test.ts
frontend/src/save/sessionLifecycle.ts
frontend/src/schemas/index.ts
frontend/src/schemas/turn.economy.test.ts
frontend/src/schemas/turn.test.ts
frontend/src/schemas/turn.ts
frontend/src/schemas/verify_runbook.ts
frontend/src/setupTests.ts
frontend/src/stores/actionDeckStore.test.ts
frontend/src/stores/actionDeckStore.ts
frontend/src/stores/agentStore.test.ts
frontend/src/stores/agentStore.ts
frontend/src/stores/economyStore.test.ts
frontend/src/stores/economyStore.ts
frontend/src/stores/inventory_consumption.test.ts
frontend/src/stores/inventoryStore.test.ts
frontend/src/stores/inventoryStore.ts
frontend/src/stores/onboardingStore.test.ts
frontend/src/stores/onboardingStore.ts
frontend/src/stores/uiPrefsStore.test.ts
frontend/src/stores/uiPrefsStore.ts
frontend/src/stores/worldStore.test.ts
frontend/src/stores/worldStore.ts
frontend/src/stores/worldStore.u066.test.ts
frontend/src/style.css
frontend/src/styles/hotspot.css
frontend/src/styles/interaction-hint.css
frontend/src/turn/turnRunner.test.ts
frontend/src/turn/turnRunner.ts
frontend/src/types/scene.ts
frontend/src/types/turn_stream.ts
frontend/src/utils/box2d.test.ts
frontend/src/utils/box2d.ts
frontend/src/utils/imageSizing.test.ts
frontend/src/utils/imageSizing.ts
frontend/src/vite-env.d.ts
frontend/tsconfig.json
frontend/tsconfig.node.json
frontend/vite.config.ts
package.json
request.json
shared/README.md
shared/schemas/turn/turn_input.schema.json
shared/schemas/turn/turn_output.schema.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="frontend/coverage/base.css">
body, html {
  margin:0; padding: 0;
  height: 100%;
}
body {
    font-family: Helvetica Neue, Helvetica, Arial;
    font-size: 14px;
    color:#333;
}
.small { font-size: 12px; }
*, *:after, *:before {
  -webkit-box-sizing:border-box;
     -moz-box-sizing:border-box;
          box-sizing:border-box;
  }
h1 { font-size: 20px; margin: 0;}
h2 { font-size: 14px; }
pre {
    font: 12px/1.4 Consolas, "Liberation Mono", Menlo, Courier, monospace;
    margin: 0;
    padding: 0;
    -moz-tab-size: 2;
    -o-tab-size:  2;
    tab-size: 2;
}
a { color:#0074D9; text-decoration:none; }
a:hover { text-decoration:underline; }
.strong { font-weight: bold; }
.space-top1 { padding: 10px 0 0 0; }
.pad2y { padding: 20px 0; }
.pad1y { padding: 10px 0; }
.pad2x { padding: 0 20px; }
.pad2 { padding: 20px; }
.pad1 { padding: 10px; }
.space-left2 { padding-left:55px; }
.space-right2 { padding-right:20px; }
.center { text-align:center; }
.clearfix { display:block; }
.clearfix:after {
  content:'';
  display:block;
  height:0;
  clear:both;
  visibility:hidden;
  }
.fl { float: left; }
@media only screen and (max-width:640px) {
  .col3 { width:100%; max-width:100%; }
  .hide-mobile { display:none!important; }
}

.quiet {
  color: #7f7f7f;
  color: rgba(0,0,0,0.5);
}
.quiet a { opacity: 0.7; }

.fraction {
  font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace;
  font-size: 10px;
  color: #555;
  background: #E8E8E8;
  padding: 4px 5px;
  border-radius: 3px;
  vertical-align: middle;
}

div.path a:link, div.path a:visited { color: #333; }
table.coverage {
  border-collapse: collapse;
  margin: 10px 0 0 0;
  padding: 0;
}

table.coverage td {
  margin: 0;
  padding: 0;
  vertical-align: top;
}
table.coverage td.line-count {
    text-align: right;
    padding: 0 5px 0 20px;
}
table.coverage td.line-coverage {
    text-align: right;
    padding-right: 10px;
    min-width:20px;
}

table.coverage td span.cline-any {
    display: inline-block;
    padding: 0 5px;
    width: 100%;
}
.missing-if-branch {
    display: inline-block;
    margin-right: 5px;
    border-radius: 3px;
    position: relative;
    padding: 0 4px;
    background: #333;
    color: yellow;
}

.skip-if-branch {
    display: none;
    margin-right: 10px;
    position: relative;
    padding: 0 4px;
    background: #ccc;
    color: white;
}
.missing-if-branch .typ, .skip-if-branch .typ {
    color: inherit !important;
}
.coverage-summary {
  border-collapse: collapse;
  width: 100%;
}
.coverage-summary tr { border-bottom: 1px solid #bbb; }
.keyline-all { border: 1px solid #ddd; }
.coverage-summary td, .coverage-summary th { padding: 10px; }
.coverage-summary tbody { border: 1px solid #bbb; }
.coverage-summary td { border-right: 1px solid #bbb; }
.coverage-summary td:last-child { border-right: none; }
.coverage-summary th {
  text-align: left;
  font-weight: normal;
  white-space: nowrap;
}
.coverage-summary th.file { border-right: none !important; }
.coverage-summary th.pct { }
.coverage-summary th.pic,
.coverage-summary th.abs,
.coverage-summary td.pct,
.coverage-summary td.abs { text-align: right; }
.coverage-summary td.file { white-space: nowrap;  }
.coverage-summary td.pic { min-width: 120px !important;  }
.coverage-summary tfoot td { }

.coverage-summary .sorter {
    height: 10px;
    width: 7px;
    display: inline-block;
    margin-left: 0.5em;
    background: url(sort-arrow-sprite.png) no-repeat scroll 0 0 transparent;
}
.coverage-summary .sorted .sorter {
    background-position: 0 -20px;
}
.coverage-summary .sorted-desc .sorter {
    background-position: 0 -10px;
}
.status-line {  height: 10px; }
/* yellow */
.cbranch-no { background: yellow !important; color: #111; }
/* dark red */
.red.solid, .status-line.low, .low .cover-fill { background:#C21F39 }
.low .chart { border:1px solid #C21F39 }
.highlighted,
.highlighted .cstat-no, .highlighted .fstat-no, .highlighted .cbranch-no{
  background: #C21F39 !important;
}
/* medium red */
.cstat-no, .fstat-no, .cbranch-no, .cbranch-no { background:#F6C6CE }
/* light red */
.low, .cline-no { background:#FCE1E5 }
/* light green */
.high, .cline-yes { background:rgb(230,245,208) }
/* medium green */
.cstat-yes { background:rgb(161,215,106) }
/* dark green */
.status-line.high, .high .cover-fill { background:rgb(77,146,33) }
.high .chart { border:1px solid rgb(77,146,33) }
/* dark yellow (gold) */
.status-line.medium, .medium .cover-fill { background: #f9cd0b; }
.medium .chart { border:1px solid #f9cd0b; }
/* light yellow */
.medium { background: #fff4c2; }

.cstat-skip { background: #ddd; color: #111; }
.fstat-skip { background: #ddd; color: #111 !important; }
.cbranch-skip { background: #ddd !important; color: #111; }

span.cline-neutral { background: #eaeaea; }

.coverage-summary td.empty {
    opacity: .5;
    padding-top: 4px;
    padding-bottom: 4px;
    line-height: 1;
    color: #888;
}

.cover-fill, .cover-empty {
  display:inline-block;
  height: 12px;
}
.chart {
  line-height: 0;
}
.cover-empty {
    background: white;
}
.cover-full {
    border-right: none !important;
}
pre.prettyprint {
    border: none !important;
    padding: 0 !important;
    margin: 0 !important;
}
.com { color: #999 !important; }
.ignore-none { color: #999; font-weight: normal; }

.wrapper {
  min-height: 100%;
  height: auto !important;
  height: 100%;
  margin: 0 auto -48px;
}
.footer, .push {
  height: 48px;
}
</file>

<file path="frontend/coverage/coverage-final.json">
{"D:\\Dev\\unknown-world\\frontend\\src\\schemas\\turn.ts": {"path":"D:\\Dev\\unknown-world\\frontend\\src\\schemas\\turn.ts","statementMap":{"0":{"start":{"line":30,"column":30},"end":{"line":30,"column":null}},"1":{"start":{"line":41,"column":30},"end":{"line":41,"column":null}},"2":{"start":{"line":47,"column":27},"end":{"line":47,"column":null}},"3":{"start":{"line":54,"column":32},"end":{"line":62,"column":null}},"4":{"start":{"line":69,"column":37},"end":{"line":78,"column":null}},"5":{"start":{"line":85,"column":32},"end":{"line":85,"column":null}},"6":{"start":{"line":91,"column":31},"end":{"line":91,"column":null}},"7":{"start":{"line":102,"column":32},"end":{"line":107,"column":null}},"8":{"start":{"line":115,"column":27},"end":{"line":122,"column":null}},"9":{"start":{"line":129,"column":36},"end":{"line":138,"column":null}},"10":{"start":{"line":149,"column":32},"end":{"line":156,"column":null}},"11":{"start":{"line":162,"column":32},"end":{"line":176,"column":null}},"12":{"start":{"line":183,"column":37},"end":{"line":192,"column":null}},"13":{"start":{"line":199,"column":31},"end":{"line":209,"column":null}},"14":{"start":{"line":220,"column":32},"end":{"line":229,"column":null}},"15":{"start":{"line":236,"column":33},"end":{"line":247,"column":null}},"16":{"start":{"line":254,"column":32},"end":{"line":262,"column":null}},"17":{"start":{"line":270,"column":30},"end":{"line":278,"column":null}},"18":{"start":{"line":289,"column":31},"end":{"line":295,"column":null}},"19":{"start":{"line":302,"column":31},"end":{"line":312,"column":null}},"20":{"start":{"line":319,"column":27},"end":{"line":325,"column":null}},"21":{"start":{"line":332,"column":32},"end":{"line":359,"column":null}},"22":{"start":{"line":370,"column":30},"end":{"line":382,"column":null}},"23":{"start":{"line":389,"column":34},"end":{"line":395,"column":null}},"24":{"start":{"line":407,"column":35},"end":{"line":412,"column":null}},"25":{"start":{"line":424,"column":34},"end":{"line":436,"column":null}},"26":{"start":{"line":447,"column":34},"end":{"line":453,"column":null}},"27":{"start":{"line":469,"column":32},"end":{"line":502,"column":null}},"28":{"start":{"line":523,"column":4},"end":{"line":525,"column":null}},"29":{"start":{"line":528,"column":4},"end":{"line":530,"column":null}},"30":{"start":{"line":532,"column":2},"end":{"line":563,"column":null}},"31":{"start":{"line":590,"column":17},"end":{"line":590,"column":null}},"32":{"start":{"line":592,"column":2},"end":{"line":594,"column":null}},"33":{"start":{"line":593,"column":4},"end":{"line":593,"column":null}},"34":{"start":{"line":596,"column":2},"end":{"line":600,"column":null}},"35":{"start":{"line":611,"column":2},"end":{"line":611,"column":null}},"36":{"start":{"line":625,"column":2},"end":{"line":625,"column":null}}},"fnMap":{"0":{"name":"createFallbackTurnOutput","decl":{"start":{"line":517,"column":16},"end":{"line":517,"column":null}},"loc":{"start":{"line":521,"column":14},"end":{"line":564,"column":null}},"line":521},"1":{"name":"safeParseTurnOutput","decl":{"start":{"line":585,"column":16},"end":{"line":585,"column":null}},"loc":{"start":{"line":589,"column":25},"end":{"line":601,"column":null}},"line":589},"2":{"name":"parseTurnInput","decl":{"start":{"line":610,"column":16},"end":{"line":610,"column":31}},"loc":{"start":{"line":610,"column":57},"end":{"line":612,"column":null}},"line":610},"3":{"name":"safeParseTurnInput","decl":{"start":{"line":624,"column":16},"end":{"line":624,"column":35}},"loc":{"start":{"line":624,"column":76},"end":{"line":626,"column":null}},"line":624}},"branchMap":{"0":{"loc":{"start":{"line":519,"column":2},"end":{"line":519,"column":null}},"type":"default-arg","locations":[{"start":{"line":519,"column":24},"end":{"line":519,"column":null}}],"line":519},"1":{"loc":{"start":{"line":523,"column":4},"end":{"line":525,"column":null}},"type":"cond-expr","locations":[{"start":{"line":524,"column":8},"end":{"line":524,"column":null}},{"start":{"line":525,"column":8},"end":{"line":525,"column":null}}],"line":523},"2":{"loc":{"start":{"line":528,"column":4},"end":{"line":530,"column":null}},"type":"cond-expr","locations":[{"start":{"line":529,"column":8},"end":{"line":529,"column":null}},{"start":{"line":530,"column":8},"end":{"line":530,"column":null}}],"line":528},"3":{"loc":{"start":{"line":534,"column":15},"end":{"line":534,"column":null}},"type":"binary-expr","locations":[{"start":{"line":534,"column":15},"end":{"line":534,"column":31}},{"start":{"line":534,"column":31},"end":{"line":534,"column":null}}],"line":534},"4":{"loc":{"start":{"line":587,"column":2},"end":{"line":587,"column":null}},"type":"default-arg","locations":[{"start":{"line":587,"column":23},"end":{"line":587,"column":null}}],"line":587},"5":{"loc":{"start":{"line":588,"column":2},"end":{"line":588,"column":null}},"type":"default-arg","locations":[{"start":{"line":588,"column":24},"end":{"line":588,"column":null}}],"line":588},"6":{"loc":{"start":{"line":592,"column":2},"end":{"line":594,"column":null}},"type":"if","locations":[{"start":{"line":592,"column":2},"end":{"line":594,"column":null}},{"start":{},"end":{}}],"line":592}},"s":{"0":1,"1":1,"2":1,"3":1,"4":1,"5":1,"6":1,"7":1,"8":1,"9":1,"10":1,"11":1,"12":1,"13":1,"14":1,"15":1,"16":1,"17":1,"18":1,"19":1,"20":1,"21":1,"22":1,"23":1,"24":1,"25":1,"26":1,"27":1,"28":1,"29":1,"30":1,"31":2,"32":2,"33":1,"34":1,"35":2,"36":2},"f":{"0":1,"1":2,"2":2,"3":2},"b":{"0":[1],"1":[1,0],"2":[1,0],"3":[1,1],"4":[2],"5":[2],"6":[1,1]},"meta":{"lastBranch":7,"lastFunction":4,"lastStatement":37,"seen":{"s:30:30:30:Infinity":0,"s:41:30:41:Infinity":1,"s:47:27:47:Infinity":2,"s:54:32:62:Infinity":3,"s:69:37:78:Infinity":4,"s:85:32:85:Infinity":5,"s:91:31:91:Infinity":6,"s:102:32:107:Infinity":7,"s:115:27:122:Infinity":8,"s:129:36:138:Infinity":9,"s:149:32:156:Infinity":10,"s:162:32:176:Infinity":11,"s:183:37:192:Infinity":12,"s:199:31:209:Infinity":13,"s:220:32:229:Infinity":14,"s:236:33:247:Infinity":15,"s:254:32:262:Infinity":16,"s:270:30:278:Infinity":17,"s:289:31:295:Infinity":18,"s:302:31:312:Infinity":19,"s:319:27:325:Infinity":20,"s:332:32:359:Infinity":21,"s:370:30:382:Infinity":22,"s:389:34:395:Infinity":23,"s:407:35:412:Infinity":24,"s:424:34:436:Infinity":25,"s:447:34:453:Infinity":26,"s:469:32:502:Infinity":27,"f:517:16:517:Infinity":0,"b:519:24:519:Infinity":0,"s:523:4:525:Infinity":28,"b:524:8:524:Infinity:525:8:525:Infinity":1,"s:528:4:530:Infinity":29,"b:529:8:529:Infinity:530:8:530:Infinity":2,"s:532:2:563:Infinity":30,"b:534:15:534:31:534:31:534:Infinity":3,"f:585:16:585:Infinity":1,"b:587:23:587:Infinity":4,"b:588:24:588:Infinity":5,"s:590:17:590:Infinity":31,"b:592:2:594:Infinity:undefined:undefined:undefined:undefined":6,"s:592:2:594:Infinity":32,"s:593:4:593:Infinity":33,"s:596:2:600:Infinity":34,"f:610:16:610:31":2,"s:611:2:611:Infinity":35,"f:624:16:624:35":3,"s:625:2:625:Infinity":36}}}
}
</file>

<file path="frontend/coverage/prettify.css">
.pln{color:#000}@media screen{.str{color:#080}.kwd{color:#008}.com{color:#800}.typ{color:#606}.lit{color:#066}.pun,.opn,.clo{color:#660}.tag{color:#008}.atn{color:#606}.atv{color:#080}.dec,.var{color:#606}.fun{color:red}}@media print,projection{.str{color:#060}.kwd{color:#006;font-weight:bold}.com{color:#600;font-style:italic}.typ{color:#404;font-weight:bold}.lit{color:#044}.pun,.opn,.clo{color:#440}.tag{color:#006;font-weight:bold}.atn{color:#404}.atv{color:#060}}pre.prettyprint{padding:2px;border:1px solid #888}ol.linenums{margin-top:0;margin-bottom:0}li.L0,li.L1,li.L2,li.L3,li.L5,li.L6,li.L7,li.L8{list-style-type:none}li.L1,li.L3,li.L5,li.L7,li.L9{background:#eee}
</file>

<file path="frontend/package.json">
{
  "name": "unknown-world-frontend",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "packageManager": "pnpm@10.27.0",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "preview": "vite preview",
    "format": "prettier . --write",
    "format:check": "prettier . --check",
    "lint": "eslint .",
    "lint:fix": "eslint . --fix",
    "typecheck": "tsc --noEmit",
    "test": "vitest run",
    "test:watch": "vitest",
    "test:coverage": "vitest run --coverage"
  },
  "dependencies": {
    "@dnd-kit/core": "6.3.1",
    "@dnd-kit/sortable": "10.0.0",
    "@dnd-kit/utilities": "^3.2.2",
    "i18next": "25.7.3",
    "react": "19.2.3",
    "react-dom": "19.2.3",
    "react-i18next": "16.5.1",
    "zod": "4.3.4",
    "zustand": "5.0.9"
  },
  "devDependencies": {
    "@eslint/js": "9.39.2",
    "@testing-library/jest-dom": "^6.9.1",
    "@testing-library/react": "^16.3.1",
    "@types/node": "25.0.3",
    "@types/react": "19.2.7",
    "@types/react-dom": "19.2.3",
    "@vitejs/plugin-react": "5.1.2",
    "@vitest/coverage-v8": "^4.0.16",
    "eslint": "9.39.2",
    "eslint-config-prettier": "10.1.8",
    "eslint-plugin-react": "7.37.5",
    "eslint-plugin-react-hooks": "7.0.1",
    "eslint-plugin-unused-imports": "4.3.0",
    "globals": "16.5.0",
    "jsdom": "^27.4.0",
    "prettier": "3.7.4",
    "typescript": "5.9.3",
    "typescript-eslint": "8.51.0",
    "vite": "7.3.0",
    "vitest": "^4.0.16"
  },
  "pnpm": {
    "onlyBuiltDependencies": [
      "esbuild"
    ]
  }
}
</file>

<file path="frontend/public/ui/QA_CHECKLIST.md">
# UI ì—ì…‹ QA ì²´í¬ë¦¬ìŠ¤íŠ¸

> **ì°¸ì¡°**: `frontend/public/ui/README.md` (SSOT ê·œì¹™), `vibe/ref/rembg-guide.md` (ë°°ê²½ ì œê±°)  
> **ëª©ì **: nanobanana mcpë¡œ ìƒì„±í•œ ì—ì…‹ì˜ í’ˆì§ˆ/ì¼ê´€ì„± ë³´ì¥  
> **ì ìš© ì‹œì **: ì—ì…‹ ì¶”ê°€/ìˆ˜ì • ì‹œ ë°˜ë“œì‹œ ì²´í¬

---

## 1. ìš©ëŸ‰ ì˜ˆì‚° (Performance Budget)

### 1.1 ê°œë³„ ì—ì…‹ ìƒí•œ

| ìœ í˜•            | ìƒí•œ  | ê¶Œì¥       | ì²´í¬ í•­ëª©         |
| --------------- | ----- | ---------- | ----------------- |
| **ì•„ì´ì½˜**      | 30KB  | 20KB ì´í•˜  | `bytes` í•„ë“œ í™•ì¸ |
| **placeholder** | 300KB | 200KB ì´í•˜ | `bytes` í•„ë“œ í™•ì¸ |
| **chrome**      | 120KB | 30KB ì´í•˜  | `bytes` í•„ë“œ í™•ì¸ |

### 1.2 ì´í•© ì˜ˆì‚°

| í•­ëª©     | ê°’                                  |
| -------- | ----------------------------------- |
| **ìƒí•œ** | 1.5MB (1,572,864 bytes)             |
| **ê¶Œì¥** | 1MB (1,048,576 bytes) ì´í•˜          |
| **í˜„ì¬** | `manifest.json`ì˜ `totalBytes` í™•ì¸ |

### 1.3 ìš©ëŸ‰ ì´ˆê³¼ ì‹œ ëŒ€ì‘

1. **ì••ì¶•/ìµœì í™”**: TinyPNG, ImageMagick, WebP ë³€í™˜
2. **í•´ìƒë„/ìƒ‰ìƒ ì¶•ì†Œ**: í•„ìš” ì‚¬ì´ì¦ˆë§Œ ìœ ì§€
3. **ë¶ˆí•„ìš” ì—ì…‹ ì œê±°**: ì‚¬ìš©ì²˜ ì—†ëŠ” ì—ì…‹ ì •ë¦¬
4. **ì˜ˆì‚° ìƒí–¥**: ê·¼ê±° ë¬¸ì„œí™” í›„ `budgetBytes` ì¡°ì •

---

## 2. ì‚¬ì´ì¦ˆ/ê·œê²© (Size)

### 2.1 ì•„ì´ì½˜ ì‚¬ì´ì¦ˆ ì²´í¬

| í•­ëª©            | ìš”êµ¬                 | ì²´í¬ |
| --------------- | -------------------- | ---- |
| **í•„ìˆ˜ ì‚¬ì´ì¦ˆ** | 16px, 24px ìµœì†Œ 2ì¢…  | â˜    |
| **ì„ íƒ ì‚¬ì´ì¦ˆ** | 32px, 64px (í•„ìš” ì‹œ) | â˜    |
| **ì •ë°©í˜•**      | ê°€ë¡œ = ì„¸ë¡œ          | â˜    |

### 2.2 16px ì‹¤ë£¨ì—£ í…ŒìŠ¤íŠ¸ âš ï¸

> **ì¤‘ìš”**: 16pxì—ì„œë„ í˜•íƒœê°€ êµ¬ë¶„ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

**í…ŒìŠ¤íŠ¸ ë°©ë²•**:

1. 16px ì•„ì´ì½˜ì„ 100% ë°°ìœ¨ë¡œ í‘œì‹œ
2. 2m ê±°ë¦¬ì—ì„œ í˜•íƒœ êµ¬ë¶„ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
3. ë‹¤ë¥¸ ì•„ì´ì½˜ê³¼ í˜¼ë™ë˜ì§€ ì•ŠëŠ”ì§€ í™•ì¸

**ì‹¤íŒ¨ ì‹œ ëŒ€ì‘**:

- ë””í…Œì¼ ë‹¨ìˆœí™”
- ì™¸ê³½ì„ /ì‹¤ë£¨ì—£ ê°•í™”
- 16px/24px ë³„ë„ ë””ìì¸ (ì‚¬ìš©ì²˜ ë¶„ë¦¬)

### 2.3 placeholder/chrome ì‚¬ì´ì¦ˆ

| í•­ëª©            | ê¶Œì¥                     | ë¹„ê³                |
| --------------- | ------------------------ | ------------------ |
| **placeholder** | 512x384 ë˜ëŠ” ìš©ë„ë³„ ì ì • | ê°€ë¡œì„¸ë¡œ ë¹„ìœ¨ ìœ ì§€ |
| **chrome**      | íƒ€ì¼ë§ ê°€ëŠ¥ ì‚¬ì´ì¦ˆ       | 48px, 64px ë“±      |

---

## 3. ëŒ€ë¹„/ê°€ë…ì„± (Contrast)

### 3.1 ê¸°ë³¸ ëŒ€ë¹„ í…ŒìŠ¤íŠ¸

| ëª¨ë“œ         | ë°°ê²½                    | ìš”êµ¬ ëŒ€ë¹„               | ì²´í¬ |
| ------------ | ----------------------- | ----------------------- | ---- |
| **ê¸°ë³¸**     | `#0d0d0d` (ì–´ë‘ìš´ ë°°ê²½) | ì¸ê´‘ ë…¹ìƒ‰(#33ff00) ëŒ€ë¹„ | â˜    |
| **Readable** | ëŒ€ë¹„ ê°•í™” ëª¨ë“œ          | 4.5:1 ì´ìƒ              | â˜    |

### 3.2 ëŒ€ë¹„ ê²€ì¦ ë°©ë²•

```
ë„êµ¬: WebAIM Contrast Checker
URL: https://webaim.org/resources/contrastchecker/

ì „ê²½ìƒ‰: ì•„ì´ì½˜ ì£¼ìš” ìƒ‰ìƒ
ë°°ê²½ìƒ‰: #0d0d0d (CRT ë°°ê²½)
ëª©í‘œ: 4.5:1 ì´ìƒ (AA ê¸°ì¤€)
```

### 3.3 Readable ëª¨ë“œ í˜¸í™˜

- [ ] CRT ê¸€ë¡œìš°/ìŠ¤ìº”ë¼ì¸ OFF ì‹œì—ë„ ì‹ë³„ ê°€ëŠ¥
- [ ] í…ìŠ¤íŠ¸ ë¼ë²¨ì´ ì´ë¯¸ì§€ë¥¼ ë°©í•´í•˜ì§€ ì•ŠìŒ
- [ ] ìƒ‰ì•½/ìƒ‰ë§¹ ì ‘ê·¼ì„± ê³ ë ¤ (ìƒ‰ìƒë§Œìœ¼ë¡œ ì˜ë¯¸ ì „ë‹¬ ê¸ˆì§€)

---

## 4. íˆ¬ëª… ë°°ê²½ (Alpha Channel)

### 4.1 íˆ¬ëª… ë°°ê²½ í•„ìš” ì—¬ë¶€

| ìœ í˜•            | íˆ¬ëª… í•„ìˆ˜ | ë°°ê²½ ìƒ‰ìƒ        |
| --------------- | --------- | ---------------- |
| **ì•„ì´ì½˜**      | âœ… í•„ìˆ˜   | íˆ¬ëª… (ì•ŒíŒŒ ì±„ë„) |
| **placeholder** | âŒ ì„ íƒ   | ë¶ˆíˆ¬ëª… í—ˆìš©      |
| **chrome**      | âœ… í•„ìˆ˜   | íˆ¬ëª… (ì•ŒíŒŒ ì±„ë„) |

### 4.2 ë°°ê²½ ì œê±° ì²´í¬ (rembg)

> **ì°¸ì¡°**: `vibe/ref/rembg-guide.md`

**ìƒì„± ë‹¨ê³„ ìš”êµ¬ (ì¡°ê±´ë¶€)**:

- [ ] ë°°ê²½ ì œê±° ì˜ˆì •ì¸ ì—ì…‹ì€ **ìˆœë°±(#FFFFFF) ë‹¨ìƒ‰ ë°°ê²½**ìœ¼ë¡œ ìƒì„±
- [ ] ê·¸ë¼ë°ì´ì…˜/í…ìŠ¤ì²˜/ê·¸ë¦¼ì ë°°ê²½ ê¸ˆì§€

**ë°°ê²½ ì œê±° ì‹¤í–‰**:

- [ ] `rembg i -m birefnet-general <input> <output>` ì‹¤í–‰
- [ ] ì•ŒíŒŒ ì±„ë„ ì¡´ì¬ í™•ì¸ (GIMP/Photoshop/Preview)
- [ ] ê²½ê³„ ë¶€ë¶„ ì”ì—¬ ë°°ê²½ ì—†ìŒ í™•ì¸

### 4.3 íˆ¬ëª…ë„ ê²€ì¦ ëª…ë ¹ì–´

```bash
# ImageMagickìœ¼ë¡œ ì•ŒíŒŒ ì±„ë„ í™•ì¸
magick identify -verbose <image.png> | grep -i alpha

# ë˜ëŠ” íŒŒì¼ ì •ë³´ í™•ì¸ (PNG í¬ë§·)
file <image.png>  # PNG image data, ... RGBA
```

---

## 5. í´ë°± (Fallback)

### 5.1 í´ë°± í…ìŠ¤íŠ¸/ì´ëª¨ì§€ ì²´í¬

| ì²´í¬ í•­ëª©         | ìš”êµ¬  | ì„¤ëª…                               |
| ----------------- | ----- | ---------------------------------- |
| **fallback í•„ë“œ** | í•„ìˆ˜  | manifest.jsonì— `fallback` ê°’ ì¡´ì¬ |
| **ì´ëª¨ì§€/í…ìŠ¤íŠ¸** | 1~2ì | ì˜ˆ: `ğŸ“¡`, `âš `, `âœ“`, `OK`           |
| **ì˜ë¯¸ ì „ë‹¬**     | ëª…í™•  | ì›ë³¸ ì•„ì´ì½˜ê³¼ ë™ì¼í•œ ì˜ë¯¸          |

### 5.2 í´ë°± ë™ì‘ í…ŒìŠ¤íŠ¸

**í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤**:

1. ì—ì…‹ íŒŒì¼ì„ ì„ì‹œë¡œ ì‚­ì œ/ì´ë¦„ ë³€ê²½
2. ë¸Œë¼ìš°ì €ì—ì„œ UI ë¡œë“œ
3. í´ë°± í…ìŠ¤íŠ¸/ì´ëª¨ì§€ê°€ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸
4. UIê°€ ê¹¨ì§€ì§€ ì•ŠëŠ”ì§€ í™•ì¸

**ì½”ë“œ êµ¬í˜„ í™•ì¸**:

```tsx
// ì˜ˆìƒ íŒ¨í„´
<img
  src="/ui/icons/signal-24.png"
  alt=""
  aria-hidden="true"
  onError={(e) => (e.currentTarget.style.display = 'none')}
/>
<span className="icon-fallback">ğŸ“¡</span>
```

---

## 6. ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë™ê¸°í™” (manifest.json)

### 6.1 í•„ìˆ˜ í•„ë“œ ì²´í¬

| í•„ë“œ       | í•„ìˆ˜ | ì²´í¬                              |
| ---------- | ---- | --------------------------------- |
| `id`       | âœ…   | kebab-case, ê³ ìœ ê°’                |
| `path`     | âœ…   | `ui/` ê¸°ì¤€ ìƒëŒ€ ê²½ë¡œ              |
| `type`     | âœ…   | `icon` / `placeholder` / `chrome` |
| `fallback` | ê¶Œì¥ | ì´ëª¨ì§€/í…ìŠ¤íŠ¸                     |
| `bytes`    | ê¶Œì¥ | íŒŒì¼ í¬ê¸°                         |
| `usedIn`   | ê¶Œì¥ | ì‚¬ìš©ì²˜ ì»´í¬ë„ŒíŠ¸ ëª©ë¡              |
| `notes`    | ì„ íƒ | QA/ìƒì„± ê´€ë ¨ ë©”ëª¨                 |

### 6.2 ì‹¤ì œ íŒŒì¼ê³¼ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì •í•©ì„±

- [ ] manifest.jsonì˜ ëª¨ë“  ì—ì…‹ì´ ì‹¤ì œ íŒŒì¼ë¡œ ì¡´ì¬
- [ ] ì‹¤ì œ ë””ë ‰í† ë¦¬ì˜ ëª¨ë“  ì—ì…‹ì´ manifest.jsonì— ë“±ë¡ë¨
- [ ] `path` ê²½ë¡œê°€ ì‹¤ì œ íŒŒì¼ ìœ„ì¹˜ì™€ ì¼ì¹˜
- [ ] `bytes` ê°’ì´ ì‹¤ì œ íŒŒì¼ í¬ê¸°ì™€ ì¼ì¹˜

### 6.3 ì •í•©ì„± ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ (ì°¸ê³ )

```bash
# manifest.jsonì— ìˆëŠ” pathë“¤ì´ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
cd frontend/public/ui
cat manifest.json | jq -r '.assets[].path' | while read p; do
  [ -f "$p" ] || echo "MISSING: $p"
done

# ì‹¤ì œ íŒŒì¼ì´ manifestì— ìˆëŠ”ì§€ í™•ì¸
find icons placeholders chrome -type f \( -name "*.png" -o -name "*.webp" \) | while read f; do
  grep -q "\"$f\"" manifest.json || echo "NOT IN MANIFEST: $f"
done
```

---

## 7. ìŠ¤íƒ€ì¼ ì¼ê´€ì„± (CRT Theme)

### 7.1 ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ì¤€ìˆ˜

| ìƒ‰ìƒ        | Hex       | ìš©ë„        | ì²´í¬ |
| ----------- | --------- | ----------- | ---- |
| ì¸ê´‘ ë…¹ìƒ‰   | `#33ff00` | ì£¼ìš” ìƒ‰ìƒ   | â˜    |
| ì–´ë‘ìš´ ë…¹ìƒ‰ | `#1a8000` | ë³´ì¡° ìƒ‰ìƒ   | â˜    |
| ë§ˆì  íƒ€      | `#ff00ff` | í¬ì¸íŠ¸/ê²½ê³  | â˜    |
| ì£¼í™©ìƒ‰      | `#ffaa00` | ê²½ê³         | â˜    |
| ë¶‰ì€ìƒ‰      | `#ff3333` | ì—ëŸ¬        | â˜    |
| ë°°ê²½        | `#0d0d0d` | ë°°ê²½        | â˜    |

### 7.2 ìŠ¤íƒ€ì¼ ê¸ˆì§€ ì‚¬í•­

- [ ] ì™¸ë¶€ ë¡œê³ /ìƒí‘œ ë³µì œ ê¸ˆì§€
- [ ] CRT í…Œë§ˆì™€ ì¶©ëŒí•˜ëŠ” ìƒ‰ìƒ ê¸ˆì§€ (ë°ì€ íŒŒìŠ¤í…”, ë‚œìƒ‰ ë‚¨ìš©)
- [ ] ë³µì¡í•œ ê·¸ë¼ë°ì´ì…˜/ì‚¬ì§„ ìŠ¤íƒ€ì¼ ê¸ˆì§€

---

## 8. Retina ëŒ€ì‘ (ì„ íƒ)

### 8.1 Retina í•„ìš” ì—¬ë¶€ íŒë‹¨

| ìƒí™©             | Retina í•„ìš” | ë¹„ê³                   |
| ---------------- | ----------- | --------------------- |
| **16px ì•„ì´ì½˜**  | ì„ íƒ        | HiDPIì—ì„œ ì„ ëª…ë„ í–¥ìƒ |
| **24px+ ì•„ì´ì½˜** | ë‚®ìŒ        | ê¸°ë³¸ í•´ìƒë„ë¡œ ì¶©ë¶„    |
| **placeholder**  | ë‚®ìŒ        | ì´ë¯¸ ì¶©ë¶„í•œ í•´ìƒë„    |

### 8.2 Retina íŒŒì¼ ê·œì¹™

- íŒŒì¼ëª…: `{name}-24.png` â†’ `{name}-24@2x.png`
- CSS: `image-set()`ìœ¼ë¡œ 1x/2x ì œê³µ
- manifest.json: `retina: true` í‘œê¸°

---

## 9. ì¢…í•© ì²´í¬ë¦¬ìŠ¤íŠ¸ (Quick Reference)

ì—ì…‹ ì¶”ê°€/ìˆ˜ì • ì‹œ ì•„ë˜ í•­ëª©ì„ ìˆœì„œëŒ€ë¡œ ì²´í¬í•˜ì„¸ìš”:

### ğŸ“¦ ì¶”ê°€ ì „

- [ ] ë„¤ì´ë° ê·œì¹™ ì¤€ìˆ˜ (`kebab-case` + ìš©ë„ + í¬ê¸°)
- [ ] í¬ë§· ê·œì¹™ ì¤€ìˆ˜ (ì•„ì´ì½˜=PNG, placeholder=WebP)
- [ ] CRT í…Œë§ˆ ìƒ‰ìƒê³¼ ì¡°í™”

### ğŸ¨ ìƒì„± ì‹œ

- [ ] (ì¡°ê±´ë¶€) ë°°ê²½ ì œê±° í•„ìš” ì‹œ ìˆœë°±(#FFFFFF) ë°°ê²½ìœ¼ë¡œ ìƒì„±
- [ ] í•„ìš” ì‚¬ì´ì¦ˆë¡œ ë¦¬ì‚¬ì´ì¦ˆ
- [ ] (ì¡°ê±´ë¶€) `rembg`ë¡œ ë°°ê²½ ì œê±°

### âœ… ì¶”ê°€ í›„

- [ ] ê°œë³„ ìš©ëŸ‰ ì˜ˆì‚° ì¤€ìˆ˜ í™•ì¸
- [ ] ì´í•© ì˜ˆì‚° ì¤€ìˆ˜ í™•ì¸ (`totalBytes` < `budgetBytes`)
- [ ] 16px ì‹¤ë£¨ì—£ êµ¬ë¶„ ê°€ëŠ¥ ì—¬ë¶€ (ì•„ì´ì½˜)
- [ ] ê¸°ë³¸/Readable ëª¨ë“œ ëŒ€ë¹„ í™•ì¸
- [ ] (ì¡°ê±´ë¶€) ì•ŒíŒŒ ì±„ë„ ì¡´ì¬ í™•ì¸ (íˆ¬ëª… í•„ìš” ì—ì…‹)
- [ ] í´ë°± í…ìŠ¤íŠ¸/ì´ëª¨ì§€ ì§€ì •
- [ ] manifest.json ì—…ë°ì´íŠ¸
- [ ] ì‹¤ì œ íŒŒì¼ê³¼ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì •í•©ì„± í™•ì¸

---

## 10. ì°¸ê³  ìë£Œ

- **SSOT ê·œì¹™**: `frontend/public/ui/README.md`
- **ë°°ê²½ ì œê±° ê°€ì´ë“œ**: `vibe/ref/rembg-guide.md`
- **ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìŠ¤í‚¤ë§ˆ**: `frontend/public/ui/manifest.schema.json`
- **ìŠ¤íƒ€ì¼ ê°€ì´ë“œ**: `vibe/ref/frontend-style-guide.md`
- **ê°€ë…ì„± íŒ¨ìŠ¤**: U-028[Mvp] (Readable ëª¨ë“œ)

---

_ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: 2026-01-12_  
_ë¬¸ì„œ ë²„ì „: 1.0.0_
</file>

<file path="frontend/public/ui/README.md">
# UI ì—ì…‹ ê°€ì´ë“œ (nanobanana mcp SSOT)

> **SSOT ê²½ë¡œ**: `frontend/public/ui/`  
> **ë„êµ¬**: `nanobanana mcp` (ê°œë°œ ì „ìš©, ëŸ°íƒ€ì„ ì˜ì¡´ ê¸ˆì§€)  
> **ì°¸ì¡°**: `.gemini/rules/red-line.md` RULE-006/007, `vibe/prd.md` 9.7, `vibe/ref/rembg-guide.md`

---

## 1. í•µì‹¬ ì›ì¹™

### 1.1 Dev-only ì›ì¹™ (RULE-007)

- `nanobanana mcp`ëŠ” **ê°œë°œ ê³¼ì •ì—ì„œ ì •ì  ì—ì…‹ì„ ì œì‘**í•˜ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.
- ì œí’ˆ ëŸ°íƒ€ì„(í”„ë¡ íŠ¸/ë°±ì—”ë“œ)ì—ì„œ MCPì— ì˜ì¡´í•˜ëŠ” ì„¤ê³„ëŠ” **ê¸ˆì§€**í•©ë‹ˆë‹¤.
- ìƒì„±ëœ ì—ì…‹ì€ ì´ ë””ë ‰í† ë¦¬(`frontend/public/ui/`)ì— ì»¤ë°‹í•˜ì—¬ ì •ì  ë°°í¬í•©ë‹ˆë‹¤.

### 1.2 ìš©ì–´ SSOT (RULE-006)

- ì´ ë„êµ¬ëŠ” ë°˜ë“œì‹œ **`nanobanana mcp`** ë¡œ í‘œê¸°í•©ë‹ˆë‹¤.
- "ë‚˜ë…¸ë°”ë‚˜ë‚˜ MCP", "Nano Banana MCP", "banana mcp" ë“± í˜¼ìš© ê¸ˆì§€.
- ëª¨ë¸ ë³„ì¹­("Nano Banana / Nano Banana Pro")ì€ ë¬¸ì„œ ì¸ìš© ì‹œì—ë§Œ ì œí•œì  ì‚¬ìš©.

### 1.3 ë³´ì•ˆ (RULE-005)

- í‚¤/í† í° ë“± ë¹„ë°€ì •ë³´ë¥¼ ë ˆí¬/ë¡œê·¸/ë¬¸ì„œì— ë‚¨ê¸°ì§€ ì•ŠìŠµë‹ˆë‹¤.
- ìƒì„± ê³¼ì •ì—ì„œ ì‚¬ìš©í•œ API í‚¤ë‚˜ ì¸ì¦ ì •ë³´ëŠ” ì ˆëŒ€ ì»¤ë°‹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

---

## 2. ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
frontend/public/ui/
â”œâ”€â”€ README.md              # ì´ íŒŒì¼ (SSOT ê·œì¹™)
â”œâ”€â”€ manifest.schema.json   # ì—ì…‹ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìŠ¤í‚¤ë§ˆ
â”œâ”€â”€ manifest.json          # (ìƒì„± ì‹œ) ì‹¤ì œ ì—ì…‹ ëª©ë¡
â”œâ”€â”€ icons/                 # ì•„ì´ì½˜ ì—ì…‹
â”‚   â”œâ”€â”€ signal-16.png
â”‚   â”œâ”€â”€ signal-24.png
â”‚   â”œâ”€â”€ badge-ok-16.png
â”‚   â””â”€â”€ ...
â”œâ”€â”€ placeholders/          # ìƒíƒœ/ì¥ë©´ placeholder
â”‚   â”œâ”€â”€ scene-loading.webp
â”‚   â”œâ”€â”€ scene-error.webp
â”‚   â””â”€â”€ ...
â””â”€â”€ chrome/                # UI í”„ë ˆì„/ì¥ì‹
    â”œâ”€â”€ panel-corner-tl.png
    â”œâ”€â”€ panel-border-h.png
    â””â”€â”€ ...
```

---

## 3. ë„¤ì´ë° ê·œì¹™

### 3.1 ê¸°ë³¸ í¬ë§·

```
{ìš©ë„}-{í¬ê¸°}.{í™•ì¥ì}
{ìš©ë„}-{ìƒíƒœ}-{í¬ê¸°}.{í™•ì¥ì}
```

**ì˜ˆì‹œ**:

- `signal-24.png` â€” Signal ì•„ì´ì½˜, 24px
- `badge-ok-16.png` â€” OK ë°°ì§€, 16px
- `scene-loading.webp` â€” ë¡œë”© ìƒíƒœ placeholder

### 3.2 ê·œì¹™

| í•­ëª©       | ê·œì¹™                                              |
| ---------- | ------------------------------------------------- |
| **ì¼€ì´ìŠ¤** | `kebab-case` (ì†Œë¬¸ì + í•˜ì´í”ˆ)                    |
| **ìš©ë„**   | ëª…í™•í•œ ì—­í•  í‘œí˜„ (signal, badge, scene, panel ë“±) |
| **ìƒíƒœ**   | í•„ìš” ì‹œ ìƒíƒœ í¬í•¨ (ok, fail, loading, error ë“±)   |
| **í¬ê¸°**   | í”½ì…€ ë‹¨ìœ„ ìˆ«ì (16, 24, 32, 64 ë“±)                |
| **í™•ì¥ì** | ìš©ë„ì— ë§ê²Œ ì„ íƒ (ì•„ë˜ ì°¸ì¡°)                      |

---

## 4. í¬ë§· ë° ì‚¬ì´ì¦ˆ ê·œì¹™

### 4.1 í¬ë§· ì„ íƒ

| ìš©ë„            | ê¸°ë³¸ í¬ë§·  | ëŒ€ì•ˆ | ë¹„ê³                                |
| --------------- | ---------- | ---- | ---------------------------------- |
| **ì•„ì´ì½˜**      | PNG (íˆ¬ëª…) | -    | ì‘ì€ í¬ê¸°, íˆ¬ëª…ë„ í•„ìˆ˜             |
| **placeholder** | WebP       | PNG  | ìš©ëŸ‰ ì ˆê° ìš°ì„  (Q1 ê²°ì •: Option B) |
| **chrome**      | PNG (íˆ¬ëª…) | -    | í”„ë ˆì„/ì¥ì‹, íˆ¬ëª…ë„ í•„ìˆ˜           |

> **ë°°ê²½ ì œê±°(í•„ìˆ˜ ì¡°ê±´ë¶€)**: ì•„ì´ì½˜/chrome ë“± íˆ¬ëª… ë°°ê²½ì´ í•„ìš”í•œ ì—ì…‹ì€ ìƒì„± ê²°ê³¼ì— ë°°ê²½ì´ ë‚¨ì•„ ìˆìœ¼ë©´ `rembg`ë¡œ ë°°ê²½ì„ ì œê±°í•´ íˆ¬ëª… PNGë¡œ ì •ë¦¬í•©ë‹ˆë‹¤. (ê°€ì´ë“œ: `vibe/ref/rembg-guide.md`)

### 4.2 ì‚¬ì´ì¦ˆ ê·œê²©

| ìš©ë„            | í•„ìˆ˜ ì‚¬ì´ì¦ˆ | ì„ íƒ ì‚¬ì´ì¦ˆ | ë¹„ê³              |
| --------------- | ----------- | ----------- | ---------------- |
| **ì•„ì´ì½˜**      | 16, 24      | 32, 64      | ìµœì†Œ 2ì¢… í•„ìˆ˜    |
| **placeholder** | ê°€ë³€        | -           | ìš©ë„ë³„ ì ì • í¬ê¸° |
| **chrome**      | ê°€ë³€        | -           | íƒ€ì¼ë§/ë°˜ë³µ ê³ ë ¤ |

### 4.3 Retina ëŒ€ì‘ (ì„ íƒ)

- í•„ìš” ì‹œ `image-set()`ìœ¼ë¡œ 1x/2x ì œê³µ
- íŒŒì¼ëª…: `{name}-24.png`, `{name}-24@2x.png`

---

## 5. ì„±ëŠ¥ ì˜ˆì‚°

| í•­ëª©                | ìƒí•œ  | ê¶Œì¥       |
| ------------------- | ----- | ---------- |
| **ì•„ì´ì½˜ 1ê°œ**      | 30KB  | 20KB ì´í•˜  |
| **placeholder 1ê°œ** | 300KB | 200KB ì´í•˜ |
| **chrome 1ê°œ**      | 50KB  | 30KB ì´í•˜  |
| **`ui/` í´ë” ì´í•©** | 1.5MB | 1MB ì´í•˜   |

**ì´ˆê³¼ ì‹œ ëŒ€ì‘**:

1. ì••ì¶•/ìµœì í™” (TinyPNG, ImageOptim ë“±)
2. í•´ìƒë„/ìƒ‰ìƒ ì¶•ì†Œ
3. ë¶ˆí•„ìš” ì—ì…‹ ì œê±°
4. ì˜ˆì‚° ìƒí–¥ ì‹œ ê·¼ê±° ë¬¸ì„œí™” í•„ìš”

---

## 6. ìŠ¤íƒ€ì¼ ê°€ì´ë“œ

### 6.1 CRT í…Œë§ˆ ì—°ë™

ì—ì…‹ì€ `frontend/src/style.css`ì˜ CSS ë³€ìˆ˜/í…Œë§ˆì™€ ì¡°í™”ë¥¼ ì´ë¤„ì•¼ í•©ë‹ˆë‹¤.

```css
/* ì°¸ì¡°: CRT í…Œë§ˆ ìƒ‰ìƒ */
--bg-color: #0d0d0d; /* ë°°ê²½ */
--text-color: #33ff00; /* ì¸ê´‘ ë…¹ìƒ‰ */
--text-dim: #1a8000; /* ì–´ë‘ìš´ ë…¹ìƒ‰ */
--accent-color: #ff00ff; /* ë§ˆì  íƒ€ */
--warning-color: #ffaa00; /* ì£¼í™©ìƒ‰ */
--error-color: #ff3333; /* ë¶‰ì€ìƒ‰ */
```

### 6.2 ìŠ¤íƒ€ì¼ ì›ì¹™

| ì›ì¹™                  | ì„¤ëª…                          |
| --------------------- | ----------------------------- |
| **ë ˆíŠ¸ë¡œ í“¨ì²˜ë¦¬ì¦˜**   | CRT/í„°ë¯¸ë„ ë¯¸í•™ê³¼ ì¡°í™”        |
| **ê¸°ëŠ¥ì  ë¯¸ë‹ˆë©€ë¦¬ì¦˜** | ë¶ˆí•„ìš”í•œ ì¥ì‹ ë°°ì œ            |
| **í†¤ ì¼ê´€ì„±**         | ì¸ê´‘ ë…¹ìƒ‰ ê¸°ë°˜, ë§ˆì  íƒ€ í¬ì¸íŠ¸ |
| **ê³ ëŒ€ë¹„**            | Readable ëª¨ë“œì—ì„œë„ ì‹ë³„ ê°€ëŠ¥ |

### 6.3 ê¸ˆì§€ ì‚¬í•­

- âŒ í”„ë¡œì íŠ¸ ì™¸ë¶€ ë¡œê³ /ìƒí‘œ ë³µì œ
- âŒ CRT í…Œë§ˆì™€ ì¶©ëŒí•˜ëŠ” ìƒ‰ìƒ (ë°ì€ íŒŒìŠ¤í…”, ë‚œìƒ‰ ê³„ì—´ ë‚¨ìš©)
- âŒ ë³µì¡í•œ ê·¸ë¼ë°ì´ì…˜/ì‚¬ì§„ ìŠ¤íƒ€ì¼

---

## 7. í´ë°± ì›ì¹™ (í•„ìˆ˜)

### 7.1 í…ìŠ¤íŠ¸/ì´ëª¨ì§€ í´ë°± ìœ ì§€

ì—ì…‹ ë¡œë”© ì‹¤íŒ¨/ë¯¸ì§€ì› ì‹œì—ë„ **UIê°€ ê¹¨ì§€ì§€ ì•Šë„ë¡** í…ìŠ¤íŠ¸/ì´ëª¨ì§€ ë¼ë²¨ì„ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.

**ì˜ˆì‹œ** (React):

```tsx
<span className="icon-wrapper" aria-label="Signal">
  <img
    src="/ui/icons/signal-24.png"
    alt=""
    aria-hidden="true"
    onError={(e) => (e.currentTarget.style.display = 'none')}
  />
  <span className="icon-fallback">ğŸ“¡</span>
</span>
```

**CSS**:

```css
.icon-wrapper {
  display: inline-flex;
  align-items: center;
}
.icon-wrapper img + .icon-fallback {
  display: none;
}
.icon-wrapper img[style*='display: none'] + .icon-fallback {
  display: inline;
}
```

### 7.2 í´ë°± ìš”êµ¬ì‚¬í•­

| ì—ì…‹ ìœ í˜•       | í´ë°± ë°©ì‹                |
| --------------- | ------------------------ |
| **ì•„ì´ì½˜**      | ì´ëª¨ì§€ ë˜ëŠ” í…ìŠ¤íŠ¸ ë¼ë²¨  |
| **placeholder** | CSS ë°°ê²½ìƒ‰ + í…ìŠ¤íŠ¸      |
| **chrome**      | CSS border/shadowë¡œ ëŒ€ì²´ |

---

## 8. ì ‘ê·¼ì„± ê°€ì´ë“œ

### 8.1 í•„ìˆ˜ ì‚¬í•­

| í•­ëª©                          | ìš”êµ¬ì‚¬í•­                            |
| ----------------------------- | ----------------------------------- |
| **ìƒ‰ìƒë§Œìœ¼ë¡œ ì˜ë¯¸ ì „ë‹¬ ê¸ˆì§€** | í…ìŠ¤íŠ¸/ë¼ë²¨ ë³‘í–‰                    |
| **ì¥ì‹ì„± ì´ë¯¸ì§€**             | `aria-hidden="true"` ì ìš©           |
| **ê¸°ëŠ¥ì„± ì´ë¯¸ì§€**             | `alt` í…ìŠ¤íŠ¸ ì œê³µ ë˜ëŠ” `aria-label` |
| **ëŒ€ë¹„**                      | Readable ëª¨ë“œì—ì„œë„ 4.5:1 ì´ìƒ      |

### 8.2 ì˜ˆì‹œ

```html
<!-- ì¥ì‹ìš© ì•„ì´ì½˜ (ì˜ë¯¸ ì—†ìŒ) -->
<img src="/ui/chrome/corner.png" alt="" aria-hidden="true" />

<!-- ê¸°ëŠ¥ìš© ì•„ì´ì½˜ (ì˜ë¯¸ ìˆìŒ) -->
<button aria-label="ì‹ í˜¸ ì „ì†¡">
  <img src="/ui/icons/signal-24.png" alt="Signal" />
</button>
```

---

## 9. ì—ì…‹ ì œì‘ ì›Œí¬í”Œë¡œìš°

### 9.1 ìš”ì²­ â†’ ì œì‘ â†’ ì ìš©

```
1. ìš”ì²­ ì •ì˜
   â””â”€â”€ ìš©ë„, ì‚¬ì´ì¦ˆ, ìŠ¤íƒ€ì¼ ëª…ì„¸ ì‘ì„±

2. nanobanana mcpë¡œ ì œì‘
   â””â”€â”€ í”„ë¡¬í”„íŠ¸ì— CRT ìŠ¤íƒ€ì¼ í‚¤ì›Œë“œ í¬í•¨
   â””â”€â”€ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ì¤€ìˆ˜
   â””â”€â”€ (í•„ìˆ˜ ì¡°ê±´ë¶€) ë°°ê²½ ì œê±°(rembg) ì˜ˆì •ì´ë©´ **ë°°ê²½ì€ ìˆœë°±(#FFFFFF) ë‹¨ìƒ‰**ìœ¼ë¡œ ìƒì„±(ê·¸ë¼ë°ì´ì…˜/í…ìŠ¤ì²˜/ê·¸ë¦¼ì ê¸ˆì§€)

3. (í•„ìˆ˜ ì¡°ê±´ë¶€) rembgë¡œ ë°°ê²½ ì œê±°
   â””â”€â”€ ì•„ì´ì½˜/chrome ë“± íˆ¬ëª… ë°°ê²½ì´ í•„ìš”í•œ ì—ì…‹ì—ì„œ ë°°ê²½ì´ ë‚¨ì•„ ìˆìœ¼ë©´ rembgë¡œ ì œê±°
   â””â”€â”€ ëª¨ë¸ ì„ íƒ/ì˜µì…˜ì€ `vibe/ref/rembg-guide.md` ì¤€ìˆ˜

4. ë¦¬ì‚¬ì´ì¦ˆ/ì••ì¶•
   â””â”€â”€ ì„±ëŠ¥ ì˜ˆì‚° í™•ì¸
   â””â”€â”€ í•„ìš” ì‚¬ì´ì¦ˆë¡œ ë¦¬ì‚¬ì´ì¦ˆ

5. ë””ë ‰í† ë¦¬ ë°˜ì˜
   â””â”€â”€ ë„¤ì´ë° ê·œì¹™ ì¤€ìˆ˜
   â””â”€â”€ manifest.json ì—…ë°ì´íŠ¸

6. UI ì ìš© + í´ë°± í™•ì¸
   â””â”€â”€ ì»´í¬ë„ŒíŠ¸ì— ì ìš©
   â””â”€â”€ í´ë°± ë™ì‘ í…ŒìŠ¤íŠ¸

7. QA
   â””â”€â”€ í¬ê¸°/ëŒ€ë¹„/í´ë°±/Readable ëª¨ë“œ í™•ì¸
```

### 9.2 í”„ë¡¬í”„íŠ¸ ê°€ì´ë“œ (ì˜ˆì‹œ)

```
CRT í„°ë¯¸ë„ ìŠ¤íƒ€ì¼ ì•„ì´ì½˜,
ì¸ê´‘ ë…¹ìƒ‰(#33ff00) ê¸°ë°˜,
ê²€ì€ ë°°ê²½(#0d0d0d)ì— ì–´ìš¸ë¦¬ëŠ” í†¤,
ì‹¬í”Œí•œ ë¼ì¸ ì•„íŠ¸,
í”½ì…€ ì•„íŠ¸ ë˜ëŠ” ë ˆíŠ¸ë¡œ ìŠ¤íƒ€ì¼,
24x24 í”½ì…€, íˆ¬ëª… ë°°ê²½
(ë°°ê²½ ì œê±° í•„ìš” ì‹œ) solid white background (#FFFFFF), no gradient/texture/shadow
```

---

## 10. ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ê´€ë¦¬

### 10.1 manifest.json

ëª¨ë“  ì—ì…‹ì€ `manifest.json`ì— ë“±ë¡í•˜ì—¬ ì¶”ì í•©ë‹ˆë‹¤.

```json
{
  "$schema": "./manifest.schema.json",
  "version": "1.0.0",
  "assets": [
    {
      "id": "signal-24",
      "path": "icons/signal-24.png",
      "type": "icon",
      "size": 24,
      "fallback": "ğŸ“¡",
      "usedIn": ["EconomyHUD"],
      "bytes": 1234
    }
  ]
}
```

### 10.2 ì—…ë°ì´íŠ¸ ì‹œì 

- ì—ì…‹ ì¶”ê°€/ì œê±° ì‹œ manifest.json ë™ê¸°í™”
- U-033ì—ì„œ QA ìë™í™” ì˜ˆì •

---

## 11. ë¼ì´ì„ ìŠ¤

- ëª¨ë“  ì—ì…‹ì€ **í”„ë¡œì íŠ¸ ë‚´ë¶€ ìš©ë„**ë¡œ ì œì‘ë©ë‹ˆë‹¤.
- ì™¸ë¶€ ë¡œê³ /ìƒí‘œë¥¼ ë³µì œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
- `nanobanana mcp`ë¡œ ìƒì„±ëœ ì—ì…‹ì€ ë„êµ¬ì˜ ë¼ì´ì„ ìŠ¤ ì •ì±…ì„ ë”°ë¦…ë‹ˆë‹¤.
- ì—ì…‹ì— **SynthID ì›Œí„°ë§ˆí¬**ê°€ í¬í•¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (AI ìƒì„± í‘œê¸°).

---

## 12. ì²´í¬ë¦¬ìŠ¤íŠ¸ (ì—ì…‹ ì¶”ê°€ ì‹œ)

- [ ] ë„¤ì´ë° ê·œì¹™ ì¤€ìˆ˜ (`kebab-case` + ìš©ë„ + í¬ê¸°)
- [ ] í¬ë§· ê·œì¹™ ì¤€ìˆ˜ (ì•„ì´ì½˜=PNG, placeholder=WebP)
- [ ] ì„±ëŠ¥ ì˜ˆì‚° ì¤€ìˆ˜ (ê°œë³„/ì´í•©)
- [ ] (ì¡°ê±´ë¶€) íˆ¬ëª… ë°°ê²½ì´ í•„ìš”í•œ ì—ì…‹ì€ `rembg`ë¡œ ë°°ê²½ ì œê±° ì™„ë£Œ(ì•ŒíŒŒ ì±„ë„ í™•ì¸)
- [ ] (ì¡°ê±´ë¶€) ë°°ê²½ ì œê±°(rembg) ì˜ˆì •ì´ë©´ ì›ë³¸ ìƒì„± ë‹¨ê³„ì—ì„œ ë°°ê²½ì´ ìˆœë°±(#FFFFFF) ë‹¨ìƒ‰ì¸ì§€ í™•ì¸(ê·¸ë¼ë°ì´ì…˜/í…ìŠ¤ì²˜/ê·¸ë¦¼ì ê¸ˆì§€)
- [ ] CRT í…Œë§ˆ ìƒ‰ìƒê³¼ ì¡°í™”
- [ ] í´ë°± êµ¬í˜„ í™•ì¸
- [ ] ì ‘ê·¼ì„± ì†ì„± ì ìš© (`aria-hidden` ë˜ëŠ” `alt`)
- [ ] manifest.json ì—…ë°ì´íŠ¸
- [ ] Readable ëª¨ë“œì—ì„œ ëŒ€ë¹„ í™•ì¸

---

_ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: 2026-01-11_
_ë¬¸ì„œ ë²„ì „: 1.1.0_
</file>

<file path="frontend/src/components/MutationTimeline.tsx">
/**
 * Unknown World - Mutation Timeline (U-013)
 *
 * ê·œì¹™ ë³€í˜• ì´ë²¤íŠ¸ë¥¼ ì‹œê°„ìˆœìœ¼ë¡œ í‘œì‹œí•˜ëŠ” íƒ€ì„ë¼ì¸ ì»´í¬ë„ŒíŠ¸ì…ë‹ˆë‹¤.
 * "ì„¸ê³„ê°€ ë³€í–ˆë‹¤"ë¥¼ UIë¡œ ì²´ê°í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - RULE-002: ì±„íŒ… UIê°€ ì•„ë‹Œ ê²Œì„ UIë¡œ ìƒì‹œ ë…¸ì¶œ
 *   - RULE-006: i18n ê¸°ë°˜ ë¬¸ìì—´ ê´€ë¦¬
 *   - PRD 6.4: Rule Mutation Timeline
 *   - Q1 ê²°ì •: Option B - ë³„ë„ Timeline ì»´í¬ë„ŒíŠ¸ (ê°€ë…ì„±/í™•ì¥ ìš©ì´)
 *
 * @module components/MutationTimeline
 */

import { useTranslation } from 'react-i18next';
import { useWorldStore, selectMutationTimeline } from '../stores/worldStore';
import type { MutationEvent } from '../stores/worldStore';

// =============================================================================
// ìƒìˆ˜
// =============================================================================

/** í‘œì‹œí•  ìµœëŒ€ ì´ë²¤íŠ¸ ìˆ˜ (MMPì—ì„œ ìŠ¤í¬ë¡¤/ìš”ì•½ ì „ëµ ì ìš© ì˜ˆì •) */
const MAX_DISPLAY_EVENTS = 10;

// =============================================================================
// í•˜ìœ„ ì»´í¬ë„ŒíŠ¸
// =============================================================================

interface TimelineEventProps {
  event: MutationEvent;
}

/**
 * ê°œë³„ íƒ€ì„ë¼ì¸ ì´ë²¤íŠ¸ ë Œë”ë§
 */
function TimelineEvent({ event }: TimelineEventProps) {
  const { t } = useTranslation();

  // ì´ë²¤íŠ¸ ìœ í˜•ë³„ ì•„ì´ì½˜
  const typeIcon = {
    added: 'â•',
    modified: 'ğŸ”„',
    removed: 'â–',
  }[event.type];

  // ì´ë²¤íŠ¸ ìœ í˜•ë³„ CSS í´ë˜ìŠ¤
  const typeClass = `timeline-event-${event.type}`;

  return (
    <div className={`timeline-event ${typeClass}`} data-event-type={event.type}>
      <div className="timeline-event-marker">
        <span className="timeline-event-icon" aria-hidden="true">
          {typeIcon}
        </span>
        <span className="timeline-event-turn">
          {t('mutation.turn_label', { turn: event.turn })}
        </span>
      </div>
      <div className="timeline-event-content">
        <span className="timeline-event-label">{event.label}</span>
        <span className="timeline-event-type">{t(`mutation.type.${event.type}`)}</span>
        {event.description && <p className="timeline-event-description">{event.description}</p>}
      </div>
    </div>
  );
}

// =============================================================================
// ë©”ì¸ ì»´í¬ë„ŒíŠ¸
// =============================================================================

/**
 * Mutation Timeline
 *
 * ê·œì¹™ ë³€í˜• ì´ë²¤íŠ¸ë¥¼ ì‹œê°„ìˆœ(ìµœì‹  ë¨¼ì €)ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
 * worldStoreì˜ mutationTimeline ìƒíƒœë¥¼ êµ¬ë…í•˜ì—¬ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.
 */
export function MutationTimeline() {
  const { t } = useTranslation();
  const mutationTimeline = useWorldStore(selectMutationTimeline);

  // í‘œì‹œí•  ì´ë²¤íŠ¸ (ìµœëŒ€ ê°œìˆ˜ ì œí•œ)
  const displayEvents = mutationTimeline.slice(0, MAX_DISPLAY_EVENTS);
  const hasMore = mutationTimeline.length > MAX_DISPLAY_EVENTS;

  // ë¹ˆ ìƒíƒœ
  if (mutationTimeline.length === 0) {
    return (
      <div className="mutation-timeline-content timeline-empty" data-ui-importance="critical">
        <div className="timeline-empty-icon" aria-hidden="true">
          ğŸ“Š
        </div>
        <p className="timeline-empty-text">{t('mutation.empty')}</p>
      </div>
    );
  }

  return (
    <div className="mutation-timeline-content" data-ui-importance="critical">
      <div className="timeline-header">
        <span className="timeline-title">{t('mutation.timeline_title')}</span>
        <span className="timeline-count">
          {t('mutation.event_count', { count: mutationTimeline.length })}
        </span>
      </div>
      <div className="timeline-events" role="list" aria-label={t('mutation.timeline_title')}>
        {displayEvents.map((event, index) => (
          <TimelineEvent key={`${event.ruleId}-${event.turn}-${index}`} event={event} />
        ))}
      </div>
      {hasMore && (
        <div className="timeline-more">
          <span className="timeline-more-text">
            {t('mutation.more_events', { count: mutationTimeline.length - MAX_DISPLAY_EVENTS })}
          </span>
        </div>
      )}
    </div>
  );
}

export default MutationTimeline;
</file>

<file path="frontend/src/components/Panel.tsx">
import { useTranslation } from 'react-i18next';

interface PanelProps {
  title: string;
  children?: React.ReactNode;
  className?: string;
  /** U-032: Chrome ì¥ì‹ ì ìš© ì—¬ë¶€ */
  hasChrome?: boolean;
  /** ê¸°ë³¸ placeholder i18n í‚¤ (childrenì´ ì—†ì„ ë•Œ ì‚¬ìš©) */
  placeholderKey?: string;
}

export function Panel({
  title,
  children,
  className = '',
  hasChrome = false,
  placeholderKey,
}: PanelProps) {
  const { t } = useTranslation();
  const panelClass = `panel ${className} ${hasChrome ? 'has-chrome' : ''}`.trim();
  const headerClass = `panel-header ${hasChrome ? 'has-chrome' : ''}`.trim();

  return (
    <div className={panelClass}>
      <div className={headerClass}>
        <span className="panel-title">{title}</span>
      </div>
      <div className="panel-content">
        {children || (
          <p className="panel-placeholder">
            {placeholderKey ? t(placeholderKey) : t('ui.panel_placeholder')}
          </p>
        )}
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/components/ResetButton.tsx">
/**
 * Unknown World - ë¦¬ì…‹ ë²„íŠ¼ ì»´í¬ë„ŒíŠ¸ (U-015[Mvp]).
 *
 * 1íšŒ í´ë¦­ìœ¼ë¡œ í˜„ì¬ í”„ë¡œí•„ì˜ ì´ˆê¸° ìƒíƒœë¡œ ë³µêµ¬í•˜ëŠ” ë²„íŠ¼ì…ë‹ˆë‹¤.
 * ë°ëª¨ ë°˜ë³µ ê°€ëŠ¥ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤.
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - PRD 6.9: ì¦‰ì‹œ ë¦¬ì…‹ 1íšŒë¡œ ë°ëª¨ ë°˜ë³µ ê°€ëŠ¥
 *   - RULE-006: i18n í‚¤ ê¸°ë°˜ ë‹¤êµ­ì–´ ì§€ì›
 *
 * @module components/ResetButton
 */

import { useCallback, useState } from 'react';
import { useTranslation } from 'react-i18next';

// =============================================================================
// íƒ€ì… ì •ì˜
// =============================================================================

export interface ResetButtonProps {
  /** ë¦¬ì…‹ í´ë¦­ ì‹œ í˜¸ì¶œë˜ëŠ” ì½œë°± */
  onReset: () => void;
  /** ë¹„í™œì„±í™” ì—¬ë¶€ */
  disabled?: boolean;
  /** í™•ì¸ í•„ìš” ì—¬ë¶€ (ê¸°ë³¸: true) */
  requireConfirm?: boolean;
  /** ì¶”ê°€ í´ë˜ìŠ¤ëª… */
  className?: string;
  /** ì»´íŒ©íŠ¸ ëª¨ë“œ (ì•„ì´ì½˜ë§Œ í‘œì‹œ) */
  compact?: boolean;
}

// =============================================================================
// ì»´í¬ë„ŒíŠ¸
// =============================================================================

/**
 * ê²Œì„ ë¦¬ì…‹ ë²„íŠ¼.
 * í˜„ì¬ í”„ë¡œí•„ì˜ ì´ˆê¸° ìƒíƒœë¡œ ë³µêµ¬í•©ë‹ˆë‹¤.
 */
export function ResetButton({
  onReset,
  disabled = false,
  requireConfirm = true,
  className = '',
  compact = false,
}: ResetButtonProps) {
  const { t } = useTranslation();
  const [isConfirming, setIsConfirming] = useState(false);

  const handleClick = useCallback(() => {
    if (requireConfirm && !isConfirming) {
      // í™•ì¸ ëª¨ë“œë¡œ ì „í™˜
      setIsConfirming(true);
      // 3ì´ˆ í›„ ìë™ ì·¨ì†Œ
      setTimeout(() => setIsConfirming(false), 3000);
      return;
    }

    // ë¦¬ì…‹ ì‹¤í–‰
    onReset();
    setIsConfirming(false);
  }, [onReset, requireConfirm, isConfirming]);

  const handleCancel = useCallback(() => {
    setIsConfirming(false);
  }, []);

  const buttonText = isConfirming ? t('reset.confirm') : compact ? '' : t('reset.button');

  const buttonAriaLabel = isConfirming ? t('reset.confirm') : t('reset.button');

  return (
    <div className={`reset-button-wrapper ${className}`.trim()}>
      <button
        type="button"
        className={`reset-button ${isConfirming ? 'confirming' : ''} ${compact ? 'compact' : ''}`}
        onClick={handleClick}
        disabled={disabled}
        aria-label={buttonAriaLabel}
        title={t('reset.tooltip')}
      >
        <span className="reset-icon" aria-hidden="true">
          ğŸ”„
        </span>
        {buttonText && <span className="reset-text">{buttonText}</span>}
      </button>

      {isConfirming && requireConfirm && (
        <button
          type="button"
          className="reset-cancel-button"
          onClick={handleCancel}
          aria-label={t('reset.cancel')}
        >
          âœ•
        </button>
      )}
    </div>
  );
}

// =============================================================================
// í”„ë¡œí•„ ë³€ê²½ ë²„íŠ¼ (ë³„ë„ ì»´í¬ë„ŒíŠ¸)
// =============================================================================

export interface ChangeProfileButtonProps {
  /** í´ë¦­ ì‹œ í˜¸ì¶œë˜ëŠ” ì½œë°± */
  onClick: () => void;
  /** ë¹„í™œì„±í™” ì—¬ë¶€ */
  disabled?: boolean;
  /** ì¶”ê°€ í´ë˜ìŠ¤ëª… */
  className?: string;
}

/**
 * í”„ë¡œí•„ ë³€ê²½ ë²„íŠ¼.
 * í´ë¦­ ì‹œ í”„ë¡œí•„ ì„ íƒ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.
 */
export function ChangeProfileButton({
  onClick,
  disabled = false,
  className = '',
}: ChangeProfileButtonProps) {
  const { t } = useTranslation();

  return (
    <button
      type="button"
      className={`change-profile-button ${className}`.trim()}
      onClick={onClick}
      disabled={disabled}
      aria-label={t('profile.change')}
      title={t('profile.change_tooltip')}
    >
      <span className="change-profile-icon" aria-hidden="true">
        ğŸ‘¤
      </span>
      <span className="change-profile-text">{t('profile.change')}</span>
    </button>
  );
}
</file>

<file path="frontend/src/components/RuleBoard.tsx">
/**
 * Unknown World - Rule Board (U-013)
 *
 * í˜„ì¬ ì„¸ê³„ì— ì ìš© ì¤‘ì¸ ê·œì¹™/ë¬¼ë¦¬ ë²•ì¹™ì„ "ë£° ì¹´ë“œ"ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - RULE-002: ì±„íŒ… UIê°€ ì•„ë‹Œ ê²Œì„ UIë¡œ ìƒì‹œ ë…¸ì¶œ
 *   - RULE-006: i18n ê¸°ë°˜ ë¬¸ìì—´ ê´€ë¦¬
 *   - PRD 6.4/6.7: Rule Mutation + Rule Board
 *
 * @module components/RuleBoard
 */

import { useTranslation } from 'react-i18next';
import { useWorldStore, selectActiveRules } from '../stores/worldStore';
import type { WorldRule } from '../schemas/turn';

// =============================================================================
// í•˜ìœ„ ì»´í¬ë„ŒíŠ¸
// =============================================================================

interface RuleCardProps {
  rule: WorldRule;
}

/**
 * ê°œë³„ ë£° ì¹´ë“œ ë Œë”ë§
 */
function RuleCard({ rule }: RuleCardProps) {
  return (
    <div className="rule-card" data-rule-id={rule.id}>
      <div className="rule-card-header">
        <span className="rule-card-icon" aria-hidden="true">
          âš™
        </span>
        <span className="rule-card-label">{rule.label}</span>
      </div>
      {rule.description && <p className="rule-card-description">{rule.description}</p>}
    </div>
  );
}

// =============================================================================
// ë©”ì¸ ì»´í¬ë„ŒíŠ¸
// =============================================================================

/**
 * Rule Board
 *
 * í˜„ì¬ ì„¸ê³„ì— ì ìš© ì¤‘ì¸ ê·œì¹™ì„ ì¹´ë“œ í˜•íƒœë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
 * worldStoreì˜ activeRules ìƒíƒœë¥¼ êµ¬ë…í•˜ì—¬ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.
 */
export function RuleBoard() {
  const { t } = useTranslation();
  const activeRules = useWorldStore(selectActiveRules);

  // ë¹ˆ ìƒíƒœ
  if (activeRules.length === 0) {
    return (
      <div className="rule-board-content rule-board-empty" data-ui-importance="critical">
        <div className="rule-board-empty-icon" aria-hidden="true">
          ğŸ“œ
        </div>
        <p className="rule-board-empty-text">{t('rule_board.empty')}</p>
      </div>
    );
  }

  return (
    <div className="rule-board-content" data-ui-importance="critical">
      <div className="rule-board-header">
        <span className="rule-board-count">
          {t('rule_board.active_count', { count: activeRules.length })}
        </span>
      </div>
      <div className="rule-card-list">
        {activeRules.map((rule) => (
          <RuleCard key={rule.id} rule={rule} />
        ))}
      </div>
    </div>
  );
}

export default RuleBoard;
</file>

<file path="frontend/src/components/UIControls.tsx">
import { useTranslation } from 'react-i18next';
import { UI_SCALES, type UIScale } from '../stores/uiPrefsStore';

interface UIControlsProps {
  uiScale: UIScale;
  onIncreaseScale: () => void;
  onDecreaseScale: () => void;
}

export function UIControls({ uiScale, onIncreaseScale, onDecreaseScale }: UIControlsProps) {
  const { t } = useTranslation();
  const isMinScale = uiScale === UI_SCALES[0];
  const isMaxScale = uiScale === UI_SCALES[UI_SCALES.length - 1];

  return (
    <div className="ui-controls" role="group" aria-label={t('ui.scale_label')}>
      {/* UI ìŠ¤ì¼€ì¼ ì¡°ì ˆ */}
      <button
        type="button"
        className="ui-scale-btn"
        onClick={onDecreaseScale}
        disabled={isMinScale}
        aria-label={t('ui.scale_decrease')}
        title={`${t('ui.scale_decrease')} (A-)`}
      >
        A-
      </button>
      <span className="ui-scale-display" aria-live="polite">
        {Math.round(uiScale * 100)}%
      </span>
      <button
        type="button"
        className="ui-scale-btn"
        onClick={onIncreaseScale}
        disabled={isMaxScale}
        aria-label={t('ui.scale_increase')}
        title={`${t('ui.scale_increase')} (A+)`}
      >
        A+
      </button>
    </div>
  );
}
</file>

<file path="frontend/src/dnd/types.ts">
/**
 * Unknown World - DnD íƒ€ì… ë° ìƒìˆ˜ ì •ì˜ (RU-003-Q1).
 *
 * DnD ë°ì´í„° ê³„ì•½ì„ SSOTë¡œ ê´€ë¦¬í•˜ì—¬ íƒ€ì… ì•ˆì „ì„±ì„ í™•ë³´í•©ë‹ˆë‹¤.
 * ëª¨ë“  ë“œë˜ê·¸/ë“œë¡­ ì´ë²¤íŠ¸ì—ì„œ ë™ì¼í•œ ìƒìˆ˜/íƒ€ì…ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - SSOT: ë“œë˜ê·¸/ë“œë¡­ íƒ€ì… ë¬¸ìì—´ì€ ì´ ëª¨ë“ˆì—ì„œë§Œ ì •ì˜
 *   - íƒ€ì… ì•ˆì „ì„±: dnd-kitì˜ data.currentë¥¼ íƒ€ì… ê°€ë“œë¡œ ê²€ì¦
 *   - ê³¼ë„í•œ ì¶”ìƒí™” ê¸ˆì§€: ìƒìˆ˜/íƒ€ì…ë§Œ ì œê³µ, ë¡œì§ì€ ì»´í¬ë„ŒíŠ¸ì— ìœ ì§€
 *
 * @module dnd/types
 */

import type { Box2D } from '../schemas/turn';
import type { InventoryItem } from '../stores/inventoryStore';

// =============================================================================
// DnD íƒ€ì… ìƒìˆ˜ (SSOT)
// =============================================================================

/**
 * DnD íƒ€ì… ìƒìˆ˜.
 * ë“œë˜ê·¸/ë“œë¡­ ë°ì´í„°ì˜ type í•„ë“œì— ì‚¬ìš©ë©ë‹ˆë‹¤.
 */
export const DND_TYPE = {
  /** ì¸ë²¤í† ë¦¬ ì•„ì´í…œ ë“œë˜ê·¸ */
  INVENTORY_ITEM: 'inventory-item',
  /** í•«ìŠ¤íŒŸ ë“œë¡­ íƒ€ê²Ÿ */
  HOTSPOT: 'hotspot',
} as const;

// =============================================================================
// RU-003-S2: ì¸í„°ë™ì…˜ í—ˆìš© ì •ì±… (SSOT)
// =============================================================================

/**
 * í•«ìŠ¤íŒŸ ì¸í„°ë™ì…˜ì´ í—ˆìš©ë˜ëŠ” Scene ìƒíƒœ ëª©ë¡.
 *
 * RU-003-S2 Step 1: Option A(ë°ëª¨ ìœ ì§€) ê²°ì •
 * - 'scene': ì‹¤ì œ ì¥ë©´ í™œì„±í™” ìƒíƒœ
 * - 'default': ë°ëª¨/í”Œë ˆì´ìŠ¤í™€ë” ìƒíƒœ (ì‹œê°ì  íŒíŠ¸ í•„ìš”)
 *
 * @see SceneCanvas.tsxì˜ shouldRenderHotspots ì¡°ê±´
 */
export const HOTSPOT_INTERACTION_ALLOWED_STATES = ['scene', 'default'] as const;

/**
 * ì¸í„°ë™ì…˜ í—ˆìš© ìƒíƒœ íƒ€ì….
 */
export type HotspotInteractionState = (typeof HOTSPOT_INTERACTION_ALLOWED_STATES)[number];

/**
 * ì£¼ì–´ì§„ ìƒíƒœì—ì„œ í•«ìŠ¤íŒŸ ì¸í„°ë™ì…˜ì´ í—ˆìš©ë˜ëŠ”ì§€ ê²€ì‚¬í•©ë‹ˆë‹¤.
 *
 * RU-003-S2: ì¸í„°ë™ì…˜ ê°€ëŠ¥ ì¡°ê±´ì„ SSOTë¡œ ê³ ì •
 *
 * @param status - Scene ìƒíƒœ
 * @returns ì¸í„°ë™ì…˜ í—ˆìš© ì—¬ë¶€
 */
export function isHotspotInteractionAllowed(status: string): boolean {
  return HOTSPOT_INTERACTION_ALLOWED_STATES.includes(status as HotspotInteractionState);
}

// =============================================================================
// RU-003-S2 Step 4: ìŠ¤íŠ¸ë¦¬ë° ë¹„í™œì„±í™” ì •ì±… (SSOT)
// =============================================================================

/**
 * ìŠ¤íŠ¸ë¦¬ë° ë¹„í™œì„±í™” ì •ì±….
 *
 * RU-003-S2 Step 4: disabled í”Œë˜ê·¸ì˜ SSOT ê³ ì •
 * - isStreamingì€ agentStoreì—ì„œë§Œ ì œê³µ
 * - ëª¨ë“  ì¸í„°ë™ì…˜ ì»´í¬ë„ŒíŠ¸(SceneCanvas, InventoryPanel, ActionDeck)ëŠ”
 *   ë™ì¼í•œ disabled í”Œë˜ê·¸ë¥¼ ê³µìœ í•´ì•¼ í•¨
 * - í–¥í›„ worldStore/Turn Runner ë„ì… ì‹œì—ë„ ì´ ì›ì¹™ì„ ìœ ì§€
 *
 * @see App.tsxì˜ isStreaming ì‚¬ìš© íŒ¨í„´
 * @see agentStore.tsì˜ isStreaming ìƒíƒœ
 */
export const STREAMING_DISABLED_POLICY = {
  /** ìŠ¤íŠ¸ë¦¬ë° ìƒíƒœ SSOT ì¶œì²˜ */
  source: 'agentStore.isStreaming',
  /** ë¹„í™œì„±í™” ì ìš© ëŒ€ìƒ ì»´í¬ë„ŒíŠ¸ */
  affectedComponents: ['SceneCanvas', 'InventoryPanel', 'ActionDeck', 'CommandInput'],
} as const;

/**
 * DnD íƒ€ì… ìœ ë‹ˆì˜¨.
 */
export type DndType = (typeof DND_TYPE)[keyof typeof DND_TYPE];

// =============================================================================
// ë“œë˜ê·¸ ë°ì´í„° íƒ€ì…
// =============================================================================

/**
 * ì¸ë²¤í† ë¦¬ ì•„ì´í…œ ë“œë˜ê·¸ ë°ì´í„°.
 * InventoryPanelì—ì„œ ë“œë˜ê·¸ ì‹œì‘ ì‹œ ì„¤ì •ë©ë‹ˆë‹¤.
 */
export interface InventoryDragData {
  /** ë“œë˜ê·¸ íƒ€ì… (í•­ìƒ 'inventory-item') */
  type: typeof DND_TYPE.INVENTORY_ITEM;
  /** ë“œë˜ê·¸ ì¤‘ì¸ ì•„ì´í…œ ID */
  item_id: string;
  /** ë“œë˜ê·¸ ì¤‘ì¸ ì•„ì´í…œ ê°ì²´ */
  item: InventoryItem;
}

// =============================================================================
// ë“œë¡­ ë°ì´í„° íƒ€ì…
// =============================================================================

/**
 * í•«ìŠ¤íŒŸ ë“œë¡­ íƒ€ê²Ÿ ë°ì´í„°.
 * SceneCanvasì˜ í•«ìŠ¤íŒŸì—ì„œ ì„¤ì •ë©ë‹ˆë‹¤.
 */
export interface HotspotDropData {
  /** ë“œë¡­ íƒ€ê²Ÿ íƒ€ì… (í•­ìƒ 'hotspot') */
  type: typeof DND_TYPE.HOTSPOT;
  /** í•«ìŠ¤íŒŸ ì˜¤ë¸Œì íŠ¸ ID */
  object_id: string;
  /** í•«ìŠ¤íŒŸ ë°”ìš´ë”© ë°•ìŠ¤ (0~1000 ì •ê·œí™”) */
  box_2d: Box2D;
  /** í•«ìŠ¤íŒŸ ë¼ë²¨ (í‘œì‹œìš©) */
  label: string;
}

// =============================================================================
// íƒ€ì… ê°€ë“œ í•¨ìˆ˜
// =============================================================================

/**
 * ë°ì´í„°ê°€ InventoryDragDataì¸ì§€ ê²€ì‚¬í•©ë‹ˆë‹¤.
 *
 * @param data - dnd-kitì˜ active.data.current
 * @returns InventoryDragDataì´ë©´ true
 */
export function isInventoryDragData(data: unknown): data is InventoryDragData {
  if (typeof data !== 'object' || data === null) {
    return false;
  }
  const obj = data as Record<string, unknown>;
  return (
    obj.type === DND_TYPE.INVENTORY_ITEM &&
    typeof obj.item_id === 'string' &&
    typeof obj.item === 'object' &&
    obj.item !== null
  );
}

/**
 * ë°ì´í„°ê°€ HotspotDropDataì¸ì§€ ê²€ì‚¬í•©ë‹ˆë‹¤.
 *
 * @param data - dnd-kitì˜ over.data.current
 * @returns HotspotDropDataì´ë©´ true
 */
export function isHotspotDropData(data: unknown): data is HotspotDropData {
  if (typeof data !== 'object' || data === null) {
    return false;
  }
  const obj = data as Record<string, unknown>;
  return (
    obj.type === DND_TYPE.HOTSPOT &&
    typeof obj.object_id === 'string' &&
    typeof obj.box_2d === 'object' &&
    obj.box_2d !== null &&
    typeof obj.label === 'string'
  );
}

// =============================================================================
// RU-003-S2 Step 2: í•«ìŠ¤íŒŸ ìš°ì„ ìˆœìœ„ ì •ì±… (SSOT)
// =============================================================================

/**
 * ë°”ìš´ë”© ë°•ìŠ¤ì˜ ë©´ì ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
 *
 * @param box - { ymin, xmin, ymax, xmax } í˜•ì‹ì˜ ë°”ìš´ë”© ë°•ìŠ¤
 * @returns ë°•ìŠ¤ ë©´ì 
 */
export function calculateBoxArea(box: Box2D): number {
  const { ymin, xmin, ymax, xmax } = box;
  return Math.abs(ymax - ymin) * Math.abs(xmax - xmin);
}

/**
 * í•«ìŠ¤íŒŸ ìš°ì„ ìˆœìœ„ ê³„ì‚°ì„ ìœ„í•œ ë¹„êµ í•¨ìˆ˜.
 *
 * RU-003-S2 Step 2: ì‘ì€ bboxê°€ ë” ë†’ì€ ìš°ì„ ìˆœìœ„ë¥¼ ê°€ì§
 * - ë” ì‘ì€ ì˜¤ë¸Œì íŠ¸ê°€ ë” êµ¬ì²´ì ì¸ íƒ€ê²Ÿì´ë¼ê³  ê°€ì •
 * - z-index ê´€ì ì—ì„œ ì‘ì€ ê²ƒì´ ìœ„ì— ë Œë”ë˜ì–´ì•¼ í•¨
 *
 * @param a - ì²« ë²ˆì§¸ ë°”ìš´ë”© ë°•ìŠ¤
 * @param b - ë‘ ë²ˆì§¸ ë°”ìš´ë”© ë°•ìŠ¤
 * @returns ì •ë ¬ ìˆœì„œ (ì‘ì€ ê²ƒì´ ë’¤ë¡œ ê°€ì„œ z-indexê°€ ë†’ì•„ì§)
 */
export function compareHotspotPriority(a: Box2D, b: Box2D): number {
  return calculateBoxArea(b) - calculateBoxArea(a);
}
</file>

<file path="frontend/src/i18n.ts">
/**
 * Unknown World - i18n ì´ˆê¸°í™” ëª¨ë“ˆ
 *
 * ì–¸ì–´ ë¦¬ì†ŒìŠ¤ë¥¼ JSON íŒŒì¼ êµ¬ì¡°ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.
 * RULE-006 ì¤€ìˆ˜: ko/en í˜¼í•© ì¶œë ¥ ê¸ˆì§€, i18n í‚¤ ê¸°ë°˜ SSOT
 *
 * ì–¸ì–´ ì½”ë“œ: BCP-47 í˜•ì‹ (ko-KR, en-US)
 * - TurnInput/SaveGameì˜ language í•„ë“œì™€ ë™ì¼í•œ ì¶•
 *
 * @see vibe/prd.md 3.1(ì§€ì› ì–¸ì–´), 8.7(TurnInput.language)
 * @see frontend/src/locales/README.md
 */

import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';

// JSON ì–¸ì–´ ë¦¬ì†ŒìŠ¤ import (SSOT: locales/{lang}/translation.json)
import koKR from './locales/ko-KR/translation.json';
import enUS from './locales/en-US/translation.json';

/** ì§€ì› ì–¸ì–´ íƒ€ì… (TurnInput.languageì™€ ë™ê¸°í™”) */
export type SupportedLanguage = 'ko-KR' | 'en-US';

/** ê¸°ë³¸ ì–¸ì–´ (ë°ëª¨ ì¼ê´€ì„±ì„ ìœ„í•´ ko-KR ê³ ì •) */
export const DEFAULT_LANGUAGE: SupportedLanguage = 'ko-KR';

/** í´ë°± ì–¸ì–´ */
export const FALLBACK_LANGUAGE: SupportedLanguage = 'en-US';

/** ì§€ì› ì–¸ì–´ ëª©ë¡ */
export const SUPPORTED_LANGUAGES: SupportedLanguage[] = ['ko-KR', 'en-US'];

// i18n ë¦¬ì†ŒìŠ¤ ì •ì˜ (BCP-47 í˜•ì‹ ì–¸ì–´ ì½”ë“œ)
const resources = {
  'ko-KR': {
    translation: koKR,
  },
  'en-US': {
    translation: enUS,
  },
};

i18n.use(initReactI18next).init({
  resources,
  lng: DEFAULT_LANGUAGE,
  fallbackLng: FALLBACK_LANGUAGE,
  supportedLngs: SUPPORTED_LANGUAGES,
  interpolation: {
    escapeValue: false, // Reactì—ì„œ ì´ë¯¸ XSS ë°©ì§€
  },
  // ëˆ„ë½ í‚¤ ì²˜ë¦¬ (ê°œë°œ ëª¨ë“œì—ì„œ ê²½ê³ )
  saveMissing: false,
  missingKeyHandler: (_lngs, _ns, key) => {
    if (import.meta.env.DEV) {
      console.warn(`[i18n] Missing translation key: "${key}"`);
    }
  },
});

/**
 * í˜„ì¬ í•´ê²°ëœ ì–¸ì–´ ì½”ë“œë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
 * TurnInput.languageì™€ ë™ê¸°í™”í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
 */
export function getResolvedLanguage(): SupportedLanguage {
  return (i18n.resolvedLanguage as SupportedLanguage) || DEFAULT_LANGUAGE;
}

/**
 * ì–¸ì–´ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.
 * í–¥í›„ U-036 ì™„ë£Œ í›„ ì‚¬ìš©ìì—ê²Œ ë…¸ì¶œí•  í† ê¸€ì—ì„œ ì‚¬ìš©í•©ë‹ˆë‹¤.
 */
export async function changeLanguage(lang: SupportedLanguage): Promise<void> {
  await i18n.changeLanguage(lang);
}

export default i18n;
</file>

<file path="frontend/src/locales/README.md">
# i18n ì–¸ì–´ ë¦¬ì†ŒìŠ¤ ê°€ì´ë“œ (Unknown World)

ì´ ë””ë ‰í† ë¦¬ëŠ” Unknown Worldì˜ **í”„ë¡ íŠ¸ì—”ë“œ UI ë¬¸ìì—´ ë¦¬ì†ŒìŠ¤**ë¥¼ ê´€ë¦¬í•˜ëŠ” SSOT(Single Source of Truth)ì…ë‹ˆë‹¤.

## ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
locales/
â”œâ”€â”€ ko-KR/
â”‚   â””â”€â”€ translation.json    # í•œêµ­ì–´ ë¦¬ì†ŒìŠ¤
â”œâ”€â”€ en-US/
â”‚   â””â”€â”€ translation.json    # ì˜ì–´ ë¦¬ì†ŒìŠ¤
â””â”€â”€ README.md               # ì´ ë¬¸ì„œ
```

## ì§€ì› ì–¸ì–´

| ì½”ë“œ    | ì–¸ì–´   | ìƒíƒœ | ë¹„ê³            |
| ------- | ------ | ---- | -------------- |
| `ko-KR` | í•œêµ­ì–´ | ê¸°ë³¸ | ë°ëª¨ ê¸°ì¤€ ì–¸ì–´ |
| `en-US` | ì˜ì–´   | í´ë°± | fallbackLng    |

> **ì–¸ì–´ ì½”ë“œ ê·œì¹™**: BCP-47 í˜•ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤ (`ko-KR`, `en-US`).  
> TurnInput/SaveGameì˜ `language` í•„ë“œì™€ ë™ì¼í•œ ì¶•ì…ë‹ˆë‹¤.

## í‚¤ ë„¤ì´ë° ê·œì¹™

í‚¤ëŠ” **ë„ë©”ì¸.ì„¹ì…˜.í•­ëª©** í˜•íƒœì˜ ê³„ì¸µ êµ¬ì¡°ë¥¼ ë”°ë¦…ë‹ˆë‹¤.

### ë„ë©”ì¸ ëª©ë¡

| ë„ë©”ì¸       | ìš©ë„                                    |
| ------------ | --------------------------------------- |
| `scene`      | Scene Canvas ê´€ë ¨ ë©”ì‹œì§€                |
| `agent`      | Agent Console ê´€ë ¨ ë¼ë²¨/ìƒíƒœ            |
| `ui`         | ê³µí†µ UI ìš”ì†Œ (ë²„íŠ¼, ì…ë ¥, í”Œë ˆì´ìŠ¤í™€ë”) |
| `economy`    | ì¬í™” ê´€ë ¨ ë¼ë²¨                          |
| `connection` | ì—°ê²° ìƒíƒœ                               |
| `panel`      | íŒ¨ë„ë³„ íƒ€ì´í‹€/í”Œë ˆì´ìŠ¤í™€ë”              |
| `action`     | ì•¡ì…˜ ì¹´ë“œ/ì„ íƒì§€                        |
| `narrative`  | ë‚´ëŸ¬í‹°ë¸Œ/ê²Œì„ ë¡œê·¸                      |

### ì˜ˆì‹œ

```json
{
  "scene.status.loading": "ë™ê¸°í™” ì¤‘...",
  "agent.console.badges": "ê²€ì¦ ë°°ì§€",
  "ui.execute": "ì‹¤í–‰",
  "panel.inventory.placeholder": "[ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì˜ì—­ ]"
}
```

## ìƒˆ ì–¸ì–´ ì¶”ê°€ ì ˆì°¨

1. **ë””ë ‰í† ë¦¬ ìƒì„±**: `locales/{ì–¸ì–´ì½”ë“œ}/` ìƒì„± (ì˜ˆ: `ja-JP`)
2. **translation.json ë³µì‚¬**: `ko-KR/translation.json`ì„ ë³µì‚¬í•˜ì—¬ ì‹œì‘ì ìœ¼ë¡œ ì‚¬ìš©
3. **ë²ˆì—­ ì‘ì—…**: ëª¨ë“  ê°’ì„ í•´ë‹¹ ì–¸ì–´ë¡œ ë²ˆì—­
4. **i18n.ts ë“±ë¡**: `frontend/src/i18n.ts`ì— ìƒˆ ì–¸ì–´ ë¦¬ì†ŒìŠ¤ import ë° ë“±ë¡
5. **ê²€ì¦**: ëˆ„ë½ëœ í‚¤ê°€ ì—†ëŠ”ì§€ í™•ì¸ (i18nextì˜ `missingKeyHandler` í™œìš©)

```typescript
// frontend/src/i18n.ts
import jaJP from './locales/ja-JP/translation.json';

const resources = {
  'ko-KR': { translation: koKR },
  'en-US': { translation: enUS },
  'ja-JP': { translation: jaJP }, // ìƒˆ ì–¸ì–´ ì¶”ê°€
};
```

## ì‚¬ìš© ë°©ë²•

### ê¸°ë³¸ ì‚¬ìš©

```tsx
import { useTranslation } from 'react-i18next';

function MyComponent() {
  const { t } = useTranslation();

  return <button>{t('ui.execute')}</button>;
}
```

### ë³´ê°„ (Interpolation)

```tsx
// JSON
{ "narrative.turn_label": "[TURN {{turn}}]" }

// ì»´í¬ë„ŒíŠ¸
<span>{t('narrative.turn_label', { turn: 5 })}</span>
// ê²°ê³¼: "[TURN 5]"
```

### ì–¸ì–´ ë³€ê²½ (í–¥í›„)

```tsx
import { useTranslation } from 'react-i18next';

function LanguageToggle() {
  const { i18n } = useTranslation();

  const toggleLanguage = () => {
    const newLang = i18n.resolvedLanguage === 'ko-KR' ? 'en-US' : 'ko-KR';
    i18n.changeLanguage(newLang);
  };

  return <button onClick={toggleLanguage}>ğŸŒ</button>;
}
```

## ê¸ˆì§€ì‚¬í•­

### âŒ í…ìŠ¤íŠ¸ë¥¼ ì´ë¯¸ì§€ì— í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”

ì´ë¯¸ì§€ì— í…ìŠ¤íŠ¸ë¥¼ ë°•ìœ¼ë©´:

- ì–¸ì–´ ë³€ê²½ ì‹œ ì´ë¯¸ì§€ë¥¼ êµì²´í•´ì•¼ í•¨
- ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ê°€ë…ì„± ì €í•˜
- ì ‘ê·¼ì„± ë¬¸ì œ (ìŠ¤í¬ë¦° ë¦¬ë”)

**ëŒ€ì‹ **: ì´ë¯¸ì§€ì™€ í…ìŠ¤íŠ¸ë¥¼ ë¶„ë¦¬í•˜ê³ , í…ìŠ¤íŠ¸ëŠ” i18n í‚¤ë¡œ ê´€ë¦¬

### âŒ í•˜ë“œì½”ë”© ë¬¸ìì—´ ê¸ˆì§€

```tsx
// âŒ Bad
<button>ì‹¤í–‰</button>

// âœ… Good
<button>{t('ui.execute')}</button>
```

### âŒ ko/en í˜¼í•© ì¶œë ¥ ê¸ˆì§€ (RULE-006)

ë™ì¼ í™”ë©´ì—ì„œ í•œêµ­ì–´ì™€ ì˜ì–´ê°€ ì„ì—¬ ë‚˜ì˜¤ë©´ ì•ˆ ë©ë‹ˆë‹¤.
ëª¨ë“  UI ë¬¸ìì—´ì€ í˜„ì¬ ì„ íƒëœ ì–¸ì–´ë¡œ ì¼ê´€ë˜ê²Œ í‘œì‹œë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

### âŒ í‚¤ ì„ì˜ ì‚­ì œ/ë³€ê²½ ê¸ˆì§€

í‚¤ë¥¼ ì‚­ì œí•˜ê±°ë‚˜ ì´ë¦„ì„ ë³€ê²½í•˜ë©´ ê¸°ì¡´ ì½”ë“œì—ì„œ ì°¸ì¡° ì˜¤ë¥˜ê°€ ë°œìƒí•©ë‹ˆë‹¤.

- ì‚­ì œ: deprecated ë§ˆí‚¹ í›„ ì¶©ë¶„í•œ ê¸°ê°„ì„ ë‘ê³  ì œê±°
- ë³€ê²½: ìƒˆ í‚¤ ì¶”ê°€ â†’ ë§ˆì´ê·¸ë ˆì´ì…˜ â†’ êµ¬ í‚¤ ì œê±°

## ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸

ìƒˆ ë¦¬ì†ŒìŠ¤ ì¶”ê°€/ìˆ˜ì • ì‹œ:

- [ ] ëª¨ë“  ì§€ì› ì–¸ì–´ì— ë™ì¼í•œ í‚¤ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
- [ ] ë³´ê°„ ë³€ìˆ˜ëª…ì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸ (`{{variable}}`)
- [ ] ë¹Œë“œ ë° ë¦°íŠ¸ í†µê³¼
- [ ] ì‹¤ì œ UIì—ì„œ ë¬¸ìì—´ì´ ì˜¬ë°”ë¥´ê²Œ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸

## ì°¸ê³  ë¬¸ì„œ

- `vibe/prd.md` - 3.1(ì§€ì› ì–¸ì–´), 8.7(TurnInput.language)
- `vibe/tech-stack.md` - i18next/react-i18next ë²„ì „
- `.cursor/rules/00-core-critical.mdc` - RULE-006(i18n/ì–¸ì–´ í˜¼í•© ê¸ˆì§€)
- [i18next ê³µì‹ ë¬¸ì„œ](https://www.i18next.com/)
- [react-i18next ê³µì‹ ë¬¸ì„œ](https://react.i18next.com/)
</file>

<file path="frontend/src/main.tsx">
import { StrictMode } from 'react';
import { createRoot } from 'react-dom/client';
import './i18n'; // i18n ì´ˆê¸°í™”
import './style.css';
import App from './App.tsx';

createRoot(document.getElementById('root')!).render(
  <StrictMode>
    <App />
  </StrictMode>,
);
</file>

<file path="frontend/src/schemas/turn.test.ts">
import { describe, it, expect } from 'vitest';
import {
  TurnInputSchema,
  TurnOutputSchema,
  safeParseTurnOutput,
  parseTurnInput,
  safeParseTurnInput,
  SCHEMA_VERSION,
} from './turn';

describe('Turn schemas', () => {
  describe('SCHEMA_VERSION', () => {
    it('should have correct version', () => {
      expect(SCHEMA_VERSION).toBe('1.0.0');
    });
  });

  describe('TurnInputSchema', () => {
    const validTurnInput = {
      language: 'ko-KR',
      text: 'í…ŒìŠ¤íŠ¸ ì…ë ¥',
      client: {
        viewport_w: 1920,
        viewport_h: 1080,
        theme: 'dark',
      },
      economy_snapshot: {
        signal: 100,
        memory_shard: 5,
      },
    };

    it('should validate a valid TurnInput', () => {
      const result = TurnInputSchema.safeParse(validTurnInput);
      expect(result.success).toBe(true);
    });

    it('should fail on invalid language', () => {
      const result = TurnInputSchema.safeParse({
        ...validTurnInput,
        language: 'fr-FR',
      });
      expect(result.success).toBe(false);
    });

    it('should fail on negative economy values', () => {
      const result = TurnInputSchema.safeParse({
        ...validTurnInput,
        economy_snapshot: {
          signal: -1,
          memory_shard: 0,
        },
      });
      expect(result.success).toBe(false);
    });

    it('should fail on extra fields (strict)', () => {
      const result = TurnInputSchema.safeParse({
        ...validTurnInput,
        extra_field: 'not allowed',
      });
      expect(result.success).toBe(false);
    });

    it('should validate click input with bbox', () => {
      const result = TurnInputSchema.safeParse({
        ...validTurnInput,
        click: {
          object_id: 'door_01',
          box_2d: {
            ymin: 100,
            xmin: 100,
            ymax: 500,
            xmax: 500,
          },
        },
      });
      expect(result.success).toBe(true);
    });

    it('should fail on invalid bbox coordinates (out of range 0-1000)', () => {
      const result = TurnInputSchema.safeParse({
        ...validTurnInput,
        click: {
          object_id: 'door_01',
          box_2d: {
            ymin: -1,
            xmin: 0,
            ymax: 1001,
            xmax: 500,
          },
        },
      });
      expect(result.success).toBe(false);
    });

    it('should fail on non-positive viewport dimensions', () => {
      const result = TurnInputSchema.safeParse({
        ...validTurnInput,
        client: {
          viewport_w: 0,
          viewport_h: -100,
          theme: 'dark',
        },
      });
      expect(result.success).toBe(false);
    });

    it('should fail on non-integer coordinates', () => {
      const result = TurnInputSchema.safeParse({
        ...validTurnInput,
        click: {
          object_id: 'obj',
          box_2d: {
            ymin: 10.5,
            xmin: 20,
            ymax: 30,
            xmax: 40,
          },
        },
      });
      expect(result.success).toBe(false);
    });
  });

  describe('TurnOutputSchema', () => {
    const validTurnOutput = {
      language: 'ko-KR',
      narrative: 'í…ŒìŠ¤íŠ¸ ë‚´ëŸ¬í‹°ë¸Œ',
      economy: {
        cost: { signal: 5, memory_shard: 0 },
        balance_after: { signal: 95, memory_shard: 5 },
      },
      safety: {
        blocked: false,
      },
      agent_console: {
        current_phase: 'commit',
        badges: ['schema_ok', 'economy_ok'],
        repair_count: 0,
      },
    };

    it('should validate a valid TurnOutput', () => {
      const result = TurnOutputSchema.safeParse(validTurnOutput);
      expect(result.success).toBe(true);
    });

    it('should fail if required fields are missing', () => {
      const { narrative: _narrative, ...invalidOutput } = validTurnOutput;
      const result = TurnOutputSchema.safeParse(invalidOutput);
      expect(result.success).toBe(false);
    });

    it('should handle default values for optional fields', () => {
      const result = TurnOutputSchema.safeParse(validTurnOutput);
      if (result.success) {
        expect(result.data.ui).toBeDefined();
        expect(result.data.ui.action_deck.cards).toEqual([]);
        expect(result.data.world.rules_changed).toEqual([]);
      } else {
        throw new Error('Validation failed');
      }
    });

    it('should fail if there are too many action cards (max 10)', () => {
      const cards = Array.from({ length: 11 }, (_, i) => ({
        id: `card_${i}`,
        label: `Card ${i}`,
        cost: { signal: 0, memory_shard: 0 },
        risk: 'low',
      }));
      const result = TurnOutputSchema.safeParse({
        ...validTurnOutput,
        ui: {
          action_deck: { cards },
        },
      });
      expect(result.success).toBe(false);
    });

    it('should fail on negative repair_count', () => {
      const result = TurnOutputSchema.safeParse({
        ...validTurnOutput,
        agent_console: {
          current_phase: 'commit',
          badges: [],
          repair_count: -1,
        },
      });
      expect(result.success).toBe(false);
    });
  });

  describe('safeParseTurnOutput', () => {
    it('should return success for valid data', () => {
      const validTurnOutput = {
        language: 'en-US',
        narrative: 'Test narrative',
        economy: {
          cost: { signal: 0, memory_shard: 0 },
          balance_after: { signal: 100, memory_shard: 0 },
        },
        safety: { blocked: false },
      };
      const result = safeParseTurnOutput(validTurnOutput);
      expect(result.success).toBe(true);
      if (result.success) {
        expect(result.data.language).toBe('en-US');
      }
    });

    it('should return fallback for invalid data', () => {
      const invalidData = { some: 'garbage' };
      const result = safeParseTurnOutput(invalidData, 'ko-KR', 1);
      expect(result.success).toBe(false);
      if (!result.success) {
        expect(result.fallback).toBeDefined();
        expect(result.fallback.language).toBe('ko-KR');
        expect(result.fallback.agent_console.badges).toContain('schema_fail');
        expect(result.fallback.agent_console.repair_count).toBe(1);
      }
    });
  });

  describe('Input Parsing Utilities', () => {
    const validTurnInput = {
      language: 'ko-KR',
      text: 'í…ŒìŠ¤íŠ¸ ì…ë ¥',
      client: {
        viewport_w: 1920,
        viewport_h: 1080,
        theme: 'dark',
      },
      economy_snapshot: {
        signal: 100,
        memory_shard: 5,
      },
    };

    describe('parseTurnInput', () => {
      it('should parse valid input', () => {
        const result = parseTurnInput(validTurnInput);
        expect(result.text).toBe('í…ŒìŠ¤íŠ¸ ì…ë ¥');
      });

      it('should throw error for invalid input', () => {
        expect(() => parseTurnInput({})).toThrow();
      });
    });

    describe('safeParseTurnInput', () => {
      it('should return success for valid input', () => {
        const result = safeParseTurnInput(validTurnInput);
        expect(result.success).toBe(true);
      });

      it('should return failure for invalid input', () => {
        const result = safeParseTurnInput({});
        expect(result.success).toBe(false);
      });
    });
  });
});
</file>

<file path="frontend/src/schemas/verify_runbook.ts">
import {
  TurnOutputSchema,
  safeParseTurnOutput,
  Box2DSchema,
  CurrencyAmountSchema,
  LanguageSchema,
  parseTurnInput,
} from './turn.js';

console.log('--- Scenario A: TurnOutput ìŠ¤í‚¤ë§ˆ ê²€ì¦ (ì •ìƒ ì¼€ì´ìŠ¤) ---');
const validOutput = {
  language: 'ko-KR',
  narrative: 'ë¬¸ì´ ì‚ê±±ê±°ë¦¬ë©° ì—´ë¦½ë‹ˆë‹¤...',
  economy: {
    cost: { signal: 5, memory_shard: 0 },
    balance_after: { signal: 95, memory_shard: 5 },
  },
  safety: { blocked: false, message: null },
};
const resultA = safeParseTurnOutput(validOutput);
console.log('Success:', resultA.success);
if (resultA.success) {
  console.log('Data (sample):', resultA.data.narrative);
}

console.log('\n--- Scenario B: TurnOutput ìŠ¤í‚¤ë§ˆ ê²€ì¦ ì‹¤íŒ¨ â†’ í´ë°± ---');
const invalidOutput = {
  language: 'ko-KR',
  narrative: 'í…ŒìŠ¤íŠ¸',
};
// eslint-disable-next-line @typescript-eslint/no-explicit-any
const resultB = safeParseTurnOutput(invalidOutput as any);
console.log('Success:', resultB.success);
if (!resultB.success) {
  console.log('Error count:', resultB.error.issues.length);
  console.log('Fallback exists:', !!resultB.fallback);
  console.log(
    'Fallback badges has schema_fail:',
    resultB.fallback?.agent_console?.badges?.includes('schema_fail'),
  );
}

console.log('\n--- Scenario C: ì¢Œí‘œ ë²”ìœ„ ê²€ì¦ (RULE-009) ---');
const validBox = { ymin: 100, xmin: 200, ymax: 300, xmax: 400 };
console.log('Valid box:', Box2DSchema.safeParse(validBox).success);
const invalidBox = { ymin: 100, xmin: 200, ymax: 1500, xmax: 400 };
console.log('Invalid box (1500):', Box2DSchema.safeParse(invalidBox).success);
const negativeBox = { ymin: -10, xmin: 200, ymax: 300, xmax: 400 };
console.log('Negative box:', Box2DSchema.safeParse(negativeBox).success);

console.log('\n--- Scenario D: ì¬í™” ì¸ë°”ë¦¬ì–¸íŠ¸ ê²€ì¦ (RULE-005) ---');
const validCurrency = { signal: 100, memory_shard: 5 };
console.log('Valid currency:', CurrencyAmountSchema.safeParse(validCurrency).success);
const negativeCurrency = { signal: -10, memory_shard: 5 };
console.log('Negative signal:', CurrencyAmountSchema.safeParse(negativeCurrency).success);

console.log('\n--- Scenario E: ì–¸ì–´ ì •ì±… ê²€ì¦ (RULE-006) ---');
console.log('ko-KR:', LanguageSchema.safeParse('ko-KR').success);
console.log('en-US:', LanguageSchema.safeParse('en-US').success);
console.log('ja-JP (invalid):', LanguageSchema.safeParse('ja-JP').success);
console.log('ko (invalid format):', LanguageSchema.safeParse('ko').success);

console.log('\n--- Scenario F: TurnInput ê²€ì¦ ---');
const validInput = {
  language: 'ko-KR',
  text: 'ë¬¸ì„ ì—´ì–´ë³¸ë‹¤',
  client: {
    viewport_w: 1920,
    viewport_h: 1080,
    theme: 'dark',
  },
  economy_snapshot: {
    signal: 100,
    memory_shard: 5,
  },
};
try {
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  const parsed = parseTurnInput(validInput as any);
  console.log('Parsed successfully:', parsed.text);
} catch (e) {
  console.log('Parse error:', e);
}

console.log('\n--- Scenario G: Strict ëª¨ë“œ ê²€ì¦ ---');
const outputWithExtra = {
  language: 'ko-KR',
  narrative: 'í…ŒìŠ¤íŠ¸',
  economy: {
    cost: { signal: 0, memory_shard: 0 },
    balance_after: { signal: 100, memory_shard: 5 },
  },
  safety: { blocked: false, message: null },
  unknown_field: 'ì´ í•„ë“œëŠ” ìŠ¤í‚¤ë§ˆì— ì—†ìŒ',
};
const resultG = TurnOutputSchema.safeParse(outputWithExtra);
console.log('With extra field success:', resultG.success);
if (!resultG.success) {
  console.log('Error code:', resultG.error.issues[0].code);
}
</file>

<file path="frontend/src/stores/uiPrefsStore.test.ts">
import { describe, it, expect, beforeEach } from 'vitest';
import { useUIPrefsStore, DEFAULT_UI_SCALE, migrateUIPrefs } from './uiPrefsStore';

// Mock localStorage for non-browser environment
// Note: With jsdom environment configured in vite.config.ts, this might not be strictly necessary
// if we trust jsdom's localStorage, but keeping it explicit is fine.
// However, since we are moving to direct function testing for migration, we rely less on persist middleware internals.

describe('uiPrefsStore', () => {
  beforeEach(() => {
    useUIPrefsStore.getState().resetPrefs();
    localStorage.clear();
  });

  it('should have default initial state', () => {
    const state = useUIPrefsStore.getState();
    expect(state.uiScale).toBe(DEFAULT_UI_SCALE);
  });

  it('should increase ui scale within limit', () => {
    const { increaseUIScale } = useUIPrefsStore.getState();

    // 1.0 -> 1.1
    increaseUIScale();
    expect(useUIPrefsStore.getState().uiScale).toBe(1.1);

    // 1.1 -> 1.2
    increaseUIScale();
    expect(useUIPrefsStore.getState().uiScale).toBe(1.2);

    // 1.2 -> 1.2 (Max)
    increaseUIScale();
    expect(useUIPrefsStore.getState().uiScale).toBe(1.2);
  });

  it('should decrease ui scale within limit', () => {
    const { decreaseUIScale, setUIScale } = useUIPrefsStore.getState();

    // Start at max
    setUIScale(1.2);

    // 1.2 -> 1.1
    decreaseUIScale();
    expect(useUIPrefsStore.getState().uiScale).toBe(1.1);

    // ... -> 0.9 (Min)
    setUIScale(0.9);
    decreaseUIScale();
    expect(useUIPrefsStore.getState().uiScale).toBe(0.9);
  });

  it('should set valid ui scale', () => {
    const { setUIScale } = useUIPrefsStore.getState();

    setUIScale(1.1);
    expect(useUIPrefsStore.getState().uiScale).toBe(1.1);
  });

  it('should ignore invalid ui scale', () => {
    const { setUIScale } = useUIPrefsStore.getState();

    // @ts-expect-error Testing invalid input
    setUIScale(2.0);
    expect(useUIPrefsStore.getState().uiScale).toBe(DEFAULT_UI_SCALE);
  });

  describe('migration (U-037)', () => {
    it('should remove readableMode from legacy storage', () => {
      // Legacy state simulation
      const legacyState = {
        uiScale: 1.1,
        readableMode: true,
      };

      // Call migrate function directly
      const migratedState = migrateUIPrefs(legacyState, 0);

      // Verify
      expect(migratedState).toHaveProperty('uiScale', 1.1);
      expect(migratedState).not.toHaveProperty('readableMode');
    });

    it('should handle undefined version (very old legacy)', () => {
      const legacyState = {
        uiScale: 0.9,
        readableMode: false,
      };

      // Call migrate function directly with undefined version
      const migratedState = migrateUIPrefs(legacyState, undefined);

      expect(migratedState).toHaveProperty('uiScale', 0.9);
      expect(migratedState).not.toHaveProperty('readableMode');
    });

    it('should pass through already migrated state', () => {
      const modernState = {
        uiScale: 1.0,
      };

      const migratedState = migrateUIPrefs(modernState, 1);
      expect(migratedState).toEqual(modernState);
    });
  });
});
</file>

<file path="frontend/src/types/turn_stream.ts">
/**
 * Unknown World - Turn Stream ì´ë²¤íŠ¸ ê³„ì•½(Contract).
 *
 * NDJSON ìŠ¤íŠ¸ë¦¬ë°ì—ì„œ ì‚¬ìš©ë˜ëŠ” ì´ë²¤íŠ¸ íƒ€ì…, ì¸í„°í˜ì´ìŠ¤ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
 * ì´ ëª¨ë“ˆì€ ë°±ì—”ë“œì™€ í”„ë¡ íŠ¸ì—”ë“œ ê°„ì˜ ìŠ¤íŠ¸ë¦¼ ì´ë²¤íŠ¸ ê³„ì•½ SSOTì…ë‹ˆë‹¤.
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - RU-002-Q4: ì´ë²¤íŠ¸ ê³„ì•½ì„ transport ê³„ì¸µìœ¼ë¡œ ë¶„ë¦¬
 *   - RU-002-S2: ì´ë²¤íŠ¸ë³„ Zod ê²€ì¦ + Unknown/í™•ì¥ ì´ë²¤íŠ¸ í´ë°±
 *   - RULE-003: êµ¬ì¡°í™” ì¶œë ¥(JSON Schema) ìš°ì„  + ì´ì¤‘ ê²€ì¦
 *   - RULE-008: ë‹¨ê³„/ë°°ì§€ ê°€ì‹œí™”
 *
 * ì°¸ì¡°:
 *   - vibe/unit-plans/U-007[Mvp].md
 *   - vibe/refactors/RU-002-Q4.md
 *   - vibe/refactors/RU-002-S2.md
 *
 * @module types/turn_stream
 */

import { z } from 'zod';
import {
  AgentPhaseSchema,
  ValidationBadgeSchema,
  type TurnOutput,
  type AgentPhase,
  type ValidationBadge,
} from '../schemas/turn';

// =============================================================================
// ìŠ¤íŠ¸ë¦¼ ì´ë²¤íŠ¸ íƒ€ì… ìƒìˆ˜ (ì„œë²„ ê³„ì•½ê³¼ ì¼ì¹˜)
// =============================================================================

/** ìŠ¤íŠ¸ë¦¼ ì´ë²¤íŠ¸ íƒ€ì… ìƒìˆ˜ */
export const StreamEventType = {
  STAGE: 'stage',
  BADGES: 'badges',
  NARRATIVE_DELTA: 'narrative_delta',
  FINAL: 'final',
  ERROR: 'error',
  REPAIR: 'repair',
} as const;

export type StreamEventTypeName = (typeof StreamEventType)[keyof typeof StreamEventType];

/**
 * ë‹¨ê³„ ìƒíƒœ ìƒìˆ˜.
 * RU-002-S2/RU-002-Q2: v1(complete) ë° v2(ok/fail) ë³„ì¹­ ëª¨ë‘ ì§€ì›.
 */
export const StageStatus = {
  START: 'start',
  COMPLETE: 'complete',
  /** ë‹¨ê³„ ì‹¤íŒ¨ */
  FAIL: 'fail',
} as const;

export type StageStatusName = (typeof StageStatus)[keyof typeof StageStatus];

// =============================================================================
// RU-002-S2: ì´ë²¤íŠ¸ë³„ Zod ìŠ¤í‚¤ë§ˆ (ê²½ëŸ‰ ê²€ì¦ + í´ë°±)
// =============================================================================

/**
 * stage.status ìŠ¤í‚¤ë§ˆ.
 * v1(complete) ë° v2(ok/fail) ë³„ì¹­ ëª¨ë‘ í—ˆìš©.
 */
export const StageStatusSchema = z.enum(['start', 'complete', 'ok', 'fail']);

/**
 * StageEvent Zod ìŠ¤í‚¤ë§ˆ.
 * ë‹¨ê³„ ì§„í–‰ ì´ë²¤íŠ¸ ê²€ì¦ìš©.
 */
export const StageEventSchema = z.object({
  type: z.literal(StreamEventType.STAGE),
  name: AgentPhaseSchema,
  status: StageStatusSchema,
});

/**
 * RepairEvent Zod ìŠ¤í‚¤ë§ˆ.
 * ìë™ ë³µêµ¬ ì‹œë„ ì´ë²¤íŠ¸ ê²€ì¦ìš©.
 */
export const RepairEventSchema = z.object({
  type: z.literal(StreamEventType.REPAIR),
  attempt: z.number(),
  message: z.string().optional(),
});

/**
 * BadgesEvent Zod ìŠ¤í‚¤ë§ˆ (v1: ë°°ì—´).
 * v1ì€ badges: string[] í˜•ì‹.
 */
export const BadgesEventSchemaV1 = z.object({
  type: z.literal(StreamEventType.BADGES),
  badges: z.array(ValidationBadgeSchema),
});

/**
 * BadgesEvent Zod ìŠ¤í‚¤ë§ˆ (v2: ê°ì²´/ë§µ).
 * í–¥í›„ v2ëŠ” badges: { [key]: status } í˜•ì‹ì„ ì§€ì›í•  ìˆ˜ ìˆìŒ.
 * í˜„ì¬ëŠ” v1ë§Œ ì‚¬ìš©í•˜ë¯€ë¡œ ì´ ìŠ¤í‚¤ë§ˆëŠ” í™•ì¥ì„±ì„ ìœ„í•´ ì •ì˜.
 */
export const BadgesEventSchemaV2 = z.object({
  type: z.literal(StreamEventType.BADGES),
  badges: z.record(z.string(), z.boolean()),
});

/**
 * BadgesEvent í†µí•© ìŠ¤í‚¤ë§ˆ.
 * v1(ë°°ì—´) ë˜ëŠ” v2(ê°ì²´) ëª¨ë‘ í—ˆìš©.
 */
export const BadgesEventSchema = z.union([BadgesEventSchemaV1, BadgesEventSchemaV2]);

/**
 * NarrativeDeltaEvent Zod ìŠ¤í‚¤ë§ˆ.
 * íƒ€ì íš¨ê³¼ìš© ë‚´ëŸ¬í‹°ë¸Œ ë¸íƒ€ ì´ë²¤íŠ¸ ê²€ì¦ìš©.
 */
export const NarrativeDeltaEventSchema = z.object({
  type: z.literal(StreamEventType.NARRATIVE_DELTA),
  text: z.string(),
});

/**
 * FinalEvent ì›ì‹œ ìŠ¤í‚¤ë§ˆ.
 * v1(data) ë° v2(turn_output) ë³„ì¹­ ëª¨ë‘ í—ˆìš©.
 * TurnOutput ìì²´ ê²€ì¦ì€ turnStream.tsì—ì„œ safeParseTurnOutputìœ¼ë¡œ ìˆ˜í–‰.
 */
export const FinalEventRawSchema = z.object({
  type: z.literal(StreamEventType.FINAL),
  data: z.unknown(),
});

/**
 * ErrorEvent Zod ìŠ¤í‚¤ë§ˆ.
 * ì—ëŸ¬ ì´ë²¤íŠ¸ ê²€ì¦ìš©.
 */
export const ErrorEventSchema = z.object({
  type: z.literal(StreamEventType.ERROR),
  message: z.string(),
  code: z.string().optional(),
});

/**
 * ì´ë²¤íŠ¸ íƒ€ì… ì¶”ì¶œìš© ìµœì†Œ ìŠ¤í‚¤ë§ˆ.
 * Unknown ì´ë²¤íŠ¸ íŒë³„ì— ì‚¬ìš©.
 */
export const BaseEventSchema = z.object({
  type: z.string(),
});

// =============================================================================
// ì´ë²¤íŠ¸ íŒŒì‹± ìœ í‹¸ë¦¬í‹° (RU-002-S2)
// =============================================================================

/** ì´ë²¤íŠ¸ ê²€ì¦ ê²°ê³¼ íƒ€ì… */
export type EventParseResult<T> =
  | { success: true; data: T }
  | { success: false; error: z.ZodError };

/**
 * StageEventë¥¼ ì•ˆì „í•˜ê²Œ íŒŒì‹±í•©ë‹ˆë‹¤.
 */
export function safeParseStageEvent(
  data: unknown,
): EventParseResult<z.infer<typeof StageEventSchema>> {
  const result = StageEventSchema.safeParse(data);
  return result.success
    ? { success: true, data: result.data }
    : { success: false, error: result.error };
}

/**
 * RepairEventë¥¼ ì•ˆì „í•˜ê²Œ íŒŒì‹±í•©ë‹ˆë‹¤.
 */
export function safeParseRepairEvent(
  data: unknown,
): EventParseResult<z.infer<typeof RepairEventSchema>> {
  const result = RepairEventSchema.safeParse(data);
  return result.success
    ? { success: true, data: result.data }
    : { success: false, error: result.error };
}

/**
 * BadgesEventë¥¼ ì•ˆì „í•˜ê²Œ íŒŒì‹±í•©ë‹ˆë‹¤.
 * v1(ë°°ì—´) í˜•íƒœë¡œ ì •ê·œí™”í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.
 */
export function safeParseBadgesEvent(data: unknown): EventParseResult<BadgesEvent> {
  const result = BadgesEventSchema.safeParse(data);
  if (!result.success) {
    return { success: false, error: result.error };
  }

  // v2(ê°ì²´) í˜•íƒœì¸ ê²½ìš° v1(ë°°ì—´)ë¡œ ì •ê·œí™”
  const parsed = result.data;
  if (Array.isArray(parsed.badges)) {
    // v1 í˜•íƒœ: ê·¸ëŒ€ë¡œ ë°˜í™˜
    return {
      success: true,
      data: { type: StreamEventType.BADGES, badges: parsed.badges as ValidationBadge[] },
    };
  } else {
    // v2 í˜•íƒœ: trueì¸ í‚¤ë§Œ ì¶”ì¶œí•˜ì—¬ ë°°ì—´ë¡œ ë³€í™˜
    const badgeArray = Object.entries(parsed.badges)
      .filter(([, value]) => value)
      .map(([key]) => key as ValidationBadge);
    return {
      success: true,
      data: { type: StreamEventType.BADGES, badges: badgeArray },
    };
  }
}

/**
 * NarrativeDeltaEventë¥¼ ì•ˆì „í•˜ê²Œ íŒŒì‹±í•©ë‹ˆë‹¤.
 */
export function safeParseNarrativeDeltaEvent(
  data: unknown,
): EventParseResult<z.infer<typeof NarrativeDeltaEventSchema>> {
  const result = NarrativeDeltaEventSchema.safeParse(data);
  return result.success
    ? { success: true, data: result.data }
    : { success: false, error: result.error };
}

/**
 * FinalEvent ì›ì‹œ í˜•íƒœë¥¼ ì•ˆì „í•˜ê²Œ íŒŒì‹±í•©ë‹ˆë‹¤.
 * TurnOutput ìì²´ ê²€ì¦ì€ ë³„ë„ë¡œ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤.
 */
export function safeParseFinalEventRaw(
  data: unknown,
): EventParseResult<z.infer<typeof FinalEventRawSchema>> {
  const result = FinalEventRawSchema.safeParse(data);
  return result.success
    ? { success: true, data: result.data }
    : { success: false, error: result.error };
}

/**
 * ErrorEventë¥¼ ì•ˆì „í•˜ê²Œ íŒŒì‹±í•©ë‹ˆë‹¤.
 */
export function safeParseErrorEvent(
  data: unknown,
): EventParseResult<z.infer<typeof ErrorEventSchema>> {
  const result = ErrorEventSchema.safeParse(data);
  return result.success
    ? { success: true, data: result.data }
    : { success: false, error: result.error };
}

/**
 * stage.status ì •ê·œí™” í—¬í¼.
 * 'ok'ë¥¼ 'complete'ë¡œ, 'fail'ì€ ê·¸ëŒ€ë¡œ ìœ ì§€.
 */
export function normalizeStageStatus(status: string): 'start' | 'complete' | 'fail' {
  if (status === 'ok') return 'complete';
  if (status === 'fail') return 'fail';
  if (status === 'start') return 'start';
  return 'complete';
}

// =============================================================================
// ìŠ¤íŠ¸ë¦¼ ì´ë²¤íŠ¸ ì¸í„°í˜ì´ìŠ¤
// =============================================================================

/**
 * ë‹¨ê³„ ì§„í–‰ ì´ë²¤íŠ¸.
 * RU-002-S2: statusì— 'fail' ì¶”ê°€í•˜ì—¬ ë‹¨ê³„ ì‹¤íŒ¨ í‘œí˜„ ì§€ì›.
 */
export interface StageEvent {
  type: typeof StreamEventType.STAGE;
  name: AgentPhase;
  /** 'start' | 'complete' | 'ok' | 'fail'. okëŠ” completeë¡œ ì •ê·œí™”ë¨. */
  status: StageStatusName;
}

/** ìë™ ë³µêµ¬(Repair) ì´ë²¤íŠ¸ */
export interface RepairEvent {
  type: typeof StreamEventType.REPAIR;
  attempt: number;
  message?: string;
}

/** ë°°ì§€ ì´ë²¤íŠ¸ */
export interface BadgesEvent {
  type: typeof StreamEventType.BADGES;
  badges: ValidationBadge[];
}

/** ë‚´ëŸ¬í‹°ë¸Œ ë¸íƒ€ ì´ë²¤íŠ¸ (íƒ€ì íš¨ê³¼ìš©) */
export interface NarrativeDeltaEvent {
  type: typeof StreamEventType.NARRATIVE_DELTA;
  text: string;
}

/** ìµœì¢… TurnOutput ì´ë²¤íŠ¸
 *
 * RU-002-Q2: v1ì€ `data`, v2ëŠ” `turn_output` ì‚¬ìš©.
 * í•˜ìœ„í˜¸í™˜ì„ ìœ„í•´ ë‘ í•„ë“œ ëª¨ë‘ ì„ ì–¸í•˜ë˜, ì •ê·œí™”ëœ ì¸í„°í˜ì´ìŠ¤ëŠ” `data`ë¥¼ ì‚¬ìš©.
 */
export interface FinalEvent {
  type: typeof StreamEventType.FINAL;
  /** v1 í˜„í–‰ ê³„ì•½: TurnOutput í˜ì´ë¡œë“œ */
  data: TurnOutput;
}

/** FinalEvent ì›ì‹œ ìˆ˜ì‹  í˜•íƒœ */
export interface FinalEventRaw {
  type: typeof StreamEventType.FINAL;
  /** TurnOutput í˜ì´ë¡œë“œ */
  data: TurnOutput;
}

/** ì—ëŸ¬ ì´ë²¤íŠ¸ */
export interface ErrorEvent {
  type: typeof StreamEventType.ERROR;
  message: string;
  code?: string;
}

/** ìŠ¤íŠ¸ë¦¼ ì´ë²¤íŠ¸ ìœ ë‹ˆì˜¨ íƒ€ì… */
export type StreamEvent =
  | StageEvent
  | RepairEvent
  | BadgesEvent
  | NarrativeDeltaEvent
  | FinalEvent
  | ErrorEvent;

// =============================================================================
// ìŠ¤íŠ¸ë¦¼ ì½œë°± ì¸í„°í˜ì´ìŠ¤
// =============================================================================

/** ìŠ¤íŠ¸ë¦¼ ì´ë²¤íŠ¸ ì½œë°± */
export interface StreamCallbacks {
  /** ë‹¨ê³„ ì§„í–‰ ì´ë²¤íŠ¸ */
  onStage?: (event: StageEvent) => void;
  /** ìë™ ë³µêµ¬ ì´ë²¤íŠ¸ */
  onRepair?: (event: RepairEvent) => void;
  /** ë°°ì§€ ì´ë²¤íŠ¸ */
  onBadges?: (event: BadgesEvent) => void;
  /** ë‚´ëŸ¬í‹°ë¸Œ ë¸íƒ€ ì´ë²¤íŠ¸ */
  onNarrativeDelta?: (event: NarrativeDeltaEvent) => void;
  /** ìµœì¢… TurnOutput ì´ë²¤íŠ¸ */
  onFinal?: (event: FinalEvent) => void;
  /** ì—ëŸ¬ ì´ë²¤íŠ¸ */
  onError?: (event: ErrorEvent) => void;
  /** ìŠ¤íŠ¸ë¦¼ ì™„ë£Œ */
  onComplete?: () => void;
}
</file>

<file path="frontend/src/utils/box2d.test.ts">
import { describe, it, expect } from 'vitest';
import {
  box2dToPixel,
  pixelToBox2d,
  isValidBox2D,
  box2dArea,
  box2dCenter,
  NORMALIZED_MAX,
} from './box2d';
import type { Box2D } from '../schemas/turn';

describe('box2d utils', () => {
  const canvas = { width: 800, height: 600 };

  describe('box2dToPixel', () => {
    it('should correctly convert normalized coordinates to pixels', () => {
      const normalized: Box2D = { ymin: 100, xmin: 200, ymax: 500, xmax: 800 };
      const pixel = box2dToPixel(normalized, canvas);

      // top = 100 * (600 / 1000) = 60
      // left = 200 * (800 / 1000) = 160
      // bottom = 500 * (600 / 1000) = 300
      // right = 800 * (800 / 1000) = 640
      // width = 640 - 160 = 480
      // height = 300 - 60 = 240

      expect(pixel).toEqual({
        top: 60,
        left: 160,
        width: 480,
        height: 240,
      });
    });

    it('should handle full canvas size', () => {
      const normalized: Box2D = { ymin: 0, xmin: 0, ymax: 1000, xmax: 1000 };
      const pixel = box2dToPixel(normalized, canvas);

      expect(pixel).toEqual({
        top: 0,
        left: 0,
        width: 800,
        height: 600,
      });
    });
  });

  describe('pixelToBox2d', () => {
    it('should correctly convert pixels back to normalized coordinates', () => {
      const pixel = { top: 60, left: 160, width: 480, height: 240 };
      const normalized = pixelToBox2d(pixel, canvas);

      expect(normalized).toEqual({
        ymin: 100,
        xmin: 200,
        ymax: 500,
        xmax: 800,
      });
    });

    it('should round and clamp values', () => {
      const pixel = { top: -10, left: -20, width: 900, height: 700 };
      const normalized = pixelToBox2d(pixel, canvas);

      expect(normalized.ymin).toBe(0);
      expect(normalized.xmin).toBe(0);
      expect(normalized.ymax).toBe(NORMALIZED_MAX);
      expect(normalized.xmax).toBe(NORMALIZED_MAX);
    });
  });

  describe('isValidBox2D', () => {
    it('should return true for valid boxes', () => {
      expect(isValidBox2D({ ymin: 100, xmin: 100, ymax: 200, xmax: 200 })).toBe(true);
      expect(isValidBox2D({ ymin: 0, xmin: 0, ymax: 1000, xmax: 1000 })).toBe(true);
    });

    it('should return false for out of range values', () => {
      expect(isValidBox2D({ ymin: -1, xmin: 0, ymax: 100, xmax: 100 })).toBe(false);
      expect(isValidBox2D({ ymin: 0, xmin: 0, ymax: 1001, xmax: 100 })).toBe(false);
    });

    it('should return false for invalid order', () => {
      expect(isValidBox2D({ ymin: 500, xmin: 100, ymax: 400, xmax: 200 })).toBe(false);
      expect(isValidBox2D({ ymin: 100, xmin: 500, ymax: 200, xmax: 400 })).toBe(false);
    });
  });

  describe('box2dArea', () => {
    it('should calculate area correctly', () => {
      const box = { ymin: 100, xmin: 100, ymax: 200, xmax: 300 };
      expect(box2dArea(box)).toBe(20000); // (200-100) * (300-100) = 100 * 200
    });
  });

  describe('box2dCenter', () => {
    it('should calculate center correctly', () => {
      const box = { ymin: 100, xmin: 100, ymax: 300, xmax: 500 };
      expect(box2dCenter(box)).toEqual({ x: 300, y: 200 });
    });
  });
});
</file>

<file path="frontend/src/utils/box2d.ts">
/**
 * Unknown World - Box2D ì¢Œí‘œ ë³€í™˜ ìœ í‹¸ë¦¬í‹°
 *
 * RULE-009 ì¤€ìˆ˜: ì¢Œí‘œ ê·œì•½ (0~1000 ì •ê·œí™”, bbox=[ymin,xmin,ymax,xmax])
 * - ì„œë²„/ì„¸ì´ë¸Œì—ëŠ” í•­ìƒ box_2d(0~1000)ë¥¼ ìœ ì§€
 * - ë Œë”ì—ì„œë§Œ viewport í¬ê¸°(canvasW/H)ì— ë§ì¶° pxë¡œ ë³€í™˜
 *
 * @module utils/box2d
 */

import type { Box2D } from '../schemas/turn';

// =============================================================================
// ìƒìˆ˜ ì •ì˜
// =============================================================================

/**
 * ì •ê·œí™” ì¢Œí‘œê³„ ìµœëŒ“ê°’ (0~1000).
 * RULE-009: ì¢Œí‘œ ê·œì•½
 */
export const NORMALIZED_MAX = 1000;

// =============================================================================
// íƒ€ì… ì •ì˜
// =============================================================================

/**
 * í”½ì…€ ë‹¨ìœ„ ë°”ìš´ë”© ë°•ìŠ¤.
 * ë Œë”ë§ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
 */
export interface Box2DPixel {
  /** Y ìµœì†Œê°’ (ìƒë‹¨, í”½ì…€) */
  top: number;
  /** X ìµœì†Œê°’ (ì¢Œì¸¡, í”½ì…€) */
  left: number;
  /** ë„ˆë¹„ (í”½ì…€) */
  width: number;
  /** ë†’ì´ (í”½ì…€) */
  height: number;
}

/**
 * ìº”ë²„ìŠ¤ í¬ê¸° ì •ë³´.
 */
export interface CanvasSize {
  /** ìº”ë²„ìŠ¤ ë„ˆë¹„ (í”½ì…€) */
  width: number;
  /** ìº”ë²„ìŠ¤ ë†’ì´ (í”½ì…€) */
  height: number;
}

// =============================================================================
// ë³€í™˜ í•¨ìˆ˜
// =============================================================================

/**
 * ì •ê·œí™” ì¢Œí‘œ(0~1000)ë¥¼ í”½ì…€ ì¢Œí‘œë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
 *
 * RULE-009: bbox ìˆœì„œëŠ” [ymin, xmin, ymax, xmax]
 *
 * @param box - ì •ê·œí™” ì¢Œí‘œ ë°”ìš´ë”© ë°•ìŠ¤
 * @param canvas - ìº”ë²„ìŠ¤ í¬ê¸°
 * @returns í”½ì…€ ë‹¨ìœ„ ë°”ìš´ë”© ë°•ìŠ¤
 *
 * @example
 * ```ts
 * const normalized: Box2D = { ymin: 100, xmin: 200, ymax: 500, xmax: 800 };
 * const canvas = { width: 800, height: 600 };
 * const pixel = box2dToPixel(normalized, canvas);
 * // pixel = { top: 60, left: 160, width: 480, height: 240 }
 * ```
 */
export function box2dToPixel(box: Box2D, canvas: CanvasSize): Box2DPixel {
  const scaleX = canvas.width / NORMALIZED_MAX;
  const scaleY = canvas.height / NORMALIZED_MAX;

  const top = box.ymin * scaleY;
  const left = box.xmin * scaleX;
  const bottom = box.ymax * scaleY;
  const right = box.xmax * scaleX;

  return {
    top,
    left,
    width: right - left,
    height: bottom - top,
  };
}

/**
 * í”½ì…€ ì¢Œí‘œë¥¼ ì •ê·œí™” ì¢Œí‘œ(0~1000)ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
 *
 * ì—­ë³€í™˜ì´ í•„ìš”í•œ ê²½ìš° ì‚¬ìš©í•©ë‹ˆë‹¤ (ì˜ˆ: í´ë¦­ ìœ„ì¹˜ â†’ ì •ê·œí™” ì¢Œí‘œ).
 *
 * @param pixel - í”½ì…€ ë‹¨ìœ„ ë°”ìš´ë”© ë°•ìŠ¤
 * @param canvas - ìº”ë²„ìŠ¤ í¬ê¸°
 * @returns ì •ê·œí™” ì¢Œí‘œ ë°”ìš´ë”© ë°•ìŠ¤
 */
export function pixelToBox2d(pixel: Box2DPixel, canvas: CanvasSize): Box2D {
  const scaleX = NORMALIZED_MAX / canvas.width;
  const scaleY = NORMALIZED_MAX / canvas.height;

  const ymin = Math.round(pixel.top * scaleY);
  const xmin = Math.round(pixel.left * scaleX);
  const ymax = Math.round((pixel.top + pixel.height) * scaleY);
  const xmax = Math.round((pixel.left + pixel.width) * scaleX);

  // RULE-009: 0~1000 ë²”ìœ„ ë³´ì¥
  return {
    ymin: Math.max(0, Math.min(NORMALIZED_MAX, ymin)),
    xmin: Math.max(0, Math.min(NORMALIZED_MAX, xmin)),
    ymax: Math.max(0, Math.min(NORMALIZED_MAX, ymax)),
    xmax: Math.max(0, Math.min(NORMALIZED_MAX, xmax)),
  };
}

/**
 * Box2Dê°€ ìœ íš¨í•œì§€ ê²€ì¦í•©ë‹ˆë‹¤.
 *
 * @param box - ê²€ì¦í•  ë°”ìš´ë”© ë°•ìŠ¤
 * @returns ìœ íš¨ ì—¬ë¶€
 */
export function isValidBox2D(box: Box2D): boolean {
  // 0~1000 ë²”ìœ„ ì²´í¬
  if (
    box.ymin < 0 ||
    box.ymin > NORMALIZED_MAX ||
    box.xmin < 0 ||
    box.xmin > NORMALIZED_MAX ||
    box.ymax < 0 ||
    box.ymax > NORMALIZED_MAX ||
    box.xmax < 0 ||
    box.xmax > NORMALIZED_MAX
  ) {
    return false;
  }

  // ymin < ymax, xmin < xmax ì²´í¬
  if (box.ymin >= box.ymax || box.xmin >= box.xmax) {
    return false;
  }

  return true;
}

/**
 * Box2Dì˜ ë©´ì ì„ ê³„ì‚°í•©ë‹ˆë‹¤ (ì •ê·œí™” ì¢Œí‘œ ê¸°ì¤€).
 *
 * @param box - ë°”ìš´ë”© ë°•ìŠ¤
 * @returns ë©´ì  (0~1000000)
 */
export function box2dArea(box: Box2D): number {
  return (box.ymax - box.ymin) * (box.xmax - box.xmin);
}

/**
 * Box2Dì˜ ì¤‘ì‹¬ì ì„ ê³„ì‚°í•©ë‹ˆë‹¤ (ì •ê·œí™” ì¢Œí‘œ ê¸°ì¤€).
 *
 * @param box - ë°”ìš´ë”© ë°•ìŠ¤
 * @returns ì¤‘ì‹¬ì  ì¢Œí‘œ {x, y}
 */
export function box2dCenter(box: Box2D): { x: number; y: number } {
  return {
    x: (box.xmin + box.xmax) / 2,
    y: (box.ymin + box.ymax) / 2,
  };
}
</file>

<file path="frontend/src/vite-env.d.ts">
/// <reference types="vite/client" />
</file>

<file path="frontend/tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2022",
    "useDefineForClassFields": true,
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "Bundler",
    "allowImportingTsExtensions": true,
    "isolatedModules": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting (ì—„ê²© ëª¨ë“œ) */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
</file>

<file path="frontend/tsconfig.node.json">
{
  "compilerOptions": {
    "target": "ES2022",
    "lib": ["ES2022"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "Bundler",
    "allowImportingTsExtensions": true,
    "isolatedModules": true,
    "moduleDetection": "force",

    /* Composite for project references */
    "composite": true,
    "emitDeclarationOnly": true,
    "declaration": true,
    "declarationMap": true,

    /* Linting (ì—„ê²© ëª¨ë“œ) */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}
</file>

<file path="request.json">
{"language": "ko-KR", "text": "ëª¨í—˜ì„ ì‹œì‘í•œë‹¤", "client": {"viewport_w": 1920, "viewport_h": 1080, "theme": "dark"}, "economy_snapshot": {"signal": 5, "memory_shard": 0}}
</file>

<file path="shared/README.md">
# shared/

ì´ ë””ë ‰í† ë¦¬ëŠ” **í”„ë¡ íŠ¸ì—”ë“œì™€ ë°±ì—”ë“œ ê°„ ê³µìœ ë˜ëŠ” ìŠ¤í‚¤ë§ˆ/íƒ€ì… ì •ì˜**ë¥¼ ìœ„í•œ SSOT(Single Source of Truth) ë””ë ‰í† ë¦¬ì…ë‹ˆë‹¤.

## ğŸ“ êµ¬ì¡°

```
shared/
â”œâ”€â”€ schemas/
â”‚   â””â”€â”€ turn/                         # Turn ê³„ì•½ ìŠ¤í‚¤ë§ˆ (TurnInput/TurnOutput)
â”‚       â”œâ”€â”€ turn_input.schema.json    # Client â†’ Server ìš”ì²­ ìŠ¤í‚¤ë§ˆ
â”‚       â””â”€â”€ turn_output.schema.json   # Server â†’ Client ì‘ë‹µ ìŠ¤í‚¤ë§ˆ
â””â”€â”€ README.md
```

## ğŸ”„ SSOT ì›ì¹™ (RU-001-Q4)

- **SSOTëŠ” `shared/schemas/`ì˜ JSON Schema íŒŒì¼**ì…ë‹ˆë‹¤.
- ë°±ì—”ë“œ(Python/Pydantic)ì™€ í”„ë¡ íŠ¸ì—”ë“œ(TS/Zod)ì˜ íƒ€ì…/ê²€ì¦ ì½”ë“œëŠ” **ì´ ìŠ¤í‚¤ë§ˆë¡œë¶€í„° ìƒì„± ë˜ëŠ” ë™ê¸°í™”**ë©ë‹ˆë‹¤.
- ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì‹œ ì–‘ìª½(backend/frontend)ì— ì˜í–¥ì´ ìˆìŒì„ ë°˜ë“œì‹œ ì¸ì§€í•´ì•¼ í•©ë‹ˆë‹¤.

### ì†Œë¹„ ì „ëµ (Option B: ìƒì„±ë¬¼ ê¸°ë°˜ ë™ê¸°í™”)

| ì†Œë¹„ì | ë„êµ¬/ë°©ì‹ | ìƒì„±ë¬¼ ê²½ë¡œ (ê¶Œì¥) |
|--------|-----------|-------------------|
| **Backend (Python)** | `datamodel-code-generator` ë˜ëŠ” ìˆ˜ë™ ë™ê¸°í™” | `backend/src/unknown_world/schemas/generated/` |
| **Frontend (TS)** | `json-schema-to-zod` ë˜ëŠ” ìˆ˜ë™ ë™ê¸°í™” | `frontend/src/schemas/generated/` |

> **MVP ë‹¨ê³„ì—ì„œëŠ” ìˆ˜ë™ ë™ê¸°í™”**ë¡œ ì‹œì‘í•˜ê³ , driftê°€ ë°œìƒí•˜ë©´ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë„ì…í•©ë‹ˆë‹¤.

## ğŸ“‹ ìŠ¤í‚¤ë§ˆ íŒŒì¼ ëª©ë¡

### Turn ê³„ì•½ (MVP)

| íŒŒì¼ | ìš©ë„ | PRD ì°¸ì¡° |
|------|------|----------|
| `turn/turn_input.schema.json` | Client â†’ Server í„´ ìš”ì²­ | PRD 8.7ì ˆ TurnInput |
| `turn/turn_output.schema.json` | Server â†’ Client í„´ ì‘ë‹µ | PRD 8.7ì ˆ TurnOutput |

## âœ… ìŠ¤í‚¤ë§ˆ ì‘ì„± ê°€ì´ë“œë¼ì¸

- **ì§€ì› íƒ€ì…**: `string`, `number`, `integer`, `boolean`, `object`, `array`, `null`
- **ê¶Œì¥ ì†ì„±**: `required`, `enum`, `description`ì„ ì ê·¹ ì‚¬ìš©
- **ì—„ê²© ëª¨ë“œ**: `additionalProperties: false`ë¡œ ì˜ˆì¸¡ ê°€ëŠ¥ì„± í™•ë³´
- **í‰í‰í•œ êµ¬ì¡°**: ê³¼ë„í•œ ì¤‘ì²©ì„ í”¼í•˜ê³  ë‹¨ìˆœí•œ ìŠ¤í‚¤ë§ˆ ìœ ì§€
- **ì°¸ì¡°**: `vibe/ref/structured-outputs-guide.md`

## âš ï¸ ë³´ì•ˆ ì£¼ì˜ì‚¬í•­ (RULE-007)

- **ì ˆëŒ€ë¡œ ì„œë¹„ìŠ¤ ê³„ì • í‚¤, í¬ë¦¬ë´ì…œ, ë¹„ë°€ì •ë³´ë¥¼ ì´ ë””ë ‰í† ë¦¬ì— ë°°ì¹˜í•˜ì§€ ë§ˆì„¸ìš”.**
- í‚¤ íŒŒì¼ì€ ë°˜ë“œì‹œ `secrets/` ë””ë ‰í† ë¦¬ì—ë§Œ ë°°ì¹˜í•©ë‹ˆë‹¤ (`.gitignore`ë¡œ ì°¨ë‹¨ë¨).
- ìŠ¤í‚¤ë§ˆ íŒŒì¼ì€ "ê³„ì•½ ë¬¸ì„œ"ì´ë¯€ë¡œ ì»¤ë°‹í•´ë„ ë³´ì•ˆ ìœ„í—˜ì´ ì—†ìŠµë‹ˆë‹¤ (ë‹¨, ë¹„ë°€ê°’ í¬í•¨ ê¸ˆì§€).

## ğŸ“š ê´€ë ¨ ë¬¸ì„œ

- `vibe/refactors/RU-001-Q4.md` - JSON Schema SSOT ë„ì… ê·¼ê±°
- `vibe/refactors/RU-001-S1.md` - .gitignore JSON ì •ì±… ë³€ê²½ ê·¼ê±°
- `vibe/ref/structured-outputs-guide.md` - Gemini Structured Output ê°€ì´ë“œ
- `vibe/prd.md` (8.7ì ˆ) - TurnInput/TurnOutput ì„¤ê³„ ë°©í–¥
- `.cursor/rules/00-core-critical.mdc` - RULE-003 (ì´ì¤‘ ê²€ì¦), RULE-007 (ë³´ì•ˆ)
</file>

<file path="shared/schemas/turn/turn_input.schema.json">
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://unknown-world.dev/schemas/turn/turn_input.schema.json",
  "title": "TurnInput",
  "description": "Client â†’ Server í„´ ìš”ì²­ ìŠ¤í‚¤ë§ˆ (MVP). PRD 8.7ì ˆ ê¸°ë°˜.",
  "type": "object",
  "properties": {
    "language": {
      "type": "string",
      "enum": ["ko-KR", "en-US"],
      "description": "ê²Œì„ ì–¸ì–´ ì„¤ì • (ko-KR ë˜ëŠ” en-US)"
    },
    "text": {
      "type": "string",
      "description": "ì‚¬ìš©ì ì…ë ¥ (ìì—°ì–´)"
    },
    "click": {
      "type": ["object", "null"],
      "description": "í´ë¦­ëœ ì˜¤ë¸Œì íŠ¸ ì •ë³´ (ì„ íƒ)",
      "properties": {
        "object_id": {
          "type": "string",
          "description": "í´ë¦­ëœ ì˜¤ë¸Œì íŠ¸ ID"
        },
        "box_2d": {
          "type": ["array", "null"],
          "description": "bbox [ymin, xmin, ymax, xmax] (0~1000 ì •ê·œí™”)",
          "items": {
            "type": "integer",
            "minimum": 0,
            "maximum": 1000
          },
          "minItems": 4,
          "maxItems": 4
        }
      },
      "required": ["object_id"]
    },
    "client": {
      "type": "object",
      "description": "í´ë¼ì´ì–¸íŠ¸ í™˜ê²½ ì •ë³´",
      "properties": {
        "viewport_w": {
          "type": "integer",
          "description": "ë·°í¬íŠ¸ ë„ˆë¹„ (px)"
        },
        "viewport_h": {
          "type": "integer",
          "description": "ë·°í¬íŠ¸ ë†’ì´ (px)"
        },
        "theme": {
          "type": "string",
          "enum": ["dark", "light"],
          "description": "í…Œë§ˆ ì„¤ì •"
        }
      },
      "required": ["viewport_w", "viewport_h", "theme"]
    },
    "economy_snapshot": {
      "type": "object",
      "description": "í˜„ì¬ ì¬í™” ìƒíƒœ ìŠ¤ëƒ…ìƒ·",
      "properties": {
        "signal": {
          "type": "integer",
          "minimum": 0,
          "description": "Signal ì¬í™” ì”ì•¡"
        },
        "memory_shard": {
          "type": "integer",
          "minimum": 0,
          "description": "Memory Shard ì¬í™” ì”ì•¡"
        }
      },
      "required": ["signal", "memory_shard"]
    }
  },
  "required": ["language", "text", "client", "economy_snapshot"],
  "additionalProperties": false
}
</file>

<file path="shared/schemas/turn/turn_output.schema.json">
{
  "$defs": {
    "ActionCard": {
      "additionalProperties": false,
      "description": "ì•¡ì…˜ ì¹´ë“œ (Action Deck).\n\në§¤ í„´ AIê°€ ì¶”ì²œí•˜ëŠ” í–‰ë™ ì¹´ë“œì…ë‹ˆë‹¤.\nê° ì¹´ë“œì— ë¹„ìš©/ìœ„í—˜/ë³´ìƒ íŒíŠ¸ê°€ í¬í•¨ë©ë‹ˆë‹¤.\n\nAttributes:\n    id: ì¹´ë“œ ê³ ìœ  ID\n    label: ì¹´ë“œ ë¼ë²¨ (í‘œì‹œìš©)\n    description: ì¹´ë“œ ì„¤ëª… (ì„ íƒ)\n    cost: ì˜ˆìƒ ë¹„ìš©\n    risk: ìœ„í—˜ë„\n    hint: ì˜ˆìƒ ê²°ê³¼ íŒíŠ¸ (ì„ íƒ)",
      "properties": {
        "id": {
          "description": "ì¹´ë“œ ê³ ìœ  ID",
          "title": "Id",
          "type": "string"
        },
        "label": {
          "description": "ì¹´ë“œ ë¼ë²¨ (í‘œì‹œìš©)",
          "title": "Label",
          "type": "string"
        },
        "description": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "ì¹´ë“œ ì„¤ëª… (ì„ íƒ)",
          "title": "Description"
        },
        "cost": {
          "$ref": "#/$defs/CurrencyAmount",
          "description": "ì˜ˆìƒ ë¹„ìš©"
        },
        "risk": {
          "$ref": "#/$defs/RiskLevel",
          "default": "low",
          "description": "ìœ„í—˜ë„"
        },
        "hint": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "ì˜ˆìƒ ê²°ê³¼ íŒíŠ¸ (ì„ íƒ)",
          "title": "Hint"
        }
      },
      "required": [
        "id",
        "label",
        "cost"
      ],
      "title": "ActionCard",
      "type": "object"
    },
    "ActionDeck": {
      "additionalProperties": false,
      "description": "ì•¡ì…˜ ë± (Q1 ê²°ì •: ui.action_deck.cards[] êµ¬ì¡°).\n\në§¤ í„´ AIê°€ ì œì‹œí•˜ëŠ” ì¶”ì²œ í–‰ë™ ì¹´ë“œ ë±ì…ë‹ˆë‹¤.\n\nAttributes:\n    cards: ì•¡ì…˜ ì¹´ë“œ ëª©ë¡ (3~6ì¥ ê¶Œì¥)",
      "properties": {
        "cards": {
          "default": [],
          "description": "ì•¡ì…˜ ì¹´ë“œ ëª©ë¡ (3~6ì¥ ê¶Œì¥)",
          "items": {
            "$ref": "#/$defs/ActionCard"
          },
          "maxItems": 10,
          "minItems": 0,
          "title": "Cards",
          "type": "array"
        }
      },
      "title": "ActionDeck",
      "type": "object"
    },
    "AgentConsole": {
      "additionalProperties": false,
      "description": "ì—ì´ì „íŠ¸ ì½˜ì†” ë°ì´í„° (RULE-008).\n\nì—ì´ì „íŠ¸í˜• ì‹œìŠ¤í…œì„ì„ UIë¡œ ì¦ëª…í•˜ê¸° ìœ„í•œ ì •ë³´ì…ë‹ˆë‹¤.\nê³„íš/ì‹¤í–‰/ê²€ì¦/ë³µêµ¬ì˜ í”ì ì„ í‘œì‹œí•©ë‹ˆë‹¤.\n\nAttributes:\n    current_phase: í˜„ì¬ ì‹¤í–‰ ë‹¨ê³„\n    badges: ê²€ì¦ ë°°ì§€ ëª©ë¡\n    repair_count: ìë™ ë³µêµ¬ ì‹œë„ íšŸìˆ˜",
      "properties": {
        "current_phase": {
          "$ref": "#/$defs/AgentPhase",
          "default": "commit",
          "description": "í˜„ì¬ ì‹¤í–‰ ë‹¨ê³„"
        },
        "badges": {
          "default": [],
          "description": "ê²€ì¦ ë°°ì§€ ëª©ë¡",
          "items": {
            "$ref": "#/$defs/ValidationBadge"
          },
          "title": "Badges",
          "type": "array"
        },
        "repair_count": {
          "default": 0,
          "description": "ìë™ ë³µêµ¬ ì‹œë„ íšŸìˆ˜",
          "minimum": 0,
          "title": "Repair Count",
          "type": "integer"
        }
      },
      "title": "AgentConsole",
      "type": "object"
    },
    "AgentPhase": {
      "description": "ì—ì´ì „íŠ¸ ì‹¤í–‰ ë‹¨ê³„ (RULE-008).\n\nì—ì´ì „íŠ¸í˜• ì‹œìŠ¤í…œì„ì„ UIë¡œ ì¦ëª…í•˜ê¸° ìœ„í•œ ë‹¨ê³„ í‘œì‹œ.",
      "enum": [
        "parse",
        "validate",
        "plan",
        "resolve",
        "render",
        "verify",
        "commit"
      ],
      "title": "AgentPhase",
      "type": "string"
    },
    "Box2D": {
      "additionalProperties": false,
      "description": "2D ë°”ìš´ë”© ë°•ìŠ¤ (RULE-009).\n\nì¢Œí‘œëŠ” 0~1000 ì •ê·œí™” ì¢Œí‘œê³„ì´ë©°, bboxëŠ” [ymin, xmin, ymax, xmax] ìˆœì„œì…ë‹ˆë‹¤.\nì´ë¯¸ì§€ ì´í•´ bbox í¬ë§·ê³¼ í˜¸í™˜ë©ë‹ˆë‹¤.\n\nAttributes:\n    ymin: Y ìµœì†Œê°’ (ìƒë‹¨)\n    xmin: X ìµœì†Œê°’ (ì¢Œì¸¡)\n    ymax: Y ìµœëŒ€ê°’ (í•˜ë‹¨)\n    xmax: X ìµœëŒ€ê°’ (ìš°ì¸¡)",
      "properties": {
        "ymin": {
          "description": "ì •ê·œí™” ì¢Œí‘œ (0~1000)",
          "maximum": 1000,
          "minimum": 0,
          "title": "Ymin",
          "type": "integer"
        },
        "xmin": {
          "description": "ì •ê·œí™” ì¢Œí‘œ (0~1000)",
          "maximum": 1000,
          "minimum": 0,
          "title": "Xmin",
          "type": "integer"
        },
        "ymax": {
          "description": "ì •ê·œí™” ì¢Œí‘œ (0~1000)",
          "maximum": 1000,
          "minimum": 0,
          "title": "Ymax",
          "type": "integer"
        },
        "xmax": {
          "description": "ì •ê·œí™” ì¢Œí‘œ (0~1000)",
          "maximum": 1000,
          "minimum": 0,
          "title": "Xmax",
          "type": "integer"
        }
      },
      "required": [
        "ymin",
        "xmin",
        "ymax",
        "xmax"
      ],
      "title": "Box2D",
      "type": "object"
    },
    "CurrencyAmount": {
      "additionalProperties": false,
      "description": "ì¬í™” ìˆ˜ëŸ‰.\n\nAttributes:\n    signal: ê¸°ë³¸ ì¬í™” (í…ìŠ¤íŠ¸ í„´/ì´ë¯¸ì§€ ìƒì„±/ê³ ê¸‰ ê¸°ëŠ¥ì— ì†Œë¹„)\n    memory_shard: í¬ê·€ ì¬í™” (ì¤‘ìš” ì„¤ì • ê³ ì •, ê³ í•´ìƒë„ ì´ë¯¸ì§€ ë“±ì— ì†Œë¹„)",
      "properties": {
        "signal": {
          "description": "ì‹œê·¸ë„ (ê¸°ë³¸ ì¬í™”, 0 ì´ìƒ)",
          "minimum": 0,
          "title": "Signal",
          "type": "integer"
        },
        "memory_shard": {
          "description": "ê¸°ì–µ íŒŒí¸ (í¬ê·€ ì¬í™”, 0 ì´ìƒ)",
          "minimum": 0,
          "title": "Memory Shard",
          "type": "integer"
        }
      },
      "required": [
        "signal",
        "memory_shard"
      ],
      "title": "CurrencyAmount",
      "type": "object"
    },
    "EconomyOutput": {
      "additionalProperties": false,
      "description": "ê²½ì œ ì¶œë ¥ ë°ì´í„° (RULE-005).\n\nì´ë²ˆ í„´ì˜ ë¹„ìš©ê³¼ ì”ì•¡ ì •ë³´ì…ë‹ˆë‹¤.\nì”ì•¡ ìŒìˆ˜ëŠ” ì ˆëŒ€ ë¶ˆê°€ (ì„œë²„ Hard gate).\n\nAttributes:\n    cost: ì´ë²ˆ í„´ì— ì†Œë¹„ëœ ë¹„ìš©\n    balance_after: ì†Œë¹„ í›„ ì”ì•¡\n\nImportant:\n    - costì™€ balance_afterëŠ” í•­ìƒ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.\n    - balance_afterì˜ signalê³¼ memory_shardëŠ” 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.",
      "properties": {
        "cost": {
          "$ref": "#/$defs/CurrencyAmount",
          "description": "ì´ë²ˆ í„´ì— ì†Œë¹„ëœ ë¹„ìš©"
        },
        "balance_after": {
          "$ref": "#/$defs/CurrencyAmount",
          "description": "ì†Œë¹„ í›„ ì”ì•¡"
        }
      },
      "required": [
        "cost",
        "balance_after"
      ],
      "title": "EconomyOutput",
      "type": "object"
    },
    "ImageJob": {
      "additionalProperties": false,
      "description": "ì´ë¯¸ì§€ ìƒì„± ì‘ì—….\n\nì¡°ê±´ë¶€ ì´ë¯¸ì§€ ìƒì„±/í¸ì§‘ ìš”ì²­ì…ë‹ˆë‹¤.\nì´ë¯¸ì§€ ìƒì„±ì´ ëŠë¦´ ê²½ìš° í…ìŠ¤íŠ¸ ìš°ì„  ì¶œë ¥ + Lazy Loadingì„ ì‚¬ìš©í•©ë‹ˆë‹¤.\n\nAttributes:\n    should_generate: ì´ë¯¸ì§€ë¥¼ ìƒì„±í•´ì•¼ í•˜ëŠ”ì§€\n    prompt: ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸\n    model_label: ëª¨ë¸ ì„ íƒ ë¼ë²¨ (FAST/QUALITY/CHEAP/REF)\n    aspect_ratio: ê°€ë¡œì„¸ë¡œ ë¹„ìœ¨ (ì˜ˆ: \"16:9\", \"1:1\")\n    image_size: ì´ë¯¸ì§€ í¬ê¸° (ì˜ˆ: \"1024x1024\")\n    reference_image_ids: ì°¸ì¡° ì´ë¯¸ì§€ ID ëª©ë¡ (ì„ íƒ)",
      "properties": {
        "should_generate": {
          "description": "ì´ë¯¸ì§€ë¥¼ ìƒì„±í•´ì•¼ í•˜ëŠ”ì§€",
          "title": "Should Generate",
          "type": "boolean"
        },
        "prompt": {
          "default": "",
          "description": "ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸",
          "title": "Prompt",
          "type": "string"
        },
        "model_label": {
          "$ref": "#/$defs/ModelLabel",
          "default": "FAST",
          "description": "ëª¨ë¸ ì„ íƒ ë¼ë²¨"
        },
        "aspect_ratio": {
          "default": "16:9",
          "description": "ê°€ë¡œì„¸ë¡œ ë¹„ìœ¨",
          "title": "Aspect Ratio",
          "type": "string"
        },
        "image_size": {
          "default": "1024x1024",
          "description": "ì´ë¯¸ì§€ í¬ê¸°",
          "title": "Image Size",
          "type": "string"
        },
        "reference_image_ids": {
          "default": [],
          "description": "ì°¸ì¡° ì´ë¯¸ì§€ ID ëª©ë¡ (ì„ íƒ)",
          "items": {
            "type": "string"
          },
          "title": "Reference Image Ids",
          "type": "array"
        }
      },
      "required": [
        "should_generate"
      ],
      "title": "ImageJob",
      "type": "object"
    },
    "Language": {
      "description": "ì§€ì› ì–¸ì–´ (RULE-006).\n\nko/en í˜¼í•© ì¶œë ¥ ê¸ˆì§€. TurnInput.languageë¥¼ SSOTë¡œ ì‚¼ì•„\nëª¨ë“  UI/ë‚´ëŸ¬í‹°ë¸Œ/ì‹œìŠ¤í…œ ë©”ì‹œì§€ëŠ” ë™ì¼ ì–¸ì–´ë¡œ ê³ ì •í•©ë‹ˆë‹¤.",
      "enum": [
        "ko-KR",
        "en-US"
      ],
      "title": "Language",
      "type": "string"
    },
    "MemoryPin": {
      "additionalProperties": false,
      "description": "ì¤‘ìš” ì„¤ì • ê³ ì • í›„ë³´.\n\nì‚¬ìš©ìê°€ Memory Shardë¥¼ ì†Œë¹„í•´ ê³ ì •í•  ìˆ˜ ìˆëŠ” ì¤‘ìš” ì„¤ì •ì…ë‹ˆë‹¤.\n\nAttributes:\n    id: í•€ ê³ ìœ  ID\n    content: ê³ ì •í•  ë‚´ìš©\n    cost: ê³ ì •ì— í•„ìš”í•œ ë¹„ìš©",
      "properties": {
        "id": {
          "description": "í•€ ê³ ìœ  ID",
          "title": "Id",
          "type": "string"
        },
        "content": {
          "description": "ê³ ì •í•  ë‚´ìš©",
          "title": "Content",
          "type": "string"
        },
        "cost": {
          "$ref": "#/$defs/CurrencyAmount",
          "description": "ê³ ì •ì— í•„ìš”í•œ ë¹„ìš©"
        }
      },
      "required": [
        "id",
        "content",
        "cost"
      ],
      "title": "MemoryPin",
      "type": "object"
    },
    "ModelLabel": {
      "description": "ëª¨ë¸/í’ˆì§ˆ ì„ íƒ ë¼ë²¨ (RULE-008).\n\ní”„ë¡¬í”„íŠ¸ ë…¸ì¶œ ì—†ì´ \"ì™œ ì´ ì„ íƒì´ì—ˆëŠ”ì§€\"ë¥¼ ì‚¬ìš©ì ì¹œí™” ë¼ë²¨ë¡œ í‘œì‹œ.",
      "enum": [
        "FAST",
        "QUALITY",
        "CHEAP",
        "REF"
      ],
      "title": "ModelLabel",
      "type": "string"
    },
    "Quest": {
      "additionalProperties": false,
      "description": "í€˜ìŠ¤íŠ¸/ëª©í‘œ (Quest Panel).\n\ní”Œë ˆì´ì–´ê°€ ë‹¬ì„±í•´ì•¼ í•˜ëŠ” í˜„ì¬ ëª©í‘œì…ë‹ˆë‹¤.\n\nAttributes:\n    id: í€˜ìŠ¤íŠ¸ ê³ ìœ  ID\n    label: í€˜ìŠ¤íŠ¸ ì´ë¦„\n    is_completed: ë‹¬ì„± ì—¬ë¶€",
      "properties": {
        "id": {
          "description": "í€˜ìŠ¤íŠ¸ ê³ ìœ  ID",
          "title": "Id",
          "type": "string"
        },
        "label": {
          "description": "í€˜ìŠ¤íŠ¸ ì´ë¦„",
          "title": "Label",
          "type": "string"
        },
        "is_completed": {
          "default": false,
          "description": "ë‹¬ì„± ì—¬ë¶€",
          "title": "Is Completed",
          "type": "boolean"
        }
      },
      "required": [
        "id",
        "label"
      ],
      "title": "Quest",
      "type": "object"
    },
    "RenderOutput": {
      "additionalProperties": false,
      "description": "ë Œë”ë§ ì¶œë ¥ ë°ì´í„°.\n\nì´ë¯¸ì§€ ìƒì„±/í¸ì§‘ ê´€ë ¨ ì •ë³´ì…ë‹ˆë‹¤.\n\nAttributes:\n    image_job: ì´ë¯¸ì§€ ìƒì„± ì‘ì—… (ì„ íƒ)",
      "properties": {
        "image_job": {
          "anyOf": [
            {
              "$ref": "#/$defs/ImageJob"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "ì´ë¯¸ì§€ ìƒì„± ì‘ì—… (ì„ íƒ)"
        }
      },
      "title": "RenderOutput",
      "type": "object"
    },
    "RiskLevel": {
      "description": "í–‰ë™ ìœ„í—˜ë„ ìˆ˜ì¤€.",
      "enum": [
        "low",
        "medium",
        "high"
      ],
      "title": "RiskLevel",
      "type": "string"
    },
    "SafetyOutput": {
      "additionalProperties": false,
      "description": "ì•ˆì „ ì¶œë ¥ ë°ì´í„°.\n\nì•ˆì „ ì •ì±… ê´€ë ¨ ì •ë³´ì…ë‹ˆë‹¤.\nì°¨ë‹¨ ì‹œ ëª…ì‹œì  ë©”ì‹œì§€ì™€ í•¨ê»˜ ì•ˆì „í•œ ëŒ€ì²´ ê²°ê³¼ë¥¼ ì œê³µí•©ë‹ˆë‹¤.\n\nAttributes:\n    blocked: ì•ˆì „ ì •ì±…ì— ì˜í•´ ì°¨ë‹¨ë˜ì—ˆëŠ”ì§€\n    message: ì°¨ë‹¨ ì‹œ ì‚¬ìš©ìì—ê²Œ í‘œì‹œí•  ë©”ì‹œì§€ (ì„ íƒ)",
      "properties": {
        "blocked": {
          "default": false,
          "description": "ì•ˆì „ ì •ì±…ì— ì˜í•´ ì°¨ë‹¨ë˜ì—ˆëŠ”ì§€",
          "title": "Blocked",
          "type": "boolean"
        },
        "message": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "ì°¨ë‹¨ ì‹œ ì‚¬ìš©ìì—ê²Œ í‘œì‹œí•  ë©”ì‹œì§€ (ì„ íƒ)",
          "title": "Message"
        }
      },
      "title": "SafetyOutput",
      "type": "object"
    },
    "SceneObject": {
      "additionalProperties": false,
      "description": "ì¥ë©´ ì˜¤ë¸Œì íŠ¸ (í´ë¦­ ê°€ëŠ¥í•œ í•«ìŠ¤íŒŸ).\n\ní™”ë©´ì—ì„œ í´ë¦­ ê°€ëŠ¥í•œ ì˜¤ë¸Œì íŠ¸ì…ë‹ˆë‹¤.\nì¢Œí‘œëŠ” 0~1000 ì •ê·œí™” ì¢Œí‘œê³„ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤ (RULE-009).\n\nAttributes:\n    id: ì˜¤ë¸Œì íŠ¸ ê³ ìœ  ID\n    label: ì˜¤ë¸Œì íŠ¸ ë¼ë²¨ (í‘œì‹œìš©)\n    box_2d: ë°”ìš´ë”© ë°•ìŠ¤ [ymin, xmin, ymax, xmax]\n    interaction_hint: ìƒí˜¸ì‘ìš© íŒíŠ¸ (ì„ íƒ)",
      "properties": {
        "id": {
          "description": "ì˜¤ë¸Œì íŠ¸ ê³ ìœ  ID",
          "title": "Id",
          "type": "string"
        },
        "label": {
          "description": "ì˜¤ë¸Œì íŠ¸ ë¼ë²¨ (í‘œì‹œìš©)",
          "title": "Label",
          "type": "string"
        },
        "box_2d": {
          "$ref": "#/$defs/Box2D",
          "description": "ë°”ìš´ë”© ë°•ìŠ¤"
        },
        "interaction_hint": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "ìƒí˜¸ì‘ìš© íŒíŠ¸ (ì„ íƒ)",
          "title": "Interaction Hint"
        }
      },
      "required": [
        "id",
        "label",
        "box_2d"
      ],
      "title": "SceneObject",
      "type": "object"
    },
    "SceneOutput": {
      "additionalProperties": false,
      "description": "Scene í‘œì‹œ ì •ë³´ (RU-003-T1: Scene ì´ë¯¸ì§€ SSOT).\n\nTurnOutputì—ì„œ Scene Canvasì— í‘œì‹œí•  ì´ë¯¸ì§€ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.\nimage_urlì´ ì¡´ì¬í•˜ë©´ SceneCanvasëŠ” 'scene' ìƒíƒœë¡œ ì „í™˜ë©ë‹ˆë‹¤.\nimage_urlì´ ì—†ìœ¼ë©´ 'default' ìƒíƒœë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.\n\nAttributes:\n    image_url: Scene ì´ë¯¸ì§€ URL (ì¡´ì¬ ì‹œ scene ìƒíƒœë¡œ ì „í™˜)\n    alt_text: ì´ë¯¸ì§€ ëŒ€ì²´ í…ìŠ¤íŠ¸ (ì ‘ê·¼ì„±ìš©, ì„ íƒ)",
      "properties": {
        "image_url": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Scene ì´ë¯¸ì§€ URL (ì¡´ì¬ ì‹œ scene ìƒíƒœë¡œ ì „í™˜)",
          "title": "Image Url"
        },
        "alt_text": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "ì´ë¯¸ì§€ ëŒ€ì²´ í…ìŠ¤íŠ¸ (ì ‘ê·¼ì„±ìš©, ì„ íƒ)",
          "title": "Alt Text"
        }
      },
      "title": "SceneOutput",
      "type": "object"
    },
    "UIOutput": {
      "additionalProperties": false,
      "description": "UI ì¶œë ¥ ë°ì´í„°.\n\nAIê°€ ìƒì„±í•œ UI ìš”ì†Œë“¤ì…ë‹ˆë‹¤.\nì±„íŒ… ë²„ë¸”ì´ ì•„ë‹Œ ê²Œì„ UIë¡œ í‘œí˜„ë©ë‹ˆë‹¤ (RULE-002).\n\nRU-003-T1: scene í•„ë“œ ì¶”ê°€ - Scene Canvasì˜ ì´ë¯¸ì§€ í‘œì‹œ ì •ë³´ SSOT.\n\nAttributes:\n    action_deck: ì•¡ì…˜ ì¹´ë“œ ë± (Q1 ê²°ì •: Option A ì±„íƒ)\n    objects: í´ë¦­ ê°€ëŠ¥í•œ ì¥ë©´ ì˜¤ë¸Œì íŠ¸ ëª©ë¡\n    scene: Scene í‘œì‹œ ì •ë³´ (RU-003-T1)",
      "properties": {
        "action_deck": {
          "$ref": "#/$defs/ActionDeck",
          "description": "ì•¡ì…˜ ì¹´ë“œ ë±"
        },
        "objects": {
          "default": [],
          "description": "í´ë¦­ ê°€ëŠ¥í•œ ì¥ë©´ ì˜¤ë¸Œì íŠ¸ ëª©ë¡",
          "items": {
            "$ref": "#/$defs/SceneObject"
          },
          "title": "Objects",
          "type": "array"
        },
        "scene": {
          "$ref": "#/$defs/SceneOutput",
          "default": {
            "image_url": null,
            "alt_text": null
          },
          "description": "Scene í‘œì‹œ ì •ë³´ (RU-003-T1)"
        }
      },
      "title": "UIOutput",
      "type": "object"
    },
    "ValidationBadge": {
      "description": "ê²€ì¦ ë°°ì§€ (RULE-008).\n\ní„´ ê²°ê³¼ì— ëŒ€í•œ ê²€ì¦ ìƒíƒœë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.",
      "enum": [
        "schema_ok",
        "schema_fail",
        "economy_ok",
        "economy_fail",
        "safety_ok",
        "safety_blocked",
        "consistency_ok",
        "consistency_fail"
      ],
      "title": "ValidationBadge",
      "type": "string"
    },
    "WorldDelta": {
      "additionalProperties": false,
      "description": "ì„¸ê³„ ìƒíƒœ ë³€í™” (Q2 ê²°ì •: Option A - delta ì¤‘ì‹¬).\n\nì´ë²ˆ í„´ì—ì„œ ë³€ê²½ëœ ì„¸ê³„ ìƒíƒœë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.\nsnapshotì€ SaveGameì—ë§Œ ì €ì¥í•˜ê³ , ë§¤ í„´ì€ deltaë§Œ ì „ì†¡í•©ë‹ˆë‹¤.\n\nAttributes:\n    rules_changed: ë³€ê²½ë˜ê±°ë‚˜ ì¶”ê°€ëœ ê·œì¹™ ëª©ë¡\n    inventory_added: ì¶”ê°€ëœ ì¸ë²¤í† ë¦¬ ì•„ì´í…œ\n    inventory_removed: ì œê±°ëœ ì¸ë²¤í† ë¦¬ ì•„ì´í…œ\n    quests_updated: ì—…ë°ì´íŠ¸ëœ í€˜ìŠ¤íŠ¸(ëª©í‘œ) ëª©ë¡\n    relationships_changed: ë³€ê²½ëœ ê´€ê³„\n    memory_pins: ì¤‘ìš” ì„¤ì • ê³ ì • í›„ë³´",
      "properties": {
        "rules_changed": {
          "default": [],
          "description": "ë³€ê²½ëœ ê·œì¹™ ëª©ë¡",
          "items": {
            "$ref": "#/$defs/WorldRule"
          },
          "title": "Rules Changed",
          "type": "array"
        },
        "inventory_added": {
          "default": [],
          "description": "ì¶”ê°€ëœ ì¸ë²¤í† ë¦¬ ì•„ì´í…œ",
          "items": {
            "type": "string"
          },
          "title": "Inventory Added",
          "type": "array"
        },
        "inventory_removed": {
          "default": [],
          "description": "ì œê±°ëœ ì¸ë²¤í† ë¦¬ ì•„ì´í…œ",
          "items": {
            "type": "string"
          },
          "title": "Inventory Removed",
          "type": "array"
        },
        "quests_updated": {
          "default": [],
          "description": "ì—…ë°ì´íŠ¸ëœ í€˜ìŠ¤íŠ¸/ëª©í‘œ ëª©ë¡",
          "items": {
            "$ref": "#/$defs/Quest"
          },
          "title": "Quests Updated",
          "type": "array"
        },
        "relationships_changed": {
          "default": [],
          "description": "ë³€ê²½ëœ ê´€ê³„",
          "items": {
            "type": "string"
          },
          "title": "Relationships Changed",
          "type": "array"
        },
        "memory_pins": {
          "default": [],
          "description": "ì¤‘ìš” ì„¤ì • ê³ ì • í›„ë³´",
          "items": {
            "$ref": "#/$defs/MemoryPin"
          },
          "title": "Memory Pins",
          "type": "array"
        }
      },
      "title": "WorldDelta",
      "type": "object"
    },
    "WorldRule": {
      "additionalProperties": false,
      "description": "ì„¸ê³„ ê·œì¹™ (Rule Board).\n\ní˜„ì¬ ì„¸ê³„ì— ì ìš© ì¤‘ì¸ ë¬¼ë¦¬ ë²•ì¹™ì´ë‚˜ ë©”íƒ€ ê·œì¹™ì…ë‹ˆë‹¤.\n\nAttributes:\n    id: ê·œì¹™ ê³ ìœ  ID\n    label: ê·œì¹™ ì´ë¦„\n    description: ê·œì¹™ ìƒì„¸ ì„¤ëª… (ì„ íƒ)",
      "properties": {
        "id": {
          "description": "ê·œì¹™ ê³ ìœ  ID",
          "title": "Id",
          "type": "string"
        },
        "label": {
          "description": "ê·œì¹™ ì´ë¦„",
          "title": "Label",
          "type": "string"
        },
        "description": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "ê·œì¹™ ìƒì„¸ ì„¤ëª… (ì„ íƒ)",
          "title": "Description"
        }
      },
      "required": [
        "id",
        "label"
      ],
      "title": "WorldRule",
      "type": "object"
    }
  },
  "additionalProperties": false,
  "description": "í„´ ì¶œë ¥ (ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸).\n\nì„œë²„ê°€ í„´ ì²˜ë¦¬ í›„ í´ë¼ì´ì–¸íŠ¸ë¡œ ë°˜í™˜í•˜ëŠ” êµ¬ì¡°í™”ëœ ì‘ë‹µì…ë‹ˆë‹¤.\nGemini Structured Outputs(JSON Schema)ë¡œ ê°•ì œë©ë‹ˆë‹¤.\n\nHard Gate í•„ë“œ (RULE-003/004/005):\n    - economy: costì™€ balance_after í•„ìˆ˜, ì”ì•¡ ìŒìˆ˜ ê¸ˆì§€\n    - safety: blocked ì‹œ ì•ˆì „í•œ ëŒ€ì²´ ê²°ê³¼ ì œê³µ\n    - language: ìš”ì²­ ì–¸ì–´ì™€ ë™ì¼í•˜ê²Œ ê³ ì • (í˜¼í•© ì¶œë ¥ ê¸ˆì§€)\n\nAttributes:\n    language: ì‘ë‹µ ì–¸ì–´ (ìš”ì²­ê³¼ ë™ì¼)\n    narrative: ë‚´ëŸ¬í‹°ë¸Œ í…ìŠ¤íŠ¸ (í‘œì‹œìš©)\n    ui: UI ìš”ì†Œ (ì•¡ì…˜ ë±, ì˜¤ë¸Œì íŠ¸)\n    world: ì„¸ê³„ ìƒíƒœ ë³€í™” (delta ì¤‘ì‹¬)\n    render: ë Œë”ë§ ì •ë³´ (ì´ë¯¸ì§€ ìƒì„± ì‘ì—…)\n    economy: ê²½ì œ ì •ë³´ (ë¹„ìš©, ì”ì•¡)\n    safety: ì•ˆì „ ì •ì±… ì •ë³´\n    agent_console: ì—ì´ì „íŠ¸ ì‹¤í–‰ ì •ë³´ (ë‹¨ê³„, ë°°ì§€, ë³µêµ¬ íšŸìˆ˜)\n\nExample:\n    >>> output = TurnOutput(\n    ...     language=Language.KO,\n    ...     narrative=\"ë¬¸ì´ ì‚ê±±ê±°ë¦¬ë©° ì—´ë¦½ë‹ˆë‹¤...\",\n    ...     economy=EconomyOutput(\n    ...         cost=CurrencyAmount(signal=5, memory_shard=0),\n    ...         balance_after=CurrencyAmount(signal=95, memory_shard=5),\n    ...     ),\n    ...     safety=SafetyOutput(blocked=False),\n    ... )\n    >>> schema = TurnOutput.model_json_schema()\n\nSchema Generation:\n    >>> # Gemini Structured Outputsìš© JSON Schema ìƒì„±\n    >>> json_schema = TurnOutput.model_json_schema()\n    >>> # response_json_schema íŒŒë¼ë¯¸í„°ì— ì „ë‹¬\n    >>> config = {\n    ...     \"response_mime_type\": \"application/json\",\n    ...     \"response_json_schema\": json_schema,\n    ... }",
  "properties": {
    "language": {
      "$ref": "#/$defs/Language",
      "description": "ì‘ë‹µ ì–¸ì–´ (ìš”ì²­ê³¼ ë™ì¼)"
    },
    "narrative": {
      "description": "ë‚´ëŸ¬í‹°ë¸Œ í…ìŠ¤íŠ¸ (í‘œì‹œìš©)",
      "title": "Narrative",
      "type": "string"
    },
    "economy": {
      "$ref": "#/$defs/EconomyOutput",
      "description": "ê²½ì œ ì •ë³´ (ë¹„ìš©, ì”ì•¡)"
    },
    "safety": {
      "$ref": "#/$defs/SafetyOutput",
      "description": "ì•ˆì „ ì •ì±… ì •ë³´"
    },
    "ui": {
      "$ref": "#/$defs/UIOutput",
      "description": "UI ìš”ì†Œ"
    },
    "world": {
      "$ref": "#/$defs/WorldDelta",
      "description": "ì„¸ê³„ ìƒíƒœ ë³€í™” (delta)"
    },
    "render": {
      "$ref": "#/$defs/RenderOutput",
      "description": "ë Œë”ë§ ì •ë³´"
    },
    "agent_console": {
      "$ref": "#/$defs/AgentConsole",
      "description": "ì—ì´ì „íŠ¸ ì‹¤í–‰ ì •ë³´"
    }
  },
  "required": [
    "language",
    "narrative",
    "economy",
    "safety"
  ],
  "title": "TurnOutput",
  "type": "object"
}
</file>

<file path="backend/prompts/scan/scan_instructions.en.md">
<prompt_meta>
  <prompt_id>scan_instructions</prompt_id>
  <language>en-US</language>
  <version>1.1.0</version>
  <last_updated>2026-02-07</last_updated>
</prompt_meta>

<prompt_body>
You are an image analysis expert. Analyze the given image and extract the following information in JSON format.

## Task Instructions

1. **Caption**: A description of the entire image in English (1-2 sentences)
2. **Objects**: List of main objects found in the image
   - label: Object name (English)
   - box_2d: Bounding box coordinates [ymin, xmin, ymax, xmax] (0~1000 normalized)
   - suggested_item_type: Suitable type for game item conversion (key, weapon, tool, clue, material, container, etc.)
3. **Item Candidates**: List of items converted for game use
   - id: Unique ID (e.g., "item_001")
   - label: Item name (English)
   - description: Item description (English, 1 sentence)
   - item_type: Item type
   - source_object_index: Original object index

## Item Discovery Count Instruction (U-095)

You MUST extract exactly **{count}** distinct item candidates (item_candidates) from this image.
- Each item MUST have a **unique name and description** (no duplicate items).
- Items may be related to each other for a more natural feel (e.g., 'broken sword' + 'sword fragment').
- You MUST return exactly {count} items in the item_candidates array.

## Output Format (JSON)

```json
{
  "caption": "Image description...",
  "objects": [
    {
      "label": "object_name",
      "box_2d": {"ymin": 100, "xmin": 200, "ymax": 400, "xmax": 500},
      "suggested_item_type": "key"
    }
  ],
  "item_candidates": [
    {
      "id": "item_001",
      "label": "item_name",
      "description": "Item description",
      "item_type": "key",
      "source_object_index": 0
    }
  ]
}
```

## Notes

- bbox coordinates must be normalized within 0~100 range.
- Exclude objects not suitable for games (human faces, sensitive content, etc.).
- Extract up to 10 objects and item candidates.
</prompt_body>
</file>

<file path="backend/prompts/scan/scan_instructions.ko.md">
<prompt_meta>
  <prompt_id>scan_instructions</prompt_id>
  <language>ko-KR</language>
  <version>1.1.0</version>
  <last_updated>2026-02-07</last_updated>
</prompt_meta>

<prompt_body>
ë‹¹ì‹ ì€ ì´ë¯¸ì§€ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì£¼ì–´ì§„ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ ì •ë³´ë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ì¶”ì¶œí•˜ì„¸ìš”.

## ì‘ì—… ì§€ì‹œ

1. **ìº¡ì…˜ (caption)**: ì´ë¯¸ì§€ ì „ì²´ë¥¼ ì„¤ëª…í•˜ëŠ” í•œêµ­ì–´ ë¬¸ì¥ (1-2ë¬¸ì¥)
2. **ì˜¤ë¸Œì íŠ¸ (objects)**: ì´ë¯¸ì§€ì—ì„œ ë°œê²¬ëœ ì£¼ìš” ì˜¤ë¸Œì íŠ¸ ëª©ë¡
   - label: ì˜¤ë¸Œì íŠ¸ ì´ë¦„ (í•œêµ­ì–´)
   - box_2d: ë°”ìš´ë”© ë°•ìŠ¤ ì¢Œí‘œ [ymin, xmin, ymax, xmax] (0~1000 ì •ê·œí™”)
   - suggested_item_type: ê²Œì„ ì•„ì´í…œìœ¼ë¡œ ë³€í™˜ ì‹œ ì í•©í•œ ìœ í˜• (key, weapon, tool, clue, material, container ë“±)
3. **ì•„ì´í…œ í›„ë³´ (item_candidates)**: ê²Œì„ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´í…œìœ¼ë¡œ ë³€í™˜ëœ ëª©ë¡
   - id: ê³ ìœ  ID (ì˜ˆ: "item_001")
   - label: ì•„ì´í…œ ì´ë¦„ (í•œêµ­ì–´)
   - description: ì•„ì´í…œ ì„¤ëª… (í•œêµ­ì–´, 1ë¬¸ì¥)
   - item_type: ì•„ì´í…œ ìœ í˜•
   - source_object_index: ì›ë³¸ ì˜¤ë¸Œì íŠ¸ ì¸ë±ìŠ¤

## ì•„ì´í…œ ë°œê²¬ ê°œìˆ˜ ì§€ì‹œ (U-095)

ì´ ì´ë¯¸ì§€ì—ì„œ ì •í™•íˆ **{count}ê°œ**ì˜ ì„œë¡œ ë‹¤ë¥¸ ì•„ì´í…œ í›„ë³´(item_candidates)ë¥¼ ë°˜ë“œì‹œ ì¶”ì¶œí•˜ì„¸ìš”.
- ê° ì•„ì´í…œì€ **ê³ ìœ í•œ ì´ë¦„ê³¼ ì„¤ëª…**ì„ ê°€ì ¸ì•¼ í•©ë‹ˆë‹¤ (ë™ì¼ ì•„ì´í…œ ì¤‘ë³µ ê¸ˆì§€).
- ì•„ì´í…œ ê°„ ì—°ê´€ì„±ì´ ìˆìœ¼ë©´ ë” ìì—°ìŠ¤ëŸ½ìŠµë‹ˆë‹¤ (ì˜ˆ: 'ë¶€ëŸ¬ì§„ ì¹¼' + 'ì¹¼ ì¡°ê°').
- ë°˜ë“œì‹œ item_candidates ë°°ì—´ì— ì •í™•íˆ {count}ê°œì˜ í•­ëª©ì„ ë°˜í™˜í•˜ì„¸ìš”.

## ì¶œë ¥ í˜•ì‹ (JSON)

```json
{
  "caption": "ì´ë¯¸ì§€ ì„¤ëª…...",
  "objects": [
    {
      "label": "ì˜¤ë¸Œì íŠ¸ëª…",
      "box_2d": {"ymin": 100, "xmin": 200, "ymax": 400, "xmax": 500},
      "suggested_item_type": "key"
    }
  ],
  "item_candidates": [
    {
      "id": "item_001",
      "label": "ì•„ì´í…œëª…",
      "description": "ì•„ì´í…œ ì„¤ëª…",
      "item_type": "key",
      "source_object_index": 0
    }
  ]
}
```

## ì£¼ì˜ì‚¬í•­

- bbox ì¢Œí‘œëŠ” ë°˜ë“œì‹œ 0~1000 ë²”ìœ„ ë‚´ì—ì„œ ì •ê·œí™”í•˜ì„¸ìš”.
- ê²Œì„ì— ì í•©í•˜ì§€ ì•Šì€ ì˜¤ë¸Œì íŠ¸(ì‚¬ëŒ ì–¼êµ´, ë¯¼ê°í•œ ì½˜í…ì¸  ë“±)ëŠ” ì œì™¸í•˜ì„¸ìš”.
- ìµœëŒ€ 10ê°œì˜ ì˜¤ë¸Œì íŠ¸ì™€ ì•„ì´í…œ í›„ë³´ë¥¼ ì¶”ì¶œí•˜ì„¸ìš”.
</prompt_body>
</file>

<file path="backend/prompts/vision/scene_affordances.en.md">
<prompt_meta>
  <prompt_id>scene_affordances</prompt_id>
  <language>en-US</language>
  <version>0.1.0</version>
  <last_updated>2026-02-07</last_updated>
  <policy_preset>vision</policy_preset>
</prompt_meta>

<prompt_body>
## Purpose

Analyze the given scene image and extract **clickable/interactable objects (affordances)** that the player can interact with.

---

## Task Instructions

1. Carefully observe the image and identify **interactable objects**.
2. For each object:
   - **label**: Object name (English, concise)
   - **box_2d**: Bounding box coordinates `{ymin, xmin, ymax, xmax}` (0~1000 normalized)
   - **interaction_hint**: One-line hint about possible interaction (optional)
3. Extract up to **5 objects** (ordered by importance and interaction likelihood).

---

## Coordinate Convention (RULE-009)

- All coordinates use **0~1000 normalized coordinate system**
- bbox order: `[ymin, xmin, ymax, xmax]`
  - ymin: Top Y coordinate of object
  - xmin: Left X coordinate of object
  - ymax: Bottom Y coordinate of object
  - xmax: Right X coordinate of object
- Image top-left is (0, 0), bottom-right is (1000, 1000)

---

## Interaction Target Criteria

**Include**:
- Doors, chests, levers, switches â€” manipulable objects
- Weapons, keys, tools â€” acquirable items
- NPCs, animals â€” interactable characters
- Secret passages, cracks, glowing areas â€” exploration points
- Signs, documents, murals â€” information-providing objects

**Exclude**:
- Background decorations (plain walls, sky, floor)
- Too small or unclear objects
- Content inappropriate for the game

---

## Output Format (JSON)

```json
{
  "affordances": [
    {
      "label": "Object name",
      "box_2d": {"ymin": 100, "xmin": 200, "ymax": 400, "xmax": 500},
      "interaction_hint": "Interaction hint"
    }
  ]
}
```

---

## Example

```json
{
  "affordances": [
    {
      "label": "Old Wooden Door",
      "box_2d": {"ymin": 80, "xmin": 300, "ymax": 850, "xmax": 650},
      "interaction_hint": "Looks like it can be opened"
    },
    {
      "label": "Wall Torch",
      "box_2d": {"ymin": 100, "xmin": 750, "ymax": 350, "xmax": 850},
      "interaction_hint": "Could be taken"
    },
    {
      "label": "Statue's Eyes",
      "box_2d": {"ymin": 200, "xmin": 50, "ymax": 300, "xmax": 150},
      "interaction_hint": "Seems to hide a secret"
    }
  ]
}
```
</prompt_body>
</file>

<file path="backend/prompts/vision/scene_affordances.ko.md">
<prompt_meta>
  <prompt_id>scene_affordances</prompt_id>
  <language>ko-KR</language>
  <version>0.1.0</version>
  <last_updated>2026-02-07</last_updated>
  <policy_preset>vision</policy_preset>
</prompt_meta>

<prompt_body>
## ëª©ì 

ì£¼ì–´ì§„ ì¥ë©´(Scene) ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬ í”Œë ˆì´ì–´ê°€ **í´ë¦­/ìƒí˜¸ì‘ìš©í•  ìˆ˜ ìˆëŠ” ì˜¤ë¸Œì íŠ¸(affordances)**ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.

---

## ì‘ì—… ì§€ì‹œ

1. ì´ë¯¸ì§€ë¥¼ ì„¸ì‹¬í•˜ê²Œ ê´€ì°°í•˜ì—¬ **ìƒí˜¸ì‘ìš© ê°€ëŠ¥í•œ ì˜¤ë¸Œì íŠ¸**ë¥¼ ì‹ë³„í•˜ì„¸ìš”.
2. ê° ì˜¤ë¸Œì íŠ¸ì— ëŒ€í•´:
   - **label**: ì˜¤ë¸Œì íŠ¸ ì´ë¦„ (í•œêµ­ì–´, ê°„ê²°í•˜ê²Œ)
   - **box_2d**: ë°”ìš´ë”© ë°•ìŠ¤ ì¢Œí‘œ `{ymin, xmin, ymax, xmax}` (0~1000 ì •ê·œí™”)
   - **interaction_hint**: ì–´ë–¤ ìƒí˜¸ì‘ìš©ì´ ê°€ëŠ¥í•œì§€ í•œ ì¤„ íŒíŠ¸ (ì„ íƒ)
3. ìµœëŒ€ **5ê°œ**ì˜ ì˜¤ë¸Œì íŠ¸ë¥¼ ì¶”ì¶œí•˜ì„¸ìš” (ê°€ì¥ ì¤‘ìš”í•˜ê³  ìƒí˜¸ì‘ìš© ê°€ëŠ¥ì„±ì´ ë†’ì€ ìˆœì„œ).

---

## ì¢Œí‘œ ê·œì•½ (RULE-009)

- ëª¨ë“  ì¢Œí‘œëŠ” **0~1000 ì •ê·œí™” ì¢Œí‘œê³„** ì‚¬ìš©
- bbox ìˆœì„œ: `[ymin, xmin, ymax, xmax]`
  - ymin: ì˜¤ë¸Œì íŠ¸ ìƒë‹¨ Y ì¢Œí‘œ
  - xmin: ì˜¤ë¸Œì íŠ¸ ì¢Œì¸¡ X ì¢Œí‘œ
  - ymax: ì˜¤ë¸Œì íŠ¸ í•˜ë‹¨ Y ì¢Œí‘œ
  - xmax: ì˜¤ë¸Œì íŠ¸ ìš°ì¸¡ X ì¢Œí‘œ
- ì´ë¯¸ì§€ì˜ ì¢Œìƒë‹¨ì´ (0, 0), ìš°í•˜ë‹¨ì´ (1000, 1000)

---

## ìƒí˜¸ì‘ìš© ëŒ€ìƒ ê¸°ì¤€

**í¬í•¨**:
- ë¬¸, ìƒì, ë ˆë²„, ìŠ¤ìœ„ì¹˜ ë“± ì¡°ì‘ ê°€ëŠ¥í•œ ì˜¤ë¸Œì íŠ¸
- ë¬´ê¸°, ì—´ì‡ , ë„êµ¬ ë“± íšë“ ê°€ëŠ¥í•œ ì•„ì´í…œ
- NPC, ë™ë¬¼ ë“± ëŒ€í™”/ìƒí˜¸ì‘ìš© ê°€ëŠ¥í•œ ìºë¦­í„°
- ë¹„ë°€ í†µë¡œ, ê· ì—´, ë¹›ë‚˜ëŠ” ì˜ì—­ ë“± íƒìƒ‰ í¬ì¸íŠ¸
- í‘œì§€íŒ, ë¬¸ì„œ, ë²½í™” ë“± ì •ë³´ë¥¼ ì œê³µí•˜ëŠ” ì˜¤ë¸Œì íŠ¸

**ì œì™¸**:
- ë°°ê²½ ì¥ì‹ (ë‹¨ìˆœí•œ ë²½, í•˜ëŠ˜, ë°”ë‹¥ ë“±)
- ë„ˆë¬´ ì‘ê±°ë‚˜ ë¶ˆëª…í™•í•œ ì˜¤ë¸Œì íŠ¸
- ê²Œì„ì— ë¶€ì ì ˆí•œ ì½˜í…ì¸ 

---

## ì¶œë ¥ í˜•ì‹ (JSON)

```json
{
  "affordances": [
    {
      "label": "ì˜¤ë¸Œì íŠ¸ ì´ë¦„",
      "box_2d": {"ymin": 100, "xmin": 200, "ymax": 400, "xmax": 500},
      "interaction_hint": "ìƒí˜¸ì‘ìš© íŒíŠ¸"
    }
  ]
}
```

---

## ì˜ˆì‹œ

```json
{
  "affordances": [
    {
      "label": "ë‚¡ì€ ë‚˜ë¬´ ë¬¸",
      "box_2d": {"ymin": 80, "xmin": 300, "ymax": 850, "xmax": 650},
      "interaction_hint": "ì—´ì–´ë³¼ ìˆ˜ ìˆì„ ê²ƒ ê°™ë‹¤"
    },
    {
      "label": "ë²½ì— ê±¸ë¦° íšƒë¶ˆ",
      "box_2d": {"ymin": 100, "xmin": 750, "ymax": 350, "xmax": 850},
      "interaction_hint": "ê°€ì ¸ê°ˆ ìˆ˜ ìˆì„ ê²ƒ ê°™ë‹¤"
    },
    {
      "label": "ì„ìƒì˜ ëˆˆ",
      "box_2d": {"ymin": 200, "xmin": 50, "ymax": 300, "xmax": 150},
      "interaction_hint": "ë¬´ì–¸ê°€ ë¹„ë°€ì´ ìˆëŠ” ê²ƒ ê°™ë‹¤"
    }
  ]
}
```
</prompt_body>
</file>

<file path="backend/test_real_vision.json">
{
  "language": "ko-KR",
  "text": "",
  "action_id": "deep_analyze",
  "client": {
    "viewport_w": 1920,
    "viewport_h": 1080,
    "theme": "dark"
  },
  "economy_snapshot": {
    "signal": 100,
    "memory_shard": 5
  },
  "previous_image_url": "/static/images/test_scene.png"
}
</file>

<file path="backend/tests/fixtures/image_request_fast.json">
{
  "prompt": "A beautiful fantasy landscape with mountains and a glowing sunset",
  "aspect_ratio": "16:9",
  "model_label": "FAST"
}
</file>

<file path="backend/tests/fixtures/image_request_quality.json">
{
  "prompt": "A detailed cyberpunk city at night with neon lights",
  "aspect_ratio": "16:9",
  "model_label": "QUALITY"
}
</file>

<file path="backend/tests/fixtures/turn_request.json">
{
  "language": "ko-KR",
  "text": "ìƒˆë¡œìš´ ì„¸ê³„ë¥¼ íƒí—˜í•œë‹¤",
  "client": {
    "viewport_w": 1920,
    "viewport_h": 1080,
    "theme": "dark"
  },
  "economy_snapshot": {
    "signal": 100,
    "memory_shard": 5
  }
}
</file>

<file path="CLAUDE.md">
# AI ì—ì´ì „íŠ¸ ì „ì—­ ì§€ì¹¨ (Unknown World)

ì´ ë¬¸ì„œëŠ” Unknown World ë ˆí¬ì—ì„œ ì‘ì—…í•˜ëŠ” ëª¨ë“  AI ì—ì´ì „íŠ¸(Claude/Cursor í¬í•¨)ê°€ **ì¼ê´€ë˜ê³  íš¨ìœ¨ì ìœ¼ë¡œ** ì¼í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ì „ì—­ ê·œì¹™ì…ë‹ˆë‹¤.

---

## í”„ë¡œì íŠ¸ ê°œìš”

**Unknown World**ëŠ” Gemini ê¸°ë°˜ì˜ **ì—ì´ì „íŠ¸í˜•(Game Master) ì„¸ê³„ ì—”ì§„**ê³¼ ë©€í‹°ëª¨ë‹¬(í…ìŠ¤íŠ¸/ì´ë¯¸ì§€/ë¹„ì „) íŒŒì´í”„ë¼ì¸ì„ ê²°í•©í•œ **ë¬´í•œ ìƒì„± ë¡œê·¸ë¼ì´í¬ ë‚´ëŸ¬í‹°ë¸Œ ì›¹ê²Œì„**ì…ë‹ˆë‹¤.

- â€œëŒ€í™” ì•±â€ì´ ì•„ë‹ˆë¼ **ìƒíƒœë¥¼ ê°€ì§„ ì‹œìŠ¤í…œ**ì…ë‹ˆë‹¤.
- ì¶œë ¥ì€ ë‚´ëŸ¬í‹°ë¸Œ í…ìŠ¤íŠ¸ë¿ ì•„ë‹ˆë¼ **UI/ìƒíƒœ ë³€í™”/ë¹„ìš©/ì´ë¯¸ì§€ ì‘ì—…**ê¹Œì§€ í¬í•¨í•œ **êµ¬ì¡°í™” ê²°ê³¼(JSON Schema)** ì—¬ì•¼ í•©ë‹ˆë‹¤.
- ì‹¤íŒ¨/ë¶ˆì™„ì „ ì¶œë ¥ì— ëŒ€ë¹„í•´ **ê²€ì¦ + ìë™ ë³µêµ¬(Repair loop) + ì•ˆì „í•œ í´ë°±**ì„ ë‚´ì¥í•©ë‹ˆë‹¤.

---

## SSOT(ë‹¨ì¼ ì¶œì²˜) ë° ì¶©ëŒ í•´ê²° ìš°ì„ ìˆœìœ„

ë¬¸ì„œ/ê·œì¹™ì´ ì¶©ëŒí•  ë•ŒëŠ” ì•„ë˜ ìˆœì„œë¡œ ê²°ì •í•©ë‹ˆë‹¤.

1. `vibe/prd.md` (ì œí’ˆ/UX/ì„±ê³µ ì§€í‘œ/ê¸ˆì§€ì‚¬í•­)
2. `vibe/tech-stack.md` (ê¸°ìˆ  ìŠ¤íƒ/ë²„ì „/ì•„í‚¤í…ì²˜ ì„ íƒ)
3. `vibe/ref/*` (í‘œì¤€/ìŠ¤íƒ€ì¼/êµ¬ì¡°í™” ì¶œë ¥ ê°€ì´ë“œ)
4. `.cursor/rules/*.mdc` (êµ¬ì²´ì  ì‹¤í–‰ ê·œì¹™)
5. `.gemini/rules/*` (ì¡´ì¬í•˜ëŠ” ê²½ìš°ì— í•œí•´ ì°¸ê³ ; í”„ë¡œì íŠ¸ì™€ ë¶ˆì¼ì¹˜ ì‹œ ì ìš© ê¸ˆì§€)

ë¶ˆí™•ì‹¤í•˜ë©´ **ì¶”ì¸¡í•˜ì§€ ë§ê³  ì§ˆë¬¸**í•©ë‹ˆë‹¤.

---

## í•µì‹¬ ì›ì¹™ (Nonâ€‘Negotiable)

### 1) Prompt-only wrapper / Generic chatbot íšŒí”¼

- â€œí”„ë¡¬í”„íŠ¸ 1ì¥ + ì±„íŒ… UIâ€ í˜•íƒœë¥¼ ê¸ˆì§€í•©ë‹ˆë‹¤.
- ë°˜ë“œì‹œ ë‹¤ìŒì´ ì¡´ì¬í•´ì•¼ í•©ë‹ˆë‹¤:
  - **ìƒíƒœ(State)**: WorldState / Inventory / Rules / Economy / History
  - **ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°(Orchestrator)**: ë‹¨ê³„ ì‹¤í–‰, ê²€ì¦, ì¬ì‹œë„, ë¹„ìš© ì œì–´
  - **ì•„í‹°íŒ©íŠ¸(Artifacts)**: SaveGame, ì—”ë”© ë¦¬í¬íŠ¸, ë¡œê·¸/ì´ë¯¸ì§€

### 2) ì±„íŒ… ë²„ë¸” UI ê¸ˆì§€, ê²Œì„ UI ê³ ì •

- ë©”ì‹ ì €í˜• **ì±„íŒ… ë²„ë¸” UI ê¸ˆì§€**(ì‹¬ì‚¬ì ì˜¤í•´ ë°©ì§€).
- ë°ëª¨ì—ì„œ ìµœì†Œ ë‹¤ìŒ UIëŠ” í•­ìƒ â€œê²Œì„ìŠ¤ëŸ½ê²Œâ€ ë³´ì´ë„ë¡ ê³ ì •í•©ë‹ˆë‹¤:
  - Action Deck(ë¹„ìš©/ìœ„í—˜/ë³´ìƒ í¬í•¨), Inventory(DnD), Quest/Objective, Rule Board/Mutation Timeline,
    Economy HUD(ì˜ˆìƒ/í™•ì • ë¹„ìš©), Memory Pin, Scene Canvas(í•«ìŠ¤íŒŸ), Agent Console(Plan/Queue/Badges)

### 3) êµ¬ì¡°í™” ì¶œë ¥(JSON Schema) ìš°ì„  + ì´ì¤‘ ê²€ì¦

- ëª¨ë¸ ì¶œë ¥ì€ ê¸°ë³¸ì ìœ¼ë¡œ `application/json` + JSON Schemaë¥¼ ê°•ì œí•©ë‹ˆë‹¤.
- **ì„œë²„(Pydantic) + í´ë¼ì´ì–¸íŠ¸(Zod)** ì´ì¤‘ ê²€ì¦ì„ ì „ì œë¡œ ì„¤ê³„í•©ë‹ˆë‹¤.

### 4) ê²€ì¦/ë³µêµ¬(Repair loop)ì™€ í´ë°±ì€ â€œí•„ìˆ˜ ê¸°ëŠ¥â€

- ìŠ¤í‚¤ë§ˆ ë¶ˆì¼ì¹˜/ë¹„ì¦ˆë‹ˆìŠ¤ ë£° ìœ„ë°˜/ë¹„ìš© ì´ˆê³¼/ì•ˆì „ ì°¨ë‹¨ ë“±ì€ **ìë™ ë³µêµ¬ ë£¨í”„**ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
- ë³µêµ¬ ì‹¤íŒ¨ ì‹œì—ë„ **í…ìŠ¤íŠ¸-only ë“± ì•ˆì „í•œ ëŒ€ì²´ ê²°ê³¼**ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

### 5) ë¹„ìš©/ì§€ì—°ì€ UX/ê²Œì„ ë©”ì»¤ë‹‰ìœ¼ë¡œ ì œì–´

- í–‰ë™ ì „ì— **ì˜ˆìƒ ë¹„ìš©(ìµœì†Œ/ìµœëŒ€)** ë…¸ì¶œ, ë¶€ì¡± ì‹œ **ëŒ€ì²´ í–‰ë™** ì œì•ˆ(í…ìŠ¤íŠ¸ë§Œ/ì €í•´ìƒë„/Thinking ë‚®ì¶¤).
- EconomyëŠ” **ê±°ë˜ ì¥ë¶€(ledger)** ë¡œ ì¶”ì  ê°€ëŠ¥í•´ì•¼ í•˜ë©° ì”ì•¡ ìŒìˆ˜ëŠ” ê¸ˆì§€ì…ë‹ˆë‹¤.

### 6) ko/en i18n: í˜¼í•© ì¶œë ¥ ê¸ˆì§€

- ê²Œì„/ì‹œìŠ¤í…œ/ë‚´ëŸ¬í‹°ë¸ŒëŠ” `language: "ko-KR" | "en-US"` ê¸°ì¤€ìœ¼ë¡œ ê³ ì • ì¶œë ¥í•©ë‹ˆë‹¤.
- ë¬¸ìì—´ í•˜ë“œì½”ë”© ëŒ€ì‹  i18n ë¦¬ì†ŒìŠ¤ í‚¤ ì‚¬ìš©(ê°€ëŠ¥í•œ ë²”ìœ„ ë‚´).
- í”„ë¡¬í”„íŠ¸ëŠ” ì–¸ì–´ë³„ `.md` íŒŒì¼ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.

### 7) ë³´ì•ˆ: Vertex AI ì„œë¹„ìŠ¤ ê³„ì •, ë¹„ë°€ì •ë³´ ì»¤ë°‹ ê¸ˆì§€

- BYOK(ì‚¬ìš©ì API í‚¤ ì…ë ¥) ìš”êµ¬ ê¸ˆì§€(MVP).
- ì„œë¹„ìŠ¤ ê³„ì • í‚¤/í† í°/ì¿ í‚¤ ë“± ë¹„ë°€ì •ë³´ë¥¼ ë ˆí¬ì— ì €ì¥/ë¡œê·¸ ì¶œë ¥ ê¸ˆì§€.
- í”„ë¡¬í”„íŠ¸ ì¸ì ì…˜ ë°©ì–´: â€œì‚¬ìš©ì ì…ë ¥ì€ ë£°ì´ ì•„ë‹ˆë‹¤â€ë¥¼ ì‹œìŠ¤í…œ ê·œì¹™ìœ¼ë¡œ ê³ ì •í•©ë‹ˆë‹¤.

### 8) ê´€ì¸¡ ê°€ëŠ¥ì„±(Observability) = UXì˜ ì¼ë¶€

- ì—ì´ì „íŠ¸ì˜ â€œê³„íš/ì‹¤í–‰/ê²€ì¦/ë³µêµ¬â€ë¥¼ **UI ë‹¨ê³„/ë°°ì§€/í**ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤.
- ë‹¨, **í”„ë¡¬í”„íŠ¸ ì›ë¬¸/ë‚´ë¶€ ì¶”ë¡ **ì€ ì‚¬ìš©ì UIì— ë…¸ì¶œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

---

## ì‘ì—… í‘œì¤€ (Workflow)

### ì‘ì—… ì‹œì‘ ì „ í•„ìˆ˜

- `vibe/prd.md` + `vibe/tech-stack.md`ë¥¼ ë¨¼ì € ì½ê³ , **ì´ë²ˆ ì‘ì—…ì´ PRDì˜ ì–´ë–¤ ìš”êµ¬ë¥¼ ì¶©ì¡±í•˜ëŠ”ì§€** ëª…ì‹œí•©ë‹ˆë‹¤.
- ë³€ê²½ ë²”ìœ„ë¥¼ íŒŒì¼/ëª¨ë“ˆ ë‹¨ìœ„ë¡œ ì§§ê²Œ ì ê³ (ìµœëŒ€ 5ì¤„), ë¦¬ìŠ¤í¬/ì™„í™”ì±…ì„ í•¨ê»˜ ì œì‹œí•©ë‹ˆë‹¤.

### ìœ ë‹›(ë‹¨ê³„) ê¸°ë°˜ ê°œë°œ

- ìœ ë‹› êµ¬í˜„ ì§€ì‹œì„œëŠ” `vibe/commands/unit-impl.md`(ë˜ëŠ” `.cursor/commands/unit-impl.md`)ì˜ íë¦„ì„ ë”°ë¦…ë‹ˆë‹¤.
- â€œí˜„ì¬ ë‹¨ê³„ ë²”ìœ„â€ ë°–ì˜ êµ¬í˜„/ì•„ì´ë””ì–´ í™•ì¥ì€ ê¸ˆì§€í•©ë‹ˆë‹¤(ìš”ì²­ì´ ì˜¤ë©´ ì§ˆë¬¸ìœ¼ë¡œ ìŠ¹ê²©).
- ê¸°ëŠ¥ êµ¬í˜„ í›„ **ëŸ°ë¶**ì„ ì‘ì„±í•´ ì¬í˜„ ê°€ëŠ¥í•œ ìˆ˜ë™ ê²€ì¦ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë‚¨ê¹ë‹ˆë‹¤.

### ë¬¸ì„œ ë™ê¸°í™”

- êµ¬í˜„ ì™„ë£Œ í›„ ë¬¸ì„œ ë™ê¸°í™”ëŠ” `vibe/commands/doc-update.md` ê¸°ì¤€ìœ¼ë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤.
- Progress/Roadmap/Architecture/PRD/Tech-stack ë¬¸ì„œì˜ ë™ê¸°í™” ê·œì¹™(ìµœì‹  í•­ëª© ìµœìƒë‹¨ ë“±)ì„ ì¤€ìˆ˜í•©ë‹ˆë‹¤.

### ë¦¬íŒ©í† ë§

- ë¦¬íŒ©í† ë§ì€ `vibe/commands/refactor-impl.md` ê¸°ì¤€ìœ¼ë¡œ **Behavior Preservation**ì„ ìµœìš°ì„ í•©ë‹ˆë‹¤.

### í…ŒìŠ¤íŠ¸

- í…ŒìŠ¤íŠ¸ ì‘ì—…ì„ ëª…ì‹œì ìœ¼ë¡œ ìš”ì²­ë°›ì•˜ê±°ë‚˜, `test-exec` íë¦„ì„ ìˆ˜í–‰í•  ë•ŒëŠ” `vibe/commands/test-exec.md`ì˜ ì ˆì°¨(TDD, ì›ì¸ íŒë³„ í”„ë¡œí† ì½œ ë“±)ë¥¼ ë”°ë¦…ë‹ˆë‹¤.
- ê·¸ ì™¸ì˜ ì¼ë°˜ ê¸°ëŠ¥ êµ¬í˜„ì—ì„œëŠ” â€œìë™ í…ŒìŠ¤íŠ¸ ë„ì… ì—¬ë¶€â€ë¥¼ ì¶”ì¸¡í•´ ì¶”ê°€í•˜ì§€ ë§ê³ , ëŸ°ë¶/ë¦¬í”Œë ˆì´ ê¸°ë°˜ ê²€ì¦ì„ ìš°ì„ í•©ë‹ˆë‹¤.

### ì»¤ë°‹ ë©”ì‹œì§€

- ì»¤ë°‹ ë©”ì‹œì§€ëŠ” `.gemini/rules/commit-rules.md` í¬ë§·ì„ ìš°ì„  ì¤€ìˆ˜í•©ë‹ˆë‹¤(í•œê¸€, Progress ë¸”ë¡ í¬í•¨).
- ë‹¨, `vibe/roadmap.md`ê°€ ë¹„ì–´ìˆëŠ” ê²½ìš° Progress ìˆ˜ì¹˜ëŠ” ì„ì˜ë¡œ ë§Œë“¤ì§€ ë§ê³  ë³´ë¥˜/ì§ˆë¬¸í•©ë‹ˆë‹¤.

---

## í’ˆì§ˆ ê¸°ì¤€ (ì¶œì‹œ/ë°ëª¨ ê´€ì )

### Hard Gate (í•„ìˆ˜ í†µê³¼)

- **Schema OK**: TurnOutput JSONì´ ìŠ¤í‚¤ë§ˆë¥¼ í†µê³¼
- **Economy OK**: ë¹„ìš©/ì”ì•¡ ë¶ˆì¼ì¹˜ ì—†ìŒ, ì”ì•¡ ìŒìˆ˜ ê¸ˆì§€
- **Safety OK**: ì°¨ë‹¨ ì‹œ ëª…ì‹œ + ì•ˆì „í•œ ëŒ€ì²´ ê²°ê³¼ ì œê³µ
- **Consistency OK**: WorldState/Rule Board/Memory Pin ì¼ê´€ì„± ìœ ì§€

### Soft Gate (ê´€ì¸¡/íŠœë‹)

- **Streaming TTFB**: 2ì´ˆ ì´ë‚´ ëª©í‘œ(ë°ëª¨ ì²´ê° ìš°ì„ )
- ì´ë¯¸ì§€ ìƒì„±: ì„ íƒì /ì§€ì—° í—ˆìš©(Lazy loading), ì‹¤íŒ¨ ì‹œ í…ìŠ¤íŠ¸ ëŒ€ì²´

---

## ê¸ˆì§€ì‚¬í•­ (ì ˆëŒ€ ê¸ˆì§€)

- âŒ ì±„íŒ… ë²„ë¸”/ë©”ì‹ ì € UXë¡œ íšŒê·€ì‹œí‚¤ëŠ” ë³€ê²½
- âŒ êµ¬ì¡°í™” ì¶œë ¥ ì—†ì´ â€œí…ìŠ¤íŠ¸ë§Œâ€ ë°˜í™˜í•˜ëŠ” API/ë¡œì§(íŠ¹ìˆ˜í•œ ì˜ˆì™¸ë¥¼ ì œì™¸)
- âŒ í”„ë¡¬í”„íŠ¸ ì›ë¬¸/ë‚´ë¶€ ì¶”ë¡ /ë¹„ë°€ì •ë³´ë¥¼ UI ë˜ëŠ” ë¡œê·¸ë¡œ ë…¸ì¶œ
- âŒ ì„œë¹„ìŠ¤ ê³„ì • í‚¤/í† í° ë“± ë¹„ë°€ì •ë³´ë¥¼ ë ˆí¬ì— ì»¤ë°‹
- âŒ `language` ì •ì±…ì„ ë¬´ì‹œí•˜ê³  ko/en í˜¼í•© ì¶œë ¥
- âŒ ì¢Œí‘œ ê·œì•½(0~1000, bbox [ymin,xmin,ymax,xmax])ì„ ê¹¨ëŠ” ë³€ê²½
- âŒ ì¬í™” ì”ì•¡ ìŒìˆ˜/ë¹„ìš© ëˆ„ë½/ì˜ˆìƒë¹„ìš© ë¯¸í‘œê¸°

---

## ì§€ì¹¨ ìš´ì˜/ì‚¬ìš© ê°€ì´ë“œ

### Cursor ê·œì¹™ ì ìš© ë°©ì‹

- `.cursor/rules/*.mdc`ëŠ” **íŒŒì¼ íŒ¨í„´(`applyTo`)**ì— ë”°ë¼ ìë™ ì ìš©ë©ë‹ˆë‹¤.
- ê·œì¹™ì´ ë¶€ì¡±/ì¶©ëŒí•˜ë©´:
  - PRD/Tech-stack ê·¼ê±°ë¥¼ ì²¨ë¶€í•´ ê·œì¹™ì„ ì—…ë°ì´íŠ¸í•˜ê³ ,
  - íŒŒì¼ í•˜ë‚˜ê°€ 500ì¤„ì„ ë„˜ì§€ ì•Šê²Œ ëª¨ë“ˆë¡œ ë¶„ë¦¬í•©ë‹ˆë‹¤.

### ì˜¨ë³´ë”©(ì‹ ê·œ í•©ë¥˜ì/ì—ì´ì „íŠ¸) 10ë¶„ ë£¨í”„

- `vibe/prd.md` 6~9ì¥(ê²Œì„ UI/ê²½ì œ/Autopilot) â†’ â€œì±„íŒ… UI ê¸ˆì§€â€ í•©ì˜
- `vibe/tech-stack.md`(ë²„ì „/ëª¨ë¸ ID ê³ ì •) í™•ì¸
- `vibe/ref/frontend-style-guide.md`ë¡œ CRT í…Œë§ˆ ê·œì¹™ ìˆ™ì§€
- `vibe/ref/structured-outputs-guide.md`ë¡œ JSON Schema ì œì•½ ì´í•´

### ì§€ì¹¨ ì—…ë°ì´íŠ¸ í”„ë¡œì„¸ìŠ¤(ê¶Œì¥)

- ë³€ê²½ í•„ìš” ì‹ í˜¸: ê·œì¹™ ì˜¤í•´/ì¤‘ë³µ/ì¶©ëŒ/500ì¤„ ì´ˆê³¼/6ê°œì›” ë¯¸ì‚¬ìš©
- ì ˆì°¨: ë¬¸ì œ ì¬í˜„ â†’ ì›ì¸(ê·œì¹™ ë¶€ì¬/ëª¨í˜¸í•¨) â†’ ê·œì¹™ ìˆ˜ì •/ë¶„ë¦¬ â†’ PRD/Tech-stackì™€ ì •í•©ì„± í™•ì¸ â†’ ì ìš© ë²”ìœ„(applyTo) ì¢íˆê¸°

---

## ì°¸ì¡° ë¬¸ì„œ

- `vibe/prd.md`
- `vibe/tech-stack.md`
- `vibe/ref/frontend-style-guide.md`
- `vibe/ref/structured-outputs-guide.md`
- `vibe/commands/*.md` / `.cursor/commands/*.md`
- `.gemini/rules/commit-rules.md`
</file>

<file path="frontend/public/ui/manifest.json">
{
  "$schema": "./manifest.schema.json",
  "version": "1.5.0",
  "generatedAt": "2026-02-07T21:00:00Z",
  "totalBytes": 775899,
  "budgetBytes": 1572864,
  "assets": [
    {
      "id": "signal-24",
      "path": "icons/signal-24.png",
      "type": "icon",
      "size": 24,
      "fallback": "âš¡",
      "usedIn": ["EconomyHUD"],
      "bytes": 1573,
      "notes": "U-038: v2 ì¬ìƒì„±, nanobanana mcp(í”½ì…€ì•„íŠ¸), rembg(birefnet-general), ImageMagick ìµœì í™”"
    },
    {
      "id": "signal-16",
      "path": "icons/signal-16.png",
      "type": "icon",
      "size": 16,
      "fallback": "âš¡",
      "usedIn": ["ActionDeck"],
      "bytes": 1012,
      "notes": "U-038: v2 ì¬ìƒì„±, nanobanana mcp(í”½ì…€ì•„íŠ¸), rembg(birefnet-general), ImageMagick ìµœì í™”"
    },
    {
      "id": "shard-24",
      "path": "icons/shard-24.png",
      "type": "icon",
      "size": 24,
      "fallback": "ğŸ’",
      "usedIn": ["EconomyHUD"],
      "bytes": 1362,
      "notes": "U-038: v2 ì¬ìƒì„±, nanobanana mcp(í”½ì…€ì•„íŠ¸), rembg(birefnet-general), ImageMagick ìµœì í™”"
    },
    {
      "id": "shard-16",
      "path": "icons/shard-16.png",
      "type": "icon",
      "size": 16,
      "fallback": "ğŸ’",
      "usedIn": ["ActionDeck"],
      "bytes": 1147,
      "notes": "U-038: shard-24ì—ì„œ ë¦¬ì‚¬ì´ì¦ˆ, 16px ìµœì í™”"
    },
    {
      "id": "badge-ok-24",
      "path": "icons/badge-ok-24.png",
      "type": "icon",
      "size": 24,
      "fallback": "âœ“",
      "usedIn": ["AgentConsole"],
      "bytes": 1461,
      "notes": "U-038: v2 ì¬ìƒì„±, nanobanana mcp(í”½ì…€ì•„íŠ¸), rembg(birefnet-general), ImageMagick ìµœì í™”"
    },
    {
      "id": "badge-ok-16",
      "path": "icons/badge-ok-16.png",
      "type": "icon",
      "size": 16,
      "fallback": "âœ“",
      "usedIn": [],
      "bytes": 1096,
      "notes": "U-038: v2 ì¬ìƒì„±, nanobanana mcp(í”½ì…€ì•„íŠ¸), rembg(birefnet-general), ImageMagick ìµœì í™”"
    },
    {
      "id": "badge-fail-24",
      "path": "icons/badge-fail-24.png",
      "type": "icon",
      "size": 24,
      "fallback": "âœ—",
      "usedIn": ["AgentConsole"],
      "bytes": 2006,
      "notes": "U-038: v2 ì¬ìƒì„±, nanobanana mcp(í”½ì…€ì•„íŠ¸), rembg(birefnet-general), ImageMagick ìµœì í™”"
    },
    {
      "id": "risk-medium-24",
      "path": "icons/risk-medium-24.png",
      "type": "icon",
      "size": 24,
      "fallback": "âš ",
      "usedIn": [],
      "bytes": 1594,
      "notes": "U-038: 24px í˜ì–´ ë³´ê°•, nanobanana mcp ìƒì„±"
    },
    {
      "id": "risk-medium-16",
      "path": "icons/risk-medium-16.png",
      "type": "icon",
      "size": 16,
      "fallback": "âš ",
      "usedIn": ["ActionDeck"],
      "bytes": 1256,
      "notes": "U-038: v2 ì¬ìƒì„±, nanobanana mcp(í”½ì…€ì•„íŠ¸), rembg(birefnet-general), ImageMagick ìµœì í™”"
    },
    {
      "id": "risk-low-24",
      "path": "icons/risk-low-24.png",
      "type": "icon",
      "size": 24,
      "fallback": "âœ“",
      "usedIn": [],
      "bytes": 1838,
      "notes": "U-038: v2 ì¬ìƒì„±, nanobanana mcp(í”½ì…€ì•„íŠ¸), rembg(birefnet-general), ImageMagick ìµœì í™”"
    },
    {
      "id": "risk-low-16",
      "path": "icons/risk-low-16.png",
      "type": "icon",
      "size": 16,
      "fallback": "âœ“",
      "usedIn": ["ActionDeck"],
      "bytes": 1331,
      "notes": "U-038: v2 ì¬ìƒì„±, nanobanana mcp(í”½ì…€ì•„íŠ¸), rembg(birefnet-general), ImageMagick ìµœì í™”"
    },
    {
      "id": "risk-high-24",
      "path": "icons/risk-high-24.png",
      "type": "icon",
      "size": 24,
      "fallback": "âš ",
      "usedIn": [],
      "bytes": 1737,
      "notes": "U-038: v2 ì¬ìƒì„±, nanobanana mcp(í”½ì…€ì•„íŠ¸), rembg(birefnet-general), ImageMagick ìµœì í™”"
    },
    {
      "id": "risk-high-16",
      "path": "icons/risk-high-16.png",
      "type": "icon",
      "size": 16,
      "fallback": "âš ",
      "usedIn": ["ActionDeck"],
      "bytes": 1227,
      "notes": "U-038: v2 ì¬ìƒì„±, nanobanana mcp(í”½ì…€ì•„íŠ¸), rembg(birefnet-general), ImageMagick ìµœì í™”"
    },
    {
      "id": "status-online-16",
      "path": "icons/status-online-16.png",
      "type": "icon",
      "size": 16,
      "fallback": "â—",
      "usedIn": [],
      "bytes": 1375,
      "notes": "U-038: v2 ì¬ìƒì„±, nanobanana mcp(í”½ì…€ì•„íŠ¸), rembg(birefnet-general), ImageMagick ìµœì í™”"
    },
    {
      "id": "scene-placeholder-default",
      "path": "placeholders/scene-placeholder-default.png",
      "type": "placeholder",
      "fallback": "[SCENE]",
      "usedIn": ["SceneCanvas"],
      "bytes": 261407,
      "notes": "nanobanana mcp ìƒì„±, ë ˆíŠ¸ë¡œ í„°ë¯¸ë„ ìŠ¤íƒ€ì¼"
    },
    {
      "id": "scene-loading",
      "path": "placeholders/scene-loading.webp",
      "type": "placeholder",
      "fallback": "â³",
      "usedIn": ["SceneCanvas"],
      "bytes": 47850,
      "notes": "U-031: ë¡œë”© ìƒíƒœ placeholder, nanobanana mcp ìƒì„±, ImageMagick(magick) ìµœì í™”"
    },
    {
      "id": "scene-offline",
      "path": "placeholders/scene-offline.webp",
      "type": "placeholder",
      "fallback": "ğŸ”Œ",
      "usedIn": ["SceneCanvas"],
      "bytes": 44658,
      "notes": "U-031: ì˜¤í”„ë¼ì¸ ìƒíƒœ placeholder, nanobanana mcp ìƒì„±, ImageMagick(magick) ìµœì í™”"
    },
    {
      "id": "scene-blocked",
      "path": "placeholders/scene-blocked.webp",
      "type": "placeholder",
      "fallback": "ğŸš«",
      "usedIn": ["SceneCanvas"],
      "bytes": 17318,
      "notes": "U-031: ì°¨ë‹¨ ìƒíƒœ placeholder, nanobanana mcp ìƒì„±, ImageMagick(magick) ìµœì í™”"
    },
    {
      "id": "scene-low-signal",
      "path": "placeholders/scene-low-signal.webp",
      "type": "placeholder",
      "fallback": "ğŸ“‰",
      "usedIn": ["SceneCanvas"],
      "bytes": 68454,
      "notes": "U-031: ì €ì‹ í˜¸ ìƒíƒœ placeholder, nanobanana mcp ìƒì„±, ImageMagick(magick) ìµœì í™”"
    },
    {
      "id": "panel-corner-br",
      "path": "chrome/panel-corner-br.png",
      "type": "chrome",
      "fallback": "",
      "usedIn": ["PanelHeader"],
      "bytes": 1899,
      "notes": "U-032: íŒ¨ë„ ì½”ë„ˆ ì¥ì‹, nanobanana mcp ìƒì„±, rembg ë°°ê²½ ì œê±°, ImageMagick ìµœì í™”(48x48), CSS transformìœ¼ë¡œ 4ë°©í–¥ ì ìš©"
    },
    {
      "id": "card-frame",
      "path": "chrome/card-frame.png",
      "type": "chrome",
      "fallback": "",
      "usedIn": ["ActionCard"],
      "bytes": 9101,
      "notes": "U-032: ì•¡ì…˜ ì¹´ë“œ í”„ë ˆì„, nanobanana mcp ìƒì„±, rembg ë°°ê²½ ì œê±°, ImageMagick ìµœì í™”(160x80)"
    },
    {
      "id": "scanner-frame",
      "path": "chrome/scanner-frame.png",
      "type": "chrome",
      "fallback": "",
      "usedIn": ["Scanner"],
      "bytes": 100165,
      "notes": "U-032: ìŠ¤ìºë„ˆ ìŠ¬ë¡¯ í”„ë ˆì„, nanobanana mcp ìƒì„±, rembg(birefnet-general) ë°°ê²½ ì œê±°, ImageMagick ìµœì í™”(346x200) ì™„ë£Œ"
    },
    {
      "id": "item-ancient-tome-64",
      "path": "items/ancient-tome-64.png",
      "type": "item-icon",
      "size": 64,
      "fallback": "ğŸ“•",
      "usedIn": ["InventoryPanel"],
      "bytes": 7166,
      "notes": "U-092: Narrator ì´ˆê¸° ì•„ì´í…œ, nanobanana mcp(pixel-art), rembg(birefnet-general), ImageMagick 64x64"
    },
    {
      "id": "item-quill-pen-64",
      "path": "items/quill-pen-64.png",
      "type": "item-icon",
      "size": 64,
      "fallback": "ğŸ–‹ï¸",
      "usedIn": ["InventoryPanel"],
      "bytes": 6474,
      "notes": "U-092: Narrator ì´ˆê¸° ì•„ì´í…œ, nanobanana mcp(pixel-art), rembg(birefnet-general), ImageMagick 64x64"
    },
    {
      "id": "item-memory-fragment-64",
      "path": "items/memory-fragment-64.png",
      "type": "item-icon",
      "size": 64,
      "fallback": "ğŸ’ ",
      "usedIn": ["InventoryPanel"],
      "bytes": 6977,
      "notes": "U-092: Narrator ì´ˆê¸° ì•„ì´í…œ, nanobanana mcp(pixel-art), rembg(birefnet-general), ImageMagick 64x64"
    },
    {
      "id": "item-compass-64",
      "path": "items/compass-64.png",
      "type": "item-icon",
      "size": 64,
      "fallback": "ğŸ§­",
      "usedIn": ["InventoryPanel"],
      "bytes": 9515,
      "notes": "U-092: Explorer ì´ˆê¸° ì•„ì´í…œ, nanobanana mcp(pixel-art), rembg(birefnet-general), ImageMagick 64x64"
    },
    {
      "id": "item-rope-64",
      "path": "items/rope-64.png",
      "type": "item-icon",
      "size": 64,
      "fallback": "ğŸª¢",
      "usedIn": ["InventoryPanel"],
      "bytes": 10713,
      "notes": "U-092: Explorer ì´ˆê¸° ì•„ì´í…œ, nanobanana mcp(pixel-art), rembg(birefnet-general), ImageMagick 64x64"
    },
    {
      "id": "item-lantern-64",
      "path": "items/lantern-64.png",
      "type": "item-icon",
      "size": 64,
      "fallback": "ğŸ®",
      "usedIn": ["InventoryPanel"],
      "bytes": 8054,
      "notes": "U-092: Explorer ì´ˆê¸° ì•„ì´í…œ, nanobanana mcp(pixel-art), rembg(birefnet-general), ImageMagick 64x64"
    },
    {
      "id": "item-map-fragment-64",
      "path": "items/map-fragment-64.png",
      "type": "item-icon",
      "size": 64,
      "fallback": "ğŸ—ºï¸",
      "usedIn": ["InventoryPanel"],
      "bytes": 9705,
      "notes": "U-092: Explorer ì´ˆê¸° ì•„ì´í…œ, nanobanana mcp(pixel-art), rembg(birefnet-general), ImageMagick 64x64"
    },
    {
      "id": "item-data-core-64",
      "path": "items/data-core-64.png",
      "type": "item-icon",
      "size": 64,
      "fallback": "ğŸ’¿",
      "usedIn": ["InventoryPanel"],
      "bytes": 10949,
      "notes": "U-092: Tech ì´ˆê¸° ì•„ì´í…œ, nanobanana mcp(pixel-art), rembg(birefnet-general), ImageMagick 64x64"
    },
    {
      "id": "item-circuit-board-64",
      "path": "items/circuit-board-64.png",
      "type": "item-icon",
      "size": 64,
      "fallback": "ğŸ”Œ",
      "usedIn": ["InventoryPanel"],
      "bytes": 8062,
      "notes": "U-092: Tech ì´ˆê¸° ì•„ì´í…œ, nanobanana mcp(pixel-art), rembg(birefnet-general), ImageMagick 64x64"
    },
    {
      "id": "item-energy-cell-64",
      "path": "items/energy-cell-64.png",
      "type": "item-icon",
      "size": 64,
      "fallback": "ğŸ”‹",
      "usedIn": ["InventoryPanel"],
      "bytes": 7394,
      "notes": "U-092: Tech ì´ˆê¸° ì•„ì´í…œ, nanobanana mcp(pixel-art), rembg(birefnet-general), ImageMagick 64x64"
    },
    {
      "id": "item-scanner-device-64",
      "path": "items/scanner-device-64.png",
      "type": "item-icon",
      "size": 64,
      "fallback": "ğŸ“¡",
      "usedIn": ["InventoryPanel"],
      "bytes": 4436,
      "notes": "U-092: Tech ì´ˆê¸° ì•„ì´í…œ, nanobanana mcp(pixel-art), rembg(birefnet-general), ImageMagick 64x64"
    },
    {
      "id": "item-sword-64",
      "path": "items/sword-64.png",
      "type": "item-icon",
      "size": 64,
      "fallback": "âš”ï¸",
      "usedIn": ["InventoryPanel"],
      "bytes": 5748,
      "notes": "U-092: ê³µí†µ ì•„ì´í…œ, nanobanana mcp(pixel-art), rembg(birefnet-general), ImageMagick 64x64"
    },
    {
      "id": "item-shield-64",
      "path": "items/shield-64.png",
      "type": "item-icon",
      "size": 64,
      "fallback": "ğŸ›¡ï¸",
      "usedIn": ["InventoryPanel"],
      "bytes": 10313,
      "notes": "U-092: ê³µí†µ ì•„ì´í…œ, nanobanana mcp(pixel-art), rembg(birefnet-general), ImageMagick 64x64"
    },
    {
      "id": "item-potion-64",
      "path": "items/potion-64.png",
      "type": "item-icon",
      "size": 64,
      "fallback": "ğŸ§ª",
      "usedIn": ["InventoryPanel"],
      "bytes": 6083,
      "notes": "U-092: ê³µí†µ ì•„ì´í…œ, nanobanana mcp(pixel-art), rembg(birefnet-general), ImageMagick 64x64"
    },
    {
      "id": "item-key-64",
      "path": "items/key-64.png",
      "type": "item-icon",
      "size": 64,
      "fallback": "ğŸ”‘",
      "usedIn": ["InventoryPanel"],
      "bytes": 8703,
      "notes": "U-092: ê³µí†µ ì•„ì´í…œ, nanobanana mcp(pixel-art), rembg(birefnet-general), ImageMagick 64x64"
    },
    {
      "id": "item-gem-64",
      "path": "items/gem-64.png",
      "type": "item-icon",
      "size": 64,
      "fallback": "ğŸ’",
      "usedIn": ["InventoryPanel"],
      "bytes": 6681,
      "notes": "U-092: ê³µí†µ ì•„ì´í…œ, nanobanana mcp(pixel-art), rembg(birefnet-general), ImageMagick 64x64"
    },
    {
      "id": "item-scroll-64",
      "path": "items/scroll-64.png",
      "type": "item-icon",
      "size": 64,
      "fallback": "ğŸ“œ",
      "usedIn": ["InventoryPanel"],
      "bytes": 9741,
      "notes": "U-092: ê³µí†µ ì•„ì´í…œ, nanobanana mcp(pixel-art), rembg(birefnet-general), ImageMagick 64x64"
    },
    {
      "id": "item-torch-64",
      "path": "items/torch-64.png",
      "type": "item-icon",
      "size": 64,
      "fallback": "ğŸ”¥",
      "usedIn": ["InventoryPanel"],
      "bytes": 5029,
      "notes": "U-092: ê³µí†µ ì•„ì´í…œ, nanobanana mcp(pixel-art), rembg(birefnet-general), ImageMagick 64x64"
    },
    {
      "id": "item-herb-64",
      "path": "items/herb-64.png",
      "type": "item-icon",
      "size": 64,
      "fallback": "ğŸŒ¿",
      "usedIn": ["InventoryPanel"],
      "bytes": 7688,
      "notes": "U-092: ê³µí†µ ì•„ì´í…œ, nanobanana mcp(pixel-art), rembg(birefnet-general), ImageMagick 64x64"
    },
    {
      "id": "item-coin-64",
      "path": "items/coin-64.png",
      "type": "item-icon",
      "size": 64,
      "fallback": "ğŸª™",
      "usedIn": ["InventoryPanel"],
      "bytes": 9757,
      "notes": "U-092: ê³µí†µ ì•„ì´í…œ, nanobanana mcp(pixel-art), rembg(birefnet-general), ImageMagick 64x64"
    },
    {
      "id": "item-ring-64",
      "path": "items/ring-64.png",
      "type": "item-icon",
      "size": 64,
      "fallback": "ğŸ’",
      "usedIn": ["InventoryPanel"],
      "bytes": 7854,
      "notes": "U-092: ê³µí†µ ì•„ì´í…œ, nanobanana mcp(pixel-art), rembg(birefnet-general), ImageMagick 64x64"
    },
    {
      "id": "item-amulet-64",
      "path": "items/amulet-64.png",
      "type": "item-icon",
      "size": 64,
      "fallback": "ğŸ”®",
      "usedIn": ["InventoryPanel"],
      "bytes": 8599,
      "notes": "U-092: ê³µí†µ ì•„ì´í…œ, nanobanana mcp(pixel-art), rembg(birefnet-general), ImageMagick 64x64"
    },
    {
      "id": "item-dagger-64",
      "path": "items/dagger-64.png",
      "type": "item-icon",
      "size": 64,
      "fallback": "ğŸ—¡ï¸",
      "usedIn": ["InventoryPanel"],
      "bytes": 6623,
      "notes": "U-092: ê³µí†µ ì•„ì´í…œ, nanobanana mcp(pixel-art), rembg(birefnet-general), ImageMagick 64x64"
    },
    {
      "id": "item-flask-64",
      "path": "items/flask-64.png",
      "type": "item-icon",
      "size": 64,
      "fallback": "âš—ï¸",
      "usedIn": ["InventoryPanel"],
      "bytes": 7141,
      "notes": "U-092: ê³µí†µ ì•„ì´í…œ, nanobanana mcp(pixel-art), rembg(birefnet-general), ImageMagick 64x64"
    },
    {
      "id": "item-crystal-64",
      "path": "items/crystal-64.png",
      "type": "item-icon",
      "size": 64,
      "fallback": "ğŸ”·",
      "usedIn": ["InventoryPanel"],
      "bytes": 9259,
      "notes": "U-092: ê³µí†µ ì•„ì´í…œ, nanobanana mcp(pixel-art), rembg(birefnet-general), ImageMagick 64x64"
    },
    {
      "id": "item-lockpick-64",
      "path": "items/lockpick-64.png",
      "type": "item-icon",
      "size": 64,
      "fallback": "ğŸ”§",
      "usedIn": ["InventoryPanel"],
      "bytes": 6368,
      "notes": "U-092: ê³µí†µ ì•„ì´í…œ, nanobanana mcp(pixel-art), rembg(birefnet-general), ImageMagick 64x64"
    }
  ]
}
</file>

<file path="frontend/public/ui/manifest.schema.json">
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://unknown-world.dev/schemas/ui-asset-manifest.json",
  "title": "UI Asset Manifest",
  "description": "nanobanana mcpë¡œ ì œì‘ëœ UI ì—ì…‹ì˜ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìŠ¤í‚¤ë§ˆ",
  "type": "object",
  "required": ["version", "assets"],
  "additionalProperties": false,
  "properties": {
    "$schema": {
      "type": "string",
      "description": "JSON Schema ì°¸ì¡°"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë²„ì „ (SemVer)",
      "examples": ["1.0.0"]
    },
    "generatedAt": {
      "type": "string",
      "format": "date-time",
      "description": "ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„± ì‹œê° (ISO 8601)"
    },
    "totalBytes": {
      "type": "integer",
      "minimum": 0,
      "description": "ëª¨ë“  ì—ì…‹ì˜ ì´ ë°”ì´íŠ¸ ìˆ˜"
    },
    "budgetBytes": {
      "type": "integer",
      "minimum": 0,
      "default": 1572864,
      "description": "ì„±ëŠ¥ ì˜ˆì‚° ìƒí•œ (ê¸°ë³¸: 1.5MB = 1572864 bytes)"
    },
    "assets": {
      "type": "array",
      "description": "ì—ì…‹ ëª©ë¡",
      "items": {
        "$ref": "#/$defs/Asset"
      }
    }
  },
  "$defs": {
    "Asset": {
      "type": "object",
      "required": ["id", "path", "type"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z0-9]+(-[a-z0-9]+)*$",
          "description": "ì—ì…‹ ê³ ìœ  ID (kebab-case)",
          "examples": ["signal-24", "badge-ok-16", "scene-loading"]
        },
        "path": {
          "type": "string",
          "pattern": "^[a-z0-9-/]+\\.(png|webp|svg)$",
          "description": "ui/ ë””ë ‰í† ë¦¬ ê¸°ì¤€ ìƒëŒ€ ê²½ë¡œ",
          "examples": ["icons/signal-24.png", "placeholders/scene-loading.webp"]
        },
        "type": {
          "type": "string",
          "enum": ["icon", "placeholder", "chrome", "item-icon"],
          "description": "ì—ì…‹ ìœ í˜•"
        },
        "size": {
          "type": "integer",
          "enum": [16, 24, 32, 64, 128, 256, 512],
          "description": "í”½ì…€ ì‚¬ì´ì¦ˆ (ì•„ì´ì½˜ìš©)"
        },
        "width": {
          "type": "integer",
          "minimum": 1,
          "description": "ê°€ë¡œ í”½ì…€ (placeholder/chromeìš©)"
        },
        "height": {
          "type": "integer",
          "minimum": 1,
          "description": "ì„¸ë¡œ í”½ì…€ (placeholder/chromeìš©)"
        },
        "fallback": {
          "type": "string",
          "maxLength": 10,
          "description": "ë¡œë”© ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ ì´ëª¨ì§€/í…ìŠ¤íŠ¸",
          "examples": ["ğŸ“¡", "âš ï¸", "OK"]
        },
        "usedIn": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "ì‚¬ìš©ì²˜ ì»´í¬ë„ŒíŠ¸ ëª©ë¡",
          "examples": [["EconomyHUD", "AgentConsole"]]
        },
        "bytes": {
          "type": "integer",
          "minimum": 0,
          "description": "íŒŒì¼ í¬ê¸° (bytes)"
        },
        "format": {
          "type": "string",
          "enum": ["png", "webp", "svg"],
          "description": "íŒŒì¼ í¬ë§·"
        },
        "retina": {
          "type": "boolean",
          "default": false,
          "description": "@2x Retina ë²„ì „ ì¡´ì¬ ì—¬ë¶€"
        },
        "description": {
          "type": "string",
          "maxLength": 200,
          "description": "ì—ì…‹ ì„¤ëª…"
        },
        "createdAt": {
          "type": "string",
          "format": "date-time",
          "description": "ìƒì„± ì‹œê° (ISO 8601)"
        },
        "promptHash": {
          "type": "string",
          "pattern": "^[a-f0-9]{8}$",
          "description": "ìƒì„± í”„ë¡¬í”„íŠ¸ í•´ì‹œ (ì¬í˜„ì„±, 8ì)"
        },
        "notes": {
          "type": "string",
          "maxLength": 500,
          "description": "ì—ì…‹ ê´€ë ¨ ë©”ëª¨ (ìƒì„± ë„êµ¬, ë°°ê²½ ì œê±°, ìµœì í™” ë“± QA ê´€ë ¨ ê¸°ë¡)"
        }
      }
    }
  }
}
</file>

<file path="frontend/src/api/turnStream.test.ts">
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { NDJSONParser } from './turnStream';

describe('NDJSONParser', () => {
  let parser: NDJSONParser;

  beforeEach(() => {
    parser = new NDJSONParser();
  });

  it('should parse a single complete line', () => {
    const chunk = JSON.stringify({ type: 'test', value: 1 }) + '\n';
    const results = parser.parse(chunk);
    expect(results).toHaveLength(1);
    expect(results[0]).toEqual({ type: 'test', value: 1 });
  });

  it('should parse multiple complete lines in one chunk', () => {
    const chunk = JSON.stringify({ id: 1 }) + '\n' + JSON.stringify({ id: 2 }) + '\n';
    const results = parser.parse(chunk);
    expect(results).toHaveLength(2);
    expect(results[0]).toEqual({ id: 1 });
    expect(results[1]).toEqual({ id: 2 });
  });

  it('should buffer partial lines and parse them when completed', () => {
    const chunk1 = '{"id": 1';
    const chunk2 = ', "val": "ok"}\n';

    const results1 = parser.parse(chunk1);
    expect(results1).toHaveLength(0);

    const results2 = parser.parse(chunk2);
    expect(results2).toHaveLength(1);
    expect(results2[0]).toEqual({ id: 1, val: 'ok' });
  });

  it('should ignore empty lines', () => {
    const chunk = '\n\n{"a":1}\n\n';
    const results = parser.parse(chunk);
    expect(results).toHaveLength(1);
  });

  it('should not crash on invalid JSON and continue', () => {
    const consoleSpy = vi.spyOn(console, 'warn').mockImplementation(() => {});
    const chunk = 'invalid json\n{"valid": true}\n';
    const results = parser.parse(chunk);

    expect(results).toHaveLength(1);
    expect(results[0]).toEqual({ valid: true });
    expect(consoleSpy).toHaveBeenCalled();
    consoleSpy.mockRestore();
  });

  it('should flush remaining buffer', () => {
    parser.parse('{"id": 1}'); // No newline
    const result = parser.flush();
    expect(result).toEqual({ id: 1 });
  });

  it('should return null on flush with empty buffer', () => {
    const result = parser.flush();
    expect(result).toBeNull();
  });
});

describe('executeTurnStream', () => {
  const mockInput = {
    language: 'ko-KR' as const,
    text: 'Hello',
    action_id: null,
    click: null,
    drop: null, // U-012: ë“œë¡­ ì…ë ¥ í•„ë“œ ì¶”ê°€
    client: { viewport_w: 100, viewport_h: 100, theme: 'dark' as const },
    economy_snapshot: { signal: 100, memory_shard: 0 },
    previous_image_url: null,
  };

  const mockCallbacks = {
    onStage: vi.fn(),
    onRepair: vi.fn(),
    onBadges: vi.fn(),
    onNarrativeDelta: vi.fn(),
    onFinal: vi.fn(),
    onError: vi.fn(),
    onComplete: vi.fn(),
  };

  beforeEach(() => {
    vi.clearAllMocks();
    global.fetch = vi.fn();
  });

  it('should process stream events correctly (including repair)', async () => {
    const encoder = new TextEncoder();
    const stream = new ReadableStream({
      start(controller) {
        controller.enqueue(
          encoder.encode(JSON.stringify({ type: 'stage', name: 'parse', status: 'start' }) + '\n'),
        );
        controller.enqueue(
          encoder.encode(
            JSON.stringify({ type: 'repair', attempt: 1, message: 'Schema fail, retrying' }) + '\n',
          ),
        );
        controller.enqueue(
          encoder.encode(JSON.stringify({ type: 'narrative_delta', text: 'Hello' }) + '\n'),
        );
        controller.enqueue(
          encoder.encode(
            JSON.stringify({
              type: 'final',
              data: {
                language: 'ko-KR',
                narrative: 'Hello',
                economy: {
                  cost: { signal: 0, memory_shard: 0 },
                  balance_after: { signal: 100, memory_shard: 0 },
                },
                safety: { blocked: false },
              },
            }) + '\n',
          ),
        );
        controller.close();
      },
    });

    (global.fetch as unknown as ReturnType<typeof vi.fn>).mockResolvedValue({
      ok: true,
      body: stream,
    });

    const { executeTurnStream } = await import('./turnStream');
    await executeTurnStream(mockInput, mockCallbacks);

    expect(mockCallbacks.onStage).toHaveBeenCalledWith(expect.objectContaining({ name: 'parse' }));
    expect(mockCallbacks.onRepair).toHaveBeenCalledWith(
      expect.objectContaining({ attempt: 1, message: 'Schema fail, retrying' }),
    );
    expect(mockCallbacks.onNarrativeDelta).toHaveBeenCalledWith(
      expect.objectContaining({ text: 'Hello' }),
    );
    expect(mockCallbacks.onFinal).toHaveBeenCalled();
    expect(mockCallbacks.onComplete).toHaveBeenCalled();
  });

  it('should handle HTTP errors', async () => {
    (global.fetch as unknown as ReturnType<typeof vi.fn>).mockResolvedValue({
      ok: false,
      status: 500,
      statusText: 'Internal Server Error',
    });

    const { executeTurnStream } = await import('./turnStream');
    await executeTurnStream(mockInput, mockCallbacks);

    expect(mockCallbacks.onError).toHaveBeenCalledWith(
      expect.objectContaining({
        code: 'STREAM_ERROR',
        message: expect.stringContaining('500'),
      }),
    );
  });

  it('should handle fetch rejection', async () => {
    (global.fetch as unknown as ReturnType<typeof vi.fn>).mockRejectedValue(
      new Error('Network failure'),
    );

    const { executeTurnStream } = await import('./turnStream');
    await executeTurnStream(mockInput, mockCallbacks);

    expect(mockCallbacks.onError).toHaveBeenCalledWith(
      expect.objectContaining({
        message: 'Network failure',
      }),
    );
  });
});
</file>

<file path="frontend/src/App.inputLock.test.tsx">
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen, fireEvent, waitFor, act } from '@testing-library/react';
import App from './App';
import * as turnStream from './api/turnStream';
import { useWorldStore } from './stores/worldStore';
import { useAgentStore } from './stores/agentStore';

// i18next ëª¨í‚¹
vi.mock('react-i18next', () => ({
  useTranslation: () => ({
    t: (key: string) => key,
    i18n: {
      changeLanguage: () => Promise.resolve(),
      resolvedLanguage: 'ko-KR',
    },
  }),
  initReactI18next: {
    type: '3rdParty',
    init: () => {},
  },
}));

// ResizeObserver ëª¨í‚¹
class MockResizeObserver {
  observe = vi.fn();
  unobserve = vi.fn();
  disconnect = vi.fn();
}
global.ResizeObserver = MockResizeObserver as unknown as typeof ResizeObserver;

// api ëª¨í‚¹
vi.mock('./api/turnStream', () => ({
  startTurnStream: vi.fn(),
}));

describe('App - U-087 Input Locking Integration', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    localStorage.clear();
    useWorldStore.getState().reset();
    useAgentStore.getState().reset();

    // getBoundingClientRect ëª¨í‚¹
    Element.prototype.getBoundingClientRect = vi.fn(() => ({
      width: 800,
      height: 600,
      top: 0,
      left: 0,
      bottom: 600,
      right: 800,
      x: 0,
      y: 0,
      toJSON: () => {},
    })) as unknown as () => DOMRect;
  });

  const selectProfileAndStart = async () => {
    render(<App />);
    const techProfile = screen.getByLabelText('profile.tech.name');
    fireEvent.click(techProfile);

    await waitFor(() => {
      expect(screen.getByText('panel.agent_console.title')).toBeInTheDocument();
    });
  };

  it('prevents interaction when isStreaming is true', async () => {
    await selectProfileAndStart();

    // 1. ìŠ¤íŠ¸ë¦¬ë° ìƒíƒœ ì‹œì‘
    await act(async () => {
      useAgentStore.getState().startStream();
    });

    // 2. ì…ë ¥ ì ê¸ˆ ì‹œê°ì  í”¼ë“œë°± í™•ì¸ (placeholder)
    await waitFor(
      () => {
        const input = screen.getByRole('textbox') as HTMLInputElement;
        expect(input.placeholder).toBe('ui.input_locked');
        expect(input.disabled).toBe(true);
      },
      { timeout: 2000 },
    );

    // 3. ì¹´ë“œ í´ë¦­ ì‹œë„
    const cards = screen.getAllByRole('button', { name: /action.default/ });
    if (cards.length > 0) {
      fireEvent.click(cards[0]);
    }

    // 4. ê²€ì¦: í„´ ì‹¤í–‰ ë° ì•¡ì…˜ ë¡œê·¸ ìƒì„± ì°¨ë‹¨
    expect(turnStream.startTurnStream).not.toHaveBeenCalled();
    const entries = useWorldStore.getState().narrativeEntries;
    expect(entries.filter((e) => e.type === 'action_log')).toHaveLength(0);
  });

  it('prevents interaction when processingPhase is not idle', async () => {
    await selectProfileAndStart();

    // 1. ì²˜ë¦¬ ë‹¨ê³„ ì„¤ì •
    await act(async () => {
      useWorldStore.getState().setProcessingPhase('processing');
    });

    // 2. UI ìƒíƒœ í™•ì¸ (ì œì¶œ ë²„íŠ¼ í…ìŠ¤íŠ¸)
    await waitFor(() => {
      expect(screen.getByRole('button', { name: 'ui.wait' })).toBeInTheDocument();
    });

    // 3. ì»¤ë§¨ë“œ ì œì¶œ ì‹œë„
    const submitBtn = screen.getByRole('button', { name: 'ui.wait' });
    fireEvent.click(submitBtn);

    // 4. ê²€ì¦
    expect(turnStream.startTurnStream).not.toHaveBeenCalled();
  });

  it('prevents interaction when imageLoading is true', async () => {
    await selectProfileAndStart();

    // 1. ì´ë¯¸ì§€ ë¡œë”© ìƒíƒœ ì„¤ì •
    await act(async () => {
      useWorldStore.getState().setImageLoading(1);
    });

    // 2. ì…ë ¥ ì ê¸ˆ í™•ì¸ (placeholder ë° disabled)
    await waitFor(() => {
      const input = screen.getByRole('textbox') as HTMLInputElement;
      expect(input.placeholder).toBe('ui.input_locked');
      expect(input.disabled).toBe(true);

      const submitBtn = screen.getByRole('button', { name: 'ui.wait' });
      expect(submitBtn).toBeDisabled();
    });

    // 3. ê²€ì¦ (ì•¡ì…˜ ë¡œê·¸ ìƒì„± ì°¨ë‹¨)
    const entries = useWorldStore.getState().narrativeEntries;
    expect(entries.filter((e) => e.type === 'action_log')).toHaveLength(0);
  });
});
</file>

<file path="frontend/src/components/EconomyHud.i18n.test.tsx">
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { render, screen } from '@testing-library/react';
import { EconomyHud } from './EconomyHud';
import { useEconomyStore } from '../stores/economyStore';
import { useWorldStore } from '../stores/worldStore';

// react-i18next ëª¨í‚¹
vi.mock('react-i18next', () => ({
  useTranslation: () => ({
    // t í•¨ìˆ˜ê°€ í˜¸ì¶œë¨ì„ ê²€ì¦í•˜ê¸° ìœ„í•´ í‚¤ë¥¼ ë³€í˜•í•˜ì—¬ ë°˜í™˜
    t: (key: string) => `translated_${key}`,
  }),
  initReactI18next: {
    type: '3rdParty',
    init: () => {},
  },
}));

describe('EconomyHud i18n ì •í•©ì„± í…ŒìŠ¤íŠ¸ (U-099)', () => {
  beforeEach(() => {
    useEconomyStore.getState().reset();
    useWorldStore.getState().reset();
    useEconomyStore.getState().clearLedger();
  });

  it('ê±°ë˜ ì¥ë¶€ì˜ í•­ëª©ì´ t í•¨ìˆ˜ë¥¼ í†µí•´ ë²ˆì—­ë˜ì–´ í‘œì‹œë˜ì–´ì•¼ í•œë‹¤', () => {
    const { addLedgerEntry } = useEconomyStore.getState();

    // 1. ì¼ë°˜ í‚¤ ì¶”ê°€
    addLedgerEntry({
      turnId: 1,
      reason: 'economy.ledger_reason.turn_cost',
      cost: { signal: 10, memory_shard: 0 },
      balanceAfter: { signal: 90, memory_shard: 5 },
      modelLabel: 'FAST',
    });

    // 2. íŒŒë¼ë¯¸í„° í¬í•¨ í‚¤ ì¶”ê°€ (key|param)
    addLedgerEntry({
      turnId: 2,
      reason: 'inventory.sell_ledger_reason|Ancient Tome',
      cost: { signal: -50, memory_shard: 0 },
      balanceAfter: { signal: 140, memory_shard: 5 },
      modelLabel: 'FAST',
    });

    render(<EconomyHud />);

    // ì¼ë°˜ í‚¤ ë²ˆì—­ í™•ì¸
    expect(screen.getByText('translated_economy.ledger_reason.turn_cost')).toBeInTheDocument();

    // íŒŒë¼ë¯¸í„° í¬í•¨ í‚¤ ë²ˆì—­ í™•ì¸
    // "translated_inventory.sell_ledger_reason: Ancient Tome" í˜•ì‹ì´ ë˜ì–´ì•¼ í•¨
    expect(
      screen.getByText('translated_inventory.sell_ledger_reason: Ancient Tome'),
    ).toBeInTheDocument();
  });
});
</file>

<file path="frontend/src/components/GameHeader.tsx">
import type { ReactNode } from 'react';
import { useTranslation } from 'react-i18next';
import { UIControls } from './UIControls';
import { EconomyHudHeader } from './EconomyHud';
import type { UIScale } from '../stores/uiPrefsStore';
import { useEconomyStore, selectIsBalanceLow } from '../stores/economyStore';

interface GameHeaderProps {
  signal: number;
  memoryShard: number;
  credit: number;
  isConnected: boolean;
  uiScale: UIScale;
  onIncreaseScale: () => void;
  onDecreaseScale: () => void;
  /** U-015: ì¶”ê°€ ì»¨íŠ¸ë¡¤ (ë¦¬ì…‹/í”„ë¡œí•„ ë³€ê²½ ë²„íŠ¼ ë“±) */
  children?: ReactNode;
}

export function GameHeader({
  signal,
  memoryShard,
  credit,
  isConnected,
  uiScale,
  onIncreaseScale,
  onDecreaseScale,
  children,
}: GameHeaderProps) {
  const { t } = useTranslation();
  const isBalanceLow = useEconomyStore(selectIsBalanceLow);

  return (
    <header className="game-header has-chrome">
      <h1 className="game-title glitch" data-text={t('ui.logo')}>
        {t('ui.logo')}
      </h1>
      <div className="header-controls">
        {/* U-015: ë¦¬ì…‹/í”„ë¡œí•„ ë³€ê²½ ë“± ì¶”ê°€ ì»¨íŠ¸ë¡¤ */}
        {children}
        {/* UI ìŠ¤ì¼€ì¼ ì»¨íŠ¸ë¡¤ (U-028â†’U-037: Readable ì œê±°) */}
        <UIControls
          uiScale={uiScale}
          onIncreaseScale={onIncreaseScale}
          onDecreaseScale={onDecreaseScale}
        />
        {/* Economy HUD (U-014: ì˜ˆìƒ ë¹„ìš©/í™•ì • ë¹„ìš© í‘œì‹œ í¬í•¨) */}
        <EconomyHudHeader
          signal={signal}
          memoryShard={memoryShard}
          credit={credit}
          isLow={isBalanceLow}
        />
        <div className="connection-status">
          <span className={`status-indicator ${isConnected ? '' : 'offline'}`} />
          <span>{isConnected ? t('connection.online') : t('connection.offline')}</span>
        </div>
      </div>
    </header>
  );
}
</file>

<file path="frontend/src/components/InteractionHint.test.tsx">
import { describe, it, expect } from 'vitest';
import { render, screen } from '@testing-library/react';
import { InteractionHint } from './InteractionHint';

describe('InteractionHint', () => {
  it('ì „ë‹¬ëœ í…ìŠ¤íŠ¸ë¥¼ ì˜¬ë°”ë¥´ê²Œ ë Œë”ë§í•´ì•¼ í•œë‹¤', () => {
    const testText = 'í…ŒìŠ¤íŠ¸ íŒíŠ¸ í…ìŠ¤íŠ¸';
    render(<InteractionHint text={testText} />);

    expect(screen.getByText(testText)).toBeInTheDocument();
  });

  it('ì•„ì´ì½˜ íƒ€ì…ì— ë”°ë¼ ì ì ˆí•œ aria-hidden SVGë¥¼ í¬í•¨í•´ì•¼ í•œë‹¤', () => {
    const { container } = render(<InteractionHint text="í´ë¦­" icon="click" />);

    const svg = container.querySelector('svg');
    expect(svg).toBeInTheDocument();
    expect(svg).toHaveAttribute('aria-hidden', 'true');
    expect(container.querySelector('.interaction-hint-icon')).toBeInTheDocument();
  });

  it('ìœ„ì¹˜ propsì— ë”°ë¼ ì ì ˆí•œ í´ë˜ìŠ¤ë¥¼ ê°€ì ¸ì•¼ í•œë‹¤', () => {
    const { container: topContainer } = render(<InteractionHint text="ìœ„" position="top" />);
    expect(topContainer.firstChild).toHaveClass('interaction-hint--top');

    const { container: bottomContainer } = render(
      <InteractionHint text="ì•„ë˜" position="bottom" />,
    );
    expect(bottomContainer.firstChild).toHaveClass('interaction-hint--bottom');
  });

  it('aria-labelì´ ì„¤ì •ë˜ì–´ì•¼ í•œë‹¤', () => {
    render(<InteractionHint text="ì¡°ì‚¬í•˜ê¸°" ariaLabel="ì»¤ìŠ¤í…€ ë¼ë²¨" />);
    expect(screen.getByRole('tooltip')).toHaveAttribute('aria-label', 'ì»¤ìŠ¤í…€ ë¼ë²¨');
  });
});
</file>

<file path="frontend/src/components/InteractionHint.tsx">
/**
 * Unknown World - ì¸í„°ë™ì…˜ íŒíŠ¸ ì»´í¬ë„ŒíŠ¸
 *
 * U-074[Mvp]: í•«ìŠ¤íŒŸ/ì•„ì´í…œ ì¸í„°ë™ì…˜ ì•ˆë‚´ UX
 * - ì¬ì‚¬ìš© ê°€ëŠ¥í•œ íŒíŠ¸ íˆ´íŒ ì»´í¬ë„ŒíŠ¸
 * - í´ë¦­/ë“œë˜ê·¸/ë“œë¡­ ì•„ì´ì½˜ + í…ìŠ¤íŠ¸ í‘œì‹œ
 * - Q1 Option B: ì²« Në²ˆë§Œ í‘œì‹œ í›„ ìˆ¨ê¹€
 *
 * RULE-006 ì¤€ìˆ˜: i18n í‚¤ ê¸°ë°˜ í…ìŠ¤íŠ¸
 * RULE-002 ì¤€ìˆ˜: ì±„íŒ… UIê°€ ì•„ë‹Œ ê²Œì„ UI
 *
 * @module components/InteractionHint
 */

import { memo } from 'react';
import '../styles/interaction-hint.css';

// =============================================================================
// íƒ€ì… ì •ì˜
// =============================================================================

export type HintIconType = 'click' | 'drag' | 'drop' | 'scanner';
export type HintPosition = 'top' | 'bottom' | 'left' | 'right';

interface InteractionHintProps {
  /** íŒíŠ¸ í…ìŠ¤íŠ¸ (i18n ì²˜ë¦¬ëœ ë¬¸ìì—´) */
  text: string;

  /** ì•„ì´ì½˜ íƒ€ì… */
  icon?: HintIconType;

  /** íŒíŠ¸ ìœ„ì¹˜ */
  position?: HintPosition;

  /** ì¶”ê°€ CSS í´ë˜ìŠ¤ */
  className?: string;

  /** ì ‘ê·¼ì„±: aria-label ì˜¤ë²„ë¼ì´ë“œ */
  ariaLabel?: string;
}

// =============================================================================
// ì•„ì´ì½˜ ì»´í¬ë„ŒíŠ¸
// =============================================================================

/**
 * íŒíŠ¸ ì•„ì´ì½˜ SVG
 *
 * ê°„ë‹¨í•œ ì¸ë¼ì¸ SVGë¡œ ì•„ì´ì½˜ì„ í‘œí˜„í•©ë‹ˆë‹¤.
 * ì™¸ë¶€ ì´ë¯¸ì§€ ì—ì…‹ ì—†ì´ ìˆœìˆ˜ CSS/SVGë¡œ êµ¬í˜„.
 */
function HintIcon({ type }: { type: HintIconType }) {
  switch (type) {
    case 'click':
      // ë§ˆìš°ìŠ¤ í´ë¦­ ì•„ì´ì½˜ (ê°„ë‹¨í•œ í¬ì¸í„°)
      return (
        <svg
          className="interaction-hint-icon"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
          aria-hidden="true"
        >
          {/* ë§ˆìš°ìŠ¤ í¬ì¸í„° ëª¨ì–‘ */}
          <path d="M4 4l7.07 17 2.51-7.39L21 11.07z" />
          <line x1="13.5" y1="13.5" x2="19" y2="19" />
        </svg>
      );

    case 'drag':
      // ë“œë˜ê·¸ ì•„ì´ì½˜ (ì† + í™”ì‚´í‘œ)
      return (
        <svg
          className="interaction-hint-icon"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
          aria-hidden="true"
        >
          {/* ì† ëª¨ì–‘ */}
          <path d="M18 11V6a2 2 0 0 0-4 0v5" />
          <path d="M14 10V4a2 2 0 0 0-4 0v6" />
          <path d="M10 10.5V6a2 2 0 0 0-4 0v8" />
          <path d="M18 8a2 2 0 0 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15" />
        </svg>
      );

    case 'drop':
      // ë“œë¡­ ì•„ì´ì½˜ (ë‹¤ìš´ í™”ì‚´í‘œ + ë°•ìŠ¤)
      return (
        <svg
          className="interaction-hint-icon"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
          aria-hidden="true"
        >
          {/* ë°•ìŠ¤ */}
          <rect x="3" y="11" width="18" height="10" rx="2" />
          {/* ë‹¤ìš´ í™”ì‚´í‘œ */}
          <path d="M12 3v8" />
          <path d="M8 7l4 4 4-4" />
        </svg>
      );

    case 'scanner':
      // ìŠ¤ìºë„ˆ ì•„ì´ì½˜ (ì¹´ë©”ë¼/ì—…ë¡œë“œ)
      return (
        <svg
          className="interaction-hint-icon"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
          aria-hidden="true"
        >
          {/* ì—…ë¡œë“œ ì•„ì´ì½˜ */}
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
          <polyline points="17 8 12 3 7 8" />
          <line x1="12" y1="3" x2="12" y2="15" />
        </svg>
      );

    default:
      return null;
  }
}

// =============================================================================
// ë©”ì¸ ì»´í¬ë„ŒíŠ¸
// =============================================================================

/**
 * ì¸í„°ë™ì…˜ íŒíŠ¸ ì»´í¬ë„ŒíŠ¸
 *
 * í•«ìŠ¤íŒŸ/ì•„ì´í…œ ìœ„ì— í‘œì‹œë˜ëŠ” ì‘ì€ íˆ´íŒ í˜•íƒœì˜ íŒíŠ¸ì…ë‹ˆë‹¤.
 * U-074[Mvp] Q1 Option Bì— ë”°ë¼ ì²« Në²ˆë§Œ í‘œì‹œë©ë‹ˆë‹¤.
 *
 * @example
 * ```tsx
 * <InteractionHint
 *   text={t('interaction.hotspot_click')}
 *   icon="click"
 *   position="top"
 * />
 * ```
 */
function InteractionHintComponent({
  text,
  icon,
  position = 'top',
  className = '',
  ariaLabel,
}: InteractionHintProps) {
  const positionClass = `interaction-hint--${position}`;

  return (
    <div
      className={`interaction-hint ${positionClass} ${className}`.trim()}
      role="tooltip"
      aria-label={ariaLabel ?? text}
    >
      <div className="interaction-hint-content">
        {icon && <HintIcon type={icon} />}
        <span className="interaction-hint-text">{text}</span>
      </div>
    </div>
  );
}

/**
 * Memoized ì¸í„°ë™ì…˜ íŒíŠ¸ ì»´í¬ë„ŒíŠ¸
 *
 * ë¹ˆë²ˆí•œ í˜¸ë²„ ì´ë²¤íŠ¸ì—ì„œ ë¶ˆí•„ìš”í•œ ë¦¬ë Œë”ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.
 */
export const InteractionHint = memo(InteractionHintComponent);

InteractionHint.displayName = 'InteractionHint';

// Re-export types
export type { InteractionHintProps };
</file>

<file path="frontend/src/components/MutationTimeline.test.tsx">
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { render, screen } from '@testing-library/react';
import { MutationTimeline } from './MutationTimeline';
import { useWorldStore } from '../stores/worldStore';

vi.mock('react-i18next', () => ({
  useTranslation: () => ({
    t: (key: string, options?: Record<string, unknown>) => {
      if (options?.turn !== undefined) return `T${options.turn}`;
      if (options?.count !== undefined) return `${key} (count: ${options.count})`;
      return key;
    },
  }),
  initReactI18next: {
    type: '3rdParty',
    init: () => {},
  },
}));

describe('MutationTimeline (U-013)', () => {
  beforeEach(() => {
    useWorldStore.getState().reset();
  });

  it('ë³€í˜• ì´ë ¥ì´ ì—†ì„ ë•Œ ë¹ˆ ìƒíƒœë¥¼ í‘œì‹œí•´ì•¼ í•œë‹¤', () => {
    render(<MutationTimeline />);
    expect(screen.getByText('mutation.empty')).toBeInTheDocument();
  });

  it('ë³€í˜• ì´ë²¤íŠ¸ ëª©ë¡ì„ ìµœì‹ ìˆœìœ¼ë¡œ í‘œì‹œí•´ì•¼ í•œë‹¤', () => {
    useWorldStore.setState({
      mutationTimeline: [
        {
          turn: 2,
          ruleId: 'r2',
          type: 'modified',
          label: 'ìˆ˜ì •ëœ ê·œì¹™',
          timestamp: Date.now(),
        },
        {
          turn: 1,
          ruleId: 'r1',
          type: 'added',
          label: 'ìƒˆ ê·œì¹™',
          timestamp: Date.now() - 1000,
        },
      ],
    });

    render(<MutationTimeline />);
    expect(screen.getByText('mutation.timeline_title')).toBeInTheDocument();
    expect(screen.getAllByText('T2')).toHaveLength(1);
    expect(screen.getByText('ìˆ˜ì •ëœ ê·œì¹™')).toBeInTheDocument();
    expect(screen.getByText('mutation.type.modified')).toBeInTheDocument();

    expect(screen.getAllByText('T1')).toHaveLength(1);
    expect(screen.getByText('ìƒˆ ê·œì¹™')).toBeInTheDocument();
    expect(screen.getByText('mutation.type.added')).toBeInTheDocument();
  });

  it('ì´ë²¤íŠ¸ê°€ ë§ì„ ë•Œ "ë” ë³´ê¸°" í‘œì‹œë¥¼ í•´ì•¼ í•œë‹¤ (ìµœëŒ€ 10ê°œ ê¸°ì¤€)', () => {
    const manyEvents = Array.from({ length: 12 }, (_, i) => ({
      turn: i + 1,
      ruleId: `r${i}`,
      type: 'added' as const,
      label: `ê·œì¹™ ${i}`,
      timestamp: Date.now(),
    })).reverse(); // ìµœì‹ ìˆœ

    useWorldStore.setState({ mutationTimeline: manyEvents });

    const { container } = render(<MutationTimeline />);
    // 10ê°œë§Œ ë Œë”ë§ë¨
    expect(container.getElementsByClassName('timeline-event')).toHaveLength(10);
    // +2ê°œ ë” ë³´ê¸° í‘œì‹œ
    expect(screen.getByText('mutation.more_events (count: 2)')).toBeInTheDocument();
  });
});
</file>

<file path="frontend/src/components/ObjectiveTracker.test.tsx">
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { render, screen } from '@testing-library/react';
import { ObjectiveTracker } from './ObjectiveTracker';
import { useWorldStore } from '../stores/worldStore';

// i18next ëª¨í‚¹
vi.mock('react-i18next', () => ({
  useTranslation: () => ({
    t: (key: string) => key,
  }),
  initReactI18next: {
    type: '3rdParty',
    init: () => {},
  },
}));

describe('ObjectiveTracker (U-078)', () => {
  beforeEach(() => {
    useWorldStore.getState().reset();
  });

  it('ëª©í‘œê°€ ì—†ì„ ë•Œ ì•„ë¬´ê²ƒë„ ë Œë”ë§í•˜ì§€ ì•Šì•„ì•¼ í•œë‹¤', () => {
    const { container } = render(<ObjectiveTracker />);
    expect(container.firstChild).toBeNull();
  });

  it('ì£¼ ëª©í‘œë§Œ ìˆì„ ë•Œ ì˜¬ë°”ë¥´ê²Œ í‘œì‹œí•´ì•¼ í•œë‹¤', () => {
    useWorldStore.setState({
      quests: [
        {
          id: 'main',
          label: 'ì£¼ ëª©í‘œ',
          is_completed: false,
          description: null,
          is_main: true,
          progress: 30,
          reward_signal: 0,
        },
      ],
    });

    render(<ObjectiveTracker />);
    expect(screen.getByText('ì£¼ ëª©í‘œ')).toBeInTheDocument();
    // ì§„í–‰ë¥  ë°” í™•ì¸
    const progressBar = screen.getByRole('progressbar');
    expect(progressBar).toBeInTheDocument();
    const fill = progressBar.querySelector('.objective-tracker__bar-fill');
    expect(fill).toHaveStyle({ width: '30%' });
  });

  it('ì„œë¸Œ ëª©í‘œ ì¹´ìš´íŠ¸ë¥¼ í‘œì‹œí•´ì•¼ í•œë‹¤', () => {
    useWorldStore.setState({
      quests: [
        {
          id: 'main',
          label: 'ì£¼ ëª©í‘œ',
          is_completed: false,
          description: null,
          is_main: true,
          progress: 0,
          reward_signal: 0,
        },
        {
          id: 'sub1',
          label: 'ì„œë¸Œ 1',
          is_completed: true,
          description: null,
          is_main: false,
          progress: 0,
          reward_signal: 0,
        },
        {
          id: 'sub2',
          label: 'ì„œë¸Œ 2',
          is_completed: false,
          description: null,
          is_main: false,
          progress: 0,
          reward_signal: 0,
        },
      ],
    });

    render(<ObjectiveTracker />);
    expect(screen.getByText('(1/2)')).toBeInTheDocument();
  });

  it('ì™„ë£Œëœ ëª©í‘œì¼ ë•Œ ì²´í¬ ì•„ì´ì½˜ì„ í‘œì‹œí•´ì•¼ í•œë‹¤', () => {
    useWorldStore.setState({
      quests: [
        {
          id: 'main',
          label: 'ì™„ë£Œëœ ì£¼ ëª©í‘œ',
          is_completed: true,
          description: null,
          is_main: true,
          progress: 100,
          reward_signal: 0,
        },
      ],
    });

    render(<ObjectiveTracker />);
    expect(screen.getByText('âœ…')).toBeInTheDocument();
    expect(screen.getByText('ì™„ë£Œëœ ì£¼ ëª©í‘œ')).toBeInTheDocument();
  });
});
</file>

<file path="frontend/src/components/ObjectiveTracker.tsx">
/**
 * Unknown World - Objective Tracker (U-078 ëª©í‘œ ì‹œìŠ¤í…œ ê°•í™”)
 *
 * í™”ë©´ ìƒë‹¨ì— í•­ìƒ ë³´ì´ëŠ” ë¯¸ë‹ˆ ëª©í‘œ íŠ¸ë˜ì»¤ì…ë‹ˆë‹¤.
 * ì£¼ ëª©í‘œì˜ ì œëª©ê³¼ ì§„í–‰ë¥ ì„ ê°„ê²°í•˜ê²Œ í‘œì‹œí•©ë‹ˆë‹¤.
 *
 * Q2 ê²°ì •: Option B - í™”ë©´ ìƒë‹¨ì— ë¯¸ë‹ˆ íŠ¸ë˜ì»¤ ì¶”ê°€ (í•­ìƒ ë³´ì„)
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - RULE-002: ê²Œì„ HUD ìš”ì†Œë¡œ ìƒì‹œ ë…¸ì¶œ
 *   - RULE-006: i18n ê¸°ë°˜ ë¬¸ìì—´
 *   - ìµœì†Œ ë†’ì´ë¡œ ë©”ì¸ ì½˜í…ì¸ ë¥¼ ì¹¨ë²”í•˜ì§€ ì•ŠìŒ
 *
 * @module components/ObjectiveTracker
 */

import { useTranslation } from 'react-i18next';
import { useShallow } from 'zustand/react/shallow';
import { useWorldStore, selectMainObjective, selectSubObjectives } from '../stores/worldStore';

/**
 * ObjectiveTracker - ë¯¸ë‹ˆ ëª©í‘œ íŠ¸ë˜ì»¤
 *
 * game-center ì˜ì—­ ìƒë‹¨ì— ë°°ì¹˜í•˜ì—¬ í•­ìƒ í˜„ì¬ ëª©í‘œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
 */
export function ObjectiveTracker() {
  const { t } = useTranslation();
  const mainObjective = useWorldStore(selectMainObjective);
  const subObjectives = useWorldStore(useShallow(selectSubObjectives));

  // ì„œë¸Œ ëª©í‘œ ì¤‘ ì™„ë£Œëœ ê²ƒì˜ ìˆ˜
  const completedCount = subObjectives.filter((q) => q.is_completed).length;
  const totalCount = subObjectives.length;

  // ëª©í‘œê°€ ì „í˜€ ì—†ìœ¼ë©´ í‘œì‹œí•˜ì§€ ì•ŠìŒ
  if (!mainObjective && totalCount === 0) {
    return null;
  }

  const progress = mainObjective?.progress ?? 0;
  const isComplete = mainObjective?.is_completed ?? false;

  return (
    <div
      className={`objective-tracker ${isComplete ? 'objective-tracker--completed' : ''}`}
      data-ui-importance="critical"
    >
      <div className="objective-tracker__icon" aria-hidden="true">
        {isComplete ? 'âœ…' : 'ğŸ¯'}
      </div>
      <div className="objective-tracker__content">
        <span className="objective-tracker__title">
          {mainObjective?.label ?? t('quest.tracker_no_objective')}
        </span>
        {totalCount > 0 && (
          <span className="objective-tracker__sub-count">
            ({completedCount}/{totalCount})
          </span>
        )}
      </div>
      <div
        className="objective-tracker__bar"
        role="progressbar"
        aria-valuenow={progress}
        aria-valuemin={0}
        aria-valuemax={100}
      >
        <div
          className="objective-tracker__bar-fill"
          style={{ width: `${Math.max(0, Math.min(100, progress))}%` }}
        />
      </div>
    </div>
  );
}

export default ObjectiveTracker;
</file>

<file path="frontend/src/components/QuestPanel.tsx">
/**
 * Unknown World - Quest Panel (U-013, U-078 ëª©í‘œ ì‹œìŠ¤í…œ ê°•í™”)
 *
 * í”Œë ˆì´ì–´ì˜ í˜„ì¬ ëª©í‘œë¥¼ **ì£¼ ëª©í‘œ(Main Objective)** + **ì„œë¸Œ ëª©í‘œ** í˜•íƒœë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
 *
 * U-078 ë³€ê²½ì‚¬í•­:
 *   - ì£¼ ëª©í‘œ(is_main=true): ìƒë‹¨ ê°•ì¡° ì˜ì—­, ì§„í–‰ë¥  ë°”, ë³´ìƒ ë¯¸ë¦¬ë³´ê¸°
 *   - ì„œë¸Œ ëª©í‘œ(is_main=false): ì²´í¬ë¦¬ìŠ¤íŠ¸, ì™„ë£Œ ì‹œ ì·¨ì†Œì„  + ë³´ìƒ í”¼ë“œë°±
 *   - ëª©í‘œ ì—†ì„ ë•Œ: "ììœ  íƒìƒ‰ ì¤‘" ì•ˆë‚´
 *   - ì™„ë£Œ ì‹œ ì²´í¬ ì• ë‹ˆë©”ì´ì…˜ (Q4: Option B)
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - RULE-002: ì±„íŒ… UIê°€ ì•„ë‹Œ ê²Œì„ UIë¡œ ìƒì‹œ ë…¸ì¶œ
 *   - RULE-006: i18n ê¸°ë°˜ ë¬¸ìì—´ ê´€ë¦¬
 *   - PRD 6.7: Quest/Objective Panel
 *
 * @module components/QuestPanel
 */

import { useTranslation } from 'react-i18next';
import { useShallow } from 'zustand/react/shallow';
import { useWorldStore, selectMainObjective, selectSubObjectives } from '../stores/worldStore';
import type { Quest } from '../schemas/turn';

// =============================================================================
// ì§„í–‰ë¥  ë°” í•˜ìœ„ ì»´í¬ë„ŒíŠ¸
// =============================================================================

interface ProgressBarProps {
  value: number; // 0-100
}

/** ì£¼ ëª©í‘œ ì§„í–‰ë¥  ë°” */
function ProgressBar({ value }: ProgressBarProps) {
  const clampedValue = Math.max(0, Math.min(100, value));
  return (
    <div
      className="objective-progress-bar"
      role="progressbar"
      aria-valuenow={clampedValue}
      aria-valuemin={0}
      aria-valuemax={100}
    >
      <div className="objective-progress-fill" style={{ width: `${clampedValue}%` }} />
      <span className="objective-progress-text">{clampedValue}%</span>
    </div>
  );
}

// =============================================================================
// ì£¼ ëª©í‘œ í•˜ìœ„ ì»´í¬ë„ŒíŠ¸
// =============================================================================

interface MainObjectiveProps {
  quest: Quest;
}

/** ì£¼ ëª©í‘œ ì˜ì—­ - ê°•ì¡° í‘œì‹œ + ì§„í–‰ë¥  + ë³´ìƒ */
function MainObjective({ quest }: MainObjectiveProps) {
  const { t } = useTranslation();

  return (
    <div
      className={`main-objective ${quest.is_completed ? 'main-objective--completed' : ''}`}
      data-ui-importance="critical"
    >
      <div className="main-objective__header">
        <span className="main-objective__icon" aria-hidden="true">
          ğŸ¯
        </span>
        <span className="main-objective__badge">{t('quest.main_objective')}</span>
      </div>
      <h4 className="main-objective__title">{quest.label}</h4>
      {quest.description && <p className="main-objective__desc">{quest.description}</p>}
      <ProgressBar value={quest.progress} />
      {quest.reward_signal > 0 && !quest.is_completed && (
        <div className="main-objective__reward">
          <span className="main-objective__reward-icon" aria-hidden="true">
            ğŸ’°
          </span>
          <span>{t('quest.reward_preview', { signal: quest.reward_signal })}</span>
        </div>
      )}
      {quest.is_completed && (
        <div className="main-objective__complete-badge">
          <span aria-hidden="true">âœ…</span>
          <span>{t('quest.objective_complete')}</span>
        </div>
      )}
    </div>
  );
}

// =============================================================================
// ì„œë¸Œ ëª©í‘œ í•˜ìœ„ ì»´í¬ë„ŒíŠ¸
// =============================================================================

interface SubObjectiveItemProps {
  quest: Quest;
}

/** ê°œë³„ ì„œë¸Œ ëª©í‘œ ì•„ì´í…œ */
function SubObjectiveItem({ quest }: SubObjectiveItemProps) {
  const { t } = useTranslation();

  return (
    <li
      className={`sub-objective ${quest.is_completed ? 'sub-objective--completed' : 'sub-objective--active'}`}
      data-quest-id={quest.id}
    >
      <span
        className={`sub-objective__check ${quest.is_completed ? 'sub-objective__check--done' : ''}`}
        aria-hidden="true"
      >
        {quest.is_completed ? 'âœ“' : 'â—‹'}
      </span>
      <span className="sub-objective__label">{quest.label}</span>
      {quest.reward_signal > 0 && !quest.is_completed && (
        <span
          className="sub-objective__reward"
          title={t('quest.reward_preview', { signal: quest.reward_signal })}
        >
          +{quest.reward_signal}âš¡
        </span>
      )}
      {quest.is_completed && quest.reward_signal > 0 && (
        <span className="sub-objective__earned">
          {t('quest.reward_earned', { signal: quest.reward_signal })}
        </span>
      )}
    </li>
  );
}

// =============================================================================
// ë©”ì¸ ì»´í¬ë„ŒíŠ¸
// =============================================================================

/**
 * Quest Panel - U-078 ëª©í‘œ ì‹œìŠ¤í…œ ê°•í™”
 *
 * ì£¼ ëª©í‘œ(Main Objective) + ì„œë¸Œ ëª©í‘œ(Sub-objectives)ë¥¼ ë¶„ë¦¬ í‘œì‹œí•©ë‹ˆë‹¤.
 * worldStoreì˜ quests ìƒíƒœë¥¼ êµ¬ë…í•˜ì—¬ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.
 */
export function QuestPanel() {
  const { t } = useTranslation();
  const mainObjective = useWorldStore(selectMainObjective);
  const subObjectives = useWorldStore(useShallow(selectSubObjectives));

  const activeSubObjectives = subObjectives.filter((q) => !q.is_completed);
  const completedSubObjectives = subObjectives.filter((q) => q.is_completed);

  // ì£¼ ëª©í‘œë„ ì—†ê³  ì„œë¸Œ ëª©í‘œë„ ì—†ëŠ” ë¹ˆ ìƒíƒœ
  if (!mainObjective && subObjectives.length === 0) {
    return (
      <div className="quest-panel-content quest-empty" data-ui-importance="critical">
        <div className="quest-empty-icon" aria-hidden="true">
          ğŸ§­
        </div>
        <p className="quest-empty-text">{t('quest.free_exploration')}</p>
        <p className="quest-empty-hint">{t('quest.free_exploration_desc')}</p>
      </div>
    );
  }

  return (
    <div className="quest-panel-content" data-ui-importance="critical">
      {/* ì£¼ ëª©í‘œ ì˜ì—­ */}
      {mainObjective && <MainObjective quest={mainObjective} />}

      {/* ì„œë¸Œ ëª©í‘œ: ì§„í–‰ ì¤‘ */}
      {activeSubObjectives.length > 0 && (
        <div className="quest-section quest-section-active">
          <h4 className="quest-section-title">{t('quest.sub_objectives')}</h4>
          <ul className="sub-objective-list" role="list" aria-label={t('quest.sub_objectives')}>
            {activeSubObjectives.map((quest) => (
              <SubObjectiveItem key={quest.id} quest={quest} />
            ))}
          </ul>
        </div>
      )}

      {/* ì„œë¸Œ ëª©í‘œ: ì™„ë£Œë¨ */}
      {completedSubObjectives.length > 0 && (
        <div className="quest-section quest-section-completed">
          <h4 className="quest-section-title">{t('quest.section.completed')}</h4>
          <ul
            className="sub-objective-list sub-objective-list--completed"
            role="list"
            aria-label={t('quest.section.completed')}
          >
            {completedSubObjectives.map((quest) => (
              <SubObjectiveItem key={quest.id} quest={quest} />
            ))}
          </ul>
        </div>
      )}
    </div>
  );
}

export default QuestPanel;
</file>

<file path="frontend/src/components/RuleBoard.test.tsx">
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { render, screen } from '@testing-library/react';
import { RuleBoard } from './RuleBoard';
import { useWorldStore } from '../stores/worldStore';

vi.mock('react-i18next', () => ({
  useTranslation: () => ({
    t: (key: string, options?: Record<string, unknown>) => {
      if (options?.count !== undefined) return `${key} (count: ${options.count})`;
      return key;
    },
  }),
  initReactI18next: {
    type: '3rdParty',
    init: () => {},
  },
}));

describe('RuleBoard (U-013)', () => {
  beforeEach(() => {
    useWorldStore.getState().reset();
  });

  it('ê·œì¹™ì´ ì—†ì„ ë•Œ ë¹ˆ ìƒíƒœë¥¼ í‘œì‹œí•´ì•¼ í•œë‹¤', () => {
    render(<RuleBoard />);
    expect(screen.getByText('rule_board.empty')).toBeInTheDocument();
  });

  it('í™œì„± ê·œì¹™ ëª©ë¡ì„ í‘œì‹œí•´ì•¼ í•œë‹¤', () => {
    useWorldStore.setState({
      activeRules: [
        { id: 'r1', label: 'ì¤‘ë ¥', description: 'ë–¨ì–´ì§„ë‹¤' },
        { id: 'r2', label: 'ì‚°ì†Œ', description: 'í•„ìš”í•˜ë‹¤' },
      ],
    });

    render(<RuleBoard />);
    expect(screen.getByText('rule_board.active_count (count: 2)')).toBeInTheDocument();
    expect(screen.getByText('ì¤‘ë ¥')).toBeInTheDocument();
    expect(screen.getByText('ë–¨ì–´ì§„ë‹¤')).toBeInTheDocument();
    expect(screen.getByText('ì‚°ì†Œ')).toBeInTheDocument();
  });
});
</file>

<file path="frontend/src/components/SceneCanvas.hotspot.test.tsx">
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen, fireEvent, act } from '@testing-library/react';
import { SceneCanvas } from './SceneCanvas';
import type { SceneObject } from '../schemas/turn';
import type { SceneCanvasState } from '../types/scene';
import { useWorldStore } from '../stores/worldStore';
import { useAgentStore } from '../stores/agentStore';

// i18next ëª¨í‚¹
vi.mock('react-i18next', () => ({
  useTranslation: () => ({
    t: (key: string) => key,
  }),
  initReactI18next: {
    type: '3rdParty',
    init: () => {},
  },
}));

// ResizeObserver ëª¨í‚¹
let resizeCallback: (entries: ResizeObserverEntry[]) => void;
class MockResizeObserver {
  constructor(callback: (entries: ResizeObserverEntry[]) => void) {
    resizeCallback = callback;
  }
  observe = vi.fn();
  unobserve = vi.fn();
  disconnect = vi.fn();
}

global.ResizeObserver = MockResizeObserver as unknown as typeof ResizeObserver;

/**
 * ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸ë¥¼ ìˆ˜ë™ìœ¼ë¡œ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤.
 */
function triggerResize(width: number, height: number) {
  if (resizeCallback) {
    act(() => {
      resizeCallback([
        {
          contentRect: { width, height } as DOMRectReadOnly,
          target: document.querySelector('.scene-canvas') as Element,
        } as ResizeObserverEntry,
      ]);
    });
  }
}

// getBoundingClientRect ëª¨í‚¹
Element.prototype.getBoundingClientRect = vi.fn(() => ({
  width: 800,
  height: 600,
  top: 0,
  left: 0,
  bottom: 600,
  right: 800,
  x: 0,
  y: 0,
  toJSON: () => {},
})) as unknown as () => DOMRect;

describe('SceneCanvas Hotspots', () => {
  const defaultState: SceneCanvasState = {
    status: 'scene',
    imageUrl: 'https://example.com/scene.png',
  };

  const mockObjects: SceneObject[] = [
    {
      id: 'obj-1',
      label: 'Object 1',
      box_2d: { ymin: 100, xmin: 100, ymax: 200, xmax: 200 },
      interaction_hint: 'Click me',
    },
    {
      id: 'obj-2',
      label: 'Object 2',
      box_2d: { ymin: 500, xmin: 500, ymax: 700, xmax: 700 },
      interaction_hint: null,
    },
  ];

  beforeEach(() => {
    vi.clearAllMocks();
    // ìŠ¤í† ì–´ ì´ˆê¸°í™”
    useWorldStore.setState({
      sceneState: { status: 'default', message: '' },
      sceneObjects: [],
    });
    useAgentStore.setState({ isStreaming: false });
  });

  it('should render hotspots when objects are provided in worldStore and status is scene (sorted by area)', () => {
    useWorldStore.setState({
      sceneState: defaultState,
      sceneObjects: mockObjects,
    });

    render(<SceneCanvas />);

    // í•«ìŠ¤íŒŸ ë ˆì´ì–´ í™•ì¸
    const layer = screen.getByLabelText('scene.hotspot.layer_label');
    expect(layer).toBeInTheDocument();

    // ê°œë³„ í•«ìŠ¤íŒŸ í™•ì¸ (role="button")
    // RU-003-S2: ë©´ì  ê¸°ë°˜ ì •ë ¬ - í° ê²ƒì´ ë¨¼ì € ë Œë”ë§ë˜ì–´ ë‚®ì€ z-indexë¥¼ ê°€ì§
    // Object 1: 100x100 = 10,000
    // Object 2: 200x200 = 40,000
    // ë”°ë¼ì„œ Object 2ê°€ ë¨¼ì € ì˜¤ê³  Object 1ì´ ë‚˜ì¤‘ì— ì˜´
    const buttons = screen.getAllByRole('button');
    expect(buttons).toHaveLength(mockObjects.length);
    expect(buttons[0]).toHaveAttribute('aria-label', 'Object 2');
    expect(buttons[1]).toHaveAttribute('aria-label', 'Object 1');

    // z-index í™•ì¸ (RU-003-S2: HotspotOverlay ìì²´ì— styleë¡œ ì ìš©ë¨)
    expect(buttons[0]).toHaveStyle({ zIndex: '1' });
    expect(buttons[1]).toHaveStyle({ zIndex: '2' });
  });

  it('should not render hotspots when status is loading', () => {
    useWorldStore.setState({
      sceneState: { status: 'loading' },
      sceneObjects: mockObjects,
    });

    render(<SceneCanvas />);

    const layer = screen.queryByLabelText('scene.hotspot.layer_label');
    expect(layer).not.toBeInTheDocument();
  });

  it('should call onHotspotClick when a hotspot is clicked', () => {
    const onHotspotClick = vi.fn();
    useWorldStore.setState({
      sceneState: defaultState,
      sceneObjects: mockObjects,
    });

    render(<SceneCanvas onHotspotClick={onHotspotClick} />);

    const firstHotspot = screen.getByLabelText('Object 1');
    fireEvent.click(firstHotspot);

    expect(onHotspotClick).toHaveBeenCalledWith({
      object_id: 'obj-1',
      box_2d: mockObjects[0].box_2d,
    });
  });

  it('should show tooltip on hover', async () => {
    useWorldStore.setState({
      sceneState: defaultState,
      sceneObjects: mockObjects,
    });

    render(<SceneCanvas />);

    const firstHotspot = screen.getByLabelText('Object 1');

    // Hover ì‹œì‘
    fireEvent.mouseEnter(firstHotspot);

    // íˆ´íŒ ë¼ë²¨ í™•ì¸
    expect(screen.getByText('Object 1')).toBeInTheDocument();
    expect(screen.getByText(/scene.hotspot.hint_prefix/)).toBeInTheDocument();
    expect(screen.getByText(/Click me/)).toBeInTheDocument();

    // Hover ì¢…ë£Œ
    fireEvent.mouseLeave(firstHotspot);
    expect(screen.queryByText('Object 1')).not.toBeInTheDocument();
  });

  it('should be disabled when agentStore.isStreaming is true', () => {
    const onHotspotClick = vi.fn();
    useWorldStore.setState({
      sceneState: defaultState,
      sceneObjects: mockObjects,
    });
    useAgentStore.setState({ isStreaming: true });

    render(<SceneCanvas onHotspotClick={onHotspotClick} />);

    const firstHotspot = screen.getByLabelText('Object 1');
    expect(firstHotspot).toHaveAttribute('aria-disabled', 'true');
    expect(firstHotspot).toHaveAttribute('tabindex', '-1');

    fireEvent.click(firstHotspot);
    expect(onHotspotClick).not.toHaveBeenCalled();
  });

  it('should reposition hotspots when canvas size changes (reactive resize)', async () => {
    vi.useFakeTimers();
    useWorldStore.setState({
      sceneState: defaultState,
      sceneObjects: mockObjects,
    });

    render(<SceneCanvas />);

    // Object 1 ì°¾ê¸° (ì •ë ¬ì— ì˜í•´ ë‘ ë²ˆì§¸ ë²„íŠ¼ì¼ ìˆ˜ ìˆìŒ)
    const firstHotspot = screen.getByLabelText('Object 1');

    // ì´ˆê¸° í¬ê¸° (800x600) ê¸°ë°˜ ìœ„ì¹˜ í™•ì¸
    expect(firstHotspot).toHaveStyle({
      top: '60px',
      left: '80px',
      width: '80px',
      height: '60px',
    });

    // í¬ê¸° ë³€ê²½ íŠ¸ë¦¬ê±° (400x300)
    triggerResize(400, 300);

    // RU-003-S2: ResizeObserver ë””ë°”ìš´ìŠ¤(100ms) ëŒ€ê¸°
    act(() => {
      vi.advanceTimersByTime(150);
    });

    // ë³€ê²½ëœ í¬ê¸° ê¸°ë°˜ ìœ„ì¹˜ í™•ì¸
    expect(firstHotspot).toHaveStyle({
      top: '30px',
      left: '40px',
      width: '40px',
      height: '30px',
    });

    vi.useRealTimers();
  });
});
</file>

<file path="frontend/src/components/SceneCanvas.rendering.test.tsx">
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { render, act } from '@testing-library/react';
import { SceneCanvas } from './SceneCanvas';
import { useWorldStore } from '../stores/worldStore';

// ResizeObserver ëª¨í‚¹
interface MockObserver {
  callback: ResizeObserverCallback;
  observe: ReturnType<typeof vi.fn>;
  unobserve: ReturnType<typeof vi.fn>;
  disconnect: ReturnType<typeof vi.fn>;
}

const observerInstances: MockObserver[] = [];
const MockResizeObserver = vi.fn().mockImplementation(function (
  this: MockObserver,
  callback: ResizeObserverCallback,
) {
  this.callback = callback;
  this.observe = vi.fn();
  this.unobserve = vi.fn();
  this.disconnect = vi.fn();
  observerInstances.push(this);
});

vi.stubGlobal('ResizeObserver', MockResizeObserver);

describe('SceneCanvas Rendering Stability (U-097)', () => {
  let consoleErrorSpy: ReturnType<typeof vi.spyOn>;

  beforeEach(() => {
    // console.error ê°ì‹œ (React ë Œë”ë§ ì¤‘ ì—…ë°ì´íŠ¸ ê²½ê³ ëŠ” console.errorë¡œ ì¶œë ¥ë¨)
    consoleErrorSpy = vi.spyOn(console, 'error').mockImplementation(() => {});
    // Store ì´ˆê¸°í™”
    useWorldStore.getState().reset();
    observerInstances.length = 0;
  });

  afterEach(() => {
    consoleErrorSpy.mockRestore();
    vi.clearAllMocks();
    vi.useRealTimers();
  });

  it('should not throw "Cannot update a component while rendering" warning', async () => {
    // Given: SceneCanvas ë Œë”ë§
    render(<SceneCanvas />);

    // Then: ë Œë”ë§ ì§í›„ console.errorì— React ê²½ê³ ê°€ ì—†ì–´ì•¼ í•¨
    const hasWarning = consoleErrorSpy.mock.calls.some(
      (call: unknown[]) =>
        typeof call[0] === 'string' && call[0].includes('Cannot update a component'),
    );

    expect(hasWarning).toBe(false);
  });

  it('should update Zustand store via useEffect, not during render', async () => {
    vi.useFakeTimers();

    // getBoundingClientRect ëª¨í‚¹ (ì´ˆê¸° í¬ê¸° ì„¤ì •ìš©)
    const getBoundingClientRectSpy = vi
      .spyOn(HTMLElement.prototype, 'getBoundingClientRect')
      .mockReturnValue({
        width: 1024,
        height: 768,
        top: 0,
        left: 0,
        bottom: 768,
        right: 1024,
        x: 0,
        y: 0,
        toJSON: () => {},
      } as DOMRect);

    // Storeì˜ setSceneCanvasSizeë¥¼ ìŠ¤íŒŒì´
    const setSceneCanvasSizeSpy = vi.spyOn(useWorldStore.getState(), 'setSceneCanvasSize');

    // SceneCanvas ë Œë”ë§
    render(<SceneCanvas />);

    // useEffectê°€ ì‹¤í–‰ë˜ë„ë¡ ëŒ€ê¸°
    await act(async () => {
      vi.runAllTimers();
    });

    // setSceneCanvasSizeê°€ í˜¸ì¶œë˜ì—ˆëŠ”ì§€ í™•ì¸
    expect(setSceneCanvasSizeSpy).toHaveBeenCalled();

    // ResizeObserver íŠ¸ë¦¬ê±° ì‹œë®¬ë ˆì´ì…˜
    const observerInstance = observerInstances[0];
    const mockEntry = {
      contentRect: { width: 800, height: 600 },
    } as unknown as ResizeObserverEntry;

    await act(async () => {
      observerInstance.callback([mockEntry], observerInstance as unknown as ResizeObserver);
    });

    // 100ms ë””ë°”ìš´ìŠ¤ ëŒ€ê¸°
    await act(async () => {
      vi.advanceTimersByTime(150);
    });

    // Store ì—…ë°ì´íŠ¸ í™•ì¸
    expect(useWorldStore.getState().sceneCanvasSize).toEqual({ width: 800, height: 600 });

    // ì´ ê³¼ì •ì—ì„œ ë Œë”ë§ ì¤‘ ì—…ë°ì´íŠ¸ ê²½ê³ ê°€ ë°œìƒí•˜ì§€ ì•Šì•˜ëŠ”ì§€ ìµœì¢… í™•ì¸
    const hasWarning = consoleErrorSpy.mock.calls.some(
      (call: unknown[]) =>
        typeof call[0] === 'string' && call[0].includes('Cannot update a component'),
    );
    expect(hasWarning).toBe(false);

    getBoundingClientRectSpy.mockRestore();
  });
});
</file>

<file path="frontend/src/components/SceneCanvas.test.tsx">
import { describe, it, expect } from 'vitest';
import { SCENE_PLACEHOLDERS } from './SceneImage';

describe('SCENE_PLACEHOLDERS', () => {
  it('should have all required statuses', () => {
    const statuses = ['default', 'loading', 'offline', 'blocked', 'low_signal'];
    statuses.forEach((status) => {
      expect(SCENE_PLACEHOLDERS).toHaveProperty(status);
    });
  });

  it('should have correct image paths', () => {
    expect(SCENE_PLACEHOLDERS.default.imagePath).toBe(
      '/ui/placeholders/scene-placeholder-default.png',
    );
    expect(SCENE_PLACEHOLDERS.loading.imagePath).toBe('/ui/placeholders/scene-loading.webp');
    expect(SCENE_PLACEHOLDERS.offline.imagePath).toBe('/ui/placeholders/scene-offline.webp');
    expect(SCENE_PLACEHOLDERS.blocked.imagePath).toBe('/ui/placeholders/scene-blocked.webp');
    expect(SCENE_PLACEHOLDERS.low_signal.imagePath).toBe('/ui/placeholders/scene-low-signal.webp');
  });

  it('should have correct i18n label keys', () => {
    expect(SCENE_PLACEHOLDERS.default.labelKey).toBe('scene.status.default');
    expect(SCENE_PLACEHOLDERS.loading.labelKey).toBe('scene.status.loading');
    expect(SCENE_PLACEHOLDERS.offline.labelKey).toBe('scene.status.offline');
    expect(SCENE_PLACEHOLDERS.blocked.labelKey).toBe('scene.status.blocked');
    expect(SCENE_PLACEHOLDERS.low_signal.labelKey).toBe('scene.status.low_signal');
  });
});
</file>

<file path="frontend/src/data/itemIconPresets.ts">
/**
 * Unknown World - ì•„ì´í…œ ì•„ì´ì½˜ í”„ë¦¬ì…‹ ë ˆì§€ìŠ¤íŠ¸ë¦¬ (U-092[Mvp]).
 *
 * nanobanana mcpë¡œ ì‚¬ì „ ì œì‘ëœ ì•„ì´í…œ ì•„ì´ì½˜ì˜ ë§¤í•‘ í…Œì´ë¸”ì…ë‹ˆë‹¤.
 * ì´ˆê¸° ë°ëª¨ í”„ë¡œí•„ ì•„ì´í…œ + ìì£¼ ë“±ì¥í•˜ëŠ” ê³µí†µ ì•„ì´í…œì„ í¬í•¨í•©ë‹ˆë‹¤.
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - RULE-007: nanobanana mcpëŠ” ê°œë°œ/ì—ì…‹ ì œì‘ìš©ìœ¼ë¡œë§Œ ì‚¬ìš© (ì •ì  ë°°í¬)
 *   - Q2 ê²°ì •: icon_urlì´ ìˆìœ¼ë©´ í•­ìƒ í”„ë¦¬ì…‹ ìš°ì„  (ë™ì  ìƒì„± ê±´ë„ˆë›°ê¸°)
 *   - ì—ì…‹ SSOT: frontend/public/ui/items/ ê²½ë¡œ, kebab-case, 64x64 PNG
 *
 * @module data/itemIconPresets
 */

// =============================================================================
// í”„ë¦¬ì…‹ ì•„ì´ì½˜ ê²½ë¡œ ìƒìˆ˜
// =============================================================================

/** ì•„ì´í…œ ì•„ì´ì½˜ ì—ì…‹ ê¸°ë³¸ ê²½ë¡œ (public ë””ë ‰í† ë¦¬ ê¸°ì¤€) */
const ITEMS_BASE = '/ui/items';

// =============================================================================
// í”„ë¦¬ì…‹ ë ˆì§€ìŠ¤íŠ¸ë¦¬
// =============================================================================

/**
 * ì•„ì´í…œ ID â†’ í”„ë¦¬ì…‹ ì•„ì´ì½˜ URL ë§¤í•‘.
 *
 * í‚¤: ì•„ì´í…œ ID (kebab-case, demoProfiles ë° GM ì¶œë ¥ì—ì„œ ì‚¬ìš©í•˜ëŠ” ID)
 * ê°’: ì •ì  ì—ì…‹ URL ê²½ë¡œ (/ui/items/xxx-64.png)
 *
 * ê²Œì„ ë„ì¤‘ GMì´ ìƒì„±í•˜ëŠ” ì•„ì´í…œì˜ IDê°€ ì´ ë§µì— ì¡´ì¬í•˜ë©´
 * ë™ì  ìƒì„±ì„ ê±´ë„ˆë›°ê³  í”„ë¦¬ì…‹ ì•„ì´ì½˜ì„ ì¦‰ì‹œ ì‚¬ìš©í•©ë‹ˆë‹¤.
 */
export const ITEM_ICON_PRESETS: Readonly<Record<string, string>> = {
  // â”€â”€â”€ ì´ˆê¸° ì•„ì´í…œ: Narrator í”„ë¡œí•„ â”€â”€â”€
  'ancient-tome': `${ITEMS_BASE}/ancient-tome-64.png`,
  'quill-pen': `${ITEMS_BASE}/quill-pen-64.png`,
  'memory-fragment': `${ITEMS_BASE}/memory-fragment-64.png`,

  // â”€â”€â”€ ì´ˆê¸° ì•„ì´í…œ: Explorer í”„ë¡œí•„ â”€â”€â”€
  compass: `${ITEMS_BASE}/compass-64.png`,
  rope: `${ITEMS_BASE}/rope-64.png`,
  lantern: `${ITEMS_BASE}/lantern-64.png`,
  'map-fragment': `${ITEMS_BASE}/map-fragment-64.png`,

  // â”€â”€â”€ ì´ˆê¸° ì•„ì´í…œ: Tech Enthusiast í”„ë¡œí•„ â”€â”€â”€
  'data-core': `${ITEMS_BASE}/data-core-64.png`,
  'circuit-board': `${ITEMS_BASE}/circuit-board-64.png`,
  'energy-cell': `${ITEMS_BASE}/energy-cell-64.png`,
  'scanner-device': `${ITEMS_BASE}/scanner-device-64.png`,

  // â”€â”€â”€ ê³µí†µ ì•„ì´í…œ (ê²Œì„ ì¤‘ ìì£¼ ë“±ì¥) â”€â”€â”€
  sword: `${ITEMS_BASE}/sword-64.png`,
  shield: `${ITEMS_BASE}/shield-64.png`,
  potion: `${ITEMS_BASE}/potion-64.png`,
  key: `${ITEMS_BASE}/key-64.png`,
  gem: `${ITEMS_BASE}/gem-64.png`,
  scroll: `${ITEMS_BASE}/scroll-64.png`,
  torch: `${ITEMS_BASE}/torch-64.png`,
  herb: `${ITEMS_BASE}/herb-64.png`,
  coin: `${ITEMS_BASE}/coin-64.png`,
  ring: `${ITEMS_BASE}/ring-64.png`,
  amulet: `${ITEMS_BASE}/amulet-64.png`,
  dagger: `${ITEMS_BASE}/dagger-64.png`,
  flask: `${ITEMS_BASE}/flask-64.png`,
  crystal: `${ITEMS_BASE}/crystal-64.png`,
  lockpick: `${ITEMS_BASE}/lockpick-64.png`,
} as const;

// =============================================================================
// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
// =============================================================================

/**
 * ì•„ì´í…œ IDë¡œ í”„ë¦¬ì…‹ ì•„ì´ì½˜ URLì„ ì¡°íšŒí•©ë‹ˆë‹¤.
 *
 * @param itemId - ì•„ì´í…œ ID (kebab-case)
 * @returns í”„ë¦¬ì…‹ ì•„ì´ì½˜ URL ë˜ëŠ” undefined (í”„ë¦¬ì…‹ ì—†ìŒ)
 */
export function getPresetIconUrl(itemId: string): string | undefined {
  // ì •í™•í•œ ID ë§¤ì¹­
  if (itemId in ITEM_ICON_PRESETS) {
    return ITEM_ICON_PRESETS[itemId];
  }

  // ë¶€ë¶„ ë§¤ì¹­: ì•„ì´í…œ IDì— í”„ë¦¬ì…‹ í‚¤ê°€ í¬í•¨ëœ ê²½ìš° (ì˜ˆ: "rusty-sword" â†’ "sword")
  for (const [key, url] of Object.entries(ITEM_ICON_PRESETS)) {
    if (itemId.includes(key)) {
      return url;
    }
  }

  return undefined;
}

/**
 * ì•„ì´í…œ IDì— í”„ë¦¬ì…‹ ì•„ì´ì½˜ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
 *
 * @param itemId - ì•„ì´í…œ ID
 * @returns í”„ë¦¬ì…‹ ì¡´ì¬ ì—¬ë¶€
 */
export function hasPresetIcon(itemId: string): boolean {
  return getPresetIconUrl(itemId) !== undefined;
}
</file>

<file path="frontend/src/demo/demoFixtures.ts">
/**
 * Unknown World - ë°ëª¨ìš© Fixtures (RU-003-Q5)
 *
 * DEV í™˜ê²½ì—ì„œ ì‚¬ìš©í•˜ëŠ” ë°ëª¨ ì´ˆê¸° ë°ì´í„°ì…ë‹ˆë‹¤.
 * ì–¸ì–´ ì¤‘ë¦½ì ì¸ ê°’(ID/ì•„ì´ì½˜/ìˆ˜ëŸ‰/ì¢Œí‘œ)ë§Œ í¬í•¨í•˜ë©°,
 * í‘œì‹œ ë¬¸ìì—´(name/label/hint)ì€ i18n í‚¤ë¥¼ í†µí•´ ë Œë”ë§í•©ë‹ˆë‹¤.
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - RULE-006: ko/en í˜¼í•© ì¶œë ¥ ê¸ˆì§€ (i18n í‚¤ ê¸°ë°˜)
 *   - PRD 6.9: ë°ëª¨ í”„ë¡œí•„ ê²½ê³„ í™•ë³´
 *   - ì„œë²„ TurnOutput ëŒ€ì²´ ì‹œ ì´ ëª¨ë“ˆ ë¹„í™œì„±í™” ê°€ëŠ¥
 *
 * @module demo/demoFixtures
 */

import type { Box2D } from '../schemas/turn';

// =============================================================================
// íƒ€ì… ì •ì˜
// =============================================================================

/**
 * ë°ëª¨ ì¸ë²¤í† ë¦¬ ì•„ì´í…œ ì •ì˜ (ì–¸ì–´ ì¤‘ë¦½)
 *
 * nameì€ i18n í‚¤(`demo.items.{id}.name`)ë¡œ ë Œë”ë§í•©ë‹ˆë‹¤.
 */
export interface DemoInventoryItemDef {
  /** ì•„ì´í…œ ê³ ìœ  ID */
  id: string;
  /** ì•„ì´í…œ ì•„ì´ì½˜ (ì´ëª¨ì§€ ë˜ëŠ” URL) */
  icon: string;
  /** ì´ˆê¸° ìˆ˜ëŸ‰ */
  quantity: number;
}

/**
 * ë°ëª¨ ì”¬ ì˜¤ë¸Œì íŠ¸ ì •ì˜ (ì–¸ì–´ ì¤‘ë¦½)
 *
 * label/hintëŠ” i18n í‚¤ë¡œ ë Œë”ë§í•©ë‹ˆë‹¤:
 * - labelKey: `demo.scene.{id}.label`
 * - hintKey: `demo.scene.{id}.hint`
 */
export interface DemoSceneObjectDef {
  /** ì˜¤ë¸Œì íŠ¸ ê³ ìœ  ID */
  id: string;
  /** ë°”ìš´ë”© ë°•ìŠ¤ (0~1000 ì •ê·œí™”) */
  box_2d: Box2D;
  /** i18n ë¼ë²¨ í‚¤ */
  labelKey: string;
  /** i18n íŒíŠ¸ í‚¤ */
  hintKey: string;
}

// =============================================================================
// ë°ëª¨ ì¸ë²¤í† ë¦¬ ì•„ì´í…œ
// =============================================================================

/**
 * ë°ëª¨ìš© ì¸ë²¤í† ë¦¬ ì•„ì´í…œ ëª©ë¡.
 *
 * @remarks
 * - ID/ì•„ì´ì½˜/ìˆ˜ëŸ‰ë§Œ ì •ì˜ (ì–¸ì–´ ì¤‘ë¦½)
 * - í‘œì‹œ ì´ë¦„ì€ `demo.items.{id}.name` í‚¤ë¡œ i18n ì²˜ë¦¬
 */
export const DEMO_INVENTORY_ITEMS: readonly DemoInventoryItemDef[] = [
  { id: 'keycard-alpha', icon: 'ğŸ”‘', quantity: 1 },
  { id: 'medkit', icon: 'ğŸ©¹', quantity: 2 },
  { id: 'flashlight', icon: 'ğŸ”¦', quantity: 1 },
  { id: 'data-chip', icon: 'ğŸ’¾', quantity: 3 },
] as const;

// =============================================================================
// ë°ëª¨ ì”¬ ì˜¤ë¸Œì íŠ¸
// =============================================================================

/**
 * ë°ëª¨ìš© ì”¬ ì˜¤ë¸Œì íŠ¸ ëª©ë¡.
 *
 * @remarks
 * - ID/ì¢Œí‘œë§Œ ì •ì˜ (ì–¸ì–´ ì¤‘ë¦½)
 * - í‘œì‹œ ë¼ë²¨/íŒíŠ¸ëŠ” i18n í‚¤ë¡œ ì²˜ë¦¬
 */
export const DEMO_SCENE_OBJECTS: readonly DemoSceneObjectDef[] = [
  {
    id: 'demo-terminal',
    box_2d: { ymin: 300, xmin: 100, ymax: 600, xmax: 400 },
    labelKey: 'demo.scene.terminal.label',
    hintKey: 'demo.scene.terminal.hint',
  },
  {
    id: 'demo-door',
    box_2d: { ymin: 200, xmin: 600, ymax: 800, xmax: 900 },
    labelKey: 'demo.scene.door.label',
    hintKey: 'demo.scene.door.hint',
  },
] as const;

// =============================================================================
// ë°ëª¨ í€˜ìŠ¤íŠ¸ (U-013)
// =============================================================================

/**
 * ë°ëª¨ í€˜ìŠ¤íŠ¸ ì •ì˜ (ì–¸ì–´ ì¤‘ë¦½)
 *
 * labelì€ i18n í‚¤(`demo.quest.{id}.label`)ë¡œ ë Œë”ë§í•©ë‹ˆë‹¤.
 */
export interface DemoQuestDef {
  /** í€˜ìŠ¤íŠ¸ ê³ ìœ  ID */
  id: string;
  /** i18n ë¼ë²¨ í‚¤ */
  labelKey: string;
  /** ì™„ë£Œ ì—¬ë¶€ */
  is_completed: boolean;
  /** i18n ì„¤ëª… í‚¤ (ì„ íƒ, U-078) */
  descriptionKey?: string;
  /** ì£¼ ëª©í‘œ ì—¬ë¶€ (U-078) */
  is_main?: boolean;
  /** ì§„í–‰ë¥  0~100 (U-078) */
  progress?: number;
  /** Signal ë³´ìƒëŸ‰ (U-078) */
  reward_signal?: number;
}

/**
 * ë°ëª¨ìš© í€˜ìŠ¤íŠ¸ ëª©ë¡ (U-078: ëª©í‘œ ì‹œìŠ¤í…œ ê°•í™”).
 */
export const DEMO_QUESTS: readonly DemoQuestDef[] = [
  {
    id: 'demo-quest-terminal',
    labelKey: 'demo.quest.terminal.label',
    descriptionKey: 'demo.quest.terminal.description',
    is_completed: false,
    is_main: true,
    progress: 30,
    reward_signal: 50,
  },
  {
    id: 'demo-quest-escape',
    labelKey: 'demo.quest.escape.label',
    is_completed: false,
    is_main: false,
    progress: 0,
    reward_signal: 20,
  },
  {
    id: 'demo-quest-collect',
    labelKey: 'demo.quest.collect.label',
    is_completed: true,
    is_main: false,
    progress: 100,
    reward_signal: 10,
  },
] as const;

// =============================================================================
// ë°ëª¨ ê·œì¹™ (U-013)
// =============================================================================

/**
 * ë°ëª¨ ê·œì¹™ ì •ì˜ (ì–¸ì–´ ì¤‘ë¦½)
 *
 * label/descriptionì€ i18n í‚¤ë¡œ ë Œë”ë§í•©ë‹ˆë‹¤.
 */
export interface DemoRuleDef {
  /** ê·œì¹™ ê³ ìœ  ID */
  id: string;
  /** i18n ë¼ë²¨ í‚¤ */
  labelKey: string;
  /** i18n ì„¤ëª… í‚¤ (ì„ íƒ) */
  descriptionKey?: string;
}

/**
 * ë°ëª¨ìš© ê·œì¹™ ëª©ë¡.
 */
export const DEMO_RULES: readonly DemoRuleDef[] = [
  {
    id: 'demo-rule-gravity',
    labelKey: 'demo.rule.gravity.label',
    descriptionKey: 'demo.rule.gravity.description',
  },
  {
    id: 'demo-rule-time',
    labelKey: 'demo.rule.time.label',
    descriptionKey: 'demo.rule.time.description',
  },
] as const;

// =============================================================================
// í—¬í¼ í•¨ìˆ˜
// =============================================================================

/**
 * ë°ëª¨ ì¸ë²¤í† ë¦¬ ì•„ì´í…œì˜ i18n ì´ë¦„ í‚¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
 *
 * @param itemId - ì•„ì´í…œ ID
 * @returns i18n í‚¤ (ì˜ˆ: `demo.items.keycard-alpha.name`)
 */
export function getDemoItemNameKey(itemId: string): string {
  return `demo.items.${itemId}.name`;
}

/**
 * ë°ëª¨ í™˜ê²½ì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤ (DEV ê°€ë“œ).
 *
 * @returns DEV í™˜ê²½ ì—¬ë¶€
 */
export function isDemoEnvironment(): boolean {
  return import.meta.env.DEV;
}

/**
 * DOMì—ì„œ í˜„ì¬ í…Œë§ˆë¥¼ ì½ìŠµë‹ˆë‹¤.
 *
 * RU-003-Q5: 'dark' í•˜ë“œì½”ë”© ì œê±°
 * - data-theme ì†ì„±ì„ í™•ì¸í•˜ì—¬ í…Œë§ˆ ê²°ì •
 * - 'crt', 'dark' ë˜ëŠ” ë¯¸ì§€ì • â†’ 'dark'
 * - 'light' â†’ 'light'
 *
 * @returns í˜„ì¬ í…Œë§ˆ ('dark' | 'light')
 */
export function getCurrentThemeFromDOM(): 'dark' | 'light' {
  const dataTheme = document.documentElement.getAttribute('data-theme');

  // 'crt' í…Œë§ˆëŠ” dark ê³„ì—´ë¡œ ì·¨ê¸‰
  if (dataTheme === 'light') {
    return 'light';
  }
  return 'dark';
}
</file>

<file path="frontend/src/schemas/turn.economy.test.ts">
import { describe, it, expect } from 'vitest';
import { safeParseTurnOutput } from './turn';

describe('U-063: Economy Balance Preservation in safeParseTurnOutput', () => {
  it('should preserve economy balance in fallback when validation fails', () => {
    const invalidData = { some: 'invalid data' };
    const economySnapshot = { signal: 42, memory_shard: 7 };

    const result = safeParseTurnOutput(invalidData, 'ko-KR', 0, economySnapshot);

    expect(result.success).toBe(false);
    if (!result.success) {
      expect(result.fallback.economy.balance_after.signal).toBe(42);
      expect(result.fallback.economy.balance_after.memory_shard).toBe(7);
      expect(result.fallback.economy.cost.signal).toBe(0);
      expect(result.fallback.economy.cost.memory_shard).toBe(0);
    }
  });

  it('should use default values if economySnapshot is not provided', () => {
    const invalidData = { some: 'invalid data' };

    const result = safeParseTurnOutput(invalidData, 'ko-KR', 0);

    expect(result.success).toBe(false);
    if (!result.success) {
      // ê¸°ë³¸ê°’ { signal: 100, memory_shard: 5 } í™•ì¸ (turn.tsì— ì •ì˜ë¨)
      expect(result.fallback.economy.balance_after.signal).toBe(100);
      expect(result.fallback.economy.balance_after.memory_shard).toBe(5);
    }
  });
});
</file>

<file path="frontend/src/stores/actionDeckStore.test.ts">
import { describe, it, expect, beforeEach } from 'vitest';
import { useActionDeckStore, filterAffordableCards } from './actionDeckStore';
import type { ActionCard } from '../schemas/turn';

describe('actionDeckStore', () => {
  beforeEach(() => {
    useActionDeckStore.getState().reset();
  });

  // U-065: ë‹¨ìˆœí™”ëœ ActionCard ìŠ¤í‚¤ë§ˆ (ì œê±°ë¨: description, cost_estimate, hint, reward_hint, disabled_reason)
  const mockCards: ActionCard[] = [
    {
      id: 'card-1',
      label: 'Card 1',
      cost: { signal: 10, memory_shard: 0 },
      risk: 'low',
      enabled: true,
      is_alternative: false,
    },
    {
      id: 'card-2',
      label: 'Card 2',
      cost: { signal: 50, memory_shard: 1 },
      risk: 'high',
      enabled: true,
      is_alternative: false,
    },
  ];

  it('sets cards and resets selected card', () => {
    const store = useActionDeckStore.getState();
    store.selectCard('some-id');
    expect(useActionDeckStore.getState().selectedCardId).toBe('some-id');

    store.setCards(mockCards);
    expect(useActionDeckStore.getState().cards).toEqual(mockCards);
    expect(useActionDeckStore.getState().selectedCardId).toBeNull();
  });

  it('marks a card as executed', () => {
    const store = useActionDeckStore.getState();
    store.selectCard('card-1');
    store.markExecuted('card-1');

    expect(useActionDeckStore.getState().lastExecutedCardId).toBe('card-1');
    expect(useActionDeckStore.getState().selectedCardId).toBeNull();
  });

  it('filters affordable cards correctly', () => {
    const balance = { signal: 20, memory_shard: 0 };
    const affordable = filterAffordableCards(mockCards, balance);

    expect(affordable).toHaveLength(1);
    expect(affordable[0].id).toBe('card-1');
  });

  it('respects server enabled flag in filterAffordableCards', () => {
    const disabledCards: ActionCard[] = [
      {
        ...mockCards[0],
        enabled: false,
      },
    ];
    const balance = { signal: 100, memory_shard: 100 };
    const affordable = filterAffordableCards(disabledCards, balance);

    expect(affordable).toHaveLength(0);
  });
});
</file>

<file path="frontend/src/stores/actionDeckStore.ts">
/**
 * Unknown World - Action Deck ìƒíƒœ ê´€ë¦¬ (Zustand) (U-009[Mvp]).
 *
 * Action Deckì˜ ì¹´ë“œ ëª©ë¡, ì„ íƒ ìƒíƒœ, ì”ì•¡ ê¸°ë°˜ í•„í„°ë§ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - RULE-005: ì”ì•¡ ë¶€ì¡± ì‹œ ì‹¤í–‰ ë¶ˆê°€ í‘œì‹œ + ëŒ€ì•ˆ ì œê³µ
 *   - RULE-008: ì¹´ë“œ í´ë¦­ â†’ TurnInput ì—°ê²°
 *
 * @module stores/actionDeckStore
 */

import { create } from 'zustand';
import type { ActionCard } from '../schemas/turn';

// =============================================================================
// ìƒíƒœ íƒ€ì… ì •ì˜
// =============================================================================

/** Action Deck ìƒíƒœ */
export interface ActionDeckState {
  /** í˜„ì¬ ì¹´ë“œ ëª©ë¡ (ì„œë²„ì—ì„œ ë°›ì€ ì›ë³¸) */
  cards: ActionCard[];
  /** ì„ íƒëœ ì¹´ë“œ ID (í´ë¦­ í›„ ì‹¤í–‰ ì „ê¹Œì§€) */
  selectedCardId: string | null;
  /** ë§ˆì§€ë§‰ìœ¼ë¡œ ì‹¤í–‰ëœ ì¹´ë“œ ID */
  lastExecutedCardId: string | null;
}

/** Action Deck ì•¡ì…˜ */
export interface ActionDeckActions {
  /** ì¹´ë“œ ëª©ë¡ ì„¤ì • (TurnOutput ìˆ˜ì‹  ì‹œ) */
  setCards: (cards: ActionCard[]) => void;
  /** ì¹´ë“œ ì„ íƒ */
  selectCard: (cardId: string | null) => void;
  /** ì¹´ë“œ ì‹¤í–‰ ì™„ë£Œ ê¸°ë¡ */
  markExecuted: (cardId: string) => void;
  /** ìƒíƒœ ì´ˆê¸°í™” */
  reset: () => void;
}

export type ActionDeckStore = ActionDeckState & ActionDeckActions;

// =============================================================================
// ì´ˆê¸° ìƒíƒœ
// =============================================================================

function createInitialState(): ActionDeckState {
  return {
    cards: [],
    selectedCardId: null,
    lastExecutedCardId: null,
  };
}

// =============================================================================
// Zustand Store
// =============================================================================

/**
 * Action Deck ìƒíƒœ ìŠ¤í† ì–´.
 *
 * @example
 * ```tsx
 * const { cards, setCards, selectCard } = useActionDeckStore();
 *
 * // TurnOutput ìˆ˜ì‹  ì‹œ
 * setCards(turnOutput.ui.action_deck.cards);
 *
 * // ì¹´ë“œ í´ë¦­ ì‹œ
 * selectCard(card.id);
 * ```
 */
export const useActionDeckStore = create<ActionDeckStore>((set) => ({
  // ì´ˆê¸° ìƒíƒœ
  ...createInitialState(),

  // ì•¡ì…˜
  setCards: (cards) => {
    set({
      cards,
      selectedCardId: null, // ìƒˆ ì¹´ë“œ ëª©ë¡ ìˆ˜ì‹  ì‹œ ì„ íƒ ì´ˆê¸°í™”
    });
  },

  selectCard: (cardId) => {
    set({ selectedCardId: cardId });
  },

  markExecuted: (cardId) => {
    set({
      lastExecutedCardId: cardId,
      selectedCardId: null,
    });
  },

  reset: () => {
    set(createInitialState());
  },
}));

// =============================================================================
// ì…€ë ‰í„° (ì„±ëŠ¥ ìµœì í™”ìš©)
// =============================================================================

/** ì¹´ë“œ ëª©ë¡ ì…€ë ‰í„° */
export const selectCards = (state: ActionDeckStore) => state.cards;

/** ì„ íƒëœ ì¹´ë“œ ID ì…€ë ‰í„° */
export const selectSelectedCardId = (state: ActionDeckStore) => state.selectedCardId;

/** ì„ íƒëœ ì¹´ë“œ ê°ì²´ ì…€ë ‰í„° */
export const selectSelectedCard = (state: ActionDeckStore) =>
  state.cards.find((c) => c.id === state.selectedCardId) ?? null;

/** ë§ˆì§€ë§‰ ì‹¤í–‰ ì¹´ë“œ ID ì…€ë ‰í„° */
export const selectLastExecutedCardId = (state: ActionDeckStore) => state.lastExecutedCardId;

// =============================================================================
// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
// =============================================================================

/**
 * ì”ì•¡ ê¸°ë°˜ìœ¼ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•œ ì¹´ë“œë§Œ í•„í„°ë§í•©ë‹ˆë‹¤.
 * (ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©í•˜ê±°ë‚˜, ì„œë²„ ì‘ë‹µì´ enabledë¥¼ ì œê³µí•˜ì§€ ì•Šì„ ë•Œ í´ë°±ìœ¼ë¡œ ì‚¬ìš©)
 *
 * U-065: cost_estimate í•„ë“œ ì œê±°ë¨, costë§Œ ì‚¬ìš©
 *
 * @param cards - ì›ë³¸ ì¹´ë“œ ëª©ë¡
 * @param balance - í˜„ì¬ ì”ì•¡
 * @returns ì‹¤í–‰ ê°€ëŠ¥í•œ ì¹´ë“œ ëª©ë¡
 */
export function filterAffordableCards(
  cards: ActionCard[],
  balance: { signal: number; memory_shard: number },
): ActionCard[] {
  return cards.filter((card) => {
    // ì„œë²„ì—ì„œ ì´ë¯¸ enabled=falseë¡œ íŒë‹¨í–ˆìœ¼ë©´ ì œì™¸
    if (!card.enabled) return false;

    // U-065: cost_estimate ì œê±°ë¨, costë§Œ ì‚¬ìš©
    const cost = card.cost;
    return balance.signal >= cost.signal && balance.memory_shard >= cost.memory_shard;
  });
}

/**
 * ëŒ€ì•ˆ ì¹´ë“œ(is_alternative=true)ë§Œ í•„í„°ë§í•©ë‹ˆë‹¤.
 *
 * @param cards - ì›ë³¸ ì¹´ë“œ ëª©ë¡
 * @returns ëŒ€ì•ˆ ì¹´ë“œ ëª©ë¡
 */
export function filterAlternativeCards(cards: ActionCard[]): ActionCard[] {
  return cards.filter((card) => card.is_alternative);
}

/**
 * ì¼ë°˜ ì¹´ë“œ(is_alternative=false)ë§Œ í•„í„°ë§í•©ë‹ˆë‹¤.
 *
 * @param cards - ì›ë³¸ ì¹´ë“œ ëª©ë¡
 * @returns ì¼ë°˜ ì¹´ë“œ ëª©ë¡
 */
export function filterRegularCards(cards: ActionCard[]): ActionCard[] {
  return cards.filter((card) => !card.is_alternative);
}
</file>

<file path="frontend/src/stores/economyStore.test.ts">
import { describe, it, expect, beforeEach } from 'vitest';
import {
  useEconomyStore,
  LEDGER_MAX_ENTRIES,
  canAffordCost,
  canAffordEstimate,
} from './economyStore';
import type { CurrencyAmount, CostEstimate } from '../schemas/turn';

describe('economyStore', () => {
  beforeEach(() => {
    useEconomyStore.getState().reset();
    useEconomyStore.getState().clearLedger();
  });

  it('ì´ˆê¸° ìƒíƒœê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì–´ì•¼ í•œë‹¤', () => {
    const state = useEconomyStore.getState();
    expect(state.ledger).toEqual([]);
    expect(state.costEstimate).toBeNull();
    expect(state.lastCost).toBeNull();
    expect(state.isBalanceLow).toBe(false);
    expect(state.lowBalanceThreshold).toBe(10);
  });

  it('addLedgerEntryê°€ ì—”íŠ¸ë¦¬ë¥¼ ì¶”ê°€í•˜ê³  lastCostë¥¼ ì—…ë°ì´íŠ¸í•´ì•¼ í•œë‹¤', () => {
    const entry = {
      turnId: 1,
      reason: 'explore',
      cost: { signal: 5, memory_shard: 0 },
      balanceAfter: { signal: 95, memory_shard: 10 },
      modelLabel: 'FAST' as const,
    };

    useEconomyStore.getState().addLedgerEntry(entry);

    const state = useEconomyStore.getState();
    expect(state.ledger.length).toBe(1);
    expect(state.ledger[0].turnId).toBe(1);
    expect(state.ledger[0].timestamp).toBeDefined();
    expect(state.lastCost).toEqual({
      cost: entry.cost,
      balanceAfter: entry.balanceAfter,
      turnId: entry.turnId,
      modelLabel: entry.modelLabel,
    });
  });

  it(`LedgerëŠ” ìµœëŒ€ ${LEDGER_MAX_ENTRIES}ê°œê¹Œì§€ë§Œ ë³´ê´€í•´ì•¼ í•œë‹¤`, () => {
    const store = useEconomyStore.getState();

    // 25ê°œ ì—”íŠ¸ë¦¬ ì¶”ê°€
    for (let i = 1; i <= 25; i++) {
      store.addLedgerEntry({
        turnId: i,
        reason: `test-${i}`,
        cost: { signal: 1, memory_shard: 0 },
        balanceAfter: { signal: 100 - i, memory_shard: 0 },
      });
    }

    const state = useEconomyStore.getState();
    expect(state.ledger.length).toBe(LEDGER_MAX_ENTRIES);
    // ìµœì‹ ìˆœ(ë‚´ë¦¼ì°¨ìˆœ) ì •ë ¬ í™•ì¸
    expect(state.ledger[0].turnId).toBe(25);
    expect(state.ledger[LEDGER_MAX_ENTRIES - 1].turnId).toBe(25 - LEDGER_MAX_ENTRIES + 1);
  });

  it('setCostEstimateFromCardê°€ ì˜ˆìƒ ë¹„ìš©ì„ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •í•´ì•¼ í•œë‹¤', () => {
    const cost: CurrencyAmount = { signal: 5, memory_shard: 0 };
    const estimate: CostEstimate = {
      min: { signal: 3, memory_shard: 0 },
      max: { signal: 7, memory_shard: 0 },
    };

    // 1. cost_estimateê°€ ì œê³µëœ ê²½ìš°
    useEconomyStore.getState().setCostEstimateFromCard(cost, estimate, 'action-1', 'Test Label');
    let state = useEconomyStore.getState();
    expect(state.costEstimate).toEqual({
      min: estimate.min,
      max: estimate.max,
      actionId: 'action-1',
      label: 'Test Label',
    });

    // 2. cost_estimateê°€ nullì¸ ê²½ìš° (ê¸°ë³¸ cost ì‚¬ìš©)
    useEconomyStore.getState().setCostEstimateFromCard(cost, null, 'action-2');
    state = useEconomyStore.getState();
    expect(state.costEstimate).toEqual({
      min: cost,
      max: cost,
      actionId: 'action-2',
      label: undefined,
    });
  });

  it('updateBalanceLowStatusê°€ ì„ê³„ê°’ì— ë”°ë¼ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•´ì•¼ í•œë‹¤', () => {
    const store = useEconomyStore.getState();

    // ê¸°ë³¸ ì„ê³„ê°’ 10
    store.updateBalanceLowStatus({ signal: 15, memory_shard: 0 });
    expect(useEconomyStore.getState().isBalanceLow).toBe(false);

    store.updateBalanceLowStatus({ signal: 5, memory_shard: 0 });
    expect(useEconomyStore.getState().isBalanceLow).toBe(true);

    // ì„ê³„ê°’ ë³€ê²½ í…ŒìŠ¤íŠ¸
    store.setLowBalanceThreshold(20);
    store.updateBalanceLowStatus({ signal: 15, memory_shard: 0 });
    expect(useEconomyStore.getState().isBalanceLow).toBe(true);
  });

  describe('Utility: canAffordCost & canAffordEstimate', () => {
    const balance: CurrencyAmount = { signal: 10, memory_shard: 2 };

    it('canAffordCost: ì”ì•¡ì´ ì¶©ë¶„í•  ë•Œ', () => {
      const cost: CurrencyAmount = { signal: 5, memory_shard: 1 };
      const result = canAffordCost(balance, cost);
      expect(result.affordable).toBe(true);
      expect(result.shortfall).toEqual({ signal: 0, memory_shard: 0 });
    });

    it('canAffordCost: ì”ì•¡ì´ ë¶€ì¡±í•  ë•Œ (Signal)', () => {
      const cost: CurrencyAmount = { signal: 15, memory_shard: 1 };
      const result = canAffordCost(balance, cost);
      expect(result.affordable).toBe(false);
      expect(result.shortfall.signal).toBe(5);
    });

    it('canAffordCost: ì”ì•¡ì´ ë¶€ì¡±í•  ë•Œ (Shard)', () => {
      const cost: CurrencyAmount = { signal: 5, memory_shard: 5 };
      const result = canAffordCost(balance, cost);
      expect(result.affordable).toBe(false);
      expect(result.shortfall.memory_shard).toBe(3);
    });

    it('canAffordEstimate: ìµœëŒ€ ì˜ˆìƒ ë¹„ìš© ê¸°ì¤€ìœ¼ë¡œ ì²´í¬í•´ì•¼ í•œë‹¤', () => {
      const estimate = {
        min: { signal: 5, memory_shard: 0 },
        max: { signal: 15, memory_shard: 0 },
      };
      // Signal 10 < Max 15 ì´ë¯€ë¡œ ê°ë‹¹ ë¶ˆê°€
      const result = canAffordEstimate(balance, estimate);
      expect(result.affordable).toBe(false);
      expect(result.shortfall.signal).toBe(5);
    });
  });
});
</file>

<file path="frontend/src/stores/uiPrefsStore.ts">
/**
 * Unknown World - UI ì„¤ì • ìƒíƒœ ê´€ë¦¬ (Zustand + persist) (U-116[Mvp]).
 *
 * UI ìŠ¤ì¼€ì¼ ì„¤ì •ì„ LocalStorageì— ì˜ì†í™”í•©ë‹ˆë‹¤.
 * U-116: SaveGame ì‹œìŠ¤í…œ ì œê±°ì— ë”°ë¼ ë…ë¦½ì ì¸ persist ìŠ¤í† ì–´ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - PRD 9.4: ê°€ë…ì„±(í•„ìˆ˜) - ì „ì—­ UI ìŠ¤ì¼€ì¼ ì¡°ì ˆ ì œê³µ
 *   - U-037: Readable ëª¨ë“œ ì œê±° â†’ critical/ambient ì¤‘ìš”ë„ ê¸°ë°˜ ìŠ¤íƒ€ì¼ë¡œ ëŒ€ì²´
 *   - U-116: SaveGame í†µí•© ë¡œì§ ì œê±°
 *
 * @module stores/uiPrefsStore
 */

import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';

// =============================================================================
// ìƒìˆ˜ ì •ì˜
// =============================================================================

/** ì§€ì›í•˜ëŠ” UI ìŠ¤ì¼€ì¼ ê°’ */
export const UI_SCALES = [0.9, 1.0, 1.1, 1.2] as const;
export type UIScale = (typeof UI_SCALES)[number];

/** ê¸°ë³¸ UI ìŠ¤ì¼€ì¼ */
export const DEFAULT_UI_SCALE: UIScale = 1.0;

/** localStorage í‚¤ */
export const UI_PREFS_STORAGE_KEY = 'unknown-world-ui-prefs';

// =============================================================================
// ìƒíƒœ íƒ€ì… ì •ì˜
// =============================================================================

/** UI ì„¤ì • ìƒíƒœ */
export interface UIPrefsState {
  /**
   * UI ìŠ¤ì¼€ì¼ (0.9 ~ 1.2)
   * - 0.9: ì‘ì€ UI (ì •ë³´ ë°€ë„ ë†’ìŒ)
   * - 1.0: ê¸°ë³¸
   * - 1.1: ì•½ê°„ í™•ëŒ€
   * - 1.2: í° UI (ê°€ë…ì„± ìš°ì„ )
   */
  uiScale: UIScale;
}

/** UI ì„¤ì • ì•¡ì…˜ */
export interface UIPrefsActions {
  /** UI ìŠ¤ì¼€ì¼ ì„¤ì • */
  setUIScale: (scale: UIScale) => void;

  /** UI ìŠ¤ì¼€ì¼ ì¦ê°€ (ìµœëŒ€ 1.2) */
  increaseUIScale: () => void;

  /** UI ìŠ¤ì¼€ì¼ ê°ì†Œ (ìµœì†Œ 0.9) */
  decreaseUIScale: () => void;

  /** ì„¤ì • ì´ˆê¸°í™” */
  resetPrefs: () => void;
}

export type UIPrefsStore = UIPrefsState & UIPrefsActions;

// =============================================================================
// ì´ˆê¸° ìƒíƒœ
// =============================================================================

/** ì´ˆê¸° ìƒíƒœ ìƒì„± */
function createInitialState(): UIPrefsState {
  return {
    uiScale: DEFAULT_UI_SCALE,
  };
}

// =============================================================================
// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
// =============================================================================

/**
 * ì£¼ì–´ì§„ ìŠ¤ì¼€ì¼ì´ ìœ íš¨í•œì§€ í™•ì¸
 */
function isValidScale(scale: number): scale is UIScale {
  return UI_SCALES.includes(scale as UIScale);
}

/**
 * ìŠ¤ì¼€ì¼ ì¸ë±ìŠ¤ ë°˜í™˜
 */
function getScaleIndex(scale: UIScale): number {
  return UI_SCALES.indexOf(scale);
}

/**
 * U-037: legacy ì €ì¥ê°’(readableMode) ë§ˆì´ê·¸ë ˆì´ì…˜/ë¬´ì‹œ
 * @internal exported for testing
 */
export function migrateUIPrefs(persistedState: unknown, version: number | undefined): UIPrefsState {
  // version 0 ë˜ëŠ” undefinedì—ì„œ version 1ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜
  // readableMode í•„ë“œê°€ ìˆìœ¼ë©´ ì œê±°
  if (version === 0 || version === undefined) {
    const state = persistedState as Record<string, unknown>;
    // readableMode í•„ë“œ ì œê±° (ë¬´ì‹œ)
    if ('readableMode' in state) {
      const { readableMode: _, ...rest } = state;
      return { ...rest, uiScale: state.uiScale ?? DEFAULT_UI_SCALE } as UIPrefsState;
    }
    return { ...state, uiScale: state.uiScale ?? DEFAULT_UI_SCALE } as UIPrefsState;
  }
  return persistedState as UIPrefsState;
}

// =============================================================================
// Zustand Store with persist
// =============================================================================

/**
 * UI ì„¤ì • ìŠ¤í† ì–´.
 *
 * U-037: Readable ëª¨ë“œ ì œê±°ë¨. CRT íš¨ê³¼ëŠ” critical/ambient ì¤‘ìš”ë„ ê¸°ë°˜ìœ¼ë¡œ ìë™ ì ìš©ë©ë‹ˆë‹¤.
 *
 * @example
 * ```tsx
 * // ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©
 * const { uiScale, setUIScale } = useUIPrefsStore();
 *
 * // DOM ì ìš© (App.tsxì—ì„œ)
 * useEffect(() => {
 *   document.documentElement.dataset.uiScale = uiScale.toString();
 *   document.documentElement.style.setProperty('--ui-scale-factor', uiScale.toString());
 * }, [uiScale]);
 * ```
 */
export const useUIPrefsStore = create<UIPrefsStore>()(
  persist(
    (set, get) => ({
      // ì´ˆê¸° ìƒíƒœ
      ...createInitialState(),

      // ì•¡ì…˜
      setUIScale: (scale) => {
        if (isValidScale(scale)) {
          set({ uiScale: scale });
        }
      },

      increaseUIScale: () => {
        const currentIndex = getScaleIndex(get().uiScale);
        const nextIndex = Math.min(currentIndex + 1, UI_SCALES.length - 1);
        set({ uiScale: UI_SCALES[nextIndex] });
      },

      decreaseUIScale: () => {
        const currentIndex = getScaleIndex(get().uiScale);
        const prevIndex = Math.max(currentIndex - 1, 0);
        set({ uiScale: UI_SCALES[prevIndex] });
      },

      resetPrefs: () => {
        set(createInitialState());
      },
    }),
    {
      name: UI_PREFS_STORAGE_KEY,
      storage: createJSONStorage(() => localStorage),
      // ì§ë ¬í™”í•  í•„ë“œ ì§€ì • (ì•¡ì…˜ ì œì™¸)
      partialize: (state) => ({
        uiScale: state.uiScale,
      }),
      // U-037: legacy ì €ì¥ê°’(readableMode) ë§ˆì´ê·¸ë ˆì´ì…˜/ë¬´ì‹œ
      version: 1,
      migrate: migrateUIPrefs,
    },
  ),
);

// =============================================================================
// ì…€ë ‰í„° (ì„±ëŠ¥ ìµœì í™”ìš©)
// =============================================================================

/** UI ìŠ¤ì¼€ì¼ ì…€ë ‰í„° */
export const selectUIScale = (state: UIPrefsStore) => state.uiScale;

// =============================================================================
// DOM ì ìš© í—¬í¼
// =============================================================================

/**
 * CSS ë³€ìˆ˜ë¡œ UI ìŠ¤ì¼€ì¼ ì ìš©
 * í˜¸ì¶œ ì‹œ html ìš”ì†Œì— --ui-scale-factor ë³€ìˆ˜ë¥¼ ì„¤ì •
 */
export function applyUIScaleToDOM(scale: UIScale): void {
  document.documentElement.style.setProperty('--ui-scale-factor', scale.toString());
  document.documentElement.dataset.uiScale = scale.toString();
}

/**
 * ì „ì²´ UI ì„¤ì • DOM ì ìš©
 * U-037: readableMode ì œê±°ë¨ - ìŠ¤ì¼€ì¼ë§Œ ì ìš©
 */
export function applyUIPrefsToDOM(state: UIPrefsState): void {
  applyUIScaleToDOM(state.uiScale);
}
</file>

<file path="frontend/src/stores/worldStore.u066.test.ts">
import { describe, it, expect, beforeEach } from 'vitest';
import { useWorldStore } from './worldStore';

describe('worldStore (U-066: Late-binding Image)', () => {
  beforeEach(() => {
    useWorldStore.getState().reset();
  });

  it('setImageLoadingì´ ì˜¬ë°”ë¥¸ ìƒíƒœë¥¼ ì„¤ì •í•´ì•¼ í•œë‹¤', () => {
    const turnId = 5;
    useWorldStore.getState().setImageLoading(turnId);

    const state = useWorldStore.getState();
    expect(state.sceneState.imageLoading).toBe(true);
    expect(state.sceneState.pendingImageTurnId).toBe(turnId);
    expect(state.sceneState.sceneRevision).toBe(turnId);
  });

  it('applyLateBindingImageê°€ ì¼ì¹˜í•˜ëŠ” turnIdì— ëŒ€í•´ ì´ë¯¸ì§€ë¥¼ ì ìš©í•´ì•¼ í•œë‹¤', () => {
    const turnId = 5;
    const imageUrl = 'https://example.com/image.png';

    // 1. ë¡œë”© ì‹œì‘
    useWorldStore.getState().setImageLoading(turnId);

    // 2. ì´ë¯¸ì§€ ì ìš©
    const applied = useWorldStore.getState().applyLateBindingImage(imageUrl, turnId);

    expect(applied).toBe(true);
    const state = useWorldStore.getState();
    expect(state.sceneState.status).toBe('scene');
    expect(state.sceneState.imageUrl).toBe(imageUrl);
    expect(state.sceneState.imageLoading).toBe(false);
    expect(state.sceneState.pendingImageTurnId).toBeUndefined();
  });

  it('applyLateBindingImageê°€ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” turnIdì— ëŒ€í•´ ì´ë¯¸ì§€ë¥¼ ë¬´ì‹œí•´ì•¼ í•œë‹¤', () => {
    const oldTurnId = 5;
    const newTurnId = 6;
    const oldImageUrl = 'https://example.com/old.png';

    // 1. ì´ì „ í„´ ë¡œë”© ì‹œì‘
    useWorldStore.getState().setImageLoading(oldTurnId);

    // 2. ìƒˆ í„´ ì‹œì‘ (ë¡œë”© ìƒíƒœ ë®ì–´ì”€)
    useWorldStore.getState().setImageLoading(newTurnId);

    // 3. ì´ì „ í„´ì˜ ì´ë¯¸ì§€ê°€ ë„ì°©í•¨
    const applied = useWorldStore.getState().applyLateBindingImage(oldImageUrl, oldTurnId);

    expect(applied).toBe(false);
    const state = useWorldStore.getState();
    expect(state.sceneState.pendingImageTurnId).toBe(newTurnId); // ì—¬ì „íˆ ìƒˆ í„´ ëŒ€ê¸° ì¤‘
    expect(state.sceneState.imageUrl).not.toBe(oldImageUrl);
  });

  it('cancelImageLoadingì´ ë¡œë”© ìƒíƒœë¥¼ í•´ì œí•˜ê³  ì´ì „ ì´ë¯¸ì§€ë¥¼ ìœ ì§€í•´ì•¼ í•œë‹¤', () => {
    const turnId = 5;
    const initialImageUrl = 'https://example.com/initial.png';

    // ì´ˆê¸° ì´ë¯¸ì§€ ì„¤ì •
    useWorldStore.setState({
      sceneState: { status: 'scene', imageUrl: initialImageUrl },
    });

    // ë¡œë”© ì‹œì‘
    useWorldStore.getState().setImageLoading(turnId);
    expect(useWorldStore.getState().sceneState.imageLoading).toBe(true);
    expect(useWorldStore.getState().sceneState.previousImageUrl).toBe(initialImageUrl);

    // ë¡œë”© ì·¨ì†Œ
    useWorldStore.getState().cancelImageLoading();

    const state = useWorldStore.getState();
    expect(state.sceneState.imageLoading).toBe(false);
    expect(state.sceneState.imageUrl).toBe(initialImageUrl);
    expect(state.sceneState.previousImageUrl).toBeUndefined();
  });
});
</file>

<file path="frontend/src/styles/interaction-hint.css">
/**
 * Unknown World - ì¸í„°ë™ì…˜ íŒíŠ¸ ìŠ¤íƒ€ì¼
 *
 * U-074[Mvp]: í•«ìŠ¤íŒŸ/ì•„ì´í…œ ì¸í„°ë™ì…˜ ì•ˆë‚´ UX
 * - íŒíŠ¸ íˆ´íŒ ìŠ¤íƒ€ì¼ (í´ë¦­/ë“œë˜ê·¸ íŒíŠ¸)
 * - CRT í…Œë§ˆ ì¼ê´€ì„± ìœ ì§€
 *
 * @see vibe/ref/frontend-style-guide.md
 */

/* ============================================
   1. ì¸í„°ë™ì…˜ íŒíŠ¸ ê¸°ë³¸ ìŠ¤íƒ€ì¼
   ============================================ */

.interaction-hint {
  position: absolute;
  z-index: 30;
  pointer-events: none;
  animation: hint-fade-in 0.2s ease-out;
}

@keyframes hint-fade-in {
  from {
    opacity: 0;
    transform: translateY(4px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* ============================================
   2. íŒíŠ¸ ë‚´ìš© ì»¨í…Œì´ë„ˆ
   ============================================ */

.interaction-hint-content {
  display: inline-flex;
  align-items: center;
  gap: var(--spacing-xs);
  padding: var(--spacing-xs) var(--spacing-sm);
  background-color: rgba(0, 255, 128, 0.12);
  border: 1px solid var(--accent-color);
  border-radius: 3px;
  box-shadow:
    0 0 8px rgba(0, 255, 128, 0.3),
    0 2px 8px rgba(0, 0, 0, 0.6);
  white-space: nowrap;
}

/* ============================================
   3. íŒíŠ¸ í…ìŠ¤íŠ¸
   ============================================ */

.interaction-hint-text {
  font-size: var(--font-size-xs);
  font-weight: 600;
  color: var(--accent-color);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  text-shadow: 0 0 4px rgba(0, 255, 128, 0.4);
}

/* ============================================
   4. íŒíŠ¸ ì•„ì´ì½˜
   ============================================ */

.interaction-hint-icon {
  width: 14px;
  height: 14px;
  color: var(--accent-color);
  flex-shrink: 0;
  filter: drop-shadow(0 0 2px rgba(0, 255, 128, 0.4));
}

/* ============================================
   5. ìœ„ì¹˜ ë³€í˜• (top/bottom/left/right)
   ============================================ */

/* ìƒë‹¨ (ê¸°ë³¸) */
.interaction-hint--top {
  bottom: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
}

.interaction-hint--top .interaction-hint-content::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 5px solid transparent;
  border-top-color: var(--accent-color);
}

/* í•˜ë‹¨ */
.interaction-hint--bottom {
  top: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
}

.interaction-hint--bottom .interaction-hint-content::after {
  content: '';
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 5px solid transparent;
  border-bottom-color: var(--accent-color);
}

/* ì¢Œì¸¡ */
.interaction-hint--left {
  top: 50%;
  right: calc(100% + 8px);
  transform: translateY(-50%);
}

.interaction-hint--left .interaction-hint-content::after {
  content: '';
  position: absolute;
  left: 100%;
  top: 50%;
  transform: translateY(-50%);
  border: 5px solid transparent;
  border-left-color: var(--accent-color);
}

/* ìš°ì¸¡ */
.interaction-hint--right {
  top: 50%;
  left: calc(100% + 8px);
  transform: translateY(-50%);
}

.interaction-hint--right .interaction-hint-content::after {
  content: '';
  position: absolute;
  right: 100%;
  top: 50%;
  transform: translateY(-50%);
  border: 5px solid transparent;
  border-right-color: var(--accent-color);
}

/* ============================================
   6. í•«ìŠ¤íŒŸìš© íŒíŠ¸ (ë§ˆì  íƒ€ í…Œë§ˆ)
   ============================================ */

.interaction-hint--hotspot .interaction-hint-content {
  background-color: rgba(224, 64, 251, 0.15);
  border-color: var(--hotspot-primary);
  box-shadow:
    0 0 8px var(--hotspot-glow),
    0 2px 8px rgba(0, 0, 0, 0.6);
}

.interaction-hint--hotspot .interaction-hint-text {
  color: var(--hotspot-primary);
  text-shadow: 0 0 4px rgba(224, 64, 251, 0.4);
}

.interaction-hint--hotspot .interaction-hint-icon {
  color: var(--hotspot-primary);
  filter: drop-shadow(0 0 2px rgba(224, 64, 251, 0.4));
}

.interaction-hint--hotspot.interaction-hint--top .interaction-hint-content::after {
  border-top-color: var(--hotspot-primary);
}

.interaction-hint--hotspot.interaction-hint--bottom .interaction-hint-content::after {
  border-bottom-color: var(--hotspot-primary);
}

/* ============================================
   7. ì¸ë²¤í† ë¦¬ìš© íŒíŠ¸ (ê¸°ë³¸ ê·¸ë¦° í…Œë§ˆ)
   ============================================ */

.interaction-hint--inventory .interaction-hint-content {
  background-color: rgba(0, 255, 128, 0.12);
  border-color: var(--accent-color);
}

/* ============================================
   8. ë°˜ì‘í˜• ì¡°ì •
   ============================================ */

@media (max-width: 768px) {
  .interaction-hint-content {
    padding: 4px 8px;
  }

  .interaction-hint-text {
    font-size: 10px;
  }

  .interaction-hint-icon {
    width: 12px;
    height: 12px;
  }
}

/* ============================================
   9. ì ‘ê·¼ì„±: reduced-motion
   ============================================ */

@media (prefers-reduced-motion: reduce) {
  .interaction-hint {
    animation: none;
  }
}

/* ============================================
   10. ê³ ëŒ€ë¹„ ëª¨ë“œ
   ============================================ */

@media (prefers-contrast: more) {
  .interaction-hint-content {
    border-width: 2px;
    background-color: rgba(0, 0, 0, 0.9);
  }
}
</file>

<file path="frontend/src/turn/turnRunner.test.ts">
import { describe, it, expect, vi, beforeEach, type Mock } from 'vitest';
import { createTurnRunner } from './turnRunner';
import type { TurnInput } from '../schemas/turn';
import type { StreamCallbacks } from '../api/turnStream';

// ëª¨í‚¹
vi.mock('../api/turnStream', () => ({
  startTurnStream: vi.fn(() => vi.fn()),
}));

vi.mock('../api/image', () => ({
  startImageGeneration: vi.fn(),
}));

const mockWorldStore = {
  economy: { signal: 100, memory_shard: 5 },
  sceneState: { status: 'scene', imageUrl: 'old-url.png' },
  setIsAnalyzing: vi.fn(),
  setSceneState: vi.fn(),
  setProcessingPhase: vi.fn(),
  turnCount: 1,
};

vi.mock('../stores/worldStore', () => ({
  useWorldStore: {
    getState: vi.fn(() => mockWorldStore),
  },
}));

vi.mock('../stores/agentStore', () => ({
  useAgentStore: {
    getState: vi.fn(() => ({
      isStreaming: false,
      startStream: vi.fn(),
      completeStream: vi.fn(),
      handleStage: vi.fn(),
      handleBadges: vi.fn(),
      handleNarrativeDelta: vi.fn(),
      handleFinal: vi.fn(),
      handleError: vi.fn(),
    })),
  },
}));

vi.mock('react-i18next', () => ({
  useTranslation: () => ({
    t: (key: string) => key,
  }),
}));

describe('turnRunner (U-089[Mvp])', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('ì •ë°€ë¶„ì„ í‚¤ì›Œë“œ ê°ì§€ ì‹œ isAnalyzingì„ trueë¡œ ì„¤ì •í•´ì•¼ í•¨', () => {
    const runner = createTurnRunner({
      t: (key: string) => key,
      theme: 'dark',
      language: 'ko-KR',
    });

    // 1. "ì •ë°€ë¶„ì„" í…ìŠ¤íŠ¸ ì…ë ¥
    runner.runTurn({ text: 'ì •ë°€ë¶„ì„ í•´ì¤˜' });
    expect(mockWorldStore.setIsAnalyzing).toHaveBeenCalledWith(true);

    // 2. ì¼ë°˜ í…ìŠ¤íŠ¸ ì…ë ¥ ì‹œì—ëŠ” ì„¤ì •í•˜ì§€ ì•Šì•„ì•¼ í•¨
    vi.clearAllMocks();
    runner.runTurn({ text: 'ì•ˆë…•í•˜ì„¸ìš”' });
    expect(mockWorldStore.setIsAnalyzing).not.toHaveBeenCalled();
  });

  it('ì •ë°€ë¶„ì„ actionId ê°ì§€ ì‹œ isAnalyzingì„ trueë¡œ ì„¤ì •í•´ì•¼ í•¨', () => {
    const runner = createTurnRunner({
      t: (key: string) => key,
      theme: 'dark',
      language: 'ko-KR',
    });

    runner.runTurn({ text: '', actionId: 'deep_analyze' });
    expect(mockWorldStore.setIsAnalyzing).toHaveBeenCalledWith(true);
  });

  it('ì •ë°€ë¶„ì„ ì¤‘ì—ëŠ” setSceneState({status: "loading"})ì„ í˜¸ì¶œí•˜ì§€ ì•Šì•„ì•¼ í•¨ (ê¸°ì¡´ ì´ë¯¸ì§€ ìœ ì§€)', () => {
    const runner = createTurnRunner({
      t: (key: string) => key,
      theme: 'dark',
      language: 'ko-KR',
    });

    runner.runTurn({ text: 'ì •ë°€ë¶„ì„' });

    // isAnalyzingì€ true
    expect(mockWorldStore.setIsAnalyzing).toHaveBeenCalledWith(true);
    // status: 'loading'ì€ í˜¸ì¶œë˜ì§€ ì•Šì•„ì•¼ í•¨
    expect(mockWorldStore.setSceneState).not.toHaveBeenCalledWith(
      expect.objectContaining({ status: 'loading' }),
    );
  });

  it('í„´ ì™„ë£Œ ì‹œ ìµœì†Œ í‘œì‹œ ì‹œê°„ ì´í›„ isAnalyzingì„ falseë¡œ ì„¤ì •í•´ì•¼ í•¨', async () => {
    vi.useFakeTimers();
    const runner = createTurnRunner({
      t: (key: string) => key,
      theme: 'dark',
      language: 'ko-KR',
    });

    const { startTurnStream } = (await import('../api/turnStream')) as unknown as {
      startTurnStream: Mock;
    };
    let completeCallback: () => void = () => {};

    startTurnStream.mockImplementation((_input: TurnInput, callbacks: StreamCallbacks) => {
      completeCallback = callbacks.onComplete!;
      return vi.fn();
    });

    runner.runTurn({ text: 'ì •ë°€ë¶„ì„' });
    expect(mockWorldStore.setIsAnalyzing).toHaveBeenCalledWith(true);

    // í„´ ì™„ë£Œ í˜¸ì¶œ
    completeCallback();

    // ì¦‰ì‹œëŠ” falseê°€ ë˜ì§€ ì•Šì•„ì•¼ í•¨ (ìµœì†Œ í‘œì‹œ ì‹œê°„ ë•Œë¬¸)
    expect(mockWorldStore.setIsAnalyzing).not.toHaveBeenLastCalledWith(false);

    // 500ms ê²½ê³¼ í›„
    vi.advanceTimersByTime(500);
    expect(mockWorldStore.setIsAnalyzing).toHaveBeenLastCalledWith(false);

    vi.useRealTimers();
  });
});
</file>

<file path="frontend/src/utils/imageSizing.test.ts">
import { describe, it, expect } from 'vitest';
import { selectImageSizing, getDefaultImageSizing } from './imageSizing';

describe('imageSizing utils', () => {
  describe('selectImageSizing', () => {
    it('should select 16:9 for landscape aspect ratio', () => {
      const result = selectImageSizing(1920, 1080);
      expect(result.aspectRatio).toBe('16:9');
      expect(result.imageSize).toBe('1K');
    });

    it('should select 1:1 for square aspect ratio', () => {
      const result = selectImageSizing(1000, 1000);
      expect(result.aspectRatio).toBe('1:1');
    });

    it('should select 9:16 for portrait aspect ratio', () => {
      const result = selectImageSizing(1080, 1920);
      expect(result.aspectRatio).toBe('9:16');
    });

    it('should select 21:9 for ultra-wide aspect ratio', () => {
      const result = selectImageSizing(2560, 1080);
      expect(result.aspectRatio).toBe('21:9');
    });

    it('should select 2:3 for vertical aspect ratio', () => {
      const result = selectImageSizing(600, 900);
      expect(result.aspectRatio).toBe('2:3');
    });

    it('should select 4:3 for traditional monitor aspect ratio', () => {
      const result = selectImageSizing(1024, 768);
      expect(result.aspectRatio).toBe('4:3');
    });

    it('should select closest ratio for slightly off dimensions', () => {
      // 800/450 = 1.777... (16:9)
      // 810/450 = 1.8
      const result = selectImageSizing(810, 450);
      expect(result.aspectRatio).toBe('16:9');
    });

    it('should fallback to default for invalid dimensions', () => {
      const defaultSizing = getDefaultImageSizing();

      expect(selectImageSizing(0, 100)).toEqual(defaultSizing);
      expect(selectImageSizing(100, 0)).toEqual(defaultSizing);
      expect(selectImageSizing(40, 40)).toEqual(defaultSizing); // MIN_VALID_DIMENSION is 50
      expect(selectImageSizing(NaN, 100)).toEqual(defaultSizing);
    });

    it('should generate correct label', () => {
      const result = selectImageSizing(1920, 1080);
      expect(result.label).toBe('IMAGE 16:9@1K');
    });
  });

  describe('getDefaultImageSizing', () => {
    it('should return 16:9 and 1K as default', () => {
      const result = getDefaultImageSizing();
      expect(result.aspectRatio).toBe('16:9');
      expect(result.imageSize).toBe('1K');
    });
  });
});
</file>

<file path="frontend/src/utils/imageSizing.ts">
/**
 * Unknown World - Scene Canvas í¬ê¸° â†’ (aspect_ratio, image_size) ì„ íƒ ìœ í‹¸
 *
 * U-085[Mvp]: ì´ë¯¸ì§€ í¬ê¸°ë¥¼ í˜„ì¬ UI ë ˆì´ì•„ì›ƒ(Scene Canvas)ì— ìµœëŒ€í•œ ë§ì¶¤ìœ¼ë¡œ ìƒì„±
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - RULE-009: ì¢Œí‘œ ê·œì•½(0~1000) ë¬´ê´€ (ë¹„ìœ¨ë§Œ ì œì–´)
 *   - RULE-010: ì§€ì› ë¹„ìœ¨/í¬ê¸°ëŠ” SDK SSOTì— ê³ ì •
 *   - í˜ì–´ë§ Q1: UI ë ˆì´ì•„ì›ƒ ìš°ì„  (image_job.aspect_ratioë³´ë‹¤ ìš°ì„ )
 *   - í˜ì–´ë§ Q2: image_sizeëŠ” SDK ê°’ (1K/2K/4K) ì‚¬ìš©
 *
 * ì°¸ì¡°:
 *   - vibe/ref/image-generate-guide.md: "1:1","2:3","3:2","3:4","4:3","4:5","5:4","9:16","16:9","21:9"
 *   - image_size: "1K" | "2K" | "4K" (ëŒ€ë¬¸ì K í•„ìˆ˜)
 *
 * @module utils/imageSizing
 */

// =============================================================================
// íƒ€ì… ì •ì˜
// =============================================================================

/** SDKê°€ ì§€ì›í•˜ëŠ” aspect_ratio ë¬¸ìì—´ */
export type SupportedAspectRatio =
  | '1:1'
  | '2:3'
  | '3:2'
  | '3:4'
  | '4:3'
  | '4:5'
  | '5:4'
  | '9:16'
  | '16:9'
  | '21:9';

/** SDKê°€ ì§€ì›í•˜ëŠ” image_size ê°’ */
export type SupportedImageSize = '1K' | '2K' | '4K';

/** ì´ë¯¸ì§€ ì‚¬ì´ì§• ê²°ê³¼ */
export interface ImageSizingResult {
  /** ì„ íƒëœ ê°€ë¡œì„¸ë¡œ ë¹„ìœ¨ */
  aspectRatio: SupportedAspectRatio;
  /** ì„ íƒëœ ì´ë¯¸ì§€ í¬ê¸° (SDK ê°’) */
  imageSize: SupportedImageSize;
  /** ë””ë²„ê·¸/ë¡œê·¸ìš© ë¼ë²¨ (ì˜ˆ: "IMAGE 16:9@1K") */
  label: string;
}

// =============================================================================
// ìƒìˆ˜ ì •ì˜
// =============================================================================

/**
 * ì§€ì›í•˜ëŠ” aspect_ratio í›„ë³´ì™€ ì‹¤ìˆ˜ ë¹„ìœ¨ê°’ ë§¤í•‘.
 * SDK ê³µì‹ ì§€ì› ë¹„ìœ¨: "1:1","2:3","3:2","3:4","4:3","4:5","5:4","9:16","16:9","21:9"
 *
 * ê²Œì„ UIì—ì„œëŠ” ê°€ë¡œ ë ˆì´ì•„ì›ƒì´ ì¼ë°˜ì ì´ë¯€ë¡œ 16:9ë¥¼ ìš°ì„  í›„ë³´ë¡œ ë°°ì¹˜.
 */
const ASPECT_RATIO_MAP: ReadonlyArray<{
  ratio: SupportedAspectRatio;
  value: number;
}> = [
  { ratio: '21:9', value: 21 / 9 }, // 2.333
  { ratio: '16:9', value: 16 / 9 }, // 1.778
  { ratio: '3:2', value: 3 / 2 }, // 1.500
  { ratio: '4:3', value: 4 / 3 }, // 1.333
  { ratio: '5:4', value: 5 / 4 }, // 1.250
  { ratio: '1:1', value: 1 / 1 }, // 1.000
  { ratio: '4:5', value: 4 / 5 }, // 0.800
  { ratio: '3:4', value: 3 / 4 }, // 0.750
  { ratio: '2:3', value: 2 / 3 }, // 0.667
  { ratio: '9:16', value: 9 / 16 }, // 0.563
];

/**
 * ê¸°ë³¸ ì´ë¯¸ì§€ ì‚¬ì´ì§• ê²°ê³¼.
 * ì¸¡ì • ì‹¤íŒ¨/ë¹„ì •ìƒ ê°’ ì‹œ ì•ˆì „í•œ í´ë°±.
 */
const DEFAULT_SIZING: ImageSizingResult = {
  aspectRatio: '16:9',
  imageSize: '1K',
  label: 'IMAGE 16:9@1K',
};

/**
 * ìœ íš¨í•œ Scene Canvas í¬ê¸° ìµœì†Œê°’ (px).
 * ì´ë³´ë‹¤ ì‘ìœ¼ë©´ ì¸¡ì • ì‹¤íŒ¨ë¡œ ê°„ì£¼í•˜ê³  ê¸°ë³¸ê°’ ì‚¬ìš©.
 */
const MIN_VALID_DIMENSION = 50;

// =============================================================================
// í•µì‹¬ í•¨ìˆ˜
// =============================================================================

/**
 * Scene Canvas í‘œì‹œ í¬ê¸°(px)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìµœì ì˜ aspect_ratioì™€ image_sizeë¥¼ ì„ íƒí•©ë‹ˆë‹¤.
 *
 * - ì§€ì› í›„ë³´ ì¤‘ "ê°€ì¥ ê°€ê¹Œìš´ ë¹„ìœ¨"ì„ ì„ íƒí•©ë‹ˆë‹¤.
 * - image_sizeëŠ” MVPì—ì„œ '1K'ë¡œ ê³ ì •í•©ë‹ˆë‹¤ (ë¹„ìš© íš¨ìœ¨, ë°ëª¨ ì²´ê° ì¶©ë¶„).
 * - ì¸¡ì • ì‹¤íŒ¨(0 ë˜ëŠ” ë¹„ì •ìƒ ê°’) ì‹œ ê¸°ë³¸ê°’(16:9 + 1K)ìœ¼ë¡œ í´ë°±í•©ë‹ˆë‹¤.
 *
 * @param width - Scene Canvas ë„ˆë¹„ (px)
 * @param height - Scene Canvas ë†’ì´ (px)
 * @returns ì„ íƒëœ aspect_ratio, image_size, ë¡œê·¸ ë¼ë²¨
 *
 * @example
 * ```ts
 * const result = selectImageSizing(800, 450);
 * // { aspectRatio: '16:9', imageSize: '1K', label: 'IMAGE 16:9@1K' }
 *
 * const result2 = selectImageSizing(600, 800);
 * // { aspectRatio: '3:4', imageSize: '1K', label: 'IMAGE 3:4@1K' }
 * ```
 */
export function selectImageSizing(width: number, height: number): ImageSizingResult {
  // ìœ íš¨ì„± ê²€ì‚¬: ë¹„ì •ìƒ ê°’ì´ë©´ ê¸°ë³¸ê°’ í´ë°±
  if (
    !Number.isFinite(width) ||
    !Number.isFinite(height) ||
    width < MIN_VALID_DIMENSION ||
    height < MIN_VALID_DIMENSION
  ) {
    return DEFAULT_SIZING;
  }

  // ëª©í‘œ ë¹„ìœ¨ ê³„ì‚°
  const targetRatio = width / height;

  // ê°€ì¥ ê°€ê¹Œìš´ ë¹„ìœ¨ ì°¾ê¸° (ì ˆëŒ€ ì°¨ì´ ìµœì†Œí™”)
  let bestMatch = ASPECT_RATIO_MAP[0];
  let bestDiff = Math.abs(targetRatio - bestMatch.value);

  for (let i = 1; i < ASPECT_RATIO_MAP.length; i++) {
    const diff = Math.abs(targetRatio - ASPECT_RATIO_MAP[i].value);
    if (diff < bestDiff) {
      bestDiff = diff;
      bestMatch = ASPECT_RATIO_MAP[i];
    }
  }

  // MVPì—ì„œëŠ” 1K ê³ ì • (ë¹„ìš© íš¨ìœ¨ + ë°ëª¨ ì²´ê° ì¶©ë¶„)
  // MMPì—ì„œ í•´ìƒë„ ìë™ ì„ íƒ ë„ì… ê°€ëŠ¥
  const imageSize: SupportedImageSize = '1K';

  return {
    aspectRatio: bestMatch.ratio,
    imageSize,
    label: `IMAGE ${bestMatch.ratio}@${imageSize}`,
  };
}

/**
 * ê¸°ë³¸ ì´ë¯¸ì§€ ì‚¬ì´ì§• ê²°ê³¼ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
 * Scene Canvas í¬ê¸°ë¥¼ ì•„ì§ ì¸¡ì •í•˜ì§€ ëª»í•œ ê²½ìš° ì‚¬ìš©í•©ë‹ˆë‹¤.
 */
export function getDefaultImageSizing(): ImageSizingResult {
  return { ...DEFAULT_SIZING };
}
</file>

<file path="package.json">
{
  "name": "unknown-world",
  "version": "0.1.0",
  "private": true,
  "description": "Unknown World - Gemini ê¸°ë°˜ ì—ì´ì „íŠ¸í˜• ê²Œì„ ì—”ì§„",
  "packageManager": "pnpm@10.27.0",
  "engines": {
    "node": "24.12.0"
  },
  "scripts": {
    "kill": "pnpm kill:port && pnpm kill:zombies",
    "kill:port": "npx --yes kill-port 8001 8002 8003 8004 8005 8006 8007 8008 8009 8010 8011 8012 8013 8014 8015 8016 8017 8018 8019 8020",
    "kill:zombies": "bash scripts/kill-zombies.sh",
    "kill:front": "npx --yes kill-port 8001 8002 8003 8004 8005 8006 8007 8008 8009 8010",
    "kill:back": "npx --yes kill-port 8011 8012 8013 8014 8015 8016 8017 8018 8019 8020",
    "dev:back": "cd backend && uv run uvicorn unknown_world.main:app --reload --port 8011",
    "dev:front": "pnpm -C frontend dev"
  }
}
</file>

<file path="backend/prompts/image/scene_prompt.en.md">
<prompt_meta>
  <prompt_id>scene_image_generation</prompt_id>
  <language>en-US</language>
  <version>0.2.0</version>
  <last_updated>2026-01-28</last_updated>
  <policy_preset>default</policy_preset>
</prompt_meta>

<prompt_body>
## Purpose

Prompt template for generating in-game scene images.
Creates visual representations that match the text narrative in a consistent style.

## Inputs

- narrative: Current turn's narrative text
- scene_description: Scene description (optional)
- style_hints: Style hints (optional)
- previous_scene_context: Previous scene context (for consistency)

## Output Contract (Summary)

- Image generation prompts are written in **English** (model optimization).
- Always include base style keywords for consistency.
- Minimize negative prompts; describe the desired scene positively.

---

## System Instructions

You are the image prompt generator for "Unknown World" game.
Based on the given narrative and scene description, create prompts for the Gemini image generation model.

### Base Style Guidelines

1. **Art Style**: Dark fantasy, mystery, roguelike atmosphere
2. **Color Palette**: Dark and muted tones, neon accents (harmonizing with CRT theme)
3. **Lighting**: Dramatic contrast, rim lighting, atmospheric illumination
4. **Composition**: Cinematic, prefer wide or medium shots

### Prompt Structure

```
[Subject/Scene Description], [Art Style], [Lighting/Mood], [Color Tones], [Camera/Composition], [Quality Keywords]
```

### Quality Keywords (Always Include)

- highly detailed
- cinematic lighting
- atmospheric
- dark fantasy aesthetic
- 4k quality

### Prohibited Elements

- Avoid photorealistic style (difficult to maintain consistency)
- No violent/sexual/discriminatory imagery
- Avoid text/letters in images (readability issues)

---

## Example Prompts

### Example 1: Mysterious Forest Entrance

**Input Narrative**: "The old door creaks open. Cold air rushes out from within."

**Generated Prompt**:
```
An ancient wooden door creaking open in a misty forest, cold air flowing out, dark fantasy style, dramatic rim lighting, deep shadows, muted colors with cyan accents, wide shot, atmospheric fog, highly detailed, cinematic composition, 4k quality
```

### Example 2: Interior of a Ruined Castle

**Input Narrative**: "The throne of the crumbling castle gleams under the moonlight."

**Generated Prompt**:
```
A crumbling throne in a ruined castle bathed in moonlight, broken pillars and debris, dark fantasy aesthetic, silver and blue tones, dramatic chiaroscuro lighting, medium shot from below, dust particles in light beams, highly detailed, cinematic atmosphere, 4k quality
```

---

## Important Constraints

- **Prompts in English**: For image generation model optimization
- **Maintain Consistent Style**: Always include base style keywords
- **Safety Policy Compliance**: Exclude inappropriate content elements
</prompt_body>
</file>

<file path="backend/prompts/image/scene_prompt.ko.md">
<prompt_meta>
  <prompt_id>scene_image_generation</prompt_id>
  <language>ko-KR</language>
  <version>0.2.0</version>
  <last_updated>2026-01-28</last_updated>
  <policy_preset>default</policy_preset>
</prompt_meta>

<prompt_body>
## ëª©ì 

ê²Œì„ ë‚´ ì¥ë©´(Scene) ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•œ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ì…ë‹ˆë‹¤.
í…ìŠ¤íŠ¸ ë‚´ëŸ¬í‹°ë¸Œì— ë§ëŠ” ì‹œê°ì  í‘œí˜„ì„ ì¼ê´€ëœ ìŠ¤íƒ€ì¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.

## ì…ë ¥

- narrative: í˜„ì¬ í„´ì˜ ë‚´ëŸ¬í‹°ë¸Œ í…ìŠ¤íŠ¸
- scene_description: ì¥ë©´ ì„¤ëª… (ì„ íƒ)
- style_hints: ìŠ¤íƒ€ì¼ íŒíŠ¸ (ì„ íƒ)
- previous_scene_context: ì´ì „ ì¥ë©´ ë§¥ë½ (ì¼ê´€ì„± ìœ ì§€ìš©)

## ì¶œë ¥ ê³„ì•½ (ìš”ì•½)

- ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸ëŠ” **ì˜ì–´**ë¡œ ì‘ì„±ë©ë‹ˆë‹¤ (ëª¨ë¸ ìµœì í™”).
- ìŠ¤íƒ€ì¼ ì¼ê´€ì„±ì„ ìœ„í•´ ê¸°ë³¸ ìŠ¤íƒ€ì¼ í‚¤ì›Œë“œë¥¼ í•­ìƒ í¬í•¨í•©ë‹ˆë‹¤.
- ë¶€ì • í”„ë¡¬í”„íŠ¸ëŠ” ìµœì†Œí™”í•˜ê³ , ì›í•˜ëŠ” ì¥ë©´ì„ ê¸ì •ì ìœ¼ë¡œ ì„œìˆ í•©ë‹ˆë‹¤.

---

## ì‹œìŠ¤í…œ ì§€ì‹œ

ë‹¹ì‹ ì€ "Unknown World" ê²Œì„ì˜ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ìƒì„±ê¸°ì…ë‹ˆë‹¤.
ì£¼ì–´ì§„ ë‚´ëŸ¬í‹°ë¸Œì™€ ì¥ë©´ ì„¤ëª…ì„ ë°”íƒ•ìœ¼ë¡œ Gemini ì´ë¯¸ì§€ ìƒì„± ëª¨ë¸ì— ì „ë‹¬í•  í”„ë¡¬í”„íŠ¸ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.

### ê¸°ë³¸ ìŠ¤íƒ€ì¼ ê°€ì´ë“œë¼ì¸

1. **ì•„íŠ¸ ìŠ¤íƒ€ì¼**: ë‹¤í¬ íŒíƒ€ì§€, ë¯¸ìŠ¤í„°ë¦¬, ë¡œê·¸ë¼ì´í¬ ë¶„ìœ„ê¸°
2. **ìƒ‰ìƒ íŒ”ë ˆíŠ¸**: ì–´ë‘¡ê³  ì°¨ë¶„í•œ í†¤, ë„¤ì˜¨ ì•…ì„¼íŠ¸ (CRT í…Œë§ˆì™€ ì¡°í™”)
3. **ì¡°ëª…**: ê·¹ì ì¸ ëª…ì•” ëŒ€ë¹„, ë¦¼ ë¼ì´íŠ¸, ë¶„ìœ„ê¸° ìˆëŠ” ì¡°ëª…
4. **êµ¬ë„**: ì‹œë„¤ë§ˆí‹±, ì™€ì´ë“œ ìƒ· ë˜ëŠ” ì¤‘ê°„ ìƒ· ì„ í˜¸

### í”„ë¡¬í”„íŠ¸ êµ¬ì¡°

```
[ì£¼ì œ/ì¥ë©´ ì„¤ëª…], [ì•„íŠ¸ ìŠ¤íƒ€ì¼], [ì¡°ëª…/ë¶„ìœ„ê¸°], [ìƒ‰ìƒ í†¤], [ì¹´ë©”ë¼/êµ¬ë„], [í’ˆì§ˆ í‚¤ì›Œë“œ]
```

### í’ˆì§ˆ í‚¤ì›Œë“œ (ê¸°ë³¸ í¬í•¨)

- highly detailed
- cinematic lighting
- atmospheric
- dark fantasy aesthetic
- 4k quality

### ê¸ˆì§€ ì‚¬í•­

- ì‹¤ì‚¬ ìŠ¤íƒ€ì¼ (photorealistic) ì§€ì–‘ (ì¼ê´€ì„± ìœ ì§€ ì–´ë ¤ì›€)
- í­ë ¥ì /ì„±ì /ì°¨ë³„ì  ì´ë¯¸ì§€ ìš”ì†Œ ê¸ˆì§€
- í…ìŠ¤íŠ¸/ê¸€ì í¬í•¨ ì§€ì–‘ (ê°€ë…ì„± ë¬¸ì œ)

---

## ì˜ˆì‹œ í”„ë¡¬í”„íŠ¸

### ì˜ˆì‹œ 1: ì‹ ë¹„ë¡œìš´ ìˆ² ì…êµ¬

**ì…ë ¥ ë‚´ëŸ¬í‹°ë¸Œ**: "ë‚¡ì€ ë¬¸ì´ ì‚ê±±ê±°ë¦¬ë©° ì—´ë¦½ë‹ˆë‹¤. ì•ˆìª½ì—ì„œ ì°¨ê°€ìš´ ê³µê¸°ê°€ ë°€ë ¤ì˜µë‹ˆë‹¤."

**ìƒì„±ëœ í”„ë¡¬í”„íŠ¸**:
```
An ancient wooden door creaking open in a misty forest, cold air flowing out, dark fantasy style, dramatic rim lighting, deep shadows, muted colors with cyan accents, wide shot, atmospheric fog, highly detailed, cinematic composition, 4k quality
```

### ì˜ˆì‹œ 2: íí—ˆê°€ ëœ ì„±ì˜ ë‚´ë¶€

**ì…ë ¥ ë‚´ëŸ¬í‹°ë¸Œ**: "ë¬´ë„ˆì§„ ì„±ì˜ ì™•ì¢Œê°€ ë‹¬ë¹› ì•„ë˜ ë¹›ë‚˜ê³  ìˆìŠµë‹ˆë‹¤."

**ìƒì„±ëœ í”„ë¡¬í”„íŠ¸**:
```
A crumbling throne in a ruined castle bathed in moonlight, broken pillars and debris, dark fantasy aesthetic, silver and blue tones, dramatic chiaroscuro lighting, medium shot from below, dust particles in light beams, highly detailed, cinematic atmosphere, 4k quality
```

---

## ì¤‘ìš” ì œì•½

- **í”„ë¡¬í”„íŠ¸ëŠ” ì˜ì–´ë¡œ ì‘ì„±**: ì´ë¯¸ì§€ ìƒì„± ëª¨ë¸ ìµœì í™”ë¥¼ ìœ„í•´
- **ì¼ê´€ëœ ìŠ¤íƒ€ì¼ ìœ ì§€**: ê¸°ë³¸ ìŠ¤íƒ€ì¼ í‚¤ì›Œë“œë¥¼ í•­ìƒ í¬í•¨
- **ì•ˆì „ ì •ì±… ì¤€ìˆ˜**: ë¶€ì ì ˆí•œ ì½˜í…ì¸  ìƒì„± ìš”ì†Œ ë°°ì œ
</prompt_body>
</file>

<file path="backend/prompts/system/game_master.en.md">
<prompt_meta>
  <prompt_id>game_master_system</prompt_id>
  <language>en-US</language>
  <version>0.2.0</version>
  <last_updated>2026-01-28</last_updated>
  <policy_preset>default</policy_preset>
</prompt_meta>

<prompt_body>
## Purpose

Act as an agent-style Game Master to generate TurnOutput (JSON).
"Unknown World" is an infinite generative roguelike narrative web game.

## Input

- TurnInput: language, text, action_id, click, client, economy_snapshot
- WorldState: world rules, inventory, quests, relationships, history summary

## Output Contract (Summary)

- Output must satisfy the TurnOutput JSON Schema.
- language is fixed to "en-US" matching the input.
- All text (narrative, label, description, etc.) must be in English.

---

## System Instructions

You are the Game Master of "Unknown World". React to player actions, evolve the world, and generate engaging narratives.

### Core Principles

1. **Consistency**: Adhere to world rules and established settings.
2. **Creativity**: Create unpredictable yet logical developments.
3. **Responsiveness**: Provide meaningful consequences for player choices.
4. **Economy**: Calculate cost and balance_after accurately.

### Narrative Style

- 2-3 sentences of concise, immersive description
- Use present tense
- Include sensory details (sounds, smells, textures)
- Address the player as "you"
- **Important**: Do not directly quote the user's input text in the narrative (prevents language mixing)

### Action Card Generation Rules

- Provide 3-6 choice cards
- Include cost, risk level, and hint for each card
- At least 1 low-cost alternative (is_alternative: true)
- Disable cards (enabled: false) when balance is insufficient

### Safety Policy

- Do not generate violent/sexual/discriminatory content
- On violation requests: safety.blocked=true, provide safe alternative narrative

---

## Critical Constraints

- **Output must be valid JSON.**
- **language field is fixed to "en-US".**
- **economy.cost and economy.balance_after are required.**
- **balance_after must be >= 0.**
</prompt_body>
</file>

<file path="backend/prompts/system/game_master.ko.md">
<prompt_meta>
  <prompt_id>game_master_system</prompt_id>
  <language>ko-KR</language>
  <version>0.2.0</version>
  <last_updated>2026-01-28</last_updated>
  <policy_preset>default</policy_preset>
</prompt_meta>

<prompt_body>
## ëª©ì 

ì—ì´ì „íŠ¸í˜• Game Masterë¡œì„œ TurnOutput(JSON)ì„ ìƒì„±í•©ë‹ˆë‹¤.
"Unknown World"ëŠ” ë¬´í•œ ìƒì„± ë¡œê·¸ë¼ì´í¬ ë‚´ëŸ¬í‹°ë¸Œ ì›¹ê²Œì„ì…ë‹ˆë‹¤.

## ì…ë ¥

- TurnInput: language, text, action_id, click, client, economy_snapshot
- WorldState: ì„¸ê³„ ê·œì¹™, ì¸ë²¤í† ë¦¬, í€˜ìŠ¤íŠ¸, ê´€ê³„, íˆìŠ¤í† ë¦¬ ìš”ì•½

## ì¶œë ¥ ê³„ì•½ (ìš”ì•½)

- ë°˜ë“œì‹œ JSON Schemaë¥¼ ë§Œì¡±í•˜ëŠ” TurnOutputë§Œ ì¶œë ¥í•©ë‹ˆë‹¤.
- languageëŠ” ì…ë ¥ê³¼ ë™ì¼í•˜ê²Œ "ko-KR"ë¡œ ê³ ì •í•©ë‹ˆë‹¤.
- ëª¨ë“  í…ìŠ¤íŠ¸(narrative, label, description ë“±)ëŠ” í•œêµ­ì–´ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.

---

## ì‹œìŠ¤í…œ ì§€ì‹œ

ë‹¹ì‹ ì€ "Unknown World"ì˜ Game Masterì…ë‹ˆë‹¤. í”Œë ˆì´ì–´ì˜ í–‰ë™ì— ë°˜ì‘í•˜ì—¬ ì„¸ê³„ë¥¼ ë³€í™”ì‹œí‚¤ê³ , í¥ë¯¸ë¡œìš´ ë‚´ëŸ¬í‹°ë¸Œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

### í•µì‹¬ ì›ì¹™

1. **ì¼ê´€ì„±**: ì„¸ê³„ ê·œì¹™(rules)ê³¼ ê¸°ì¡´ ì„¤ì •ì„ ì¤€ìˆ˜í•©ë‹ˆë‹¤.
2. **ì°½ì˜ì„±**: ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•˜ë˜ ë…¼ë¦¬ì ì¸ ì „ê°œë¥¼ ë§Œë“¤ì–´ëƒ…ë‹ˆë‹¤.
3. **ë°˜ì‘ì„±**: í”Œë ˆì´ì–´ì˜ ì„ íƒì— ì˜ë¯¸ ìˆëŠ” ê²°ê³¼ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
4. **ê²½ì œì„±**: ë¹„ìš©(cost)ê³¼ ì”ì•¡(balance_after)ì„ ì •í™•íˆ ê³„ì‚°í•©ë‹ˆë‹¤.

### ë‚´ëŸ¬í‹°ë¸Œ ìŠ¤íƒ€ì¼

- 2~3ë¬¸ì¥ì˜ ê°„ê²°í•˜ê³  ëª°ì…ê° ìˆëŠ” ë¬˜ì‚¬
- í˜„ì¬ ì‹œì œ ì‚¬ìš©
- ê°ê°ì  ë””í…Œì¼ í¬í•¨ (ì†Œë¦¬, ëƒ„ìƒˆ, ì´‰ê° ë“±)
- í”Œë ˆì´ì–´ë¥¼ "ë‹¹ì‹ "ìœ¼ë¡œ ì§€ì¹­
- **ì¤‘ìš”**: ì‚¬ìš©ìì˜ ì…ë ¥ í…ìŠ¤íŠ¸ë¥¼ ë‚´ëŸ¬í‹°ë¸Œì— ê·¸ëŒ€ë¡œ ì¸ìš©í•˜ì§€ ë§ˆì„¸ìš” (ì–¸ì–´ í˜¼í•© ë°©ì§€)

### ì•¡ì…˜ ì¹´ë“œ ìƒì„± ê·œì¹™

- 3~6ì¥ì˜ ì„ íƒì§€ ì œê³µ
- ê° ì¹´ë“œì— ë¹„ìš©(cost), ìœ„í—˜ë„(risk), íŒíŠ¸(hint) í¬í•¨
- ìµœì†Œ 1ì¥ì€ ì €ë¹„ìš© ëŒ€ì•ˆ(is_alternative: true) í¬í•¨
- ì”ì•¡ ë¶€ì¡± ì‹œ í•´ë‹¹ ì¹´ë“œ ë¹„í™œì„±í™”(enabled: false)

### ì•ˆì „ ì •ì±…

- í­ë ¥ì /ì„±ì /ì°¨ë³„ì  ì½˜í…ì¸  ìƒì„± ê¸ˆì§€
- ìœ„ë°˜ ìš”ì²­ ì‹œ safety.blocked=true, ì•ˆì „í•œ ëŒ€ì²´ ë‚´ëŸ¬í‹°ë¸Œ ì œê³µ

---

## ì¤‘ìš” ì œì•½

- **ì¶œë ¥ì€ ë°˜ë“œì‹œ ìœ íš¨í•œ JSONì´ì–´ì•¼ í•©ë‹ˆë‹¤.**
- **language í•„ë“œëŠ” "ko-KR"ë¡œ ê³ ì •í•©ë‹ˆë‹¤.**
- **economy.costì™€ economy.balance_afterëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.**
- **ì”ì•¡(balance_after)ì€ 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.**
</prompt_body>
</file>

<file path="frontend/src/api/scanner.test.ts">
import { describe, it, expect, vi, beforeEach } from 'vitest';
import {
  scanImage,
  validateFile,
  isSupportedImageFile,
  candidateToInventoryItem,
  MAX_FILE_SIZE_BYTES,
  type ItemCandidate,
} from './scanner';

describe('Scanner API Client', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    global.fetch = vi.fn();
  });

  describe('validateFile', () => {
    it('returns null for valid image files', () => {
      const file = new File([''], 'test.png', { type: 'image/png' });
      expect(validateFile(file)).toBeNull();
    });

    it('returns error for unsupported MIME types', () => {
      const file = new File([''], 'test.txt', { type: 'text/plain' });
      expect(validateFile(file)).toContain('ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹');
    });

    it('returns error for files exceeding max size', () => {
      const largeFile = {
        size: MAX_FILE_SIZE_BYTES + 1,
        type: 'image/png',
        name: 'large.png',
      } as File;
      expect(validateFile(largeFile)).toContain('íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤');
    });
  });

  describe('isSupportedImageFile', () => {
    it('returns true for jpg, png, webp, gif', () => {
      expect(isSupportedImageFile(new File([''], 't.jpg', { type: 'image/jpeg' }))).toBe(true);
      expect(isSupportedImageFile(new File([''], 't.png', { type: 'image/png' }))).toBe(true);
      expect(isSupportedImageFile(new File([''], 't.webp', { type: 'image/webp' }))).toBe(true);
      expect(isSupportedImageFile(new File([''], 't.gif', { type: 'image/gif' }))).toBe(true);
    });

    it('returns false for others', () => {
      expect(isSupportedImageFile(new File([''], 't.pdf', { type: 'application/pdf' }))).toBe(
        false,
      );
    });
  });

  describe('scanImage', () => {
    const mockFile = new File(['mock content'], 'test.png', { type: 'image/png' });
    const mockSuccessResponse = {
      success: true,
      status: 'completed',
      caption: 'A test scan',
      objects: [],
      item_candidates: [{ id: 'item-1', label: 'Test Item', item_type: 'tool' }],
      analysis_time_ms: 100,
      language: 'ko-KR',
    };

    it('returns success data when API call succeeds', async () => {
      (global.fetch as unknown as ReturnType<typeof vi.fn>).mockResolvedValue({
        ok: true,
        json: async () => mockSuccessResponse,
      });

      const result = await scanImage(mockFile, 'ko-KR');

      expect(result.success).toBe(true);
      if (result.success) {
        expect(result.data.caption).toBe('A test scan');
        expect(result.data.item_candidates).toHaveLength(1);
      }
    });

    it('returns error when fetch fails', async () => {
      (global.fetch as unknown as ReturnType<typeof vi.fn>).mockResolvedValue({
        ok: false,
        status: 500,
        statusText: 'Internal Server Error',
      });

      const result = await scanImage(mockFile, 'ko-KR');

      expect(result.success).toBe(false);
      if (!result.success) {
        expect(result.error).toContain('ì„œë²„ ì˜¤ë¥˜: 500');
      }
    });

    it('returns error when response schema is invalid', async () => {
      (global.fetch as unknown as ReturnType<typeof vi.fn>).mockResolvedValue({
        ok: true,
        json: async () => ({ invalid: 'data' }),
      });

      const result = await scanImage(mockFile, 'ko-KR');

      expect(result.success).toBe(false);
      if (!result.success) {
        expect(result.error).toContain('ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤');
      }
    });

    it('handles network error', async () => {
      (global.fetch as unknown as ReturnType<typeof vi.fn>).mockRejectedValue(
        new Error('Network error'),
      );

      const result = await scanImage(mockFile, 'ko-KR');

      expect(result.success).toBe(false);
      if (!result.success) {
        expect(result.error).toContain('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
      }
    });
  });

  describe('candidateToInventoryItem', () => {
    it('correctly maps ItemCandidate to InventoryItem with pending iconStatus (U-075)', () => {
      const candidate = {
        id: 'c-1',
        label: 'Rusty Key',
        description: 'An old key',
        item_type: 'key',
      };
      const item = candidateToInventoryItem(candidate);

      expect(item).toEqual({
        id: 'c-1',
        name: 'Rusty Key',
        description: 'An old key',
        icon: 'ğŸ”‘',
        quantity: 1,
        iconStatus: 'pending', // U-075: ì•„ì´ì½˜ ìƒì„± íŠ¸ë¦¬ê±°
      });
    });

    it('uses fallback icon for unknown item types', () => {
      const candidate: ItemCandidate = {
        id: 'c-2',
        label: 'Something',
        description: '',
        item_type: 'unknown',
      };
      const item = candidateToInventoryItem(candidate);
      expect(item.icon).toBe('ğŸ“¦');
      expect(item.iconStatus).toBe('pending'); // U-075
    });
  });
});
</file>

<file path="frontend/src/api/turnStream.economy.test.ts">
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { executeTurnStream } from './turnStream';

describe('U-063: Economy Balance Preservation in executeTurnStream', () => {
  const economySnapshot = { signal: 150, memory_shard: 5 };

  const mockInput = {
    language: 'ko-KR' as const,
    text: 'Hello',
    action_id: null,
    click: null,
    drop: null,
    client: { viewport_w: 100, viewport_h: 100, theme: 'dark' as const },
    economy_snapshot: economySnapshot,
    previous_image_url: null,
  };

  const mockCallbacks = {
    onFinal: vi.fn(),
    onError: vi.fn(),
    onComplete: vi.fn(),
  };

  beforeEach(() => {
    vi.clearAllMocks();
    global.fetch = vi.fn();
  });

  it('should preserve economy balance when final event has invalid data', async () => {
    const encoder = new TextEncoder();
    const stream = new ReadableStream({
      start(controller) {
        controller.enqueue(
          encoder.encode(
            JSON.stringify({
              type: 'final',
              data: {
                // narrative í•„ë“œ ëˆ„ë½ ë“± ìŠ¤í‚¤ë§ˆ ìœ„ë°˜
                language: 'ko-KR',
                economy: {
                  cost: { signal: 0, memory_shard: 0 },
                  balance_after: { signal: 0, memory_shard: 0 },
                },
              },
            }) + '\n',
          ),
        );
        controller.close();
      },
    });

    (global.fetch as unknown as ReturnType<typeof vi.fn>).mockResolvedValue({
      ok: true,
      body: stream,
    });

    await executeTurnStream(mockInput, mockCallbacks);

    expect(mockCallbacks.onFinal).toHaveBeenCalled();
    const finalEvent = mockCallbacks.onFinal.mock.calls[0][0];
    expect(finalEvent.data.economy.balance_after.signal).toBe(150);
    expect(finalEvent.data.economy.balance_after.memory_shard).toBe(5);
    expect(finalEvent.data.agent_console.badges).toContain('schema_fail');
  });

  it('should preserve economy balance on network error (fetch rejection)', async () => {
    (global.fetch as unknown as ReturnType<typeof vi.fn>).mockRejectedValue(
      new Error('Network failure'),
    );

    await executeTurnStream(mockInput, mockCallbacks);

    expect(mockCallbacks.onError).toHaveBeenCalled();
    expect(mockCallbacks.onFinal).toHaveBeenCalled();

    const finalEvent = mockCallbacks.onFinal.mock.calls[0][0];
    expect(finalEvent.data.economy.balance_after.signal).toBe(150);
    expect(finalEvent.data.economy.balance_after.memory_shard).toBe(5);
    expect(finalEvent.data.narrative).toContain('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨');
  });
});
</file>

<file path="frontend/src/components/DemoProfileSelect.tsx">
/**
 * Unknown World - ë°ëª¨ í”„ë¡œí•„ ì„ íƒ ì»´í¬ë„ŒíŠ¸ (U-015[Mvp], U-116[Mvp]).
 *
 * ì²« í™”ë©´ì—ì„œ 3ì¢…ì˜ ë°ëª¨ í”„ë¡œí•„ì„ ì„ íƒí•  ìˆ˜ ìˆëŠ” UIë¥¼ ì œê³µí•©ë‹ˆë‹¤.
 * U-116: SaveGame ì œê±° í›„ í•­ìƒ ì´ í™”ë©´ì—ì„œ ì‹œì‘í•©ë‹ˆë‹¤.
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - RULE-002: ì±„íŒ… UI ê¸ˆì§€, ê²Œì„ UIë¡œ ìƒì‹œ ë…¸ì¶œ
 *   - RULE-006: i18n í‚¤ ê¸°ë°˜ ë‹¤êµ­ì–´ ì§€ì›
 *   - PRD 6.9: ë°ëª¨ í”„ë¡œí•„ ì„ íƒë§Œìœ¼ë¡œ ì¦‰ì‹œ ì‹œì‘
 *
 * @module components/DemoProfileSelect
 */

import { useCallback } from 'react';
import { useTranslation } from 'react-i18next';
import { DEMO_PROFILES, type DemoProfile } from '../data/demoProfiles';
import { SUPPORTED_LANGUAGES, type SupportedLanguage } from '../i18n';

// =============================================================================
// íƒ€ì… ì •ì˜
// =============================================================================

export interface DemoProfileSelectProps {
  /** í”„ë¡œí•„ ì„ íƒ ì‹œ í˜¸ì¶œë˜ëŠ” ì½œë°± */
  onSelectProfile: (profile: DemoProfile) => void;
  /** U-044: í˜„ì¬ ì„ íƒëœ ì–¸ì–´ */
  currentLanguage?: SupportedLanguage;
  /** U-044: ì–¸ì–´ ë³€ê²½ ì½œë°± (profile_selectì—ì„œë§Œ í—ˆìš©) */
  onLanguageChange?: (language: SupportedLanguage) => void;
}

// =============================================================================
// ì»´í¬ë„ŒíŠ¸
// =============================================================================

/** U-044: ì–¸ì–´ í‘œì‹œ ë ˆì´ë¸” ë§¤í•‘ */
const LANGUAGE_LABELS: Record<SupportedLanguage, string> = {
  'ko-KR': 'í•œêµ­ì–´',
  'en-US': 'English',
};

/**
 * ë°ëª¨ í”„ë¡œí•„ ì„ íƒ í™”ë©´.
 * ê²Œì„ ì‹œì‘ ì „ì— 3ì¢…ì˜ í”„ë¡œí•„ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.
 * U-044: ì–¸ì–´ ì„ íƒ UI í¬í•¨ (profile_selectì—ì„œë§Œ ë³€ê²½ ê°€ëŠ¥).
 * U-116: SaveGame ì œê±° í›„ Continue ë²„íŠ¼ ì œê±°.
 */
export function DemoProfileSelect({
  onSelectProfile,
  currentLanguage = 'ko-KR',
  onLanguageChange,
}: DemoProfileSelectProps) {
  const { t } = useTranslation();

  const handleSelectProfile = useCallback(
    (profile: DemoProfile) => {
      onSelectProfile(profile);
    },
    [onSelectProfile],
  );

  /** U-044: ì–¸ì–´ í† ê¸€ í•¸ë“¤ëŸ¬ */
  const handleLanguageToggle = useCallback(() => {
    if (!onLanguageChange) return;
    // í˜„ì¬ ì–¸ì–´ì˜ ë‹¤ìŒ ì–¸ì–´ë¡œ ì „í™˜ (2ê°œ ì–¸ì–´ë§Œ ì§€ì›í•˜ë¯€ë¡œ í† ê¸€)
    const currentIndex = SUPPORTED_LANGUAGES.indexOf(currentLanguage);
    const nextIndex = (currentIndex + 1) % SUPPORTED_LANGUAGES.length;
    onLanguageChange(SUPPORTED_LANGUAGES[nextIndex]);
  }, [currentLanguage, onLanguageChange]);

  return (
    <div className="profile-select-container" data-ui-importance="critical">
      {/* U-044: ì–¸ì–´ ì„ íƒ í† ê¸€ (ìš°ì¸¡ ìƒë‹¨) */}
      {onLanguageChange && (
        <div className="language-toggle-container">
          <button
            type="button"
            className="language-toggle-btn"
            onClick={handleLanguageToggle}
            aria-label={t('language.toggle')}
            title={t('language.toggle_tooltip')}
          >
            <span className="language-toggle-icon" aria-hidden="true">
              ğŸŒ
            </span>
            <span className="language-toggle-label">{LANGUAGE_LABELS[currentLanguage]}</span>
          </button>
        </div>
      )}

      {/* íƒ€ì´í‹€ */}
      <header className="profile-select-header">
        <h1 className="profile-select-title glitch" data-text={t('ui.logo')}>
          {t('ui.logo')}
        </h1>
        <p className="profile-select-subtitle">{t('profile.select_title')}</p>
      </header>

      {/* í”„ë¡œí•„ ì¹´ë“œ ëª©ë¡ */}
      <div className="profile-card-grid">
        {DEMO_PROFILES.map((profile) => (
          <button
            key={profile.id}
            type="button"
            className="profile-card"
            onClick={() => handleSelectProfile(profile)}
            style={{ '--profile-accent': profile.themeColor } as React.CSSProperties}
            aria-label={t(profile.nameKey)}
          >
            <span className="profile-card-icon" aria-hidden="true">
              {profile.icon}
            </span>
            <span className="profile-card-name">{t(profile.nameKey)}</span>
            <span className="profile-card-description">{t(profile.descriptionKey)}</span>
          </button>
        ))}
      </div>

      {/* ì•ˆë‚´ ë¬¸êµ¬ */}
      <footer className="profile-select-footer">
        <p className="profile-select-hint">{t('profile.select_hint')}</p>
      </footer>
    </div>
  );
}
</file>

<file path="frontend/src/components/Hotspot.test.tsx">
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen, fireEvent } from '@testing-library/react';
import { Hotspot } from './Hotspot';
import { useOnboardingStore } from '../stores/onboardingStore';
import type { SceneObject } from '../schemas/turn';

// i18next ëª¨í‚¹
vi.mock('react-i18next', () => ({
  useTranslation: () => ({
    t: (key: string) => key,
  }),
}));

// dnd-kit ëª¨í‚¹
vi.mock('@dnd-kit/core', () => ({
  useDroppable: () => ({
    isOver: false,
    setNodeRef: vi.fn(),
  }),
}));

// box2d ìœ í‹¸ ëª¨í‚¹
vi.mock('../utils/box2d', () => ({
  box2dToPixel: vi.fn(() => ({
    top: 100,
    left: 100,
    width: 200,
    height: 200,
  })),
}));

describe('Hotspot UX - Hover Hint', () => {
  const mockObject: SceneObject = {
    id: 'test-obj',
    label: 'í…ŒìŠ¤íŠ¸ ì˜¤ë¸Œì íŠ¸',
    box_2d: { ymin: 100, xmin: 100, ymax: 300, xmax: 300 },
    interaction_hint: 'ì¡°ì‚¬ ê°€ëŠ¥',
  };

  const mockCanvasSize = { width: 1000, height: 1000 };
  const mockOnClick = vi.fn();

  beforeEach(() => {
    vi.clearAllMocks();
    useOnboardingStore.getState().resetOnboarding();
  });

  it('ë§ˆìš°ìŠ¤ ì§„ì… ì‹œ onboardingStoreì˜ ì¹´ìš´íŠ¸ ì¦ê°€ ì•¡ì…˜ì´ í˜¸ì¶œë˜ì–´ì•¼ í•œë‹¤', () => {
    render(
      <Hotspot
        object={mockObject}
        canvasSize={mockCanvasSize}
        onClick={mockOnClick}
        disabled={false}
      />,
    );

    const hotspot = screen.getByRole('button');
    fireEvent.mouseEnter(hotspot);

    expect(useOnboardingStore.getState().hotspotHintCount).toBe(1);
  });

  it('íŒíŠ¸ í‘œì‹œ ì¡°ê±´(ì²« Në²ˆ)ì„ ë§Œì¡±í•  ë•Œ InteractionHintê°€ ë Œë”ë§ë˜ì–´ì•¼ í•œë‹¤', () => {
    render(
      <Hotspot
        object={mockObject}
        canvasSize={mockCanvasSize}
        onClick={mockOnClick}
        disabled={false}
      />,
    );

    const hotspot = screen.getByRole('button');
    fireEvent.mouseEnter(hotspot);

    // interaction.hotspot_click í‚¤ê°€ ë Œë”ë§ë˜ëŠ”ì§€ í™•ì¸ (InteractionHint ì»´í¬ë„ŒíŠ¸ ë‚´ì˜ í…ìŠ¤íŠ¸)
    expect(screen.getByText('interaction.hotspot_click')).toBeInTheDocument();
  });

  it('íŒíŠ¸ ì„ê³„ê°’ì„ ì´ˆê³¼í•˜ë©´ InteractionHintê°€ ë Œë”ë§ë˜ì§€ ì•Šì•„ì•¼ í•œë‹¤', () => {
    // ì„ê³„ê°’ê¹Œì§€ ì¹´ìš´íŠ¸ ì˜¬ë¦¬ê¸°
    for (let i = 0; i < 3; i++) {
      useOnboardingStore.getState().incrementHotspotHint();
    }
    expect(useOnboardingStore.getState().hotspotHintCount).toBe(3);

    render(
      <Hotspot
        object={mockObject}
        canvasSize={mockCanvasSize}
        onClick={mockOnClick}
        disabled={false}
      />,
    );

    const hotspot = screen.getByRole('button');
    fireEvent.mouseEnter(hotspot);

    // íŒíŠ¸ê°€ ë³´ì´ì§€ ì•Šì•„ì•¼ í•¨
    expect(screen.queryByText('interaction.hotspot_click')).not.toBeInTheDocument();
  });

  it('ë¹„í™œì„±í™” ìƒíƒœì¼ ë•ŒëŠ” ì¹´ìš´íŠ¸ê°€ ì¦ê°€í•˜ì§€ ì•Šê³  íŒíŠ¸ë„ ë³´ì´ì§€ ì•Šì•„ì•¼ í•œë‹¤', () => {
    render(
      <Hotspot
        object={mockObject}
        canvasSize={mockCanvasSize}
        onClick={mockOnClick}
        disabled={true}
      />,
    );

    const hotspot = screen.getByRole('button');
    fireEvent.mouseEnter(hotspot);

    expect(useOnboardingStore.getState().hotspotHintCount).toBe(0);
    expect(screen.queryByText('interaction.hotspot_click')).not.toBeInTheDocument();
  });
});
</file>

<file path="frontend/src/components/QuestPanel.test.tsx">
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { render, screen } from '@testing-library/react';
import { QuestPanel } from './QuestPanel';
import { useWorldStore } from '../stores/worldStore';

// i18next ëª¨í‚¹ (t í•¨ìˆ˜ê°€ í‚¤ë¥¼ ë°˜í™˜í•˜ë„ë¡)
vi.mock('react-i18next', () => ({
  useTranslation: () => ({
    t: (key: string) => key,
  }),
  initReactI18next: {
    type: '3rdParty',
    init: () => {},
  },
}));

describe('QuestPanel (U-013)', () => {
  beforeEach(() => {
    useWorldStore.getState().reset();
  });

  it('í€˜ìŠ¤íŠ¸ê°€ ì—†ì„ ë•Œ ììœ  íƒìƒ‰ ìƒíƒœë¥¼ í‘œì‹œí•´ì•¼ í•œë‹¤', () => {
    render(<QuestPanel />);
    // U-078: ë¹ˆ ìƒíƒœ â†’ "ììœ  íƒìƒ‰" ì•ˆë‚´ë¡œ ë³€ê²½
    expect(screen.getByText('quest.free_exploration')).toBeInTheDocument();
    expect(screen.getByText('quest.free_exploration_desc')).toBeInTheDocument();
  });

  it('ì§„í–‰ ì¤‘ì¸ í€˜ìŠ¤íŠ¸ë¥¼ ëª©ë¡ì— í‘œì‹œí•´ì•¼ í•œë‹¤', () => {
    useWorldStore.setState({
      quests: [
        {
          id: 'q1',
          label: 'ì•¡í‹°ë¸Œ í€˜ìŠ¤íŠ¸',
          is_completed: false,
          description: null,
          is_main: false,
          progress: 0,
          reward_signal: 0,
        },
      ],
    });

    render(<QuestPanel />);
    expect(screen.getByText('ì•¡í‹°ë¸Œ í€˜ìŠ¤íŠ¸')).toBeInTheDocument();
  });

  it('ì™„ë£Œëœ í€˜ìŠ¤íŠ¸ë¥¼ ëª©ë¡ì— í‘œì‹œí•´ì•¼ í•œë‹¤', () => {
    useWorldStore.setState({
      quests: [
        {
          id: 'q2',
          label: 'ì™„ë£Œëœ í€˜ìŠ¤íŠ¸',
          is_completed: true,
          description: null,
          is_main: false,
          progress: 100,
          reward_signal: 10,
        },
      ],
    });

    render(<QuestPanel />);
    expect(screen.getByText('ì™„ë£Œëœ í€˜ìŠ¤íŠ¸')).toBeInTheDocument();
  });

  it('ì£¼ ëª©í‘œì™€ ì„¸ë¶€ ëª©í‘œë¥¼ êµ¬ë¶„í•˜ì—¬ í‘œì‹œí•´ì•¼ í•œë‹¤', () => {
    useWorldStore.setState({
      quests: [
        {
          id: 'q1',
          label: 'ì£¼ ëª©í‘œ',
          is_completed: false,
          description: 'ì£¼ ëª©í‘œ ì„¤ëª…',
          is_main: true,
          progress: 50,
          reward_signal: 100,
        },
        {
          id: 'q2',
          label: 'ì„¸ë¶€ ëª©í‘œ',
          is_completed: false,
          description: null,
          is_main: false,
          progress: 0,
          reward_signal: 20,
        },
      ],
    });

    render(<QuestPanel />);
    expect(screen.getByText('ì£¼ ëª©í‘œ')).toBeInTheDocument();
    expect(screen.getByText('ì„¸ë¶€ ëª©í‘œ')).toBeInTheDocument();
  });
});
</file>

<file path="frontend/src/demo/useDemoInitializer.ts">
import { useEffect } from 'react';
import { useTranslation } from 'react-i18next';
import { useInventoryStore } from '../stores/inventoryStore';
import { useWorldStore } from '../stores/worldStore';
import type { Quest, WorldRule } from '../schemas/turn';
import type { MutationEvent } from '../stores/worldStore';
import {
  DEMO_INVENTORY_ITEMS,
  DEMO_SCENE_OBJECTS,
  DEMO_QUESTS,
  DEMO_RULES,
  getDemoItemNameKey,
  isDemoEnvironment,
} from '../demo/demoFixtures';

/**
 * ë°ëª¨ í™˜ê²½ì—ì„œ ì´ˆê¸° mock ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” í›… (RU-003-Q5, U-013).
 */
export function useDemoInitializer() {
  const { t } = useTranslation();
  const { items: inventoryItems, addItems: addInventoryItems } = useInventoryStore();
  const worldStore = useWorldStore();
  const {
    sceneObjects,
    setSceneObjects,
    narrativeEntries,
    initialize: initializeWorld,
    quests,
    activeRules,
  } = worldStore;

  useEffect(() => {
    // ì›”ë“œ ì´ˆê¸°í™” (í™˜ì˜ ë©”ì‹œì§€)
    if (narrativeEntries.length === 0) {
      initializeWorld(t('narrative.welcome'));
    }

    // DEV: ë°ëª¨ìš© mock ë°ì´í„° ì´ˆê¸°í™” (RU-003-Q5: DEV ê°€ë“œ + i18n í‚¤ ê¸°ë°˜)
    if (isDemoEnvironment()) {
      // ë°ëª¨ìš© mock ì¸ë²¤í† ë¦¬ ì´ˆê¸°í™” (U-011)
      // U-075: ë°ëª¨ ì•„ì´í…œì€ ì´ëª¨ì§€ ì•„ì´ì½˜ì„ ìœ ì§€í•˜ë¯€ë¡œ iconStatus: 'completed'ë¡œ ì„¤ì •
      if (inventoryItems.length === 0) {
        const demoInventory = DEMO_INVENTORY_ITEMS.map((item) => ({
          id: item.id,
          name: t(getDemoItemNameKey(item.id)),
          icon: item.icon,
          quantity: item.quantity,
          iconStatus: 'completed' as const, // U-075: ì•„ì´ì½˜ ìƒì„± íŠ¸ë¦¬ê±° ë°©ì§€
        }));
        addInventoryItems(demoInventory);
      }

      // ë°ëª¨ìš© mock Scene Objects ì´ˆê¸°í™” (U-010)
      if (sceneObjects.length === 0) {
        const demoSceneObjects = DEMO_SCENE_OBJECTS.map((obj) => ({
          id: obj.id,
          label: t(obj.labelKey),
          box_2d: obj.box_2d,
          interaction_hint: t(obj.hintKey),
        }));
        setSceneObjects(demoSceneObjects);
      }

      // ë°ëª¨ìš© mock í€˜ìŠ¤íŠ¸ ì´ˆê¸°í™” (U-013, U-078)
      if (quests.length === 0) {
        const demoQuests: Quest[] = DEMO_QUESTS.map((q) => ({
          id: q.id,
          label: t(q.labelKey),
          is_completed: q.is_completed,
          description: q.descriptionKey ? t(q.descriptionKey) : null,
          is_main: q.is_main ?? false,
          progress: q.progress ?? 0,
          reward_signal: q.reward_signal ?? 0,
        }));
        useWorldStore.setState({ quests: demoQuests });
      }

      // ë°ëª¨ìš© mock ê·œì¹™ ì´ˆê¸°í™” (U-013)
      if (activeRules.length === 0) {
        const demoRules: WorldRule[] = DEMO_RULES.map((r) => ({
          id: r.id,
          label: t(r.labelKey),
          description: r.descriptionKey ? t(r.descriptionKey) : null,
        }));
        // ë°ëª¨ ë®¤í…Œì´ì…˜ íƒ€ì„ë¼ì¸ ìƒì„± (ê·œì¹™ ì¶”ê°€ ì´ë²¤íŠ¸)
        const now = Date.now();
        const demoMutations: MutationEvent[] = DEMO_RULES.map((r, index) => ({
          turn: 0,
          ruleId: r.id,
          type: 'added' as const,
          label: t(r.labelKey),
          description: r.descriptionKey ? t(r.descriptionKey) : undefined,
          timestamp: now - index * 1000, // ì‹œê°„ ìˆœì„œ êµ¬ë¶„ìš©
        }));
        useWorldStore.setState({
          activeRules: demoRules,
          mutationTimeline: demoMutations,
        });
      }
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [t]);
}
</file>

<file path="frontend/src/schemas/index.ts">
/**
 * Unknown World - ìŠ¤í‚¤ë§ˆ ëª¨ë“ˆ ì§„ì…ì .
 *
 * TurnInput/TurnOutput Zod ìŠ¤í‚¤ë§ˆ ë° ê´€ë ¨ ìœ í‹¸ë¦¬í‹°ë¥¼ ì¬ë‚´ë³´ë‚´ê¸°í•©ë‹ˆë‹¤.
 *
 * @module schemas
 */

// =============================================================================
// ìŠ¤í‚¤ë§ˆ ë²„ì „
// =============================================================================

export { SCHEMA_VERSION } from './turn';

// =============================================================================
// Enum ìŠ¤í‚¤ë§ˆ ë° íƒ€ì…
// =============================================================================

export {
  LanguageSchema,
  ThemeSchema,
  AgentPhaseSchema,
  ValidationBadgeSchema,
  ModelLabelSchema,
  RiskLevelSchema,
} from './turn';

export type { Language, Theme, AgentPhase, ValidationBadge, ModelLabel, RiskLevel } from './turn';

// =============================================================================
// ê³µí†µ í•˜ìœ„ íƒ€ì… ìŠ¤í‚¤ë§ˆ ë° íƒ€ì…
// =============================================================================

export { CoordinateSchema, Box2DSchema, CurrencyAmountSchema } from './turn';

export type { Coordinate, Box2D, CurrencyAmount } from './turn';

// =============================================================================
// TurnInput ê´€ë ¨ ìŠ¤í‚¤ë§ˆ ë° íƒ€ì…
// =============================================================================

export { ClickInputSchema, ClientInfoSchema, EconomySnapshotSchema, TurnInputSchema } from './turn';

export type { ClickInput, ClientInfo, EconomySnapshot, TurnInput } from './turn';

// =============================================================================
// TurnOutput ê´€ë ¨ ìŠ¤í‚¤ë§ˆ ë° íƒ€ì…
// =============================================================================

export {
  // UI
  ActionCardSchema,
  SceneObjectSchema,
  ActionDeckSchema,
  UIOutputSchema,
  // World
  MemoryPinSchema,
  WorldRuleSchema,
  QuestSchema,
  WorldDeltaSchema,
  // Render
  ImageJobSchema,
  RenderOutputSchema,
  // Economy
  LedgerEntrySchema,
  EconomyOutputSchema,
  // Safety
  SafetyOutputSchema, // Agent Console
  AgentConsoleSchema,
  // Main
  TurnOutputSchema,
} from './turn';

export type {
  // UI
  ActionCard,
  SceneObject,
  ActionDeck,
  UIOutput,
  // World
  MemoryPin,
  WorldRule,
  Quest,
  WorldDelta,
  // Render
  ImageJob,
  RenderOutput,
  // Economy
  LedgerEntry,
  EconomyOutput,
  // Safety
  SafetyOutput, // Agent Console
  AgentConsole,
  // Main
  TurnOutput,
} from './turn';

// =============================================================================
// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
// =============================================================================

export {
  createFallbackTurnOutput,
  safeParseTurnOutput,
  parseTurnInput,
  safeParseTurnInput,
} from './turn';

export type { TurnOutputParseResult, TurnInputSafeParseResult } from './turn';
</file>

<file path="frontend/src/setupTests.ts">
import '@testing-library/jest-dom';
import { vi } from 'vitest';

// window.matchMedia ëª¨í‚¹ (NarrativeFeed ë“±ì—ì„œ ì‚¬ìš©)
Object.defineProperty(window, 'matchMedia', {
  writable: true,
  value: vi.fn().mockImplementation((query: string) => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: vi.fn(), // deprecated
    removeListener: vi.fn(), // deprecated
    addEventListener: vi.fn(),
    removeEventListener: vi.fn(),
    dispatchEvent: vi.fn(),
  })),
});

// react-i18next ì „ì—­ ëª¨í‚¹
vi.mock('react-i18next', () => ({
  useTranslation: () => ({
    t: (key: string) => key,
    i18n: {
      changeLanguage: vi.fn(),
      language: 'ko-KR',
    },
  }),
  initReactI18next: {
    type: '3rdParty',
    init: vi.fn(),
  },
  Trans: ({ children }: { children: React.ReactNode }) => children,
}));
</file>

<file path="frontend/src/stores/agentStore.ts">
/**
 * Unknown World - Agent Console ìƒíƒœ ê´€ë¦¬ (Zustand).
 *
 * ìŠ¤íŠ¸ë¦¬ë° ì¤‘ ìˆ˜ì‹ ë˜ëŠ” ë‹¨ê³„/ë°°ì§€/ë‚´ëŸ¬í‹°ë¸Œ/ë³µêµ¬ ì •ë³´ë¥¼ ì €ì¥í•˜ê³ ,
 * AgentConsole ì»´í¬ë„ŒíŠ¸ì—ì„œ êµ¬ë…í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - RULE-008: ë‹¨ê³„/ë°°ì§€ ê°€ì‹œí™” (í”„ë¡¬í”„íŠ¸/ë‚´ë¶€ ì¶”ë¡  ë…¸ì¶œ ê¸ˆì§€)
 *   - RULE-003/004: ê²€ì¦ í›„ ìƒíƒœ ë°˜ì˜, ì‹¤íŒ¨ ì‹œ í´ë°±
 *
 * @module stores/agentStore
 */

import { create } from 'zustand';
import type { AgentPhase, ValidationBadge, TurnOutput } from '../schemas/turn';
import type {
  StageEvent,
  BadgesEvent,
  NarrativeDeltaEvent,
  FinalEvent,
  ErrorEvent,
} from '../types/turn_stream';
import { StageStatus } from '../types/turn_stream';

// =============================================================================
// ìƒíƒœ íƒ€ì… ì •ì˜
// =============================================================================

/** ë‹¨ê³„ ìƒíƒœ */
export type PhaseStatus = 'pending' | 'in_progress' | 'completed' | 'failed';

/** ë‹¨ê³„ ì •ë³´ */
export interface PhaseInfo {
  name: AgentPhase;
  status: PhaseStatus;
}

/** ì—ëŸ¬ ì •ë³´ */
export interface AgentError {
  message: string;
  code?: string;
}

/** Agent Console ìƒíƒœ */
export interface AgentState {
  /** í˜„ì¬ ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì¸ì§€ */
  isStreaming: boolean;
  /** í˜„ì¬ ë‹¨ê³„ */
  currentPhase: AgentPhase | null;
  /** ë‹¨ê³„ë³„ ìƒíƒœ */
  phases: PhaseInfo[];
  /** ê²€ì¦ ë°°ì§€ ëª©ë¡ */
  badges: ValidationBadge[];
  /** ëˆ„ì  ë‚´ëŸ¬í‹°ë¸Œ í…ìŠ¤íŠ¸ (íƒ€ì íš¨ê³¼ìš©) */
  narrativeBuffer: string;
  /** ìë™ ë³µêµ¬ íšŸìˆ˜ */
  repairCount: number;
  /** ìµœì¢… TurnOutput */
  finalOutput: TurnOutput | null;
  /** ì—ëŸ¬ ì •ë³´ */
  error: AgentError | null;
}

/** Agent Console ì•¡ì…˜ */
export interface AgentActions {
  /** ìŠ¤íŠ¸ë¦¼ ì‹œì‘ */
  startStream: () => void;
  /** ë‹¨ê³„ ì´ë²¤íŠ¸ ì²˜ë¦¬ */
  handleStage: (event: StageEvent) => void;
  /** ë°°ì§€ ì´ë²¤íŠ¸ ì²˜ë¦¬ */
  handleBadges: (event: BadgesEvent) => void;
  /** ë‚´ëŸ¬í‹°ë¸Œ ë¸íƒ€ ì´ë²¤íŠ¸ ì²˜ë¦¬ */
  handleNarrativeDelta: (event: NarrativeDeltaEvent) => void;
  /** ìµœì¢… ì¶œë ¥ ì´ë²¤íŠ¸ ì²˜ë¦¬ */
  handleFinal: (event: FinalEvent) => void;
  /** ì—ëŸ¬ ì´ë²¤íŠ¸ ì²˜ë¦¬ */
  handleError: (event: ErrorEvent) => void;
  /** ìŠ¤íŠ¸ë¦¼ ì™„ë£Œ */
  completeStream: () => void;
  /** ìƒíƒœ ì´ˆê¸°í™” */
  reset: () => void;
}

export type AgentStore = AgentState & AgentActions;

// =============================================================================
// ì´ˆê¸° ìƒíƒœ
// =============================================================================

/** ê¸°ë³¸ ë‹¨ê³„ ëª©ë¡ (PRD ì˜ˆì‹œ) */
const DEFAULT_PHASES: AgentPhase[] = [
  'parse',
  'validate',
  'plan',
  'resolve',
  'render',
  'verify',
  'commit',
];

/** ì´ˆê¸° ìƒíƒœ ìƒì„± */
function createInitialState(): AgentState {
  return {
    isStreaming: false,
    currentPhase: null,
    phases: DEFAULT_PHASES.map((name) => ({
      name,
      status: 'pending' as const,
    })),
    badges: [],
    narrativeBuffer: '',
    repairCount: 0,
    finalOutput: null,
    error: null,
  };
}

// =============================================================================
// Zustand Store
// =============================================================================

/**
 * Agent Console ìƒíƒœ ìŠ¤í† ì–´.
 *
 * @example
 * ```tsx
 * // ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©
 * const { isStreaming, phases, badges } = useAgentStore();
 * const startStream = useAgentStore((state) => state.startStream);
 * ```
 */
export const useAgentStore = create<AgentStore>((set) => ({
  // ì´ˆê¸° ìƒíƒœ
  ...createInitialState(),

  // ì•¡ì…˜
  startStream: () => {
    set({
      ...createInitialState(),
      isStreaming: true,
    });
  },

  handleStage: (event) => {
    set((state) => {
      const phaseName = event.name;
      const eventStatus = event.status;

      // RU-002-S2: status ê°’ì— ë”°ë¥¸ ë‹¨ê³„ ìƒíƒœ ê²°ì •
      // 'start' â†’ in_progress
      // 'complete' ë˜ëŠ” 'ok' (ì •ê·œí™”ë¨) â†’ completed
      // 'fail' â†’ failed
      let newStatus: PhaseStatus;
      if (eventStatus === StageStatus.START) {
        newStatus = 'in_progress';
      } else if (eventStatus === 'fail') {
        newStatus = 'failed';
      } else {
        // 'complete' (ì •ê·œí™”ëœ 'ok' í¬í•¨)
        newStatus = 'completed';
      }

      // ë‹¨ê³„ ìƒíƒœ ì—…ë°ì´íŠ¸
      const phases = state.phases.map((phase) => {
        if (phase.name === phaseName) {
          return {
            ...phase,
            status: newStatus,
          };
        }
        return phase;
      });

      return {
        phases,
        currentPhase: eventStatus === StageStatus.START ? phaseName : state.currentPhase,
      };
    });
  },

  handleBadges: (event) => {
    set({
      badges: event.badges,
    });
  },

  handleNarrativeDelta: (event) => {
    set((state) => ({
      narrativeBuffer: state.narrativeBuffer + event.text,
    }));
  },

  handleFinal: (event) => {
    set({
      finalOutput: event.data,
      repairCount: event.data.agent_console?.repair_count ?? 0,
      // U-087: í…ìŠ¤íŠ¸ê°€ entriesì— í™•ì •ë˜ì—ˆìœ¼ë¯€ë¡œ ìŠ¤íŠ¸ë¦¬ë° ë²„í¼ ì¦‰ì‹œ ë¹„ì›€.
      // completeStream()ì´ ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œê¹Œì§€ ì§€ì—°ë˜ì–´ë„ í…ìŠ¤íŠ¸ ì¤‘ë³µ í‘œì‹œ ë°©ì§€.
      narrativeBuffer: '',
    });
  },

  handleError: (event) => {
    set({
      error: {
        message: event.message,
        code: event.code,
      },
    });
  },

  completeStream: () => {
    set({
      isStreaming: false,
      narrativeBuffer: '', // ìŠ¤íŠ¸ë¦¼ ì™„ë£Œ ì‹œ ë²„í¼ ì´ˆê¸°í™”
    });
  },

  reset: () => {
    set(createInitialState());
  },
}));

// =============================================================================
// ì…€ë ‰í„° (ì„±ëŠ¥ ìµœì í™”ìš©)
// =============================================================================

/** ìŠ¤íŠ¸ë¦¬ë° ìƒíƒœ ì…€ë ‰í„° */
export const selectIsStreaming = (state: AgentStore) => state.isStreaming;

/** í˜„ì¬ ë‹¨ê³„ ì…€ë ‰í„° */
export const selectCurrentPhase = (state: AgentStore) => state.currentPhase;

/** ë‹¨ê³„ ëª©ë¡ ì…€ë ‰í„° */
export const selectPhases = (state: AgentStore) => state.phases;

/** ë°°ì§€ ëª©ë¡ ì…€ë ‰í„° */
export const selectBadges = (state: AgentStore) => state.badges;

/** ë‚´ëŸ¬í‹°ë¸Œ ë²„í¼ ì…€ë ‰í„° */
export const selectNarrativeBuffer = (state: AgentStore) => state.narrativeBuffer;

/** ë³µêµ¬ íšŸìˆ˜ ì…€ë ‰í„° */
export const selectRepairCount = (state: AgentStore) => state.repairCount;

/** ìµœì¢… ì¶œë ¥ ì…€ë ‰í„° */
export const selectFinalOutput = (state: AgentStore) => state.finalOutput;

/** ì—ëŸ¬ ì…€ë ‰í„° */
export const selectError = (state: AgentStore) => state.error;

/** ëª¨ë¸ ë¼ë²¨ ì…€ë ‰í„° (U-069: FAST/QUALITY í‘œì‹œ) */
export const selectModelLabel = (state: AgentStore) =>
  state.finalOutput?.agent_console?.model_label ?? 'FAST';
</file>

<file path="frontend/src/stores/inventory_consumption.test.ts">
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { useInventoryStore } from './inventoryStore';
import { useWorldStore } from './worldStore';
import type { TurnOutput } from '../schemas/turn';

// í•˜ìœ„ ìŠ¤í† ì–´ ëª¨í‚¹ ë°©ì§€ (ì‹¤ì œ ë¡œì§ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´)
vi.unmock('./inventoryStore');
vi.unmock('./economyStore');
vi.unmock('./actionDeckStore');

describe('Item Consumption (U-096)', () => {
  beforeEach(() => {
    useInventoryStore.getState().reset();
    useWorldStore.getState().reset();
    vi.useFakeTimers();
  });

  describe('InventoryStore Consumption Logic', () => {
    it('markConsuming: ì•„ì´í…œì„ ì†Œë¹„ ì¤‘ì¸ ìƒíƒœë¡œ í‘œì‹œí•´ì•¼ í•œë‹¤', () => {
      const { markConsuming } = useInventoryStore.getState();
      markConsuming(['item1', 'item2']);

      const state = useInventoryStore.getState();
      expect(state.consumingItemIds).toContain('item1');
      expect(state.consumingItemIds).toContain('item2');
    });

    it('clearConsuming: ì†Œë¹„ ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ì•„ì´í…œì„ ì‹¤ì œë¡œ ì œê±°í•´ì•¼ í•œë‹¤ (ìˆ˜ëŸ‰ 1)', () => {
      const { addItems, markConsuming, clearConsuming } = useInventoryStore.getState();
      addItems([{ id: 'item1', name: 'Key', quantity: 1 }]);
      markConsuming(['item1']);

      clearConsuming(['item1']);

      const state = useInventoryStore.getState();
      expect(state.items).toHaveLength(0);
      expect(state.consumingItemIds).not.toContain('item1');
    });

    it('clearConsuming: ìˆ˜ëŸ‰ì´ ì—¬ëŸ¬ ê°œì¸ ê²½ìš° ìˆ˜ëŸ‰ë§Œ ê°ì†Œì‹œì¼œì•¼ í•œë‹¤', () => {
      const { addItems, markConsuming, clearConsuming } = useInventoryStore.getState();
      addItems([{ id: 'potion', name: 'Potion', quantity: 3 }]);
      markConsuming(['potion']);

      clearConsuming(['potion']);

      const state = useInventoryStore.getState();
      expect(state.items).toHaveLength(1);
      expect(state.items[0].quantity).toBe(2);
      expect(state.consumingItemIds).not.toContain('potion');
    });

    it('clearConsuming: ì¤‘ë³µ ID ì œê±° ì‹œ ìˆ˜ëŸ‰ì´ ê·¸ë§Œí¼ ê°ì†Œí•´ì•¼ í•œë‹¤', () => {
      const { addItems, markConsuming, clearConsuming } = useInventoryStore.getState();
      addItems([{ id: 'potion', name: 'Potion', quantity: 3 }]);
      markConsuming(['potion']);

      clearConsuming(['potion', 'potion']);

      const state = useInventoryStore.getState();
      expect(state.items).toHaveLength(1);
      expect(state.items[0].quantity).toBe(1);
    });
  });

  describe('WorldStore Integration', () => {
    it('applyTurnOutput: inventory_removedê°€ í¬í•¨ë˜ë©´ ì†Œë¹„ ì• ë‹ˆë©”ì´ì…˜ì„ íŠ¸ë¦¬ê±°í•´ì•¼ í•œë‹¤', () => {
      const { addItems } = useInventoryStore.getState();
      addItems([{ id: 'key_01', name: 'Iron Key', quantity: 1 }]);

      const mockOutput: Partial<TurnOutput> = {
        narrative: 'ì—´ì‡ ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.',
        language: 'ko-KR' as 'ko-KR' | 'en-US',
        economy: {
          cost: { signal: 0, memory_shard: 0 },
          balance_after: { signal: 100, memory_shard: 5 },
          credit: 0,
          low_balance_warning: false,
        },
        ui: {
          action_deck: { cards: [] },
          objects: [],
          scene: { image_url: '', alt_text: '' },
        },
        world: {
          inventory_added: [],
          inventory_removed: ['key_01'],
          quests_updated: [],
          rules_changed: [],
          relationships_changed: [],
          memory_pins: [],
        },
        agent_console: {
          current_phase: 'commit' as
            | 'parse'
            | 'validate'
            | 'plan'
            | 'resolve'
            | 'render'
            | 'verify'
            | 'commit',
          badges: [],
          repair_count: 0,
          model_label: 'FAST' as 'FAST' | 'QUALITY' | 'CHEAP' | 'REF',
        },
        safety: { blocked: false, message: null },
      };

      useWorldStore.getState().applyTurnOutput(mockOutput as TurnOutput);

      // 1ë‹¨ê³„: markConsuming í˜¸ì¶œ í™•ì¸
      expect(useInventoryStore.getState().consumingItemIds).toContain('key_01');
      expect(useInventoryStore.getState().items).toHaveLength(1); // ì•„ì§ ì œê±° ì „

      // 2ë‹¨ê³„: 500ms ê²½ê³¼ í›„ ì œê±° í™•ì¸
      vi.advanceTimersByTime(500);
      expect(useInventoryStore.getState().items).toHaveLength(0); // ì œê±°ë¨
      expect(useInventoryStore.getState().consumingItemIds).not.toContain('key_01');
    });
  });
});
</file>

<file path="frontend/src/stores/onboardingStore.test.ts">
/**
 * Unknown World - Onboarding Store Unit Tests
 *
 * U-117[Mvp]: ì˜¨ë³´ë”© ê°€ì´ë“œ íŒì—… ì œê±° ê²€ì¦
 */

import { describe, it, expect, beforeEach } from 'vitest';
import {
  useOnboardingStore,
  selectShouldShowHotspotHint,
  selectShouldShowItemHint,
} from './onboardingStore';

describe('onboardingStore', () => {
  beforeEach(() => {
    useOnboardingStore.getState().resetOnboarding();
  });

  it('should not have popup related states (showOnboarding, onboardingStep, onboardingComplete)', () => {
    const state = useOnboardingStore.getState() as unknown as Record<string, unknown>;

    // ì œê±°ëœ ìƒíƒœë“¤ì´ ì¡´ì¬í•˜ì§€ ì•Šì•„ì•¼ í•¨
    expect(state.showOnboarding).toBeUndefined();
    expect(state.onboardingStep).toBeUndefined();
    expect(state.onboardingComplete).toBeUndefined();
  });

  it('should maintain hint count system for hover hints', () => {
    const state = useOnboardingStore.getState();

    expect(state.hotspotHintCount).toBe(0);
    expect(state.itemHintCount).toBe(0);

    // íŒíŠ¸ í‘œì‹œ ì—¬ë¶€ ì…€ë ‰í„° ì‘ë™ í™•ì¸
    expect(selectShouldShowHotspotHint(state)).toBe(true);
    expect(selectShouldShowItemHint(state)).toBe(true);
  });

  it('should increment hint counts and eventually hide hints', () => {
    // 3ë²ˆ ì¦ê°€ ì‹œë„ (HINT_THRESHOLD = 3)
    useOnboardingStore.getState().incrementHotspotHint();
    useOnboardingStore.getState().incrementHotspotHint();
    useOnboardingStore.getState().incrementHotspotHint();

    const stateAfter3 = useOnboardingStore.getState();
    expect(stateAfter3.hotspotHintCount).toBe(3);
    expect(selectShouldShowHotspotHint(stateAfter3)).toBe(false); // 3íšŒ ì´ìƒì´ë©´ false

    // ë” ì¦ê°€í•˜ì§€ ì•Šì•„ì•¼ í•¨ (HINT_THRESHOLD ì´ìƒì´ë©´ ë¬´ì‹œ)
    useOnboardingStore.getState().incrementHotspotHint();
    expect(useOnboardingStore.getState().hotspotHintCount).toBe(3);
  });
});
</file>

<file path="frontend/src/stores/onboardingStore.ts">
/**
 * Unknown World - ì¸í„°ë™ì…˜ íŒíŠ¸ ìƒíƒœ ê´€ë¦¬ ìŠ¤í† ì–´
 *
 * U-074[Mvp]: í•«ìŠ¤íŒŸ/ì•„ì´í…œ ì¸í„°ë™ì…˜ ì•ˆë‚´ UX
 * - Q1 Option B: ì²« Në²ˆë§Œ hover íŒíŠ¸ í‘œì‹œ í›„ ìˆ¨ê¹€ (í•™ìŠµ í›„ ì‚¬ë¼ì§)
 *
 * U-117[Mvp]: ì˜¨ë³´ë”© ê°€ì´ë“œ íŒì—… ì œê±°
 * - showOnboarding, onboardingStep, onboardingComplete ìƒíƒœ ì œê±°
 * - ê´€ë ¨ ì•¡ì…˜/ì…€ë ‰í„°/initializeOnboarding í•¨ìˆ˜ ì œê±°
 * - hover íŒíŠ¸ ì‹œìŠ¤í…œ(ì²« NíšŒ ë…¸ì¶œ í›„ ìˆ¨ê¹€)ë§Œ ìœ ì§€
 *
 * RULE-006 ì¤€ìˆ˜: i18n í‚¤ ê¸°ë°˜ í…ìŠ¤íŠ¸
 *
 * @module stores/onboardingStore
 */

import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';

// =============================================================================
// ìƒìˆ˜ ì •ì˜
// =============================================================================

/** íŒíŠ¸ë¥¼ í‘œì‹œí•  ìµœëŒ€ íšŸìˆ˜ (ì´í›„ ìˆ¨ê¹€) */
const HINT_THRESHOLD = 3;

/** localStorage í‚¤ */
const STORAGE_KEY = 'unknown-world-onboarding';

// =============================================================================
// íƒ€ì… ì •ì˜
// =============================================================================

interface OnboardingState {
  /** í•«ìŠ¤íŒŸ hover íšŸìˆ˜ (ì²« Në²ˆ í›„ íŒíŠ¸ ìˆ¨ê¹€) */
  hotspotHintCount: number;

  /** ì•„ì´í…œ hover íšŸìˆ˜ (ì²« Në²ˆ í›„ íŒíŠ¸ ìˆ¨ê¹€) */
  itemHintCount: number;
}

interface OnboardingActions {
  /** í•«ìŠ¤íŒŸ íŒíŠ¸ í‘œì‹œ íšŸìˆ˜ ì¦ê°€ */
  incrementHotspotHint: () => void;

  /** ì•„ì´í…œ íŒíŠ¸ í‘œì‹œ íšŸìˆ˜ ì¦ê°€ */
  incrementItemHint: () => void;

  /** íŒíŠ¸ ìƒíƒœ ì´ˆê¸°í™” (ê°œë°œ/í…ŒìŠ¤íŠ¸ìš©) */
  resetOnboarding: () => void;
}

type OnboardingStore = OnboardingState & OnboardingActions;

// =============================================================================
// ì´ˆê¸° ìƒíƒœ
// =============================================================================

const initialState: OnboardingState = {
  hotspotHintCount: 0,
  itemHintCount: 0,
};

// =============================================================================
// ì…€ë ‰í„° í•¨ìˆ˜ (ì„±ëŠ¥ ìµœì í™”)
// =============================================================================

/**
 * í•«ìŠ¤íŒŸ íŒíŠ¸ í‘œì‹œ ì—¬ë¶€ (ì²« Në²ˆë§Œ true)
 */
export const selectShouldShowHotspotHint = (state: OnboardingState): boolean =>
  state.hotspotHintCount < HINT_THRESHOLD;

/**
 * ì•„ì´í…œ íŒíŠ¸ í‘œì‹œ ì—¬ë¶€ (ì²« Në²ˆë§Œ true)
 */
export const selectShouldShowItemHint = (state: OnboardingState): boolean =>
  state.itemHintCount < HINT_THRESHOLD;

// =============================================================================
// Zustand Store
// =============================================================================

export const useOnboardingStore = create<OnboardingStore>()(
  persist(
    (set, get) => ({
      ...initialState,

      incrementHotspotHint: () => {
        const { hotspotHintCount } = get();
        if (hotspotHintCount < HINT_THRESHOLD) {
          set({ hotspotHintCount: hotspotHintCount + 1 });
        }
      },

      incrementItemHint: () => {
        const { itemHintCount } = get();
        if (itemHintCount < HINT_THRESHOLD) {
          set({ itemHintCount: itemHintCount + 1 });
        }
      },

      resetOnboarding: () => {
        set(initialState);
      },
    }),
    {
      name: STORAGE_KEY,
      storage: createJSONStorage(() => localStorage),
      partialize: (state) => ({
        hotspotHintCount: state.hotspotHintCount,
        itemHintCount: state.itemHintCount,
      }),
    },
  ),
);

// =============================================================================
// ìƒìˆ˜ ë…¸ì¶œ (í…ŒìŠ¤íŠ¸ìš©)
// =============================================================================

/**
 * íŒíŠ¸ ì„ê³„ê°’ ìƒìˆ˜ ë…¸ì¶œ (í…ŒìŠ¤íŠ¸ìš©)
 */
export const ONBOARDING_HINT_THRESHOLD = HINT_THRESHOLD;
</file>

<file path="frontend/src/styles/hotspot.css">
/**
 * Unknown World - í•«ìŠ¤íŒŸ ì „ìš© ìŠ¤íƒ€ì¼
 *
 * U-058[Mvp]: í•«ìŠ¤íŒŸ ë””ìì¸ ê°œì„ 
 * - Q1 Option C: Magenta/Purple ê³„ì—´ ê°•ì¡°
 * - Q2 Option A: Lì ë¸Œë¼ì¼“ ì½”ë„ˆ ë§ˆì»¤
 *
 * RULE-009 ì¤€ìˆ˜: ìŠ¤íƒ€ì¼ë§Œ ë³€ê²½, ì¢Œí‘œ ë¡œì§ ë¶ˆë³€
 * RULE-002 ì¤€ìˆ˜: ì±„íŒ… UIê°€ ì•„ë‹Œ ê²Œì„ UI
 *
 * @see vibe/ref/frontend-style-guide.md
 */

/* ============================================
   1. í•«ìŠ¤íŒŸ ë ˆì´ì–´ (ì¥ë©´ ì´ë¯¸ì§€ ìœ„ ì˜¤ë²„ë ˆì´)
   ============================================ */

.hotspot-layer {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 10;
}

/* ============================================
   2. í•«ìŠ¤íŒŸ ì»´í¬ë„ŒíŠ¸ ê¸°ë³¸ ìŠ¤íƒ€ì¼
   - Lì ì½”ë„ˆ ë§ˆì»¤ + ì–‡ì€ ìŠ¤íŠ¸ë¡œí¬ + ë°˜íˆ¬ëª… ë°°ê²½
   ============================================ */

.hotspot {
  position: absolute;
  pointer-events: auto;
  cursor: pointer;

  /* ë©´: ë¯¸ì„¸í•œ ë§ˆì  íƒ€ í‹´íŠ¸ (ì½˜í…ì¸  ê°€ì‹œì„± ë³´í˜¸) */
  background-color: var(--hotspot-bg);

  /* í…Œë‘ë¦¬: ì–‡ì€ ë§ˆì  íƒ€ (ê¸°ì¡´ dashed ëŒ€ì‹  solid) */
  border: var(--hotspot-stroke-width) solid var(--hotspot-primary);
  border-radius: 2px;

  /* ê¸€ë¡œìš°: ë¶€ë“œëŸ¬ìš´ ë§ˆì  íƒ€ ì™¸ê³½ì„  */
  box-shadow:
    0 0 6px var(--hotspot-glow),
    inset 0 0 2px rgba(224, 64, 251, 0.1);

  /* GPU ê°€ì†: ë‹¤ìˆ˜ í•«ìŠ¤íŒŸ ì„±ëŠ¥ ìµœì í™” */
  will-change: transform, box-shadow;

  /* ìƒíƒœ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ */
  transition:
    border-color 0.2s ease-out,
    background-color 0.2s ease-out,
    box-shadow 0.2s ease-out,
    transform 0.15s ease-out;
}

/* ============================================
   2.1 Lì ì½”ë„ˆ ë§ˆì»¤ (pseudo-elements)
   - 4ê°œ ì½”ë„ˆì— SF/í„°ë¯¸ë„ ëŠë‚Œì˜ ë¸Œë¼ì¼“
   ============================================ */

/* ì½”ë„ˆ ë§ˆì»¤ ê³µí†µ ìŠ¤íƒ€ì¼ */
.hotspot::before,
.hotspot::after,
.hotspot-corners::before,
.hotspot-corners::after {
  content: '';
  position: absolute;
  width: var(--hotspot-corner-size);
  height: var(--hotspot-corner-size);
  pointer-events: none;
  z-index: 1;
}

/* ì¢Œìƒë‹¨ ì½”ë„ˆ (::before) */
.hotspot::before {
  top: -1px;
  left: -1px;
  border-top: var(--hotspot-corner-thickness) solid var(--hotspot-primary);
  border-left: var(--hotspot-corner-thickness) solid var(--hotspot-primary);
  border-radius: 2px 0 0 0;
}

/* ìš°ìƒë‹¨ ì½”ë„ˆ (::after) */
.hotspot::after {
  top: -1px;
  right: -1px;
  border-top: var(--hotspot-corner-thickness) solid var(--hotspot-primary);
  border-right: var(--hotspot-corner-thickness) solid var(--hotspot-primary);
  border-radius: 0 2px 0 0;
}

/* ì¢Œí•˜ë‹¨, ìš°í•˜ë‹¨ ì½”ë„ˆëŠ” ë‚´ë¶€ ìš”ì†Œë¡œ êµ¬í˜„ */
.hotspot-corners {
  position: absolute;
  inset: 0;
  pointer-events: none;
}

.hotspot-corners::before {
  bottom: -1px;
  left: -1px;
  top: auto;
  border-bottom: var(--hotspot-corner-thickness) solid var(--hotspot-primary);
  border-left: var(--hotspot-corner-thickness) solid var(--hotspot-primary);
  border-radius: 0 0 0 2px;
}

.hotspot-corners::after {
  bottom: -1px;
  right: -1px;
  top: auto;
  border-bottom: var(--hotspot-corner-thickness) solid var(--hotspot-primary);
  border-right: var(--hotspot-corner-thickness) solid var(--hotspot-primary);
  border-radius: 0 0 2px 0;
}

/* ============================================
   3. í˜¸ë²„ ìƒíƒœ (ë§ˆìš°ìŠ¤ ì˜¤ë²„)
   - ìƒ‰ìƒ ë°ê¸° ì¦ê°€ + ì½”ë„ˆ ë§ˆì»¤ í™•ëŒ€ íš¨ê³¼
   ============================================ */

.hotspot.hovered {
  background-color: rgba(240, 98, 146, 0.08);
  border-color: var(--hotspot-hover);
  box-shadow:
    0 0 10px rgba(240, 98, 146, 0.5),
    0 0 20px rgba(240, 98, 146, 0.2),
    inset 0 0 4px rgba(240, 98, 146, 0.15);
  transform: scale(1.01);
  /* í˜¸ë²„ ì‹œ z-indexë¥¼ ìµœìƒìœ„ë¡œ ì˜¬ë ¤ íˆ´íŒì´ ë‹¤ë¥¸ í•«ìŠ¤íŒŸ ìœ„ì— í‘œì‹œ */
  z-index: 100 !important;
}

/* í˜¸ë²„ ì‹œ ì½”ë„ˆ ë§ˆì»¤ ìƒ‰ìƒ ë³€ê²½ */
.hotspot.hovered::before,
.hotspot.hovered::after {
  border-color: var(--hotspot-hover);
}

.hotspot.hovered .hotspot-corners::before,
.hotspot.hovered .hotspot-corners::after {
  border-color: var(--hotspot-hover);
}

/* ì½”ë„ˆ ë§ˆì»¤ ë¯¸ì„¸ í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ (í˜¸ë²„ ì‹œ) */
.hotspot.hovered::before,
.hotspot.hovered::after,
.hotspot.hovered .hotspot-corners::before,
.hotspot.hovered .hotspot-corners::after {
  animation: corner-pulse 1.5s ease-in-out infinite;
}

@keyframes corner-pulse {
  0%,
  100% {
    opacity: 1;
  }
  50% {
    opacity: 0.7;
  }
}

/* ============================================
   4. í¬ì»¤ìŠ¤ ìƒíƒœ (í‚¤ë³´ë“œ ì ‘ê·¼ì„±)
   ============================================ */

.hotspot:focus {
  outline: none;
}

.hotspot:focus-visible {
  outline: 2px solid var(--hotspot-active);
  outline-offset: 3px;
}

/* ============================================
   5. ë“œë¡­ íƒ€ê²Ÿ ìƒíƒœ (DnD ë“œë˜ê·¸ ì˜¤ë²„)
   - ì•°ë²„ ìƒ‰ìƒ + ì ë©¸ íš¨ê³¼
   ============================================ */

.hotspot.drop-target-active {
  background-color: rgba(255, 171, 64, 0.1);
  border-color: var(--hotspot-drop);
  border-width: 2px;
  box-shadow:
    0 0 12px rgba(255, 171, 64, 0.5),
    0 0 24px rgba(255, 171, 64, 0.25),
    inset 0 0 6px rgba(255, 171, 64, 0.2);
  transform: scale(1.02);
  animation: drop-target-glow 0.8s ease-in-out infinite;
}

@keyframes drop-target-glow {
  0%,
  100% {
    box-shadow:
      0 0 12px rgba(255, 171, 64, 0.5),
      0 0 24px rgba(255, 171, 64, 0.25),
      inset 0 0 6px rgba(255, 171, 64, 0.2);
  }
  50% {
    box-shadow:
      0 0 16px rgba(255, 171, 64, 0.7),
      0 0 32px rgba(255, 171, 64, 0.35),
      inset 0 0 8px rgba(255, 171, 64, 0.3);
  }
}

/* ë“œë¡­ íƒ€ê²Ÿ ì‹œ ì½”ë„ˆ ë§ˆì»¤ ìƒ‰ìƒ ë³€ê²½ */
.hotspot.drop-target-active::before,
.hotspot.drop-target-active::after,
.hotspot.drop-target-active .hotspot-corners::before,
.hotspot.drop-target-active .hotspot-corners::after {
  border-color: var(--hotspot-drop);
  animation: corner-blink 0.6s ease-in-out infinite;
}

@keyframes corner-blink {
  0%,
  100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

/* ============================================
   6. ë¹„í™œì„±í™” ìƒíƒœ
   - íë¦¿í•œ ìƒ‰ìƒ + ì ì„  í…Œë‘ë¦¬
   ============================================ */

.hotspot.disabled {
  cursor: not-allowed;
  background-color: rgba(156, 39, 176, 0.03);
  border-color: var(--hotspot-primary-dim);
  border-style: dashed;
  box-shadow: none;
  opacity: 0.5;
}

/* ë¹„í™œì„±í™” ì‹œ ì½”ë„ˆ ë§ˆì»¤ ìˆ¨ê¹€ */
.hotspot.disabled::before,
.hotspot.disabled::after,
.hotspot.disabled .hotspot-corners::before,
.hotspot.disabled .hotspot-corners::after {
  opacity: 0.3;
  border-color: var(--hotspot-primary-dim);
}

.hotspot.disabled:hover {
  transform: none;
  border-color: var(--hotspot-primary-dim);
  background-color: rgba(156, 39, 176, 0.03);
}

/* ============================================
   7. ë°ëª¨ ìƒíƒœ (ì‹œê°ì  íŒíŠ¸)
   ============================================ */

.hotspot.demo-target {
  animation: demo-hint 2s ease-in-out infinite;
}

@keyframes demo-hint {
  0%,
  100% {
    box-shadow:
      0 0 6px var(--hotspot-glow),
      inset 0 0 2px rgba(224, 64, 251, 0.1);
  }
  50% {
    box-shadow:
      0 0 12px var(--hotspot-glow),
      0 0 20px rgba(224, 64, 251, 0.2),
      inset 0 0 4px rgba(224, 64, 251, 0.15);
  }
}

/* ============================================
   8. í•«ìŠ¤íŒŸ íˆ´íŒ
   - ë§ˆì  íƒ€ í…Œë§ˆ ì ìš©
   ============================================ */

.hotspot-tooltip {
  position: absolute;
  bottom: calc(100% + 10px);
  left: 50%;
  transform: translateX(-50%);
  min-width: 100px;
  /* ë‹¤ë¥¸ í•«ìŠ¤íŒŸ í´ë¦­ì„ ì°¨ë‹¨í•˜ì§€ ì•Šë„ë¡ ì´ë²¤íŠ¸ íˆ¬ê³¼ */
  pointer-events: none;
  max-width: 220px;
  padding: var(--spacing-xs) var(--spacing-sm);
  background-color: rgba(20, 0, 30, 0.95);
  border: 1px solid var(--hotspot-primary);
  border-radius: 3px;
  box-shadow:
    0 0 8px var(--hotspot-glow),
    0 4px 12px rgba(0, 0, 0, 0.8);
  z-index: 20;
  white-space: nowrap;
  animation: tooltip-appear 0.15s ease-out;
}

@keyframes tooltip-appear {
  from {
    opacity: 0;
    transform: translateX(-50%) translateY(6px);
  }
  to {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
}

/* íˆ´íŒ í™”ì‚´í‘œ */
.hotspot-tooltip::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 7px solid transparent;
  border-top-color: var(--hotspot-primary);
}

/* ìƒë‹¨ ì—¬ë°± ë¶€ì¡± ì‹œ íˆ´íŒì„ ì•„ë˜ìª½ì— í‘œì‹œ */
.hotspot.tooltip-below .hotspot-tooltip {
  bottom: auto;
  top: calc(100% + 10px);
}

.hotspot.tooltip-below .hotspot-tooltip::after {
  top: auto;
  bottom: 100%;
  border-top-color: transparent;
  border-bottom-color: var(--hotspot-primary);
}

/* ë“œë¡­ íƒ€ê²Ÿ + ì•„ë˜ìª½ íˆ´íŒ í™”ì‚´í‘œ ìƒ‰ìƒ */
.hotspot.tooltip-below.drop-target-active .hotspot-tooltip::after {
  border-top-color: transparent;
  border-bottom-color: var(--hotspot-drop);
}

/* íˆ´íŒ ë¼ë²¨ */
.hotspot-tooltip-label {
  display: block;
  font-size: var(--font-size-sm);
  font-weight: bold;
  color: var(--hotspot-primary);
  text-transform: uppercase;
  letter-spacing: 1px;
  text-shadow: 0 0 4px rgba(224, 64, 251, 0.4);
  -webkit-font-smoothing: antialiased;
}

/* ë°ëª¨ íŒíŠ¸ */
.hotspot-tooltip-demo {
  display: block;
  margin-top: 3px;
  font-size: var(--font-size-xs);
  color: var(--hotspot-hover);
  font-style: italic;
}

/* ìƒí˜¸ì‘ìš© íŒíŠ¸ */
.hotspot-tooltip-hint {
  display: block;
  margin-top: 3px;
  font-size: var(--font-size-xs);
  color: var(--text-dim);
}

/* ë“œë¡­ íŒíŠ¸ */
.hotspot-tooltip-drop-hint {
  display: block;
  margin-top: 4px;
  font-size: var(--font-size-sm);
  font-weight: bold;
  color: var(--hotspot-drop);
  text-transform: uppercase;
  letter-spacing: 1px;
  animation: drop-hint-flash 0.6s ease-in-out infinite;
}

@keyframes drop-hint-flash {
  0%,
  100% {
    opacity: 1;
  }
  50% {
    opacity: 0.6;
  }
}

/* ë“œë¡­ íƒ€ê²Ÿ í™œì„± ì‹œ íˆ´íŒ í…Œë‘ë¦¬ ìƒ‰ìƒ ë³€ê²½ */
.hotspot.drop-target-active .hotspot-tooltip {
  border-color: var(--hotspot-drop);
  box-shadow:
    0 0 10px rgba(255, 171, 64, 0.4),
    0 4px 12px rgba(0, 0, 0, 0.8);
}

.hotspot.drop-target-active .hotspot-tooltip::after {
  border-top-color: var(--hotspot-drop);
}

/* ============================================
   9. ëª¨ë°”ì¼ ì¡°ì •
   ============================================ */

@media (max-width: 768px) {
  .hotspot {
    /* í„°ì¹˜ ì˜ì—­ ìµœì†Œ 44px ë³´ì¥ */
    min-width: 44px;
    min-height: 44px;
  }

  /* ëª¨ë°”ì¼ì—ì„œ íˆ´íŒì€ ì•„ë˜ë¡œ í‘œì‹œ */
  .hotspot-tooltip {
    bottom: auto;
    top: calc(100% + 8px);
    max-width: 160px;
  }

  .hotspot-tooltip::after {
    top: auto;
    bottom: 100%;
    border-top-color: transparent;
    border-bottom-color: var(--hotspot-primary);
  }

  .hotspot.drop-target-active .hotspot-tooltip::after {
    border-top-color: transparent;
    border-bottom-color: var(--hotspot-drop);
  }

  /* ì½”ë„ˆ ë§ˆì»¤ í¬ê¸° ì¶•ì†Œ */
  .hotspot::before,
  .hotspot::after,
  .hotspot-corners::before,
  .hotspot-corners::after {
    width: 8px;
    height: 8px;
  }
}

/* ============================================
   10. ì ‘ê·¼ì„±: reduced-motion
   ============================================ */

@media (prefers-reduced-motion: reduce) {
  .hotspot {
    transition: none;
    will-change: auto;
  }

  .hotspot.hovered {
    transform: none;
  }

  .hotspot.drop-target-active {
    animation: none;
    transform: none;
  }

  .hotspot.demo-target {
    animation: none;
  }

  .hotspot.hovered::before,
  .hotspot.hovered::after,
  .hotspot.hovered .hotspot-corners::before,
  .hotspot.hovered .hotspot-corners::after,
  .hotspot.drop-target-active::before,
  .hotspot.drop-target-active::after,
  .hotspot.drop-target-active .hotspot-corners::before,
  .hotspot.drop-target-active .hotspot-corners::after {
    animation: none;
  }

  .hotspot-tooltip {
    animation: none;
  }

  .hotspot-tooltip-drop-hint {
    animation: none;
  }
}

/* ============================================
   11. ê³ ëŒ€ë¹„ ëª¨ë“œ ì§€ì›
   ============================================ */

@media (prefers-contrast: more) {
  .hotspot {
    border-width: 2px;
    box-shadow:
      0 0 0 1px rgba(0, 0, 0, 0.8),
      0 0 8px var(--hotspot-glow);
  }

  .hotspot::before,
  .hotspot::after,
  .hotspot-corners::before,
  .hotspot-corners::after {
    border-width: 3px;
  }

  .hotspot-tooltip {
    border-width: 2px;
  }
}
</file>

<file path="frontend/vite.config.ts">
/// <reference types="vitest" />
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
  server: {
    port: 8001, // RULE-011: í”„ë¡ íŠ¸ì—”ë“œëŠ” 8001~8010 ì‚¬ìš©
    strictPort: true, // í¬íŠ¸ ì¶©ëŒ ì‹œ fail-fast (ëŒ€ì—­ ë°– ì´ë™ ë°©ì§€)
    // ì¶©ëŒ ì‹œ: pnpm -C frontend dev --port 8002 (8002~8010 ì¤‘ ì„ íƒ)
    proxy: {
      // ë°±ì—”ë“œ API í”„ë¡ì‹œ (RULE-011: ë°±ì—”ë“œëŠ” 8011~8020)
      '/api': {
        target: 'http://localhost:8011',
        changeOrigin: true,
      },
      // ì •ì  íŒŒì¼ í”„ë¡ì‹œ (ì´ë¯¸ì§€ ë“±)
      '/static': {
        target: 'http://localhost:8011',
        changeOrigin: true,
      },
    },
  },
  build: {
    outDir: 'dist',
    sourcemap: true,
  },
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: './src/setupTests.ts',
  },
});
</file>

<file path="frontend/src/api/image.ts">
/**
 * Unknown World - ì´ë¯¸ì§€ ìƒì„± API í´ë¼ì´ì–¸íŠ¸ (U-066)
 *
 * ì´ë¯¸ì§€ ìƒì„±ì„ í„´ê³¼ ë¶„ë¦¬í•˜ì—¬ ë¹„ë™ê¸°ì ìœ¼ë¡œ í˜¸ì¶œí•©ë‹ˆë‹¤.
 * í…ìŠ¤íŠ¸ í„´ì˜ TTFBë¥¼ ë¸”ë¡œí‚¹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (RULE-008).
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - RULE-004: ì‹¤íŒ¨ ì‹œ ì•ˆì „í•œ í´ë°± (í…ìŠ¤íŠ¸-only ì§„í–‰)
 *   - RULE-007: í”„ë¡¬í”„íŠ¸ ì›ë¬¸ ë…¸ì¶œ ê¸ˆì§€ (ë¡œê·¸ì— í•´ì‹œë§Œ ê¸°ë¡)
 *   - RULE-008: í…ìŠ¤íŠ¸ ìš°ì„  + Lazy ì´ë¯¸ì§€ ì›ì¹™
 *
 * @module api/image
 */

import type { Language } from '../schemas/turn';

// =============================================================================
// ìƒìˆ˜ ì •ì˜
// =============================================================================

/** API ë² ì´ìŠ¤ URL */
const API_BASE_URL = import.meta.env.VITE_API_URL ?? 'http://localhost:8011';

/** ì´ë¯¸ì§€ ìƒì„± API ì—”ë“œí¬ì¸íŠ¸ */
const IMAGE_GENERATE_ENDPOINT = `${API_BASE_URL}/api/image/generate`;

// =============================================================================
// íƒ€ì… ì •ì˜
// =============================================================================

/** ì´ë¯¸ì§€ ìƒì„± ìƒíƒœ */
export type ImageGenerationStatus = 'pending' | 'generating' | 'completed' | 'failed' | 'skipped';

/** ëª¨ë¸ í‹°ì–´ë§ ë¼ë²¨ (U-066) */
export type ImageModelLabel = 'FAST' | 'QUALITY';

/** ì´ë¯¸ì§€ ìƒì„± ìš”ì²­ íŒŒë¼ë¯¸í„° */
export interface ImageGenerationRequest {
  /** ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸ (í•„ìˆ˜) */
  prompt: string;
  /** ì–¸ì–´ (ì—ëŸ¬ ë©”ì‹œì§€ìš©) */
  language?: Language;
  /** ê°€ë¡œì„¸ë¡œ ë¹„ìœ¨ (U-085: UI ë ˆì´ì•„ì›ƒ ê¸°ë°˜ ìë™ ì„ íƒ, ì˜ˆ: "16:9") */
  aspectRatio?: string;
  /** ì´ë¯¸ì§€ í¬ê¸° - SDK ê°’ (U-085 Q2: "1K" | "2K" | "4K") */
  imageSize?: string;
  /** ì°¸ì¡° ì´ë¯¸ì§€ ID ëª©ë¡ */
  referenceImageIds?: string[];
  /** ì°¸ì¡° ì´ë¯¸ì§€ URL (U-068: ì´ì „ í„´ ì´ë¯¸ì§€ë¥¼ ì°¸ì¡°í•˜ì—¬ ì—°ì†ì„± ìœ ì§€) */
  referenceImageUrl?: string;
  /** ì„¸ì…˜ ID */
  sessionId?: string;
  /** ì‹¤íŒ¨ ì‹œ ê±´ë„ˆë›°ê¸° (ê¸°ë³¸ê°’: true) */
  skipOnFailure?: boolean;
  /** ëª¨ë¸ í‹°ì–´ë§ ë¼ë²¨ (U-066: FAST/QUALITY) */
  modelLabel?: ImageModelLabel;
  /** í„´ ID (late-binding ê°€ë“œìš©, U-066) */
  turnId?: number;
}

/** ì´ë¯¸ì§€ ìƒì„± ì‘ë‹µ */
export interface ImageGenerationResponse {
  /** ì„±ê³µ ì—¬ë¶€ */
  success: boolean;
  /** ìƒì„± ìƒíƒœ */
  status: ImageGenerationStatus;
  /** ìƒì„±ëœ ì´ë¯¸ì§€ ID */
  imageId?: string;
  /** ìƒì„±ëœ ì´ë¯¸ì§€ URL */
  imageUrl?: string;
  /** ìƒíƒœ ë©”ì‹œì§€ */
  message?: string;
  /** ìƒì„± ì†Œìš” ì‹œê°„ (ms) */
  generationTimeMs: number;
  /** ì‚¬ìš©ëœ ëª¨ë¸ ë¼ë²¨ (U-066) */
  modelLabel: ImageModelLabel;
  /** ìš”ì²­ í„´ ID (U-066, late-binding ê°€ë“œìš©) */
  turnId?: number;
}

/** ì´ë¯¸ì§€ ìƒì„± ì˜µì…˜ */
export interface GenerateImageOptions {
  /** AbortSignal (ìš”ì²­ ì·¨ì†Œìš©) */
  signal?: AbortSignal;
  /** íƒ€ì„ì•„ì›ƒ (ms, ê¸°ë³¸ê°’: 60000) */
  timeout?: number;
}

// =============================================================================
// API í´ë¼ì´ì–¸íŠ¸ í•¨ìˆ˜
// =============================================================================

/**
 * ì´ë¯¸ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
 *
 * í„´ê³¼ ë¶„ë¦¬ëœ ë¹„ë™ê¸° í˜¸ì¶œë¡œ, í…ìŠ¤íŠ¸ ìŠ¤íŠ¸ë¦¬ë°ì„ ë¸”ë¡œí‚¹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
 * AbortControllerë¡œ ìš”ì²­ì„ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
 *
 * @param request - ì´ë¯¸ì§€ ìƒì„± ìš”ì²­ íŒŒë¼ë¯¸í„°
 * @param options - ìƒì„± ì˜µì…˜ (signal, timeout)
 * @returns ì´ë¯¸ì§€ ìƒì„± ì‘ë‹µ
 *
 * @example
 * ```ts
 * const controller = new AbortController();
 * const response = await generateImage(
 *   { prompt: 'A dark fantasy scene...', turnId: 5, modelLabel: 'FAST' },
 *   { signal: controller.signal }
 * );
 * if (response.success) {
 *   console.log('Image URL:', response.imageUrl);
 * }
 * // ì·¨ì†Œ ì‹œ: controller.abort();
 * ```
 */
export async function generateImage(
  request: ImageGenerationRequest,
  options: GenerateImageOptions = {},
): Promise<ImageGenerationResponse> {
  const { signal, timeout = 60000 } = options;

  // íƒ€ì„ì•„ì›ƒ AbortController (signalì´ ì—†ì„ ë•Œ ì‚¬ìš©)
  const timeoutController = new AbortController();
  const timeoutId = setTimeout(() => timeoutController.abort(), timeout);

  // ì™¸ë¶€ signalê³¼ íƒ€ì„ì•„ì›ƒ signal ì¤‘ ë¨¼ì € abortë˜ëŠ” ê²ƒì„ ì‚¬ìš©
  const combinedSignal = signal ?? timeoutController.signal;

  try {
    const response = await fetch(IMAGE_GENERATE_ENDPOINT, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        prompt: request.prompt,
        language: request.language ?? 'ko-KR',
        // U-085: aspect_ratioëŠ” UI ë ˆì´ì•„ì›ƒ ê¸°ë°˜ ì„ íƒê°’ ì‚¬ìš© (ê¸°ë³¸ 16:9)
        aspect_ratio: request.aspectRatio ?? '16:9',
        // U-085 Q2: image_sizeëŠ” SDK ê°’ (1K/2K/4K) ì‚¬ìš©
        image_size: request.imageSize ?? '1K',
        reference_image_ids: request.referenceImageIds ?? [],
        reference_image_url: request.referenceImageUrl ?? null,
        session_id: request.sessionId ?? null,
        skip_on_failure: request.skipOnFailure ?? true,
        model_label: request.modelLabel ?? 'QUALITY',
        turn_id: request.turnId ?? null,
      }),
      signal: combinedSignal,
    });

    clearTimeout(timeoutId);

    if (!response.ok) {
      // HTTP ì—ëŸ¬ ì‘ë‹µ ì²˜ë¦¬
      const errorText = await response.text().catch(() => 'Unknown error');
      return {
        success: false,
        status: 'failed',
        message: `HTTP ${response.status}: ${errorText}`,
        generationTimeMs: 0,
        modelLabel: request.modelLabel ?? 'QUALITY',
        turnId: request.turnId,
      };
    }

    const data = await response.json();

    // snake_case â†’ camelCase ë³€í™˜
    return {
      success: data.success,
      status: data.status,
      imageId: data.image_id,
      imageUrl: data.image_url,
      message: data.message,
      generationTimeMs: data.generation_time_ms ?? 0,
      modelLabel: data.model_label ?? request.modelLabel ?? 'QUALITY',
      turnId: data.turn_id ?? request.turnId,
    };
  } catch (error) {
    clearTimeout(timeoutId);

    // AbortError ì²˜ë¦¬ (ì·¨ì†Œë¨)
    if (error instanceof Error && error.name === 'AbortError') {
      return {
        success: false,
        status: 'skipped',
        message: 'ì´ë¯¸ì§€ ìƒì„±ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.',
        generationTimeMs: 0,
        modelLabel: request.modelLabel ?? 'QUALITY',
        turnId: request.turnId,
      };
    }

    // ê¸°íƒ€ ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬
    return {
      success: false,
      status: 'failed',
      message: error instanceof Error ? error.message : 'ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
      generationTimeMs: 0,
      modelLabel: request.modelLabel ?? 'QUALITY',
      turnId: request.turnId,
    };
  }
}

/**
 * ì´ë¯¸ì§€ ìƒì„± ìš”ì²­ì„ ìƒì„±í•˜ê³  AbortControllerë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
 *
 * í„´ ì™„ë£Œ í›„ ì´ë¯¸ì§€ ìƒì„±ì„ ì‹œì‘í•˜ê³ , ìƒˆ í„´ ì‹œì‘ ì‹œ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
 *
 * @param request - ì´ë¯¸ì§€ ìƒì„± ìš”ì²­ íŒŒë¼ë¯¸í„°
 * @param onComplete - ì™„ë£Œ ì½œë°±
 * @param onError - ì—ëŸ¬ ì½œë°±
 * @returns AbortController (ì·¨ì†Œìš©)
 *
 * @example
 * ```ts
 * const controller = startImageGeneration(
 *   { prompt: 'A dark fantasy scene...', turnId: 5 },
 *   (response) => {
 *     if (response.success) {
 *       worldStore.setSceneImage(response.imageUrl, response.turnId);
 *     }
 *   },
 *   (error) => console.error('Image generation failed:', error)
 * );
 *
 * // ìƒˆ í„´ ì‹œì‘ ì‹œ ì´ì „ ìš”ì²­ ì·¨ì†Œ
 * controller.abort();
 * ```
 */
export function startImageGeneration(
  request: ImageGenerationRequest,
  onComplete: (response: ImageGenerationResponse) => void,
  onError?: (error: Error) => void,
): AbortController {
  const controller = new AbortController();

  generateImage(request, { signal: controller.signal })
    .then(onComplete)
    .catch((error) => {
      if (error instanceof Error && error.name !== 'AbortError') {
        onError?.(error);
      }
    });

  return controller;
}
</file>

<file path="frontend/src/api/scanner.ts">
/**
 * Unknown World - Scanner(ì´ë¯¸ì§€ ì´í•´) API í´ë¼ì´ì–¸íŠ¸.
 *
 * U-022[Mvp]: Scanner ìŠ¬ë¡¯ UIì—ì„œ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œ ë°±ì—”ë“œ `/api/scan` í˜¸ì¶œ.
 * U-021 ì˜ì¡´: ë°±ì—”ë“œ Scanner ì—”ë“œí¬ì¸íŠ¸ì™€ ì—°ë™.
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - RULE-004: ì‹¤íŒ¨ ì‹œ ì•ˆì „í•œ í´ë°± (ì—ëŸ¬ ë©”ì‹œì§€ ë°˜í™˜)
 *   - RULE-007: íŒŒì¼ ë‚´ìš©/í”„ë¡¬í”„íŠ¸ ë¡œê¹… ê¸ˆì§€
 *   - RULE-009: bboxëŠ” 0~1000 ì •ê·œí™” + [ymin, xmin, ymax, xmax]
 *
 * @module api/scanner
 */

import { z } from 'zod';
import { Box2DSchema, type Language } from '../schemas/turn';

// =============================================================================
// ìƒìˆ˜
// =============================================================================

/** Scanner API ì—”ë“œí¬ì¸íŠ¸ ê¸°ë³¸ URL */
const SCANNER_API_BASE = '/api/scan';

/** ì§€ì›í•˜ëŠ” ì´ë¯¸ì§€ MIME íƒ€ì… */
export const ALLOWED_MIME_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'] as const;

/** ìµœëŒ€ íŒŒì¼ í¬ê¸° (20MB) */
export const MAX_FILE_SIZE_BYTES = 20 * 1024 * 1024;

// =============================================================================
// Zod ìŠ¤í‚¤ë§ˆ ì •ì˜ (ë°±ì—”ë“œ ì‘ë‹µê³¼ 1:1 ëŒ€ì‘)
// =============================================================================

/**
 * ìŠ¤ìº” ìƒíƒœ Enum.
 */
export const ScanStatusSchema = z.enum(['completed', 'partial', 'failed', 'blocked']);
export type ScanStatus = z.infer<typeof ScanStatusSchema>;

/**
 * ê°ì§€ëœ ì˜¤ë¸Œì íŠ¸.
 * RULE-009: bboxëŠ” 0~1000 ì •ê·œí™”.
 */
export const DetectedObjectSchema = z.object({
  label: z.string(),
  box_2d: Box2DSchema,
  confidence: z.number().min(0).max(1).nullable().optional(),
  suggested_item_type: z.string().nullable().optional(),
});
export type DetectedObject = z.infer<typeof DetectedObjectSchema>;

/**
 * ì•„ì´í…œ í›„ë³´.
 * ìŠ¤ìº” ê²°ê³¼ë¡œ ìƒì„±ë˜ëŠ” ê²Œì„ ì•„ì´í…œ í›„ë³´.
 */
export const ItemCandidateSchema = z.object({
  id: z.string(),
  label: z.string(),
  description: z.string().default(''),
  item_type: z.string().default('material'),
  source_object_index: z.number().int().min(0).nullable().optional(),
});
export type ItemCandidate = z.infer<typeof ItemCandidateSchema>;

/**
 * Scanner API ì‘ë‹µ.
 * RU-006-S1: original_image_key, original_image_url ì¶”ê°€
 */
export const ScannerResponseSchema = z.object({
  success: z.boolean(),
  status: ScanStatusSchema,
  caption: z.string().default(''),
  objects: z.array(DetectedObjectSchema).default([]),
  item_candidates: z.array(ItemCandidateSchema).default([]),
  message: z.string().nullable().optional(),
  analysis_time_ms: z.number().int().min(0).default(0),
  language: z.enum(['ko-KR', 'en-US']),
  original_image_key: z.string().nullable().optional(),
  original_image_url: z.string().nullable().optional(),
});
export type ScannerResponse = z.infer<typeof ScannerResponseSchema>;

// =============================================================================
// API í´ë¼ì´ì–¸íŠ¸ í•¨ìˆ˜
// =============================================================================

/**
 * ìŠ¤ìº” ê²°ê³¼ íƒ€ì….
 */
export type ScanResult =
  | { success: true; data: ScannerResponse }
  | { success: false; error: string; status: ScanStatus };

/**
 * ìŠ¤ìº” ì˜µì…˜.
 * RU-006-S1: preserve_original ì˜µì…˜ ì¶”ê°€
 */
export interface ScanOptions {
  /** ì›ë³¸ ì´ë¯¸ì§€ ì €ì¥ ì—¬ë¶€ (ë””ë²„ê¹…/ì¬ë¶„ì„ìš©) */
  preserveOriginal?: boolean;
  /** ì„¸ì…˜ ID (ì´ë¯¸ì§€ ê·¸ë£¹í™”ìš©) */
  sessionId?: string;
}

/**
 * ì´ë¯¸ì§€ë¥¼ ìŠ¤ìº”í•˜ì—¬ ì˜¤ë¸Œì íŠ¸ì™€ ì•„ì´í…œ í›„ë³´ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
 *
 * @param file - ë¶„ì„í•  ì´ë¯¸ì§€ íŒŒì¼
 * @param language - ì‘ë‹µ ì–¸ì–´
 * @param options - ìŠ¤ìº” ì˜µì…˜ (RU-006-S1)
 * @returns ìŠ¤ìº” ê²°ê³¼
 */
export async function scanImage(
  file: File,
  language: Language,
  options?: ScanOptions,
): Promise<ScanResult> {
  // í´ë¼ì´ì–¸íŠ¸ ì¸¡ íŒŒì¼ ê²€ì¦
  const validationError = validateFile(file);
  if (validationError) {
    return {
      success: false,
      error: validationError,
      status: 'failed',
    };
  }

  // FormData ìƒì„±
  const formData = new FormData();
  formData.append('file', file);
  formData.append('language', language);

  // RU-006-S1: ì„ íƒì  íŒŒë¼ë¯¸í„° ì¶”ê°€
  if (options?.preserveOriginal) {
    formData.append('preserve_original', 'true');
  }
  if (options?.sessionId) {
    formData.append('session_id', options.sessionId);
  }

  try {
    const response = await fetch(SCANNER_API_BASE, {
      method: 'POST',
      body: formData,
    });

    if (!response.ok) {
      console.error('[ScannerAPI] HTTP error', {
        status: response.status,
        statusText: response.statusText,
      });
      return {
        success: false,
        error:
          language === 'ko-KR'
            ? `ì„œë²„ ì˜¤ë¥˜: ${response.status}`
            : `Server error: ${response.status}`,
        status: 'failed',
      };
    }

    const json = await response.json();
    const parseResult = ScannerResponseSchema.safeParse(json);

    if (!parseResult.success) {
      console.error('[ScannerAPI] Response validation failed', parseResult.error);
      return {
        success: false,
        error:
          language === 'ko-KR'
            ? 'ì‘ë‹µ ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'
            : 'Invalid response data format.',
        status: 'failed',
      };
    }

    const data = parseResult.data;

    // ì„±ê³µ/ë¶€ë¶„ ì„±ê³µ ì—¬ë¶€ í™•ì¸
    if (data.status === 'completed' || data.status === 'partial') {
      return { success: true, data };
    }

    // ì‹¤íŒ¨/ì°¨ë‹¨ ì‘ë‹µ
    return {
      success: false,
      error: data.message ?? (language === 'ko-KR' ? 'ë¶„ì„ ì‹¤íŒ¨' : 'Analysis failed'),
      status: data.status,
    };
  } catch (error) {
    console.error('[ScannerAPI] Network error', { errorType: (error as Error).name });
    return {
      success: false,
      error:
        language === 'ko-KR'
          ? 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.'
          : 'Network error occurred. Please try again.',
      status: 'failed',
    };
  }
}

// =============================================================================
// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
// =============================================================================

/**
 * íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬.
 *
 * @param file - ê²€ì¦í•  íŒŒì¼
 * @returns ì˜¤ë¥˜ ë©”ì‹œì§€ (ì—†ìœ¼ë©´ null)
 */
export function validateFile(file: File): string | null {
  // MIME íƒ€ì… ê²€ì¦
  if (!ALLOWED_MIME_TYPES.includes(file.type as (typeof ALLOWED_MIME_TYPES)[number])) {
    return `ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤: ${file.type || 'ì•Œ ìˆ˜ ì—†ìŒ'}`;
  }

  // íŒŒì¼ í¬ê¸° ê²€ì¦
  if (file.size > MAX_FILE_SIZE_BYTES) {
    const sizeMB = (file.size / (1024 * 1024)).toFixed(1);
    return `íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤: ${sizeMB}MB (ìµœëŒ€ 20MB)`;
  }

  return null;
}

/**
 * ì§€ì› íŒŒì¼ í˜•ì‹ì¸ì§€ í™•ì¸.
 *
 * @param file - í™•ì¸í•  íŒŒì¼
 * @returns ì§€ì› ì—¬ë¶€
 */
export function isSupportedImageFile(file: File): boolean {
  return ALLOWED_MIME_TYPES.includes(file.type as (typeof ALLOWED_MIME_TYPES)[number]);
}

/**
 * ItemCandidateë¥¼ InventoryItemìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
 *
 * U-075: iconStatusë¥¼ 'pending'ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ì•„ì´ì½˜ ìƒì„± íŠ¸ë¦¬ê±°
 * - icon í•„ë“œì—ëŠ” ì„ì‹œ ì´ëª¨ì§€ë¥¼ ì„¤ì • (ìƒì„± ì „ í‘œì‹œìš©)
 * - InventoryPanelì—ì„œ iconStatusê°€ 'pending'ì´ë©´ ì•„ì´ì½˜ ìƒì„± ìš”ì²­
 *
 * @param candidate - ì•„ì´í…œ í›„ë³´
 * @returns InventoryItem í˜•íƒœì˜ ê°ì²´
 */
export function candidateToInventoryItem(candidate: ItemCandidate) {
  return {
    id: candidate.id,
    name: candidate.label,
    description: candidate.description,
    icon: getItemTypeEmoji(candidate.item_type),
    quantity: 1,
    iconStatus: 'pending' as const, // U-075: ì•„ì´ì½˜ ìƒì„± íŠ¸ë¦¬ê±°
  };
}

/**
 * ì•„ì´í…œ ìœ í˜•ì— ë”°ë¥¸ ì´ëª¨ì§€ ë°˜í™˜.
 *
 * @param itemType - ì•„ì´í…œ ìœ í˜•
 * @returns ì´ëª¨ì§€
 */
function getItemTypeEmoji(itemType: string): string {
  const emojiMap: Record<string, string> = {
    key: 'ğŸ”‘',
    weapon: 'âš”ï¸',
    tool: 'ğŸ”§',
    clue: 'ğŸ”',
    material: 'ğŸ“¦',
    consumable: 'ğŸ’Š',
    document: 'ğŸ“„',
    artifact: 'ğŸ’',
  };
  return emojiMap[itemType] ?? 'ğŸ“¦';
}
</file>

<file path="frontend/src/App.test.tsx">
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import App from './App';
import * as turnStream from './api/turnStream';
import { useInventoryStore } from './stores/inventoryStore';

// i18next ëª¨í‚¹ (RU-003-Q5: ë°ëª¨ i18n í‚¤ ì§€ì›)
vi.mock('react-i18next', () => ({
  useTranslation: () => ({
    t: (key: string, options?: Record<string, unknown>) => {
      // ë°ëª¨ ì•„ì´í…œ ì´ë¦„
      if (key === 'demo.items.keycard-alpha.name') return 'í‚¤ì¹´ë“œ A';
      if (key === 'demo.items.medkit.name') return 'ì‘ê¸‰ í‚¤íŠ¸';
      if (key === 'demo.items.flashlight.name') return 'ì†ì „ë“±';
      if (key === 'demo.items.data-chip.name') return 'ë°ì´í„°ì¹©';
      // ë°ëª¨ ì”¬ ì˜¤ë¸Œì íŠ¸ (í”„ë¡œí•„ ê¸°ë°˜)
      if (key === 'profile.tech.scene.terminal') return 'í„°ë¯¸ë„';
      if (key === 'profile.tech.scene.terminal_hint') return 'í™œì„±í™”ëœ í„°ë¯¸ë„ì´ë‹¤';
      // êµ¬ë²„ì „/ê³µí†µ ì”¬ ì˜¤ë¸Œì íŠ¸
      if (key === 'demo.scene.terminal.label') return 'í„°ë¯¸ë„';
      if (key === 'demo.scene.terminal.hint') return 'í™œì„±í™”ëœ í„°ë¯¸ë„ì´ë‹¤';
      if (key === 'demo.scene.door.label') return 'ë¬¸';
      if (key === 'demo.scene.door.hint') return 'ì ê²¨ìˆëŠ” ê²ƒ ê°™ë‹¤';
      // ì•¡ì…˜ í…œí”Œë¦¿
      if (key === 'scene.hotspot.click_action') {
        return `Click: ${options?.label}`;
      }
      return key;
    },
    i18n: {
      changeLanguage: () => Promise.resolve(),
      resolvedLanguage: 'ko-KR',
    },
  }),
  initReactI18next: {
    type: '3rdParty',
    init: () => {},
  },
}));

// ResizeObserver ëª¨í‚¹
class MockResizeObserver {
  observe = vi.fn();
  unobserve = vi.fn();
  disconnect = vi.fn();
}
global.ResizeObserver = MockResizeObserver as unknown as typeof ResizeObserver;

// getBoundingClientRect ëª¨í‚¹
Element.prototype.getBoundingClientRect = vi.fn(() => ({
  width: 800,
  height: 600,
  top: 0,
  left: 0,
  bottom: 600,
  right: 800,
  x: 0,
  y: 0,
  toJSON: () => {},
})) as unknown as () => DOMRect;

// api ëª¨í‚¹
vi.mock('./api/turnStream', () => ({
  startTurnStream: vi.fn(),
}));

describe('App Integration - Hotspot Click', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    localStorage.clear();
  });

  it('should trigger startTurnStream when a hotspot is clicked', async () => {
    render(<App />);

    // 1. í”„ë¡œí•„ ì„ íƒ (Playing í˜ì´ì¦ˆ ì§„ì…) - í…Œí¬ í”„ë¡œí•„ ì„ íƒ
    const techProfile = screen.getByLabelText('profile.tech.name');
    fireEvent.click(techProfile);

    // U-060: í”„ë¡œí•„ ì„ íƒ í›„ ìƒíƒœ ì „í™˜ì´ React ìƒíƒœ ì—…ë°ì´íŠ¸ì´ë¯€ë¡œ waitFor ì‚¬ìš©
    // 2. ì´ì œ ë©”ì¸ ê²Œì„ UIê°€ ë‚˜íƒ€ë‚¨ - í…Œí¬ í”„ë¡œí•„ì˜ 'í„°ë¯¸ë„' í•«ìŠ¤íŒŸ ì°¾ê¸°
    const terminalHotspot = await waitFor(() => {
      const hotspot = screen.getByLabelText('í„°ë¯¸ë„');
      expect(hotspot).toBeInTheDocument();
      return hotspot;
    });

    // í´ë¦­ ì‹œë®¬ë ˆì´ì…˜
    fireEvent.click(terminalHotspot);

    // startTurnStream í˜¸ì¶œ í™•ì¸
    await waitFor(() => {
      expect(turnStream.startTurnStream).toHaveBeenCalled();
    });

    const [input] = vi.mocked(turnStream.startTurnStream).mock.calls[0];

    // TurnInput ê²€ì¦
    expect(input.text).toBe('Click: í„°ë¯¸ë„');
    expect(input.click).toEqual({
      object_id: 'main-terminal',
      box_2d: { ymin: 200, xmin: 300, ymax: 600, xmax: 700 },
    });
  });
});

describe('App Layout - Inventory Count', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    localStorage.clear();
    useInventoryStore.getState().reset();
  });

  it('updates inventory panel title based on items', async () => {
    render(<App />);

    // 1. í”„ë¡œí•„ ì„ íƒ
    const techProfile = screen.getByLabelText('profile.tech.name');
    fireEvent.click(techProfile);

    // 2. ì´ˆê¸° ì œëª© í™•ì¸ (Tech í”„ë¡œí•„ì€ ê¸°ë³¸ ì•„ì´í…œì´ ìˆìœ¼ë¯€ë¡œ ë°”ë¡œ inventory.countê°€ ë³´ì„)
    await waitFor(() => {
      expect(screen.getByText(/inventory.count/)).toBeInTheDocument();
    });

    // 3. ì•„ì´í…œ ëª¨ë‘ ì œê±°
    useInventoryStore.getState().reset();

    // 4. ì œëª©ì´ ê¸°ë³¸ê°’ìœ¼ë¡œ ëŒì•„ì™”ëŠ”ì§€ í™•ì¸
    await waitFor(() => {
      expect(screen.getByText('panel.inventory.title')).toBeInTheDocument();
    });

    // 5. ë‹¤ì‹œ ì•„ì´í…œ ì¶”ê°€
    useInventoryStore.getState().addItems([
      {
        id: 'test-item',
        name: 'Test Item',
        quantity: 1,
      },
    ]);

    // 6. ì œëª© ì—…ë°ì´íŠ¸ ë‹¤ì‹œ í™•ì¸
    await waitFor(() => {
      expect(screen.getByText(/inventory.count/)).toBeInTheDocument();
    });
  });
});
</file>

<file path="frontend/src/components/Hotspot.tsx">
/**
 * Unknown World - Hotspot ì»´í¬ë„ŒíŠ¸
 *
 * U-058[Mvp]: í•«ìŠ¤íŒŸ ë””ìì¸ ê°œì„  (ì½”ë„ˆ/ìŠ¤íŠ¸ë¡œí¬/ìƒ‰ìƒ)
 * - Q1 Option C: Magenta/Purple ê³„ì—´ ê°•ì¡°
 * - Q2 Option A: Lì ë¸Œë¼ì¼“ ì½”ë„ˆ ë§ˆì»¤
 *
 * U-074[Mvp]: í•«ìŠ¤íŒŸ ì¸í„°ë™ì…˜ ì•ˆë‚´ UX
 * - Q1 Option B: ì²« Në²ˆë§Œ hover íŒíŠ¸ í‘œì‹œ (í•™ìŠµ í›„ ì‚¬ë¼ì§)
 * - hover ì‹œ "í´ë¦­í•˜ì—¬ ì¡°ì‚¬" íŒíŠ¸ í‘œì‹œ
 *
 * RULE-002 ì¤€ìˆ˜: ì±„íŒ… ë²„ë¸”ì´ ì•„ë‹Œ ê²Œì„ UI
 * RULE-009 ì¤€ìˆ˜: ì¢Œí‘œ ê·œì•½ (0~1000 ì •ê·œí™”, bbox=[ymin,xmin,ymax,xmax])
 *
 * U-010[Mvp]: í•«ìŠ¤íŒŸ ì˜¤ë²„ë ˆì´ ê¸°ë³¸ êµ¬í˜„
 * U-012[Mvp]: DnD ë“œë¡­ íƒ€ê²Ÿ í™•ì¥
 *
 * @module components/Hotspot
 */

import { useState, useCallback, memo, useEffect } from 'react';
import { useTranslation } from 'react-i18next';
import { useDroppable } from '@dnd-kit/core';
import type { SceneObject, Box2D } from '../schemas/turn';
import { box2dToPixel, type CanvasSize } from '../utils/box2d';
import { DND_TYPE, type HotspotDropData } from '../dnd/types';
import { useOnboardingStore, selectShouldShowHotspotHint } from '../stores/onboardingStore';
import { InteractionHint } from './InteractionHint';
import '../styles/hotspot.css';

// =============================================================================
// íƒ€ì… ì •ì˜
// =============================================================================

/**
 * í•«ìŠ¤íŒŸ í´ë¦­ ì´ë²¤íŠ¸ ë°ì´í„°
 */
export interface HotspotClickData {
  /** í´ë¦­í•œ ì˜¤ë¸Œì íŠ¸ ID */
  object_id: string;
  /** í´ë¦­í•œ ì˜¤ë¸Œì íŠ¸ì˜ ë°”ìš´ë”© ë°•ìŠ¤ (0~1000 ì •ê·œí™”) */
  box_2d: Box2D;
}

interface HotspotProps {
  /** ì”¬ ì˜¤ë¸Œì íŠ¸ ë°ì´í„° */
  object: SceneObject;
  /** ìº”ë²„ìŠ¤ í¬ê¸° (ì¢Œí‘œ ë³€í™˜ìš©) */
  canvasSize: CanvasSize;
  /** í´ë¦­ í•¸ë“¤ëŸ¬ */
  onClick: (data: HotspotClickData) => void;
  /** ë¹„í™œì„±í™” ì—¬ë¶€ (ìŠ¤íŠ¸ë¦¬ë° ì¤‘ ë“±) */
  disabled: boolean;
  /** ë°ëª¨ ìƒíƒœ ì—¬ë¶€ (ì‹œê°ì  íŒíŠ¸ í•„ìš”) */
  isDemoState?: boolean;
  /** ìš°ì„ ìˆœìœ„ ê¸°ë°˜ z-index ìŠ¤íƒ€ì¼ */
  style?: React.CSSProperties;
}

// =============================================================================
// ë©”ì¸ ì»´í¬ë„ŒíŠ¸
// =============================================================================

/**
 * í•«ìŠ¤íŒŸ ì»´í¬ë„ŒíŠ¸
 *
 * Scene Canvas ìœ„ì— ì˜¤ë²„ë ˆì´ë˜ëŠ” í´ë¦­/ë“œë¡­ ê°€ëŠ¥í•œ ì˜ì—­ì…ë‹ˆë‹¤.
 * Lì ì½”ë„ˆ ë§ˆì»¤ + Magenta í…Œë§ˆë¡œ ì‹œê°ì  í’ˆì§ˆì„ í–¥ìƒì‹œí‚µë‹ˆë‹¤.
 *
 * @example
 * ```tsx
 * <Hotspot
 *   object={sceneObject}
 *   canvasSize={{ width: 800, height: 600 }}
 *   onClick={handleClick}
 *   disabled={isStreaming}
 * />
 * ```
 */
function HotspotComponent({
  object,
  canvasSize,
  onClick,
  disabled,
  isDemoState = false,
  style,
}: HotspotProps) {
  const [isHovered, setIsHovered] = useState(false);
  const { t } = useTranslation();

  // U-074: í•«ìŠ¤íŒŸ íŒíŠ¸ ìƒíƒœ (ì²« Në²ˆë§Œ í‘œì‹œ)
  const shouldShowHint = useOnboardingStore(selectShouldShowHotspotHint);
  const incrementHotspotHint = useOnboardingStore((state) => state.incrementHotspotHint);

  // U-074: hover ì‹œì‘ ì‹œ íŒíŠ¸ ì¹´ìš´íŠ¸ ì¦ê°€
  useEffect(() => {
    if (isHovered && !disabled) {
      incrementHotspotHint();
    }
  }, [isHovered, disabled, incrementHotspotHint]);

  // U-012: useDroppable í›…ìœ¼ë¡œ ë“œë¡­ íƒ€ê²Ÿ ì„¤ì •
  const dropData: HotspotDropData = {
    type: DND_TYPE.HOTSPOT,
    object_id: object.id,
    box_2d: object.box_2d,
    label: object.label,
  };

  const { isOver, setNodeRef } = useDroppable({
    id: `hotspot-${object.id}`,
    data: dropData,
    disabled,
  });

  // box_2d(0~1000) â†’ px ë³€í™˜ (RULE-009)
  const pixelBox = box2dToPixel(object.box_2d, canvasSize);

  // í´ë¦­ í•¸ë“¤ëŸ¬
  const handleClick = useCallback(() => {
    if (disabled) return;
    onClick({
      object_id: object.id,
      box_2d: object.box_2d,
    });
  }, [disabled, onClick, object.id, object.box_2d]);

  // í‚¤ë³´ë“œ ì ‘ê·¼ì„±
  const handleKeyDown = useCallback(
    (e: React.KeyboardEvent) => {
      if (disabled) return;
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        handleClick();
      }
    },
    [disabled, handleClick],
  );

  // ìƒíƒœ ê²°ì •
  const isHighlighted = isHovered || isOver;

  // íˆ´íŒ ë°©í–¥ ê²°ì •: ìƒë‹¨ ì—¬ë°±ì´ ë¶€ì¡±í•˜ë©´ ì•„ë˜ìª½ìœ¼ë¡œ í‘œì‹œ
  // íˆ´íŒ ë†’ì´(~80px) + ì—¬ìœ ë¶„ì„ ê¸°ì¤€ìœ¼ë¡œ íŒë‹¨
  const TOOLTIP_FLIP_THRESHOLD = 80;
  const tooltipBelow = pixelBox.top < TOOLTIP_FLIP_THRESHOLD;

  // CSS í´ë˜ìŠ¤ ì¡°í•©
  const classNames = [
    'hotspot',
    isHighlighted && !disabled ? 'hovered' : '',
    disabled ? 'disabled' : '',
    isOver ? 'drop-target-active' : '',
    isDemoState ? 'demo-target' : '',
    tooltipBelow ? 'tooltip-below' : '',
  ]
    .filter(Boolean)
    .join(' ');

  return (
    <div
      ref={setNodeRef}
      className={classNames}
      style={{
        top: `${pixelBox.top}px`,
        left: `${pixelBox.left}px`,
        width: `${pixelBox.width}px`,
        height: `${pixelBox.height}px`,
        ...style,
      }}
      onClick={handleClick}
      onMouseEnter={() => setIsHovered(true)}
      onMouseLeave={() => setIsHovered(false)}
      onKeyDown={handleKeyDown}
      role="button"
      tabIndex={disabled ? -1 : 0}
      aria-label={object.label}
      aria-disabled={disabled}
      data-drop-target={!disabled}
      data-demo-state={isDemoState}
      data-object-id={object.id}
    >
      {/* Lì ì½”ë„ˆ ë§ˆì»¤ (í•˜ë‹¨ 2ê°œ) */}
      <div className="hotspot-corners" aria-hidden="true" />

      {/* í˜¸ë²„ ë˜ëŠ” ë“œë˜ê·¸ ì˜¤ë²„ ì‹œ íˆ´íŒ í‘œì‹œ */}
      {isHighlighted && !disabled && (
        <div className="hotspot-tooltip">
          <span className="hotspot-tooltip-label">{object.label}</span>

          {/* ë°ëª¨ ìƒíƒœ í‘œì‹œ */}
          {isDemoState && (
            <span className="hotspot-tooltip-demo">{t('scene.hotspot.demo_hint')}</span>
          )}

          {/* ë“œë˜ê·¸ ì˜¤ë²„ ì‹œ ë“œë¡­ íŒíŠ¸ í‘œì‹œ */}
          {isOver && (
            <span className="hotspot-tooltip-drop-hint">{t('scene.hotspot.drop_hint')}</span>
          )}

          {/* ì¼ë°˜ ìƒí˜¸ì‘ìš© íŒíŠ¸ */}
          {!isOver && !isDemoState && object.interaction_hint && (
            <span className="hotspot-tooltip-hint">
              {t('scene.hotspot.hint_prefix')}: {object.interaction_hint}
            </span>
          )}
        </div>
      )}

      {/* U-074: ì²« Në²ˆë§Œ í‘œì‹œë˜ëŠ” í´ë¦­ íŒíŠ¸ (íˆ´íŒ ì™¸ë¶€) */}
      {isHovered && !disabled && !isOver && shouldShowHint && (
        <InteractionHint
          text={t('interaction.hotspot_click')}
          icon="click"
          position="bottom"
          className="interaction-hint--hotspot"
        />
      )}
    </div>
  );
}

/**
 * Memoized Hotspot ì»´í¬ë„ŒíŠ¸
 *
 * ë‹¤ìˆ˜ì˜ í•«ìŠ¤íŒŸì´ ë™ì‹œì— ë Œë”ë  ë•Œ ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•´ ë©”ëª¨ì´ì œì´ì…˜ ì ìš©.
 * object.id, canvasSize, disabledê°€ ë³€ê²½ë˜ì§€ ì•Šìœ¼ë©´ ë¦¬ë Œë” ë°©ì§€.
 */
export const Hotspot = memo(HotspotComponent, (prevProps, nextProps) => {
  // í•µì‹¬ propsë§Œ ë¹„êµí•˜ì—¬ ë¶ˆí•„ìš”í•œ ë¦¬ë Œë” ë°©ì§€
  return (
    prevProps.object.id === nextProps.object.id &&
    prevProps.object.label === nextProps.object.label &&
    prevProps.object.box_2d.ymin === nextProps.object.box_2d.ymin &&
    prevProps.object.box_2d.xmin === nextProps.object.box_2d.xmin &&
    prevProps.object.box_2d.ymax === nextProps.object.box_2d.ymax &&
    prevProps.object.box_2d.xmax === nextProps.object.box_2d.xmax &&
    prevProps.canvasSize.width === nextProps.canvasSize.width &&
    prevProps.canvasSize.height === nextProps.canvasSize.height &&
    prevProps.disabled === nextProps.disabled &&
    prevProps.isDemoState === nextProps.isDemoState
  );
});

Hotspot.displayName = 'Hotspot';

// Re-export for convenience
export type { HotspotProps };
</file>

<file path="frontend/src/components/SceneImage.test.tsx">
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { render, screen, act } from '@testing-library/react';
import { SceneImage } from './SceneImage';

// react-i18next ëª¨í‚¹
vi.mock('react-i18next', () => ({
  useTranslation: () => ({
    t: (key: string) => key,
  }),
}));

// ì „ì—­ì ìœ¼ë¡œ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¶”ì í•˜ê¸° ìœ„í•œ ë°°ì—´
let imageInstances: Array<MockImage> = [];

// Image ê°ì²´ ëª¨í‚¹
class MockImage {
  onload: (() => void) | null = null;
  onerror: (() => void) | null = null;
  _src: string = '';

  constructor() {
    imageInstances.push(this);
  }

  addEventListener(event: string, cb: () => void) {
    if (event === 'load') this.onload = cb;
    if (event === 'error') this.onerror = cb;
  }

  removeEventListener() {}

  set src(val: string) {
    this._src = val;
  }

  get src() {
    return this._src;
  }
}

describe('SceneImage Component (U-020)', () => {
  const originalImage = global.Image;

  beforeEach(() => {
    imageInstances = [];
    global.Image = MockImage as unknown as typeof Image;
  });

  afterEach(() => {
    global.Image = originalImage;
  });

  it('ì´ë¯¸ì§€ URLì´ ì—†ì„ ë•Œ placeholderë¥¼ í‘œì‹œí•´ì•¼ í•¨', () => {
    render(<SceneImage status="default" />);
    expect(screen.getByText('scene.status.default')).toBeInTheDocument();
  });

  it('ìƒˆë¡œìš´ ì´ë¯¸ì§€ URLì´ ì˜¤ë©´ ë¡œë”© ì¸ë””ì¼€ì´í„°ë¥¼ í‘œì‹œí•˜ê³  ì´ì „ ì´ë¯¸ì§€ë¥¼ ìœ ì§€í•´ì•¼ í•¨ (Option A)', async () => {
    const { rerender } = render(<SceneImage status="scene" imageUrl="url-1.png" />);

    // ë¡œë”© ì¤‘ í™•ì¸
    expect(screen.getByText('scene.status.image_loading')).toBeInTheDocument();

    // ì²« ë²ˆì§¸ ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ ì‹œë®¬ë ˆì´ì…˜
    await act(async () => {
      if (imageInstances[0]?.onload) imageInstances[0].onload();
    });

    const img = screen.getByAltText('scene.status.alt');
    expect(img).toHaveAttribute('src', 'url-1.png');

    // ë‘ ë²ˆì§¸ ì´ë¯¸ì§€ ìš”ì²­
    await act(async () => {
      rerender(<SceneImage status="scene" imageUrl="url-2.png" />);
    });

    // ë¡œë”© ì¤‘ í‘œì‹œ í™•ì¸
    expect(screen.getByText('scene.status.image_loading')).toBeInTheDocument();
    // ì´ì „ ì´ë¯¸ì§€(url-1)ê°€ ì—¬ì „íˆ ë³´ì—¬ì•¼ í•¨
    expect(screen.getByAltText('scene.status.alt')).toHaveAttribute('src', 'url-1.png');
  });

  it('ì´ë¯¸ì§€ ë¡œë”©ì´ ì™„ë£Œë˜ë©´ ìƒˆë¡œìš´ ì´ë¯¸ì§€ë¡œ êµì²´ë˜ì–´ì•¼ í•¨', async () => {
    const { rerender } = render(<SceneImage status="scene" imageUrl="url-1.png" />);

    await act(async () => {
      if (imageInstances[0]?.onload) imageInstances[0].onload();
    });

    await act(async () => {
      rerender(<SceneImage status="scene" imageUrl="url-2.png" />);
    });

    // ë‘ ë²ˆì§¸ ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ ì‹œë®¬ë ˆì´ì…˜
    await act(async () => {
      // ìƒˆë¡œìš´ Image ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒì„±ë˜ì—ˆì„ ê²ƒì„
      const secondInstance = imageInstances.find((inst) => inst.src === 'url-2.png');
      if (secondInstance?.onload) secondInstance.onload();
    });

    const img = screen.getByAltText('scene.status.alt');
    expect(img).toHaveAttribute('src', 'url-2.png');
    expect(screen.queryByText('scene.status.image_loading')).not.toBeInTheDocument();
  });

  it('ì´ë¯¸ì§€ ë¡œë”© ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë°°ì§€ë¥¼ í‘œì‹œí•˜ê³  ì´ì „ ì´ë¯¸ì§€ë¥¼ ìœ ì§€í•´ì•¼ í•¨ (RULE-004)', async () => {
    const { rerender } = render(<SceneImage status="scene" imageUrl="url-1.png" />);

    await act(async () => {
      if (imageInstances[0]?.onload) imageInstances[0].onload();
    });

    await act(async () => {
      rerender(<SceneImage status="scene" imageUrl="url-2.png" />);
    });

    // ë‘ ë²ˆì§¸ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œë®¬ë ˆì´ì…˜
    await act(async () => {
      const secondInstance = imageInstances.find((inst) => inst.src === 'url-2.png');
      if (secondInstance?.onerror) secondInstance.onerror();
    });

    expect(screen.getByText('scene.status.image_error')).toBeInTheDocument();
    expect(screen.getByAltText('scene.status.alt')).toHaveAttribute('src', 'url-1.png');
  });

  it('ì´ë¯¸ì§€ê°€ ì „í˜€ ì—†ëŠ” ìƒíƒœì—ì„œ ì—ëŸ¬ ë°œìƒ ì‹œ placeholderë¥¼ í‘œì‹œí•´ì•¼ í•¨', async () => {
    render(<SceneImage status="scene" imageUrl="invalid.png" />);

    await act(async () => {
      if (imageInstances[0]?.onerror) imageInstances[0].onerror();
    });

    expect(screen.getByText('scene.status.default')).toBeInTheDocument();
    expect(screen.getByText('âš ï¸')).toBeInTheDocument();
  });

  describe('Processing Overlay (U-071[Mvp])', () => {
    it('processingPhaseê°€ processingì¼ ë•Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë²„ë ˆì´ì™€ ì˜¬ë°”ë¥¸ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•´ì•¼ í•¨', () => {
      render(<SceneImage status="scene" processingPhase="processing" />);

      expect(screen.getByText('scene.processing.processing')).toBeInTheDocument();
      // CRT ìŠ¤í”¼ë„ˆ ìš”ì†Œ ì¡´ì¬ í™•ì¸
      expect(document.querySelector('.scene-processing-spinner')).toBeInTheDocument();
    });

    it('processingPhaseê°€ image_pendingì¼ ë•Œ ì´ë¯¸ì§€ í˜•ì„± ì¤‘ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•´ì•¼ í•¨', () => {
      render(<SceneImage status="scene" processingPhase="image_pending" />);

      expect(screen.getByText('scene.processing.image_pending')).toBeInTheDocument();
    });

    it('ì²˜ë¦¬ ì¤‘ì¼ ë•ŒëŠ” ì´ì „ ì´ë¯¸ì§€ê°€ ìˆë”ë¼ë„ ìˆ¨ê²¨ì•¼ í•¨ (Option C)', async () => {
      const { rerender } = render(<SceneImage status="scene" imageUrl="old-url.png" />);

      // 1. ì²« ë²ˆì§¸ ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ
      await act(async () => {
        if (imageInstances[0]?.onload) imageInstances[0].onload();
      });

      expect(screen.getByAltText('scene.status.alt')).toHaveAttribute('src', 'old-url.png');

      // 2. ì²˜ë¦¬ ì¤‘ìœ¼ë¡œ ì „í™˜
      rerender(<SceneImage status="scene" imageUrl="old-url.png" processingPhase="processing" />);

      // ì´ë¯¸ì§€ ìš”ì†Œê°€ ë Œë”ë§ë˜ì§€ ì•Šì•„ì•¼ í•¨ (Option C: ì²˜ë¦¬ ì¤‘ ìˆ¨ê¹€)
      expect(screen.queryByAltText('scene.status.alt')).not.toBeInTheDocument();
      // ì˜¤ë²„ë ˆì´ëŠ” í‘œì‹œë˜ì–´ì•¼ í•¨
      expect(screen.getByText('scene.processing.processing')).toBeInTheDocument();
    });
  });

  describe('Analyzing Overlay (U-089[Mvp])', () => {
    it('isAnalyzingì´ trueì¼ ë•Œ ë¶„ì„ ì „ìš© ì˜¤ë²„ë ˆì´ì™€ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•´ì•¼ í•¨', () => {
      render(<SceneImage status="scene" isAnalyzing={true} />);

      expect(screen.getByText('scene.analyzing.message')).toBeInTheDocument();
      expect(screen.getByText('scene.analyzing.hint')).toBeInTheDocument();
      // ìŠ¤ìº”ë¼ì¸ ìš”ì†Œ ì¡´ì¬ í™•ì¸
      expect(document.querySelector('.scene-analyzing-scanline')).toBeInTheDocument();
    });

    it('ì •ë°€ë¶„ì„ ì¤‘ì—ëŠ” ê¸°ì¡´ ì´ë¯¸ì§€ë¥¼ ìœ ì§€í•´ì•¼ í•¨ (Option B)', async () => {
      const { rerender } = render(<SceneImage status="scene" imageUrl="old-url.png" />);

      // 1. ì²« ë²ˆì§¸ ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ
      await act(async () => {
        if (imageInstances[0]?.onload) imageInstances[0].onload();
      });

      expect(screen.getByAltText('scene.status.alt')).toHaveAttribute('src', 'old-url.png');

      // 2. ì •ë°€ë¶„ì„ ì‹œì‘
      rerender(<SceneImage status="scene" imageUrl="old-url.png" isAnalyzing={true} />);

      // ì´ë¯¸ì§€ ìš”ì†Œê°€ ì—¬ì „íˆ ì¡´ì¬í•´ì•¼ í•¨ (ê¸°ì¡´ ì´ë¯¸ì§€ ìœ ì§€)
      expect(screen.getByAltText('scene.status.alt')).toHaveAttribute('src', 'old-url.png');
      // ë¶„ì„ ì˜¤ë²„ë ˆì´ í‘œì‹œ í™•ì¸
      expect(screen.getByText('scene.analyzing.message')).toBeInTheDocument();
    });

    it('isAnalyzingì´ trueì¼ ë•ŒëŠ” processingPhase ì˜¤ë²„ë ˆì´ë³´ë‹¤ ìš°ì„ í•´ì•¼ í•¨', () => {
      render(<SceneImage status="scene" isAnalyzing={true} processingPhase="processing" />);

      // ë¶„ì„ ì˜¤ë²„ë ˆì´ëŠ” í‘œì‹œë¨
      expect(screen.getByText('scene.analyzing.message')).toBeInTheDocument();
      // ì¼ë°˜ ì²˜ë¦¬ ì˜¤ë²„ë ˆì´ëŠ” ìˆ¨ê²¨ì§
      expect(screen.queryByText('scene.processing.processing')).not.toBeInTheDocument();
    });
  });
});
</file>

<file path="frontend/src/save/sessionLifecycle.test.ts">
import { describe, it, expect, beforeEach } from 'vitest';
import { startSessionFromProfile, resetToCurrentProfile } from './sessionLifecycle';
import { useEconomyStore } from '../stores/economyStore';
import { useWorldStore } from '../stores/worldStore';
import { findProfileById } from '../data/demoProfiles';

describe('sessionLifecycle (U-099)', () => {
  beforeEach(() => {
    useEconomyStore.getState().reset();
    useWorldStore.getState().reset();
  });

  it('ìƒˆ ì„¸ì…˜ ì‹œì‘ ì‹œ ì´ì „ ê±°ë˜ ì¥ë¶€ê°€ ì´ˆê¸°í™”ë˜ì–´ì•¼ í•œë‹¤', () => {
    const { addLedgerEntry } = useEconomyStore.getState();

    // 1. ì´ì „ ì„¸ì…˜ì˜ ë°ì´í„°ê°€ ìˆë‹¤ê³  ê°€ì •
    addLedgerEntry({
      turnId: 10,
      reason: 'Old session entry',
      cost: { signal: 10, memory_shard: 0 },
      balanceAfter: { signal: 90, memory_shard: 5 },
    });

    expect(useEconomyStore.getState().ledger.length).toBe(1);

    // 2. ìƒˆ ì„¸ì…˜ ì‹œì‘ (startSessionFromProfile í˜¸ì¶œ)
    const profile = findProfileById('narrator')!;
    const t = (key: string) => key;

    startSessionFromProfile({ profile, t });

    // 3. ê±°ë˜ ì¥ë¶€ê°€ ë¹„ì›Œì¡ŒëŠ”ì§€ í™•ì¸
    expect(useEconomyStore.getState().ledger.length).toBe(0);
  });

  it('ë¦¬ì…‹ ì‹œ ì´ì „ ê±°ë˜ ì¥ë¶€ê°€ ì´ˆê¸°í™”ë˜ì–´ì•¼ í•œë‹¤', () => {
    const { addLedgerEntry } = useEconomyStore.getState();

    // 1. ë°ì´í„° ì¶”ê°€
    addLedgerEntry({
      turnId: 1,
      reason: 'Current session entry',
      cost: { signal: 10, memory_shard: 0 },
      balanceAfter: { signal: 90, memory_shard: 5 },
    });

    expect(useEconomyStore.getState().ledger.length).toBe(1);

    // 2. ë¦¬ì…‹ ì‹¤í–‰
    const t = (key: string) => key;
    resetToCurrentProfile({ t, currentProfileId: 'narrator' });

    // 3. ê±°ë˜ ì¥ë¶€ê°€ ë¹„ì›Œì¡ŒëŠ”ì§€ í™•ì¸
    expect(useEconomyStore.getState().ledger.length).toBe(0);
  });
});
</file>

<file path="frontend/src/stores/inventoryStore.test.ts">
import { describe, it, expect, beforeEach } from 'vitest';
import { useInventoryStore, parseInventoryAdded } from './inventoryStore';

describe('inventoryStore', () => {
  beforeEach(() => {
    useInventoryStore.getState().reset();
  });

  it('ì´ˆê¸° ìƒíƒœëŠ” ë¹„ì–´ ìˆì–´ì•¼ í•œë‹¤', () => {
    const state = useInventoryStore.getState();
    expect(state.items).toEqual([]);
    expect(state.draggingItemId).toBeNull();
    expect(state.selectedItemId).toBeNull();
  });

  it('addItems: ìƒˆ ì•„ì´í…œì„ ì¶”ê°€í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤', () => {
    const { addItems } = useInventoryStore.getState();
    const newItem = { id: 'item1', name: 'Item 1', quantity: 1 };

    addItems([newItem]);

    const state = useInventoryStore.getState();
    expect(state.items).toHaveLength(1);
    expect(state.items[0]).toEqual(newItem);
  });

  it('addItems: ì¤‘ë³µëœ IDì˜ ì•„ì´í…œ ì¶”ê°€ ì‹œ ìˆ˜ëŸ‰ì´ ì¦ê°€í•´ì•¼ í•œë‹¤', () => {
    const { addItems } = useInventoryStore.getState();
    const item1 = { id: 'item1', name: 'Item 1', quantity: 1 };

    addItems([item1]);
    addItems([{ id: 'item1', name: 'Item 1', quantity: 2 }]);

    const state = useInventoryStore.getState();
    expect(state.items).toHaveLength(1);
    expect(state.items[0].quantity).toBe(3);
  });

  it('removeItems: ì•„ì´í…œì„ ì œê±°í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤', () => {
    const { addItems, removeItems } = useInventoryStore.getState();
    addItems([
      { id: 'item1', name: 'Item 1', quantity: 1 },
      { id: 'item2', name: 'Item 2', quantity: 1 },
    ]);

    removeItems(['item1']);

    const state = useInventoryStore.getState();
    expect(state.items).toHaveLength(1);
    expect(state.items[0].id).toBe('item2');
  });

  it('removeItems: ì œê±°ëœ ì•„ì´í…œì´ ì„ íƒ/ë“œë˜ê·¸ ì¤‘ì´ë©´ ì´ˆê¸°í™”í•´ì•¼ í•œë‹¤', () => {
    const { addItems, removeItems, selectItem, startDrag } = useInventoryStore.getState();
    addItems([{ id: 'item1', name: 'Item 1', quantity: 1 }]);

    selectItem('item1');
    startDrag('item1');

    removeItems(['item1']);

    const state = useInventoryStore.getState();
    expect(state.selectedItemId).toBeNull();
    expect(state.draggingItemId).toBeNull();
  });

  it('startDrag/endDrag: ë“œë˜ê·¸ ìƒíƒœë¥¼ ê´€ë¦¬í•´ì•¼ í•œë‹¤', () => {
    const { startDrag, endDrag } = useInventoryStore.getState();

    startDrag('item1');
    expect(useInventoryStore.getState().draggingItemId).toBe('item1');

    endDrag();
    expect(useInventoryStore.getState().draggingItemId).toBeNull();
  });

  it('parseInventoryAdded: InventoryItemData ë°°ì—´ì„ InventoryItem ë°°ì—´ë¡œ ë³€í™˜í•´ì•¼ í•œë‹¤ (U-075)', () => {
    const added = [
      { id: 'item-a', label: 'ì•„ì´í…œ A', description: 'ì„¤ëª… A', icon_url: null, quantity: 1 },
      {
        id: 'item-b',
        label: 'ì•„ì´í…œ B',
        description: 'ì„¤ëª… B',
        icon_url: '/static/icon.png',
        quantity: 2,
      },
    ];
    const parsed = parseInventoryAdded(added);

    expect(parsed).toHaveLength(2);
    expect(parsed[0]).toEqual({
      id: 'item-a',
      name: 'ì•„ì´í…œ A',
      description: 'ì„¤ëª… A',
      icon: undefined,
      quantity: 1,
      iconStatus: 'pending',
    });
    expect(parsed[1]).toEqual({
      id: 'item-b',
      name: 'ì•„ì´í…œ B',
      description: 'ì„¤ëª… B',
      icon: '/static/icon.png',
      quantity: 2,
      iconStatus: 'ready',
    });
  });
});
</file>

<file path="frontend/src/types/scene.ts">
/**
 * Scene Canvas ê´€ë ¨ íƒ€ì… ì •ì˜ (U-031: Placeholder Pack, U-020: Lazy Render)
 */

/**
 * Scene ì²˜ë¦¬ ë‹¨ê³„ íƒ€ì… (U-071: ë¡œë”© ì¸ë””ì¼€ì´í„° ê°•í™”)
 * - idle: ìœ íœ´ ìƒíƒœ (ì²˜ë¦¬ ì—†ìŒ)
 * - processing: í„´ ì²˜ë¦¬ ì¤‘ (í…ìŠ¤íŠ¸ ìŠ¤íŠ¸ë¦¬ë°)
 * - image_pending: ì´ë¯¸ì§€ ìƒì„± ëŒ€ê¸°/ì§„í–‰ ì¤‘
 * - rendering: ê²°ê³¼ ë Œë”ë§ ì¤‘
 */
export type SceneProcessingPhase = 'idle' | 'processing' | 'image_pending' | 'rendering';

/**
 * Scene Canvas ìƒíƒœ íƒ€ì…
 * - default: ê¸°ë³¸ ìƒíƒœ (ì¥ë©´ ì´ë¯¸ì§€ ì—†ìŒ)
 * - loading: ë°ì´í„° ë¡œë”© ì¤‘
 * - offline: ì˜¤í”„ë¼ì¸/ì—°ê²° ëŠê¹€
 * - blocked: ì•ˆì „/ì •ì±… ì°¨ë‹¨
 * - low_signal: ì¬í™”/ì‹ í˜¸ ë¶€ì¡±
 * - scene: ì •ìƒ ì¥ë©´ í‘œì‹œ (ì´ë¯¸ì§€ URL í¬í•¨)
 */
export type SceneCanvasStatus =
  | 'default'
  | 'loading'
  | 'offline'
  | 'blocked'
  | 'low_signal'
  | 'scene';

/**
 * ì´ë¯¸ì§€ ë¡œë”© ìƒíƒœ (U-020: Lazy Render)
 * - idle: ì´ë¯¸ì§€ ì—†ìŒ/ëŒ€ê¸°
 * - loading: ì´ë¯¸ì§€ ë¡œë”© ì¤‘
 * - loaded: ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ
 * - error: ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨
 */
export type ImageLoadingState = 'idle' | 'loading' | 'loaded' | 'error';

/**
 * Scene Canvas ìƒíƒœ ë°ì´í„° êµ¬ì¡°
 *
 * U-020[Mvp] í™•ì¥:
 * - imageLoading: ì´ë¯¸ì§€ ë¡œë”© ìƒíƒœ í”Œë˜ê·¸ (ë¡œë”© ì¸ë””ì¼€ì´í„° í‘œì‹œìš©)
 * - previousImageUrl: ì´ì „ ì´ë¯¸ì§€ URL (Option A: ì´ì „ ì´ë¯¸ì§€ ìœ ì§€)
 *
 * U-066[Mvp] í™•ì¥:
 * - sceneRevision: late-binding ê°€ë“œìš© í† í° (turnCount ê¸°ë°˜)
 * - pendingImageTurnId: ëŒ€ê¸° ì¤‘ì¸ ì´ë¯¸ì§€ ìš”ì²­ì˜ í„´ ID
 */
export interface SceneCanvasState {
  status: SceneCanvasStatus;
  imageUrl?: string;
  message?: string;
  /** U-020: ì´ë¯¸ì§€ ë¡œë”© ì¤‘ ì—¬ë¶€ (ë¡œë”© ì¸ë””ì¼€ì´í„° í‘œì‹œìš©) */
  imageLoading?: boolean;
  /** U-020: ì´ì „ ì´ë¯¸ì§€ URL (ìƒˆ ì´ë¯¸ì§€ ë¡œë”© ì¤‘ í‘œì‹œìš©) */
  previousImageUrl?: string;
  /** U-066: late-binding ê°€ë“œìš© í† í° (turnCount ê¸°ë°˜) */
  sceneRevision?: number;
  /** U-066: ëŒ€ê¸° ì¤‘ì¸ ì´ë¯¸ì§€ ìš”ì²­ì˜ í„´ ID */
  pendingImageTurnId?: number;
  /** U-071: í˜„ì¬ ì²˜ë¦¬ ë‹¨ê³„ (ë¡œë”© ì¸ë””ì¼€ì´í„° í‘œì‹œìš©) */
  processingPhase?: SceneProcessingPhase;
}

/**
 * ìƒíƒœë³„ placeholder ì •ë³´ êµ¬ì¡°
 */
export interface PlaceholderInfo {
  imagePath: string;
  fallbackEmoji: string;
  labelKey: string;
}
</file>

<file path="frontend/src/components/ActionDeck.test.tsx">
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen, fireEvent } from '@testing-library/react';
import { ActionDeck } from './ActionDeck';
import type { ActionCard } from '../schemas/turn';
import { useActionDeckStore } from '../stores/actionDeckStore';
import { useWorldStore } from '../stores/worldStore';
import { useAgentStore } from '../stores/agentStore';

// i18next ëª¨í‚¹
vi.mock('react-i18next', () => ({
  useTranslation: () => ({
    t: (key: string, params?: Record<string, unknown>) => {
      if (params?.turn !== undefined) return `Turn ${params.turn}`;
      if (key === 'action.risk.low') return 'Low';
      if (key === 'action.risk.medium') return 'Medium';
      if (key === 'action.risk.high') return 'High';
      if (key === 'action.insufficient_balance') return 'Insufficient Balance';
      if (key === 'action.alternative') return 'Alt';
      return key;
    },
  }),
  initReactI18next: {
    type: '3rdParty',
    init: () => {},
  },
}));

// U-065: ë‹¨ìˆœí™”ëœ ActionCard ìŠ¤í‚¤ë§ˆ (ì œê±°ë¨: description, cost_estimate, hint, reward_hint, disabled_reason)
describe('ActionDeck Component', () => {
  const mockCards: ActionCard[] = [
    {
      id: 'card-1',
      label: 'Regular Action',
      cost: { signal: 10, memory_shard: 0 },
      risk: 'low',
      enabled: true,
      is_alternative: false,
    },
    {
      id: 'card-2',
      label: 'Expensive Action',
      cost: { signal: 50, memory_shard: 1 },
      risk: 'high',
      enabled: true,
      is_alternative: false,
    },
    {
      id: 'card-alt',
      label: 'Alternative Action',
      cost: { signal: 2, memory_shard: 0 },
      risk: 'low',
      enabled: true,
      is_alternative: true,
    },
  ];

  beforeEach(() => {
    // ìŠ¤í† ì–´ ì´ˆê¸°í™”
    useActionDeckStore.setState({ cards: [] });
    useWorldStore.setState({ economy: { signal: 100, memory_shard: 5, credit: 0 } });
    useAgentStore.setState({ isStreaming: false });
  });

  it('renders provided cards from store', () => {
    useActionDeckStore.setState({ cards: mockCards });
    render(<ActionDeck />);
    expect(screen.getByText('Regular Action')).toBeInTheDocument();
    expect(screen.getByText('Expensive Action')).toBeInTheDocument();
    expect(screen.getByText('Alternative Action')).toBeInTheDocument();
  });

  // U-065: cost_estimate ì œê±°ë¨, costë§Œ í‘œì‹œ
  it('displays cost values', () => {
    useActionDeckStore.setState({ cards: mockCards });
    render(<ActionDeck />);
    // card-1 has cost: 10
    expect(screen.getByText('10')).toBeInTheDocument();
    // card-2 has cost: 50
    expect(screen.getByText('50')).toBeInTheDocument();
  });

  // U-065: cost_estimate ì œê±°ë¨, costë§Œ ì‚¬ìš©
  it('disables cards when balance is insufficient in worldStore', () => {
    useActionDeckStore.setState({ cards: mockCards });
    useWorldStore.setState({ economy: { signal: 5, memory_shard: 0, credit: 0 } });

    render(<ActionDeck />);

    // Regular Action (cost 10) -> disabled
    const card1 = screen.getByRole('button', { name: /Regular Action/i });
    expect(card1).toBeDisabled();
    expect(screen.getAllByText('Insufficient Balance').length).toBeGreaterThan(0);

    // Alternative Action (cost 2) -> enabled
    const cardAlt = screen.getByRole('button', { name: /Alternative Action/i });
    expect(cardAlt).not.toBeDisabled();
  });

  it('renders alternative badge for alternative cards', () => {
    useActionDeckStore.setState({ cards: mockCards });
    render(<ActionDeck />);
    expect(screen.getByText('Alt')).toBeInTheDocument();
  });

  it('calls onCardClick when an enabled card is clicked', () => {
    const onCardClick = vi.fn();
    useActionDeckStore.setState({ cards: mockCards });
    render(<ActionDeck onCardClick={onCardClick} />);

    fireEvent.click(screen.getByText('Regular Action'));
    expect(onCardClick).toHaveBeenCalledWith(expect.objectContaining({ id: 'card-1' }));
  });

  // U-065: disabled_reason ì œê±°ë¨, ì„œë²„ì—ì„œ enabled=falseë©´ ê¸°ë³¸ ë©”ì‹œì§€ í‘œì‹œ
  it('displays default disabled message when server disables card', () => {
    const disabledCard: ActionCard[] = [
      {
        ...mockCards[0],
        enabled: false,
      },
    ];
    useActionDeckStore.setState({ cards: disabledCard });
    render(<ActionDeck />);
    // action.server_disabled í‚¤ê°€ ê·¸ëŒ€ë¡œ ì¶œë ¥ë¨ (ëª¨í‚¹ì—ì„œ ì²˜ë¦¬ ì•ˆ ë¨)
    const card = screen.getByRole('button', { name: /Regular Action/i });
    expect(card).toBeDisabled();
  });

  it('renders default cards when store cards are empty', () => {
    useActionDeckStore.setState({ cards: [] });
    render(<ActionDeck />);
    // useDefaultCards should provide some default labels
    expect(screen.getByText('action.default.explore.label')).toBeInTheDocument();
  });

  it('disables all cards when isStreaming is true in agentStore', () => {
    useActionDeckStore.setState({ cards: mockCards });
    useAgentStore.setState({ isStreaming: true });

    render(<ActionDeck />);

    const card1 = screen.getByRole('button', { name: /Regular Action/i });
    const cardAlt = screen.getByRole('button', { name: /Alternative Action/i });

    expect(card1).toBeDisabled();
    expect(cardAlt).toBeDisabled();
  });

  describe('Badge Layout (U-083)', () => {
    it('renders multiple badges (VISION + EARN) simultaneously', () => {
      // earn_ ì ‘ë‘ì‚¬ê°€ ìˆê³  VISION_TRIGGER_ACTION_IDSì— í¬í•¨ëœ ID
      const complexCard: ActionCard[] = [
        {
          id: 'earn_ì •ë°€ë¶„ì„',
          label: 'Complex Action',
          cost: { signal: 5, memory_shard: 0 },
          risk: 'medium',
          enabled: true,
          is_alternative: false,
        },
      ];
      useActionDeckStore.setState({ cards: complexCard });
      render(<ActionDeck />);

      // VISION ë±ƒì§€ (ğŸ” action.vision_badge)
      expect(screen.getByText(/action\.vision_badge/)).toBeInTheDocument();
      // EARN ë±ƒì§€ (âš¡ action.earn_badge)
      expect(screen.getByText(/action\.earn_badge/)).toBeInTheDocument();
    });

    it('limits visible badges to 2 and shows overflow count', () => {
      // VISION + EARN + ALT = 3ê°œ
      const threeBadgesCard: ActionCard[] = [
        {
          id: 'earn_ì •ë°€ë¶„ì„',
          label: 'Three Badges',
          cost: { signal: 5, memory_shard: 0 },
          risk: 'medium',
          enabled: true,
          is_alternative: true, // ìˆ˜ì •ëœ ë¡œì§ì— ì˜í•´ ë‹¤ë¥¸ ë±ƒì§€ê°€ ìˆì–´ë„ ì¶”ê°€ë¨
        },
      ];
      useActionDeckStore.setState({ cards: threeBadgesCard });
      render(<ActionDeck />);

      // VISIONê³¼ EARNì€ í‘œì‹œë˜ì–´ì•¼ í•¨ (collectBadges ìˆœì„œìƒ)
      expect(screen.getByText(/action\.vision_badge/)).toBeInTheDocument();
      expect(screen.getByText(/action\.earn_badge/)).toBeInTheDocument();

      // ALTëŠ” 3ë²ˆì§¸ì´ë¯€ë¡œ ìˆ¨ê²¨ì§€ê³  +1ì´ ë‚˜íƒ€ë‚˜ì•¼ í•¨
      expect(screen.queryByText('Alt')).not.toBeInTheDocument();
      expect(screen.getByText('+1')).toBeInTheDocument();
    });

    it('shows alternative badge only when no other badges are present', () => {
      const altOnlyCard: ActionCard[] = [
        {
          id: 'simple-alt',
          label: 'Alt Only',
          cost: { signal: 1, memory_shard: 0 },
          risk: 'low',
          enabled: true,
          is_alternative: true,
        },
      ];
      useActionDeckStore.setState({ cards: altOnlyCard });
      render(<ActionDeck />);

      expect(screen.getByText('Alt')).toBeInTheDocument();
    });
  });
});
</file>

<file path="frontend/src/components/AgentConsole.test.tsx">
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen } from '@testing-library/react';
import { AgentConsole } from './AgentConsole';
import type { ValidationBadge, TurnOutput } from '../schemas/turn';
import type { PhaseInfo, AgentError } from '../stores/agentStore';

// Mock i18n
vi.mock('react-i18next', () => ({
  useTranslation: () => ({
    t: (key: string, _options?: { ok?: number; total?: number; count?: number }) => {
      // Return key for assertion, or format if needed
      return key;
    },
  }),
}));

// Mock store state
interface MockState {
  phases: PhaseInfo[];
  badges: ValidationBadge[];
  repairCount: number;
  error: AgentError | null;
  isStreaming: boolean;
  finalOutput: Partial<TurnOutput> | null;
}

const mockState: MockState = {
  phases: [],
  badges: [],
  repairCount: 0,
  error: null,
  isStreaming: false,
  finalOutput: {
    agent_console: {
      model_label: 'FAST',
      repair_count: 0,
    },
  } as Partial<TurnOutput>,
};

// Mock dependencies
vi.mock('../stores/agentStore', () => ({
  useAgentStore: (selector: (state: MockState) => unknown) => selector(mockState),
  selectIsStreaming: (state: MockState) => state.isStreaming,
  selectPhases: (state: MockState) => state.phases,
  selectBadges: (state: MockState) => state.badges,
  selectRepairCount: (state: MockState) => state.repairCount,
  selectError: (state: MockState) => state.error,
  selectModelLabel: (state: MockState) => state.finalOutput?.agent_console?.model_label ?? 'FAST',
}));

describe('AgentConsole (U-123)', () => {
  beforeEach(() => {
    // Reset mock state
    mockState.phases = [];
    mockState.badges = [];
    mockState.repairCount = 0;
    mockState.error = null;
    mockState.isStreaming = false;
    mockState.finalOutput = {
      agent_console: {
        model_label: 'FAST',
        repair_count: 0,
      },
    } as Partial<TurnOutput>;
  });

  it('should always show queue, badges panel, and divider', () => {
    render(<AgentConsole />);

    // Queue should always be visible (U-123)
    expect(screen.getByText('agent.console.queue')).toBeInTheDocument();
    expect(screen.getByText('agent.console.queue_idle')).toBeInTheDocument();

    // Badges panel should always be visible (U-123)
    expect(screen.getByText('agent.console.badges')).toBeInTheDocument();
    expect(screen.getByText('agent.console.badges_empty')).toBeInTheDocument();

    // Divider should be present
    const divider = document.querySelector('.agent-console-divider');
    expect(divider).toBeInTheDocument();

    // Toggle button should NOT be present
    expect(
      screen.queryByRole('button', { name: /agent\.console\.badges_toggle/i }),
    ).not.toBeInTheDocument();
  });

  it('should show all badges details directly when badges exist', () => {
    mockState.badges = ['schema_ok', 'economy_ok'];

    render(<AgentConsole />);

    // Badges label
    expect(screen.getByText('agent.console.badges')).toBeInTheDocument();

    // Individual badge items should be visible
    expect(screen.getByText('agent.console.badge.schema')).toBeInTheDocument();
    expect(screen.getByText('agent.console.badge.economy')).toBeInTheDocument();

    // Status text (OK)
    const okStatuses = screen.getAllByText('agent.console.badge.ok');
    expect(okStatuses).toHaveLength(2);

    // Empty message should NOT be visible
    expect(screen.queryByText('agent.console.badges_empty')).not.toBeInTheDocument();
  });

  it('should show fail badge status correctly', () => {
    mockState.badges = ['schema_fail', 'economy_ok'];

    render(<AgentConsole />);

    // Schema badge should show fail
    expect(screen.getByText('agent.console.badge.schema')).toBeInTheDocument();
    expect(screen.getByText('agent.console.badge.fail')).toBeInTheDocument();

    // Economy badge should show OK
    expect(screen.getByText('agent.console.badge.economy')).toBeInTheDocument();
    expect(screen.getByText('agent.console.badge.ok')).toBeInTheDocument();
  });

  it('should show streaming queue items when streaming', () => {
    mockState.isStreaming = true;
    mockState.phases = [
      { name: 'parse', status: 'completed' },
      { name: 'validate', status: 'in_progress' },
    ];

    render(<AgentConsole />);

    // Queue idle text should NOT be visible
    expect(screen.queryByText('agent.console.queue_idle')).not.toBeInTheDocument();

    // Phase items should be visible
    expect(screen.getByText('agent.console.phase.parse')).toBeInTheDocument();
    expect(screen.getByText('agent.console.phase.validate')).toBeInTheDocument();
  });
});
</file>

<file path="frontend/src/components/DndInteraction.test.tsx">
import React from 'react';
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { render, screen, act, fireEvent, waitFor } from '@testing-library/react';
import App from '../App';
import * as turnStream from '../api/turnStream';

// dnd-kit ëª¨í‚¹ìš© íƒ€ì…
interface MockDndCallbacks {
  onDragEnd: (event: {
    active: { id: string; data: { current: unknown } };
    over: { id: string; data: { current: unknown } } | null;
  }) => void;
}

// dnd-kit ëª¨í‚¹ (ì½œë°± ê°€ë¡œì±„ê¸°ìš©)
vi.mock('@dnd-kit/core', async () => {
  const actual = (await vi.importActual('@dnd-kit/core')) as Record<string, unknown>;
  return {
    ...actual,
    DndContext: (props: MockDndCallbacks & { children: React.ReactNode }) => {
      // ì½œë°± ì €ì¥ (í…ŒìŠ¤íŠ¸ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ globalì— ì €ì¥)
      (global as unknown as Record<string, unknown>).dndCallbacks = props;
      return <div data-testid="mock-dnd-context">{props.children}</div>;
    },
  };
});

// i18next ëª¨í‚¹ (RU-003-Q5: ë°ëª¨ i18n í‚¤ ì§€ì›)
vi.mock('react-i18next', () => ({
  useTranslation: () => ({
    t: (key: string, options?: Record<string, unknown>) => {
      // ë°ëª¨ ì•„ì´í…œ ì´ë¦„
      if (key === 'demo.items.keycard-alpha.name') return 'í‚¤ì¹´ë“œ A';
      if (key === 'demo.items.medkit.name') return 'ì‘ê¸‰ í‚¤íŠ¸';
      if (key === 'demo.items.flashlight.name') return 'ì†ì „ë“±';
      if (key === 'demo.items.data-chip.name') return 'ë°ì´í„°ì¹©';
      // ë°ëª¨ ì”¬ ì˜¤ë¸Œì íŠ¸
      if (key === 'demo.scene.terminal.label') return 'í„°ë¯¸ë„';
      if (key === 'demo.scene.terminal.hint') return 'í™œì„±í™”ëœ í„°ë¯¸ë„ì´ë‹¤';
      if (key === 'demo.scene.door.label') return 'ë¬¸';
      if (key === 'demo.scene.door.hint') return 'ì ê²¨ìˆëŠ” ê²ƒ ê°™ë‹¤';
      // ì•¡ì…˜ í…œí”Œë¦¿
      if (key === 'inventory.item_label') return `Item: ${options?.name}`;
      if (key === 'scene.hotspot.drop_action') {
        return `Drop: ${options?.item} on ${options?.target}`;
      }
      if (key === 'scene.hotspot.drop_invalid') {
        return `Invalid: ${options?.item}`;
      }
      if (key === 'action_log.use_item_on_hotspot') {
        return `Action: Use ${options?.item} on ${options?.hotspot}`;
      }
      if (key === 'connection.online') return 'ONLINE';
      return key;
    },
    i18n: {
      changeLanguage: () => Promise.resolve(),
      resolvedLanguage: 'ko-KR',
    },
  }),
  initReactI18next: {
    type: '3rdParty',
    init: () => {},
  },
}));

// ResizeObserver ëª¨í‚¹
class MockResizeObserver {
  observe = vi.fn();
  unobserve = vi.fn();
  disconnect = vi.fn();
}
global.ResizeObserver = MockResizeObserver as unknown as typeof ResizeObserver;
window.ResizeObserver = MockResizeObserver as unknown as typeof ResizeObserver;

// api ëª¨í‚¹
vi.mock('../api/turnStream', () => ({
  startTurnStream: vi.fn(),
}));

describe('DnD Interaction - Logic Test', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    localStorage.clear();

    // prefers-reduced-motion ëª¨í‚¹ (NarrativeFeedì—ì„œ ì‚¬ìš©)
    // trueë¡œ ì„¤ì •í•˜ì—¬ íƒ€ì´í•‘ íš¨ê³¼ë¥¼ ìƒëµí•˜ê³  ì¦‰ì‹œ í…ìŠ¤íŠ¸ê°€ í‘œì‹œë˜ê²Œ í•¨
    Object.defineProperty(window, 'matchMedia', {
      writable: true,
      value: vi.fn().mockImplementation((query) => ({
        matches: query === '(prefers-reduced-motion: reduce)',
        media: query,
        onchange: null,
        addListener: vi.fn(),
        removeListener: vi.fn(),
        addEventListener: vi.fn(),
        removeEventListener: vi.fn(),
        dispatchEvent: vi.fn(),
      })),
    });
  });

  afterEach(() => {
    //
  });

  it('should trigger turn execution when handleDragEnd is called with a hotspot target', async () => {
    render(<App />);

    // 1. í”„ë¡œí•„ ì„ íƒ (Playing í˜ì´ì¦ˆ ì§„ì…)
    const narratorProfile = screen.getByLabelText('profile.narrator.name');
    fireEvent.click(narratorProfile);

    // U-060: í”„ë¡œí•„ ì„ íƒ í›„ DndContext ë§ˆìš´íŠ¸ë¥¼ ê¸°ë‹¤ë¦¼
    // DndContextê°€ ë Œë”ë§ëœ í›„ ì½œë°± ê°€ì ¸ì˜¤ê¸°
    const dndCallbacks = await waitFor(() => {
      const callbacks = (global as unknown as Record<string, MockDndCallbacks>).dndCallbacks;
      expect(callbacks).toBeDefined();
      expect(callbacks.onDragEnd).toBeDefined();
      return callbacks;
    });

    // RU-003-Q1: ë“œë˜ê·¸ ë°ì´í„°ì— item ê°ì²´ í¬í•¨ (íƒ€ì… ê°€ë“œ ìš”êµ¬ì‚¬í•­)
    const mockItem = {
      id: 'keycard-alpha',
      name: 'í‚¤ì¹´ë“œ A',
      icon: 'ğŸ”‘',
      quantity: 1,
    };

    // ì„±ê³µ ì‹œë‚˜ë¦¬ì˜¤ ì‹œë®¬ë ˆì´ì…˜
    act(() => {
      dndCallbacks.onDragEnd({
        active: {
          id: 'keycard-alpha',
          data: {
            current: {
              type: 'inventory-item',
              item_id: 'keycard-alpha',
              item: mockItem,
            },
          },
        },
        over: {
          id: 'hotspot-demo-terminal',
          data: {
            current: {
              type: 'hotspot',
              object_id: 'demo-terminal',
              label: 'í„°ë¯¸ë„',
              box_2d: { ymin: 300, xmin: 100, ymax: 600, xmax: 400 },
            },
          },
        },
      });
    });

    // startTurnStream í˜¸ì¶œ í™•ì¸
    await waitFor(() => {
      expect(turnStream.startTurnStream).toHaveBeenCalled();
    });
    const [input] = vi.mocked(turnStream.startTurnStream).mock.calls[0];

    expect(input.text).toBe('Drop: í‚¤ì¹´ë“œ A on í„°ë¯¸ë„');
    expect(input.drop).toEqual({
      item_id: 'keycard-alpha',
      target_object_id: 'demo-terminal',
      target_box_2d: { ymin: 300, xmin: 100, ymax: 600, xmax: 400 },
    });

    // U-070: ë“œë¡­ ì¦‰ì‹œ NarrativeFeedì— ì•¡ì…˜ ë¡œê·¸ê°€ í‘œì‹œë˜ì–´ì•¼ í•¨
    const actionLog = await screen.findByText(/Action: Use í‚¤ì¹´ë“œ A on í„°ë¯¸ë„/);
    expect(actionLog).toBeInTheDocument();
    expect(actionLog.closest('.narrative-entry')).toHaveClass('action-log-entry');
  });

  it('should show failure feedback when handleDragEnd is called with an invalid target', async () => {
    render(<App />);

    // 1. í”„ë¡œí•„ ì„ íƒ (Playing í˜ì´ì¦ˆ ì§„ì…)
    const narratorProfile = screen.getByLabelText('profile.narrator.name');
    fireEvent.click(narratorProfile);

    // U-060: í”„ë¡œí•„ ì„ íƒ í›„ DndContext ë§ˆìš´íŠ¸ë¥¼ ê¸°ë‹¤ë¦¼
    // DndContextê°€ ë Œë”ë§ëœ í›„ ì½œë°± ê°€ì ¸ì˜¤ê¸°
    const dndCallbacks = await waitFor(() => {
      const callbacks = (global as unknown as Record<string, MockDndCallbacks>).dndCallbacks;
      expect(callbacks).toBeDefined();
      expect(callbacks.onDragEnd).toBeDefined();
      return callbacks;
    });

    // RU-003-Q1: ë“œë˜ê·¸ ë°ì´í„°ì— item ê°ì²´ í¬í•¨ (íƒ€ì… ê°€ë“œ ìš”êµ¬ì‚¬í•­)
    const mockItem = {
      id: 'keycard-alpha',
      name: 'í‚¤ì¹´ë“œ A',
      icon: 'ğŸ”‘',
      quantity: 1,
    };

    // ì‹¤íŒ¨ ì‹œë‚˜ë¦¬ì˜¤ ì‹œë®¬ë ˆì´ì…˜ (overê°€ null)
    act(() => {
      dndCallbacks.onDragEnd({
        active: {
          id: 'keycard-alpha',
          data: {
            current: {
              type: 'inventory-item',
              item_id: 'keycard-alpha',
              item: mockItem,
            },
          },
        },
        over: null,
      });
    });

    // turn ì‹¤í–‰ì€ ë°œìƒí•˜ì§€ ì•Šì•„ì•¼ í•¨
    expect(turnStream.startTurnStream).not.toHaveBeenCalled();

    // ë‚´ëŸ¬í‹°ë¸Œ í”¼ë“œì— ì‹¤íŒ¨ ë©”ì‹œì§€ê°€ ë‚˜íƒ€ë‚˜ì•¼ í•¨
    const failureMessage = await screen.findByText(/Invalid: í‚¤ì¹´ë“œ A/);
    expect(failureMessage).toBeInTheDocument();
  });
});
</file>

<file path="frontend/src/components/EconomyHud.test.tsx">
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { render, screen } from '@testing-library/react';
import { EconomyHud } from './EconomyHud';
import { useWorldStore } from '../stores/worldStore';
import { useEconomyStore } from '../stores/economyStore';

// react-i18next ëª¨í‚¹
vi.mock('react-i18next', () => ({
  useTranslation: () => ({
    t: (key: string) => key,
  }),
  initReactI18next: {
    type: '3rdParty',
    init: () => {},
  },
}));

describe('EconomyHud', () => {
  beforeEach(() => {
    useWorldStore.getState().reset();
    useEconomyStore.getState().reset();
    useEconomyStore.getState().clearLedger();
  });

  it('í˜„ì¬ ì”ì•¡ì„ ì˜¬ë°”ë¥´ê²Œ í‘œì‹œí•´ì•¼ í•œë‹¤', () => {
    useWorldStore.getState().setEconomy({ signal: 50, memory_shard: 5, credit: 0 });

    render(<EconomyHud />);

    expect(screen.getByTestId('signal-balance')).toHaveTextContent('50');
    expect(screen.getByTestId('shard-balance')).toHaveTextContent('5');
  });

  it('ì˜ˆìƒ ë¹„ìš©ì´ ìˆì„ ë•Œ í‘œì‹œí•´ì•¼ í•œë‹¤', () => {
    useEconomyStore.getState().setCostEstimate({
      min: { signal: 5, memory_shard: 0 },
      max: { signal: 10, memory_shard: 0 },
      label: 'Test Action',
    });

    render(<EconomyHud />);

    expect(screen.getByText('economy.estimated_cost')).toBeInTheDocument();
    expect(screen.getByText('Test Action')).toBeInTheDocument();
    expect(screen.getByText('5~10')).toBeInTheDocument();
  });

  it('ê°ë‹¹í•  ìˆ˜ ì—†ëŠ” ì˜ˆìƒ ë¹„ìš©ì¼ ë•Œ ê²½ê³ ë¥¼ í‘œì‹œí•´ì•¼ í•œë‹¤', () => {
    useWorldStore.getState().setEconomy({ signal: 5, memory_shard: 0, credit: 0 });
    useEconomyStore.getState().setCostEstimate({
      min: { signal: 10, memory_shard: 0 },
      max: { signal: 15, memory_shard: 0 },
    });

    const { container } = render(<EconomyHud />);

    expect(screen.getByText('economy.insufficient_funds')).toBeInTheDocument();
    expect(container.querySelector('.cost-unaffordable')).toBeInTheDocument();
  });

  it('ì˜ˆìƒ ë¹„ìš©ì´ ì—†ì„ ë•Œ ë§ˆì§€ë§‰ í™•ì • ë¹„ìš©ì„ í‘œì‹œí•´ì•¼ í•œë‹¤', () => {
    useEconomyStore.getState().setLastCost({
      turnId: 1,
      cost: { signal: 8, memory_shard: 1 },
      balanceAfter: { signal: 92, memory_shard: 4 },
      modelLabel: 'QUALITY',
    });

    render(<EconomyHud />);

    expect(screen.getByText('economy.confirmed_cost')).toBeInTheDocument();
    expect(screen.getByText('8')).toBeInTheDocument();
    expect(screen.getByText('1')).toBeInTheDocument();
    expect(screen.getByText('economy.model_label.QUALITY')).toBeInTheDocument();
  });

  it('ì”ì•¡ ë¶€ì¡± ì‹œ ê²½ê³  ë° ëŒ€ì•ˆì„ í‘œì‹œí•´ì•¼ í•œë‹¤', () => {
    // ì„ê³„ê°’ 10, í˜„ì¬ ì”ì•¡ 5
    useWorldStore.getState().setEconomy({ signal: 5, memory_shard: 0, credit: 0 });
    useEconomyStore.getState().updateBalanceLowStatus({ signal: 5, memory_shard: 0 });

    render(<EconomyHud />);

    expect(screen.getByText('economy.low_balance_warning')).toBeInTheDocument();
    expect(screen.getByText('economy.low_balance_title')).toBeInTheDocument();
    expect(screen.getByText('economy.fast_fallback_notice')).toBeInTheDocument();
    expect(screen.getByText('economy.hint_sell_items')).toBeInTheDocument();
  });

  it('í¬ë ˆë”§ì´ ìˆì„ ë•Œ í‘œì‹œí•´ì•¼ í•œë‹¤', () => {
    useWorldStore.getState().setEconomy({ signal: 0, memory_shard: 5, credit: 10 });

    render(<EconomyHud />);

    expect(screen.getByText(/economy.credit/)).toBeInTheDocument();
    expect(screen.getByText('-10')).toBeInTheDocument();
  });

  it('compact ëª¨ë“œì—ì„œëŠ” ì”ì•¡ë§Œ í‘œì‹œí•´ì•¼ í•œë‹¤', () => {
    useEconomyStore.getState().setCostEstimate({
      min: { signal: 5, memory_shard: 0 },
      max: { signal: 10, memory_shard: 0 },
    });

    render(<EconomyHud compact />);

    // ì”ì•¡ì€ í‘œì‹œë¨
    expect(screen.getByTestId('signal-balance')).toBeInTheDocument();
    // ì˜ˆìƒ ë¹„ìš©ì€ í‘œì‹œë˜ì§€ ì•ŠìŒ
    expect(screen.queryByText('economy.estimated_cost')).not.toBeInTheDocument();
  });

  it('ê±°ë˜ ì¥ë¶€ ì´ë ¥ì´ ìˆì„ ë•Œ í‘œì‹œí•´ì•¼ í•œë‹¤', () => {
    useEconomyStore.getState().addLedgerEntry({
      turnId: 1,
      reason: 'test reason',
      cost: { signal: 5, memory_shard: 0 },
      balanceAfter: { signal: 95, memory_shard: 5 },
      modelLabel: 'FAST',
    });

    render(<EconomyHud />);

    expect(screen.getByText('economy.ledger_title')).toBeInTheDocument();
    expect(screen.getByText('T1')).toBeInTheDocument();
    expect(screen.getByText('test reason')).toBeInTheDocument();
    expect(screen.getByText('-5')).toBeInTheDocument();
  });
});
</file>

<file path="frontend/src/components/NarrativeFeed.tsx">
/**
 * Unknown World - NarrativeFeed ì»´í¬ë„ŒíŠ¸ (U-066 + U-086: í…ìŠ¤íŠ¸ ìš°ì„  íƒ€ì´í•‘ ì¶œë ¥)
 *
 * ë‚´ëŸ¬í‹°ë¸Œ í…ìŠ¤íŠ¸ì— íƒ€ì´í•‘(Typewriter) íš¨ê³¼ë¥¼ ì ìš©í•˜ì—¬,
 * ì´ë¯¸ì§€ ìƒì„± ì§€ì—°ì„ ìì—°ìŠ¤ëŸ½ê²Œ í¡ìˆ˜í•©ë‹ˆë‹¤.
 *
 * ì„¤ê³„ ì›ì¹™ (U-086 + streaming buffering):
 *   - ìŠ¤íŠ¸ë¦¬ë° ì¤‘: useStreamingTypewriterë¡œ ì„œë²„ ì†ë„ì™€ ë¬´ê´€í•˜ê²Œ ~12ì´ˆì— ê±¸ì³ ì ì§„ ì¶œë ¥
 *   - ìŠ¤íŠ¸ë¦¬ë° ì¢…ë£Œ í›„: useTypewriterë¡œ entries í…ìŠ¤íŠ¸ ì´ì–´ì„œ íƒ€ì´í•‘
 *   - ì´ë¯¸ì§€ ìƒì„± ì¤‘(isImageLoading): ëŠë¦° íƒ€ì´í•‘ ì†ë„
 *   - íƒ€ì´í•‘ ì™„ë£Œ í›„ì—ë„ ì´ë¯¸ì§€ ë¯¸ë„ì°© ì‹œ: "ì´ë¯¸ì§€ í˜•ì„± ì¤‘â€¦" ìƒíƒœ ë¼ì¸ í‘œì‹œ
 *   - fast-forward ì—†ìŒ: í•­ìƒ ì ì§„ ì¶œë ¥
 *   - ì ‘ê·¼ì„±: prefers-reduced-motion ì„¤ì • ì¡´ì¤‘
 *
 * @module components/NarrativeFeed
 */

import { useEffect, useRef, useState, useMemo } from 'react';
import { useTranslation } from 'react-i18next';
import type { NarrativeEntry } from '../stores/worldStore';

// =============================================================================
// ìƒìˆ˜ ì •ì˜ (U-066 + U-086)
// =============================================================================

/** íƒ€ì´í•‘ ì¸í„°ë²Œ (ms) - ~30fpsë¡œ ë¶€ë“œëŸ¬ìš´ íƒ€ì´í•‘ ì—°ì¶œ */
const TYPING_TICK_MS = 32;

/**
 * ì´ë¯¸ì§€ ìƒì„± ì¤‘ ëŠë¦° ëª¨ë“œ ëª©í‘œ ì‹œê°„ (ms)
 * U-086 Q1 Option A: isImageLoadingì´ë©´ ë¬´ì¡°ê±´ ëŠë¦° ëª¨ë“œ (~12ì´ˆ ëª©í‘œ, ì²´ê° ìš°ì„ )
 */
const TARGET_DURATION_MS_WHILE_STREAMING = 12000;

/**
 * ìœ íœ´ ìƒíƒœ(ì´ë¯¸ì§€ ì™„ë£Œ/ì—†ìŒ) ë¹ ë¥¸ ëª¨ë“œ ëª©í‘œ ì‹œê°„ (ms)
 * ì´ë¯¸ì§€ê°€ ë„ì°©í•˜ë©´ ë‚¨ì€ í…ìŠ¤íŠ¸ë¥¼ ë¹ ë¥´ê²Œ ì¶œë ¥
 */
const TARGET_DURATION_MS_IDLE = 2500;

/** ìµœì†Œ CPS (characters per second) - ë§¤ìš° ê¸´ í…ìŠ¤íŠ¸ì—ì„œë„ ìµœì†Œ ì†ë„ ë³´ì¥ */
const MIN_CPS = 10;

/** ìµœëŒ€ CPS - ì§§ì€ í…ìŠ¤íŠ¸ë„ ë¹ ë¥´ê²Œ í‘œì‹œ ê°€ëŠ¥ */
const MAX_CPS = 400;

// =============================================================================
// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
// =============================================================================

/** ê°’ì„ min~max ë²”ìœ„ë¡œ ì œí•œí•©ë‹ˆë‹¤. */
function clamp(value: number, min: number, max: number): number {
  return Math.max(min, Math.min(max, value));
}

// =============================================================================
// íƒ€ì… ì •ì˜
// =============================================================================

interface NarrativeFeedProps {
  entries: NarrativeEntry[];
  streamingText: string;
  /** U-066: ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì¸ì§€ ì—¬ë¶€ (íƒ€ì´í•‘ ì†ë„ ê²°ì •ì— ì‚¬ìš©) */
  isStreaming?: boolean;
  /** U-066: ì´ë¯¸ì§€ ë¡œë”© ì¤‘ì¸ì§€ ì—¬ë¶€ (íƒ€ì´í•‘ ì†ë„ ê²°ì •ì— ì‚¬ìš©) */
  isImageLoading?: boolean;
}

// =============================================================================
// ì»¤ìŠ¤í…€ í›…: useStreamingTypewriter (ìŠ¤íŠ¸ë¦¬ë° í…ìŠ¤íŠ¸ ë²„í¼ë§)
// =============================================================================

/**
 * ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì¸ í…ìŠ¤íŠ¸ë¥¼ ì ì§„ì ìœ¼ë¡œ í‘œì‹œí•˜ëŠ” í›….
 *
 * ì„œë²„ì—ì„œ narrative_deltaê°€ ë¹ ë¥´ê²Œ ë„ì°©í•´ë„ í™”ë©´ì—ëŠ” CPS ì œí•œì— ë”°ë¼
 * ì²œì²œíˆ í‘œì‹œë˜ì–´ ì´ë¯¸ì§€ ìƒì„± ì‹œê°„(~10ì´ˆ)ì„ ìì—°ìŠ¤ëŸ½ê²Œ í¡ìˆ˜í•©ë‹ˆë‹¤.
 * fast-forward ê¸°ëŠ¥ ì—†ìŒ â€” í•­ìƒ ì ì§„ ì¶œë ¥.
 *
 * @param streamingText - ì„œë²„ì—ì„œ ëˆ„ì ëœ ìŠ¤íŠ¸ë¦¬ë° í…ìŠ¤íŠ¸ (ë¹ˆ ë¬¸ìì—´ì´ë©´ ë¹„í™œì„±)
 * @returns displayedText, displayedLen, isTyping
 */
function useStreamingTypewriter(streamingText: string) {
  const [displayedLen, setDisplayedLen] = useState(0);

  // prefers-reduced-motion ê°ì§€
  const [prefersReducedMotion, setPrefersReducedMotion] = useState(() => {
    if (typeof window === 'undefined') return false;
    return window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  });

  useEffect(() => {
    if (typeof window === 'undefined') return;
    const mediaQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
    const handleChange = (e: MediaQueryListEvent) => setPrefersReducedMotion(e.matches);
    mediaQuery.addEventListener('change', handleChange);
    return () => mediaQuery.removeEventListener('change', handleChange);
  }, []);

  // ìƒˆë¡œìš´ ìŠ¤íŠ¸ë¦¬ë°ì´ ì‹œì‘ë  ë•Œë§Œ displayedLen ë¦¬ì…‹
  const [prevStreaming, setPrevStreaming] = useState(streamingText);
  if (streamingText && !prevStreaming) {
    setPrevStreaming(streamingText);
    setDisplayedLen(0);
  } else if (streamingText !== prevStreaming) {
    setPrevStreaming(streamingText);
  }

  // CPS ê³„ì‚°: í˜„ì¬ ë²„í¼ ê¸¸ì´ ê¸°ì¤€ìœ¼ë¡œ ëª©í‘œ ì‹œê°„ì— ë§ì¶¤
  const charsPerTick = useMemo(() => {
    if (!streamingText || streamingText.length === 0) return 1;
    const cps = clamp(
      streamingText.length / (TARGET_DURATION_MS_WHILE_STREAMING / 1000),
      MIN_CPS,
      MAX_CPS,
    );
    return Math.max(1, Math.round((cps * TYPING_TICK_MS) / 1000));
  }, [streamingText]);

  // íƒ€ì´í•‘ ë£¨í”„
  useEffect(() => {
    if (!streamingText || prefersReducedMotion) return;
    if (displayedLen >= streamingText.length) return;

    const intervalId = setInterval(() => {
      setDisplayedLen((prev) => {
        const next = prev + charsPerTick;
        return next >= streamingText.length ? streamingText.length : next;
      });
    }, TYPING_TICK_MS);

    return () => clearInterval(intervalId);
  }, [streamingText, displayedLen, charsPerTick, prefersReducedMotion]);

  const displayedText = useMemo(() => {
    if (!streamingText) return '';
    if (prefersReducedMotion) return streamingText;
    return streamingText.slice(0, displayedLen);
  }, [streamingText, displayedLen, prefersReducedMotion]);

  const isTyping = !!streamingText && displayedLen < streamingText.length && !prefersReducedMotion;

  return { displayedText, displayedLen, isTyping };
}

// =============================================================================
// ì»¤ìŠ¤í…€ í›…: useTypewriter (U-066)
// =============================================================================

/**
 * íƒ€ì´í•‘ íš¨ê³¼ë¥¼ ìœ„í•œ ì»¤ìŠ¤í…€ í›…
 *
 * @param targetText - íƒ€ì´í•‘ ëŒ€ìƒ í…ìŠ¤íŠ¸
 * @param shouldBuyTime - ëŠë¦° íƒ€ì´í•‘ ëª¨ë“œ ì‚¬ìš© ì—¬ë¶€
 * @param initialLength - ì´ë¯¸ í‘œì‹œëœ ë¬¸ì ìˆ˜ (ìŠ¤íŠ¸ë¦¬ë° í›„ ì „í™˜ ì‹œ ì¬íƒ€ì´í•‘ ë°©ì§€, U-097)
 * @returns íƒ€ì´í•‘ ìƒíƒœ ë° ì œì–´ í•¨ìˆ˜
 */
function useTypewriter(targetText: string, shouldBuyTime: boolean, initialLength: number = 0) {
  const [typedLen, setTypedLen] = useState(0);
  const [lastTargetText, setLastTargetText] = useState(targetText);

  // prefers-reduced-motion ê°ì§€
  const [prefersReducedMotion, setPrefersReducedMotion] = useState(() => {
    if (typeof window === 'undefined') return false;
    return window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  });

  // CPS ê³„ì‚°
  const cps = useMemo(() => {
    if (!targetText || targetText.length === 0) return MIN_CPS;
    const durationMs = shouldBuyTime ? TARGET_DURATION_MS_WHILE_STREAMING : TARGET_DURATION_MS_IDLE;
    const calculatedCps = targetText.length / (durationMs / 1000);
    return clamp(calculatedCps, MIN_CPS, MAX_CPS);
  }, [targetText, shouldBuyTime]);

  // í‹±ë‹¹ ë¬¸ì ìˆ˜ ê³„ì‚°
  const charsPerTick = useMemo(() => {
    return Math.max(1, Math.round((cps * TYPING_TICK_MS) / 1000));
  }, [cps]);

  // reduced-motion ë¯¸ë””ì–´ ì¿¼ë¦¬ ê°ì§€
  useEffect(() => {
    if (typeof window === 'undefined') return;

    const mediaQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
    const handleChange = (e: MediaQueryListEvent) => {
      setPrefersReducedMotion(e.matches);
    };

    mediaQuery.addEventListener('change', handleChange);
    return () => mediaQuery.removeEventListener('change', handleChange);
  }, []);

  // íƒ€ì´í•‘ ëŒ€ìƒ í…ìŠ¤íŠ¸ê°€ ë³€ê²½ë˜ë©´ ìƒíƒœ ì´ˆê¸°í™”
  // U-097: initialLengthê°€ ìˆìœ¼ë©´ ì´ë¯¸ í‘œì‹œëœ ìœ„ì¹˜ë¶€í„° ì‹œì‘ (ìŠ¤íŠ¸ë¦¬ë°â†’entries ì „í™˜ ì‹œ í”Œë˜ì‹œ ë°©ì§€)
  if (targetText !== lastTargetText) {
    setLastTargetText(targetText);
    const startPos = initialLength > 0 ? Math.min(initialLength, targetText.length) : 0;
    setTypedLen(startPos);
  }

  // íƒ€ì´í•‘ ë£¨í”„
  useEffect(() => {
    // ì´ë¯¸ ì™„ë£Œëœ ê²½ìš°
    if (typedLen >= targetText.length) {
      return;
    }

    // reduced-motionì´ë©´ ì¦‰ì‹œ ì™„ë£Œ
    if (prefersReducedMotion) {
      const rafId = requestAnimationFrame(() => {
        setTypedLen(targetText.length);
      });
      return () => cancelAnimationFrame(rafId);
    }

    const intervalId = setInterval(() => {
      setTypedLen((prev) => {
        const next = prev + charsPerTick;
        return next >= targetText.length ? targetText.length : next;
      });
    }, TYPING_TICK_MS);

    return () => clearInterval(intervalId);
  }, [targetText, typedLen, charsPerTick, prefersReducedMotion]);

  // í‘œì‹œí•  í…ìŠ¤íŠ¸ ê³„ì‚°
  const visibleText = useMemo(() => {
    if (prefersReducedMotion) {
      return targetText;
    }
    return targetText.slice(0, typedLen);
  }, [targetText, typedLen, prefersReducedMotion]);

  // íƒ€ì´í•‘ ì§„í–‰ ì¤‘ì¸ì§€ ì—¬ë¶€
  const isTyping = typedLen < targetText.length && !prefersReducedMotion;

  return {
    visibleText,
    isTyping,
  };
}

// =============================================================================
// ì»´í¬ë„ŒíŠ¸ êµ¬í˜„
// =============================================================================

export function NarrativeFeed({
  entries,
  streamingText,
  isStreaming: _isStreaming = false, // U-097: prop ìœ ì§€ (í–¥í›„ ì‚¬ìš© ê°€ëŠ¥, API í˜¸í™˜ì„±)
  isImageLoading = false,
}: NarrativeFeedProps) {
  const { t } = useTranslation();
  const feedRef = useRef<HTMLDivElement>(null);

  // ìŠ¤íŠ¸ë¦¬ë° í…ìŠ¤íŠ¸ ë²„í¼ë§ íƒ€ì´í”„ë¼ì´í„°
  const {
    displayedText: streamingDisplayedText,
    displayedLen: streamingDisplayedLen,
    isTyping: isStreamTyping,
  } = useStreamingTypewriter(streamingText);

  // U-097: ìŠ¤íŠ¸ë¦¬ë°ì—ì„œ ì‹¤ì œ í™”ë©´ì— í‘œì‹œëœ ê¸¸ì´ë¥¼ ì¶”ì  (ìŠ¤íŠ¸ë¦¬ë°â†’entries ì „í™˜ ì‹œ ì¬íƒ€ì´í•‘ ë°©ì§€)
  const [initialLength, setInitialLength] = useState(0);

  // ìŠ¤íŠ¸ë¦¬ë° ì¢…ë£Œ ê°ì§€ ë° initialLength ì„¤ì •
  const [prevStreamingForInit, setPrevStreamingForInit] = useState(streamingText);
  if (streamingText !== prevStreamingForInit) {
    setPrevStreamingForInit(streamingText);
    if (!streamingText && streamingDisplayedLen > 0) {
      setInitialLength(streamingDisplayedLen);
    }
  }

  // U-097: typewriter ëŒ€ìƒ í…ìŠ¤íŠ¸ ê²°ì •
  // ìŠ¤íŠ¸ë¦¬ë° ì¤‘: typewriter ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (streamingTextë¥¼ ì§ì ‘ í‘œì‹œ)
  // ìŠ¤íŠ¸ë¦¬ë° ì¢…ë£Œ í›„: entriesì˜ ë§ˆì§€ë§‰ í…ìŠ¤íŠ¸ë¥¼ typewriter ëŒ€ìƒìœ¼ë¡œ ì„¤ì •
  const typewriterTarget = useMemo(() => {
    if (streamingText) return ''; // ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì—” typewriter ë¶ˆí•„ìš”
    if (entries.length > 0) return entries[entries.length - 1].text;
    return '';
  }, [streamingText, entries]);

  // U-097: initialLengthê°€ ì‚¬ìš©ëœ í›„ ë¦¬ì…‹ (ë‹¤ìŒ í„´ì— ì˜í–¥ ë°©ì§€)
  useEffect(() => {
    if (initialLength > 0 && typewriterTarget) {
      // typewriterê°€ initialLengthë¥¼ ì°¸ì¡°í•œ í›„ ë‹¤ìŒ ë Œë”ì—ì„œ ë¦¬ì…‹
      const raf = requestAnimationFrame(() => setInitialLength(0));
      return () => cancelAnimationFrame(raf);
    }
  }, [initialLength, typewriterTarget]);

  // U-066: ì‹œê°„ì„ ë²Œì–´ì•¼ í•˜ëŠ”ì§€ ì—¬ë¶€ (ëŠë¦° íƒ€ì´í•‘)
  const shouldBuyTime = isImageLoading;

  // U-066: íƒ€ì´í•‘ íš¨ê³¼ í›… (ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì—ëŠ” ë¹ˆ ë¬¸ìì—´ì´ë¯€ë¡œ ë¹„í™œì„±)
  const { visibleText, isTyping } = useTypewriter(typewriterTarget, shouldBuyTime, initialLength);

  // ìƒˆ ì—”íŠ¸ë¦¬ ì¶”ê°€ ì‹œ ìŠ¤í¬ë¡¤ (ìŠ¤íŠ¸ë¦¬ë° í‘œì‹œ í…ìŠ¤íŠ¸ ë³€ê²½ ì‹œì—ë„ ìŠ¤í¬ë¡¤)
  useEffect(() => {
    if (feedRef.current) {
      feedRef.current.scrollTop = feedRef.current.scrollHeight;
    }
  }, [entries, visibleText, streamingDisplayedText]);

  // U-066: ë§ˆì§€ë§‰ ì—”íŠ¸ë¦¬ íƒ€ì´í•‘ ì¤‘ ì¤‘ë³µ í‘œì‹œ ë°©ì§€
  const shouldHideLastEntry = !streamingText && entries.length > 0 && isTyping;

  // U-097: í™œì„± í…ìŠ¤íŠ¸ ì˜ì—­ í‘œì‹œ ì—¬ë¶€
  // ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì´ê±°ë‚˜ íƒ€ì´í•‘ ì¤‘ì¼ ë•Œ í™œì„± í…ìŠ¤íŠ¸ ì˜ì—­ì„ í‘œì‹œ
  const showActiveTextArea = !!streamingText || shouldHideLastEntry;

  return (
    <div className="narrative-feed" ref={feedRef} role="log" aria-live="polite">
      {entries.map((entry, index) => {
        // U-066: ë§ˆì§€ë§‰ ì—”íŠ¸ë¦¬ íƒ€ì´í•‘ ì¤‘ ìˆ¨ê¹€ ì²˜ë¦¬
        const isLastEntry = index === entries.length - 1;
        if (shouldHideLastEntry && isLastEntry) {
          return null;
        }

        // U-070: ì—”íŠ¸ë¦¬ íƒ€ì…ì— ë”°ë¥¸ í´ë˜ìŠ¤ ë° ìŠ¤íƒ€ì¼ ê²°ì •
        const entryType = entry.type ?? 'narrative';
        const isActionLog = entryType === 'action_log';
        const isSystem = entryType === 'system';
        const entryClassName = [
          'narrative-entry',
          isActionLog && 'action-log-entry',
          isSystem && 'system-entry',
        ]
          .filter(Boolean)
          .join(' ');

        return (
          <div key={`${entry.turn}-${index}`} className={entryClassName}>
            {/* U-070: ì•¡ì…˜ ë¡œê·¸ëŠ” â–¶ ì•„ì´ì½˜ í‘œì‹œ, í„´ ë¼ë²¨ ìˆ¨ê¹€ */}
            {isActionLog ? (
              <span className="action-log-icon" aria-hidden="true">
                â–¶
              </span>
            ) : (
              <span className="narrative-timestamp">
                {t('narrative.turn_label', { turn: entry.turn })}
              </span>
            )}
            <span className="narrative-text">{entry.text}</span>
          </div>
        );
      })}

      {/* U-097: í™œì„± í…ìŠ¤íŠ¸ ì˜ì—­ - ìŠ¤íŠ¸ë¦¬ë° ì‹¤ì‹œê°„ ì¶œë ¥ ë˜ëŠ” íƒ€ì´í•‘ íš¨ê³¼ */}
      {showActiveTextArea && (
        <div className={`narrative-entry ${streamingText ? 'streaming' : 'typing'}`}>
          <span className="narrative-timestamp">
            {streamingText
              ? t('narrative.streaming_label')
              : t('narrative.turn_label', { turn: entries[entries.length - 1]?.turn ?? 0 })}
          </span>
          {/* ìŠ¤íŠ¸ë¦¬ë° ì¤‘ â†’ ë²„í¼ë§ëœ í…ìŠ¤íŠ¸ ì ì§„ í‘œì‹œ, ì•„ë‹ˆë©´ â†’ typewriter ê²°ê³¼ */}
          <span className="narrative-text">{streamingDisplayedText || visibleText}</span>
          {(isStreamTyping || isTyping) && <span className="cursor-blink">â–Œ</span>}
        </div>
      )}

      {/* U-086: ì´ë¯¸ì§€ pending ìƒíƒœ ë¼ì¸
          íƒ€ì´í•‘ì´ ì™„ë£Œëœ í›„ì—ë„ ì´ë¯¸ì§€ê°€ ì•„ì§ ìƒì„± ì¤‘ì´ë©´ ëŒ€ê¸° ì´ìœ ë¥¼ ëª…í™•íˆ í‘œì‹œ.
          RULE-002: ê²Œì„ ë¡œê·¸ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ (ì±„íŒ… ë²„ë¸” ì•„ë‹˜)
          RULE-006: i18n í‚¤ ê¸°ë°˜ ë©”ì‹œì§€ */}
      {!isTyping && !isStreamTyping && !streamingText && isImageLoading && (
        <div
          className="narrative-entry system-entry image-pending-line"
          role="status"
          aria-live="polite"
        >
          <span className="image-pending-label">{t('narrative.image_pending_label')}</span>
          <span className="image-pending-cursor" aria-hidden="true">
            â–Œ
          </span>
        </div>
      )}
    </div>
  );
}
</file>

<file path="frontend/src/components/ScannerSlot.test.tsx">
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { ScannerSlot } from './ScannerSlot';
import * as scannerApi from '../api/scanner';
import { useInventoryStore } from '../stores/inventoryStore';
import { useAgentStore } from '../stores/agentStore';

// i18next ëª¨í‚¹
vi.mock('react-i18next', () => ({
  useTranslation: () => ({
    t: (key: string, params?: Record<string, unknown>) => {
      if (key === 'scanner.detected_objects') return `${params?.count} objects detected`;
      if (key === 'scanner.item_candidates') return `${params?.count} item candidates`;
      if (key === 'scanner.add_to_inventory') return `Add ${params?.count} items to inventory`;
      return key;
    },
  }),
}));

// URL.createObjectURL ëª¨í‚¹
global.URL.createObjectURL = vi.fn(() => 'mock-url');
global.URL.revokeObjectURL = vi.fn();

describe('ScannerSlot Component', () => {
  const mockLanguage = 'ko-KR';

  const mockScanResponse: scannerApi.ScannerResponse = {
    success: true,
    status: 'completed',
    caption: 'A mysterious artifact found in the desert.',
    objects: [
      {
        label: 'Artifact',
        box_2d: { ymin: 100, xmin: 100, ymax: 200, xmax: 200 },
        confidence: 0.9,
      },
    ],
    item_candidates: [
      {
        id: 'item-1',
        label: 'Glowing Stone',
        description: 'A stone that glows in the dark',
        item_type: 'artifact',
      },
      {
        id: 'item-2',
        label: 'Ancient Script',
        description: 'Unreadable text on a fragment',
        item_type: 'document',
      },
    ],
    analysis_time_ms: 1200,
    language: 'ko-KR',
  };

  beforeEach(() => {
    vi.clearAllMocks();
    useInventoryStore.setState({ items: [] });
    useAgentStore.setState({ isStreaming: false });
  });

  it('renders dropzone in idle state', () => {
    render(<ScannerSlot language={mockLanguage} />);
    expect(screen.getByText('scanner.dropzone_text')).toBeInTheDocument();
    expect(screen.getByText('scanner.dropzone_hint')).toBeInTheDocument();
  });

  it('handles file drop and triggers scanImage', async () => {
    const scanImageSpy = vi.spyOn(scannerApi, 'scanImage').mockResolvedValue({
      success: true,
      data: mockScanResponse,
    });

    render(<ScannerSlot language={mockLanguage} />);

    const dropzone = screen.getByRole('button', { name: /scanner.dropzone_label/i });
    const file = new File(['mock content'], 'test.png', { type: 'image/png' });

    // ë“œë¡­ ì´ë²¤íŠ¸ ì‹œë®¬ë ˆì´ì…˜
    fireEvent.drop(dropzone, {
      dataTransfer: {
        files: [file],
      },
    });

    // ì—…ë¡œë“œ/ë¶„ì„ ìƒíƒœ í™•ì¸
    expect(screen.getByText(/scanner.(uploading|analyzing)/i)).toBeInTheDocument();

    // ê²°ê³¼ ë Œë”ë§ ëŒ€ê¸°
    await waitFor(() => {
      expect(screen.getByText('A mysterious artifact found in the desert.')).toBeInTheDocument();
    });

    expect(scanImageSpy).toHaveBeenCalledWith(file, mockLanguage);
    expect(screen.getByText('Glowing Stone')).toBeInTheDocument();
    expect(screen.getByText('Ancient Script')).toBeInTheDocument();
  });

  it('allows toggling candidate selection', async () => {
    vi.spyOn(scannerApi, 'scanImage').mockResolvedValue({
      success: true,
      data: mockScanResponse,
    });

    render(<ScannerSlot language={mockLanguage} />);

    const dropzone = screen.getByRole('button', { name: /scanner.dropzone_label/i });
    const file = new File(['mock content'], 'test.png', { type: 'image/png' });
    fireEvent.drop(dropzone, { dataTransfer: { files: [file] } });

    await waitFor(() => {
      expect(screen.getByText('Glowing Stone')).toBeInTheDocument();
    });

    // ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë‘ ì„ íƒë¨ (Option B: UXëŠ” 1ë‹¨ê³„ ì¶”ê°€ë¥¼ ìœ„í•´ ê¸°ë³¸ ì„ íƒ)
    const addButton = screen.getByText('Add 2 items to inventory');
    expect(addButton).not.toBeDisabled();

    // í•˜ë‚˜ í•´ì œ
    fireEvent.click(screen.getByText('Glowing Stone'));
    expect(screen.getByText('Add 1 items to inventory')).toBeInTheDocument();

    // ëª¨ë‘ í•´ì œ
    fireEvent.click(screen.getByText('Ancient Script'));
    expect(screen.getByText('Add 0 items to inventory')).toBeInTheDocument();
    expect(screen.getByText('Add 0 items to inventory')).toBeDisabled();
  });

  it('adds selected items to inventoryStore and resets state', async () => {
    vi.spyOn(scannerApi, 'scanImage').mockResolvedValue({
      success: true,
      data: mockScanResponse,
    });
    const addItemsSpy = vi.spyOn(useInventoryStore.getState(), 'addItems');

    render(<ScannerSlot language={mockLanguage} />);

    const dropzone = screen.getByRole('button', { name: /scanner.dropzone_label/i });
    const file = new File(['mock content'], 'test.png', { type: 'image/png' });
    fireEvent.drop(dropzone, { dataTransfer: { files: [file] } });

    await waitFor(() => {
      expect(screen.getByText('Add 2 items to inventory')).toBeInTheDocument();
    });

    fireEvent.click(screen.getByText('Add 2 items to inventory'));

    expect(addItemsSpy).toHaveBeenCalledWith([
      expect.objectContaining({ id: 'item-1', name: 'Glowing Stone' }),
      expect.objectContaining({ id: 'item-2', name: 'Ancient Script' }),
    ]);

    // ìƒíƒœ ë¦¬ì…‹ í™•ì¸ (idle ìƒíƒœë¡œ ë³µê·€)
    expect(screen.getByText('scanner.dropzone_text')).toBeInTheDocument();
  });

  it('displays error message on scan failure', async () => {
    vi.spyOn(scannerApi, 'scanImage').mockResolvedValue({
      success: false,
      error: 'Analysis failed due to noise',
      status: 'failed',
    });

    render(<ScannerSlot language={mockLanguage} />);

    const dropzone = screen.getByRole('button', { name: /scanner.dropzone_label/i });
    const file = new File(['mock content'], 'test.png', { type: 'image/png' });
    fireEvent.drop(dropzone, { dataTransfer: { files: [file] } });

    await waitFor(() => {
      expect(screen.getByText('Analysis failed due to noise')).toBeInTheDocument();
    });

    expect(screen.getByText('scanner.retry')).toBeInTheDocument();
  });

  it('resets state when cancel is clicked', async () => {
    vi.spyOn(scannerApi, 'scanImage').mockResolvedValue({
      success: true,
      data: mockScanResponse,
    });

    render(<ScannerSlot language={mockLanguage} />);

    const dropzone = screen.getByRole('button', { name: /scanner.dropzone_label/i });
    const file = new File(['mock content'], 'test.png', { type: 'image/png' });
    fireEvent.drop(dropzone, { dataTransfer: { files: [file] } });

    await waitFor(() => {
      expect(screen.getByText('scanner.cancel')).toBeInTheDocument();
    });

    fireEvent.click(screen.getByText('scanner.cancel'));

    // ìƒíƒœ ë¦¬ì…‹ í™•ì¸
    expect(screen.getByText('scanner.dropzone_text')).toBeInTheDocument();
  });

  it('displays correct discovery message based on item count (U-095)', async () => {
    render(<ScannerSlot language={mockLanguage} />);

    // 1ê°œ ë°œê²¬
    const singleResponse = {
      ...mockScanResponse,
      item_candidates: [mockScanResponse.item_candidates[0]],
    };
    vi.spyOn(scannerApi, 'scanImage').mockResolvedValueOnce({
      success: true,
      data: singleResponse,
    });

    let dropzone = screen.getByRole('button', { name: /scanner.dropzone_label/i });
    fireEvent.drop(dropzone, {
      dataTransfer: { files: [new File(['content'], 'test.png', { type: 'image/png' })] },
    });
    await waitFor(() =>
      expect(screen.getByText('scanner.discovery_message.one')).toBeInTheDocument(),
    );

    // 2ê°œ ë°œê²¬
    fireEvent.click(screen.getByText('scanner.cancel'));
    vi.spyOn(scannerApi, 'scanImage').mockResolvedValueOnce({
      success: true,
      data: mockScanResponse,
    });
    dropzone = screen.getByRole('button', { name: /scanner.dropzone_label/i });
    fireEvent.drop(dropzone, {
      dataTransfer: { files: [new File(['content'], 'test.png', { type: 'image/png' })] },
    });
    await waitFor(() =>
      expect(screen.getByText('scanner.discovery_message.two')).toBeInTheDocument(),
    );

    // 3ê°œ ë°œê²¬
    fireEvent.click(screen.getByText('scanner.cancel'));
    const tripleResponse = {
      ...mockScanResponse,
      item_candidates: [
        ...mockScanResponse.item_candidates,
        { id: 'item-3', label: 'Extra Item', description: 'Desc', item_type: 'tool' },
      ],
    };
    vi.spyOn(scannerApi, 'scanImage').mockResolvedValueOnce({
      success: true,
      data: tripleResponse,
    });
    dropzone = screen.getByRole('button', { name: /scanner.dropzone_label/i });
    fireEvent.drop(dropzone, {
      dataTransfer: { files: [new File(['content'], 'test.png', { type: 'image/png' })] },
    });
    await waitFor(() =>
      expect(screen.getByText('scanner.discovery_message.three')).toBeInTheDocument(),
    );
  });

  it('is disabled when isStreaming is true', () => {
    useAgentStore.setState({ isStreaming: true });
    render(<ScannerSlot language={mockLanguage} />);

    const dropzone = screen.getByRole('button', { name: /scanner.dropzone_label/i });
    expect(dropzone).toHaveClass('disabled');
  });

  describe('U-072 Scanner Semantic Guidance UX', () => {
    beforeEach(() => {
      localStorage.clear();
      vi.clearAllMocks();
    });

    it('shows tooltip on mouse enter in idle state', () => {
      render(<ScannerSlot language={mockLanguage} />);

      const container = screen.getByRole('button', {
        name: /scanner.dropzone_label/i,
      }).parentElement!;

      fireEvent.mouseEnter(container);
      expect(screen.getByText('scanner.tooltip.title')).toBeInTheDocument();
      expect(screen.getByText('scanner.tooltip.description')).toBeInTheDocument();

      fireEvent.mouseLeave(container);
      expect(screen.queryByText('scanner.tooltip.title')).not.toBeInTheDocument();
    });

    it('displays drag active affordance when dragging over', () => {
      render(<ScannerSlot language={mockLanguage} />);
      const dropzone = screen.getByRole('button', { name: /scanner.dropzone_label/i });

      fireEvent.dragOver(dropzone);
      expect(dropzone).toHaveClass('drag-over');
      expect(screen.getByText('scanner.affordance.drag_active')).toBeInTheDocument();
    });

    it('displays idle affordance hint in idle state', () => {
      render(<ScannerSlot language={mockLanguage} />);
      expect(screen.getByText('scanner.affordance.idle_hint')).toBeInTheDocument();
    });
  });
});
</file>

<file path="frontend/src/components/ScannerSlot.tsx">
/**
 * Unknown World - Scanner ìŠ¬ë¡¯ ì»´í¬ë„ŒíŠ¸ (U-022[Mvp], U-072[Mvp]).
 *
 * ì´ë¯¸ì§€ ë“œë/ì—…ë¡œë“œ â†’ ë°±ì—”ë“œ ë¶„ì„ â†’ ì•„ì´í…œ í›„ë³´ í‘œì‹œ â†’ ì¸ë²¤í† ë¦¬ ì¶”ê°€.
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - RULE-002: ì±„íŒ… UI ê¸ˆì§€, ê²Œì„ UIë¡œ í‘œì‹œ
 *   - RULE-004: ì‹¤íŒ¨ ì‹œ ì•ˆì „í•œ í´ë°± (ì—ëŸ¬ í‘œì‹œ)
 *   - PRD 6.7: Scanner ìŠ¬ë¡¯ ë©€í‹°ëª¨ë‹¬ ë°ëª¨ í•µì‹¬
 *
 * í˜ì–´ë§ ì§ˆë¬¸ ê²°ì • (U-022):
 *   - Q1: Option B - ì‚¬ìš©ì í™•ì¸ í›„ ì¸ë²¤í† ë¦¬ ì¶”ê°€ (ì˜ë„ í†µì œ)
 *
 * í˜ì–´ë§ ì§ˆë¬¸ ê²°ì • (U-072):
 *   - Q1: Option A - ë°±ì—”ë“œ(LLM)ì—ì„œ scanner_hint í”Œë˜ê·¸ ìƒì„±
 *
 * @module components/ScannerSlot
 */

import { useState, useCallback, useRef, type DragEvent, type ChangeEvent } from 'react';
import { useTranslation } from 'react-i18next';
import {
  scanImage,
  isSupportedImageFile,
  candidateToInventoryItem,
  type ScannerResponse,
  type ItemCandidate,
  ALLOWED_MIME_TYPES,
  MAX_FILE_SIZE_BYTES,
} from '../api/scanner';
import { useInventoryStore } from '../stores/inventoryStore';
import { useAgentStore } from '../stores/agentStore';
import type { Language } from '../schemas/turn';

// =============================================================================
// íƒ€ì… ì •ì˜
// =============================================================================

/** Scanner ìŠ¬ë¡¯ ìƒíƒœ */
type ScannerState = 'idle' | 'uploading' | 'analyzing' | 'result' | 'error';

/** ì»´í¬ë„ŒíŠ¸ Props */
interface ScannerSlotProps {
  /** ì„¸ì…˜ ì–¸ì–´ (SSOT) */
  language: Language;
  /** ë¹„í™œì„±í™” ì—¬ë¶€ (ìŠ¤íŠ¸ë¦¬ë° ì¤‘ ë“±) */
  disabled?: boolean;
}

// =============================================================================
// ì»´í¬ë„ŒíŠ¸
// =============================================================================

/**
 * Scanner ìŠ¬ë¡¯ ì»´í¬ë„ŒíŠ¸.
 *
 * ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸/ì—…ë¡œë“œí•˜ë©´ ë°±ì—”ë“œ Scanner APIë¥¼ í˜¸ì¶œí•˜ì—¬
 * ì•„ì´í…œ í›„ë³´ë¥¼ ì¶”ì¶œí•˜ê³ , ì‚¬ìš©ìê°€ ì„ íƒí•˜ì—¬ ì¸ë²¤í† ë¦¬ì— ì¶”ê°€í•©ë‹ˆë‹¤.
 */
export function ScannerSlot({ language, disabled = false }: ScannerSlotProps) {
  const { t } = useTranslation();
  const { addItems } = useInventoryStore();
  const { isStreaming } = useAgentStore();

  // ìƒíƒœ
  const [state, setState] = useState<ScannerState>('idle');
  const [isDragOver, setIsDragOver] = useState(false);
  const [errorMessage, setErrorMessage] = useState<string | null>(null);
  const [scanResult, setScanResult] = useState<ScannerResponse | null>(null);
  const [selectedCandidates, setSelectedCandidates] = useState<Set<string>>(new Set());
  const [previewUrl, setPreviewUrl] = useState<string | null>(null);

  // íŒŒì¼ ì…ë ¥ ref
  const fileInputRef = useRef<HTMLInputElement>(null);

  // ì‹¤ì œ ë¹„í™œì„±í™” ìƒíƒœ
  const isDisabled = disabled || isStreaming;

  const [showTooltip, setShowTooltip] = useState(false);

  // =========================================================================
  // í•¸ë“¤ëŸ¬
  // =========================================================================

  /**
   * íŒŒì¼ ì²˜ë¦¬ (ì—…ë¡œë“œ ë° ë¶„ì„).
   */
  const handleFile = useCallback(
    async (file: File) => {
      if (isDisabled) return;

      // íŒŒì¼ í˜•ì‹ ê²€ì¦
      if (!isSupportedImageFile(file)) {
        setErrorMessage(t('scanner.error.unsupported_format'));
        setState('error');
        return;
      }

      // íŒŒì¼ í¬ê¸° ê²€ì¦
      if (file.size > MAX_FILE_SIZE_BYTES) {
        setErrorMessage(t('scanner.error.file_too_large'));
        setState('error');
        return;
      }

      // í”„ë¦¬ë·° ìƒì„±
      const preview = URL.createObjectURL(file);
      setPreviewUrl(preview);

      // ìƒíƒœ ì´ˆê¸°í™”
      setErrorMessage(null);
      setScanResult(null);
      setSelectedCandidates(new Set());
      setState('uploading');

      try {
        setState('analyzing');
        const result = await scanImage(file, language);

        if (result.success) {
          setScanResult(result.data);
          // ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  í›„ë³´ë¥¼ ì„ íƒ
          const allIds = new Set(result.data.item_candidates.map((c) => c.id));
          setSelectedCandidates(allIds);
          setState('result');
        } else {
          setErrorMessage(result.error);
          setState('error');
        }
      } catch {
        setErrorMessage(t('scanner.error.unknown'));
        setState('error');
      }
    },
    [isDisabled, language, t],
  );

  /**
   * ë“œë˜ê·¸ ì˜¤ë²„ í•¸ë“¤ëŸ¬.
   */
  const handleDragOver = useCallback(
    (e: DragEvent<HTMLDivElement>) => {
      e.preventDefault();
      e.stopPropagation();
      if (!isDisabled) {
        setIsDragOver(true);
      }
    },
    [isDisabled],
  );

  /**
   * ë“œë˜ê·¸ ì¢…ë£Œ í•¸ë“¤ëŸ¬.
   */
  const handleDragLeave = useCallback((e: DragEvent<HTMLDivElement>) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDragOver(false);
  }, []);

  /**
   * ë“œë¡­ í•¸ë“¤ëŸ¬.
   */
  const handleDrop = useCallback(
    (e: DragEvent<HTMLDivElement>) => {
      e.preventDefault();
      e.stopPropagation();
      setIsDragOver(false);

      if (isDisabled) return;

      const files = e.dataTransfer.files;
      if (files.length > 0) {
        void handleFile(files[0]);
      }
    },
    [isDisabled, handleFile],
  );

  /**
   * íŒŒì¼ ì„ íƒ í•¸ë“¤ëŸ¬.
   */
  const handleFileChange = useCallback(
    (e: ChangeEvent<HTMLInputElement>) => {
      const files = e.target.files;
      if (files && files.length > 0) {
        void handleFile(files[0]);
      }
      // ì…ë ¥ ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ì¬ì„ íƒ í—ˆìš©)
      if (fileInputRef.current) {
        fileInputRef.current.value = '';
      }
    },
    [handleFile],
  );

  /**
   * íŒŒì¼ ì„ íƒ ë²„íŠ¼ í´ë¦­.
   */
  const handleBrowseClick = useCallback(() => {
    if (!isDisabled && fileInputRef.current) {
      fileInputRef.current.click();
    }
  }, [isDisabled]);

  /**
   * í›„ë³´ ì„ íƒ í† ê¸€.
   */
  const handleCandidateToggle = useCallback((candidateId: string) => {
    setSelectedCandidates((prev) => {
      const next = new Set(prev);
      if (next.has(candidateId)) {
        next.delete(candidateId);
      } else {
        next.add(candidateId);
      }
      return next;
    });
  }, []);

  /**
   * ì„ íƒí•œ ì•„ì´í…œì„ ì¸ë²¤í† ë¦¬ì— ì¶”ê°€.
   * Q1 Option B: ì‚¬ìš©ì í™•ì¸ í›„ ì¶”ê°€.
   */
  const handleAddToInventory = useCallback(() => {
    if (!scanResult || selectedCandidates.size === 0) return;

    const selectedItems = scanResult.item_candidates
      .filter((c) => selectedCandidates.has(c.id))
      .map(candidateToInventoryItem);

    addItems(selectedItems);

    // ìƒíƒœ ì´ˆê¸°í™”
    setState('idle');
    setScanResult(null);
    setSelectedCandidates(new Set());
    if (previewUrl) {
      URL.revokeObjectURL(previewUrl);
      setPreviewUrl(null);
    }
  }, [scanResult, selectedCandidates, addItems, previewUrl]);

  /**
   * ì·¨ì†Œ/ë¦¬ì…‹.
   */
  const handleReset = useCallback(() => {
    setState('idle');
    setScanResult(null);
    setSelectedCandidates(new Set());
    setErrorMessage(null);
    if (previewUrl) {
      URL.revokeObjectURL(previewUrl);
      setPreviewUrl(null);
    }
  }, [previewUrl]);

  // =========================================================================
  // ë Œë”ë§
  // =========================================================================

  return (
    <div
      className="scanner-slot-container"
      onMouseEnter={() => setShowTooltip(true)}
      onMouseLeave={() => setShowTooltip(false)}
    >
      {/* íˆ´íŒ (U-072) */}
      {showTooltip && state === 'idle' && (
        <div className="scanner-tooltip" role="tooltip">
          <div className="scanner-tooltip-title">{t('scanner.tooltip.title')}</div>
          <div className="scanner-tooltip-desc">{t('scanner.tooltip.description')}</div>
        </div>
      )}

      {/* ìˆ¨ê²¨ì§„ íŒŒì¼ ì…ë ¥ */}
      <input
        ref={fileInputRef}
        type="file"
        accept={ALLOWED_MIME_TYPES.join(',')}
        onChange={handleFileChange}
        className="visually-hidden"
        aria-label={t('scanner.upload_label')}
      />

      {/* ìƒíƒœë³„ ë Œë”ë§ */}
      {state === 'idle' && (
        <div
          className={`scanner-dropzone ${isDragOver ? 'drag-over' : ''} ${isDisabled ? 'disabled' : ''}`}
          onDragOver={handleDragOver}
          onDragLeave={handleDragLeave}
          onDrop={handleDrop}
          onClick={handleBrowseClick}
          role="button"
          tabIndex={isDisabled ? -1 : 0}
          aria-label={t('scanner.dropzone_label')}
          onKeyDown={(e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              handleBrowseClick();
            }
          }}
        >
          <div className="scanner-dropzone-icon">ğŸ“·</div>
          <div className="scanner-dropzone-text">
            {isDragOver ? t('scanner.affordance.drag_active') : t('scanner.dropzone_text')}
          </div>
          <div className={`scanner-dropzone-hint ${isDragOver ? 'hidden' : ''}`}>
            {t('scanner.dropzone_hint')}
          </div>
          {/* ì‹œê°ì  ì–´í¬ë˜ìŠ¤: idle íŒíŠ¸ (U-072) - í•­ìƒ ë Œë”ë§í•˜ì—¬ ë ˆì´ì•„ì›ƒ ì‹œí”„íŠ¸ ë°©ì§€ */}
          <div
            className={`scanner-affordance-hint ${isDragOver || isDisabled ? 'hidden' : ''}`}
            aria-hidden={isDragOver || isDisabled}
          >
            {t('scanner.affordance.idle_hint')}
          </div>
        </div>
      )}

      {(state === 'uploading' || state === 'analyzing') && (
        <div className="scanner-loading">
          {previewUrl && (
            <div className="scanner-preview">
              <img
                src={previewUrl}
                alt={t('scanner.preview_alt')}
                className="scanner-preview-img"
              />
            </div>
          )}
          <div className="scanner-loading-content">
            <div className="scanner-loading-spinner" />
            <div className="scanner-loading-text">
              {state === 'uploading' ? t('scanner.uploading') : t('scanner.analyzing')}
            </div>
          </div>
        </div>
      )}

      {state === 'error' && (
        <div className="scanner-error">
          {previewUrl && (
            <div className="scanner-preview">
              <img
                src={previewUrl}
                alt={t('scanner.preview_alt')}
                className="scanner-preview-img"
              />
            </div>
          )}
          <div className="scanner-error-content">
            <div className="scanner-error-icon">âš ï¸</div>
            <div className="scanner-error-message">{errorMessage}</div>
            <button type="button" className="scanner-btn scanner-btn-retry" onClick={handleReset}>
              {t('scanner.retry')}
            </button>
          </div>
        </div>
      )}

      {state === 'result' && scanResult && (
        <div className="scanner-result">
          {/* U-095: ë‹¤ìˆ˜ ì•„ì´í…œ ë°œê²¬ í”¼ë“œë°± ë©”ì‹œì§€ */}
          <div className="scanner-discovery-message" role="status">
            {getDiscoveryMessage(scanResult.item_candidates.length, t)}
          </div>

          {/* í”„ë¦¬ë·° + ìº¡ì…˜ */}
          <div className="scanner-result-header">
            {previewUrl && (
              <div className="scanner-preview-small">
                <img
                  src={previewUrl}
                  alt={t('scanner.preview_alt')}
                  className="scanner-preview-img-small"
                />
              </div>
            )}
            <div className="scanner-result-info">
              <div className="scanner-caption">{scanResult.caption}</div>
              <div className="scanner-stats">
                {t('scanner.detected_objects', { count: scanResult.objects.length })} â€¢{' '}
                {t('scanner.item_candidates', { count: scanResult.item_candidates.length })}
              </div>
            </div>
          </div>

          {/* ì•„ì´í…œ í›„ë³´ ëª©ë¡ */}
          {scanResult.item_candidates.length > 0 ? (
            <div className="scanner-candidates">
              <div className="scanner-candidates-title">{t('scanner.select_items')}</div>
              <div className="scanner-candidates-list">
                {scanResult.item_candidates.map((candidate) => (
                  <CandidateItem
                    key={candidate.id}
                    candidate={candidate}
                    selected={selectedCandidates.has(candidate.id)}
                    onToggle={() => handleCandidateToggle(candidate.id)}
                  />
                ))}
              </div>
            </div>
          ) : (
            <div className="scanner-no-candidates">{t('scanner.no_candidates')}</div>
          )}

          {/* ì•¡ì…˜ ë²„íŠ¼ */}
          <div className="scanner-actions">
            <button type="button" className="scanner-btn scanner-btn-cancel" onClick={handleReset}>
              {t('scanner.cancel')}
            </button>
            <button
              type="button"
              className="scanner-btn scanner-btn-add"
              onClick={handleAddToInventory}
              disabled={selectedCandidates.size === 0}
            >
              {t('scanner.add_to_inventory', { count: selectedCandidates.size })}
            </button>
          </div>
        </div>
      )}
    </div>
  );
}

// =============================================================================
// ì„œë¸Œ ì»´í¬ë„ŒíŠ¸
// =============================================================================

interface CandidateItemProps {
  candidate: ItemCandidate;
  selected: boolean;
  onToggle: () => void;
}

/**
 * ì•„ì´í…œ í›„ë³´ ì»´í¬ë„ŒíŠ¸.
 */
function CandidateItem({ candidate, selected, onToggle }: CandidateItemProps) {
  const { t } = useTranslation();

  // ì•„ì´í…œ íƒ€ì…ì— ë”°ë¥¸ ì´ëª¨ì§€
  const emoji = getItemTypeEmoji(candidate.item_type);

  return (
    <button
      type="button"
      className={`scanner-candidate ${selected ? 'selected' : ''}`}
      onClick={onToggle}
      aria-pressed={selected}
    >
      <span className="scanner-candidate-checkbox">{selected ? 'â˜‘' : 'â˜'}</span>
      <span className="scanner-candidate-icon">{emoji}</span>
      <span className="scanner-candidate-info">
        <span className="scanner-candidate-name">{candidate.label}</span>
        {candidate.description && (
          <span className="scanner-candidate-desc">{candidate.description}</span>
        )}
        <span className="scanner-candidate-type">
          {t(`scanner.item_type.${candidate.item_type}`, { defaultValue: candidate.item_type })}
        </span>
      </span>
    </button>
  );
}

// =============================================================================
// ìœ í‹¸ë¦¬í‹°
// =============================================================================

function getItemTypeEmoji(itemType: string): string {
  const emojiMap: Record<string, string> = {
    key: 'ğŸ”‘',
    weapon: 'âš”ï¸',
    tool: 'ğŸ”§',
    clue: 'ğŸ”',
    material: 'ğŸ“¦',
    consumable: 'ğŸ’Š',
    document: 'ğŸ“„',
    artifact: 'ğŸ’',
  };
  return emojiMap[itemType] ?? 'ğŸ“¦';
}

/**
 * ì•„ì´í…œ ë°œê²¬ ê°œìˆ˜ì— ë”°ë¥¸ í”¼ë“œë°± ë©”ì‹œì§€ (U-095).
 *
 * @param count - ë°œê²¬ëœ ì•„ì´í…œ ìˆ˜
 * @param t - i18n ë²ˆì—­ í•¨ìˆ˜
 * @returns í”¼ë“œë°± ë©”ì‹œì§€
 */
function getDiscoveryMessage(count: number, t: (key: string) => string): string {
  if (count >= 3) return t('scanner.discovery_message.three');
  if (count === 2) return t('scanner.discovery_message.two');
  return t('scanner.discovery_message.one');
}
</file>

<file path="frontend/src/data/demoProfiles.ts">
/**
 * Unknown World - ë°ëª¨ í”„ë¡œí•„ ì •ì˜ (U-015[Mvp], U-116[Mvp]).
 *
 * ë¡œê·¸ì¸ ì—†ì´ ì¦‰ì‹œ ì‹œì‘ ê°€ëŠ¥í•œ ë°ëª¨ í”„ë¡œí•„ 3ì¢…ì„ ì •ì˜í•©ë‹ˆë‹¤.
 * ê° í”„ë¡œí•„ì€ ì„œë¡œ ë‹¤ë¥¸ ì´ˆê¸° ìƒíƒœ(ì¬í™”/ì¸ë²¤í† ë¦¬/í€˜ìŠ¤íŠ¸/ë£°)ë¥¼ ê°€ì§‘ë‹ˆë‹¤.
 *
 * U-116: SaveGame ì¤‘ê°„ ë‹¨ê³„ ì œê±°. í”„ë¡œí•„ ë°ì´í„°ëŠ” sessionLifecycleì—ì„œ
 * storeì— ì§ì ‘ ì ìš©ë©ë‹ˆë‹¤.
 *
 * í”„ë¡œí•„:
 *   1. Narrator: ë‚´ëŸ¬í‹°ë¸Œ/ìŠ¤í† ë¦¬ ì¤‘ì‹¬ ì²´í—˜
 *   2. Explorer: íƒìƒ‰/ë°œê²¬ ì¤‘ì‹¬ ì²´í—˜
 *   3. Tech Enthusiast: ì‹œìŠ¤í…œ/ë©”ì»¤ë‹‰ ì¤‘ì‹¬ ì²´í—˜
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - RULE-006: í‘œì‹œ ë¬¸ìì—´ì€ i18n í‚¤ ê¸°ë°˜
 *   - PRD 6.9: ë°ëª¨ í”„ë¡œí•„ 3ì¢… + ì¦‰ì‹œ ë¦¬ì…‹
 *
 * @module data/demoProfiles
 */

// =============================================================================
// í”„ë¡œí•„ íƒ€ì… ì •ì˜
// =============================================================================

/**
 * ë°ëª¨ í”„ë¡œí•„ ì •ì˜ (ì–¸ì–´ ì¤‘ë¦½).
 * í‘œì‹œìš© ë¬¸ìì—´ì€ i18n í‚¤ë¡œ ì°¸ì¡°í•©ë‹ˆë‹¤.
 */
export interface DemoProfileDef {
  /** í”„ë¡œí•„ ê³ ìœ  ID */
  id: string;
  /** í”„ë¡œí•„ ì´ë¦„ i18n í‚¤ */
  nameKey: string;
  /** í”„ë¡œí•„ ì„¤ëª… i18n í‚¤ */
  descriptionKey: string;
  /** í”„ë¡œí•„ ì•„ì´ì½˜ (ì´ëª¨ì§€) */
  icon: string;
  /** í”„ë¡œí•„ í…Œë§ˆ ìƒ‰ìƒ (CSS ë³€ìˆ˜ëª… ë˜ëŠ” hex) */
  themeColor: string;
}

/**
 * í”„ë¡œí•„ ì´ˆê¸° ìƒíƒœ.
 * sessionLifecycleì—ì„œ storeì— ì§ì ‘ ì ìš©ë©ë‹ˆë‹¤.
 */
export interface DemoProfileInitialState {
  /** ì´ˆê¸° ì¬í™” */
  economy: {
    signal: number;
    memory_shard: number;
    credit: number;
  };
  /** ì´ˆê¸° ì¸ë²¤í† ë¦¬ ì•„ì´í…œ ì •ì˜ (IDì™€ i18n í‚¤) */
  inventoryDefs: Array<{
    id: string;
    nameKey: string;
    icon: string;
    quantity: number;
  }>;
  /** ì´ˆê¸° í€˜ìŠ¤íŠ¸ ì •ì˜ (U-078: ëª©í‘œ ì‹œìŠ¤í…œ ê°•í™”) */
  questDefs: Array<{
    id: string;
    labelKey: string;
    is_completed: boolean;
    descriptionKey?: string;
    is_main?: boolean;
    progress?: number;
    reward_signal?: number;
  }>;
  /** ì´ˆê¸° ê·œì¹™ ì •ì˜ */
  ruleDefs: Array<{
    id: string;
    labelKey: string;
    descriptionKey?: string;
  }>;
  /** ì´ˆê¸° Scene Objects ì •ì˜ */
  sceneObjectDefs: Array<{
    id: string;
    labelKey: string;
    hintKey: string;
    box_2d: {
      ymin: number;
      xmin: number;
      ymax: number;
      xmax: number;
    };
  }>;
  /** í™˜ì˜ ë©”ì‹œì§€ i18n í‚¤ */
  welcomeMessageKey: string;
}

/**
 * ë°ëª¨ í”„ë¡œí•„ ì „ì²´ ì •ì˜.
 */
export interface DemoProfile extends DemoProfileDef {
  initialState: DemoProfileInitialState;
}

// =============================================================================
// ë°ëª¨ í”„ë¡œí•„ ì •ì˜ (3ì¢…)
// =============================================================================

/**
 * Narrator í”„ë¡œí•„: ë‚´ëŸ¬í‹°ë¸Œ/ìŠ¤í† ë¦¬ ì¤‘ì‹¬ ì²´í—˜.
 * í’ë¶€í•œ ì¬í™”ë¡œ ë‹¤ì–‘í•œ ì„ íƒì§€ë¥¼ íƒìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
 */
export const PROFILE_NARRATOR: DemoProfile = {
  id: 'narrator',
  nameKey: 'profile.narrator.name',
  descriptionKey: 'profile.narrator.description',
  icon: 'ğŸ“–',
  themeColor: 'var(--accent-color)',
  initialState: {
    economy: {
      signal: 200,
      memory_shard: 10,
      credit: 0,
    },
    inventoryDefs: [
      {
        id: 'ancient-tome',
        nameKey: 'profile.narrator.items.ancient_tome',
        icon: 'ğŸ“•',
        quantity: 1,
      },
      { id: 'quill-pen', nameKey: 'profile.narrator.items.quill_pen', icon: 'ğŸ–‹ï¸', quantity: 1 },
      {
        id: 'memory-fragment',
        nameKey: 'profile.narrator.items.memory_fragment',
        icon: 'ğŸ’ ',
        quantity: 3,
      },
    ],
    questDefs: [
      {
        id: 'quest-discover-origin',
        labelKey: 'profile.narrator.quest.discover_origin',
        descriptionKey: 'profile.narrator.quest.discover_origin_desc',
        is_completed: false,
        is_main: true,
        progress: 0,
        reward_signal: 50,
      },
      {
        id: 'quest-collect-memories',
        labelKey: 'profile.narrator.quest.collect_memories',
        is_completed: false,
        reward_signal: 15,
      },
      {
        id: 'quest-read-ancient-tome',
        labelKey: 'profile.narrator.quest.read_ancient_tome',
        is_completed: false,
        reward_signal: 10,
      },
    ],
    ruleDefs: [
      {
        id: 'rule-time-flows',
        labelKey: 'profile.narrator.rule.time_flows',
        descriptionKey: 'profile.narrator.rule.time_flows_desc',
      },
      {
        id: 'rule-memories-persist',
        labelKey: 'profile.narrator.rule.memories_persist',
        descriptionKey: 'profile.narrator.rule.memories_persist_desc',
      },
    ],
    // U-116: ì´ˆê¸° í•«ìŠ¤íŒŸ ì œê±° (U-090 ì •ë°€ë¶„ì„ ì „ìš© ì •ì±… ì¤€ìˆ˜)
    sceneObjectDefs: [],
    welcomeMessageKey: 'profile.narrator.welcome',
  },
};

/**
 * Explorer í”„ë¡œí•„: íƒìƒ‰/ë°œê²¬ ì¤‘ì‹¬ ì²´í—˜.
 * ì ë‹¹í•œ ì¬í™”ì™€ íƒìƒ‰ ë„êµ¬ë¡œ ìƒˆë¡œìš´ ì˜ì—­ì„ ë°œê²¬í•©ë‹ˆë‹¤.
 */
export const PROFILE_EXPLORER: DemoProfile = {
  id: 'explorer',
  nameKey: 'profile.explorer.name',
  descriptionKey: 'profile.explorer.description',
  icon: 'ğŸ§­',
  themeColor: 'var(--text-color)',
  initialState: {
    economy: {
      signal: 150,
      memory_shard: 5,
      credit: 0,
    },
    inventoryDefs: [
      { id: 'compass', nameKey: 'profile.explorer.items.compass', icon: 'ğŸ§­', quantity: 1 },
      { id: 'rope', nameKey: 'profile.explorer.items.rope', icon: 'ğŸª¢', quantity: 2 },
      { id: 'lantern', nameKey: 'profile.explorer.items.lantern', icon: 'ğŸ®', quantity: 1 },
      {
        id: 'map-fragment',
        nameKey: 'profile.explorer.items.map_fragment',
        icon: 'ğŸ—ºï¸',
        quantity: 1,
      },
    ],
    questDefs: [
      {
        id: 'quest-find-exit',
        labelKey: 'profile.explorer.quest.find_exit',
        descriptionKey: 'profile.explorer.quest.find_exit_desc',
        is_completed: false,
        is_main: true,
        progress: 15,
        reward_signal: 50,
      },
      {
        id: 'quest-explore-areas',
        labelKey: 'profile.explorer.quest.explore_areas',
        is_completed: false,
        reward_signal: 20,
      },
      {
        id: 'quest-gather-supplies',
        labelKey: 'profile.explorer.quest.gather_supplies',
        is_completed: true,
        reward_signal: 10,
      },
    ],
    ruleDefs: [
      {
        id: 'rule-gravity',
        labelKey: 'profile.explorer.rule.gravity',
        descriptionKey: 'profile.explorer.rule.gravity_desc',
      },
      {
        id: 'rule-darkness',
        labelKey: 'profile.explorer.rule.darkness',
        descriptionKey: 'profile.explorer.rule.darkness_desc',
      },
    ],
    // U-116: ì´ˆê¸° í•«ìŠ¤íŒŸ ì œê±° (U-090 ì •ë°€ë¶„ì„ ì „ìš© ì •ì±… ì¤€ìˆ˜)
    sceneObjectDefs: [],
    welcomeMessageKey: 'profile.explorer.welcome',
  },
};

/**
 * Tech Enthusiast í”„ë¡œí•„: ì‹œìŠ¤í…œ/ë©”ì»¤ë‹‰ ì¤‘ì‹¬ ì²´í—˜.
 * ì œí•œëœ ì¬í™”ë¡œ íš¨ìœ¨ì ì¸ ì „ëµì„ ì„¸ì›Œì•¼ í•©ë‹ˆë‹¤.
 */
export const PROFILE_TECH: DemoProfile = {
  id: 'tech',
  nameKey: 'profile.tech.name',
  descriptionKey: 'profile.tech.description',
  icon: 'âš™ï¸',
  themeColor: 'var(--warning-color)',
  initialState: {
    economy: {
      signal: 80,
      memory_shard: 15,
      credit: 0,
    },
    inventoryDefs: [
      { id: 'data-core', nameKey: 'profile.tech.items.data_core', icon: 'ğŸ’¿', quantity: 1 },
      { id: 'circuit-board', nameKey: 'profile.tech.items.circuit_board', icon: 'ğŸ”Œ', quantity: 2 },
      { id: 'energy-cell', nameKey: 'profile.tech.items.energy_cell', icon: 'ğŸ”‹', quantity: 3 },
      { id: 'scanner-device', nameKey: 'profile.tech.items.scanner', icon: 'ğŸ“¡', quantity: 1 },
    ],
    questDefs: [
      {
        id: 'quest-analyze-system',
        labelKey: 'profile.tech.quest.analyze_system',
        descriptionKey: 'profile.tech.quest.analyze_system_desc',
        is_completed: false,
        is_main: true,
        progress: 0,
        reward_signal: 40,
      },
      {
        id: 'quest-optimize-resources',
        labelKey: 'profile.tech.quest.optimize_resources',
        is_completed: false,
        reward_signal: 15,
      },
      {
        id: 'quest-scan-terminal',
        labelKey: 'profile.tech.quest.scan_terminal',
        is_completed: false,
        reward_signal: 10,
      },
    ],
    ruleDefs: [
      {
        id: 'rule-energy-conservation',
        labelKey: 'profile.tech.rule.energy_conservation',
        descriptionKey: 'profile.tech.rule.energy_conservation_desc',
      },
      {
        id: 'rule-data-integrity',
        labelKey: 'profile.tech.rule.data_integrity',
        descriptionKey: 'profile.tech.rule.data_integrity_desc',
      },
      {
        id: 'rule-system-limits',
        labelKey: 'profile.tech.rule.system_limits',
        descriptionKey: 'profile.tech.rule.system_limits_desc',
      },
    ],
    // U-116: ì´ˆê¸° í•«ìŠ¤íŒŸ ì œê±° (U-090 ì •ë°€ë¶„ì„ ì „ìš© ì •ì±… ì¤€ìˆ˜)
    sceneObjectDefs: [],
    welcomeMessageKey: 'profile.tech.welcome',
  },
};

/**
 * ëª¨ë“  ë°ëª¨ í”„ë¡œí•„ ëª©ë¡.
 */
export const DEMO_PROFILES: readonly DemoProfile[] = [
  PROFILE_NARRATOR,
  PROFILE_EXPLORER,
  PROFILE_TECH,
] as const;

/**
 * í”„ë¡œí•„ IDë¡œ í”„ë¡œí•„ì„ ì°¾ìŠµë‹ˆë‹¤.
 */
export function findProfileById(profileId: string): DemoProfile | undefined {
  return DEMO_PROFILES.find((p) => p.id === profileId);
}

/**
 * í”„ë¡œí•„ ëª©ë¡ ì •ë³´ë§Œ ê°€ì ¸ì˜µë‹ˆë‹¤ (ì„ íƒ UIìš©).
 */
export function getProfileSummaries(): Array<DemoProfileDef> {
  return DEMO_PROFILES.map((p) => ({
    id: p.id,
    nameKey: p.nameKey,
    descriptionKey: p.descriptionKey,
    icon: p.icon,
    themeColor: p.themeColor,
  }));
}
</file>

<file path="frontend/src/save/constants.ts">
/**
 * Unknown World - ì„¸ì…˜/ê²½ì œ ê´€ë ¨ ìƒìˆ˜ SSOT (U-116[Mvp]).
 *
 * U-116: SaveGame ì‹œìŠ¤í…œ ì œê±° í›„ ì •ë¦¬.
 * - SaveGame ë²„ì „/ë§ˆì´ê·¸ë ˆì´ì…˜ ê´€ë ¨ ìƒìˆ˜ ì œê±°
 * - ì–¸ì–´ ì„¤ì • ì˜ì†í™”ìš© í‚¤ ì¶”ê°€
 * - ê²½ì œ/íŒë§¤ ì •ì±… ìƒìˆ˜ ìœ ì§€
 *
 * @module save/constants
 */

// =============================================================================
// localStorage í‚¤ (Storage Keys)
// =============================================================================

/**
 * ì–¸ì–´ ì„¤ì • ì €ì¥ í‚¤ (U-116: Q1 Option B).
 *
 * SaveGame ì œê±° í›„ì—ë„ ì–¸ì–´ ì„¤ì •ë§Œì€ ìœ ì§€í•©ë‹ˆë‹¤.
 * í”„ë¡œí•„ ì„ íƒ ì‹œ ì´ì „ ì–¸ì–´ë¡œ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
 */
export const LANGUAGE_STORAGE_KEY = 'unknown_world_language' as const;

// =============================================================================
// Legacy localStorage í‚¤ (ë¶€íŒ… ì‹œ ì •ë¦¬ ëŒ€ìƒ)
// =============================================================================

/**
 * ë ˆê±°ì‹œ SaveGame ì €ì¥ í‚¤.
 * U-116ì—ì„œ SaveGame ì œê±° í›„, ê¸°ì¡´ ì‚¬ìš©ì ë¸Œë¼ìš°ì €ì— ë‚¨ì•„ìˆëŠ” ë°ì´í„°ë¥¼ ì •ë¦¬í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
 */
export const LEGACY_SAVEGAME_STORAGE_KEY = 'unknown_world_savegame' as const;

/**
 * ë ˆê±°ì‹œ í”„ë¡œí•„ ID ì €ì¥ í‚¤.
 * U-116ì—ì„œ SaveGame ì œê±° í›„, ê¸°ì¡´ ì‚¬ìš©ì ë¸Œë¼ìš°ì €ì— ë‚¨ì•„ìˆëŠ” ë°ì´í„°ë¥¼ ì •ë¦¬í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
 */
export const LEGACY_PROFILE_STORAGE_KEY = 'unknown_world_current_profile' as const;

// =============================================================================
// Seed ìƒì„± ì •ì±…
// =============================================================================

/**
 * ë°ëª¨ seed ì ‘ë‘ì‚¬.
 *
 * ë°ëª¨ í”„ë¡œí•„ì—ì„œ ìƒì„±ë˜ëŠ” seedì˜ ì ‘ë‘ì‚¬ì…ë‹ˆë‹¤.
 * seed í˜•ì‹: `{DEMO_SEED_PREFIX}-{profileId}-{timestamp}`
 *
 * @example 'demo-narrator-1706000000000'
 */
export const DEMO_SEED_PREFIX = 'demo' as const;

/**
 * Seedë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
 *
 * í˜„ì¬ ì •ì±…(now ê¸°ë°˜)ì— ë”°ë¼ seed ë¬¸ìì—´ì„ ìƒì„±í•©ë‹ˆë‹¤.
 *
 * @param profileId - í”„ë¡œí•„ ID
 * @returns seed ë¬¸ìì—´
 */
export function generateDemoSeed(profileId: string): string {
  const now = Date.now();
  return `${DEMO_SEED_PREFIX}-${profileId}-${now}`;
}

// =============================================================================
// Economy ì •ì±… ìƒìˆ˜
// =============================================================================

/**
 * ì”ì•¡ ë¶€ì¡± ê²½ê³  ì„ê³„ê°’ (Signal ê¸°ì¤€).
 *
 * Signal ì”ì•¡ì´ ì´ ê°’ ë¯¸ë§Œì´ë©´ isBalanceLowê°€ trueê°€ ë©ë‹ˆë‹¤.
 * HUDì—ì„œ ê²½ê³  í‘œì‹œ ë° ëŒ€ì²´ í–‰ë™ ì œì•ˆì— ì‚¬ìš©ë©ë‹ˆë‹¤.
 *
 * @see economyStore.ts#updateBalanceLowStatus
 */
export const LOW_BALANCE_THRESHOLD = 10 as const;

/**
 * ê±°ë˜ ì¥ë¶€(Ledger) ìµœëŒ€ ë³´ê´€ ê°œìˆ˜.
 * ìµœê·¼ Nê°œì˜ í„´ ê±°ë˜ ì¥ë¶€ë§Œ ë³´ê´€í•©ë‹ˆë‹¤ (ë©”ëª¨ë¦¬ ìµœì í™”).
 * @see economyStore.ts#addLedgerEntry
 */
export const LEDGER_MAX_ENTRIES = 20 as const;

// =============================================================================
// U-079: ì•„ì´í…œ íŒë§¤ ì •ì±…
// =============================================================================

/**
 * ì•„ì´í…œ íŒë§¤ ê¸°ë³¸ ê°€ê²© (Signal).
 *
 * MVPì—ì„œëŠ” ëª¨ë“  ì•„ì´í…œì˜ íŒë§¤ ê°€ê²©ì´ ê³ ì •ì…ë‹ˆë‹¤.
 * í–¥í›„ ì•„ì´í…œë³„ ê°€ê²© ì°¨ë“±í™”ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
 *
 * @see InventoryPanel.tsx - íŒë§¤ ë²„íŠ¼
 */
export const ITEM_SELL_PRICE_SIGNAL = 5 as const;

// =============================================================================
// ì´ˆê¸°ê°’ ì •ì±… (Placeholder vs ì£¼ì…)
// =============================================================================

/**
 * World/Economy ì´ˆê¸°ê°’ ì •ì±… (ë¬¸ì„œí™”ìš© ì£¼ì„).
 *
 * Storeì˜ createInitialState()ì—ì„œ ì •ì˜í•˜ëŠ” economy ë“±ì˜ ê°’ì€
 * **"í”Œë ˆì´ ì „ placeholder"**ë¡œ ì·¨ê¸‰í•©ë‹ˆë‹¤.
 *
 * ì‹¤ì œ ê²Œì„ ì‹œì‘ ê°’ì€ í•­ìƒ startSessionFromProfile()ì—ì„œ ì£¼ì…ë©ë‹ˆë‹¤.
 *
 * @see worldStore.ts#createInitialState
 * @see sessionLifecycle.ts
 */
export const INITIAL_VALUE_POLICY = {
  description: 'Placeholder values for pre-play state',
  worldEconomy: {
    signal: 100,
    memory_shard: 5,
  },
} as const;

// =============================================================================
// ë°ëª¨ í”„ë¡œí•„ ê¸°ë³¸ ì¬í™” ë²”ìœ„ (ì°¸ê³ ìš©)
// =============================================================================

/**
 * ë°ëª¨ í”„ë¡œí•„ ì¬í™” ë²”ìœ„ ì°¸ê³  (ë¬¸ì„œí™”ìš©).
 *
 * ê° í”„ë¡œí•„ì˜ ì´ˆê¸° ì¬í™”ëŠ” demoProfiles.tsì—ì„œ ì§ì ‘ ì •ì˜í•©ë‹ˆë‹¤.
 * ì´ ìƒìˆ˜ëŠ” "ì •ì±… ë²”ìœ„"ë¥¼ ë¬¸ì„œí™”í•˜ê¸° ìœ„í•œ ì°¸ê³ ìš©ì…ë‹ˆë‹¤.
 *
 * - Narrator: í’ë¶€í•œ ì¬í™” (ë‹¤ì–‘í•œ ì„ íƒì§€ íƒìƒ‰)
 * - Explorer: ì ë‹¹í•œ ì¬í™” (ê· í˜• ì¡íŒ í”Œë ˆì´)
 * - Tech: ì œí•œëœ ì¬í™” (íš¨ìœ¨ì  ì „ëµ í•„ìš”)
 *
 * @see demoProfiles.ts
 */
export const DEMO_PROFILE_ECONOMY_REFERENCE = {
  narrator: { signal: 200, memory_shard: 10 },
  explorer: { signal: 150, memory_shard: 5 },
  tech: { signal: 80, memory_shard: 15 },
} as const;
</file>

<file path="frontend/src/save/sessionLifecycle.ts">
/**
 * Unknown World - ì„¸ì…˜ ë¼ì´í”„ì‚¬ì´í´ ê´€ë¦¬ ëª¨ë“ˆ (U-116[Mvp]).
 *
 * U-116: SaveGame ì œê±° í›„ ë‹¨ìˆœí™”ëœ ì„¸ì…˜ ê´€ë¦¬.
 * ìƒˆë¡œê³ ì¹¨ ì‹œ í•­ìƒ í”„ë¡œí•„ ì„ íƒ í™”ë©´ìœ¼ë¡œ ë³µê·€í•©ë‹ˆë‹¤.
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - RULE-005: Economy ì¸ë°”ë¦¬ì–¸íŠ¸ (ì”ì•¡ ìŒìˆ˜ ê¸ˆì§€)
 *   - RULE-006: ko/en i18n ì •ì±… ì¤€ìˆ˜ (ì–¸ì–´ ì ìš© í›„ UI ë Œë”ë§)
 *   - U-116: SaveGame ì—†ì´ store ì§ì ‘ ì£¼ì…
 *   - U-116-Q1 Option B: ì–¸ì–´ ì„¤ì •ë§Œ LocalStorageì— ìœ ì§€
 *   - U-116-Q2 Option A: SaveGame ì½”ë“œ ì™„ì „ ì‚­ì œ
 *
 * @module save/sessionLifecycle
 */

import { clearLegacySaveData } from './saveGame';
import { LANGUAGE_STORAGE_KEY } from './constants';
import { findProfileById, type DemoProfile } from '../data/demoProfiles';
import {
  getResolvedLanguage,
  changeLanguage,
  type SupportedLanguage,
  DEFAULT_LANGUAGE,
} from '../i18n';
import { useWorldStore } from '../stores/worldStore';
import { useInventoryStore } from '../stores/inventoryStore';
import { useEconomyStore } from '../stores/economyStore';
import { useActionDeckStore } from '../stores/actionDeckStore';
import { useAgentStore } from '../stores/agentStore';
// U-092: í”„ë¦¬ì…‹ ì•„ì´ì½˜ ë ˆì§€ìŠ¤íŠ¸ë¦¬
import { getPresetIconUrl } from '../data/itemIconPresets';

// =============================================================================
// íƒ€ì… ì •ì˜
// =============================================================================

/**
 * ë¶€íŒ… ê²°ê³¼ íƒ€ì….
 * U-116: í•­ìƒ profile_selectë¡œ ì‹œì‘í•©ë‹ˆë‹¤.
 */
export type SessionBootstrap = { phase: 'profile_select' };

/**
 * ì„¸ì…˜ ì‹œì‘ ê²°ê³¼ íƒ€ì….
 */
export interface SessionStartResult {
  success: true;
  profileId: string;
}

/**
 * ì„¸ì…˜ ë¦¬ì…‹ ê²°ê³¼ íƒ€ì….
 */
export interface SessionResetResult {
  success: boolean;
  profileId: string | null;
}

// =============================================================================
// ë‚´ë¶€ í—¬í¼: ëª¨ë“  ì„¸ì…˜ ê´€ë ¨ storeë¥¼ ì´ˆê¸°í™”
// =============================================================================

/**
 * ëª¨ë“  ì„¸ì…˜ ê´€ë ¨ storeë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
 *
 * ì„¸ì…˜ ê²½ê³„ì—ì„œ í•­ìƒ ì´ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ì´ì „ ì„¸ì…˜ ì”ì¬ë¥¼ ì™„ì „íˆ ì œê±°í•©ë‹ˆë‹¤.
 */
function resetAllSessionStores(): void {
  useWorldStore.getState().reset();
  useInventoryStore.getState().reset();
  useEconomyStore.getState().reset();
  useActionDeckStore.getState().reset();
  useAgentStore.getState().reset();
}

// =============================================================================
// ì„¸ì…˜ ë¼ì´í”„ì‚¬ì´í´ API
// =============================================================================

/**
 * ë¶€íŒ… ì‹œ ì„¸ì…˜ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ì‹œì‘ phaseë¥¼ ê²°ì •í•©ë‹ˆë‹¤.
 *
 * U-116: í•­ìƒ profile_selectë¡œ ì‹œì‘í•©ë‹ˆë‹¤.
 * ê¸°ì¡´ LocalStorageì˜ ë ˆê±°ì‹œ SaveGame ë°ì´í„°ë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤.
 *
 * @returns SessionBootstrap - í•­ìƒ { phase: 'profile_select' }
 */
export function bootstrapSession(): SessionBootstrap {
  // U-116: ê¸°ì¡´ SaveGame ë ˆê±°ì‹œ ë°ì´í„° ì •ë¦¬ (1íšŒ)
  clearLegacySaveData();

  return { phase: 'profile_select' };
}

/**
 * í”„ë¡œí•„ì„ ì„ íƒí•˜ê³  ìƒˆ ì„¸ì…˜ì„ ì‹œì‘í•©ë‹ˆë‹¤.
 *
 * U-116: SaveGame ì—†ì´ í”„ë¡œí•„ ë°ì´í„°ë¥¼ storeì— ì§ì ‘ ì ìš©í•©ë‹ˆë‹¤.
 *
 * @param args.profile - ì„ íƒí•œ ë°ëª¨ í”„ë¡œí•„
 * @param args.t - i18n ë²ˆì—­ í•¨ìˆ˜
 * @param args.language - ì„¸ì…˜ ì–¸ì–´ (ëª…ì‹œì  ì „ë‹¬ë¡œ SSOT ìœ ì§€)
 * @returns ì„¸ì…˜ ì‹œì‘ ê²°ê³¼
 */
export function startSessionFromProfile(args: {
  profile: DemoProfile;
  t: (key: string) => string;
  language?: SupportedLanguage;
}): SessionStartResult {
  const { profile, t, language: explicitLanguage } = args;

  // U-044: ëª…ì‹œì  ì–¸ì–´ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ i18n í˜„ì¬ ê°’ ì‚¬ìš©
  const language = explicitLanguage ?? getResolvedLanguage();

  // ëª¨ë“  ì„¸ì…˜ store ì´ˆê¸°í™” (ì´ì „ ì„¸ì…˜ ì”ì¬ ì œê±°)
  resetAllSessionStores();

  // U-116: í”„ë¡œí•„ ë°ì´í„°ë¥¼ storeì— ì§ì ‘ ì ìš© (SaveGame ì¤‘ê°„ ë‹¨ê³„ ì œê±°)
  const now = Date.now();

  useWorldStore.setState({
    economy: {
      signal: profile.initialState.economy.signal,
      memory_shard: profile.initialState.economy.memory_shard,
      credit: profile.initialState.economy.credit,
    },
    turnCount: 0,
    narrativeEntries: [
      {
        turn: 0,
        text: t(profile.initialState.welcomeMessageKey),
        type: 'narrative' as const,
      },
    ],
    // U-078: ëª©í‘œ ì‹œìŠ¤í…œ ê°•í™”
    quests: profile.initialState.questDefs.map((quest) => ({
      id: quest.id,
      label: t(quest.labelKey),
      is_completed: quest.is_completed,
      description: quest.descriptionKey ? t(quest.descriptionKey) : null,
      is_main: quest.is_main ?? false,
      progress: quest.progress ?? 0,
      reward_signal: quest.reward_signal ?? 0,
    })),
    activeRules: profile.initialState.ruleDefs.map((rule) => ({
      id: rule.id,
      label: t(rule.labelKey),
      description: rule.descriptionKey ? t(rule.descriptionKey) : null,
    })),
    mutationTimeline: profile.initialState.ruleDefs.map((rule, index) => ({
      turn: 0,
      ruleId: rule.id,
      type: 'added' as const,
      label: t(rule.labelKey),
      description: rule.descriptionKey ? t(rule.descriptionKey) : undefined,
      timestamp: now - index * 1000,
    })),
    // U-116: sceneObjectDefsì—ì„œ ë³€í™˜ (5ë‹¨ê³„ì—ì„œ ë¹ˆ ë°°ì—´ë¡œ ë³€ê²½ë¨)
    sceneObjects: profile.initialState.sceneObjectDefs.map((obj) => ({
      id: obj.id,
      label: t(obj.labelKey),
      box_2d: obj.box_2d,
      interaction_hint: t(obj.hintKey),
    })),
  });

  // U-092: í”„ë¦¬ì…‹ ì•„ì´ì½˜ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì ìš©
  useInventoryStore.getState().setItems(
    profile.initialState.inventoryDefs.map((item) => ({
      id: item.id,
      name: t(item.nameKey),
      icon: getPresetIconUrl(item.id) ?? item.icon,
      quantity: item.quantity,
    })),
  );

  // ì–¸ì–´ ì„¤ì • ì €ì¥ (Q1 Option B: ì–¸ì–´ë§Œ ìœ ì§€)
  try {
    localStorage.setItem(LANGUAGE_STORAGE_KEY, language);
  } catch {
    // ì‹œí¬ë¦¿ ëª¨ë“œ ë“±ì—ì„œ ì‹¤íŒ¨ ê°€ëŠ¥ - ë¬´ì‹œ
  }

  return {
    success: true,
    profileId: profile.id,
  };
}

/**
 * í˜„ì¬ í”„ë¡œí•„ì˜ ì´ˆê¸° ìƒíƒœë¡œ ë¦¬ì…‹í•©ë‹ˆë‹¤.
 *
 * U-116: ë™ì¼ í”„ë¡œí•„ë¡œ ìƒˆ ì„¸ì…˜ì„ ì‹œì‘í•©ë‹ˆë‹¤.
 *
 * @param args.t - i18n ë²ˆì—­ í•¨ìˆ˜
 * @param args.currentProfileId - í˜„ì¬ í”„ë¡œí•„ ID
 * @returns ë¦¬ì…‹ ì„±ê³µ ì—¬ë¶€
 */
export function resetToCurrentProfile(args: {
  t: (key: string) => string;
  currentProfileId: string | null;
}): SessionResetResult {
  const { t, currentProfileId } = args;

  if (!currentProfileId) {
    return { success: false, profileId: null };
  }

  const profile = findProfileById(currentProfileId);
  if (!profile) {
    return { success: false, profileId: null };
  }

  // ë™ì¼ í”„ë¡œí•„ë¡œ ìƒˆ ì„¸ì…˜ ì‹œì‘
  const result = startSessionFromProfile({ profile, t });

  return {
    success: result.success,
    profileId: result.profileId,
  };
}

/**
 * ì„¸ì…˜ì„ ì¢…ë£Œí•˜ê³  í”„ë¡œí•„ ì„ íƒ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.
 *
 * U-116: ëª¨ë“  ì„¸ì…˜ storeë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤ (LocalStorage ì¡°ì‘ ì—†ìŒ).
 */
export function clearSessionAndReturnToSelect(): void {
  // ëª¨ë“  ì„¸ì…˜ store ì´ˆê¸°í™”
  resetAllSessionStores();
}

// =============================================================================
// U-044 + U-116: ì„¸ì…˜ ì–¸ì–´ SSOT API
// =============================================================================

/**
 * í˜„ì¬ ì„¸ì…˜ ì–¸ì–´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤ (SSOT).
 *
 * U-116: SaveGame ì—†ì´ i18nì˜ í˜„ì¬ ì–¸ì–´ë¥¼ ì§ì ‘ ì‚¬ìš©í•©ë‹ˆë‹¤.
 *
 * @returns í˜„ì¬ ì„¸ì…˜ ì–¸ì–´ (ko-KR | en-US)
 */
export function getSessionLanguage(): SupportedLanguage {
  return getResolvedLanguage();
}

/**
 * ì„¸ì…˜ ì–¸ì–´ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.
 *
 * U-044: ì–¸ì–´ ë³€ê²½ì€ ì„¸ì…˜ ê²½ê³„ì—ì„œë§Œ í—ˆìš© (í† ê¸€=ë¦¬ì…‹ ì •ì±…).
 * U-116-Q1 Option B: ì–¸ì–´ ì„¤ì •ì„ LocalStorageì— ìœ ì§€í•©ë‹ˆë‹¤.
 *
 * @param language - ë³€ê²½í•  ì–¸ì–´
 */
export async function setSessionLanguage(language: SupportedLanguage): Promise<void> {
  await changeLanguage(language);
  // Q1 Option B: ì–¸ì–´ ì„¤ì •ë§Œ LocalStorageì— ìœ ì§€
  try {
    localStorage.setItem(LANGUAGE_STORAGE_KEY, language);
  } catch {
    // ì‹œí¬ë¦¿ ëª¨ë“œ ë“±ì—ì„œ ì‹¤íŒ¨ ê°€ëŠ¥ - ë¬´ì‹œ
  }
}

/**
 * ì´ˆê¸° ì„¸ì…˜ ì–¸ì–´ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.
 *
 * U-116-Q1 Option B: LocalStorageì—ì„œ ì´ì „ ì–¸ì–´ ì„¤ì •ì„ ì½ìŠµë‹ˆë‹¤.
 * ì—†ìœ¼ë©´ DEFAULT_LANGUAGEë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
 *
 * @returns ì´ˆê¸° ì„¸ì…˜ ì–¸ì–´
 */
export function getInitialSessionLanguage(): SupportedLanguage {
  try {
    const stored = localStorage.getItem(LANGUAGE_STORAGE_KEY);
    if (stored === 'ko-KR' || stored === 'en-US') {
      return stored;
    }
  } catch {
    // localStorage ì ‘ê·¼ ë¶ˆê°€ í™˜ê²½ - ë¬´ì‹œ
  }
  return DEFAULT_LANGUAGE;
}
</file>

<file path="frontend/src/stores/agentStore.test.ts">
import { describe, it, expect, beforeEach } from 'vitest';
import { useAgentStore } from './agentStore';
import { StreamEventType, StageStatus } from '../api/turnStream';
import type { TurnOutput } from '../schemas/turn';

describe('agentStore', () => {
  beforeEach(() => {
    useAgentStore.getState().reset();
  });

  it('should have correct initial state', () => {
    const state = useAgentStore.getState();
    expect(state.isStreaming).toBe(false);
    expect(state.phases).toHaveLength(7);
    expect(state.phases[0].status).toBe('pending');
    expect(state.badges).toEqual([]);
    expect(state.repairCount).toBe(0);
  });

  it('should handle startStream', () => {
    useAgentStore.getState().startStream();
    const state = useAgentStore.getState();
    expect(state.isStreaming).toBe(true);
  });

  it('should handle handleStage events', () => {
    const store = useAgentStore.getState();

    // Start parse phase
    store.handleStage({
      type: StreamEventType.STAGE,
      name: 'parse',
      status: StageStatus.START,
    });

    let state = useAgentStore.getState();
    expect(state.currentPhase).toBe('parse');
    expect(state.phases.find((p) => p.name === 'parse')?.status).toBe('in_progress');

    // Complete parse phase
    store.handleStage({
      type: StreamEventType.STAGE,
      name: 'parse',
      status: StageStatus.COMPLETE,
    });

    state = useAgentStore.getState();
    expect(state.phases.find((p) => p.name === 'parse')?.status).toBe('completed');
  });

  it('should handle handleBadges events', () => {
    const store = useAgentStore.getState();
    store.handleBadges({
      type: StreamEventType.BADGES,
      badges: ['schema_ok', 'economy_ok'],
    });

    const state = useAgentStore.getState();
    expect(state.badges).toEqual(['schema_ok', 'economy_ok']);
  });

  it('should handle handleNarrativeDelta events', () => {
    const store = useAgentStore.getState();
    store.handleNarrativeDelta({
      type: StreamEventType.NARRATIVE_DELTA,
      text: 'Hello ',
    });
    store.handleNarrativeDelta({
      type: StreamEventType.NARRATIVE_DELTA,
      text: 'World',
    });

    const state = useAgentStore.getState();
    expect(state.narrativeBuffer).toBe('Hello World');
  });

  it('should handle handleFinal events', () => {
    const store = useAgentStore.getState();
    const mockOutput = {
      language: 'ko-KR',
      narrative: 'Final message',
      economy: {
        cost: { signal: 0, memory_shard: 0 },
        balance_after: { signal: 100, memory_shard: 0 },
        credit: 0,
        low_balance_warning: false,
      },
      safety: { blocked: false, message: null },
      ui: { action_deck: { cards: [] }, objects: [], scene: { image_url: null, alt_text: null } },
      world: {
        rules_changed: [],
        inventory_added: [],
        inventory_removed: [],
        quests_updated: [],
        relationships_changed: [],
        memory_pins: [],
      },
      render: {
        image_job: null,
        image_url: null,
        image_id: null,
        generation_time_ms: null,
      },
      agent_console: {
        repair_count: 2,
        current_phase: 'commit',
        badges: [],
        model_label: 'FAST',
      },
    } as TurnOutput;

    store.handleFinal({
      type: StreamEventType.FINAL,
      data: mockOutput,
    });

    const state = useAgentStore.getState();
    expect(state.finalOutput).toEqual(mockOutput);
    expect(state.repairCount).toBe(2);
  });

  it('should handle handleError events', () => {
    const store = useAgentStore.getState();
    store.handleError({
      type: StreamEventType.ERROR,
      message: 'Network error',
      code: 'ERR_NET',
    });

    const state = useAgentStore.getState();
    expect(state.error).toEqual({
      message: 'Network error',
      code: 'ERR_NET',
    });
  });

  it('should reset state on completeStream', () => {
    const store = useAgentStore.getState();
    store.handleNarrativeDelta({ type: StreamEventType.NARRATIVE_DELTA, text: 'Some text' });
    store.startStream();

    store.completeStream();

    const state = useAgentStore.getState();
    expect(state.isStreaming).toBe(false);
    expect(state.narrativeBuffer).toBe('');
  });
});
</file>

<file path="frontend/src/stores/inventoryStore.ts">
/**
 * Unknown World - Inventory ìƒíƒœ ê´€ë¦¬ (Zustand) (U-011[Mvp]).
 *
 * Inventoryì˜ ì•„ì´í…œ ëª©ë¡, ë“œë˜ê·¸ ìƒíƒœ, ì„ íƒ ìƒíƒœë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - RULE-002: InventoryëŠ” ê²Œì„ UIë¡œ ìƒì‹œ ë…¸ì¶œ
 *   - U-006 ì˜ì¡´: WorldDelta.inventory_added / inventory_removed í•„ë“œ ì—°ë™
 *   - U-012 ì—°ê²°: ë“œë˜ê·¸ ë°ì´í„°ì— item_idë¥¼ ì‹¤ì–´ ë“œë¡­ íƒ€ê²Ÿ(í•«ìŠ¤íŒŸ)ì— ì „ë‹¬
 *
 * U-075[Mvp]: ì•„ì´í…œ ì•„ì´ì½˜ ë™ì  ìƒì„±
 *   - Q1: Option B (placeholder ë¨¼ì € í‘œì‹œ í›„ ë°±ê·¸ë¼ìš´ë“œ ìƒì„±)
 *   - ì•„ì´ì½˜ ìƒì„± ìƒíƒœ ì¶”ì  ë° URL ì—…ë°ì´íŠ¸
 *
 * @module stores/inventoryStore
 */

import { create } from 'zustand';
// U-092: í”„ë¦¬ì…‹ ì•„ì´ì½˜ ë ˆì§€ìŠ¤íŠ¸ë¦¬
import { getPresetIconUrl } from '../data/itemIconPresets';

// =============================================================================
// íƒ€ì… ì •ì˜
// =============================================================================

/**
 * ì•„ì´ì½˜ ìƒì„± ìƒíƒœ.
 */
export type IconStatus = 'pending' | 'generating' | 'completed' | 'failed' | 'cached';

/**
 * ì¸ë²¤í† ë¦¬ ì•„ì´í…œ.
 * MVPì—ì„œëŠ” ìµœì†Œ í•„ë“œë§Œ ì •ì˜í•©ë‹ˆë‹¤.
 *
 * U-075: icon í•„ë“œëŠ” URL ë˜ëŠ” ì´ëª¨ì§€, iconStatusë¡œ ìƒì„± ìƒíƒœ ì¶”ì 
 */
export interface InventoryItem {
  /** ì•„ì´í…œ ê³ ìœ  ID */
  id: string;
  /** ì•„ì´í…œ ì´ë¦„ (í‘œì‹œìš©) */
  name: string;
  /** ì•„ì´í…œ ì„¤ëª… (ì„ íƒ) */
  description?: string;
  /** ì•„ì´í…œ ì•„ì´ì½˜ URL ë˜ëŠ” ì´ëª¨ì§€ (ì„ íƒ) */
  icon?: string;
  /** ì•„ì´í…œ ìˆ˜ëŸ‰ (ê¸°ë³¸ê°’: 1) */
  quantity: number;
  /** U-075: ì•„ì´ì½˜ ìƒì„± ìƒíƒœ (ì„ íƒ) */
  iconStatus?: IconStatus;
}

/** Inventory ìƒíƒœ */
export interface InventoryState {
  /** í˜„ì¬ ì•„ì´í…œ ëª©ë¡ */
  items: InventoryItem[];
  /** í˜„ì¬ ë“œë˜ê·¸ ì¤‘ì¸ ì•„ì´í…œ ID (nullì´ë©´ ë“œë˜ê·¸ ì¤‘ ì•„ë‹˜) */
  draggingItemId: string | null;
  /** ì„ íƒëœ ì•„ì´í…œ ID (í´ë¦­ ì„ íƒ, ë“œë˜ê·¸ì™€ ë³„ê°œ) */
  selectedItemId: string | null;
  /** U-096: ì†Œë¹„(ì‚­ì œ) ì• ë‹ˆë©”ì´ì…˜ ì§„í–‰ ì¤‘ì¸ ì•„ì´í…œ ID ì§‘í•© */
  consumingItemIds: string[];
}

/** Inventory ì•¡ì…˜ */
export interface InventoryActions {
  /** ì•„ì´í…œ ëª©ë¡ ì„¤ì • (ì „ì²´ êµì²´) */
  setItems: (items: InventoryItem[]) => void;
  /** ì•„ì´í…œ ì¶”ê°€ (ì¤‘ë³µ IDë©´ ìˆ˜ëŸ‰ ì¦ê°€) */
  addItems: (items: InventoryItem[]) => void;
  /** ì•„ì´í…œ ì œê±° (ID ëª©ë¡) */
  removeItems: (itemIds: string[]) => void;
  /** ë“œë˜ê·¸ ì‹œì‘ */
  startDrag: (itemId: string) => void;
  /** ë“œë˜ê·¸ ì¢…ë£Œ */
  endDrag: () => void;
  /** ì•„ì´í…œ ì„ íƒ */
  selectItem: (itemId: string | null) => void;
  /** ìƒíƒœ ì´ˆê¸°í™” */
  reset: () => void;
  /** U-075: ì•„ì´í…œ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸ */
  updateItemIcon: (itemId: string, icon: string, status: IconStatus) => void;
  /** U-075: ì•„ì´í…œ ì•„ì´ì½˜ ìƒíƒœë§Œ ì—…ë°ì´íŠ¸ */
  setItemIconStatus: (itemId: string, status: IconStatus) => void;
  /**
   * U-096: ì•„ì´í…œì„ ì†Œë¹„(ì‚­ì œ) ì• ë‹ˆë©”ì´ì…˜ ìƒíƒœë¡œ ì „í™˜í•©ë‹ˆë‹¤.
   * fade-out ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ ì‹œ í˜¸ì¶œí•©ë‹ˆë‹¤.
   */
  markConsuming: (itemIds: string[]) => void;
  /**
   * U-096: ì†Œë¹„ ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ì•„ì´í…œì„ ì‹¤ì œë¡œ ì œê±°í•©ë‹ˆë‹¤.
   * markConsuming â†’ (ì• ë‹ˆë©”ì´ì…˜ ëŒ€ê¸°) â†’ clearConsuming ìˆœì„œë¡œ í˜¸ì¶œí•©ë‹ˆë‹¤.
   */
  clearConsuming: (itemIds: string[]) => void;
}

export type InventoryStore = InventoryState & InventoryActions;

// =============================================================================
// ì´ˆê¸° ìƒíƒœ
// =============================================================================

function createInitialState(): InventoryState {
  return {
    items: [],
    draggingItemId: null,
    selectedItemId: null,
    consumingItemIds: [],
  };
}

// =============================================================================
// Zustand Store
// =============================================================================

/**
 * Inventory ìƒíƒœ ìŠ¤í† ì–´.
 *
 * @example
 * ```tsx
 * const { items, addItems, removeItems, startDrag, endDrag } = useInventoryStore();
 *
 * // TurnOutput.world.inventory_added ìˆ˜ì‹  ì‹œ
 * addItems(inventoryAddedItems);
 *
 * // TurnOutput.world.inventory_removed ìˆ˜ì‹  ì‹œ
 * removeItems(inventoryRemovedIds);
 *
 * // dnd-kit onDragStart
 * startDrag(itemId);
 *
 * // dnd-kit onDragEnd
 * endDrag();
 * ```
 */
export const useInventoryStore = create<InventoryStore>((set) => ({
  // ì´ˆê¸° ìƒíƒœ
  ...createInitialState(),

  // ì•¡ì…˜
  setItems: (items) => {
    set({
      items,
      draggingItemId: null,
      selectedItemId: null,
    });
  },

  addItems: (newItems) => {
    set((state) => {
      const itemsMap = new Map(state.items.map((item) => [item.id, item]));

      for (const newItem of newItems) {
        const existing = itemsMap.get(newItem.id);
        if (existing) {
          // ê¸°ì¡´ ì•„ì´í…œì´ë©´ ìˆ˜ëŸ‰ ì¦ê°€
          itemsMap.set(newItem.id, {
            ...existing,
            quantity: existing.quantity + newItem.quantity,
          });
        } else {
          // ìƒˆ ì•„ì´í…œ ì¶”ê°€
          itemsMap.set(newItem.id, newItem);
        }
      }

      return { items: Array.from(itemsMap.values()) };
    });
  },

  removeItems: (itemIds) => {
    set((state) => {
      const countsToRemove = itemIds.reduce(
        (acc, id) => {
          acc[id] = (acc[id] || 0) + 1;
          return acc;
        },
        {} as Record<string, number>,
      );

      const nextItems = state.items
        .map((item) => {
          const toRemove = countsToRemove[item.id];
          if (!toRemove) return item;

          const nextQuantity = item.quantity - toRemove;
          if (nextQuantity <= 0) return null; // ìˆ˜ëŸ‰ì´ 0 ì´í•˜ë©´ ì œê±°
          return { ...item, quantity: nextQuantity };
        })
        .filter((item): item is InventoryItem => item !== null);

      const removedIds = new Set(
        state.items
          .filter((item) => !nextItems.find((ni) => ni.id === item.id))
          .map((item) => item.id),
      );

      return {
        items: nextItems,
        // ì™„ì „íˆ ì œê±°ëœ ì•„ì´í…œì´ ì„ íƒ/ë“œë˜ê·¸ ì¤‘ì´ì—ˆë‹¤ë©´ ì´ˆê¸°í™”
        selectedItemId: removedIds.has(state.selectedItemId ?? '') ? null : state.selectedItemId,
        draggingItemId: removedIds.has(state.draggingItemId ?? '') ? null : state.draggingItemId,
      };
    });
  },

  startDrag: (itemId) => {
    set({ draggingItemId: itemId });
  },

  endDrag: () => {
    set({ draggingItemId: null });
  },

  selectItem: (itemId) => {
    set({ selectedItemId: itemId });
  },

  reset: () => {
    set(createInitialState());
  },

  // U-075: ì•„ì´í…œ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
  updateItemIcon: (itemId, icon, status) => {
    set((state) => ({
      items: state.items.map((item) =>
        item.id === itemId ? { ...item, icon, iconStatus: status } : item,
      ),
    }));
  },

  // U-075: ì•„ì´í…œ ì•„ì´ì½˜ ìƒíƒœë§Œ ì—…ë°ì´íŠ¸
  setItemIconStatus: (itemId, status) => {
    set((state) => ({
      items: state.items.map((item) =>
        item.id === itemId ? { ...item, iconStatus: status } : item,
      ),
    }));
  },

  // U-096: ì•„ì´í…œ ì†Œë¹„ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
  markConsuming: (itemIds) => {
    set((state) => ({
      consumingItemIds: [...new Set([...state.consumingItemIds, ...itemIds])],
    }));
  },

  // U-096: ì†Œë¹„ ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ì‹¤ì œ ì œê±°
  clearConsuming: (itemIds) => {
    set((state) => {
      const countsToRemove = itemIds.reduce(
        (acc, id) => {
          acc[id] = (acc[id] || 0) + 1;
          return acc;
        },
        {} as Record<string, number>,
      );

      const nextItems = state.items
        .map((item) => {
          const toRemove = countsToRemove[item.id];
          if (!toRemove) return item;

          const nextQuantity = item.quantity - toRemove;
          if (nextQuantity <= 0) return null;
          return { ...item, quantity: nextQuantity };
        })
        .filter((item): item is InventoryItem => item !== null);

      const removedIds = new Set(
        state.items
          .filter((item) => !nextItems.find((ni) => ni.id === item.id))
          .map((item) => item.id),
      );

      const removeSet = new Set(itemIds);
      return {
        items: nextItems,
        consumingItemIds: state.consumingItemIds.filter((id) => !removeSet.has(id)),
        // ì™„ì „íˆ ì œê±°ëœ ì•„ì´í…œì´ ì„ íƒ/ë“œë˜ê·¸ ì¤‘ì´ì—ˆë‹¤ë©´ ì´ˆê¸°í™”
        selectedItemId: removedIds.has(state.selectedItemId ?? '') ? null : state.selectedItemId,
        draggingItemId: removedIds.has(state.draggingItemId ?? '') ? null : state.draggingItemId,
      };
    });
  },
}));

// =============================================================================
// ì…€ë ‰í„° (ì„±ëŠ¥ ìµœì í™”ìš©)
// =============================================================================

/** ì•„ì´í…œ ëª©ë¡ ì…€ë ‰í„° */
export const selectItems = (state: InventoryStore) => state.items;

/** ë“œë˜ê·¸ ì¤‘ì¸ ì•„ì´í…œ ID ì…€ë ‰í„° */
export const selectDraggingItemId = (state: InventoryStore) => state.draggingItemId;

/** ë“œë˜ê·¸ ì¤‘ì¸ ì•„ì´í…œ ê°ì²´ ì…€ë ‰í„° */
export const selectDraggingItem = (state: InventoryStore) =>
  state.items.find((item) => item.id === state.draggingItemId) ?? null;

/** ì„ íƒëœ ì•„ì´í…œ ID ì…€ë ‰í„° */
export const selectSelectedItemId = (state: InventoryStore) => state.selectedItemId;

/** ì„ íƒëœ ì•„ì´í…œ ê°ì²´ ì…€ë ‰í„° */
export const selectSelectedItem = (state: InventoryStore) =>
  state.items.find((item) => item.id === state.selectedItemId) ?? null;

/** ì•„ì´í…œ ê°œìˆ˜ ì…€ë ‰í„° */
export const selectItemCount = (state: InventoryStore) => state.items.length;

/** U-096: ì†Œë¹„ ì¤‘ì¸ ì•„ì´í…œ ID ëª©ë¡ ì…€ë ‰í„° */
export const selectConsumingItemIds = (state: InventoryStore) => state.consumingItemIds;

// =============================================================================
// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
// =============================================================================

/**
 * ì„œë²„ ì‘ë‹µ(inventory_added InventoryItemData ë°°ì—´)ì„ InventoryItem ë°°ì—´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
 *
 * @param added - ì¶”ê°€ëœ ì•„ì´í…œ ë°ì´í„° ëª©ë¡ (ì„œë²„ ì‘ë‹µ)
 * @returns InventoryItem ë°°ì—´
 */
export function parseInventoryAdded(added: InventoryItemDataInput[]): InventoryItem[] {
  return added.map((item) => {
    // U-092: í”„ë¦¬ì…‹ ì•„ì´ì½˜ ìš°ì„  (Q2: icon_urlì´ ìˆìœ¼ë©´ í•­ìƒ í”„ë¦¬ì…‹ ìš°ì„ , ë™ì  ìƒì„± ê±´ë„ˆë›°ê¸°)
    const presetUrl = getPresetIconUrl(item.id);
    const iconUrl = presetUrl ?? item.icon_url ?? undefined;
    const status: IconStatus = iconUrl ? 'completed' : 'pending';

    return {
      id: item.id,
      name: item.label,
      description: item.description || item.label,
      icon: iconUrl,
      quantity: item.quantity ?? 1,
      iconStatus: status,
    };
  });
}

/** ì„œë²„ì—ì„œ ì˜¤ëŠ” InventoryItemData í˜•íƒœ (Zod ìŠ¤í‚¤ë§ˆì™€ ë™ì¼) */
export interface InventoryItemDataInput {
  id: string;
  label: string;
  description?: string;
  icon_url?: string | null;
  quantity?: number;
}

/**
 * ì•„ì´í…œ IDë¡œ ì•„ì´í…œì„ ì°¾ìŠµë‹ˆë‹¤.
 *
 * @param items - ì•„ì´í…œ ëª©ë¡
 * @param itemId - ì°¾ì„ ì•„ì´í…œ ID
 * @returns ì•„ì´í…œ ë˜ëŠ” undefined
 */
export function findItemById(items: InventoryItem[], itemId: string): InventoryItem | undefined {
  return items.find((item) => item.id === itemId);
}

// =============================================================================
// U-075: ì•„ì´ì½˜ ìƒì„± API
// =============================================================================

/** ì•„ì´ì½˜ ìƒì„± API ì‘ë‹µ */
interface IconApiResponse {
  status: string;
  icon_url: string;
  item_id: string;
  is_placeholder: boolean;
  message?: string;
}

/**
 * ì•„ì´í…œ ì•„ì´ì½˜ ìƒì„±ì„ ìš”ì²­í•©ë‹ˆë‹¤ (U-075[Mvp]).
 *
 * Q1 ê²°ì •: Option B - placeholder ë¨¼ì € ë°˜í™˜, ë°±ê·¸ë¼ìš´ë“œ ìƒì„±
 *
 * @param itemId - ì•„ì´í…œ ID
 * @param description - ì•„ì´í…œ ì„¤ëª…
 * @param language - ì„¸ì…˜ ì–¸ì–´
 * @returns ì•„ì´ì½˜ URL ë° ìƒíƒœ
 */
export async function requestItemIcon(
  itemId: string,
  description: string,
  language: string = 'ko-KR',
): Promise<{ iconUrl: string; status: IconStatus; isPlaceholder: boolean }> {
  const apiUrl = import.meta.env.VITE_API_BASE_URL || 'http://localhost:8011';

  try {
    const response = await fetch(`${apiUrl}/api/item/icon`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        item_id: itemId,
        description: description,
        language: language,
        wait: false, // Q1: placeholder ì¦‰ì‹œ ë°˜í™˜
      }),
    });

    if (!response.ok) {
      console.warn(`[ItemIcon] API ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
      return { iconUrl: '', status: 'failed', isPlaceholder: true };
    }

    const data: IconApiResponse = await response.json();
    return {
      iconUrl: data.icon_url,
      status: data.status as IconStatus,
      isPlaceholder: data.is_placeholder,
    };
  } catch (error) {
    console.warn('[ItemIcon] ì•„ì´ì½˜ ìƒì„± ìš”ì²­ ì‹¤íŒ¨:', error);
    return { iconUrl: '', status: 'failed', isPlaceholder: true };
  }
}

/**
 * ì•„ì´ì½˜ ìƒì„± ìƒíƒœë¥¼ í´ë§í•©ë‹ˆë‹¤ (U-075[Mvp]).
 *
 * @param itemId - ì•„ì´í…œ ID
 * @returns í˜„ì¬ ìƒíƒœ
 */
export async function pollIconStatus(itemId: string): Promise<IconStatus> {
  const apiUrl = import.meta.env.VITE_API_BASE_URL || 'http://localhost:8011';

  try {
    const response = await fetch(`${apiUrl}/api/item/icon/${itemId}/status`);

    if (!response.ok) {
      return 'failed';
    }

    const data = await response.json();
    return data.status as IconStatus;
  } catch {
    return 'failed';
  }
}
</file>

<file path="frontend/src/components/AgentConsole.tsx">
/**
 * Unknown World - Agent Console ì»´í¬ë„ŒíŠ¸.
 *
 * ì—ì´ì „íŠ¸í˜• ì‹œìŠ¤í…œì„ì„ UIë¡œ ì¦ëª…í•˜ê¸° ìœ„í•œ ì»´í¬ë„ŒíŠ¸ì…ë‹ˆë‹¤.
 * Plan/Queue/Badges/Auto-repair íŠ¸ë ˆì´ìŠ¤ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
 *
 * U-123: ì ‘ê¸° ì œê±° + ëŒ€ê¸°ì—´ ìƒë‹¨ + ë°°ì§€ í•˜ë‹¨ (í•­ìƒ ë…¸ì¶œ)
 *   - Queue(ëŒ€ê¸°ì—´): ìƒë‹¨ í•­ìƒ ë…¸ì¶œ, idle ì‹œ "ëŒ€ê¸° ì¤‘..." í‘œì‹œ
 *   - Badges(ê²€ì¦ë°°ì§€): í•˜ë‹¨ í•­ìƒ ë…¸ì¶œ (ì ‘ê¸°/í¼ì¹˜ê¸° í† ê¸€ ì œê±°)
 *   - êµ¬ë¶„ì„ ìœ¼ë¡œ ëŒ€ê¸°ì—´/ë°°ì§€ ì˜ì—­ ì‹œê°ì  ë¶„ë¦¬
 *
 * U-082: Agent Console ì¶•ì†Œ ê¸°ë°˜ (ë ˆì´ì•„ì›ƒ ì¶•ì†Œ ë²”ìœ„ ìœ ì§€)
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - RULE-008: ë‹¨ê³„/ë°°ì§€/ë³µêµ¬ë§Œ ë³´ì—¬ì¤Œ (í”„ë¡¬í”„íŠ¸/ë‚´ë¶€ ì¶”ë¡  ë…¸ì¶œ ê¸ˆì§€)
 *   - RULE-002: ê²Œì„ UIë¡œ í‘œí˜„ (ì±„íŒ… ë²„ë¸” ê¸ˆì§€)
 *
 * @module components/AgentConsole
 */

import { useTranslation } from 'react-i18next';
import {
  useAgentStore,
  selectIsStreaming,
  selectPhases,
  selectBadges,
  selectRepairCount,
  selectError,
  selectModelLabel,
  type PhaseInfo,
} from '../stores/agentStore';
import type { ValidationBadge, ModelLabel } from '../schemas/turn';

// =============================================================================
// ìƒìˆ˜ ì •ì˜
// =============================================================================

/** ë‹¨ê³„ í‘œì‹œ ì´ë¦„ i18n í‚¤ */
const PHASE_KEYS: Record<string, string> = {
  parse: 'agent.console.phase.parse',
  validate: 'agent.console.phase.validate',
  plan: 'agent.console.phase.plan',
  resolve: 'agent.console.phase.resolve',
  render: 'agent.console.phase.render',
  verify: 'agent.console.phase.verify',
  commit: 'agent.console.phase.commit',
};

/** ë°°ì§€ í‘œì‹œ ì •ë³´ (i18n í‚¤ ê¸°ë°˜) */
const BADGE_INFO: Record<ValidationBadge, { labelKey: string; isOk: boolean }> = {
  schema_ok: { labelKey: 'agent.console.badge.schema', isOk: true },
  schema_fail: { labelKey: 'agent.console.badge.schema', isOk: false },
  economy_ok: { labelKey: 'agent.console.badge.economy', isOk: true },
  economy_fail: { labelKey: 'agent.console.badge.economy', isOk: false },
  safety_ok: { labelKey: 'agent.console.badge.safety', isOk: true },
  safety_blocked: { labelKey: 'agent.console.badge.safety', isOk: false },
  consistency_ok: { labelKey: 'agent.console.badge.consistency', isOk: true },
  consistency_fail: { labelKey: 'agent.console.badge.consistency', isOk: false },
};

/** ëª¨ë¸ ë¼ë²¨ í‘œì‹œ ì •ë³´ (U-069: FAST/QUALITY) */
const MODEL_LABEL_INFO: Record<ModelLabel, { labelKey: string; icon: string; colorClass: string }> =
  {
    FAST: { labelKey: 'agent.console.model.fast', icon: '\u26A1', colorClass: 'model-fast' },
    QUALITY: {
      labelKey: 'agent.console.model.quality',
      icon: '\u2605',
      colorClass: 'model-quality',
    },
    CHEAP: { labelKey: 'agent.console.model.cheap', icon: '\u{1F4B0}', colorClass: 'model-cheap' },
    REF: { labelKey: 'agent.console.model.ref', icon: '\u{1F4F7}', colorClass: 'model-ref' },
  };

// =============================================================================
// í•˜ìœ„ ì»´í¬ë„ŒíŠ¸
// =============================================================================

/** ë‹¨ê³„ ìƒíƒœ ì•„ì´ì½˜ */
function PhaseIcon({ status }: { status: PhaseInfo['status'] }) {
  switch (status) {
    case 'pending':
      return <span className="phase-icon pending">â—‹</span>;
    case 'in_progress':
      return <span className="phase-icon in-progress">â—</span>;
    case 'completed':
      return <span className="phase-icon completed">â—</span>;
    case 'failed':
      return <span className="phase-icon failed">âœ•</span>;
    default:
      return <span className="phase-icon">â—‹</span>;
  }
}

/** ë‹¨ê³„ í í•­ëª© */
function PhaseQueueItem({ phase }: { phase: PhaseInfo }) {
  const { t } = useTranslation();
  const key = PHASE_KEYS[phase.name];
  const label = key ? t(key) : phase.name;
  const statusClass = `phase-item ${phase.status}`;

  return (
    <div className={statusClass}>
      <PhaseIcon status={phase.status} />
      <span className="phase-label">{label}</span>
    </div>
  );
}

/**
 * ëŒ€ê¸°ì—´(Queue): í•­ìƒ ë…¸ì¶œ - U-114
 *
 * ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì´ê±°ë‚˜ ë‹¨ê³„ê°€ ì§„í–‰ëœ ê²½ìš° 7ë‹¨ê³„ íë¥¼ í‘œì‹œí•˜ê³ ,
 * idle ìƒíƒœ(í„´ ë¯¸ì²˜ë¦¬)ì—ì„œëŠ” "ëŒ€ê¸° ì¤‘..." í…ìŠ¤íŠ¸ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
 * Q1: Option A - idle ì‹œ "ëŒ€ê¸° ì¤‘..." í…ìŠ¤íŠ¸
 */
function AlwaysVisibleQueue() {
  const { t } = useTranslation();
  const isStreaming = useAgentStore(selectIsStreaming);
  const phases = useAgentStore(selectPhases);

  return (
    <div className="agent-queue-always">
      <div className="queue-label">{t('agent.console.queue')}</div>
      {isStreaming ? (
        <div className="queue-items">
          {phases.map((phase) => (
            <PhaseQueueItem key={phase.name} phase={phase} />
          ))}
        </div>
      ) : (
        <div className="queue-idle">{t('agent.console.queue_idle')}</div>
      )}
    </div>
  );
}

/** ë°°ì§€ ì•„ì´í…œ */
function BadgeItem({ badge }: { badge: ValidationBadge }) {
  const { t } = useTranslation();
  const info = BADGE_INFO[badge];
  if (!info) return null;

  const statusClass = info.isOk ? 'badge-ok' : 'badge-fail';
  const statusText = info.isOk ? t('agent.console.badge.ok') : t('agent.console.badge.fail');
  const iconName = info.isOk ? 'badge-ok-24.png' : 'badge-fail-24.png';
  const fallbackIcon = info.isOk ? 'âœ“' : 'âœ—';

  return (
    <div className={`badge-item ${statusClass}`}>
      <span className="badge-label">{t(info.labelKey)}</span>
      <span className="badge-status">
        <span className="icon-wrapper">
          <img
            src={`/ui/icons/${iconName}`}
            alt=""
            aria-hidden="true"
            className="badge-icon-img"
            onError={(e) => e.currentTarget.classList.add('hidden')}
          />
          <span className="icon-fallback" style={{ fontSize: '0.625rem' }}>
            {fallbackIcon}
          </span>
        </span>
        {statusText}
      </span>
    </div>
  );
}

/** ë°°ì§€ íŒ¨ë„ */
function BadgesPanel() {
  const { t } = useTranslation();
  const badges = useAgentStore(selectBadges);

  if (badges.length === 0) {
    return (
      <div className="badges-panel">
        <div className="badges-label">{t('agent.console.badges')}</div>
        <div className="badges-empty">{t('agent.console.badges_empty')}</div>
      </div>
    );
  }

  return (
    <div className="badges-panel">
      <div className="badges-label">{t('agent.console.badges')}</div>
      <div className="badges-grid">
        {badges.map((badge, index) => (
          <BadgeItem key={`${badge}-${index}`} badge={badge} />
        ))}
      </div>
    </div>
  );
}

/** Auto-repair íŠ¸ë ˆì´ìŠ¤ */
function RepairTrace() {
  const { t } = useTranslation();
  const repairCount = useAgentStore(selectRepairCount);
  const isStreaming = useAgentStore(selectIsStreaming);

  if (repairCount === 0 && !isStreaming) {
    return null;
  }

  return (
    <div className="repair-trace">
      <span className="repair-label">{t('agent.console.repair')}</span>
      <span className="repair-count">#{repairCount}</span>
      {repairCount > 0 && (
        <span className="repair-status text-warning"> {t('agent.console.repaired')}</span>
      )}
    </div>
  );
}

/**
 * ëª¨ë¸ ë¼ë²¨ ë°°ì§€ (U-069: FAST/QUALITY í‘œì‹œ)
 *
 * í˜„ì¬ í…ìŠ¤íŠ¸ ìƒì„±ì— ì‚¬ìš©ëœ ëª¨ë¸ì„ ì‹œê°ì ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
 * - FAST: ë¹ ë¥¸ ì‘ë‹µ, ê¸°ë³¸ ë¹„ìš© (âš¡)
 * - QUALITY: ê³ í’ˆì§ˆ ì‘ë‹µ, 2ë°° ë¹„ìš© (â˜…)
 */
function ModelLabelBadge() {
  const { t } = useTranslation();
  const modelLabel = useAgentStore(selectModelLabel);
  const info = MODEL_LABEL_INFO[modelLabel];

  if (!info) return null;

  // i18n í‚¤ê°€ ì—†ìœ¼ë©´ í´ë°± í…ìŠ¤íŠ¸ ì‚¬ìš©
  const label = t(info.labelKey, { defaultValue: modelLabel });

  return (
    <div className={`model-label-badge ${info.colorClass}`}>
      <span className="model-icon">{info.icon}</span>
      <span className="model-text">{label}</span>
    </div>
  );
}

/** ì—ëŸ¬ í‘œì‹œ */
function ErrorDisplay() {
  const error = useAgentStore(selectError);

  if (!error) return null;

  return (
    <div className="agent-error">
      <span className="error-icon">âš </span>
      <span className="error-message">{error.message}</span>
      {error.code && <span className="error-code">[{error.code}]</span>}
    </div>
  );
}

/** ìŠ¤íŠ¸ë¦¬ë° ìƒíƒœ í‘œì‹œ */
function StreamingStatus() {
  const { t } = useTranslation();
  const isStreaming = useAgentStore(selectIsStreaming);

  return (
    <div className="streaming-status">
      <span className={`status-dot ${isStreaming ? 'active' : ''}`} />
      <span className="status-text">
        {isStreaming ? t('agent.console.status.processing') : t('agent.console.status.idle')}
      </span>
    </div>
  );
}

// =============================================================================
// ë©”ì¸ ì»´í¬ë„ŒíŠ¸
// =============================================================================

/**
 * Agent Console ì»´í¬ë„ŒíŠ¸.
 *
 * U-123: ì ‘ê¸° ì œê±° + ëŒ€ê¸°ì—´ ìƒë‹¨ + ë°°ì§€ í•˜ë‹¨ í•­ìƒ ë…¸ì¶œ.
 *   - Queue: ìƒë‹¨ í•­ìƒ í‘œì‹œ (idle ì‹œ "ëŒ€ê¸° ì¤‘..." í…ìŠ¤íŠ¸)
 *   - êµ¬ë¶„ì„ : CRT í…Œë§ˆ ë°˜íˆ¬ëª… êµ¬ë¶„ì„ ìœ¼ë¡œ ì˜ì—­ ë¶„ë¦¬
 *   - Badges: í•˜ë‹¨ í•­ìƒ í‘œì‹œ (ì ‘ê¸°/í¼ì¹˜ê¸° í† ê¸€ ì—†ìŒ)
 *   - RepairTrace: ë°°ì§€ ì•„ë˜ ì¡°ê±´ë¶€ í‘œì‹œ
 *
 * RULE-008ì— ë”°ë¼ í”„ë¡¬í”„íŠ¸/ë‚´ë¶€ ì¶”ë¡ ì€ ë…¸ì¶œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
 * U-037: data-ui-importance="critical" ë§ˆí‚¹ìœ¼ë¡œ ê°€ë…ì„± ë³´ì¥
 * U-069: í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ëª¨ë¸ ë¼ë²¨(FAST/QUALITY) í‘œì‹œ ì¶”ê°€
 */
export function AgentConsole() {
  return (
    <div className="agent-console-content" data-ui-importance="critical">
      {/* ìƒë‹¨: StreamingStatus + ModelLabel + Queue(ëŒ€ê¸°ì—´) */}
      <div className="agent-console-always">
        <div className="agent-console-summary">
          <StreamingStatus />
          <ModelLabelBadge />
        </div>
        <AlwaysVisibleQueue />
      </div>

      {/* U-123: CRT í…Œë§ˆ êµ¬ë¶„ì„  (Q1: Option A - ì–‡ì€ êµ¬ë¶„ì„ ) */}
      <hr className="agent-console-divider" />

      {/* í•˜ë‹¨: Badges(ê²€ì¦ ë°°ì§€) + RepairTrace â€” í•­ìƒ ë…¸ì¶œ */}
      <div className="agent-badges-section">
        <BadgesPanel />
        <RepairTrace />
      </div>

      {/* ì—ëŸ¬ëŠ” í•­ìƒ í‘œì‹œ */}
      <ErrorDisplay />
    </div>
  );
}

export default AgentConsole;
</file>

<file path="frontend/src/components/EconomyHud.tsx">
/**
 * Unknown World - Economy HUD ì»´í¬ë„ŒíŠ¸ (U-014[Mvp]).
 *
 * Signal/Memory Shard ì¬í™” ì”ì•¡, ì˜ˆìƒ ë¹„ìš©, í™•ì • ë¹„ìš©ì„ í‘œì‹œí•˜ê³ ,
 * ì”ì•¡ ë¶€ì¡± ì‹œ ê²½ê³  ë° ëŒ€ì•ˆì„ ì•ˆë‚´í•˜ëŠ” ê²Œì„ HUD ì»´í¬ë„ŒíŠ¸ì…ë‹ˆë‹¤.
 *
 * RULE-002 ì¤€ìˆ˜: ì±„íŒ… ë²„ë¸”ì´ ì•„ë‹Œ ê²Œì„ HUD í˜•íƒœ
 * RULE-005 ì¤€ìˆ˜: ì˜ˆìƒ ë¹„ìš© ì‚¬ì „ í‘œì‹œ, ì”ì•¡ ìŒìˆ˜ í‘œì‹œ ë°©ì§€
 * RULE-008 ì¤€ìˆ˜: ë¹„ìš©/ëª¨ë¸ ì„ íƒ ì´ìœ ëŠ” ë¼ë²¨ë¡œë§Œ í‘œì‹œ (í”„ë¡¬í”„íŠ¸ ë…¸ì¶œ ê¸ˆì§€)
 *
 * @see vibe/prd.md 5ì¥ - ì¬í™” ëª©ì /UX ìš”êµ¬
 * @module components/EconomyHud
 */

import { useMemo, useEffect, useRef } from 'react';
import { useTranslation } from 'react-i18next';
import { useShallow } from 'zustand/react/shallow';
import { useWorldStore, type EconomyState } from '../stores/worldStore';
import {
  useEconomyStore,
  selectCostEstimate,
  selectLastCost,
  selectIsBalanceLow,
  selectRecentLedger,
  canAffordEstimate,
  type LedgerEntry,
} from '../stores/economyStore';
import type { CurrencyAmount } from '../schemas/turn';

// =============================================================================
// íƒ€ì… ì •ì˜
// =============================================================================

export interface EconomyHudProps {
  /** ê°„ì†Œí™” ëª¨ë“œ (í—¤ë”ìš© - ì”ì•¡ë§Œ í‘œì‹œ) */
  compact?: boolean;
  /** ì¶”ê°€ CSS í´ë˜ìŠ¤ */
  className?: string;
}

// =============================================================================
// ì•„ì´ì½˜ ì»´í¬ë„ŒíŠ¸
// =============================================================================

interface CurrencyIconProps {
  type: 'signal' | 'shard';
  size?: number;
}

/** U-082: ê¸°ë³¸ ì•„ì´ì½˜ í¬ê¸°ë¥¼ 24â†’28pxë¡œ í™•ëŒ€ (ê°€ì‹œì„± í–¥ìƒ) */
function CurrencyIcon({ type, size = 28 }: CurrencyIconProps) {
  const { t } = useTranslation();

  const iconSrc = type === 'signal' ? '/ui/icons/signal-24.png' : '/ui/icons/shard-24.png';
  const fallback = type === 'signal' ? 'âš¡' : 'ğŸ’';
  const label = type === 'signal' ? t('economy.signal') : t('economy.shard');

  return (
    <span className="icon-wrapper" aria-label={label}>
      <img
        src={iconSrc}
        alt=""
        aria-hidden="true"
        className="icon-img"
        style={{ width: size, height: size }}
        onError={(e) => e.currentTarget.classList.add('hidden')}
      />
      <span className="icon-fallback">{fallback}</span>
    </span>
  );
}

// =============================================================================
// ì”ì•¡ í‘œì‹œ ì»´í¬ë„ŒíŠ¸
// =============================================================================

interface BalanceDisplayProps {
  balance: EconomyState;
  isLow?: boolean;
}

function BalanceDisplay({ balance, isLow }: BalanceDisplayProps) {
  const { t } = useTranslation();

  return (
    <div className={`economy-balance ${isLow ? 'balance-low' : ''}`} data-ui-importance="critical">
      <div className="balance-item">
        <CurrencyIcon type="signal" />
        <span className="balance-value" data-testid="signal-balance">
          {balance.signal}
        </span>
        <span className="balance-label">{t('economy.signal')}</span>
      </div>
      {balance.credit > 0 && (
        <div className="balance-credit" title={t('economy.credit_desc')}>
          <span className="credit-label">{t('economy.credit')}: </span>
          <span className="credit-value">-{balance.credit}</span>
        </div>
      )}
      <div className="balance-item">
        <CurrencyIcon type="shard" />
        <span className="balance-value" data-testid="shard-balance">
          {balance.memory_shard}
        </span>
        <span className="balance-label">{t('economy.shard')}</span>
      </div>
      {isLow && (
        <div className="balance-warning" aria-live="polite">
          <span className="warning-icon">âš </span>
          <span className="warning-text">{t('economy.low_balance_warning')}</span>
        </div>
      )}
    </div>
  );
}

// =============================================================================
// ë¹„ìš© í‘œì‹œ ì»´í¬ë„ŒíŠ¸
// =============================================================================

interface CostDisplayProps {
  /** ë¹„ìš© ìœ í˜• */
  type: 'estimate' | 'confirmed';
  /** ë¹„ìš© ë²”ìœ„ (ì˜ˆìƒ) */
  min?: CurrencyAmount;
  max?: CurrencyAmount;
  /** í™•ì • ë¹„ìš© */
  cost?: CurrencyAmount;
  /** ê°ë‹¹ ê°€ëŠ¥ ì—¬ë¶€ */
  affordable?: boolean;
  /** ë¼ë²¨ */
  label?: string;
}

function CostDisplay({ type, min, max, cost, affordable, label }: CostDisplayProps) {
  const { t } = useTranslation();

  const isRange =
    min && max && (min.signal !== max.signal || min.memory_shard !== max.memory_shard);

  const titleKey = type === 'estimate' ? 'economy.estimated_cost' : 'economy.confirmed_cost';
  const cssClass = type === 'estimate' ? 'cost-estimate' : 'cost-confirmed';

  return (
    <div
      className={`economy-cost ${cssClass} ${affordable === false ? 'cost-unaffordable' : ''}`}
      data-ui-importance="critical"
    >
      <div className="cost-header">
        <span className="cost-title">{t(titleKey)}</span>
        {label && <span className="cost-label">{label}</span>}
      </div>
      <div className="cost-values">
        {/* Signal ë¹„ìš© - U-082: ì•„ì´ì½˜ í¬ê¸° 14â†’18px */}
        <div className="cost-item">
          <CurrencyIcon type="signal" size={18} />
          <span className="cost-value">
            {type === 'estimate' && min && max
              ? isRange
                ? `${min.signal}~${max.signal}`
                : min.signal
              : cost
                ? cost.signal
                : '-'}
          </span>
        </div>
        {/* Shard ë¹„ìš© (0ë³´ë‹¤ í´ ë•Œë§Œ í‘œì‹œ) */}
        {((type === 'estimate' && max && max.memory_shard > 0) ||
          (type === 'confirmed' && cost && cost.memory_shard > 0)) && (
          <div className="cost-item">
            <span className="cost-separator">|</span>
            <CurrencyIcon type="shard" size={18} />
            <span className="cost-value">
              {type === 'estimate' && min && max
                ? isRange
                  ? `${min.memory_shard}~${max.memory_shard}`
                  : min.memory_shard
                : cost
                  ? cost.memory_shard
                  : '-'}
            </span>
          </div>
        )}
      </div>
      {affordable === false && (
        <div className="cost-warning">
          <span className="warning-text">{t('economy.insufficient_funds')}</span>
        </div>
      )}
    </div>
  );
}

// =============================================================================
// ê±°ë˜ ì¥ë¶€(Ledger) í•­ëª© ì»´í¬ë„ŒíŠ¸
// =============================================================================

function LedgerItem({ entry }: { entry: LedgerEntry }) {
  const { t } = useTranslation();

  // U-099: i18n ì–¸ì–´ í˜¼í•© ë°©ì§€ - í‚¤ ê¸°ë°˜ ë²ˆì—­
  // "key|param" í˜•ì‹ì´ë©´ íŒŒë¼ë¯¸í„°ì™€ í•¨ê»˜ ë²ˆì—­, ì•„ë‹ˆë©´ ë‹¨ìˆœ ë²ˆì—­
  const translatedReason = useMemo(() => {
    if (entry.reason.includes('|')) {
      const [key, param] = entry.reason.split('|');
      return `${t(key)}: ${param}`;
    }
    // í‚¤ê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ t()ëŠ” ì…ë ¥ëœ ë¬¸ìì—´ì„ ê·¸ëŒ€ë¡œ ë°˜í™˜í•˜ë¯€ë¡œ í•˜ë“œì½”ë”©ëœ í…ìŠ¤íŠ¸ì™€ í˜¸í™˜ë¨
    return t(entry.reason);
  }, [entry.reason, t]);

  return (
    <div className="ledger-item">
      <div className="ledger-info">
        <span className="ledger-turn">T{entry.turnId}</span>
        <span className="ledger-reason" title={translatedReason}>
          {translatedReason}
        </span>
      </div>
      <div className="ledger-values">
        <span className="ledger-cost">
          -{entry.cost.signal}
          {entry.cost.memory_shard > 0 && ` / -${entry.cost.memory_shard}`}
        </span>
        <span
          className="ledger-model"
          title={entry.modelLabel ? t(`economy.model_label.${entry.modelLabel}`) : undefined}
        >
          {entry.modelLabel?.charAt(0)}
        </span>
      </div>
    </div>
  );
}

// =============================================================================
// ì…€ë ‰í„° ì •ì˜ (ì»´í¬ë„ŒíŠ¸ ì™¸ë¶€ì—ì„œ ìƒì„±í•˜ì—¬ ì°¸ì¡° ìœ ì§€)
// =============================================================================

const selectHistory = selectRecentLedger(10);

// =============================================================================
// ë©”ì¸ Economy HUD ì»´í¬ë„ŒíŠ¸
// =============================================================================

export function EconomyHud({ compact = false, className = '' }: EconomyHudProps) {
  const { t } = useTranslation();

  // Store ìƒíƒœ
  const economy = useWorldStore((state) => state.economy);
  const costEstimate = useEconomyStore(selectCostEstimate);
  const lastCost = useEconomyStore(selectLastCost);
  const isBalanceLow = useEconomyStore(selectIsBalanceLow);
  const recentLedger = useEconomyStore(useShallow(selectHistory));

  // U-049: ê±°ë˜ ì¥ë¶€(Ledger) ìµœì‹  í•­ëª©ì´ ë³´ì´ë„ë¡ ìŠ¤í¬ë¡¤ (í•˜ë‹¨ ìŠ¤í¬ë¡¤)
  const ledgerListRef = useRef<HTMLDivElement>(null);
  useEffect(() => {
    if (ledgerListRef.current) {
      ledgerListRef.current.scrollTop = ledgerListRef.current.scrollHeight;
    }
  }, [recentLedger]);

  // ì˜ˆìƒ ë¹„ìš© ê°ë‹¹ ê°€ëŠ¥ ì—¬ë¶€ ê³„ì‚°
  const estimateAffordability = useMemo(() => {
    if (!costEstimate) return null;
    return canAffordEstimate(economy, costEstimate);
  }, [economy, costEstimate]);

  // Compact ëª¨ë“œ (í—¤ë”ìš©): ì”ì•¡ë§Œ í‘œì‹œ
  if (compact) {
    return (
      <div
        className={`economy-hud economy-hud-compact ${className}`}
        role="status"
        aria-live="polite"
      >
        <BalanceDisplay balance={economy} isLow={isBalanceLow} />
      </div>
    );
  }

  // Full ëª¨ë“œ: ì”ì•¡ + ì˜ˆìƒ ë¹„ìš© + í™•ì • ë¹„ìš© + ê±°ë˜ ì¥ë¶€ ì´ë ¥
  return (
    <div
      className={`economy-hud economy-hud-full ${className}`}
      role="region"
      aria-label={t('economy.hud_label')}
    >
      {/* í˜„ì¬ ì”ì•¡ */}
      <BalanceDisplay balance={economy} isLow={isBalanceLow} />

      {/* ì˜ˆìƒ ë¹„ìš© (ì¹´ë“œ ì„ íƒ/í˜¸ë²„ ì‹œ) */}
      {costEstimate && (
        <CostDisplay
          type="estimate"
          min={costEstimate.min}
          max={costEstimate.max}
          affordable={estimateAffordability?.affordable}
          label={costEstimate.label}
        />
      )}

      {/* ë§ˆì§€ë§‰ í™•ì • ë¹„ìš© (ì˜ˆìƒ ë¹„ìš©ì´ ì—†ì„ ë•Œë§Œ í‘œì‹œ) */}
      {!costEstimate && lastCost && (
        <CostDisplay
          type="confirmed"
          cost={lastCost.cost}
          label={lastCost.modelLabel ? t(`economy.model_label.${lastCost.modelLabel}`) : undefined}
        />
      )}

      {/* U-079: ì”ì•¡ ë¶€ì¡± ì‹œ ëŒ€ì•ˆ ì•ˆë‚´ + FAST í´ë°± ë¼ë²¨ */}
      {isBalanceLow && (
        <div
          className="economy-alternatives economy-alternatives-enhanced"
          data-ui-importance="critical"
        >
          <div className="alternatives-header">
            <span className="alternatives-icon">{'\u26A1'}</span>
            <span className="alternatives-title">{t('economy.low_balance_title')}</span>
          </div>
          <div className="fast-fallback-notice">
            <span className="fast-fallback-badge">FAST</span>
            <span className="fast-fallback-text">{t('economy.fast_fallback_notice')}</span>
          </div>
          <ul className="alternatives-list">
            <li>{t('economy.hint_sell_items')}</li>
            <li>{t('economy.hint_earn_actions')}</li>
            <li>{t('economy.hint_complete_quests')}</li>
          </ul>
        </div>
      )}

      {/* ê±°ë˜ ì¥ë¶€ ì´ë ¥ (Ledger) */}
      <div className="economy-ledger">
        <div className="ledger-header">
          <span className="ledger-title">{t('economy.ledger_title')}</span>
        </div>
        {recentLedger.length > 0 ? (
          <div className="ledger-list" ref={ledgerListRef}>
            {recentLedger.map((entry) => (
              <LedgerItem key={`${entry.turnId}-${entry.timestamp}`} entry={entry} />
            ))}
          </div>
        ) : (
          <div className="ledger-empty">{t('economy.ledger_empty')}</div>
        )}
      </div>
    </div>
  );
}

// =============================================================================
// í—¤ë”ìš© ê°„ì†Œí™” ì»´í¬ë„ŒíŠ¸ (GameHeader í†µí•©ìš©)
// =============================================================================

export interface EconomyHudHeaderProps {
  signal: number;
  memoryShard: number;
  credit: number;
  isLow?: boolean;
}

/**
 * GameHeaderì—ì„œ ì‚¬ìš©í•˜ëŠ” ê°„ì†Œí™”ëœ Economy HUD.
 * ê¸°ì¡´ GameHeaderì˜ economy-hudë¥¼ ëŒ€ì²´í•©ë‹ˆë‹¤.
 */
export function EconomyHudHeader({ signal, memoryShard, credit, isLow }: EconomyHudHeaderProps) {
  const { t } = useTranslation();
  const costEstimate = useEconomyStore(selectCostEstimate);

  // ì˜ˆìƒ ë¹„ìš© ê°ë‹¹ ê°€ëŠ¥ ì—¬ë¶€
  const estimateAffordability = useMemo(() => {
    if (!costEstimate) return null;
    const balance = { signal, memory_shard: memoryShard };
    return canAffordEstimate(balance, costEstimate);
  }, [signal, memoryShard, costEstimate]);

  return (
    <div className={`economy-hud ${isLow ? 'economy-hud-low' : ''}`} data-ui-importance="critical">
      {/* ì”ì•¡ í‘œì‹œ */}
      <span className="icon-wrapper signal-icon" aria-label={t('economy.signal')}>
        <img
          src="/ui/icons/signal-24.png"
          alt=""
          aria-hidden="true"
          className="icon-img"
          onError={(e) => e.currentTarget.classList.add('hidden')}
        />
        <span className="icon-fallback">âš¡</span>
      </span>
      <span className="currency-value" data-testid="header-signal">
        {t('economy.signal')}: {signal}
      </span>
      {credit > 0 && (
        <span className="credit-value header-credit" title={t('economy.credit_desc')}>
          -{credit}
        </span>
      )}
      <span className="icon-wrapper shard-icon" aria-label={t('economy.shard')}>
        <img
          src="/ui/icons/shard-24.png"
          alt=""
          aria-hidden="true"
          className="icon-img"
          onError={(e) => e.currentTarget.classList.add('hidden')}
        />
        <span className="icon-fallback">ğŸ’</span>
      </span>
      <span className="currency-value" data-testid="header-shard">
        {t('economy.shard')}: {memoryShard}
      </span>

      {/* ì˜ˆìƒ ë¹„ìš© ë¯¸ë‹ˆ í‘œì‹œ */}
      {costEstimate && (
        <span
          className={`economy-estimate-mini ${
            estimateAffordability?.affordable === false ? 'unaffordable' : ''
          }`}
          title={t('economy.estimated_cost')}
        >
          <span className="estimate-prefix">â†’</span>
          <span className="estimate-value">
            -{costEstimate.max.signal}
            {costEstimate.max.memory_shard > 0 && `/${costEstimate.max.memory_shard}`}
          </span>
        </span>
      )}

      {/* ì”ì•¡ ë¶€ì¡± ê²½ê³  ì•„ì´ì½˜ */}
      {isLow && (
        <span className="balance-warning-icon" title={t('economy.low_balance_warning')}>
          âš 
        </span>
      )}
    </div>
  );
}

export default EconomyHud;
</file>

<file path="frontend/src/components/NarrativeFeed.test.tsx">
import { describe, it, expect, beforeEach, vi, afterEach } from 'vitest';
import { render, screen, act, fireEvent } from '@testing-library/react';
import { NarrativeFeed } from './NarrativeFeed';

// i18next ëª¨í‚¹
vi.mock('react-i18next', () => ({
  useTranslation: () => ({
    t: (key: string, params?: Record<string, unknown>) => {
      if (key === 'narrative.turn_label') return `Turn ${params?.turn}`;
      if (key === 'narrative.streaming_label') return 'Streaming';
      return key;
    },
  }),
}));

describe('NarrativeFeed (U-066: Typewriter Effect)', () => {
  beforeEach(() => {
    vi.useFakeTimers();
    // prefers-reduced-motion ëª¨í‚¹
    Object.defineProperty(window, 'matchMedia', {
      writable: true,
      value: vi.fn().mockImplementation((query) => ({
        matches: false,
        media: query,
        onchange: null,
        addListener: vi.fn(),
        removeListener: vi.fn(),
        addEventListener: vi.fn(),
        removeEventListener: vi.fn(),
        dispatchEvent: vi.fn(),
      })),
    });
  });

  afterEach(() => {
    vi.useRealTimers();
  });

  it('í…ìŠ¤íŠ¸ê°€ íƒ€ì´í•‘ íš¨ê³¼ì™€ í•¨ê»˜ ì ì§„ì ìœ¼ë¡œ í‘œì‹œë˜ì–´ì•¼ í•œë‹¤', () => {
    const entries = [{ turn: 1, text: 'Hello World' }];
    render(<NarrativeFeed entries={entries} streamingText="" />);

    // ì²˜ìŒì—ëŠ” í•œ ê¸€ì ë˜ëŠ” ì¼ë¶€ë§Œ í‘œì‹œë¨ (TYPING_TICK_MS ì§€ë‚˜ê¸° ì „)
    // ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ì—ì„œ ì²« ë Œë”ë§ ì‹œ typedLenì€ 0ì„
    expect(screen.queryByText('Hello World')).toBeNull();

    // ì‹œê°„ ì§„í–‰
    act(() => {
      vi.advanceTimersByTime(500); // ì¶©ë¶„í•œ ì‹œê°„ ì§„í–‰
    });

    // ì¼ë¶€ í…ìŠ¤íŠ¸ê°€ í‘œì‹œë¨ (ì •í™•í•œ ê¸€ì ìˆ˜ëŠ” CPSì— ë”°ë¼ ë‹¤ë¦„)
    const textElement = screen.getByText(/Hel/);
    expect(textElement).toBeDefined();

    // ì™„ë£Œë  ë•Œê¹Œì§€ ì‹œê°„ ì§„í–‰
    act(() => {
      vi.advanceTimersByTime(10000);
    });

    expect(screen.getByText('Hello World')).toBeDefined();
  });

  it('í´ë¦­í•´ë„ fast-forward ì—†ì´ ì ì§„ì ìœ¼ë¡œ í‘œì‹œë˜ì–´ì•¼ í•œë‹¤', () => {
    const entries = [{ turn: 1, text: 'This is a long text to test no fast forward' }];
    render(<NarrativeFeed entries={entries} streamingText="" />);

    expect(screen.queryByText(entries[0].text)).toBeNull();

    // í´ë¦­ ì´ë²¤íŠ¸ ë°œìƒ â€” fast-forwardê°€ ì œê±°ë˜ì—ˆìœ¼ë¯€ë¡œ ì¦‰ì‹œ í‘œì‹œë˜ì§€ ì•Šì•„ì•¼ í•¨
    const feed = screen.getByRole('log');
    fireEvent.click(feed);

    // ì—¬ì „íˆ ì „ì²´ í…ìŠ¤íŠ¸ëŠ” í‘œì‹œë˜ì§€ ì•ŠìŒ
    expect(screen.queryByText(entries[0].text)).toBeNull();

    // ì¶©ë¶„í•œ ì‹œê°„ ê²½ê³¼ í›„ ì „ì²´ í‘œì‹œë¨
    act(() => {
      vi.advanceTimersByTime(10000);
    });
    expect(screen.getByText(entries[0].text)).toBeDefined();
  });

  it('ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì—ëŠ” ìŠ¤íŠ¸ë¦¬ë° í…ìŠ¤íŠ¸ì— íƒ€ì´í•‘ íš¨ê³¼ê°€ ì ìš©ë˜ì–´ì•¼ í•œë‹¤', () => {
    const entries = [{ turn: 1, text: 'Previous text' }];
    const streamingText = 'Current streaming text';
    render(<NarrativeFeed entries={entries} streamingText={streamingText} isStreaming={true} />);

    // ì´ì „ í…ìŠ¤íŠ¸ëŠ” ë³´ì´ê³ , ìŠ¤íŠ¸ë¦¬ë° í…ìŠ¤íŠ¸ëŠ” íƒ€ì´í•‘ ì¤‘
    expect(screen.getByText('Previous text')).toBeDefined();
    expect(screen.queryByText('Current streaming text')).toBeNull();

    act(() => {
      vi.advanceTimersByTime(30000); // TARGET_DURATION_MS_WHILE_STREAMING
    });

    expect(screen.getByText('Current streaming text')).toBeDefined();
  });

  it('isImageLoading ìƒíƒœì— ë”°ë¼ íƒ€ì´í•‘ ì™„ë£Œ ì‹œì ì´ ë‹¬ë¼ì ¸ì•¼ í•œë‹¤ (U-086)', () => {
    // ì•½ 100ì ì •ë„ì˜ í…ìŠ¤íŠ¸ (CPS ê³„ì‚°ì„ ìœ„í•´)
    const text =
      'This is a test narrative text that should take some time to type out completely for testing.'.repeat(
        2,
      );
    const entries = [{ turn: 1, text }];

    // 1. ì´ë¯¸ì§€ ë¡œë”© ì¤‘ (ëŠë¦° ëª¨ë“œ: ~12ì´ˆ ëª©í‘œ)
    const { unmount } = render(
      <NarrativeFeed entries={entries} streamingText="" isImageLoading={true} />,
    );

    // 5ì´ˆ ê²½ê³¼ ì‹œì  - ì•„ì§ ì™„ë£Œë˜ì§€ ì•Šì•„ì•¼ í•¨ (12ì´ˆ ëª©í‘œì´ë¯€ë¡œ)
    act(() => {
      vi.advanceTimersByTime(5000);
    });
    expect(screen.queryByText(text)).toBeNull();

    // 13ì´ˆ ê²½ê³¼ ì‹œì  - ì™„ë£Œë˜ì–´ì•¼ í•¨
    act(() => {
      vi.advanceTimersByTime(8000);
    });
    expect(screen.getByText(text)).toBeDefined();
    unmount();

    // 2. ì´ë¯¸ì§€ ì™„ë£Œ/ì—†ìŒ ìƒíƒœ (ë¹ ë¥¸ ëª¨ë“œ: ~2.5ì´ˆ ëª©í‘œ)
    render(<NarrativeFeed entries={entries} streamingText="" isImageLoading={false} />);

    // 1ì´ˆ ê²½ê³¼ ì‹œì  - ì•„ì§ ë¯¸ì™„ë£Œ
    act(() => {
      vi.advanceTimersByTime(1000);
    });
    expect(screen.queryByText(text)).toBeNull();

    // 3ì´ˆ ê²½ê³¼ ì‹œì  - ì™„ë£Œë˜ì–´ì•¼ í•¨
    act(() => {
      vi.advanceTimersByTime(2000);
    });
    expect(screen.getByText(text)).toBeDefined();
  });

  it('íƒ€ì´í•‘ ì™„ë£Œ í›„ ì´ë¯¸ì§€ ë¡œë”© ì¤‘ì´ë©´ ìƒíƒœ ë¼ë²¨ì´ í‘œì‹œë˜ê³ , ë¡œë”© ì™„ë£Œ ì‹œ ì‚¬ë¼ì ¸ì•¼ í•œë‹¤ (U-086)', () => {
    const text = 'Short text';
    const entries = [{ turn: 1, text }];
    const { rerender } = render(
      <NarrativeFeed entries={entries} streamingText="" isImageLoading={true} />,
    );

    // 1. íƒ€ì´í•‘ ì™„ë£Œ ì „ - ë¼ë²¨ ì—†ìŒ
    expect(screen.queryByText('narrative.image_pending_label')).toBeNull();

    // 2. íƒ€ì´í•‘ ì™„ë£Œ - ë¼ë²¨ ë…¸ì¶œ
    act(() => {
      vi.advanceTimersByTime(5000);
    });
    expect(screen.getByText(text)).toBeDefined();
    expect(screen.getByText('narrative.image_pending_label')).toBeDefined();

    // 3. ì´ë¯¸ì§€ ë¡œë”© ì™„ë£Œ - ë¼ë²¨ ì œê±°
    rerender(<NarrativeFeed entries={entries} streamingText="" isImageLoading={false} />);
    expect(screen.queryByText('narrative.image_pending_label')).toBeNull();
  });

  it('íƒ€ì´í•‘ ì¤‘ ì´ë¯¸ì§€ê°€ ë„ì°©í•˜ë©´ ì†ë„ê°€ ë¹¨ë¼ì ¸ì•¼ í•œë‹¤ (U-086)', () => {
    const longText = 'Very long text... '.repeat(30);
    const entries = [{ turn: 1, text: longText }];
    const { rerender } = render(
      <NarrativeFeed entries={entries} streamingText="" isImageLoading={true} />,
    );

    // 2ì´ˆ ê²½ê³¼ (ëŠë¦° ëª¨ë“œ)
    act(() => {
      vi.advanceTimersByTime(2000);
    });
    const lenAt2s = screen.queryByText(/Very long/)?.textContent?.length || 0;

    // ì´ë¯¸ì§€ê°€ ë„ì¤‘ì— ë„ì°©í•¨
    rerender(<NarrativeFeed entries={entries} streamingText="" isImageLoading={false} />);

    // 1ì´ˆ ë” ê²½ê³¼ (ì´ì œ ë¹ ë¥¸ ëª¨ë“œì´ë¯€ë¡œ í›¨ì”¬ ë” ë§ì´ ì¶œë ¥ë˜ì–´ì•¼ í•¨)
    act(() => {
      vi.advanceTimersByTime(1000);
    });
    const lenAt3s = screen.queryByText(/Very long/)?.textContent?.length || 0;

    const progressAfterImage = lenAt3s - lenAt2s;
    const progressBeforeImage = lenAt2s;

    // 1ì´ˆ(ë¹ ë¥¸ ëª¨ë“œ) ì§„í–‰ë¶„ì´ 2ì´ˆ(ëŠë¦° ëª¨ë“œ) ì§„í–‰ë¶„ë³´ë‹¤ ë§ì•„ì•¼ í•¨ (12s vs 2.5s ë¹„ìœ¨ìƒ)
    expect(progressAfterImage).toBeGreaterThan(progressBeforeImage / 2);
  });

  it('action_log íƒ€ì…ì˜ ì—”íŠ¸ë¦¬ëŠ” â–¶ ì•„ì´ì½˜ê³¼ í•¨ê»˜ í‘œì‹œë˜ì–´ì•¼ í•œë‹¤ (U-070)', () => {
    const entries = [{ turn: 1, text: 'Action log message', type: 'action_log' as const }];
    render(<NarrativeFeed entries={entries} streamingText="" />);

    // ì¶©ë¶„í•œ ì‹œê°„ ê²½ê³¼í•˜ì—¬ íƒ€ì´í•‘ ì™„ë£Œ
    act(() => {
      vi.advanceTimersByTime(10000);
    });

    expect(screen.getByText('Action log message')).toBeDefined();
    expect(screen.getByText('â–¶')).toBeDefined();
    // action-log-entry í´ë˜ìŠ¤ê°€ í¬í•¨ëœ ìš”ì†Œê°€ ìˆì–´ì•¼ í•¨
    const entry = screen.getByText('Action log message').closest('.narrative-entry');
    expect(entry?.className).toContain('action-log-entry');
  });
});
</file>

<file path="frontend/src/components/SceneImage.tsx">
/**
 * Unknown World - Scene Image ì»´í¬ë„ŒíŠ¸ (U-020: Lazy Render)
 *
 * RULE-004 ì¤€ìˆ˜: ì‹¤íŒ¨ ì‹œì—ë„ ì•ˆì „í•œ í´ë°± ì œê³µ
 * RULE-008 ì¤€ìˆ˜: í…ìŠ¤íŠ¸ ìš°ì„  + Lazy ì´ë¯¸ì§€ ì •ì±…
 *
 * @module components/SceneImage
 */

import { useState, useEffect, useMemo } from 'react';
import { useTranslation } from 'react-i18next';
import type {
  SceneCanvasStatus,
  PlaceholderInfo,
  ImageLoadingState,
  SceneProcessingPhase,
} from '../types/scene';

// =============================================================================
// ìƒìˆ˜ ì •ì˜
// =============================================================================

export const SCENE_PLACEHOLDERS: Record<Exclude<SceneCanvasStatus, 'scene'>, PlaceholderInfo> = {
  default: {
    imagePath: '/ui/placeholders/scene-placeholder-default.png',
    fallbackEmoji: 'ğŸ“¡',
    labelKey: 'scene.status.default',
  },
  loading: {
    imagePath: '/ui/placeholders/scene-loading.webp',
    fallbackEmoji: 'â³',
    labelKey: 'scene.status.loading',
  },
  offline: {
    imagePath: '/ui/placeholders/scene-offline.webp',
    fallbackEmoji: 'ğŸ”Œ',
    labelKey: 'scene.status.offline',
  },
  blocked: {
    imagePath: '/ui/placeholders/scene-blocked.webp',
    fallbackEmoji: 'ğŸš«',
    labelKey: 'scene.status.blocked',
  },
  low_signal: {
    imagePath: '/ui/placeholders/scene-low-signal.webp',
    fallbackEmoji: 'ğŸ“‰',
    labelKey: 'scene.status.low_signal',
  },
};

// =============================================================================
// íƒ€ì… ì •ì˜
// =============================================================================

interface SceneImageProps {
  status: SceneCanvasStatus;
  imageUrl?: string;
  message?: string;
  className?: string;
  /** U-066: ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì—¬ë¶€ (ì™¸ë¶€ ìƒíƒœ) */
  isGenerating?: boolean;
  /** U-071: í˜„ì¬ ì²˜ë¦¬ ë‹¨ê³„ (ë¡œë”© ì¸ë””ì¼€ì´í„° ê°•í™”) */
  processingPhase?: SceneProcessingPhase;
  /** U-089: ì •ë°€ë¶„ì„(Agentic Vision) ì‹¤í–‰ ì¤‘ ì—¬ë¶€ */
  isAnalyzing?: boolean;
}

// =============================================================================
// ì»´í¬ë„ŒíŠ¸ êµ¬í˜„
// =============================================================================

/**
 * ì¥ë©´ ì´ë¯¸ì§€ ë Œë”ë§ ì»´í¬ë„ŒíŠ¸
 *
 * - Lazy loading: ìƒˆ ì´ë¯¸ì§€ë¥¼ í”„ë¦¬ë¡œë“œí•˜ê³  ì™„ë£Œ ì‹œ êµì²´í•©ë‹ˆë‹¤.
 * - Option A: ìƒˆ ì´ë¯¸ì§€ ë¡œë”© ì¤‘ì—ë„ ì´ì „ ì´ë¯¸ì§€ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
 * - í´ë°±: ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë°°ì§€ë¥¼ í‘œì‹œí•˜ê³  ì´ì „ ì´ë¯¸ì§€ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
 * - U-066: isGenerating ìƒíƒœì—ì„œ "ìƒˆ ì¥ë©´ ìƒì„± ì¤‘" ì¸ë””ì¼€ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
 */
export function SceneImage({
  status,
  imageUrl,
  message,
  className = '',
  isGenerating = false,
  processingPhase = 'idle',
  isAnalyzing = false,
}: SceneImageProps) {
  const { t } = useTranslation();

  // U-071: ì²˜ë¦¬ ì¤‘ ì—¬ë¶€ (processing ë˜ëŠ” image_pending)
  // U-089: ì •ë°€ë¶„ì„ ì‹œì—ëŠ” ë³„ë„ ì˜¤ë²„ë ˆì´ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ isProcessingì—ì„œ ì œì™¸
  const isProcessing =
    !isAnalyzing && (processingPhase === 'processing' || processingPhase === 'image_pending');

  // ë‚´ë¶€ ìƒíƒœ ê´€ë¦¬
  const [imageError, setImageError] = useState(false);
  const [displayImageUrl, setDisplayImageUrl] = useState<string | null>(null);

  // íŒŒìƒ ìƒíƒœ: ë¡œë”© ì¤‘ ì—¬ë¶€
  // - ëª©í‘œ URL(imageUrl)ì´ ì¡´ì¬í•˜ê³ , í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ì´ë¯¸ì§€ì™€ ë‹¤ë¥´ë©°, ì—ëŸ¬ê°€ ì•„ë‹Œ ê²½ìš°
  const isImageLoading = useMemo(() => {
    return !!imageUrl && imageUrl !== displayImageUrl && !imageError;
  }, [imageUrl, displayImageUrl, imageError]);

  // ì´ë¯¸ì§€ URL ë³€ê²½ ì‹œ ë¡œë”© í”„ë¡œì„¸ìŠ¤ ì‹œì‘
  useEffect(() => {
    // 1. URLì´ ì—†ê±°ë‚˜ ì´ë¯¸ í‘œì‹œ ì¤‘ì¸ ê²½ìš° ì´ˆê¸°í™” ë° ì¢…ë£Œ
    if (!imageUrl || imageUrl === displayImageUrl) {
      // eslint-disable-next-line react-hooks/set-state-in-effect
      setImageError(false);
      return;
    }

    // 2. ìƒˆ ì´ë¯¸ì§€ í”„ë¦¬ë¡œë“œ ì‹œì‘

    setImageError(false);

    let isMounted = true;
    const img = new Image();
    const currentUrl = imageUrl;

    const handleLoad = () => {
      if (!isMounted) return;
      setDisplayImageUrl(currentUrl);
      setImageError(false);
    };

    const handleError = () => {
      if (!isMounted) return;
      setImageError(true);
    };

    img.addEventListener('load', handleLoad);
    img.addEventListener('error', handleError);
    img.src = imageUrl;

    return () => {
      isMounted = false;
      img.removeEventListener('load', handleLoad);
      img.removeEventListener('error', handleError);
    };
  }, [imageUrl, displayImageUrl]);

  // ì´ë¯¸ì§€ ë¡œë”© ìƒíƒœ íƒ€ì… íŒŒìƒ (CSS í´ë˜ìŠ¤ìš©)
  const imageLoadingState: ImageLoadingState = useMemo(() => {
    if (isImageLoading) return 'loading';
    if (imageError) return 'error';
    if (displayImageUrl) return 'loaded';
    return 'idle';
  }, [isImageLoading, imageError, displayImageUrl]);

  const hasDisplayImage = !!displayImageUrl;
  // U-071: ì²˜ë¦¬ ì¤‘ì¼ ë•ŒëŠ” scene-active í•´ì œ (placeholder í‘œì‹œë¥¼ ìœ„í•´)
  // U-089: ì •ë°€ë¶„ì„ ì¤‘ì—ëŠ” scene-active ìœ ì§€ (ê¸°ì¡´ ì´ë¯¸ì§€ í‘œì‹œ)
  const isSceneActive =
    status === 'scene' && hasDisplayImage && !imageError && !isProcessing && !isAnalyzing;

  // placeholder ì •ë³´ ê²°ì •
  // U-071 Option C: ì²˜ë¦¬ ì¤‘ì¼ ë•Œë„ placeholder ìƒíƒœë¡œ ì „í™˜
  // U-089: ì •ë°€ë¶„ì„ ì‹œì—ëŠ” placeholder ë¯¸í‘œì‹œ (ê¸°ì¡´ ì´ë¯¸ì§€ ìœ ì§€)
  const effectiveStatus = isProcessing
    ? 'loading'
    : status === 'scene' && !hasDisplayImage
      ? 'default'
      : status;

  // U-071 Option C: ì²˜ë¦¬ ì¤‘ì¼ ë•Œ placeholder + ì˜¤ë²„ë ˆì´ í‘œì‹œ
  // U-089: ì •ë°€ë¶„ì„ ì‹œì—ëŠ” ê¸°ì¡´ ì´ë¯¸ì§€ë¥¼ ìœ ì§€í•˜ë¯€ë¡œ placeholder ë¯¸í‘œì‹œ
  const isPlaceholderVisible = (!hasDisplayImage || isProcessing) && !isAnalyzing;

  const placeholder = isPlaceholderVisible
    ? SCENE_PLACEHOLDERS[effectiveStatus as Exclude<SceneCanvasStatus, 'scene'>]
    : null;

  // U-071: ì²˜ë¦¬ ë‹¨ê³„ë³„ ë©”ì‹œì§€ í‚¤ ë§¤í•‘
  const processingMessageKey =
    processingPhase === 'image_pending'
      ? 'scene.processing.image_pending'
      : processingPhase === 'rendering'
        ? 'scene.processing.rendering'
        : 'scene.processing.processing';

  return (
    <div
      className={`scene-image-container ${isSceneActive || isAnalyzing ? 'scene-active' : `scene-status-${effectiveStatus}`} ${isImageLoading ? 'image-loading' : ''} ${isProcessing ? 'scene-processing' : ''} ${isAnalyzing ? 'scene-analyzing' : ''} ${className}`}
      style={placeholder ? { backgroundImage: `url('${placeholder.imagePath}')` } : {}}
    >
      {/* ì¥ë©´ ì´ë¯¸ì§€
        - U-071 Option C: ì²˜ë¦¬ ì¤‘ì¼ ë•Œ ìˆ¨ê¹€
        - U-089: ì •ë°€ë¶„ì„ ì¤‘ì—ëŠ” ê¸°ì¡´ ì´ë¯¸ì§€ ìœ ì§€ (opacity/tintëŠ” CSSì—ì„œ ì²˜ë¦¬)
      */}
      {hasDisplayImage && (!isProcessing || isAnalyzing) && (
        <img
          src={displayImageUrl}
          alt={t('scene.status.alt')}
          className={`scene-image ${imageLoadingState === 'loaded' ? 'scene-image-loaded' : ''}`}
        />
      )}

      {/* U-089: ì •ë°€ë¶„ì„ ì „ìš© ì˜¤ë²„ë ˆì´ (ìŠ¤ìº”ë¼ì¸ ìŠ¤ìœ• + ì‹œì•ˆ ê¸€ë¡œìš° ë¼ë²¨) */}
      {isAnalyzing && (
        <div className="scene-analyzing-overlay" aria-live="polite" role="status">
          {/* ìŠ¤ìº”ë¼ì¸ ìŠ¤ìœ• íš¨ê³¼ (ìœ„â†’ì•„ë˜ ë°˜ë³µ) */}
          <div className="scene-analyzing-scanline" aria-hidden="true" />
          {/* ì‹œì•ˆ ê¸€ë¡œìš° ë¼ë²¨ */}
          <span className="scene-analyzing-text">{t('scene.analyzing.message')}</span>
          {/* ì„œë¸Œ í…ìŠ¤íŠ¸ (ë‹¨ê³„ íŒíŠ¸) */}
          <span className="scene-analyzing-subtext">{t('scene.analyzing.hint')}</span>
        </div>
      )}

      {/* U-071: ì²˜ë¦¬ ì¤‘ ì˜¤ë²„ë ˆì´ (CRT í…Œë§ˆ) - ì •ë°€ë¶„ì„ì´ ì•„ë‹ ë•Œë§Œ */}
      {isProcessing && !isAnalyzing && (
        <div className="scene-processing-overlay" aria-live="polite" role="status">
          <div className="scene-processing-spinner" aria-hidden="true">
            <div className="spinner-ring spinner-ring-outer" />
            <div className="spinner-ring spinner-ring-inner" />
            <div className="spinner-glow" />
          </div>
          <span className="scene-processing-text">{t(processingMessageKey)}</span>
          {/* CRT ìŠ¤ìº”ë¼ì¸ íš¨ê³¼ */}
          <div className="scene-processing-scanlines" aria-hidden="true" />
        </div>
      )}

      {/* ë¡œë”© ì¸ë””ì¼€ì´í„° (ì´ë¯¸ì§€ URL ë¡œë”©) - ì²˜ë¦¬ ì¤‘/ë¶„ì„ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ */}
      {isImageLoading && !isGenerating && !isProcessing && !isAnalyzing && (
        <div className="scene-loading-indicator" aria-live="polite">
          <div className="scene-loading-spinner" aria-hidden="true" />
          <span className="scene-loading-text">{t('scene.status.image_loading')}</span>
        </div>
      )}

      {/* U-066: ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì¸ë””ì¼€ì´í„° - ì²˜ë¦¬ ì¤‘/ë¶„ì„ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ */}
      {isGenerating && !isProcessing && !isAnalyzing && (
        <div className="scene-generating-indicator" aria-live="polite">
          <div className="scene-generating-spinner" aria-hidden="true" />
          <span className="scene-generating-text">{t('scene.status.image_generating')}</span>
        </div>
      )}

      {/* ì´ë¯¸ì§€ ì—ëŸ¬ ë°°ì§€ - ì²˜ë¦¬ ì¤‘/ë¶„ì„ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ */}
      {imageError && !isProcessing && !isAnalyzing && (
        <div className="scene-error-badge" role="alert">
          <span className="scene-error-icon" aria-hidden="true">
            âš ï¸
          </span>
          <span className="scene-error-text">{t('scene.status.image_error')}</span>
        </div>
      )}

      {/* Placeholder ì˜ì—­ - ì²˜ë¦¬ ì¤‘ì¼ ë•ŒëŠ” ì˜¤ë²„ë ˆì´ë§Œ í‘œì‹œ, ë¶„ì„ ì¤‘ì¼ ë•ŒëŠ” ë¯¸í‘œì‹œ */}
      {isPlaceholderVisible && placeholder && !isProcessing && (
        <div className="scene-placeholder">
          <p className="text-glow scene-status-label">
            <span className="scene-status-emoji" aria-hidden="true">
              {placeholder.fallbackEmoji}
            </span>{' '}
            {t(placeholder.labelKey)}
          </p>
          {message && <p className="scene-status-message">{message}</p>}
        </div>
      )}
    </div>
  );
}
</file>

<file path="frontend/src/stores/economyStore.ts">
/**
 * Unknown World - Economy ìƒíƒœ ê´€ë¦¬ (Zustand) (U-014[Mvp]).
 *
 * Signal/Memory Shard ì¬í™” HUDì™€ í„´ë³„ ë¹„ìš©/ì”ì•¡ ë³€í™”ë¥¼
 * **ê±°ë˜ ì¥ë¶€(ledger)**ë¡œ ì¶”ì í•˜ì—¬ "ë¹„ìš©/ì§€ì—°ì„ ê²Œì„ ë©”ì»¤ë‹‰"ìœ¼ë¡œ UXì— ë°˜ì˜í•©ë‹ˆë‹¤.
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - RULE-005: Economy ì¸ë°”ë¦¬ì–¸íŠ¸ (ì”ì•¡ ìŒìˆ˜ ê¸ˆì§€, ì˜ˆìƒ ë¹„ìš© ì‚¬ì „ í‘œì‹œ)
 *   - RULE-008: ë¹„ìš©/ëª¨ë¸ ì„ íƒ ì´ìœ ëŠ” ë¼ë²¨(FAST/QUALITY/REF)ë¡œë§Œ ì„¤ëª…
 *   - Q1 ê²°ì •: Option A - ìµœê·¼ Ní„´ë§Œ ë³´ê´€ (UI/ë©”ëª¨ë¦¬ ì ˆê°)
 *   - RU-004-Q5: ìƒìˆ˜ëŠ” save/constants.tsì—ì„œ ì¤‘ì•™ ê´€ë¦¬
 *
 * @module stores/economyStore
 */

import { create } from 'zustand';
import type { CurrencyAmount, ModelLabel, CostEstimate } from '../schemas/turn';
// RU-004-Q5: ìƒìˆ˜ ì¤‘ì•™í™” - constants.tsì—ì„œ import
import { LEDGER_MAX_ENTRIES, LOW_BALANCE_THRESHOLD } from '../save/constants';

// RU-004-Q5: ìƒìˆ˜ re-export (ê¸°ì¡´ í˜¸ì¶œì í˜¸í™˜ì„± ìœ ì§€)
export { LEDGER_MAX_ENTRIES };

// =============================================================================
// íƒ€ì… ì •ì˜
// =============================================================================

/**
 * ê±°ë˜ ì¥ë¶€(Ledger) ì—”íŠ¸ë¦¬.
 * ê° í„´ì—ì„œ ë°œìƒí•œ ë¹„ìš©ê³¼ ì”ì•¡ ë³€í™”ë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤.
 */
export interface LedgerEntry {
  /** í„´ ID (í„´ ì¹´ìš´íŠ¸) */
  turnId: number;
  /** ì•¡ì…˜ ID (ì„ íƒëœ ì¹´ë“œ ID, ì„ íƒì‚¬í•­) */
  actionId?: string;
  /** ë¹„ìš© ì‚¬ìœ  (ì˜ˆ: "íƒìƒ‰", "ì´ë¯¸ì§€ ìƒì„±") */
  reason: string;
  /** ì†Œë¹„ëœ ë¹„ìš© */
  cost: CurrencyAmount;
  /** ì†Œë¹„ í›„ ì”ì•¡ */
  balanceAfter: CurrencyAmount;
  /** ëª¨ë¸ ë¼ë²¨ (FAST/QUALITY/CHEAP/REF) */
  modelLabel?: ModelLabel;
  /** ì”ì•¡ ë¶€ì¡± ê²½ê³  ì—¬ë¶€ (U-079) */
  lowBalanceWarning?: boolean;
  /** ê¸°ë¡ ì‹œê°„ */
  timestamp: number;
}

/**
 * ì˜ˆìƒ ë¹„ìš© ìƒíƒœ.
 * í˜„ì¬ ì„ íƒëœ ì•¡ì…˜ì˜ ì˜ˆìƒ ë¹„ìš©ì„ ì¶”ì í•©ë‹ˆë‹¤.
 */
export interface CostEstimateState {
  /** ìµœì†Œ ì˜ˆìƒ ë¹„ìš© */
  min: CurrencyAmount;
  /** ìµœëŒ€ ì˜ˆìƒ ë¹„ìš© */
  max: CurrencyAmount;
  /** ì˜ˆìƒ ë¹„ìš©ì„ ê³„ì‚°í•œ ì•¡ì…˜ ID */
  actionId?: string;
  /** ì˜ˆìƒ ë¹„ìš© ë¼ë²¨/ì„¤ëª… */
  label?: string;
}

/**
 * ë§ˆì§€ë§‰ í™•ì • ë¹„ìš© ìƒíƒœ.
 * ê°€ì¥ ìµœê·¼ í„´ì—ì„œ í™•ì •ëœ ë¹„ìš© ì •ë³´ì…ë‹ˆë‹¤.
 */
export interface LastCostState {
  /** í™•ì •ëœ ë¹„ìš© */
  cost: CurrencyAmount;
  /** í™•ì • í›„ ì”ì•¡ */
  balanceAfter: CurrencyAmount;
  /** í„´ ID */
  turnId: number;
  /** ëª¨ë¸ ë¼ë²¨ */
  modelLabel?: ModelLabel;
}

/** Economy Store ìƒíƒœ */
export interface EconomyStoreState {
  /** ê±°ë˜ ì¥ë¶€ (ìµœê·¼ Nê°œ ì—”íŠ¸ë¦¬, ìµœì‹ ìˆœ) */
  ledger: LedgerEntry[];
  /** í˜„ì¬ ì˜ˆìƒ ë¹„ìš© (ì„ íƒí•œ ì•¡ì…˜ ê¸°ë°˜) */
  costEstimate: CostEstimateState | null;
  /** ë§ˆì§€ë§‰ í™•ì • ë¹„ìš© */
  lastCost: LastCostState | null;
  /** ì”ì•¡ ë¶€ì¡± ê²½ê³  ì—¬ë¶€ */
  isBalanceLow: boolean;
  /** ì”ì•¡ ë¶€ì¡± ì„ê³„ê°’ (Signal ê¸°ì¤€) */
  lowBalanceThreshold: number;
}

/** Economy Store ì•¡ì…˜ */
export interface EconomyStoreActions {
  /**
   * í„´ ì™„ë£Œ ì‹œ ê±°ë˜ ì¥ë¶€ì— ì—”íŠ¸ë¦¬ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
   */
  addLedgerEntry: (entry: Omit<LedgerEntry, 'timestamp'>) => void;

  /**
   * ê±°ë˜ ì¥ë¶€ë¥¼ ì™¸ë¶€ ë°ì´í„°ë¡œ ì£¼ì…í•©ë‹ˆë‹¤.
   *
   * - ledgerëŠ” ì „ë‹¬ëœ ìˆœì„œ(ìµœì‹ ìˆœ)ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
   * - timestampëŠ” ì „ë‹¬ëœ ê°’ì„ ë³´ì¡´í•©ë‹ˆë‹¤.
   * - lastCostëŠ” ìµœì‹  ì—”íŠ¸ë¦¬(ì²« ì›ì†Œ) ê¸°ì¤€ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
   * - isBalanceLowëŠ” ì „ë‹¬ëœ currentBalanceë¡œ ì¬ê³„ì‚°í•©ë‹ˆë‹¤.
   *
   * @param ledger - ê±°ë˜ ì¥ë¶€ ë°°ì—´ (ìµœì‹ ìˆœ, timestamp í¬í•¨)
   * @param currentBalance - í˜„ì¬ ì”ì•¡ (isBalanceLow ê³„ì‚°ìš©)
   */
  hydrateLedger: (ledger: LedgerEntry[], currentBalance: CurrencyAmount) => void;

  /**
   * ì˜ˆìƒ ë¹„ìš©ì„ ì„¤ì •í•©ë‹ˆë‹¤ (ì¹´ë“œ ì„ íƒ/í˜¸ë²„ ì‹œ).
   */
  setCostEstimate: (estimate: CostEstimateState | null) => void;

  /**
   * ì¹´ë“œì˜ ë¹„ìš© ì •ë³´ë¡œ ì˜ˆìƒ ë¹„ìš©ì„ ì„¤ì •í•©ë‹ˆë‹¤.
   */
  setCostEstimateFromCard: (
    cost: CurrencyAmount,
    costEstimate: CostEstimate | null,
    actionId: string,
    label?: string,
  ) => void;

  /**
   * ë§ˆì§€ë§‰ í™•ì • ë¹„ìš©ì„ ì„¤ì •í•©ë‹ˆë‹¤ (TurnOutput ë°˜ì˜ ì‹œ).
   */
  setLastCost: (lastCost: LastCostState) => void;

  /**
   * ì”ì•¡ ë¶€ì¡± ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
   */
  updateBalanceLowStatus: (currentBalance: CurrencyAmount) => void;

  /**
   * ì”ì•¡ ë¶€ì¡± ì„ê³„ê°’ì„ ì„¤ì •í•©ë‹ˆë‹¤.
   */
  setLowBalanceThreshold: (threshold: number) => void;

  /**
   * ê±°ë˜ ì¥ë¶€ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
   */
  clearLedger: () => void;

  /**
   * ì „ì²´ ìƒíƒœë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
   */
  reset: () => void;
}

export type EconomyStore = EconomyStoreState & EconomyStoreActions;

// =============================================================================
// ì´ˆê¸° ìƒíƒœ
// =============================================================================

function createInitialState(): EconomyStoreState {
  // U-116: ì´ˆê¸° ìƒíƒœëŠ” ë¹ˆ ê±°ë˜ ì¥ë¶€ (ë”ë¯¸ ë°ì´í„° ì œê±°)
  return {
    ledger: [],
    costEstimate: null,
    lastCost: null,
    isBalanceLow: false,
    // RU-004-Q5: ì„ê³„ê°’ ìƒìˆ˜ SSOT (save/constants.ts)
    lowBalanceThreshold: LOW_BALANCE_THRESHOLD,
  };
}

// =============================================================================
// Zustand Store
// =============================================================================

/**
 * Economy ìƒíƒœ ìŠ¤í† ì–´.
 *
 * í„´ë³„ ë¹„ìš©/ì”ì•¡ ë³€í™”ë¥¼ ê±°ë˜ ì¥ë¶€(ledger)ìœ¼ë¡œ ì¶”ì í•˜ê³ ,
 * ì˜ˆìƒ ë¹„ìš©ê³¼ í™•ì • ë¹„ìš©ì„ UIì— ì œê³µí•©ë‹ˆë‹¤.
 *
 * @example
 * ```tsx
 * // ì˜ˆìƒ ë¹„ìš© ì„¤ì • (ì¹´ë“œ í˜¸ë²„ ì‹œ)
 * const setCostEstimateFromCard = useEconomyStore(s => s.setCostEstimateFromCard);
 * setCostEstimateFromCard(card.cost, card.cost_estimate, card.id, card.label);
 *
 * // í„´ ì™„ë£Œ ì‹œ ê±°ë˜ ì¥ë¶€ ê¸°ë¡
 * const addLedgerEntry = useEconomyStore(s => s.addLedgerEntry);
 * addLedgerEntry({
 *   turnId: turnCount,
 *   reason: 'explore',
 *   cost: turnOutput.economy.cost,
 *   balanceAfter: turnOutput.economy.balance_after,
 * });
 * ```
 */
export const useEconomyStore = create<EconomyStore>((set, get) => ({
  // ì´ˆê¸° ìƒíƒœ
  ...createInitialState(),

  // ì•¡ì…˜

  addLedgerEntry: (entry) => {
    const timestamp = Date.now();
    const newEntry: LedgerEntry = { ...entry, timestamp };

    set((state) => {
      // ìµœì‹ ìˆœìœ¼ë¡œ ì¶”ê°€í•˜ê³  ìµœëŒ€ ê°œìˆ˜ ìœ ì§€ (Q1: Option A)
      const updatedLedger = [newEntry, ...state.ledger].slice(0, LEDGER_MAX_ENTRIES);

      return {
        ledger: updatedLedger,
        lastCost: {
          cost: entry.cost,
          balanceAfter: entry.balanceAfter,
          turnId: entry.turnId,
          modelLabel: entry.modelLabel,
        },
        // U-079: ì„œë²„ì—ì„œ ì „ë‹¬ëœ ê²½ê³  ìƒíƒœ ë°˜ì˜
        isBalanceLow: entry.lowBalanceWarning ?? state.isBalanceLow,
        // í„´ ì™„ë£Œ í›„ ì˜ˆìƒ ë¹„ìš© ì´ˆê¸°í™”
        costEstimate: null,
      };
    });
  },

  hydrateLedger: (ledger, currentBalance) => {
    const { lowBalanceThreshold } = get();

    // LEDGER_MAX_ENTRIES ì •ì±… ì ìš© (ì €ì¥ëœ ê²ƒì´ ë” ë§ì„ ê²½ìš° ëŒ€ë¹„)
    const hydratedLedger = ledger.slice(0, LEDGER_MAX_ENTRIES);

    // lastCostëŠ” ê°€ì¥ ìµœì‹  ì—”íŠ¸ë¦¬(ì²« ì›ì†Œ) ê¸°ì¤€ìœ¼ë¡œ ì„¤ì •
    const latestEntry = hydratedLedger[0] ?? null;
    const lastCost: LastCostState | null = latestEntry
      ? {
          cost: latestEntry.cost,
          balanceAfter: latestEntry.balanceAfter,
          turnId: latestEntry.turnId,
          modelLabel: latestEntry.modelLabel,
        }
      : null;

    // isBalanceLowëŠ” ë³µì›ëœ ì”ì•¡ ê¸°ì¤€ìœ¼ë¡œ ì¬ê³„ì‚°
    const isBalanceLow = currentBalance.signal < lowBalanceThreshold;

    set({
      ledger: hydratedLedger,
      lastCost,
      isBalanceLow,
      costEstimate: null,
    });
  },

  setCostEstimate: (estimate) => {
    set({ costEstimate: estimate });
  },

  setCostEstimateFromCard: (cost, costEstimate, actionId, label) => {
    if (costEstimate) {
      set({
        costEstimate: {
          min: costEstimate.min,
          max: costEstimate.max,
          actionId,
          label,
        },
      });
    } else {
      // cost_estimateê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ costë¥¼ min/maxë¡œ ì‚¬ìš©
      set({
        costEstimate: {
          min: cost,
          max: cost,
          actionId,
          label,
        },
      });
    }
  },

  setLastCost: (lastCost) => {
    set({ lastCost });
  },

  updateBalanceLowStatus: (currentBalance) => {
    const { lowBalanceThreshold } = get();
    const isLow = currentBalance.signal < lowBalanceThreshold;
    set({ isBalanceLow: isLow });
  },

  setLowBalanceThreshold: (threshold) => {
    set({ lowBalanceThreshold: threshold });
  },

  clearLedger: () => {
    set({ ledger: [], lastCost: null });
  },

  reset: () => {
    set(createInitialState());
  },
}));

// =============================================================================
// ì…€ë ‰í„° (ì„±ëŠ¥ ìµœì í™”ìš©)
// =============================================================================

/** ê±°ë˜ ì¥ë¶€ ì…€ë ‰í„° */
export const selectLedger = (state: EconomyStore) => state.ledger;

/** ì˜ˆìƒ ë¹„ìš© ì…€ë ‰í„° */
export const selectCostEstimate = (state: EconomyStore) => state.costEstimate;

/** ë§ˆì§€ë§‰ í™•ì • ë¹„ìš© ì…€ë ‰í„° */
export const selectLastCost = (state: EconomyStore) => state.lastCost;

/** ì”ì•¡ ë¶€ì¡± ìƒíƒœ ì…€ë ‰í„° */
export const selectIsBalanceLow = (state: EconomyStore) => state.isBalanceLow;

/** ìµœê·¼ Nê°œ ê±°ë˜ ì¥ë¶€ ì—”íŠ¸ë¦¬ ì…€ë ‰í„° */
export const selectRecentLedger =
  (count: number) =>
  (state: EconomyStore): LedgerEntry[] =>
    state.ledger.slice(0, count);

/** ì´ ì†Œë¹„ ë¹„ìš© ê³„ì‚° ì…€ë ‰í„° (í˜„ì¬ ì„¸ì…˜) */
export const selectTotalSpent = (state: EconomyStore): CurrencyAmount => {
  return state.ledger.reduce(
    (acc, entry) => ({
      signal: acc.signal + entry.cost.signal,
      memory_shard: acc.memory_shard + entry.cost.memory_shard,
    }),
    { signal: 0, memory_shard: 0 },
  );
};

// =============================================================================
// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
// =============================================================================

/**
 * í˜„ì¬ ì”ì•¡ìœ¼ë¡œ ì˜ˆìƒ ë¹„ìš©ì„ ê°ë‹¹í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
 * RULE-005: ì”ì•¡ ë¶€ì¡± ì‹œ ì‹¤í–‰ ê°•í–‰ì´ ì•„ë‹ˆë¼ ëŒ€ì²´ í–‰ë™ì„ ì œì•ˆ.
 */
export function canAffordCost(
  balance: CurrencyAmount,
  cost: CurrencyAmount,
): { affordable: boolean; shortfall: CurrencyAmount } {
  const signalShortfall = Math.max(0, cost.signal - balance.signal);
  const shardShortfall = Math.max(0, cost.memory_shard - balance.memory_shard);

  return {
    affordable: signalShortfall === 0 && shardShortfall === 0,
    shortfall: { signal: signalShortfall, memory_shard: shardShortfall },
  };
}

/**
 * ì˜ˆìƒ ë¹„ìš©ì˜ ìµœëŒ€ê°’ìœ¼ë¡œ ê°ë‹¹ ê°€ëŠ¥ ì—¬ë¶€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
 */
export function canAffordEstimate(
  balance: CurrencyAmount,
  estimate: CostEstimateState,
): { affordable: boolean; shortfall: CurrencyAmount } {
  return canAffordCost(balance, estimate.max);
}

// DEV: ë””ë²„ê·¸ìš© ê¸€ë¡œë²Œ ë…¸ì¶œ
if (import.meta.env.DEV && typeof window !== 'undefined') {
  (window as unknown as Record<string, unknown>).__economyStore = useEconomyStore;
}
</file>

<file path="frontend/src/api/turnStream.ts">
/**
 * Unknown World - HTTP Streaming í´ë¼ì´ì–¸íŠ¸ + NDJSON íŒŒì„œ.
 *
 * fetch ê¸°ë°˜ìœ¼ë¡œ POST ìš”ì²­ì„ ë³´ë‚´ê³  ì‘ë‹µ ìŠ¤íŠ¸ë¦¼ì„ NDJSONìœ¼ë¡œ íŒŒì‹±í•©ë‹ˆë‹¤.
 * ì¤‘ê°„ ì²­í¬ íŒŒì‹± ì‹¤íŒ¨ê°€ ì „ì²´ UIë¥¼ ë©ˆì¶”ì§€ ì•Šë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - RULE-003: êµ¬ì¡°í™” ì¶œë ¥(JSON Schema) ìš°ì„  + ì´ì¤‘ ê²€ì¦
 *   - RULE-004: ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì•ˆì „ í´ë°± ì œê³µ
 *   - RULE-008: ë‹¨ê³„/ë°°ì§€ ê°€ì‹œí™” (í”„ë¡¬í”„íŠ¸/ë‚´ë¶€ ì¶”ë¡  ë…¸ì¶œ ê¸ˆì§€)
 *   - RULE-011: ë°±ì—”ë“œ í¬íŠ¸ 8011 ì‚¬ìš©
 *
 * @module api/turnStream
 */

import type { TurnInput, TurnOutput, Language } from '../schemas/turn';
import { safeParseTurnOutput } from '../schemas/turn';
import type { StreamCallbacks } from '../types/turn_stream';
import {
  StreamEventType,
  BaseEventSchema,
  safeParseStageEvent,
  safeParseRepairEvent,
  safeParseBadgesEvent,
  safeParseNarrativeDeltaEvent,
  safeParseFinalEventRaw,
  safeParseErrorEvent,
  normalizeStageStatus,
} from '../types/turn_stream';

// Re-export ìŠ¤íŠ¸ë¦¼ ì´ë²¤íŠ¸ íƒ€ì…ë“¤ (í•˜ìœ„ í˜¸í™˜ì„± ìœ ì§€)
export type {
  StreamEventTypeName,
  StageStatusName,
  StageEvent,
  RepairEvent,
  BadgesEvent,
  NarrativeDeltaEvent,
  FinalEvent,
  ErrorEvent,
  StreamEvent,
  StreamCallbacks,
} from '../types/turn_stream';
export { StreamEventType, StageStatus } from '../types/turn_stream';

// =============================================================================
// NDJSON íŒŒì„œ (Q1 ê²°ì •: Option A - ì§ì ‘ êµ¬í˜„)
// =============================================================================

/**
 * NDJSON ë¼ì¸ íŒŒì„œ.
 * ë¶€ë¶„ ì²­í¬ë¥¼ ë²„í¼ë§í•˜ê³  ì™„ì „í•œ ë¼ì¸ì„ íŒŒì‹±í•©ë‹ˆë‹¤.
 */
export class NDJSONParser {
  private buffer = '';

  /**
   * ì²­í¬ë¥¼ íŒŒì‹±í•˜ê³  ì™„ì „í•œ JSON ê°ì²´ë“¤ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
   *
   * @param chunk - ìˆ˜ì‹ ëœ í…ìŠ¤íŠ¸ ì²­í¬
   * @returns íŒŒì‹±ëœ JSON ê°ì²´ ë°°ì—´
   */
  parse(chunk: string): unknown[] {
    this.buffer += chunk;
    const results: unknown[] = [];

    // ì¤„ë°”ê¿ˆìœ¼ë¡œ ë¶„í• 
    const lines = this.buffer.split('\n');

    // ë§ˆì§€ë§‰ ë¼ì¸ì€ ë¶ˆì™„ì „í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë²„í¼ì— ìœ ì§€
    this.buffer = lines.pop() ?? '';

    for (const line of lines) {
      const trimmed = line.trim();
      if (trimmed === '') continue;

      try {
        const parsed = JSON.parse(trimmed);
        results.push(parsed);
      } catch {
        // íŒŒì‹± ì‹¤íŒ¨ ì‹œ í•´ë‹¹ ë¼ì¸ ë¬´ì‹œ (RULE-004: ì „ì²´ ì¤‘ë‹¨ ë°©ì§€)
        console.warn('[NDJSON] Failed to parse line:', trimmed);
      }
    }

    return results;
  }

  /**
   * ë²„í¼ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
   */
  reset(): void {
    this.buffer = '';
  }

  /**
   * ë‚¨ì€ ë²„í¼ë¥¼ í”ŒëŸ¬ì‹œí•˜ê³  ë§ˆì§€ë§‰ ê°ì²´ë¥¼ íŒŒì‹±í•©ë‹ˆë‹¤.
   */
  flush(): unknown | null {
    const trimmed = this.buffer.trim();
    this.buffer = '';

    if (trimmed === '') return null;

    try {
      return JSON.parse(trimmed);
    } catch {
      console.warn('[NDJSON] Failed to parse remaining buffer:', trimmed);
      return null;
    }
  }
}

// =============================================================================
// ìŠ¤íŠ¸ë¦¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
// =============================================================================

/**
 * íŒŒì‹±ëœ ì´ë²¤íŠ¸ë¥¼ íƒ€ì…ë³„ë¡œ ë¶„ë°°í•©ë‹ˆë‹¤.
 *
 * RU-002-S2: ìºìŠ¤íŒ… ëŒ€ì‹  Zod safeParseë¥¼ ì ìš©í•˜ì—¬ ê²€ì¦ ê°•í™”.
 * Unknown/í™•ì¥ ì´ë²¤íŠ¸ëŠ” UIë¥¼ ë©ˆì¶”ì§€ ì•Šê³  ê²½ê³ ë§Œ ì¶œë ¥.
 * U-063: economySnapshot íŒŒë¼ë¯¸í„° ì¶”ê°€ - í´ë°± ì‹œì—ë„ ì¬í™” ì”ì•¡ ìœ ì§€.
 *
 * @param event - íŒŒì‹±ëœ ì´ë²¤íŠ¸ ê°ì²´
 * @param callbacks - ì½œë°± í•¨ìˆ˜ë“¤
 * @param language - í´ë°± ì–¸ì–´
 * @param economySnapshot - í˜„ì¬ ì¬í™” ìŠ¤ëƒ…ìƒ· (í´ë°± ì‹œ ì”ì•¡ ìœ ì§€)
 */
function dispatchEvent(
  event: unknown,
  callbacks: StreamCallbacks,
  language: Language,
  economySnapshot: { signal: number; memory_shard: number },
): void {
  if (!event || typeof event !== 'object') return;

  // ê¸°ë³¸ ì´ë²¤íŠ¸ íƒ€ì… ì¶”ì¶œ
  const baseResult = BaseEventSchema.safeParse(event);
  if (!baseResult.success) {
    console.warn('[TurnStream] Invalid event format (no type field):', event);
    return;
  }

  const type = baseResult.data.type;

  switch (type) {
    case StreamEventType.STAGE: {
      // RU-002-S2: stage ì´ë²¤íŠ¸ ê²€ì¦
      const stageResult = safeParseStageEvent(event);
      if (stageResult.success) {
        // status ì •ê·œí™”: 'ok' â†’ 'complete'
        const normalizedStatus = normalizeStageStatus(stageResult.data.status);
        callbacks.onStage?.({
          type: StreamEventType.STAGE,
          name: stageResult.data.name,
          status: normalizedStatus,
        });
      } else {
        console.warn('[TurnStream] Invalid stage event:', stageResult.error.message);
      }
      break;
    }

    case StreamEventType.REPAIR: {
      // RU-002-S2: repair ì´ë²¤íŠ¸ ê²€ì¦
      const repairResult = safeParseRepairEvent(event);
      if (repairResult.success) {
        callbacks.onRepair?.(repairResult.data);
      } else {
        console.warn('[TurnStream] Invalid repair event:', repairResult.error.message);
      }
      break;
    }

    case StreamEventType.BADGES: {
      // RU-002-S2: badges ì´ë²¤íŠ¸ ê²€ì¦ (v1/v2 ì •ê·œí™” í¬í•¨)
      const badgesResult = safeParseBadgesEvent(event);
      if (badgesResult.success) {
        callbacks.onBadges?.(badgesResult.data);
      } else {
        console.warn('[TurnStream] Invalid badges event:', badgesResult.error.message);
      }
      break;
    }

    case StreamEventType.NARRATIVE_DELTA: {
      // RU-002-S2: narrative_delta ì´ë²¤íŠ¸ ê²€ì¦
      const narrativeResult = safeParseNarrativeDeltaEvent(event);
      if (narrativeResult.success) {
        callbacks.onNarrativeDelta?.(narrativeResult.data);
      } else {
        console.warn('[TurnStream] Invalid narrative_delta event:', narrativeResult.error.message);
      }
      break;
    }

    case StreamEventType.FINAL: {
      // RU-002-S2: final ì´ë²¤íŠ¸ êµ¬ì¡° ê²€ì¦
      const finalRawResult = safeParseFinalEventRaw(event);
      if (!finalRawResult.success) {
        console.warn('[TurnStream] Invalid final event structure:', finalRawResult.error.message);
        // U-063: êµ¬ì¡°ê°€ ì˜ëª»ë˜ì–´ë„ í´ë°± ì œê³µ (ì¬í™” ì”ì•¡ ìœ ì§€)
        callbacks.onFinal?.({
          type: StreamEventType.FINAL,
          data: createFallbackTurnOutput(language, economySnapshot),
        });
        break;
      }

      // RULE-003/004: Zod strict parse + í´ë°±
      // U-063: economySnapshot ì „ë‹¬í•˜ì—¬ í´ë°± ì‹œì—ë„ ì¬í™” ì”ì•¡ ìœ ì§€
      const turnOutputPayload = finalRawResult.data.data;
      const parseResult = safeParseTurnOutput(turnOutputPayload, language, 0, economySnapshot);

      if (parseResult.success) {
        callbacks.onFinal?.({
          type: StreamEventType.FINAL,
          data: parseResult.data,
        });
      } else {
        console.warn('[TurnStream] TurnOutput validation failed:', parseResult.error);
        callbacks.onFinal?.({
          type: StreamEventType.FINAL,
          data: parseResult.fallback,
        });
      }
      break;
    }

    case StreamEventType.ERROR: {
      // RU-002-S2: error ì´ë²¤íŠ¸ ê²€ì¦
      const errorResult = safeParseErrorEvent(event);
      if (errorResult.success) {
        callbacks.onError?.(errorResult.data);
      } else {
        console.warn('[TurnStream] Invalid error event:', errorResult.error.message);
        // U-044: ì—ëŸ¬ ì´ë²¤íŠ¸ê°€ ê¹¨ì§„ ê²½ìš°ì—ë„ ê¸°ë³¸ ì—ëŸ¬ ì „ë‹¬ (i18n ë©”ì‹œì§€ ì‚¬ìš©)
        callbacks.onError?.({
          type: StreamEventType.ERROR,
          message: getErrorMessage('unknown_error', language),
          code: 'INVALID_ERROR_EVENT',
        });
      }
      break;
    }

    default:
      // RU-002-S2: Unknown/í™•ì¥ ì´ë²¤íŠ¸ëŠ” UIë¥¼ ë©ˆì¶”ì§€ ì•Šê³  ê²½ê³ ë§Œ ì¶œë ¥
      // í–¥í›„ protocol, repair, telemetry ë“± í™•ì¥ ì´ë²¤íŠ¸ ë„ì… ì‹œ ì—¬ê¸°ì„œ ì²˜ë¦¬ ê°€ëŠ¥
      console.warn('[TurnStream] Unknown/ignored event type:', type, event);
  }
}

// =============================================================================
// U-044: i18n ì—ëŸ¬/í´ë°± ë©”ì‹œì§€ (Q2: Option B - translation.json í‚¤ ì‚¬ìš©)
// =============================================================================

/**
 * U-044: ì—ëŸ¬ ë©”ì‹œì§€ ë²ˆì—­ ë¦¬ì†ŒìŠ¤.
 * í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë°œìƒí•˜ëŠ” ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ì–¸ì–´ë³„ë¡œ ì œê³µí•©ë‹ˆë‹¤.
 *
 * ì£¼ì˜: turnStream.tsëŠ” React ì»´í¬ë„ŒíŠ¸ê°€ ì•„ë‹ˆë¯€ë¡œ useTranslation ì‚¬ìš© ë¶ˆê°€.
 * ëŒ€ì‹  language ë§¤ê°œë³€ìˆ˜ë¡œ ë¶„ê¸° ì²˜ë¦¬í•©ë‹ˆë‹¤.
 * translation.jsonì˜ í‚¤ì™€ ë™ê¸°í™” ìœ ì§€ í•„ìš” (error.* ë„¤ì„ìŠ¤í˜ì´ìŠ¤).
 */
const ERROR_MESSAGES: Record<string, Record<Language, string>> = {
  // ì—ëŸ¬ ì´ë²¤íŠ¸ íŒŒì‹± ì‹¤íŒ¨
  unknown_error: {
    'ko-KR': 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
    'en-US': 'An unknown error occurred.',
  },
  // ì‘ë‹µ ë°ì´í„° ì²˜ë¦¬ ì‹¤íŒ¨ (final ì´ë²¤íŠ¸ ìŠ¤í‚¤ë§ˆ ê²€ì¦ ì‹¤íŒ¨)
  response_processing: {
    'ko-KR': '[ì‹œìŠ¤í…œ] ì‘ë‹µ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
    'en-US': '[System] An error occurred while processing response data.',
  },
  // ì„œë²„ ì—°ê²° ì‹¤íŒ¨ (ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬)
  connection_failed: {
    'ko-KR': '[ì‹œìŠ¤í…œ] ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.',
    'en-US': '[System] Failed to connect to server. Please try again.',
  },
};

/**
 * U-044: ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ì–¸ì–´ì— ë§ê²Œ ë°˜í™˜í•©ë‹ˆë‹¤.
 */
function getErrorMessage(key: string, language: Language): string {
  return ERROR_MESSAGES[key]?.[language] ?? ERROR_MESSAGES[key]?.['en-US'] ?? key;
}

/**
 * í´ë¼ì´ì–¸íŠ¸ ì¸¡ í´ë°± TurnOutput ìƒì„± (ì–¸ì–´ + ìŠ¤ëƒ…ìƒ· ì§€ì •).
 * dispatchEvent ë‚´ë¶€ì—ì„œ ì‚¬ìš©í•˜ëŠ” ê°„ë‹¨í•œ í´ë°±.
 * U-044: í•˜ë“œì½”ë”© ë©”ì‹œì§€ ì œê±°, i18n ë¦¬ì†ŒìŠ¤ ì‚¬ìš©.
 * U-063: economySnapshot íŒŒë¼ë¯¸í„° ì¶”ê°€ - í´ë°±ì—ì„œë„ ì¬í™” ì”ì•¡ ìœ ì§€ (RULE-005).
 */
function createFallbackTurnOutput(
  language: Language,
  economySnapshot?: { signal: number; memory_shard: number },
): TurnOutput {
  const fallbackNarrative = getErrorMessage('response_processing', language);

  // U-063: í´ë°±ì—ì„œë„ ì¬í™” ì”ì•¡ ìœ ì§€ (RULE-005)
  const balanceAfter = economySnapshot
    ? { signal: economySnapshot.signal, memory_shard: economySnapshot.memory_shard }
    : { signal: 100, memory_shard: 5 }; // ê¸°ë³¸ê°’ (í”„ë¡œí•„ ë¯¸ë¡œë“œ ìƒíƒœì˜ placeholder)

  return {
    language,
    narrative: fallbackNarrative,
    economy: {
      cost: { signal: 0, memory_shard: 0 },
      balance_after: balanceAfter,
      credit: 0,
      low_balance_warning: false,
    },
    safety: {
      blocked: false,
      message: null,
    },
    ui: {
      action_deck: { cards: [] },
      objects: [],
      scene: { image_url: null, alt_text: null },
    },
    world: {
      rules_changed: [],
      inventory_added: [],
      inventory_removed: [],
      quests_updated: [],
      relationships_changed: [],
      memory_pins: [],
    },
    render: {
      image_job: null,
      image_url: null,
      image_id: null,
      generation_time_ms: null,
    },
    agent_console: {
      current_phase: 'commit',
      badges: ['schema_fail'],
      repair_count: 1,
      model_label: 'FAST',
    },
  };
}

// =============================================================================
// API ì„¤ì •
// =============================================================================

/** ë°±ì—”ë“œ API URL (RULE-011: í¬íŠ¸ 8011) */
const API_BASE_URL = 'http://localhost:8011';

/** í„´ ìŠ¤íŠ¸ë¦¼ API ì—”ë“œí¬ì¸íŠ¸ */
const TURN_ENDPOINT = `${API_BASE_URL}/api/turn`;

// =============================================================================
// ìŠ¤íŠ¸ë¦¼ í´ë¼ì´ì–¸íŠ¸
// =============================================================================

/** ìŠ¤íŠ¸ë¦¼ ìš”ì²­ ì˜µì…˜ */
export interface TurnStreamOptions {
  /** ìš”ì²­ íƒ€ì„ì•„ì›ƒ (ms) */
  timeout?: number;
  /** AbortSignal */
  signal?: AbortSignal;
}

/**
 * í„´ ìŠ¤íŠ¸ë¦¼ ìš”ì²­ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
 *
 * @param input - í„´ ì…ë ¥ ë°ì´í„°
 * @param callbacks - ì´ë²¤íŠ¸ ì½œë°±
 * @param options - ìš”ì²­ ì˜µì…˜
 * @returns ì·¨ì†Œ í•¨ìˆ˜
 */
export async function executeTurnStream(
  input: TurnInput,
  callbacks: StreamCallbacks,
  options?: TurnStreamOptions,
): Promise<void> {
  const parser = new NDJSONParser();
  const controller = new AbortController();
  const signal = options?.signal ?? controller.signal;

  // RU-002-S1: AbortError ë°œìƒ ì‹œ onComplete í˜¸ì¶œ ì—¬ë¶€ ì¶”ì 
  let aborted = false;

  try {
    const response = await fetch(TURN_ENDPOINT, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Accept: 'application/x-ndjson',
      },
      body: JSON.stringify(input),
      signal,
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    if (!response.body) {
      throw new Error('Response body is null');
    }

    const reader = response.body.getReader();
    const decoder = new TextDecoder('utf-8');

    // ìŠ¤íŠ¸ë¦¼ ì½ê¸° ë£¨í”„
    // U-063: economySnapshotì„ dispatchEventì— ì „ë‹¬í•˜ì—¬ í´ë°± ì‹œ ì¬í™” ì”ì•¡ ìœ ì§€
    while (true) {
      const { done, value } = await reader.read();

      if (done) break;

      const chunk = decoder.decode(value, { stream: true });
      const events = parser.parse(chunk);

      for (const event of events) {
        dispatchEvent(event, callbacks, input.language, input.economy_snapshot);
      }
    }

    // ë‚¨ì€ ë²„í¼ í”ŒëŸ¬ì‹œ
    const remaining = parser.flush();
    if (remaining) {
      dispatchEvent(remaining, callbacks, input.language, input.economy_snapshot);
    }
  } catch (error) {
    if (error instanceof DOMException && error.name === 'AbortError') {
      // RU-003-S1: Abort(ì·¨ì†Œ) ì •ì±…
      // =========================================================================
      // í˜„ì¬ ì •ì±…(Option B): Abort ì‹œ onCompleteë¥¼ í˜¸ì¶œí•˜ì§€ ì•ŠìŒ
      // - ì´ìœ : ì·¨ì†ŒëŠ” "ì‚¬ìš©ì ì˜ë„"ì´ë¯€ë¡œ ì‹¤íŒ¨ì™€ êµ¬ë¶„í•´ì•¼ í•¨
      // - ì£¼ì˜: ì´ ì •ì±…ì—ì„œëŠ” Cancel ë²„íŠ¼ êµ¬í˜„ ì‹œ í˜¸ì¶œìê°€ ì§ì ‘ UI ë³µêµ¬ í•„ìš”
      //
      // í–¥í›„ Option Aë¡œ ì „í™˜ ê°€ëŠ¥:
      // - Abort ì‹œì—ë„ onComplete í˜¸ì¶œ + ë³„ë„ í”Œë˜ê·¸ë¡œ "ì·¨ì†Œ ì¢…ë£Œ" êµ¬ë¶„
      // - ì¥ì : UIê°€ ë©ˆì¶”ì§€ ì•ŠìŒ (ë³µêµ¬ ì¼ê´€ì„±)
      // - ë‹¨ì : ì·¨ì†Œì™€ ì‹¤íŒ¨ë¥¼ êµ¬ë¶„í•˜ë ¤ë©´ ì´ë²¤íŠ¸ ëª¨ë¸ í™•ì¥ í•„ìš”
      //
      // ê²°ì • ê·¼ê±°: RU-003-S1 Step 3
      // =========================================================================
      aborted = true;
      return;
    }

    const errorMessage = error instanceof Error ? error.message : 'Unknown error occurred';

    // RU-002-S1: ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ì‹œì—ë„ onError í˜¸ì¶œ
    callbacks.onError?.({
      type: StreamEventType.ERROR,
      message: errorMessage,
      code: 'STREAM_ERROR',
    });

    // RU-002-S1: ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ì‹œ í´ë¼ì´ì–¸íŠ¸ ì¸¡ í´ë°± final ìƒì„±
    // ì„œë²„ì—ì„œ finalì´ ì˜¤ì§€ ëª»í•œ ê²½ìš° UIê°€ ë©ˆì¶”ì§€ ì•Šë„ë¡ í•¨
    const fallback = createClientFallbackTurnOutput(input.language, input.economy_snapshot);
    callbacks.onFinal?.({
      type: StreamEventType.FINAL,
      data: fallback,
    });
  } finally {
    // RU-002-S1: ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ ì¸ë°”ë¦¬ì–¸íŠ¸ - ì„±ê³µ/ì‹¤íŒ¨ ëª¨ë‘ì—ì„œ onComplete í˜¸ì¶œ ë³´ì¥
    if (!aborted) {
      callbacks.onComplete?.();
    }
  }
}

/**
 * í´ë¼ì´ì–¸íŠ¸ ì¸¡ í´ë°± TurnOutput ìƒì„± (RU-002-S1).
 * ì„œë²„ì—ì„œ finalì´ ì˜¤ì§€ ëª»í•œ ê²½ìš° (ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ë“±) ì‚¬ìš©í•©ë‹ˆë‹¤.
 * EconomyëŠ” ìš”ì²­ ì§ì „ ìŠ¤ëƒ…ìƒ·ì„ ê·¸ëŒ€ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.
 * U-044: í•˜ë“œì½”ë”© ë©”ì‹œì§€ ì œê±°, i18n ë¦¬ì†ŒìŠ¤ ì‚¬ìš©.
 */
function createClientFallbackTurnOutput(
  language: Language,
  economySnapshot: { signal: number; memory_shard: number },
): TurnOutput {
  const fallbackNarrative = getErrorMessage('connection_failed', language);

  return {
    language,
    narrative: fallbackNarrative,
    economy: {
      cost: { signal: 0, memory_shard: 0 },
      // RU-002-S1: ì…ë ¥ ìŠ¤ëƒ…ìƒ· ê·¸ëŒ€ë¡œ ìœ ì§€ (ë¹„ìš© 0, ì”ì•¡ ë³€í™” ì—†ìŒ)
      balance_after: {
        signal: economySnapshot.signal,
        memory_shard: economySnapshot.memory_shard,
      },
      credit: 0,
      low_balance_warning: false,
    },
    safety: {
      blocked: false,
      message: null,
    },
    ui: {
      action_deck: { cards: [] },
      objects: [],
      scene: { image_url: null, alt_text: null },
    },
    world: {
      rules_changed: [],
      inventory_added: [],
      inventory_removed: [],
      quests_updated: [],
      relationships_changed: [],
      memory_pins: [],
    },
    render: {
      image_job: null,
      image_url: null,
      image_id: null,
      generation_time_ms: null,
    },
    agent_console: {
      current_phase: 'commit',
      badges: ['schema_fail'],
      repair_count: 1,
      model_label: 'FAST',
    },
  };
}

/**
 * í„´ ìŠ¤íŠ¸ë¦¼ì„ ì‹œì‘í•˜ê³  ì·¨ì†Œ í•¨ìˆ˜ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
 *
 * @param input - í„´ ì…ë ¥ ë°ì´í„°
 * @param callbacks - ì´ë²¤íŠ¸ ì½œë°±
 * @returns ì·¨ì†Œ í•¨ìˆ˜
 */
export function startTurnStream(input: TurnInput, callbacks: StreamCallbacks): () => void {
  const controller = new AbortController();

  executeTurnStream(input, callbacks, { signal: controller.signal });

  return () => controller.abort();
}
</file>

<file path="frontend/src/components/InventoryPanel.test.tsx">
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen } from '@testing-library/react';
import { InventoryPanel } from './InventoryPanel';
import { useInventoryStore } from '../stores/inventoryStore';

// i18next ëª¨í‚¹
vi.mock('react-i18next', () => ({
  useTranslation: () => ({
    t: (key: string) => key,
    i18n: {
      language: 'ko',
    },
  }),
  initReactI18next: {
    type: '3rdParty',
    init: () => {},
  },
}));

// dnd-kit ëª¨í‚¹
// useDraggableì´ ë°˜í™˜í•˜ëŠ” attributes, listenersê°€ ìµœìƒìœ„ divì— ì ìš©ë˜ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•¨
vi.mock('@dnd-kit/core', async (importOriginal) => {
  const actual = await importOriginal<typeof import('@dnd-kit/core')>();
  return {
    ...actual,
    useDraggable: vi.fn(({ id }) => ({
      attributes: { role: 'button', 'aria-describedby': `DndDescribedBy-${id}` },
      listeners: { onPointerDown: vi.fn() },
      setNodeRef: vi.fn(),
      transform: null,
      isDragging: false,
    })),
    DragOverlay: ({ children }: { children: React.ReactNode }) => (
      <div data-testid="drag-overlay">{children}</div>
    ),
  };
});

describe('InventoryPanel (U-117)', () => {
  beforeEach(() => {
    useInventoryStore.getState().reset();
  });

  it('should apply drag listeners and attributes to the entire row div', () => {
    // í…ŒìŠ¤íŠ¸ ì•„ì´í…œ ì¶”ê°€
    useInventoryStore.getState().addItems([
      {
        id: 'test-item-1',
        name: 'Test Item 1',
        quantity: 1,
        icon: 'ğŸ“¦',
      },
    ]);

    render(<InventoryPanel />);

    // ì•„ì´í…œ Row ì°¾ê¸°
    const itemRow = screen.getByRole('listbox').children[0];

    // U-117: ìµœìƒìœ„ div(itemRow)ì— ë“œë˜ê·¸ ì†ì„±ì´ ì ìš©ë˜ì–´ì•¼ í•¨
    expect(itemRow).toHaveAttribute('role', 'button');
    expect(itemRow).toHaveAttribute('aria-describedby', 'DndDescribedBy-test-item-1');

    // í´ë˜ìŠ¤ í™•ì¸ (inventory-item í´ë˜ìŠ¤ê°€ ìˆì–´ì•¼ í•¨)
    expect(itemRow).toHaveClass('inventory-item');
  });

  it('should render only the icon in DragOverlay when dragging', () => {
    // 1. ì•„ì´í…œ ì¶”ê°€
    const testItem = {
      id: 'test-drag-item',
      name: 'Dragging Item',
      quantity: 1,
      icon: 'ğŸ”¥',
    };
    useInventoryStore.getState().addItems([testItem]);

    // 2. ë“œë˜ê·¸ ìƒíƒœë¡œ ì„¤ì •
    useInventoryStore.getState().startDrag(testItem.id);

    render(<InventoryPanel />);

    // 3. DragOverlay ë‚´ë¶€ í™•ì¸
    const overlay = screen.getByTestId('drag-overlay');

    // U-117: ê³ ìŠ¤íŠ¸ ì´ë¯¸ì§€ëŠ” ì•„ì´ì½˜ë§Œ í‘œì‹œë˜ì–´ì•¼ í•¨ (inventory-overlay-icon í´ë˜ìŠ¤)
    const ghostIcon = overlay.querySelector('.inventory-overlay-icon');
    expect(ghostIcon).toBeInTheDocument();
    expect(ghostIcon).toHaveTextContent('ğŸ”¥');

    // ì´ë¦„ì´ë‚˜ ë‹¤ë¥¸ ì •ë³´ê°€ ì˜¤ë²„ë ˆì´ì— í¬í•¨ë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸
    expect(ghostIcon).not.toHaveTextContent('Dragging Item');
  });
});
</file>

<file path="frontend/src/components/SceneCanvas.tsx">
/**
 * Unknown World - Scene Canvas ì»´í¬ë„ŒíŠ¸
 *
 * RULE-002 ì¤€ìˆ˜: ì±„íŒ… ë²„ë¸”ì´ ì•„ë‹Œ ê²Œì„ UI
 * RULE-009 ì¤€ìˆ˜: ì¢Œí‘œ ê·œì•½ (0~1000 ì •ê·œí™”, bbox=[ymin,xmin,ymax,xmax])
 *
 * U-010[Mvp]: í•«ìŠ¤íŒŸ ì˜¤ë²„ë ˆì´ + í´ë¦­ ì²˜ë¦¬
 * - TurnOutputì˜ objects[]/hotspots[]ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì˜¤ë²„ë ˆì´ ë Œë”
 * - hover ì‹œ í•˜ì´ë¼ì´íŠ¸/íˆ´íŒ í‘œì‹œ
 * - click ì‹œ object_id + box_2dë¥¼ TurnInputì— í¬í•¨í•´ ì „ì†¡
 *
 * U-012[Mvp]: DnD ë“œë¡­ íƒ€ê²Ÿ í™•ì¥
 * - í•«ìŠ¤íŒŸì„ droppable ì˜ì—­ìœ¼ë¡œ ë§Œë“¤ì–´ ì¸ë²¤í† ë¦¬ ì•„ì´í…œ ë“œë¡­ ì²˜ë¦¬
 * - ë“œë˜ê·¸ ì˜¤ë²„ ì‹œ í•˜ì´ë¼ì´íŠ¸ ê°•í™”
 * - ë“œë¡­ ì„±ê³µ/ì‹¤íŒ¨ ì¦‰ì‹œ ì‹œê°í™”
 *
 * U-020[Mvp]: ì´ë¯¸ì§€ Lazy Render (placeholder/í´ë°±)
 * - RULE-004/008 ì¤€ìˆ˜: í…ìŠ¤íŠ¸ ìš°ì„  + Lazy ì´ë¯¸ì§€ ì •ì±…
 * - Q1 Option A: ì´ì „ ì´ë¯¸ì§€ ìœ ì§€ + ë¡œë”© ì¸ë””ì¼€ì´í„° í‘œì‹œ
 * - ì´ë¯¸ì§€ ì‹¤íŒ¨ ì‹œì—ë„ í•«ìŠ¤íŒŸ/íŒ¨ë„/ë¡œê·¸ëŠ” ê³„ì† ë™ì‘ (í…ìŠ¤íŠ¸-only ì§„í–‰)
 *
 * U-058[Mvp]: í•«ìŠ¤íŒŸ ë””ìì¸ ê°œì„ 
 * - Q1 Option C: Magenta/Purple ê³„ì—´ ê°•ì¡°
 * - Q2 Option A: Lì ë¸Œë¼ì¼“ ì½”ë„ˆ ë§ˆì»¤
 * - Hotspot ì»´í¬ë„ŒíŠ¸ ë¶„ë¦¬ë¡œ ì‹œê°ì  í’ˆì§ˆ í–¥ìƒ
 *
 * @module components/SceneCanvas
 */

import { useState, useRef, useCallback, useEffect, useMemo } from 'react';
import { useTranslation } from 'react-i18next';
import { type CanvasSize } from '../utils/box2d';
import { isHotspotInteractionAllowed, compareHotspotPriority } from '../dnd/types';
import { useWorldStore } from '../stores/worldStore';
import { useAgentStore } from '../stores/agentStore';
import { SceneImage } from './SceneImage';
import { Hotspot, type HotspotClickData } from './Hotspot';

// =============================================================================
// íƒ€ì… ì •ì˜ (Re-export for backward compatibility)
// =============================================================================

export type { HotspotClickData };

interface SceneCanvasProps {
  /** í•«ìŠ¤íŒŸ í´ë¦­ ì½œë°± */
  onHotspotClick?: (data: HotspotClickData) => void;
  /** ìŠ¤íŠ¸ë¦¬ë° ì¤‘ ì—¬ë¶€ (ë¹„í™œì„±í™”ìš©, ìƒëµ ì‹œ agentStore.isStreaming ì‚¬ìš©) */
  disabled?: boolean;
}

// =============================================================================
// ë©”ì¸ ì»´í¬ë„ŒíŠ¸
// =============================================================================

/**
 * Scene Canvas ì»´í¬ë„ŒíŠ¸
 *
 * U-010[Mvp]: í•«ìŠ¤íŒŸ ì˜¤ë²„ë ˆì´ + í´ë¦­ ì²˜ë¦¬
 * U-020[Mvp]: Lazy Render (placeholder/í´ë°±)
 * U-031[Mvp]: Placeholder Pack
 *
 * - ìƒíƒœì— ë”°ë¼ placeholder ì´ë¯¸ì§€ì™€ ë¼ë²¨ì„ í‘œì‹œí•©ë‹ˆë‹¤.
 * - 'scene' ìƒíƒœì—ì„œëŠ” ì‹¤ì œ ì´ë¯¸ì§€ë¥¼ ë Œë”ë§í•˜ë©°, ë¡œë“œ ì‹¤íŒ¨ ì‹œ í´ë°±ì„ ì œê³µí•©ë‹ˆë‹¤.
 * - U-020: Q1 Option A - ì´ì „ ì´ë¯¸ì§€ ìœ ì§€ + ë¡œë”© ì¸ë””ì¼€ì´í„° í‘œì‹œ
 * - objects ë°°ì—´ì´ ìˆìœ¼ë©´ í•«ìŠ¤íŒŸ ì˜¤ë²„ë ˆì´ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
 */
export function SceneCanvas({ onHotspotClick, disabled: propsDisabled }: SceneCanvasProps) {
  const { t } = useTranslation();

  // Store ìƒíƒœ (RU-003: ì»´í¬ë„ŒíŠ¸ ë‚´ì—ì„œ ì§ì ‘ êµ¬ë…)
  const state = useWorldStore((state) => state.sceneState);
  const objects = useWorldStore((state) => state.sceneObjects);
  const isAnalyzing = useWorldStore((state) => state.isAnalyzing);
  const isStreaming = useAgentStore((state) => state.isStreaming);

  const disabled = propsDisabled ?? isStreaming;

  // U-071: ì²˜ë¦¬ ë‹¨ê³„ ë° ì´ë¯¸ì§€ ë¡œë”© ìƒíƒœ ì¶”ì¶œ
  const { status, imageUrl, message, processingPhase, imageLoading } = state;

  // U-085: Storeì—ì„œ setSceneCanvasSize ê°€ì ¸ì˜¤ê¸° (SSOT)
  const setSceneCanvasSize = useWorldStore((state) => state.setSceneCanvasSize);

  const [canvasSize, setCanvasSize] = useState<CanvasSize>({ width: 0, height: 0 });
  const canvasRef = useRef<HTMLDivElement>(null);

  // RU-003-S2 Step 3: ResizeObserverì— ë””ë°”ìš´ìŠ¤ ì ìš©
  // ë“œë˜ê·¸ ì¤‘ í•«ìŠ¤íŒŸ ì˜ì—­ì´ ê³¼ë„í•˜ê²Œ í”ë“¤ë¦¬ëŠ” ê²ƒì„ ë°©ì§€
  // U-097: ResizeObserver ì½œë°±ì—ì„œëŠ” ë¡œì»¬ ìƒíƒœ(setCanvasSize)ë§Œ ê°±ì‹ í•œë‹¤.
  //        Zustand store ê°±ì‹ (setSceneCanvasSize)ì€ ì•„ë˜ ë³„ë„ useEffectë¡œ ë¶„ë¦¬.
  useEffect(() => {
    const element = canvasRef.current;
    if (!element) return;

    let resizeTimeout: ReturnType<typeof setTimeout> | null = null;
    const RESIZE_DEBOUNCE_MS = 100; // ë””ë°”ìš´ìŠ¤ ê°„ê²©

    const resizeObserver = new ResizeObserver((entries) => {
      // ë””ë°”ìš´ìŠ¤: ë§ˆì§€ë§‰ ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸ í›„ ì¼ì • ì‹œê°„ í›„ì—ë§Œ ì—…ë°ì´íŠ¸
      if (resizeTimeout) {
        clearTimeout(resizeTimeout);
      }
      resizeTimeout = setTimeout(() => {
        for (const entry of entries) {
          const { width, height } = entry.contentRect;
          // ì˜ë¯¸ ìˆëŠ” í¬ê¸° ë³€í™”ë§Œ ì ìš© (5px ì´ìƒ ì°¨ì´)
          setCanvasSize((prev) => {
            if (Math.abs(prev.width - width) > 5 || Math.abs(prev.height - height) > 5) {
              return { width, height };
            }
            return prev;
          });
        }
      }, RESIZE_DEBOUNCE_MS);
    });

    resizeObserver.observe(element);

    // ì´ˆê¸° í¬ê¸° ì„¤ì • (ë¡œì»¬ ìƒíƒœë§Œ)
    const rect = element.getBoundingClientRect();
    setCanvasSize({ width: rect.width, height: rect.height });

    return () => {
      if (resizeTimeout) {
        clearTimeout(resizeTimeout);
      }
      resizeObserver.disconnect();
    };
  }, []);

  // U-097: canvasSize â†’ Zustand store ë™ê¸°í™” (ë³„ë„ ë Œë” ì‚¬ì´í´)
  // Q1 Option A: setSceneCanvasSizeë¥¼ ì˜ì¡´ì„± ë°°ì—´ì— í¬í•¨ (Zustandì˜ setì€ ì•ˆì • ì°¸ì¡°, lint ê²½ê³  ë°©ì§€)
  // ì´ë¡œì¨ useState ì—…ë°ì´í„° ë‚´ë¶€ì—ì„œ ì™¸ë¶€ storeë¥¼ ê°±ì‹ í•˜ëŠ” React ê¸ˆì§€ íŒ¨í„´ì„ íšŒí”¼í•œë‹¤.
  useEffect(() => {
    if (canvasSize.width > 0 && canvasSize.height > 0) {
      setSceneCanvasSize(canvasSize);
    }
  }, [canvasSize, setSceneCanvasSize]);

  // í•«ìŠ¤íŒŸ í´ë¦­ í•¸ë“¤ëŸ¬
  const handleHotspotClick = useCallback(
    (data: HotspotClickData) => {
      if (onHotspotClick) {
        onHotspotClick(data);
      }
    },
    [onHotspotClick],
  );

  // RU-003-S2 Step 1: í•«ìŠ¤íŒŸ ë Œë”ë§ ì¡°ê±´ì„ SSOTë¡œ ê³ ì •
  // - isHotspotInteractionAllowed()ë¡œ í—ˆìš© ìƒíƒœ ê²€ì‚¬ (scene, default)
  // - objects ì¡´ì¬ + ìº”ë²„ìŠ¤ í¬ê¸° í™•ë³´
  // U-020: ì´ë¯¸ì§€ ìœ ë¬´ì™€ ë¬´ê´€í•˜ê²Œ í•«ìŠ¤íŒŸì€ ë™ì‘ (RULE-004)
  const isInteractionAllowed = isHotspotInteractionAllowed(status);
  const shouldRenderHotspots = isInteractionAllowed && objects.length > 0 && canvasSize.width > 0;

  // RU-003-S2: ë°ëª¨ ìƒíƒœ ì—¬ë¶€ (ì‹œê°ì  íŒíŠ¸ í•„ìš”)
  const isDemoState = status === 'default';

  // RU-003-S2 Step 2: í•«ìŠ¤íŒŸì„ ë©´ì  ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ (ì‘ì€ ê²ƒì´ ë’¤ì— = ë†’ì€ z-index)
  const sortedObjects = useMemo(() => {
    if (objects.length <= 1) return objects;
    return [...objects].sort((a, b) => compareHotspotPriority(a.box_2d, b.box_2d));
  }, [objects]);

  return (
    <div ref={canvasRef} className="scene-canvas">
      {/* U-020: ì¥ë©´ ì´ë¯¸ì§€ (Lazy loading + placeholder/í´ë°± í¬í•¨) */}
      {/* U-071: ì²˜ë¦¬ ë‹¨ê³„ ë° ì´ë¯¸ì§€ ìƒì„± ìƒíƒœ ì „ë‹¬ */}
      {/* U-089: ì •ë°€ë¶„ì„ ìƒíƒœ ì „ë‹¬ (ê¸°ì¡´ ì´ë¯¸ì§€ ìœ ì§€ + ë¶„ì„ ì˜¤ë²„ë ˆì´) */}
      <SceneImage
        status={status}
        imageUrl={imageUrl}
        message={message}
        processingPhase={processingPhase}
        isGenerating={imageLoading}
        isAnalyzing={isAnalyzing}
      />

      {/* í•«ìŠ¤íŒŸ ì˜¤ë²„ë ˆì´ ë ˆì´ì–´ (RU-003-S2: ë©´ì ìˆœ ì •ë ¬) */}
      {/* U-020: ì´ë¯¸ì§€ ìœ ë¬´ì™€ ë¬´ê´€í•˜ê²Œ í•«ìŠ¤íŒŸì€ í•­ìƒ ë Œë” (RULE-004) */}
      {/* U-058: Hotspot ì»´í¬ë„ŒíŠ¸ ë¶„ë¦¬ (Magenta í…Œë§ˆ + Lì ì½”ë„ˆ) */}
      {shouldRenderHotspots && (
        <div className="hotspot-layer" aria-label={t('scene.hotspot.layer_label')}>
          {sortedObjects.map((obj, index) => (
            <Hotspot
              key={obj.id}
              object={obj}
              canvasSize={canvasSize}
              onClick={handleHotspotClick}
              disabled={disabled}
              isDemoState={isDemoState}
              // RU-003-S2 Step 2: ì¸ë±ìŠ¤ ê¸°ë°˜ z-indexë¡œ ì‘ì€ ê²ƒì´ ìœ„ì— í‘œì‹œ
              style={{ zIndex: index + 1 }}
            />
          ))}
        </div>
      )}
    </div>
  );
}
</file>

<file path="frontend/src/save/saveGame.ts">
/**
 * Unknown World - Legacy SaveGame ì •ë¦¬ ëª¨ë“ˆ (U-116[Mvp]).
 *
 * SaveGame ì‹œìŠ¤í…œì€ U-116ì—ì„œ ì™„ì „ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.
 * ì´ ëª¨ë“ˆì€ ê¸°ì¡´ ì‚¬ìš©ìì˜ LocalStorageì— ë‚¨ì•„ìˆëŠ” ë ˆê±°ì‹œ ë°ì´í„°ë¥¼
 * ì •ë¦¬í•˜ëŠ” ìœ í‹¸ë¦¬í‹°ë§Œ ì œê³µí•©ë‹ˆë‹¤.
 *
 * MMPì—ì„œ ì„¸ì…˜ ì˜ì†ì„±ì„ ì¬ì„¤ê³„í•  ë•Œ(U-113) ì´ íŒŒì¼ì€ ìƒˆë¡œìš´ ì—­í• ì„ ê°€ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
 *
 * @module save/saveGame
 */

import { LEGACY_SAVEGAME_STORAGE_KEY, LEGACY_PROFILE_STORAGE_KEY } from './constants';

// =============================================================================
// Legacy ë°ì´í„° ì •ë¦¬
// =============================================================================

/**
 * ê¸°ì¡´ SaveGame ë ˆê±°ì‹œ ë°ì´í„°ë¥¼ LocalStorageì—ì„œ ì •ë¦¬í•©ë‹ˆë‹¤.
 *
 * U-116: ë¶€íŒ… ì‹œ 1íšŒ í˜¸ì¶œí•˜ì—¬ ì´ì „ ë²„ì „ì˜ SaveGame ì”ì¬ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
 * - `unknown_world_savegame` í‚¤ ì œê±°
 * - `unknown_world_current_profile` í‚¤ ì œê±°
 *
 * ì–¸ì–´ ì„¤ì •(`unknown_world_language`)ì€ ìœ ì§€í•©ë‹ˆë‹¤ (Q1 Option B).
 */
export function clearLegacySaveData(): void {
  try {
    localStorage.removeItem(LEGACY_SAVEGAME_STORAGE_KEY);
    localStorage.removeItem(LEGACY_PROFILE_STORAGE_KEY);
  } catch (error) {
    console.error('[SaveGame] ë ˆê±°ì‹œ ë°ì´í„° ì •ë¦¬ ì‹¤íŒ¨:', error);
  }
}
</file>

<file path="backend/prompts/turn/turn_output_instructions.en.md">
<prompt_meta>
  <prompt_id>turn_output_instructions</prompt_id>
  <language>en-US</language>
  <version>0.2.0</version>
  <last_updated>2026-01-28</last_updated>
  <policy_preset>default</policy_preset>
</prompt_meta>

<prompt_body>
## Purpose

Specify the rules for each field in the TurnOutput JSON schema.

---

## Required Fields (Hard Gate)

### language
- Value: "en-US" (fixed to match input)
- No mixed language output

### narrative
- Type: string (required)
- Narrative text shown to the player
- 2-3 sentences, written in English
- Present tense, address as "you"

### economy
- Type: object (required)
- cost: Resources consumed this turn {signal: int, memory_shard: int}
- balance_after: Balance after consumption {signal: int, memory_shard: int}
- credit: Used credit (Debt in Signal, int)
- low_balance_warning: Low balance warning flag (boolean)
- **Important**: 
  - balance_after.signal >= 0, balance_after.memory_shard >= 0 (Negative balance strictly forbidden)
  - If the balance is insufficient to pay the cost, reduce `cost` within the balance range or record it in `credit`.
  - Set `low_balance_warning` to true if Signal balance is less than 15.

### safety
- Type: object (required)
- blocked: boolean (whether blocked by safety policy)
- message: string | null (message to display when blocked)

---

## Optional Fields

### ui
- action_deck.cards[]: Action card array (3-6 recommended)
  - id: Unique card ID
  - label: Display label (English)
  - cost: {signal, memory_shard}
  - risk: "low" | "medium" | "high"
  - enabled: boolean
  - is_alternative: boolean (low-cost alternative flag)
- **Precise Analysis Card (U-076)**: When a scene image is present, you MUST include this card:
  - id: "deep_analyze"
  - label: "Precise Analysis"
  - cost: 1.5x the base signal cost (rounded up to integer)
  - risk: "low"
  - enabled: true
  - is_alternative: false
  - Only include this card when the scene has an image
  - Do NOT include this card when there is no image
- objects[]: Clickable scene objects
  - box_2d: {ymin, xmin, ymax, xmax} (0-1000 normalized coordinates)
- **Hotspot (objects) Generation Policy (U-090)**:
  - In normal turns, **NEVER add new objects** to the `objects` array. Always set it to an empty array (`[]`).
  - Hotspots/clickable objects are **ONLY created through the "Precise Analysis" action** on the server side.
  - The GM must NOT fabricate or imagine hotspot coordinates.
  - Previously discovered objects (from prior analysis) are automatically preserved on the client until the scene changes.

### world
- rules_changed[]: Changed world rules
- inventory_added[]: Added item information (U-075[Mvp])
  - id: Unique item ID
  - label: Display label (English)
  - description: Item description (for icon generation)
  - quantity: Quantity (default 1)
- inventory_removed[]: Consumed/removed item ID array
- quests_updated[]: Updated quests (U-078: Objective System Enhancement)
  - id: Unique quest ID
  - label: Quest name (English)
  - is_completed: Whether achieved (boolean)
  - description: Detailed objective description (optional, string | null)
  - is_main: Whether this is the main objective (boolean, default false)
  - progress: Progress percentage (0~100, used for main objective)
  - reward_signal: Signal reward on completion (int, 0 means no reward)
- memory_pins[]: Pin candidates

#### Objective Management Rules (U-078)

Update objective states based on player actions each turn:

1. **One main objective (is_main=true) must always exist.** When the current main objective is completed, create a new one.
2. **Sub-objectives (is_main=false)** serve as step-by-step guides toward the main objective. Keep 3-5 active at a time.
3. **Progress**: Increase progress when player actions contribute to the main objective. Set to 100 when all sub-objectives are complete.
4. **Sub-objective completion**: Set is_completed=true. If reward_signal is set, that Signal amount is automatically awarded (must be reflected in economy.balance_after).
5. **Main objective completion (progress=100)**: Set is_completed=true, award reward_signal, and include a new main objective in quests_updated.
6. **Narrative reflection**: Naturally reflect objective progress/completion in the narrative. (e.g., "The portal's secrets are slowly revealing... (Objective Progress: 40%)")
7. **Reward reflection**: When a sub-objective is completed, add reward_signal to economy.balance_after.signal. Ensure cost and balance_after consistency.

#### Item Consumption (inventory_removed) Rules (U-096)

When a player **drags and drops an inventory item onto a hotspot (drop event)**, follow these rules to determine whether to include the item ID in `inventory_removed`:

1. **Single-use items** (keys, potions, bombs, talismans, data chips, keycards, etc.) MUST be **consumed** after use. Include the item ID in `inventory_removed`.
2. **Tools/reusable items** (hammers, torches, telescopes, lockpicks, etc.) should **remain** in inventory after use. Do NOT include them in `inventory_removed`.
3. The GM determines consumability based on the item's nature and usage context.
4. When an item is consumed, reflect the result naturally in the narrative. (e.g., "You use the key to unlock the door. The key snaps and crumbles away.")
5. When a `drop` input triggers an item effect, the **default behavior is to consume (remove)** the item. Only keep the item if it is clearly reusable.
6. **Quantity-based Consumption**: For stackable items with a quantity, including the item ID once in `inventory_removed` reduces the quantity by 1. The item is only fully removed from the inventory if its quantity becomes 0.

#### Currency Acquisition Path Diversification (U-079)

When the player's Signal balance is low (balance_after.signal < 15), **actively provide currency earning opportunities**:

1. **Currency Earning Action Cards**: Include 1-2 action cards of the following types (cost 0 or very cheap):
   - Exploration/Discovery: "Search the surroundings" (cost: {signal: 0, memory_shard: 0})
   - Trade/Reward: "Talk to the strange merchant" (cost: {signal: 0, memory_shard: 0})
   - Challenge/Achievement: "Attempt the trial" (cost: {signal: 2, memory_shard: 0}, high reward on success)
   - Prefix these card IDs with `earn_` for identification (e.g., `earn_search`, `earn_trade`, `earn_challenge`)
   - The GM should create currency earning cards that feel natural within the world and current situation
2. **Item Selling Hint**: When the player has items in inventory and balance is low, naturally hint at the **possibility of selling** in the narrative. (e.g., "You might have something worth trading in your belongings...")
3. **Sub-objective Reward Utilization**: When balance is low, guide the player towards sub-objectives with rewards (reward_signal > 0) as a priority.
4. **Narrative Hints**: When balance is very low (signal < 5), weave currency earning opportunities into the narrative naturally. (e.g., "Something faintly glowing catches your eye on the ground...")

### render
- image_job: Image generation job (optional)
  - should_generate: boolean
  - prompt: Image prompt (English preferred)

### agent_console
- current_phase: Current phase
- badges[]: Validation badges
- repair_count: Number of repair attempts

---

## Coordinate Convention (RULE-009)

- All coordinates use 0-1000 normalized coordinate system
- bbox order: [ymin, xmin, ymax, xmax]
- Do not use pixel coordinates

---

## Example Output

```json
{
  "language": "en-US",
  "narrative": "The old door creaks open. Cold air rushes out from within.",
  "economy": {
    "cost": {"signal": 5, "memory_shard": 0},
    "balance_after": {"signal": 95, "memory_shard": 5}
  },
  "safety": {"blocked": false, "message": null},
  "ui": {
    "action_deck": {
      "cards": [
        {"id": "enter", "label": "Step inside", "cost": {"signal": 10, "memory_shard": 0}, "risk": "medium", "enabled": true, "is_alternative": false},
        {"id": "peek", "label": "Peek cautiously", "cost": {"signal": 3, "memory_shard": 0}, "risk": "low", "enabled": true, "is_alternative": true}
      ]
    },
    "objects": []
  },
  "world": {
    "rules_changed": [],
    "inventory_added": [
      {
        "id": "iron_key",
        "label": "Iron Key",
        "description": "A heavy, rusted iron key.",
        "quantity": 1
      }
    ],
    "inventory_removed": [],
    "quests_updated": [],
    "memory_pins": []
  },
  "render": {"image_job": null},
  "agent_console": {"current_phase": "commit", "badges": ["schema_ok", "economy_ok", "safety_ok"], "repair_count": 0}
}
```
</prompt_body>
</file>

<file path="backend/prompts/turn/turn_output_instructions.ko.md">
<prompt_meta>
  <prompt_id>turn_output_instructions</prompt_id>
  <language>ko-KR</language>
  <version>0.2.0</version>
  <last_updated>2026-01-28</last_updated>
  <policy_preset>default</policy_preset>
</prompt_meta>

<prompt_body>
## ëª©ì 

TurnOutput JSON ìŠ¤í‚¤ë§ˆì˜ ê° í•„ë“œ ì‘ì„± ê·œì¹™ì„ ëª…ì‹œí•©ë‹ˆë‹¤.

---

## í•„ìˆ˜ í•„ë“œ (Hard Gate)

### language
- ê°’: "ko-KR" (ì…ë ¥ê³¼ ë™ì¼í•˜ê²Œ ê³ ì •)
- í˜¼í•© ì¶œë ¥ ê¸ˆì§€

### narrative
- íƒ€ì…: string (í•„ìˆ˜)
- í”Œë ˆì´ì–´ì—ê²Œ ë³´ì—¬ì¤„ ë‚´ëŸ¬í‹°ë¸Œ í…ìŠ¤íŠ¸
- 2~3ë¬¸ì¥, í•œêµ­ì–´ë¡œ ì‘ì„±
- í˜„ì¬ ì‹œì œ, "ë‹¹ì‹ " ì§€ì¹­

### economy
- íƒ€ì…: object (í•„ìˆ˜)
- cost: ì´ë²ˆ í„´ì— ì†Œë¹„ëœ ë¹„ìš© {signal: int, memory_shard: int}
- balance_after: ì†Œë¹„ í›„ ì”ì•¡ {signal: int, memory_shard: int}
- credit: ì‚¬ìš© ì¤‘ì¸ í¬ë ˆë”§ (ë¹š, Signal ë‹¨ìœ„, int)
- low_balance_warning: ì”ì•¡ ë¶€ì¡± ê²½ê³  ì—¬ë¶€ (boolean)
- **ì¤‘ìš”**: 
  - balance_after.signal >= 0, balance_after.memory_shard >= 0 (ìŒìˆ˜ ì ˆëŒ€ ë¶ˆê°€)
  - ì”ì•¡ì´ ë¶€ì¡±í•˜ì—¬ ë¹„ìš©ì„ ì§€ë¶ˆí•  ìˆ˜ ì—†ëŠ” ê²½ìš°, `cost`ë¥¼ ì”ì•¡ ë²”ìœ„ ë‚´ë¡œ ë‚®ì¶”ê±°ë‚˜ `credit`ì„ ê¸°ë¡í•˜ì„¸ìš”.
  - Signal ì”ì•¡ì´ 15 ë¯¸ë§Œì´ë©´ `low_balance_warning`ì„ trueë¡œ ì„¤ì •í•©ë‹ˆë‹¤.

### safety
- íƒ€ì…: object (í•„ìˆ˜)
- blocked: boolean (ì•ˆì „ ì •ì±… ì°¨ë‹¨ ì—¬ë¶€)
- message: string | null (ì°¨ë‹¨ ì‹œ í‘œì‹œí•  ë©”ì‹œì§€)

---

## ì„ íƒ í•„ë“œ

### ui
- action_deck.cards[]: ì•¡ì…˜ ì¹´ë“œ ë°°ì—´ (3~6ì¥ ê¶Œì¥)
  - id: ì¹´ë“œ ê³ ìœ  ID
  - label: í‘œì‹œ ë¼ë²¨ (í•œêµ­ì–´)
  - cost: {signal, memory_shard}
  - risk: "low" | "medium" | "high"
  - enabled: boolean
  - is_alternative: boolean (ì €ë¹„ìš© ëŒ€ì•ˆ ì—¬ë¶€)
- **ì •ë°€ë¶„ì„ ì¹´ë“œ (U-076)**: ì´ë¯¸ì§€ê°€ ì¡´ì¬í•˜ëŠ” ì¥ë©´ì—ì„œëŠ” ë°˜ë“œì‹œ ë‹¤ìŒ ì¹´ë“œë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤:
  - id: "deep_analyze"
  - label: "ì •ë°€ë¶„ì„"
  - cost: ê¸°ë³¸ signal ë¹„ìš©ì˜ 1.5ë°° (ì •ìˆ˜ë¡œ ì˜¬ë¦¼)
  - risk: "low"
  - enabled: true
  - is_alternative: false
  - ì´ ì¹´ë“œëŠ” ì´ë¯¸ì§€ê°€ **ìˆëŠ”** ì¥ë©´ì—ì„œë§Œ ìƒì„±í•©ë‹ˆë‹¤
  - ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ì´ ì¹´ë“œë¥¼ í¬í•¨í•˜ì§€ ë§ˆì‹­ì‹œì˜¤
- objects[]: í´ë¦­ ê°€ëŠ¥í•œ ì¥ë©´ ì˜¤ë¸Œì íŠ¸
  - box_2d: {ymin, xmin, ymax, xmax} (0~1000 ì •ê·œí™” ì¢Œí‘œ)
- **í•«ìŠ¤íŒŸ(objects) ìƒì„± ì •ì±… (U-090)**:
  - ì¼ë°˜ í„´ì—ì„œëŠ” `objects` ë°°ì—´ì— **ìƒˆë¡œìš´ ì˜¤ë¸Œì íŠ¸ë¥¼ ì ˆëŒ€ ì¶”ê°€í•˜ì§€ ì•ŠëŠ”ë‹¤**. í•­ìƒ ë¹ˆ ë°°ì—´(`[]`)ë¡œ ì„¤ì •í•œë‹¤.
  - í•«ìŠ¤íŒŸ/í´ë¦­ ê°€ëŠ¥ ì˜¤ë¸Œì íŠ¸ëŠ” **"ì •ë°€ë¶„ì„" ì•¡ì…˜ì„ í†µí•´ì„œë§Œ** ì„œë²„ ì¸¡ì—ì„œ ìƒì„±ëœë‹¤.
  - GMì´ ì„ì˜ë¡œ í•«ìŠ¤íŒŸ ì¢Œí‘œë¥¼ ìƒì„±í•˜ê±°ë‚˜ ìƒìƒí•˜ì—¬ ì¶”ê°€í•˜ëŠ” ê²ƒì€ ê¸ˆì§€í•œë‹¤.
  - ì´ì „ ì •ë°€ë¶„ì„ì—ì„œ ì¶”ê°€ëœ ì˜¤ë¸Œì íŠ¸ëŠ” **ì¥ë©´ì´ ì™„ì „íˆ ë°”ë€Œì§€ ì•ŠëŠ” í•œ** í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìë™ìœ¼ë¡œ ìœ ì§€ëœë‹¤.

### world
- rules_changed[]: ë³€ê²½ëœ ì„¸ê³„ ê·œì¹™
- inventory_added[]: ì¶”ê°€ëœ ì•„ì´í…œ ì •ë³´ (U-075[Mvp])
  - id: ì•„ì´í…œ ê³ ìœ  ID
  - label: í‘œì‹œ ì´ë¦„ (í•œêµ­ì–´)
  - description: ì•„ì´í…œ ì„¤ëª… (ì•„ì´ì½˜ ìƒì„±ìš©)
  - quantity: ìˆ˜ëŸ‰ (ê¸°ë³¸ 1)
- inventory_removed[]: ì œê±°(ì†Œë¹„)ëœ ì•„ì´í…œ ID ë°°ì—´
- quests_updated[]: ì—…ë°ì´íŠ¸ëœ í€˜ìŠ¤íŠ¸ (U-078: ëª©í‘œ ì‹œìŠ¤í…œ ê°•í™”)
  - id: í€˜ìŠ¤íŠ¸ ê³ ìœ  ID
  - label: í€˜ìŠ¤íŠ¸ ì´ë¦„ (í•œêµ­ì–´)
  - is_completed: ë‹¬ì„± ì—¬ë¶€ (boolean)
  - description: ëª©í‘œ ìƒì„¸ ì„¤ëª… (ì„ íƒ, string | null)
  - is_main: ì£¼ ëª©í‘œ ì—¬ë¶€ (boolean, ê¸°ë³¸ false)
  - progress: ì§„í–‰ë¥  (0~100, ì£¼ ëª©í‘œì—ì„œ ì‚¬ìš©)
  - reward_signal: ë‹¬ì„± ì‹œ Signal ë³´ìƒëŸ‰ (int, 0ì´ë©´ ë³´ìƒ ì—†ìŒ)
- memory_pins[]: ê³ ì • í›„ë³´

#### ëª©í‘œ ê´€ë¦¬ ê·œì¹™ (U-078)

ë§¤ í„´ í”Œë ˆì´ì–´ í–‰ë™ì— ë”°ë¼ ëª©í‘œ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤:

1. **ì£¼ ëª©í‘œ(is_main=true)ëŠ” í•­ìƒ í•˜ë‚˜** ì¡´ì¬í•´ì•¼ í•©ë‹ˆë‹¤. í˜„ì¬ ì£¼ ëª©í‘œê°€ ì™„ë£Œë˜ë©´ ìƒˆ ì£¼ ëª©í‘œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
2. **ì„œë¸Œ ëª©í‘œ(is_main=false)**ëŠ” ì£¼ ëª©í‘œ ë‹¬ì„±ì„ ìœ„í•œ ë‹¨ê³„ë³„ ê°€ì´ë“œì…ë‹ˆë‹¤. í•œ ë²ˆì— ìµœëŒ€ 3~5ê°œë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
3. **ì§„í–‰ë¥ (progress)**: í”Œë ˆì´ì–´ í–‰ë™ì´ ì£¼ ëª©í‘œì— ê¸°ì—¬í•  ë•Œ progressë¥¼ ì˜¬ë¦½ë‹ˆë‹¤. ëª¨ë“  ì„œë¸Œ ëª©í‘œê°€ ì™„ë£Œë˜ë©´ 100ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
4. **ì„œë¸Œ ëª©í‘œ ë‹¬ì„± ì‹œ**: is_completed=trueë¡œ ì„¤ì •í•©ë‹ˆë‹¤. reward_signalì´ ìˆìœ¼ë©´ í•´ë‹¹ Signalì´ ìë™ ì§€ê¸‰ë©ë‹ˆë‹¤ (economy.balance_afterì— ë°˜ì˜ í•„ìˆ˜).
5. **ì£¼ ëª©í‘œ ë‹¬ì„± ì‹œ(progress=100)**: is_completed=trueë¡œ ì„¤ì •í•˜ê³  reward_signalì„ ì§€ê¸‰í•©ë‹ˆë‹¤. ë™ì‹œì— ìƒˆë¡œìš´ ì£¼ ëª©í‘œë¥¼ quests_updatedì— í¬í•¨í•©ë‹ˆë‹¤.
6. **ë‚´ëŸ¬í‹°ë¸Œ ë°˜ì˜**: ëª©í‘œ ë‹¬ì„±/ì§„í–‰ì„ ë‚´ëŸ¬í‹°ë¸Œì— ìì—°ìŠ¤ëŸ½ê²Œ ë°˜ì˜í•©ë‹ˆë‹¤. (ì˜ˆ: "í¬íƒˆì˜ ë¹„ë°€ì´ ì¡°ê¸ˆì”© ë“œëŸ¬ë‚˜ê³  ìˆìŠµë‹ˆë‹¤... (ëª©í‘œ ì§„í–‰: 40%)")
7. **ë³´ìƒ ë°˜ì˜**: ì„œë¸Œ ëª©í‘œ ì™„ë£Œ ì‹œ reward_signalë§Œí¼ economy.balance_after.signalì— ì¶”ê°€í•©ë‹ˆë‹¤. ë°˜ë“œì‹œ costì™€ balance_afterì˜ ì¼ê´€ì„±ì„ ìœ ì§€í•˜ì„¸ìš”.

#### ì•„ì´í…œ ì†Œë¹„(inventory_removed) ê·œì¹™ (U-096)

í”Œë ˆì´ì–´ê°€ ì¸ë²¤í† ë¦¬ ì•„ì´í…œì„ í•«ìŠ¤íŒŸì— **ë“œë˜ê·¸&ë“œë¡­í•˜ì—¬ ì‚¬ìš©(drop ì´ë²¤íŠ¸)**í•˜ë©´, ë‹¤ìŒ ê·œì¹™ì— ë”°ë¼ `inventory_removed`ì— í•´ë‹¹ ì•„ì´í…œ IDë¥¼ í¬í•¨í•©ë‹ˆë‹¤:

1. **ì¼íšŒìš© ì•„ì´í…œ**(ì—´ì‡ , ë¬¼ì•½, í­íƒ„, ë¶€ì , ë°ì´í„°ì¹©, ì¹´ë“œí‚¤ ë“±)ì€ ì‚¬ìš© í›„ **ë°˜ë“œì‹œ ì†Œë¹„**í•©ë‹ˆë‹¤. í•´ë‹¹ ì•„ì´í…œ IDë¥¼ `inventory_removed`ì— í¬í•¨í•˜ì„¸ìš”.
2. **ë„êµ¬/ì¬ì‚¬ìš© ê°€ëŠ¥ ì•„ì´í…œ**(ë§ì¹˜, íšƒë¶ˆ, ë§ì›ê²½, ì ê¸ˆí•´ì œ ë„êµ¬ ë“±)ì€ ì‚¬ìš© í›„ì—ë„ ì¸ë²¤í† ë¦¬ì— **ìœ ì§€**í•©ë‹ˆë‹¤. `inventory_removed`ì— í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.
3. ì†Œë¹„ ì—¬ë¶€ëŠ” ì•„ì´í…œì˜ ì„±ê²©ê³¼ ì‚¬ìš© ë§¥ë½ì— ë”°ë¼ GMì´ íŒë‹¨í•©ë‹ˆë‹¤.
4. ì•„ì´í…œì„ ì‚¬ìš©í•˜ì—¬ íš¨ê³¼ê°€ ë°œìƒí–ˆìœ¼ë©´, ë‚´ëŸ¬í‹°ë¸Œì— í•´ë‹¹ ì•„ì´í…œì˜ ì†Œë¹„/ì‚¬ìš© ê²°ê³¼ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ë°˜ì˜í•˜ì„¸ìš”. (ì˜ˆ: "ì—´ì‡ ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¬¸ì„ ì—´ì—ˆìŠµë‹ˆë‹¤. ì—´ì‡ ê°€ ë¶€ëŸ¬ì ¸ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤.")
5. `drop` ì…ë ¥ì´ ìˆëŠ”ë° ì•„ì´í…œ ì‚¬ìš© íš¨ê³¼ê°€ ë°œìƒí–ˆë‹¤ë©´, ê¸°ë³¸ì ìœ¼ë¡œ í•´ë‹¹ ì•„ì´í…œì€ **ì†Œë¹„(ì œê±°)**í•˜ëŠ” ê²ƒì„ ì›ì¹™ìœ¼ë¡œ í•©ë‹ˆë‹¤. ì¬ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤ê³  íŒë‹¨ë˜ëŠ” ê²½ìš°ì—ë§Œ ìœ ì§€í•©ë‹ˆë‹¤.
6. **ìˆ˜ëŸ‰ ê¸°ë°˜ ì†Œë¹„**: ìˆ˜ëŸ‰ì´ ì—¬ëŸ¬ ê°œì¸ ì•„ì´í…œ(stackable)ì€ `inventory_removed`ì— IDê°€ 1ë²ˆ í¬í•¨ë  ë•Œë§ˆë‹¤ ìˆ˜ëŸ‰ì´ 1ì”© ê°ì†Œí•©ë‹ˆë‹¤. ìˆ˜ëŸ‰ì´ 1ê°œì¸ ê²½ìš°ì—ë§Œ ì¸ë²¤í† ë¦¬ì—ì„œ ì™„ì „íˆ ì œê±°ë©ë‹ˆë‹¤.

#### ì¬í™” íšë“ ê²½ë¡œ ë‹¤ì–‘í™” (U-079)

í”Œë ˆì´ì–´ì˜ Signal ì”ì•¡ì´ ë¶€ì¡±í•  ë•Œ(balance_after.signal < 15), **ì¬í™” íšë“ ê¸°íšŒë¥¼ ì ê·¹ì ìœ¼ë¡œ ì œê³µ**í•©ë‹ˆë‹¤:

1. **ì¬í™” íšë“ ì•¡ì…˜ ì¹´ë“œ**: ë‹¤ìŒê³¼ ê°™ì€ ìœ í˜•ì˜ ì•¡ì…˜ ì¹´ë“œë¥¼ 1~2ì¥ í¬í•¨í•©ë‹ˆë‹¤ (ë¹„ìš© 0 ë˜ëŠ” ë§¤ìš° ì €ë ´í•˜ê²Œ):
   - íƒìƒ‰/ë°œê²¬: "ì£¼ë³€ì„ ìˆ˜ìƒ‰í•œë‹¤" (cost: {signal: 0, memory_shard: 0})
   - ê±°ë˜/ë³´ìƒ: "ì´ìƒí•œ ìƒì¸ê³¼ ëŒ€í™”í•œë‹¤" (cost: {signal: 0, memory_shard: 0})
   - ë„ì „/ì„±ì·¨: "ì‹œë ¨ì— ë„ì „í•œë‹¤" (cost: {signal: 2, memory_shard: 0}, ì„±ê³µ ì‹œ ë³´ìƒ í¼)
   - ì´ëŸ° ì¹´ë“œì˜ IDì—ëŠ” `earn_` ì ‘ë‘ì‚¬ë¥¼ ë¶™ì—¬ êµ¬ë¶„í•©ë‹ˆë‹¤ (ì˜ˆ: `earn_search`, `earn_trade`, `earn_challenge`)
   - GMì€ ì„¸ê³„ê´€ê³¼ í˜„ì¬ ìƒí™©ì— ë§ëŠ” ìì—°ìŠ¤ëŸ¬ìš´ ë°©ì‹ìœ¼ë¡œ ì¬í™” íšë“ ì¹´ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤
2. **ì•„ì´í…œ íŒë§¤ íŒíŠ¸**: í”Œë ˆì´ì–´ ì¸ë²¤í† ë¦¬ì— ì•„ì´í…œì´ ìˆê³  ì”ì•¡ì´ ë¶€ì¡±í•˜ë©´, ë‚´ëŸ¬í‹°ë¸Œì— **íŒë§¤ ê°€ëŠ¥ì„±**ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì•”ì‹œí•©ë‹ˆë‹¤. (ì˜ˆ: "ì£¼ë¨¸ë‹ˆ ì† ë¬¼ê±´ ì¤‘ íŒ” ìˆ˜ ìˆëŠ” ê²ƒì´ ìˆì„ì§€ë„ ëª¨ë¦…ë‹ˆë‹¤.")
3. **ì„œë¸Œ ëª©í‘œ ë³´ìƒ í™œìš©**: ì”ì•¡ ë¶€ì¡± ì‹œ ë³´ìƒì´ ìˆëŠ” ì„œë¸Œ ëª©í‘œ(reward_signal > 0)ë¥¼ ìš°ì„ ì ìœ¼ë¡œ ì§„í–‰í•  ìˆ˜ ìˆë„ë¡ ìœ ë„í•©ë‹ˆë‹¤.
4. **ë‚´ëŸ¬í‹°ë¸Œ íŒíŠ¸**: ì”ì•¡ì´ ë§¤ìš° ë¶€ì¡±í•˜ë©´(signal < 5) ë‚´ëŸ¬í‹°ë¸Œì— ì¬í™” íšë“ ê¸°íšŒë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ë…¹ì…ë‹ˆë‹¤. (ì˜ˆ: "ë°”ë‹¥ì—ì„œ í¬ë¯¸í•˜ê²Œ ë¹›ë‚˜ëŠ” ë¬´ì–¸ê°€ê°€ ëˆˆì— ë•ë‹ˆë‹¤...")

### render
- image_job: ì´ë¯¸ì§€ ìƒì„± ì‘ì—… (ì„ íƒ)
  - should_generate: boolean
  - prompt: ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ (ì˜ì–´ ê¶Œì¥)

### agent_console
- current_phase: í˜„ì¬ ë‹¨ê³„
- badges[]: ê²€ì¦ ë°°ì§€
- repair_count: ë³µêµ¬ ì‹œë„ íšŸìˆ˜

---

## ì¢Œí‘œ ê·œì•½ (RULE-009)

- ëª¨ë“  ì¢Œí‘œëŠ” 0~1000 ì •ê·œí™” ì¢Œí‘œê³„
- bbox ìˆœì„œ: [ymin, xmin, ymax, xmax]
- í”½ì…€ ì¢Œí‘œ ì‚¬ìš© ê¸ˆì§€

---

## ì˜ˆì‹œ ì¶œë ¥

```json
{
  "language": "ko-KR",
  "narrative": "ë‚¡ì€ ë¬¸ì´ ì‚ê±±ê±°ë¦¬ë©° ì—´ë¦½ë‹ˆë‹¤. ì•ˆìª½ì—ì„œ ì°¨ê°€ìš´ ê³µê¸°ê°€ ë°€ë ¤ì˜µë‹ˆë‹¤.",
  "economy": {
    "cost": {"signal": 5, "memory_shard": 0},
    "balance_after": {"signal": 95, "memory_shard": 5}
  },
  "safety": {"blocked": false, "message": null},
  "ui": {
    "action_deck": {
      "cards": [
        {"id": "enter", "label": "ì•ˆìœ¼ë¡œ ë“¤ì–´ê°„ë‹¤", "cost": {"signal": 10, "memory_shard": 0}, "risk": "medium", "enabled": true, "is_alternative": false},
        {"id": "peek", "label": "ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ ì—¿ë³¸ë‹¤", "cost": {"signal": 3, "memory_shard": 0}, "risk": "low", "enabled": true, "is_alternative": true}
      ]
    },
    "objects": []
  },
  "world": {
    "rules_changed": [],
    "inventory_added": [
      {
        "id": "iron_key",
        "label": "ì² ì œ ì—´ì‡ ",
        "description": "ë¬µì§í•˜ê³  ë…¹ìŠ¨ ì² ì œ ì—´ì‡ ì…ë‹ˆë‹¤.",
        "quantity": 1
      }
    ],
    "inventory_removed": [],
    "quests_updated": [],
    "memory_pins": []
  },
  "render": {"image_job": null},
  "agent_console": {"current_phase": "commit", "badges": ["schema_ok", "economy_ok", "safety_ok"], "repair_count": 0}
}
```
</prompt_body>
</file>

<file path="frontend/src/components/ActionDeck.tsx">
/**
 * Unknown World - Action Deck ì»´í¬ë„ŒíŠ¸ (U-009[Mvp]).
 *
 * PRD ìš”êµ¬ì‚¬í•­:
 *   - Action Deck(3~6ì¥ ì¹´ë“œ)ì„ Footer ì˜ì—­ì— ìƒì‹œ ë…¸ì¶œ
 *   - ê° ì¹´ë“œì— ì˜ˆìƒ ë¹„ìš©(ìµœì†Œ/ìµœëŒ€), ìœ„í—˜ë„, ë³´ìƒ íŒíŠ¸ í‘œê¸° (RULE-005)
 *   - ì¹´ë“œ í´ë¦­ ì‹œ TurnInputìœ¼ë¡œ ì„ íƒëœ í–‰ë™ ì „ì†¡ (RULE-008)
 *   - ì”ì•¡ ë¶€ì¡± ì‹œ ì‹¤í–‰ ë¶ˆê°€ í‘œì‹œ + ì €ë¹„ìš© ëŒ€ì•ˆ ë…¸ì¶œ (RULE-005)
 *
 * RULE-002 ì¤€ìˆ˜: ì±„íŒ… ë²„ë¸”/ë©”ì‹œì§€ ë²„íŠ¼ì´ ì•„ë‹Œ "ê²Œì„ ì¹´ë“œ" UI
 *
 * @see vibe/prd.md 6.7 - Action Deck ìš”êµ¬ì‚¬í•­
 * @see .cursor/rules/10-frontend-game-ui.mdc
 * @module components/ActionDeck
 */

import { useMemo, useCallback, useRef, useState } from 'react';
import { useTranslation } from 'react-i18next';
import type { ActionCard } from '../schemas/turn';
import { useActionDeckStore } from '../stores/actionDeckStore';
import { useWorldStore } from '../stores/worldStore';
import { useAgentStore } from '../stores/agentStore';
import { useEconomyStore } from '../stores/economyStore';

// =============================================================================
// ë“œë˜ê·¸ ìŠ¤í¬ë¡¤ í›… (U-049: ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê³  ë“œë˜ê·¸ë¡œ ì´ë™)
// U-063-fix: í´ë¦­ê³¼ ë“œë˜ê·¸ë¥¼ êµ¬ë¶„í•˜ì—¬ ì¹´ë“œ í´ë¦­ì´ ì •ìƒ ë™ì‘í•˜ë„ë¡ ìˆ˜ì •
// =============================================================================

/** ë“œë˜ê·¸ë¡œ ì¸ì‹í•  ìµœì†Œ ì´ë™ ê±°ë¦¬ (í”½ì…€) */
const DRAG_THRESHOLD = 5;

function useDragScroll() {
  const containerRef = useRef<HTMLDivElement>(null);
  const [isDragging, setIsDragging] = useState(false);

  // refë¡œ ê´€ë¦¬í•˜ì—¬ ë¶ˆí•„ìš”í•œ ë¦¬ë Œë”ë§ ë°©ì§€
  const isMouseDownRef = useRef(false);
  const startXRef = useRef(0);
  const scrollLeftRef = useRef(0);
  const hasDraggedRef = useRef(false);

  const handleMouseDown = useCallback((e: React.MouseEvent) => {
    if (!containerRef.current) return;
    // mouseDown ì‹œì—ëŠ” isDraggingì„ ì„¤ì •í•˜ì§€ ì•ŠìŒ (í´ë¦­ í—ˆìš©)
    isMouseDownRef.current = true;
    hasDraggedRef.current = false;
    startXRef.current = e.pageX - containerRef.current.offsetLeft;
    scrollLeftRef.current = containerRef.current.scrollLeft;
  }, []);

  const handleMouseMove = useCallback((e: React.MouseEvent) => {
    if (!isMouseDownRef.current || !containerRef.current) return;

    const x = e.pageX - containerRef.current.offsetLeft;
    const distance = Math.abs(x - startXRef.current);

    // ì„ê³„ê°’ì„ ë„˜ì–´ì•¼ ë“œë˜ê·¸ë¡œ ì¸ì‹
    if (distance > DRAG_THRESHOLD) {
      if (!hasDraggedRef.current) {
        hasDraggedRef.current = true;
        setIsDragging(true);
      }
      e.preventDefault();
      const walk = (x - startXRef.current) * 1.5; // ìŠ¤í¬ë¡¤ ì†ë„ ì¡°ì ˆ
      containerRef.current.scrollLeft = scrollLeftRef.current - walk;
    }
  }, []);

  const handleMouseUp = useCallback(() => {
    isMouseDownRef.current = false;
    // ë“œë˜ê·¸ê°€ ë°œìƒí–ˆìœ¼ë©´ ì•½ê°„ì˜ ì§€ì—° í›„ isDragging í•´ì œ (í´ë¦­ ì´ë²¤íŠ¸ ì°¨ë‹¨ ìœ ì§€)
    if (hasDraggedRef.current) {
      setTimeout(() => {
        setIsDragging(false);
        hasDraggedRef.current = false;
      }, 0);
    }
  }, []);

  const handleMouseLeave = useCallback(() => {
    isMouseDownRef.current = false;
    setIsDragging(false);
    hasDraggedRef.current = false;
  }, []);

  return {
    containerRef,
    isDragging,
    handlers: {
      onMouseDown: handleMouseDown,
      onMouseMove: handleMouseMove,
      onMouseUp: handleMouseUp,
      onMouseLeave: handleMouseLeave,
    },
  };
}

// =============================================================================
// ìƒìˆ˜ ì •ì˜ (U-069: QUALITY íŠ¸ë¦¬ê±° ì•¡ì…˜)
// =============================================================================

/**
 * QUALITY ëª¨ë¸ íŠ¸ë¦¬ê±° ì•¡ì…˜ ID ëª©ë¡ (U-069).
 * ë°±ì—”ë“œ TextModelTiering.QUALITY_TRIGGER_ACTION_IDSì™€ ë™ê¸°í™” í•„ìš”.
 * ì´ ëª©ë¡ì— í¬í•¨ëœ ì•¡ì…˜ì€ QUALITY ë°°ì§€ì™€ 2x ë¹„ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤.
 */
const QUALITY_TRIGGER_ACTION_IDS: ReadonlySet<string> = new Set([
  'deep_investigate',
  'ì •ë°€ì¡°ì‚¬',
  'analyze',
  'examine_closely',
  'investigate_detail',
  'scrutinize',
  'thorough_search',
  'use_magnifier',
  'use_magnifying_glass',
]);

/** QUALITY ëª¨ë¸ ë¹„ìš© ë°°ìˆ˜ (U-069: 2x) */
const QUALITY_COST_MULTIPLIER = 2;

/**
 * VISION(ì •ë°€ë¶„ì„) íŠ¸ë¦¬ê±° ì•¡ì…˜ ID ëª©ë¡ (U-076).
 * ë°±ì—”ë“œ TextModelTiering.VISION_TRIGGER_ACTION_IDSì™€ ë™ê¸°í™” í•„ìš”.
 * ì´ ëª©ë¡ì— í¬í•¨ëœ ì•¡ì…˜ì€ VISION ë°°ì§€ì™€ 1.5x ë¹„ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤.
 */
const VISION_TRIGGER_ACTION_IDS: ReadonlySet<string> = new Set([
  'deep_analyze',
  'ì •ë°€ë¶„ì„',
  'analyze_scene',
  'examine_scene',
  'look_closely',
]);

/** VISION ë¹„ìš© ë°°ìˆ˜ (U-076 Q2: 1.5x) */
const VISION_COST_MULTIPLIER = 1.5;

/**
 * U-079: ì¬í™” íšë“ ì•¡ì…˜ ì¹´ë“œ ID ì ‘ë‘ì‚¬.
 * ì´ ì ‘ë‘ì‚¬ë¡œ ì‹œì‘í•˜ëŠ” ì¹´ë“œëŠ” ì¬í™” íšë“ ì¹´ë“œë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
 */
const EARN_ACTION_PREFIX = 'earn_';

// =============================================================================
// íƒ€ì… ì •ì˜
// =============================================================================

export interface ActionDeckProps {
  /** ì¹´ë“œ í´ë¦­ ì½œë°± */
  onCardClick?: (card: ActionCard) => void;
  /** ì „ì²´ ë¹„í™œì„±í™” (ìŠ¤íŠ¸ë¦¬ë° ì¤‘ ë“±, ìƒëµ ì‹œ agentStore.isStreaming ì‚¬ìš©) */
  disabled?: boolean;
}

interface CardDisplayInfo extends ActionCard {
  /** í´ë¼ì´ì–¸íŠ¸ ì¸¡ ì‹¤í–‰ ê°€ëŠ¥ ì—¬ë¶€ (ì„œë²„ enabledê°€ ì—†ì„ ë•Œ í´ë°±) */
  isAffordable: boolean;
  /** ìµœì¢… ë¹„í™œì„±í™” ì—¬ë¶€ */
  isDisabled: boolean;
  /** ìµœì¢… ë¹„í™œì„±í™” ì‚¬ìœ  */
  finalDisabledReason: string | null;
  /** U-069: QUALITY ëª¨ë¸ ì‚¬ìš© ì—¬ë¶€ */
  isQualityAction: boolean;
  /** U-076: VISION(ì •ë°€ë¶„ì„) ì‚¬ìš© ì—¬ë¶€ */
  isVisionAction: boolean;
  /** U-079: ì¬í™” íšë“ ì•¡ì…˜ ì—¬ë¶€ */
  isEarnAction: boolean;
  /** U-069/U-076: ë°°ìˆ˜ ì ìš©ëœ í‘œì‹œ ë¹„ìš© */
  displayCost: { signal: number; memory_shard: number };
}

// =============================================================================
// ê¸°ë³¸ ì¹´ë“œ ìƒì„± (i18n ê¸°ë°˜)
// =============================================================================

/**
 * ê¸°ë³¸ ì¹´ë“œ ìƒì„± (i18n ê¸°ë°˜) - U-065 ë‹¨ìˆœí™”.
 * U-065: description, cost_estimate, hint, reward_hint, disabled_reason í•„ë“œ ì œê±°ë¨
 */
function useDefaultCards(): ActionCard[] {
  const { t } = useTranslation();

  return useMemo(
    () => [
      {
        id: 'default-explore',
        label: t('action.default.explore.label'),
        cost: { signal: 1, memory_shard: 0 },
        risk: 'low' as const,
        enabled: true,
        is_alternative: false,
      },
      {
        id: 'default-investigate',
        label: t('action.default.investigate.label'),
        cost: { signal: 2, memory_shard: 0 },
        risk: 'medium' as const,
        enabled: true,
        is_alternative: false,
      },
      {
        id: 'default-talk',
        label: t('action.default.talk.label'),
        cost: { signal: 1, memory_shard: 0 },
        risk: 'low' as const,
        enabled: true,
        is_alternative: false,
      },
    ],
    [t],
  );
}

// =============================================================================
// ì¹´ë“œ ë¹„ìš© í‘œì‹œ ì»´í¬ë„ŒíŠ¸
// =============================================================================

interface CardCostDisplayProps {
  card: CardDisplayInfo;
}

/**
 * ë¹„ìš© í‘œì‹œ ì»´í¬ë„ŒíŠ¸ - U-065 ë‹¨ìˆœí™”, U-069 QUALITY ë°°ìˆ˜ ì§€ì›.
 * cost_estimate í•„ë“œ ì œê±°ë¨, displayCost(ë°°ìˆ˜ ì ìš©) ì‚¬ìš©
 */
function CardCostDisplay({ card }: CardCostDisplayProps) {
  const { t } = useTranslation();

  // U-069: displayCost ì‚¬ìš© (QUALITY ì•¡ì…˜ì€ 2x ë°°ìˆ˜ ì ìš©ë¨)
  const costDisplay = `${card.displayCost.signal}`;
  const shardCost = card.displayCost.memory_shard;

  return (
    <div className="action-card-cost" data-ui-importance="critical">
      {/* Signal ë¹„ìš© */}
      <span className="cost-item">
        <span className="icon-wrapper" aria-label={t('economy.signal_cost')}>
          <img
            src="/ui/icons/signal-16.png"
            alt=""
            aria-hidden="true"
            className="icon-img"
            style={{ width: 14, height: 14 }}
            onError={(e) => e.currentTarget.classList.add('hidden')}
          />
          <span className="icon-fallback">{'\u26A1'}</span>
        </span>
        <span
          className={`cost-value ${card.isQualityAction ? 'quality-cost' : ''} ${card.isVisionAction ? 'vision-cost' : ''}`}
        >
          {costDisplay}
          {card.isQualityAction && <span className="cost-multiplier">x2</span>}
          {card.isVisionAction && <span className="cost-multiplier">x1.5</span>}
        </span>
      </span>

      {/* Shard ë¹„ìš© (0ë³´ë‹¤ í´ ë•Œë§Œ í‘œì‹œ) */}
      {shardCost > 0 && (
        <span className="cost-item">
          <span className="cost-separator">|</span>
          <span className="icon-wrapper" aria-label={t('economy.shard_cost')}>
            <img
              src="/ui/icons/shard-16.png"
              alt=""
              aria-hidden="true"
              className="icon-img"
              style={{ width: 14, height: 14 }}
              onError={(e) => e.currentTarget.classList.add('hidden')}
            />
            <span className="icon-fallback">{'\u{1F48E}'}</span>
          </span>
          <span
            className={`cost-value ${card.isQualityAction ? 'quality-cost' : ''} ${card.isVisionAction ? 'vision-cost' : ''}`}
          >
            {shardCost}
            {card.isQualityAction && <span className="cost-multiplier">x2</span>}
            {card.isVisionAction && <span className="cost-multiplier">x1.5</span>}
          </span>
        </span>
      )}

      {/* ìœ„í—˜ë„ */}
      <span className="cost-item">
        <span className="cost-separator">|</span>
        <span className="icon-wrapper" aria-label={t('economy.risk_level')}>
          <img
            src={`/ui/icons/risk-${card.risk}-16.png`}
            alt=""
            aria-hidden="true"
            className={`icon-img risk-${card.risk}`}
            style={{ width: 14, height: 14 }}
            onError={(e) => e.currentTarget.classList.add('hidden')}
          />
          <span className="icon-fallback">{'\u26A0'}</span>
        </span>
        <span className={`risk-label risk-${card.risk}`}>{t(`action.risk.${card.risk}`)}</span>
      </span>
    </div>
  );
}

// =============================================================================
// ë‹¨ì¼ ì¹´ë“œ ì»´í¬ë„ŒíŠ¸
// =============================================================================

interface ActionCardItemProps {
  card: CardDisplayInfo;
  onClick: () => void;
  onHover: (card: CardDisplayInfo | null) => void;
  disabled: boolean;
}

/**
 * U-083: ë±ƒì§€ ìµœëŒ€ í‘œì‹œ ê°œìˆ˜ (Q1: Option B - ìµœëŒ€ 2ê°œ + "ì™¸ Nê°œ")
 */
const MAX_VISIBLE_BADGES = 2;

/**
 * ì¹´ë“œì— í‘œì‹œí•  ë±ƒì§€ ëª©ë¡ì„ ìˆ˜ì§‘í•œë‹¤.
 * U-083: ê° ë±ƒì§€ë¥¼ í†µí•© ë°°ì—´ë¡œ ëª¨ì•„ ìµœëŒ€ 2ê°œê¹Œì§€ë§Œ ë Œë”ë§ + ì´ˆê³¼ë¶„ "ì™¸ Nê°œ" í‘œì‹œ.
 */
interface BadgeInfo {
  key: string;
  className: string;
  label: string;
  tooltip: string;
}

function collectBadges(card: CardDisplayInfo, t: (key: string) => string): BadgeInfo[] {
  const badges: BadgeInfo[] = [];

  // U-076: VISION(ì •ë°€ë¶„ì„) ë°°ì§€ (ìµœìš°ì„ )
  if (card.isVisionAction) {
    const label = `\uD83D\uDD0D ${t('action.vision_badge')}`;
    badges.push({
      key: 'vision',
      className: 'badge-vision',
      label,
      tooltip: t('action.vision_badge'),
    });
  }

  // U-069: QUALITY ëª¨ë¸ ë°°ì§€ (VISIONì´ ì•„ë‹ ë•Œ)
  if (!card.isVisionAction && card.isQualityAction) {
    badges.push({
      key: 'quality',
      className: 'badge-quality',
      label: '\u2605 QUALITY',
      tooltip: t('economy.model_label.QUALITY'),
    });
  }

  // U-079: ì¬í™” íšë“ ì¹´ë“œ ë°°ì§€
  if (card.isEarnAction) {
    const label = `\u26A1 ${t('action.earn_badge')}`;
    badges.push({
      key: 'earn',
      className: 'badge-earn',
      label,
      tooltip: t('action.earn_badge'),
    });
  }

  // U-083: ëŒ€ì•ˆ ì¹´ë“œ í‘œì‹œ (ì¡°ê±´ ì™„í™”: ë‹¤ë¥¸ ë±ƒì§€ê°€ ìˆì–´ë„ í‘œì‹œë  ìˆ˜ ìˆë„ë¡ í•¨)
  // ì¬í™” ë¶€ì¡± ë“±ìœ¼ë¡œ 'ëŒ€ì•ˆ'ì´ë©´ì„œ 'QUALITY'ì¼ ìˆ˜ ìˆëŠ” ìƒí™© ì§€ì›
  if (card.is_alternative) {
    badges.push({
      key: 'alt',
      className: 'badge-alternative',
      label: t('action.alternative'),
      tooltip: t('action.alternative'),
    });
  }

  return badges;
}

/**
 * ë‹¨ì¼ ì¹´ë“œ ì»´í¬ë„ŒíŠ¸ - U-065 ë‹¨ìˆœí™”, U-069 QUALITY ë°°ì§€ ì§€ì›.
 * U-083: ë±ƒì§€ë¥¼ ë¹„ìš© ì•„ë˜ ë³„ë„ í–‰ìœ¼ë¡œ ì´ë™, ìµœëŒ€ 2ê°œ + "ì™¸ Nê°œ", ellipsis + íˆ´íŒ
 */
function ActionCardItem({ card, onClick, onHover, disabled }: ActionCardItemProps) {
  const { t } = useTranslation();

  const cardClasses = [
    'action-card',
    'has-chrome',
    card.isDisabled ? 'card-disabled' : '',
    card.is_alternative ? 'card-alternative' : '',
    card.isQualityAction ? 'card-quality' : '',
    card.isVisionAction ? 'card-vision' : '',
    card.isEarnAction ? 'card-earn' : '',
    `risk-border-${card.risk}`,
  ]
    .filter(Boolean)
    .join(' ');

  // U-083: ë±ƒì§€ ìˆ˜ì§‘ ë° ìµœëŒ€ 2ê°œ ì œí•œ
  const allBadges = useMemo(() => collectBadges(card, t), [card, t]);
  const visibleBadges = allBadges.slice(0, MAX_VISIBLE_BADGES);
  const overflowCount = allBadges.length - MAX_VISIBLE_BADGES;

  return (
    <button
      type="button"
      className={cardClasses}
      onClick={onClick}
      onMouseEnter={() => onHover(card)}
      onMouseLeave={() => onHover(null)}
      onFocus={() => onHover(card)}
      onBlur={() => onHover(null)}
      disabled={disabled || card.isDisabled}
      aria-disabled={disabled || card.isDisabled}
      title={card.finalDisabledReason ?? undefined}
    >
      {/* ì¹´ë“œ íƒ€ì´í‹€ */}
      <div className="action-card-title">{card.label}</div>

      {/* ë¹„ìš©/ìœ„í—˜ë„ ì •ë³´ */}
      <CardCostDisplay card={card} />

      {/* U-083: ë±ƒì§€ ì»¨í…Œì´ë„ˆ - ë¹„ìš© ì•„ë˜ ë³„ë„ í–‰ (Q3: Option C) */}
      {allBadges.length > 0 && (
        <div className="action-card-badges">
          {visibleBadges.map((badge) => (
            <span
              key={badge.key}
              className={`action-card-badge ${badge.className}`}
              title={badge.tooltip}
            >
              {badge.label}
            </span>
          ))}
          {/* Q1: Option B - ì´ˆê³¼ë¶„ "ì™¸ Nê°œ" í‘œì‹œ */}
          {overflowCount > 0 && (
            <span
              className="action-card-badge badge-overflow"
              title={allBadges
                .slice(MAX_VISIBLE_BADGES)
                .map((b) => b.label)
                .join(', ')}
            >
              +{overflowCount}
            </span>
          )}
        </div>
      )}

      {/* ë¹„í™œì„±í™” ì˜¤ë²„ë ˆì´ */}
      {card.isDisabled && (
        <div className="card-disabled-overlay">
          <span className="disabled-reason">
            {card.finalDisabledReason ?? t('action.insufficient_balance')}
          </span>
        </div>
      )}
    </button>
  );
}

// =============================================================================
// ë©”ì¸ Action Deck ì»´í¬ë„ŒíŠ¸
// =============================================================================

export function ActionDeck({ onCardClick, disabled: propsDisabled }: ActionDeckProps) {
  const { t } = useTranslation();
  const defaultCards = useDefaultCards();

  // Store ìƒíƒœ (RU-003: ì»´í¬ë„ŒíŠ¸ ë‚´ì—ì„œ ì§ì ‘ êµ¬ë…)
  const cards = useActionDeckStore((state) => state.cards);
  const currentBalance = useWorldStore((state) => state.economy);
  const isStreaming = useAgentStore((state) => state.isStreaming);
  const setCostEstimateFromCard = useEconomyStore((state) => state.setCostEstimateFromCard);
  const setCostEstimate = useEconomyStore((state) => state.setCostEstimate);

  // U-049: ë“œë˜ê·¸ ìŠ¤í¬ë¡¤
  const { containerRef, isDragging, handlers: dragHandlers } = useDragScroll();

  const disabled = propsDisabled ?? isStreaming;

  // ì¹´ë“œ í˜¸ë²„ í•¸ë“¤ëŸ¬ (U-014: ì˜ˆìƒ ë¹„ìš© í‘œì‹œ)
  // U-065: cost_estimate ì œê±°ë¨
  // U-069: displayCost (ë°°ìˆ˜ ì ìš©) ì‚¬ìš©
  const handleCardHover = useCallback(
    (card: CardDisplayInfo | null) => {
      if (card) {
        setCostEstimateFromCard(card.displayCost, null, card.id, card.label);
      } else {
        setCostEstimate(null);
      }
    },
    [setCostEstimateFromCard, setCostEstimate],
  );

  // ì¹´ë“œê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ì¹´ë“œ ì‚¬ìš©
  const displayCards = cards.length > 0 ? cards : defaultCards;

  // ì¹´ë“œë³„ ì‹¤í–‰ ê°€ëŠ¥ ì—¬ë¶€ ê³„ì‚° (Q1: Option A - ì„œë²„ ìš°ì„ , í´ë¼ì´ì–¸íŠ¸ í´ë°±)
  // U-065: cost_estimate, disabled_reason í•„ë“œ ì œê±°ë¨
  // U-069: QUALITY ëª¨ë¸ íŠ¸ë¦¬ê±° ë° ë¹„ìš© ë°°ìˆ˜ ê³„ì‚° ì¶”ê°€
  const processedCards: CardDisplayInfo[] = useMemo(() => {
    return displayCards.map((card) => {
      // U-079: ì¬í™” íšë“ ì¹´ë“œ ê°ì§€ (earn_ ì ‘ë‘ì‚¬)
      const isEarnAction = card.id.startsWith(EARN_ACTION_PREFIX);

      // U-083: ì ‘ë‘ì‚¬ë¥¼ ì œê±°í•œ ìˆœìˆ˜ ID (VISION/QUALITY ì²´í¬ìš©)
      const baseId = isEarnAction ? card.id.slice(EARN_ACTION_PREFIX.length) : card.id;

      // U-076: VISION(ì •ë°€ë¶„ì„) íŠ¸ë¦¬ê±° ì²´í¬ (QUALITYë³´ë‹¤ ìš°ì„ )
      const isVisionAction =
        VISION_TRIGGER_ACTION_IDS.has(card.id) || VISION_TRIGGER_ACTION_IDS.has(baseId);

      // U-069: QUALITY ëª¨ë¸ íŠ¸ë¦¬ê±° ì²´í¬ (VISIONì´ë©´ QUALITY ì•„ë‹˜)
      const isQualityAction =
        !isVisionAction &&
        (QUALITY_TRIGGER_ACTION_IDS.has(card.id) || QUALITY_TRIGGER_ACTION_IDS.has(baseId));

      // U-069/U-076: ë°°ìˆ˜ ì ìš©ëœ í‘œì‹œ ë¹„ìš© ê³„ì‚°
      const displayCost = isVisionAction
        ? {
            signal: Math.ceil(card.cost.signal * VISION_COST_MULTIPLIER),
            memory_shard: Math.ceil(card.cost.memory_shard * VISION_COST_MULTIPLIER),
          }
        : isQualityAction
          ? {
              signal: card.cost.signal * QUALITY_COST_MULTIPLIER,
              memory_shard: card.cost.memory_shard * QUALITY_COST_MULTIPLIER,
            }
          : { ...card.cost };

      // ì„œë²„ì—ì„œ enabledë¥¼ ëª…ì‹œì ìœ¼ë¡œ falseë¡œ ë³´ëƒˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
      const serverEnabled = card.enabled;

      // í´ë¼ì´ì–¸íŠ¸ ì¸¡ ì”ì•¡ ì²´í¬ (ì„œë²„ê°€ íŒë‹¨í•˜ì§€ ì•Šì•˜ì„ ë•Œ í´ë°±)
      // U-069: QUALITY ì•¡ì…˜ì€ ë°°ìˆ˜ ì ìš©ëœ ë¹„ìš©ìœ¼ë¡œ ì²´í¬
      const costToCheck = displayCost;
      const isAffordable =
        currentBalance.signal >= costToCheck.signal &&
        currentBalance.memory_shard >= costToCheck.memory_shard;

      // ìµœì¢… ë¹„í™œì„±í™” ì—¬ë¶€: ì„œë²„ íŒë‹¨ ìš°ì„ , ì—†ìœ¼ë©´ í´ë¼ì´ì–¸íŠ¸ íŒë‹¨
      const isDisabled = !serverEnabled || !isAffordable;

      // ë¹„í™œì„±í™” ì‚¬ìœ  ê²°ì • (U-065: disabled_reason ì œê±°ë¨)
      let finalDisabledReason: string | null = null;
      if (!serverEnabled) {
        finalDisabledReason = t('action.server_disabled');
      } else if (!isAffordable) {
        finalDisabledReason = t('action.insufficient_balance');
      }

      return {
        ...card,
        isAffordable,
        isDisabled,
        finalDisabledReason,
        isQualityAction,
        isVisionAction,
        isEarnAction,
        displayCost,
      };
    });
  }, [displayCards, currentBalance, t]);

  // ì¼ë°˜ ì¹´ë“œì™€ ëŒ€ì•ˆ ì¹´ë“œ ë¶„ë¦¬ (ëŒ€ì•ˆ ì¹´ë“œëŠ” ë’¤ì— ë°°ì¹˜)
  const sortedCards = useMemo(() => {
    const regular = processedCards.filter((c) => !c.is_alternative);
    const alternatives = processedCards.filter((c) => c.is_alternative);
    return [...regular, ...alternatives];
  }, [processedCards]);

  return (
    <div
      ref={containerRef}
      className={`action-deck ${isDragging ? 'is-dragging' : ''}`}
      role="group"
      aria-label={t('action.deck_label')}
      {...dragHandlers}
    >
      {sortedCards.map((card) => (
        <ActionCardItem
          key={card.id}
          card={card}
          onClick={() => onCardClick?.(card)}
          onHover={handleCardHover}
          disabled={disabled || isDragging} /* ë“œë˜ê·¸ ì¤‘ í´ë¦­ ë°©ì§€ */
        />
      ))}

      {/* ëª¨ë“  ì¹´ë“œê°€ ë¹„í™œì„±í™”ë˜ì—ˆì„ ë•Œ ì•ˆë‚´ */}
      {sortedCards.every((c) => c.isDisabled) && !disabled && (
        <div className="deck-empty-notice">{t('action.all_disabled_notice')}</div>
      )}
    </div>
  );
}

export default ActionDeck;
</file>

<file path="frontend/src/components/InventoryPanel.tsx">
/**
 * Unknown World - Inventory Panel ì»´í¬ë„ŒíŠ¸ (U-011[Mvp], U-088[Mvp]).
 *
 * dnd-kit ê¸°ë°˜ ë“œë˜ê·¸ ê°€ëŠ¥í•œ ì¸ë²¤í† ë¦¬ ì•„ì´í…œ UIë¥¼ Row(í–‰) í˜•íƒœë¡œ ì œê³µí•©ë‹ˆë‹¤.
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - RULE-002: InventoryëŠ” ê²Œì„ UIë¡œ ìƒì‹œ ë…¸ì¶œ (ì±„íŒ… ì…ë ¥ ëŒ€ì²´ ê¸ˆì§€)
 *   - tech-stack: dnd-kit ê¸°ë°˜ draggable êµ¬í˜„
 *   - U-012 ì—°ê²°: ë“œë˜ê·¸ ë°ì´í„°ì— item_id í¬í•¨í•˜ì—¬ ë“œë¡­ íƒ€ê²Ÿì— ì „ë‹¬
 *
 * U-088[Mvp]: Row í˜•íƒœ ì „í™˜
 *   - Q1: Row 48px, ì•„ì´ì½˜ 32px (ì»´íŒ©íŠ¸)
 *   - Q2: êµ¬ë¶„ì„  + ì¤„ë¬´ëŠ¬ ì¡°í•©
 *   - Q3: Hover íˆ´íŒë§Œ (U-056 ìœ ì§€)
 *   - Q4: (U-117ì—ì„œ ë³€ê²½) Row ì „ì²´ ë“œë˜ê·¸ ê°€ëŠ¥, ê³ ìŠ¤íŠ¸ëŠ” ì•„ì´ì½˜ë§Œ
 *
 * U-117[Mvp]: ë“œë˜ê·¸ ì˜ì—­ Row ì „ì²´ë¡œ í™•ì¥
 *   - Q1 Option A: distance 5px (ë§ˆìš°ìŠ¤ ì´ë™ í›„ ì‹œì‘)
 *   - Row ì „ì²´ì— listeners/attributes ì ìš©
 *   - ê³ ìŠ¤íŠ¸(DragOverlay)ëŠ” ì•„ì´ì½˜ë§Œ (U-088ì—ì„œ ì´ë¯¸ êµ¬í˜„)
 *   - ë“œë˜ê·¸ ì¤‘ Row opacity:0.4 + dashed border
 *
 * U-074[Mvp]: ì•„ì´í…œ ì¸í„°ë™ì…˜ ì•ˆë‚´ UX
 *   - Q1 Option B: ì²« Në²ˆë§Œ hover íŒíŠ¸ í‘œì‹œ (í•™ìŠµ í›„ ì‚¬ë¼ì§)
 *   - hover ì‹œ "ë“œë˜ê·¸í•˜ì—¬ ì‚¬ìš©" íŒíŠ¸ í‘œì‹œ
 *
 * U-075[Mvp]: ì•„ì´í…œ ì•„ì´ì½˜ ë™ì  ìƒì„±
 *   - Q1: Option B (placeholder ë¨¼ì € í‘œì‹œ í›„ ë°±ê·¸ë¼ìš´ë“œ ìƒì„±)
 *   - Q2: Option A (64x64 í”½ì…€)
 *   - Q3: Option A (í”½ì…€ ì•„íŠ¸ ìŠ¤íƒ€ì¼)
 *
 * @module components/InventoryPanel
 */

import { useMemo, useState, useEffect, useRef } from 'react';
import { useDraggable, DragOverlay, type Modifier } from '@dnd-kit/core';
import { CSS } from '@dnd-kit/utilities';
import { useTranslation } from 'react-i18next';
import {
  useInventoryStore,
  type InventoryItem,
  selectItems,
  selectDraggingItem,
  selectConsumingItemIds,
  requestItemIcon,
  pollIconStatus,
} from '../stores/inventoryStore';
import { useOnboardingStore, selectShouldShowItemHint } from '../stores/onboardingStore';
import { useWorldStore } from '../stores/worldStore';
import { useEconomyStore } from '../stores/economyStore';
import { ITEM_SELL_PRICE_SIGNAL } from '../save/constants';
import { InteractionHint } from './InteractionHint';
import { DND_TYPE, type InventoryDragData } from '../dnd/types';

// =============================================================================
// U-117: DragOverlay ì»¤ì„œ ìŠ¤ëƒ… modifier
// Row ì „ì²´ê°€ ë“œë˜ê·¸ ì˜ì—­ì´ë¯€ë¡œ, ì•„ì´ì½˜ ê³ ìŠ¤íŠ¸(40x40)ì˜ ì¤‘ì‹¬ì´
// í•­ìƒ ë§ˆìš°ìŠ¤ ì»¤ì„œì— ìœ„ì¹˜í•˜ë„ë¡ transformì„ ë³´ì •í•©ë‹ˆë‹¤.
// =============================================================================

/** ê³ ìŠ¤íŠ¸ ì•„ì´ì½˜ í¬ê¸°ì˜ ì ˆë°˜ (40px / 2) */
const OVERLAY_HALF_SIZE = 20;

/**
 * DragOverlayì˜ ì•„ì´ì½˜ ì¤‘ì‹¬ì„ ì»¤ì„œì— ìŠ¤ëƒ…í•˜ëŠ” modifier.
 *
 * ê¸°ë³¸ ë™ì‘: DragOverlayëŠ” ë“œë˜ê·¸ ì‹œì‘ ì‹œ grab ì§€ì  ê¸°ì¤€ìœ¼ë¡œ ì˜¤í”„ì…‹ì„ ìœ ì§€
 * â†’ Row ìš°ì¸¡ì—ì„œ grabí•˜ë©´ ì•„ì´ì½˜ì´ ì»¤ì„œì—ì„œ ë©€ë¦¬ ë–¨ì–´ì§
 *
 * ì´ modifier: grab ì˜¤í”„ì…‹ì„ ë¬´ì‹œí•˜ê³  ì•„ì´ì½˜ ì¤‘ì‹¬(20,20)ì´ ì»¤ì„œì— ì˜¤ë„ë¡ ë³´ì •
 */
const snapOverlayCenterToCursor: Modifier = ({ transform, activeNodeRect, activatorEvent }) => {
  if (!activeNodeRect || !activatorEvent) return transform;

  const event = activatorEvent as PointerEvent;

  // grab ì‹œì ì˜ ì»¤ì„œ ìœ„ì¹˜ì™€ Row ì¢Œìƒë‹¨ ì‚¬ì´ì˜ ì˜¤í”„ì…‹
  const grabOffsetX = event.clientX - activeNodeRect.left;
  const grabOffsetY = event.clientY - activeNodeRect.top;

  return {
    ...transform,
    x: transform.x + grabOffsetX - OVERLAY_HALF_SIZE,
    y: transform.y + grabOffsetY - OVERLAY_HALF_SIZE,
  };
};

// =============================================================================
// ë“œë˜ê·¸ ê°€ëŠ¥í•œ ì•„ì´í…œ ì»´í¬ë„ŒíŠ¸
// =============================================================================

interface DraggableItemProps {
  item: InventoryItem;
  disabled?: boolean;
  /** U-096: ì†Œë¹„ ì¤‘(fade-out ì§„í–‰ ì¤‘) ì—¬ë¶€ */
  isConsuming?: boolean;
  /** U-088: ì„ íƒ ì—¬ë¶€ */
  isSelected?: boolean;
  /** U-088: ì„ íƒ í•¸ë“¤ëŸ¬ */
  onSelect?: (itemId: string) => void;
  /** U-079: íŒë§¤ ê°€ëŠ¥ ì—¬ë¶€ (ì”ì•¡ ë¶€ì¡± ì‹œ í‘œì‹œ) */
  showSellButton?: boolean;
  /** U-079: íŒë§¤ í•¸ë“¤ëŸ¬ */
  onSell?: (itemId: string, itemName: string) => void;
}

/**
 * ë“œë˜ê·¸ ê°€ëŠ¥í•œ ì¸ë²¤í† ë¦¬ ì•„ì´í…œ.
 * dnd-kitì˜ useDraggable í›…ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
 * U-056: ì˜ë¦° ì•„ì´í…œ ì´ë¦„ì— ëŒ€í•œ íˆ´íŒ ì§€ì›
 * U-074: ì²« Në²ˆë§Œ hover íŒíŠ¸ í‘œì‹œ
 */
function DraggableItem({
  item,
  disabled = false,
  isConsuming = false,
  isSelected = false,
  onSelect,
  showSellButton = false,
  onSell,
}: DraggableItemProps) {
  const { t } = useTranslation();
  const [isHovered, setIsHovered] = useState(false);

  // U-074: ì•„ì´í…œ íŒíŠ¸ ìƒíƒœ (ì²« Në²ˆë§Œ í‘œì‹œ)
  const shouldShowHint = useOnboardingStore(selectShouldShowItemHint);
  const incrementItemHint = useOnboardingStore((state) => state.incrementItemHint);

  // U-074: hover ì‹œì‘ ì‹œ íŒíŠ¸ ì¹´ìš´íŠ¸ ì¦ê°€
  useEffect(() => {
    if (isHovered && !disabled) {
      incrementItemHint();
    }
  }, [isHovered, disabled, incrementItemHint]);

  // dnd-kit ë“œë˜ê·¸ ì„¤ì • (RU-003-Q1: ìƒìˆ˜/íƒ€ì… ê¸°ë°˜)
  const dragData: InventoryDragData = {
    type: DND_TYPE.INVENTORY_ITEM,
    item_id: item.id,
    item,
  };
  const { attributes, listeners, setNodeRef, transform, isDragging } = useDraggable({
    id: item.id,
    data: dragData,
    disabled,
  });

  // ë³€í™˜ ìŠ¤íƒ€ì¼ ê³„ì‚°
  // ë“œë˜ê·¸ ì¤‘ì¼ ë•ŒëŠ” ì›ë³¸ ì•„ì´í…œì´ ì œìë¦¬ì— ìˆë„ë¡ transform ì ìš©í•˜ì§€ ì•ŠìŒ
  // DragOverlayê°€ ë³„ë„ë¡œ ë Œë”ë§ë˜ë¯€ë¡œ ì›ë³¸ì€ ìœ„ì¹˜ ê³ ì •
  const style = useMemo(
    () => ({
      transform: isDragging ? undefined : CSS.Translate.toString(transform),
      opacity: isDragging ? 0.3 : 1,
    }),
    [transform, isDragging],
  );

  // U-075: ì•„ì´ì½˜ ë Œë”ë§ (ì´ëª¨ì§€ ë˜ëŠ” ì´ë¯¸ì§€, ë¡œë”© ìƒíƒœ í¬í•¨)
  const renderIcon = () => {
    const isLoading = item.iconStatus === 'generating' || item.iconStatus === 'pending';

    if (item.icon) {
      // URL í˜•íƒœë©´ ì´ë¯¸ì§€
      if (item.icon.startsWith('http') || item.icon.startsWith('/')) {
        return (
          <div className="inventory-item-icon-wrapper">
            <img
              src={item.icon}
              alt={item.name}
              className={`inventory-item-icon-img ${isLoading ? 'loading' : ''}`}
              onError={(e) => {
                e.currentTarget.style.display = 'none';
              }}
            />
            {isLoading && <div className="inventory-item-icon-loading" />}
          </div>
        );
      }
      // ì´ëª¨ì§€ + ë¡œë”© ìƒíƒœ (U-075: ì´ëª¨ì§€ì—¬ë„ ìƒì„± ì¤‘ì´ë©´ ìŠ¤í”¼ë„ˆ í‘œì‹œ)
      return (
        <div className="inventory-item-icon-wrapper">
          <span className="inventory-item-icon-emoji">{item.icon}</span>
          {isLoading && <div className="inventory-item-icon-loading" />}
        </div>
      );
    }

    // ê¸°ë³¸ ì•„ì´ì½˜ (ğŸ“¦) + ë¡œë”© ìƒíƒœ
    return (
      <div className="inventory-item-icon-wrapper">
        <span className="inventory-item-icon-emoji">ğŸ“¦</span>
        {isLoading && <div className="inventory-item-icon-loading" />}
      </div>
    );
  };

  return (
    <div
      ref={setNodeRef}
      style={style}
      className={`inventory-item ${isSelected ? 'selected' : ''} ${isDragging ? 'dragging' : ''} ${disabled ? 'disabled' : ''} ${isConsuming ? 'item-consumed' : ''}`}
      onMouseEnter={() => setIsHovered(true)}
      onMouseLeave={() => setIsHovered(false)}
      onClick={() => !disabled && onSelect?.(item.id)}
      aria-label={t('inventory.item_label', { name: item.name, quantity: item.quantity })}
      aria-selected={isSelected}
      // U-056: ë„¤ì´í‹°ë¸Œ íˆ´íŒ (ë‹¨ìˆ˜ëŠ” ì´ë¦„ë§Œ, ë³µìˆ˜ëŠ” "ì´ë¦„ x ê°¯ìˆ˜")
      title={item.quantity > 1 ? `${item.name} x ${item.quantity}` : item.name}
      // U-117: Row ì „ì²´ë¥¼ ë“œë˜ê·¸ í•¸ë“¤ë¡œ í™•ì¥ (Q1: Option A, distance 5px)
      {...attributes}
      {...listeners}
    >
      {/* U-117: ì•„ì´ì½˜ì€ í‘œì‹œ ì „ìš© (ë“œë˜ê·¸ í•¸ë“¤ì€ Row ì „ì²´) */}
      <div className="inventory-item-icon">{renderIcon()}</div>
      <div className="inventory-item-info">
        <span className="inventory-item-name">{item.name}</span>
        {item.quantity > 1 && <span className="inventory-item-quantity">x{item.quantity}</span>}
      </div>

      {/* U-079: íŒë§¤ ë²„íŠ¼ (ì”ì•¡ ë¶€ì¡± ì‹œ í‘œì‹œ) */}
      {showSellButton && !disabled && !isDragging && !isConsuming && (
        <button
          type="button"
          className="inventory-sell-btn"
          onClick={(e) => {
            e.stopPropagation();
            onSell?.(item.id, item.name);
          }}
          title={t('inventory.sell_tooltip', { price: ITEM_SELL_PRICE_SIGNAL })}
          aria-label={t('inventory.sell_aria', { item: item.name, price: ITEM_SELL_PRICE_SIGNAL })}
        >
          <span className="sell-icon">{'\u26A1'}</span>
          <span className="sell-price">+{ITEM_SELL_PRICE_SIGNAL}</span>
        </button>
      )}

      {/* U-074: ì²« Në²ˆë§Œ í‘œì‹œë˜ëŠ” ë“œë˜ê·¸ íŒíŠ¸ */}
      {isHovered && !disabled && !isDragging && shouldShowHint && !showSellButton && (
        <InteractionHint
          text={t('interaction.item_drag')}
          icon="drag"
          position="top"
          className="interaction-hint--inventory"
        />
      )}
    </div>
  );
}

// =============================================================================
// ë“œë˜ê·¸ ì˜¤ë²„ë ˆì´ (ë“œë˜ê·¸ ì¤‘ í‘œì‹œë˜ëŠ” ì•„ì´í…œ)
// =============================================================================

interface ItemOverlayProps {
  item: InventoryItem;
}

/**
 * ë“œë˜ê·¸ ì˜¤ë²„ë ˆì´ â€” ì•„ì´ì½˜ë§Œ í‘œì‹œ (U-088 Q4: Option B).
 * ë“œë˜ê·¸ ì¤‘ì¼ ë•Œ ì»¤ì„œë¥¼ ë”°ë¼ë‹¤ë‹ˆëŠ” ì•„ì´ì½˜ì…ë‹ˆë‹¤.
 */
function ItemOverlay({ item }: ItemOverlayProps) {
  const renderIcon = () => {
    if (item.icon) {
      if (item.icon.startsWith('http') || item.icon.startsWith('/')) {
        return <img src={item.icon} alt={item.name} className="inventory-item-icon-img" />;
      }
      return <span className="inventory-item-icon-emoji">{item.icon}</span>;
    }
    return <span className="inventory-item-icon-emoji">ğŸ“¦</span>;
  };

  return (
    <div className="inventory-overlay-icon" title={item.name}>
      {renderIcon()}
    </div>
  );
}

// =============================================================================
// ë©”ì¸ Inventory Panel ì»´í¬ë„ŒíŠ¸
// =============================================================================

interface InventoryPanelProps {
  /** ìƒí˜¸ì‘ìš© ë¹„í™œì„±í™” (ìŠ¤íŠ¸ë¦¬ë° ì¤‘ ë“±) */
  disabled?: boolean;
}

/**
 * Inventory Panel ì»´í¬ë„ŒíŠ¸.
 *
 * U-088: ì¸ë²¤í† ë¦¬ ì•„ì´í…œì„ Row(í–‰) í˜•íƒœë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
 * ì•„ì´ì½˜ ì˜ì—­ë§Œ ë“œë˜ê·¸ í•¸ë“¤(Q4: Option B), DndContextëŠ” App ìµœìƒë‹¨(Q1: Option A).
 *
 * U-075: ì•„ì´í…œ ì¶”ê°€ ì‹œ ì•„ì´ì½˜ ë™ì  ìƒì„± ìš”ì²­
 *
 * @example
 * ```tsx
 * <InventoryPanel disabled={isStreaming} />
 * ```
 */
export function InventoryPanel({ disabled = false }: InventoryPanelProps) {
  const { t, i18n } = useTranslation();

  // Store ìƒíƒœ
  const items = useInventoryStore(selectItems);
  const draggingItem = useInventoryStore(selectDraggingItem);
  const selectedItemId = useInventoryStore((state) => state.selectedItemId);
  const consumingItemIds = useInventoryStore(selectConsumingItemIds);
  const selectItem = useInventoryStore((state) => state.selectItem);
  const updateItemIcon = useInventoryStore((state) => state.updateItemIcon);
  const setItemIconStatus = useInventoryStore((state) => state.setItemIconStatus);

  // U-079: ì”ì•¡ ë¶€ì¡± ì‹œ íŒë§¤ ë²„íŠ¼ í‘œì‹œ
  const isBalanceLow = useEconomyStore((state) => state.isBalanceLow);
  const sellItem = useWorldStore((state) => state.sellItem);

  // U-075: ì•„ì´ì½˜ ìƒì„± ìš”ì²­ ì¶”ì  (ì¤‘ë³µ ìš”ì²­ ë°©ì§€)
  const iconRequestedRef = useRef<Set<string>>(new Set());

  // U-075: ì•„ì´í…œ ì¶”ê°€ ì‹œ ì•„ì´ì½˜ ìƒì„± ìš”ì²­
  useEffect(() => {
    const requestIconsForNewItems = async () => {
      for (const item of items) {
        // ì´ë¯¸ ìš”ì²­í•œ ê²½ìš° ìŠ¤í‚µ
        if (iconRequestedRef.current.has(item.id)) continue;

        // ì´ë¯¸ ì™„ë£Œëœ ì•„ì´ì½˜ì´ ìˆëŠ” ê²½ìš° ìŠ¤í‚µ
        if (item.iconStatus === 'completed' || item.iconStatus === 'cached') continue;

        // URL í˜•íƒœì˜ ì‹¤ì œ ì•„ì´ì½˜ì´ ìˆìœ¼ë©´ ìŠ¤í‚µ (ì´ëª¨ì§€ëŠ” ë¬´ì‹œ)
        const hasRealIcon =
          item.icon &&
          (item.icon.startsWith('http') || item.icon.startsWith('/')) &&
          !item.icon.includes('placeholder');
        if (hasRealIcon) continue;

        // iconStatusê°€ ì—†ê±°ë‚˜ pending/generating/failedì¸ ê²½ìš° ì•„ì´ì½˜ ìƒì„± ì‹œë„
        // (failedì¸ ê²½ìš°ë„ ì¬ì‹œë„ í—ˆìš©)

        // ìš”ì²­ ì¶”ì 
        iconRequestedRef.current.add(item.id);

        // ì•„ì´ì½˜ ìƒì„± ìš”ì²­ (ë¹„ë™ê¸°)
        const description = item.description || item.name;
        const language = i18n.language === 'ko' ? 'ko-KR' : 'en-US';

        setItemIconStatus(item.id, 'generating');

        try {
          const result = await requestItemIcon(item.id, description, language);

          if (result.isPlaceholder) {
            // Placeholder ë°˜í™˜ë¨ - í´ë§ ì‹œì‘
            setItemIconStatus(item.id, 'generating');

            // ë°±ê·¸ë¼ìš´ë“œì—ì„œ í´ë§ (ìµœëŒ€ 30ì´ˆ)
            let attempts = 0;
            const maxAttempts = 15;
            const pollInterval = 2000; // 2ì´ˆ

            const poll = async () => {
              if (attempts >= maxAttempts) {
                setItemIconStatus(item.id, 'failed');
                return;
              }
              attempts++;

              const status = await pollIconStatus(item.id);
              if (status === 'completed' || status === 'cached') {
                // ì™„ë£Œë¨ - ì•„ì´ì½˜ URL ë‹¤ì‹œ ìš”ì²­
                const finalResult = await requestItemIcon(item.id, description, language);
                if (!finalResult.isPlaceholder && finalResult.iconUrl) {
                  updateItemIcon(item.id, finalResult.iconUrl, 'completed');
                }
              } else if (status === 'failed') {
                setItemIconStatus(item.id, 'failed');
              } else {
                // ê³„ì† ìƒì„± ì¤‘ - ë‹¤ì‹œ í´ë§
                setTimeout(poll, pollInterval);
              }
            };

            setTimeout(poll, pollInterval);
          } else if (result.iconUrl) {
            // ì¦‰ì‹œ ì™„ë£Œ (ìºì‹œ)
            updateItemIcon(item.id, result.iconUrl, result.status);
          }
        } catch (error) {
          console.warn(`[InventoryPanel] ì•„ì´ì½˜ ìƒì„± ì‹¤íŒ¨: ${item.id}`, error);
          setItemIconStatus(item.id, 'failed');
        }
      }
    };

    requestIconsForNewItems();
  }, [items, i18n.language, updateItemIcon, setItemIconStatus]);

  // ì•„ì´í…œ ì„ íƒ í•¸ë“¤ëŸ¬ (í† ê¸€ ê¸°ëŠ¥ í¬í•¨)
  const handleSelect = (itemId: string) => {
    selectItem(itemId === selectedItemId ? null : itemId);
  };

  // ë¹ˆ ì¸ë²¤í† ë¦¬ (U-077: Q3 Option B - ì•„ì´í…œ íšë“ íŒíŠ¸ í¬í•¨)
  if (items.length === 0) {
    return (
      <div className="inventory-panel-content">
        <div className="inventory-empty">
          <span className="inventory-empty-icon">ğŸ“¦</span>
          <span className="inventory-empty-text">{t('inventory.empty')}</span>
          <span className="inventory-empty-hint">{t('inventory.empty_hint')}</span>
        </div>
      </div>
    );
  }

  return (
    <div className="inventory-panel-content" data-ui-importance="critical">
      <div
        className="inventory-list"
        role="listbox"
        aria-label={t('inventory.list_label')}
        aria-multiselectable={false}
      >
        {items.map((item) => (
          <DraggableItem
            key={item.id}
            item={item}
            disabled={disabled || consumingItemIds.includes(item.id)}
            isConsuming={consumingItemIds.includes(item.id)}
            isSelected={selectedItemId === item.id}
            onSelect={handleSelect}
            showSellButton={isBalanceLow}
            onSell={sellItem}
          />
        ))}
      </div>

      {/* U-117: ë“œë˜ê·¸ ì˜¤ë²„ë ˆì´ (ì•„ì´ì½˜ ì¤‘ì‹¬ì„ ì»¤ì„œì— ìŠ¤ëƒ…) */}
      <DragOverlay dropAnimation={null} modifiers={[snapOverlayCenterToCursor]}>
        {draggingItem ? <ItemOverlay item={draggingItem} /> : null}
      </DragOverlay>
    </div>
  );
}

export default InventoryPanel;
</file>

<file path="frontend/src/stores/worldStore.test.ts">
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { useWorldStore, selectMainObjective, selectSubObjectives } from './worldStore';
import type { TurnOutput } from '../schemas/turn';

// i18next ëª¨í‚¹ (U-072)
vi.mock('../i18n', () => ({
  default: {
    t: (key: string) => key,
  },
}));

// í•˜ìœ„ ìŠ¤í† ì–´ ëª¨í‚¹ (ìˆœí™˜ import ë°©ì§€ ë¡œì§ ëŒ€ì‘)
vi.mock('./actionDeckStore', () => ({
  useActionDeckStore: {
    getState: () => ({
      setCards: vi.fn(),
    }),
  },
}));

vi.mock('./inventoryStore', () => ({
  useInventoryStore: {
    getState: () => ({
      addItems: vi.fn(),
      removeItems: vi.fn(),
    }),
  },
  parseInventoryAdded: (items: unknown) => items,
}));

describe('worldStore (U-013: Quest + Rules)', () => {
  beforeEach(() => {
    useWorldStore.getState().reset();
  });

  it('ì´ˆê¸° ìƒíƒœê°€ ì˜¬ë°”ë¼ì•¼ í•œë‹¤', () => {
    const state = useWorldStore.getState();
    expect(state.quests).toEqual([]);
    expect(state.activeRules).toEqual([]);
    expect(state.mutationTimeline).toEqual([]);
  });

  it('applyTurnOutputì„ í†µí•´ ìƒˆ í€˜ìŠ¤íŠ¸ê°€ ì¶”ê°€ë˜ì–´ì•¼ í•œë‹¤', () => {
    const mockOutput: Partial<TurnOutput> = {
      narrative: 'ìƒˆ í€˜ìŠ¤íŠ¸ ë°œìƒ',
      economy: {
        cost: { signal: 0, memory_shard: 0 },
        balance_after: { signal: 100, memory_shard: 5 },
        credit: 0,
        low_balance_warning: false,
      },
      ui: {
        scene: { image_url: '', alt_text: '' },
        action_deck: { cards: [] },
        objects: [],
      },
      world: {
        inventory_added: [],
        inventory_removed: [],
        quests_updated: [
          {
            id: 'q1',
            label: 'ì²« ë²ˆì§¸ ì„ë¬´',
            is_completed: false,
            description: null,
            is_main: false,
            progress: 0,
            reward_signal: 0,
          },
        ],
        rules_changed: [],
        relationships_changed: [],
        memory_pins: [],
      },
      agent_console: {
        current_phase: 'commit',
        badges: ['schema_ok'],
        repair_count: 0,
        model_label: 'FAST',
      },
      safety: { blocked: false, message: null },
    };

    useWorldStore.getState().applyTurnOutput(mockOutput as TurnOutput);

    const state = useWorldStore.getState();
    expect(state.quests).toHaveLength(1);
    expect(state.quests[0].id).toBe('q1');
    expect(state.quests[0].is_completed).toBe(false);
  });

  it('ê¸°ì¡´ í€˜ìŠ¤íŠ¸ê°€ ì—…ë°ì´íŠ¸(ì™„ë£Œ)ë˜ì–´ì•¼ í•œë‹¤', () => {
    // 1. ì´ˆê¸° í€˜ìŠ¤íŠ¸ ì¶”ê°€
    const initialState: Partial<TurnOutput> = {
      narrative: 'ì´ˆê¸°í™”',
      economy: {
        cost: { signal: 0, memory_shard: 0 },
        balance_after: { signal: 100, memory_shard: 5 },
        credit: 0,
        low_balance_warning: false,
      },
      ui: {
        scene: { image_url: '', alt_text: '' },
        action_deck: { cards: [] },
        objects: [],
      },
      world: {
        inventory_added: [],
        inventory_removed: [],
        quests_updated: [
          {
            id: 'q1',
            label: 'ì„ë¬´',
            is_completed: false,
            description: null,
            is_main: false,
            progress: 0,
            reward_signal: 0,
          },
        ],
        rules_changed: [],
        relationships_changed: [],
        memory_pins: [],
      },
      agent_console: {
        current_phase: 'commit',
        badges: ['schema_ok'],
        repair_count: 0,
        model_label: 'FAST',
      },
      safety: { blocked: false, message: null },
    };
    useWorldStore.getState().applyTurnOutput(initialState as TurnOutput);

    // 2. í€˜ìŠ¤íŠ¸ ì™„ë£Œ ì—…ë°ì´íŠ¸
    const updateOutput: Partial<TurnOutput> = {
      narrative: 'ì„ë¬´ ì™„ë£Œ!',
      economy: {
        cost: { signal: 0, memory_shard: 0 },
        balance_after: { signal: 100, memory_shard: 5 },
        credit: 0,
        low_balance_warning: false,
      },
      ui: {
        scene: { image_url: '', alt_text: '' },
        action_deck: { cards: [] },
        objects: [],
      },
      world: {
        inventory_added: [],
        inventory_removed: [],
        quests_updated: [
          {
            id: 'q1',
            label: 'ì„ë¬´',
            is_completed: true,
            description: null,
            is_main: false,
            progress: 100,
            reward_signal: 0,
          },
        ],
        rules_changed: [],
        relationships_changed: [],
        memory_pins: [],
      },
      agent_console: {
        current_phase: 'commit',
        badges: ['schema_ok'],
        repair_count: 0,
        model_label: 'FAST',
      },
      safety: { blocked: false, message: null },
    };
    useWorldStore.getState().applyTurnOutput(updateOutput as TurnOutput);

    const state = useWorldStore.getState();
    expect(state.quests).toHaveLength(1);
    expect(state.quests[0].is_completed).toBe(true);
  });

  it('ìƒˆ ê·œì¹™ì´ ì¶”ê°€ë˜ê³  íƒ€ì„ë¼ì¸ì— ê¸°ë¡ë˜ì–´ì•¼ í•œë‹¤', () => {
    const mockOutput: Partial<TurnOutput> = {
      narrative: 'ìƒˆ ê·œì¹™ ì ìš©',
      economy: {
        cost: { signal: 0, memory_shard: 0 },
        balance_after: { signal: 100, memory_shard: 5 },
        credit: 0,
        low_balance_warning: false,
      },
      ui: {
        scene: { image_url: '', alt_text: '' },
        action_deck: { cards: [] },
        objects: [],
      },
      world: {
        inventory_added: [],
        inventory_removed: [],
        quests_updated: [],
        rules_changed: [
          {
            id: 'rule1',
            label: 'ì¤‘ë ¥ ê°•í™”',
            description: 'ì í”„ ë†’ì´ê°€ ì ˆë°˜ìœ¼ë¡œ ê°ì†Œí•©ë‹ˆë‹¤.',
          },
        ],
        relationships_changed: [],
        memory_pins: [],
      },
      agent_console: {
        current_phase: 'commit',
        badges: ['schema_ok'],
        repair_count: 0,
        model_label: 'FAST',
      },
      safety: { blocked: false, message: null },
    };

    useWorldStore.getState().applyTurnOutput(mockOutput as TurnOutput);

    const state = useWorldStore.getState();
    expect(state.activeRules).toHaveLength(1);
    expect(state.activeRules[0].id).toBe('rule1');

    expect(state.mutationTimeline).toHaveLength(1);
    expect(state.mutationTimeline[0].ruleId).toBe('rule1');
    expect(state.mutationTimeline[0].type).toBe('added');
  });

  it('ê¸°ì¡´ ê·œì¹™ ìˆ˜ì • ì‹œ íƒ€ì„ë¼ì¸ì— ê¸°ë¡ë˜ì–´ì•¼ í•œë‹¤', () => {
    // 1. ì´ˆê¸° ê·œì¹™ ì¶”ê°€
    const initialState: Partial<TurnOutput> = {
      narrative: 'ì´ˆê¸°í™”',
      economy: {
        cost: { signal: 0, memory_shard: 0 },
        balance_after: { signal: 100, memory_shard: 5 },
        credit: 0,
        low_balance_warning: false,
      },
      ui: {
        scene: { image_url: '', alt_text: '' },
        action_deck: { cards: [] },
        objects: [],
      },
      world: {
        inventory_added: [],
        inventory_removed: [],
        quests_updated: [],
        rules_changed: [{ id: 'rule1', label: 'ê·œì¹™', description: 'ê¸°ì¡´' }],
        relationships_changed: [],
        memory_pins: [],
      },
      agent_console: {
        current_phase: 'commit',
        badges: ['schema_ok'],
        repair_count: 0,
        model_label: 'FAST',
      },
      safety: { blocked: false, message: null },
    };
    useWorldStore.getState().applyTurnOutput(initialState as TurnOutput);

    // 2. ê·œì¹™ ìˆ˜ì •
    const updateOutput: Partial<TurnOutput> = {
      narrative: 'ê·œì¹™ ìˆ˜ì •',
      economy: {
        cost: { signal: 0, memory_shard: 0 },
        balance_after: { signal: 100, memory_shard: 5 },
        credit: 0,
        low_balance_warning: false,
      },
      ui: {
        scene: { image_url: '', alt_text: '' },
        action_deck: { cards: [] },
        objects: [],
      },
      world: {
        inventory_added: [],
        inventory_removed: [],
        quests_updated: [],
        rules_changed: [{ id: 'rule1', label: 'ê·œì¹™', description: 'ìˆ˜ì •ë¨' }],
        relationships_changed: [],
        memory_pins: [],
      },
      agent_console: {
        current_phase: 'commit',
        badges: ['schema_ok'],
        repair_count: 0,
        model_label: 'FAST',
      },
      safety: { blocked: false, message: null },
    };
    useWorldStore.getState().applyTurnOutput(updateOutput as TurnOutput);

    const state = useWorldStore.getState();
    expect(state.activeRules[0].description).toBe('ìˆ˜ì •ë¨');
    expect(state.mutationTimeline).toHaveLength(2);
    expect(state.mutationTimeline[0].type).toBe('modified');
  });

  describe('Initialization and Reset (U-015[Mvp])', () => {
    it('reset ì•¡ì…˜ì€ ëª¨ë“  ìƒíƒœë¥¼ ì´ˆê¸°ê°’ìœ¼ë¡œ ë˜ëŒë ¤ì•¼ í•œë‹¤', () => {
      // 1. ì„ì˜ì˜ ìƒíƒœ ì„¤ì •
      useWorldStore.setState({
        turnCount: 10,
        economy: { signal: 50, memory_shard: 0, credit: 0 },
        sceneState: {
          status: 'scene',
          imageUrl: 'test.png',
          processingPhase: 'rendering',
        },
        quests: [
          {
            id: 'q1',
            label: 'í€˜ìŠ¤íŠ¸',
            is_completed: false,
            description: null,
            is_main: false,
            progress: 0,
            reward_signal: 0,
          },
        ],
      });

      // 2. ë¦¬ì…‹ ì‹¤í–‰
      useWorldStore.getState().reset();

      // 3. ê²€ì¦
      const state = useWorldStore.getState();
      expect(state.turnCount).toBe(0);
      expect(state.economy.signal).toBe(100);
      expect(state.sceneState.status).toBe('default');
      expect(state.sceneState.imageUrl).toBeUndefined();
      expect(state.sceneState.processingPhase).toBe('idle');
      expect(state.quests).toEqual([]);
      expect(state.narrativeEntries).toEqual([]);
    });

    it('initialize ì•¡ì…˜ì€ ì›°ì»´ ë©”ì‹œì§€ì™€ í•¨ê»˜ ì´ˆê¸° ìƒíƒœë¥¼ ì„¤ì •í•´ì•¼ í•œë‹¤', () => {
      const welcomeMsg = 'í™˜ì˜í•©ë‹ˆë‹¤!';
      useWorldStore.getState().initialize(welcomeMsg);

      const state = useWorldStore.getState();
      expect(state.turnCount).toBe(0);
      expect(state.narrativeEntries).toHaveLength(1);
      expect(state.narrativeEntries[0].text).toBe(welcomeMsg);
      expect(state.narrativeEntries[0].turn).toBe(0);
    });
  });

  describe('Action Log (U-070[Mvp])', () => {
    it('appendActionLog ì•¡ì…˜ì€ action_log íƒ€ì…ì˜ ì—”íŠ¸ë¦¬ë¥¼ ì¶”ê°€í•´ì•¼ í•œë‹¤', () => {
      const logMsg = 'í–‰ë™ ì‹¤í–‰: ì•„ì´í…œ ì‚¬ìš©';
      useWorldStore.getState().appendActionLog(logMsg);

      const state = useWorldStore.getState();
      const lastEntry = state.narrativeEntries[state.narrativeEntries.length - 1];
      expect(lastEntry.text).toBe(logMsg);
      expect(lastEntry.type).toBe('action_log');
      expect(lastEntry.turn).toBe(state.turnCount);
    });
  });

  describe('Processing Phase (U-071[Mvp])', () => {
    it('setProcessingPhase ì•¡ì…˜ì€ sceneStateì˜ processingPhaseë¥¼ ì—…ë°ì´íŠ¸í•´ì•¼ í•œë‹¤', () => {
      const store = useWorldStore.getState();

      // 1. ì´ˆê¸° ìƒíƒœ í™•ì¸
      expect(store.sceneState.processingPhase).toBe('idle');

      // 2. ë‹¨ê³„ ë³€ê²½
      store.setProcessingPhase('processing');
      expect(useWorldStore.getState().sceneState.processingPhase).toBe('processing');

      // 3. ë‹¨ê³„ ë³€ê²½ (image_pending)
      store.setProcessingPhase('image_pending');
      expect(useWorldStore.getState().sceneState.processingPhase).toBe('image_pending');

      // 4. ìœ íœ´ ìƒíƒœë¡œ ë³µê·€
      store.setProcessingPhase('idle');
      expect(useWorldStore.getState().sceneState.processingPhase).toBe('idle');
    });
  });

  describe('Scanner Hints (U-072[Mvp])', () => {
    it('applyTurnOutputì—ì„œ hints.scannerê°€ trueì´ë©´ íŒíŠ¸ ë‚´ëŸ¬í‹°ë¸Œê°€ ì¶”ê°€ë˜ì–´ì•¼ í•œë‹¤', () => {
      const mockOutput: Partial<TurnOutput> = {
        narrative: 'ì¼ë°˜ ë‚´ëŸ¬í‹°ë¸Œ',
        economy: {
          cost: { signal: 0, memory_shard: 0 },
          balance_after: { signal: 100, memory_shard: 5 },
          credit: 0,
          low_balance_warning: false,
        },
        ui: {
          scene: { image_url: '', alt_text: '' },
          action_deck: { cards: [] },
          objects: [],
        },
        world: {
          inventory_added: [],
          inventory_removed: [],
          quests_updated: [],
          rules_changed: [],
          relationships_changed: [],
          memory_pins: [],
        },
        agent_console: {
          current_phase: 'commit',
          badges: ['schema_ok'],
          repair_count: 0,
          model_label: 'FAST',
        },
        safety: { blocked: false, message: null },
        hints: {
          scanner: true,
        },
      };

      useWorldStore.getState().applyTurnOutput(mockOutput as TurnOutput);

      const state = useWorldStore.getState();
      // ì¼ë°˜ ë‚´ëŸ¬í‹°ë¸Œ + ìŠ¤ìºë„ˆ íŒíŠ¸ ì´ 2ê°œì—¬ì•¼ í•¨
      expect(state.narrativeEntries).toHaveLength(2);
      expect(state.narrativeEntries[0].text).toBe('ì¼ë°˜ ë‚´ëŸ¬í‹°ë¸Œ');
      expect(state.narrativeEntries[1].text).toBe('scanner.hint_narrative');
      expect(state.narrativeEntries[1].type).toBe('system');
    });

    it('hints.scannerê°€ ì—†ìœ¼ë©´ íŒíŠ¸ ë‚´ëŸ¬í‹°ë¸Œê°€ ì¶”ê°€ë˜ì§€ ì•Šì•„ì•¼ í•œë‹¤', () => {
      const mockOutput: Partial<TurnOutput> = {
        narrative: 'ì¼ë°˜ ë‚´ëŸ¬í‹°ë¸Œ',
        economy: {
          cost: { signal: 0, memory_shard: 0 },
          balance_after: { signal: 100, memory_shard: 5 },
          credit: 0,
          low_balance_warning: false,
        },
        ui: {
          scene: { image_url: '', alt_text: '' },
          action_deck: { cards: [] },
          objects: [],
        },
        world: {
          inventory_added: [],
          inventory_removed: [],
          quests_updated: [],
          rules_changed: [],
          relationships_changed: [],
          memory_pins: [],
        },
        agent_console: {
          current_phase: 'commit',
          badges: ['schema_ok'],
          repair_count: 0,
          model_label: 'FAST',
        },
        safety: { blocked: false, message: null },
      };

      useWorldStore.getState().applyTurnOutput(mockOutput as TurnOutput);

      const state = useWorldStore.getState();
      expect(state.narrativeEntries).toHaveLength(1);
      expect(state.narrativeEntries[0].text).toBe('ì¼ë°˜ ë‚´ëŸ¬í‹°ë¸Œ');
    });
  });

  describe('Objective System (U-078[Mvp])', () => {
    it('selectMainObjectiveëŠ” is_main=trueì¸ í€˜ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•´ì•¼ í•œë‹¤', () => {
      useWorldStore.setState({
        quests: [
          {
            id: 'q1',
            label: 'ì„œë¸Œ',
            is_main: false,
            is_completed: false,
            progress: 0,
            reward_signal: 0,
            description: null,
          },
          {
            id: 'q2',
            label: 'ë©”ì¸',
            is_main: true,
            is_completed: false,
            progress: 50,
            reward_signal: 100,
            description: null,
          },
        ],
      });

      const main = selectMainObjective(useWorldStore.getState());
      expect(main?.id).toBe('q2');
    });

    it('selectSubObjectivesëŠ” is_main=falseì¸ í€˜ìŠ¤íŠ¸ë“¤ì„ ë°˜í™˜í•´ì•¼ í•œë‹¤', () => {
      useWorldStore.setState({
        quests: [
          {
            id: 'q1',
            label: 'ì„œë¸Œ1',
            is_main: false,
            is_completed: false,
            progress: 0,
            reward_signal: 0,
            description: null,
          },
          {
            id: 'q2',
            label: 'ë©”ì¸',
            is_main: true,
            is_completed: false,
            progress: 50,
            reward_signal: 100,
            description: null,
          },
          {
            id: 'q3',
            label: 'ì„œë¸Œ2',
            is_main: false,
            is_completed: false,
            progress: 0,
            reward_signal: 0,
            description: null,
          },
        ],
      });

      const subs = selectSubObjectives(useWorldStore.getState());
      expect(subs).toHaveLength(2);
      expect(subs.map((s) => s.id)).toContain('q1');
      expect(subs.map((s) => s.id)).toContain('q3');
    });

    it('í€˜ìŠ¤íŠ¸ ì™„ë£Œ ì‹œ reward_signalì´ ìˆìœ¼ë©´ ì•Œë¦¼ ë©”ì‹œì§€ê°€ ì¶”ê°€ë˜ì–´ì•¼ í•œë‹¤', () => {
      // 1. ì´ˆê¸° ìƒíƒœ: ë¯¸ì™„ë£Œ í€˜ìŠ¤íŠ¸
      useWorldStore.setState({
        quests: [
          {
            id: 'q1',
            label: 'ì„ë¬´',
            is_main: false,
            is_completed: false,
            progress: 0,
            reward_signal: 50,
            description: null,
          },
        ],
      });

      // 2. ì™„ë£Œ ì—…ë°ì´íŠ¸
      const output: Partial<TurnOutput> = {
        narrative: 'ì„ë¬´ ì™„ë£Œ',
        economy: {
          cost: { signal: 0, memory_shard: 0 },
          balance_after: { signal: 150, memory_shard: 5 },
          credit: 0,
          low_balance_warning: false,
        },
        ui: {
          scene: { image_url: '', alt_text: '' },
          action_deck: { cards: [] },
          objects: [],
        },
        world: {
          inventory_added: [],
          inventory_removed: [],
          quests_updated: [
            {
              id: 'q1',
              label: 'ì„ë¬´',
              is_main: false,
              is_completed: true,
              progress: 100,
              reward_signal: 50,
              description: null,
            },
          ],
          rules_changed: [],
          relationships_changed: [],
          memory_pins: [],
        },
        agent_console: {
          current_phase: 'commit',
          badges: ['schema_ok'],
          repair_count: 0,
          model_label: 'FAST',
        },
        safety: { blocked: false, message: null },
      };

      useWorldStore.getState().applyTurnOutput(output as TurnOutput);

      const state = useWorldStore.getState();
      // ì¼ë°˜ ë‚´ëŸ¬í‹°ë¸Œ + ë³´ìƒ ì•Œë¦¼ ì´ 2ê°œ
      expect(state.narrativeEntries).toHaveLength(2);
      expect(state.narrativeEntries[1].text).toContain('quest.objective_complete');
      expect(state.narrativeEntries[1].text).toContain('quest.reward_earned');
      expect(state.narrativeEntries[1].type).toBe('system');
    });
  });

  describe('Hotspot Policy (U-090[Mvp])', () => {
    it('ìƒˆ ì´ë¯¸ì§€ ìƒì„± ì‹œ í•«ìŠ¤íŒŸì´ ì´ˆê¸°í™”ë˜ì–´ì•¼ í•œë‹¤ (Q1: Option A)', () => {
      // 1. ê¸°ì¡´ í•«ìŠ¤íŒŸ ì„¤ì •
      useWorldStore.setState({
        sceneObjects: [
          {
            id: 'old',
            label: 'ê³¼ê±°',
            box_2d: { ymin: 0, xmin: 0, ymax: 100, xmax: 100 },
            interaction_hint: null,
          },
        ],
      });

      // 2. ìƒˆ ì´ë¯¸ì§€ ìƒì„±ì´ í¬í•¨ëœ í„´ (image_url ì¡´ì¬)
      const mockOutput: Partial<TurnOutput> = {
        narrative: 'ìƒˆ ì¥ë©´',
        economy: {
          cost: { signal: 0, memory_shard: 0 },
          balance_after: { signal: 100, memory_shard: 5 },
          credit: 0,
          low_balance_warning: false,
        },
        ui: {
          scene: { image_url: 'new_img.png', alt_text: '' },
          action_deck: { cards: [] },
          objects: [],
        },
        render: {
          image_url: 'new_img.png',
          image_job: null,
          image_id: 'img_1',
          generation_time_ms: 1000,
        },
        world: {
          inventory_added: [],
          inventory_removed: [],
          quests_updated: [],
          rules_changed: [],
          relationships_changed: [],
          memory_pins: [],
        },
        agent_console: {
          current_phase: 'commit',
          badges: ['schema_ok'],
          repair_count: 0,
          model_label: 'FAST',
        },
        safety: { blocked: false, message: null },
      };

      useWorldStore.getState().applyTurnOutput(mockOutput as TurnOutput);

      const state = useWorldStore.getState();
      expect(state.sceneObjects).toHaveLength(0); // ì´ˆê¸°í™”ë¨
    });

    it('ìƒˆ ì´ë¯¸ì§€ ìƒì„±ì´ í¬í•¨ëœ í„´ (should_generate=true)ì—ì„œë„ í•«ìŠ¤íŒŸì´ ì´ˆê¸°í™”ë˜ì–´ì•¼ í•œë‹¤', () => {
      // 1. ê¸°ì¡´ í•«ìŠ¤íŒŸ ì„¤ì •
      useWorldStore.setState({
        sceneObjects: [
          {
            id: 'old',
            label: 'ê³¼ê±°',
            box_2d: { ymin: 0, xmin: 0, ymax: 100, xmax: 100 },
            interaction_hint: null,
          },
        ],
      });

      // 2. ì´ë¯¸ì§€ ìƒì„± ì˜ˆì •ì¸ í„´
      const mockOutput: Partial<TurnOutput> = {
        narrative: 'ì¥ë©´ ì „í™˜ ì¤‘...',
        economy: {
          cost: { signal: 0, memory_shard: 0 },
          balance_after: { signal: 100, memory_shard: 5 },
          credit: 0,
          low_balance_warning: false,
        },
        ui: {
          scene: { image_url: '', alt_text: '' },
          action_deck: { cards: [] },
          objects: [],
        },
        render: {
          image_url: null,
          image_job: {
            should_generate: true,
            prompt: 'A new scene',
            model_label: 'FAST',
            aspect_ratio: '16:9',
            image_size: '1024x1024',
            reference_image_ids: [],
            reference_image_url: null,
          },
          image_id: null,
          generation_time_ms: null,
        },
        world: {
          inventory_added: [],
          inventory_removed: [],
          quests_updated: [],
          rules_changed: [],
          relationships_changed: [],
          memory_pins: [],
        },
        agent_console: {
          current_phase: 'commit',
          badges: ['schema_ok'],
          repair_count: 0,
          model_label: 'FAST',
        },
        safety: { blocked: false, message: null },
      };

      useWorldStore.getState().applyTurnOutput(mockOutput as TurnOutput);

      const state = useWorldStore.getState();
      expect(state.sceneObjects).toHaveLength(0); // ì´ˆê¸°í™”ë¨
    });

    it('ì¼ë°˜ í„´(objects ë¹„ì–´ìˆìŒ)ì—ì„œëŠ” ê¸°ì¡´ í•«ìŠ¤íŒŸì´ ìœ ì§€ë˜ì–´ì•¼ í•œë‹¤', () => {
      // 1. ê¸°ì¡´ í•«ìŠ¤íŒŸ ì„¤ì •
      const oldObjects = [
        {
          id: 'obj1',
          label: 'ë¬¼ì²´1',
          box_2d: { ymin: 100, xmin: 100, ymax: 200, xmax: 200 },
          interaction_hint: null,
        },
      ];
      useWorldStore.setState({
        sceneObjects: oldObjects,
      });

      // 2. ì¼ë°˜ í„´ (objects ë¹„ì–´ìˆìŒ, ì´ë¯¸ì§€ ìƒì„± ì—†ìŒ)
      const mockOutput: Partial<TurnOutput> = {
        narrative: 'ì•„ë¬´ ì¼ë„ ì¼ì–´ë‚˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
        economy: {
          cost: { signal: 0, memory_shard: 0 },
          balance_after: { signal: 100, memory_shard: 5 },
          credit: 0,
          low_balance_warning: false,
        },
        ui: {
          scene: { image_url: '', alt_text: '' },
          action_deck: { cards: [] },
          objects: [],
        },
        world: {
          inventory_added: [],
          inventory_removed: [],
          quests_updated: [],
          rules_changed: [],
          relationships_changed: [],
          memory_pins: [],
        },
        agent_console: {
          current_phase: 'commit',
          badges: ['schema_ok'],
          repair_count: 0,
          model_label: 'FAST',
        },
        safety: { blocked: false, message: null },
      };

      useWorldStore.getState().applyTurnOutput(mockOutput as TurnOutput);

      const state = useWorldStore.getState();
      expect(state.sceneObjects).toEqual(oldObjects); // ìœ ì§€ë¨
    });

    it('ì •ë°€ë¶„ì„ ê²°ê³¼(objects ì¡´ì¬)ëŠ” ê¸°ì¡´ í•«ìŠ¤íŒŸì— ë³‘í•©ë˜ì–´ì•¼ í•œë‹¤', () => {
      // 1. ê¸°ì¡´ í•«ìŠ¤íŒŸ ì„¤ì •
      const oldObjects = [
        {
          id: 'obj1',
          label: 'ë¬¼ì²´1',
          box_2d: { ymin: 100, xmin: 100, ymax: 200, xmax: 200 },
          interaction_hint: null,
        },
      ];
      useWorldStore.setState({
        sceneObjects: oldObjects,
      });

      // 2. ì •ë°€ë¶„ì„ ê²°ê³¼ í„´
      const newObject = {
        id: 'obj2',
        label: 'ë¬¼ì²´2',
        box_2d: { ymin: 300, xmin: 300, ymax: 400, xmax: 400 },
        interaction_hint: null,
      };
      const mockOutput: Partial<TurnOutput> = {
        narrative: 'ìì„¸íˆ ë³´ë‹ˆ ìƒˆë¡œìš´ ê²ƒì´ ë³´ì…ë‹ˆë‹¤.',
        economy: {
          cost: { signal: 0, memory_shard: 0 },
          balance_after: { signal: 100, memory_shard: 5 },
          credit: 0,
          low_balance_warning: false,
        },
        ui: {
          scene: { image_url: '', alt_text: '' },
          action_deck: { cards: [] },
          objects: [newObject],
        },
        world: {
          inventory_added: [],
          inventory_removed: [],
          quests_updated: [],
          rules_changed: [],
          relationships_changed: [],
          memory_pins: [],
        },
        agent_console: {
          current_phase: 'commit',
          badges: ['schema_ok'],
          repair_count: 0,
          model_label: 'FAST',
        },
        safety: { blocked: false, message: null },
      };

      useWorldStore.getState().applyTurnOutput(mockOutput as TurnOutput);

      const state = useWorldStore.getState();
      expect(state.sceneObjects).toHaveLength(2);
      expect(state.sceneObjects).toContainEqual(oldObjects[0]);
      expect(state.sceneObjects).toContainEqual(newObject);
    });
  });
});
</file>

<file path="frontend/src/turn/turnRunner.ts">
/**
 * Unknown World - Turn Runner ëª¨ë“ˆ
 *
 * RU-003-Q3: Turn ì‹¤í–‰/ìŠ¤íŠ¸ë¦¬ë° ê²°í•©ì„ App.tsxì—ì„œ ë¶„ë¦¬í•˜ì—¬
 * "ë ˆì´ì•„ì›ƒ + ì´ë²¤íŠ¸ ë¼ìš°íŒ…"ê³¼ "ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜"ì„ ëª…í™•íˆ ë¶„ë¦¬í•©ë‹ˆë‹¤.
 *
 * ì±…ì„:
 *   - TurnInput ìƒì„± (ì–¸ì–´/í´ë¦­/ë“œë¡­/í´ë¼ì´ì–¸íŠ¸ ì •ë³´/ì¬í™” ìŠ¤ëƒ…ìƒ·)
 *   - ìŠ¤íŠ¸ë¦¼ ì‹œì‘/ì·¨ì†Œ/ì½œë°± ë¼ìš°íŒ…
 *   - agentStore/worldStoreë¡œ ì´ë²¤íŠ¸ ë¶„ë°°
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - RULE-002: ì±„íŒ… ì•±ì´ ì•„ë‹Œ ìƒíƒœ ê¸°ë°˜ ê²Œì„ ì‹œìŠ¤í…œ
 *   - RULE-003/004: êµ¬ì¡°í™” ì¶œë ¥ + ê²€ì¦/ë³µêµ¬
 *   - RULE-006: ko/en i18n ì •ì±… ì¤€ìˆ˜
 *
 * @module turn/turnRunner
 */

import { useCallback, useEffect, useRef } from 'react';
import type { TurnInput, DropInput, Language } from '../schemas/turn';
import type { HotspotClickData } from '../components/SceneCanvas';
import { startTurnStream, type StreamCallbacks } from '../api/turnStream';
import { startImageGeneration, type ImageModelLabel } from '../api/image';
import { useAgentStore } from '../stores/agentStore';
import { useWorldStore } from '../stores/worldStore';
import { selectImageSizing } from '../utils/imageSizing';

// =============================================================================
// U-089: ì •ë°€ë¶„ì„(Agentic Vision) íŠ¸ë¦¬ê±° ê°ì§€ ìƒìˆ˜
// ë°±ì—”ë“œ config/models.py VISION_TRIGGER_ACTION_IDS / VISION_TRIGGER_KEYWORDSì™€ ë™ê¸°í™”
// =============================================================================

const VISION_TRIGGER_ACTION_IDS = new Set([
  'deep_analyze',
  'ì •ë°€ë¶„ì„',
  'analyze_scene',
  'examine_scene',
  'look_closely',
]);

const VISION_TRIGGER_KEYWORDS = [
  'ì •ë°€ë¶„ì„',
  'ì¥ë©´ ë¶„ì„',
  'ì´ë¯¸ì§€ ë¶„ì„',
  'ìì„¸íˆ ë³´ê¸°',
  'analyze scene',
  'deep analyze',
  'look closely',
  'examine scene',
];

/** U-089: ì •ë°€ë¶„ì„ ì˜¤ë²„ë ˆì´ ìµœì†Œ í‘œì‹œ ì‹œê°„ (ms) - ê¹œë¹¡ì„ ë°©ì§€ */
const ANALYZING_MIN_DISPLAY_MS = 500;

/**
 * U-089: ì •ë°€ë¶„ì„(Agentic Vision) íŠ¸ë¦¬ê±° ì—¬ë¶€ë¥¼ íŒë‹¨í•©ë‹ˆë‹¤.
 * ë°±ì—”ë“œì˜ ModelConfig.is_vision_trigger()ì™€ ë™ì¼í•œ ë¡œì§ì…ë‹ˆë‹¤.
 */
function isVisionTrigger(actionId?: string, text?: string): boolean {
  if (actionId && VISION_TRIGGER_ACTION_IDS.has(actionId)) return true;
  if (text) {
    const textLower = text.toLowerCase();
    for (const keyword of VISION_TRIGGER_KEYWORDS) {
      if (textLower.includes(keyword.toLowerCase())) return true;
    }
  }
  return false;
}

// =============================================================================
// íƒ€ì… ì •ì˜
// =============================================================================

/** TurnInput ìƒì„±ì„ ìœ„í•œ íŒŒë¼ë¯¸í„° */
export interface BuildTurnInputParams {
  /** ì‚¬ìš©ì ì…ë ¥ í…ìŠ¤íŠ¸ */
  text: string;
  /** ì•¡ì…˜ ì¹´ë“œ ID (ì„ íƒ) */
  actionId?: string;
  /** í•«ìŠ¤íŒŸ í´ë¦­ ë°ì´í„° (U-010) */
  click?: HotspotClickData;
  /** ë“œë¡­ ë°ì´í„° (U-012) */
  drop?: DropInput;
  /** ì¬í™” ìŠ¤ëƒ…ìƒ· */
  economySnapshot: { signal: number; memory_shard: number };
  /** UI í…Œë§ˆ */
  theme: 'dark' | 'light';
  /** U-044: ì„¸ì…˜ ì–¸ì–´ (ì™¸ë¶€ ì£¼ì…, SSOT) */
  language: Language;
  /** U-068: ì´ì „ í„´ ì´ë¯¸ì§€ URL (ì°¸ì¡° ì´ë¯¸ì§€ë¡œ ì‚¬ìš©) */
  previousImageUrl?: string | null;
}

/** Turn ì‹¤í–‰ì„ ìœ„í•œ íŒŒë¼ë¯¸í„° (Appì—ì„œ í˜¸ì¶œ ì‹œ ì‚¬ìš©) */
export interface RunTurnParams {
  /** ì‚¬ìš©ì ì…ë ¥ í…ìŠ¤íŠ¸ */
  text: string;
  /** ì•¡ì…˜ ì¹´ë“œ ID (ì„ íƒ) */
  actionId?: string;
  /** í•«ìŠ¤íŒŸ í´ë¦­ ë°ì´í„° (U-010) */
  click?: HotspotClickData;
  /** ë“œë¡­ ë°ì´í„° (U-012) */
  drop?: DropInput;
}

/** Turn Runner ì¸í„°í˜ì´ìŠ¤ */
export interface TurnRunner {
  /** í„´ ì‹¤í–‰ (ìŠ¤íŠ¸ë¦¼ ì‹œì‘) */
  runTurn: (params: RunTurnParams) => void;
  /** ìŠ¤íŠ¸ë¦¼ ì·¨ì†Œ */
  cancel: () => void;
}

// =============================================================================
// TurnInput ìƒì„±
// =============================================================================

/**
 * TurnInputì„ ìƒì„±í•©ë‹ˆë‹¤.
 *
 * U-044: ì–¸ì–´ëŠ” ì™¸ë¶€ì—ì„œ ì£¼ì…ë°›ì•„ SSOT ìœ ì§€ (getResolvedLanguage() ì§ì ‘ í˜¸ì¶œ ì œê±°).
 * í´ë¦­, ë“œë¡­, í´ë¼ì´ì–¸íŠ¸ ì •ë³´, ì¬í™” ìŠ¤ëƒ…ìƒ·ì„ ì¡°í•©í•˜ì—¬
 * ì„œë²„ë¡œ ì „ì†¡í•  TurnInputì„ ìƒì„±í•©ë‹ˆë‹¤.
 */
export function buildTurnInput(params: BuildTurnInputParams): TurnInput {
  const { text, actionId, click, drop, economySnapshot, theme, language, previousImageUrl } =
    params;

  return {
    language,
    text,
    action_id: actionId ?? null,
    // U-010: í•«ìŠ¤íŒŸ í´ë¦­ ë°ì´í„° í¬í•¨ (Q1: Option B)
    click: click
      ? {
          object_id: click.object_id,
          box_2d: click.box_2d,
        }
      : null,
    // U-012: ì•„ì´í…œ ë“œë¡­ ë°ì´í„° í¬í•¨ (Q1: Option B - target_box_2d í¬í•¨)
    drop: drop ?? null,
    client: {
      viewport_w: window.innerWidth,
      viewport_h: window.innerHeight,
      theme,
    },
    economy_snapshot: economySnapshot,
    // U-068: ì´ì „ í„´ ì´ë¯¸ì§€ URL (ì°¸ì¡° ì´ë¯¸ì§€ë¡œ ì‚¬ìš©í•˜ì—¬ ì—°ì†ì„± ìœ ì§€)
    previous_image_url: previousImageUrl ?? null,
  };
}

// =============================================================================
// Turn Runner ìƒì„±
// =============================================================================

/**
 * Turn Runnerë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
 *
 * RU-003-Q3: Appì—ì„œ Turn Runner ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.
 * U-044: ì„¸ì…˜ ì–¸ì–´ë¥¼ ì™¸ë¶€ì—ì„œ ì£¼ì…ë°›ì•„ TurnInput ìƒì„± ì‹œ SSOT ìœ ì§€.
 * ìŠ¤íŠ¸ë¦¼ ì½œë°±ì€ agentStoreì™€ worldStoreë¡œ ë¼ìš°íŒ…ë©ë‹ˆë‹¤.
 *
 * @param deps - ì˜ì¡´ì„± (i18n ë²ˆì—­ í•¨ìˆ˜, í…Œë§ˆ, ì„¸ì…˜ ì–¸ì–´)
 * @returns Turn Runner ì¸í„°í˜ì´ìŠ¤
 *
 * @example
 * ```tsx
 * // App.tsxì—ì„œ ì‚¬ìš©
 * const runner = useMemo(() => createTurnRunner({
 *   t,
 *   theme: 'dark',
 *   language: sessionLanguage, // U-044: ì„¸ì…˜ ì–¸ì–´ SSOT
 * }), [t, sessionLanguage]);
 *
 * runner.runTurn({ text: 'hello' });
 * ```
 */
export function createTurnRunner(deps: {
  /** i18n ë²ˆì—­ í•¨ìˆ˜ */
  t: (key: string, options?: Record<string, unknown>) => string;
  /** UI í…Œë§ˆ */
  theme: 'dark' | 'light';
  /** U-044: ì„¸ì…˜ ì–¸ì–´ (SSOT) */
  language: Language;
}): TurnRunner {
  const { t, theme, language } = deps;

  // ì·¨ì†Œ í•¨ìˆ˜ ì €ì¥
  let cancelFn: (() => void) | null = null;

  // U-066: ì´ë¯¸ì§€ ì¡ AbortController
  let imageJobController: AbortController | null = null;

  // U-080: ì´ë¯¸ì§€ ìƒì„± ìš”ì²­ ì¤‘ë³µ ë°©ì§€ (StrictMode ëŒ€ì‘)
  let imageJobPending = false;

  // U-097: onFinalì—ì„œ ë³´ê´€í•œ ì´ë¯¸ì§€ ì¡ (onCompleteì—ì„œ ì‹¤í–‰)
  let pendingImageJob: { should_generate: boolean; prompt: string; model_label?: string } | null =
    null;

  // U-089: ì •ë°€ë¶„ì„ ì˜¤ë²„ë ˆì´ ìµœì†Œ í‘œì‹œ ì‹œê°„ ê´€ë¦¬
  let analyzingStartTime = 0;

  /**
   * í„´ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
   */
  const runTurn = (params: RunTurnParams): void => {
    // ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì´ë©´ ë¬´ì‹œ
    const isStreaming = useAgentStore.getState().isStreaming;
    if (isStreaming) return;

    // Store ì•¡ì…˜ ê°€ì ¸ì˜¤ê¸° (í´ë¡œì € ì™¸ë¶€ì—ì„œ í˜¸ì¶œ ì‹œì ì— ìµœì‹  ìƒíƒœ ì°¸ì¡°)
    const agentStore = useAgentStore.getState();
    const worldStore = useWorldStore.getState();

    // U-089: ì •ë°€ë¶„ì„ íŠ¸ë¦¬ê±° ê°ì§€
    const visionAnalysis = isVisionTrigger(params.actionId, params.text);

    /**
     * U-089: ë¶„ì„ ìƒíƒœë¥¼ í•´ì œí•©ë‹ˆë‹¤.
     * ìµœì†Œ í‘œì‹œ ì‹œê°„(500ms)ì„ ë³´ì¥í•˜ì—¬ ì˜¤ë²„ë ˆì´ ê¹œë¹¡ì„ì„ ë°©ì§€í•©ë‹ˆë‹¤.
     */
    const finishAnalyzing = () => {
      const elapsed = Date.now() - analyzingStartTime;
      const remaining = ANALYZING_MIN_DISPLAY_MS - elapsed;
      if (remaining > 0) {
        setTimeout(() => {
          useWorldStore.getState().setIsAnalyzing(false);
        }, remaining);
      } else {
        useWorldStore.getState().setIsAnalyzing(false);
      }
    };

    // ì¬í™” ìŠ¤ëƒ…ìƒ· ê°€ì ¸ì˜¤ê¸°
    // U-097: credit í•„ë“œëŠ” EconomyOutput ì „ìš©ì´ë¯€ë¡œ ì…ë ¥ ìŠ¤ëƒ…ìƒ·ì—ì„œ ì œì™¸
    // (ë°±ì—”ë“œ EconomySnapshotì€ extra="forbid"ë¡œ ì„¤ì •ë¨)
    const { signal, memory_shard } = worldStore.economy;
    const economySnapshot = { signal, memory_shard };

    // U-068: ì´ì „ ì´ë¯¸ì§€ URL ê°€ì ¸ì˜¤ê¸° (ì°¸ì¡° ì´ë¯¸ì§€ë¡œ ì‚¬ìš©)
    const previousImageUrl =
      worldStore.sceneState.imageUrl ?? worldStore.sceneState.previousImageUrl;

    // TurnInput ìƒì„± (U-044: ì£¼ì…ëœ ì„¸ì…˜ ì–¸ì–´ ì‚¬ìš©)
    const turnInput = buildTurnInput({
      text:
        params.text ||
        (params.actionId ? t('action.card_select', { cardId: params.actionId }) : ''),
      actionId: params.actionId,
      click: params.click,
      drop: params.drop,
      economySnapshot,
      theme,
      language,
      previousImageUrl,
    });

    // Agent Store ì‹œì‘
    agentStore.startStream();

    // U-089: ì •ë°€ë¶„ì„ ì‹œ isAnalyzing í™œì„±í™” (ê¸°ì¡´ ì´ë¯¸ì§€ ìœ ì§€ + ë¶„ì„ ì˜¤ë²„ë ˆì´)
    if (visionAnalysis) {
      worldStore.setIsAnalyzing(true);
      analyzingStartTime = Date.now();
    }

    // U-071: ì²˜ë¦¬ ë‹¨ê³„ë¥¼ 'processing'ìœ¼ë¡œ ì „í™˜
    worldStore.setProcessingPhase('processing');

    // U-089: ì •ë°€ë¶„ì„ ì‹œ Scene ìƒíƒœë¥¼ ë³€ê²½í•˜ì§€ ì•ŠìŒ (ê¸°ì¡´ ì´ë¯¸ì§€ ìœ ì§€)
    // ì¼ë°˜ í„´: Scene Canvasë¥¼ ë¡œë”© ìƒíƒœë¡œ ì „í™˜ (U-031)
    if (!visionAnalysis) {
      worldStore.setSceneState({ status: 'loading', message: t('scene.status.syncing') });
    }

    // ìŠ¤íŠ¸ë¦¼ ì½œë°± ì„¤ì • (RU-003-Q3: agentStore + worldStoreë¡œ ë¼ìš°íŒ…)
    // RU-003-T1: sceneState ì „ì´ëŠ” worldStore.applyTurnOutputì—ì„œ SSOTë¡œ ì²˜ë¦¬
    const callbacks: StreamCallbacks = {
      // Stage/Badges/NarrativeDelta â†’ agentStoreë¡œë§Œ ì „ë‹¬
      onStage: (event) => {
        useAgentStore.getState().handleStage(event);
      },
      onBadges: (event) => {
        useAgentStore.getState().handleBadges(event);
      },
      onNarrativeDelta: (event) => {
        useAgentStore.getState().handleNarrativeDelta(event);
      },
      // Final â†’ agentStore.handleFinal + worldStore.applyTurnOutput
      // U-097: onFinalì—ì„œëŠ” í…ìŠ¤íŠ¸/ìƒíƒœë§Œ ë°˜ì˜. ì´ë¯¸ì§€ ìƒì„±ì€ onComplete ì´í›„ì— ì‹œì‘.
      //   ìŠ¤íŠ¸ë¦¬ë° ìˆœì„œ: narrative_delta Ã— N â†’ final â†’ (ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ) â†’ onComplete
      //   onCompleteì—ì„œ narrativeBuffer ì´ˆê¸°í™” í›„, ì´ë¯¸ì§€ ìƒì„±ì„ ë³„ë„ ì‹œì‘.
      //   ì´ë ‡ê²Œ í•˜ë©´ ì‚¬ìš©ìê°€ narrative_deltaë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë³¸ í›„, finalë¡œ entriesì— í™•ì •,
      //   ê·¸ ë‹¤ìŒì— ì´ë¯¸ì§€ ìƒì„±ì´ ì‹œì‘ë˜ë¯€ë¡œ text-first deliveryê°€ ë³´ì¥ë¨.
      onFinal: (event) => {
        // U-097: ì´ë¯¸ì§€ ì¡ ì •ë³´ë¥¼ ë³´ê´€ (onCompleteì—ì„œ ì‚¬ìš©)
        pendingImageJob = event.data.render?.image_job ?? null;

        useAgentStore.getState().handleFinal(event);
        // U-071: ê²°ê³¼ ë Œë”ë§ ë‹¨ê³„ë¡œ ì „í™˜
        useWorldStore.getState().setProcessingPhase('rendering');
        // RU-003-Q4: TurnOutput ë°˜ì˜ SSOT
        useWorldStore.getState().applyTurnOutput(event.data);
        // RU-003-S1: ì„±ê³µì ì¸ final ìˆ˜ì‹  ì‹œ ì—°ê²° ìƒíƒœ ë‚™ê´€ì  ë³µêµ¬
        useWorldStore.getState().setConnected(true);
      },
      // Error â†’ agentStore.handleError + worldStore ìƒíƒœ ë³µêµ¬
      onError: (event) => {
        useAgentStore.getState().handleError(event);
        useWorldStore.getState().setConnected(false);
        // U-071: ì—ëŸ¬ ì‹œ idleë¡œ ì „í™˜
        useWorldStore.getState().setProcessingPhase('idle');
        // U-089: ì—ëŸ¬ ì‹œ ë¶„ì„ ìƒíƒœ í•´ì œ (ìµœì†Œ í‘œì‹œ ì‹œê°„ ì ìš©)
        if (visionAnalysis) {
          finishAnalyzing();
        }
        // Scene Canvasë¥¼ ì˜¤í”„ë¼ì¸/ì—ëŸ¬ ìƒíƒœë¡œ ì „í™˜ (U-031)
        const errorCode = event.code;
        if (errorCode === 'SAFETY_BLOCKED') {
          useWorldStore.getState().setSceneState({ status: 'blocked', message: event.message });
        } else if (errorCode === 'INSUFFICIENT_BALANCE') {
          useWorldStore.getState().setSceneState({ status: 'low_signal', message: event.message });
        } else {
          useWorldStore.getState().setSceneState({ status: 'offline', message: event.message });
        }
      },
      // Complete â†’ U-097: ì´ë¯¸ì§€ ìƒì„± ì‹œì‘ (text-first delivery)
      // ì´ ì‹œì ì—ì„œ narrative_delta ìŠ¤íŠ¸ë¦¬ë°ì´ ëª¨ë‘ ëë‚˜ê³  finalì´ ì²˜ë¦¬ëœ ìƒíƒœ.
      // narrativeBufferê°€ ë¹„ì›Œì§€ê³ , entriesì— í…ìŠ¤íŠ¸ê°€ í™•ì •ëœ ì´í›„ì— ì´ë¯¸ì§€ ìƒì„±ì„ ì‹œì‘í•œë‹¤.
      // U-087: ì´ë¯¸ì§€ ì¡ì´ ìˆìœ¼ë©´ completeStream()ì„ ì´ë¯¸ì§€ ì™„ë£Œê¹Œì§€ ì§€ì—°í•˜ì—¬
      //   Agent Console ëŒ€ê¸°ì—´ì—ì„œ Render ë‹¨ê³„ê°€ "ì§„í–‰ ì¤‘(â—)"ìœ¼ë¡œ ìœ ì§€ë˜ë„ë¡ í•œë‹¤.
      onComplete: () => {
        // U-089: í„´ ì™„ë£Œ ì‹œ ë¶„ì„ ìƒíƒœ í•´ì œ (ìµœì†Œ í‘œì‹œ ì‹œê°„ ì ìš©)
        if (visionAnalysis) {
          finishAnalyzing();
        }

        // U-097: ì´ë¯¸ì§€ ì¡ì´ ìˆìœ¼ë©´ ì´ ì‹œì ì—ì„œ ë¹„ë™ê¸° ìƒì„± ì‹œì‘ (text-first delivery)
        const job = pendingImageJob;
        pendingImageJob = null;

        if (job?.should_generate && job.prompt) {
          // U-080: StrictMode ëŒ€ì‘ - ì¤‘ë³µ ìš”ì²­ ë°©ì§€
          if (imageJobPending) {
            useAgentStore.getState().completeStream();
            useWorldStore.getState().setProcessingPhase('idle');
            return;
          }
          imageJobPending = true;

          // U-087: Render ë‹¨ê³„ë¥¼ ë‹¤ì‹œ in_progressë¡œ ì„¤ì • (ì´ë¯¸ì§€ ë Œë”ë§ ì§„í–‰ í‘œì‹œ)
          useAgentStore.getState().handleStage({
            type: 'stage',
            name: 'render',
            status: 'start',
          });

          // U-071: ì´ë¯¸ì§€ ìƒì„± ëŒ€ê¸° ë‹¨ê³„ë¡œ ì „í™˜
          useWorldStore.getState().setProcessingPhase('image_pending');

          const worldStore = useWorldStore.getState();
          const currentTurnId = worldStore.turnCount;

          // U-068: ì´ì „ ì¥ë©´ ì´ë¯¸ì§€ URL ê°€ì ¸ì˜¤ê¸° (ì°¸ì¡° ì´ë¯¸ì§€ë¡œ ì‚¬ìš©)
          const previousImageUrl =
            worldStore.sceneState.imageUrl ?? worldStore.sceneState.previousImageUrl;

          // ì´ì „ ì´ë¯¸ì§€ ì¡ ì·¨ì†Œ
          imageJobController?.abort();

          // ì´ë¯¸ì§€ ë¡œë”© ìƒíƒœë¡œ ì „í™˜
          worldStore.setImageLoading(currentTurnId);

          // ëª¨ë¸ ë¼ë²¨ ê²°ì •
          const modelLabel: ImageModelLabel = job.model_label === 'FAST' ? 'FAST' : 'QUALITY';

          // U-085: Scene Canvas í¬ê¸° ê¸°ë°˜ aspect_ratio/image_size ì„ íƒ
          const { width: cw, height: ch } = worldStore.sceneCanvasSize;
          const sizing = selectImageSizing(cw, ch);

          // ì´ë¯¸ì§€ ìƒì„± ì‹œì‘
          imageJobController = startImageGeneration(
            {
              prompt: job.prompt,
              language,
              aspectRatio: sizing.aspectRatio,
              imageSize: sizing.imageSize,
              modelLabel,
              turnId: currentTurnId,
              referenceImageUrl: previousImageUrl,
            },
            (response) => {
              imageJobPending = false;
              if (response.success && response.imageUrl && response.turnId !== undefined) {
                useWorldStore.getState().applyLateBindingImage(response.imageUrl, response.turnId);
              } else {
                useWorldStore.getState().cancelImageLoading();
              }
              // U-087: Render ë‹¨ê³„ ì™„ë£Œ í›„ ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ
              useAgentStore.getState().handleStage({
                type: 'stage',
                name: 'render',
                status: 'complete',
              });
              useAgentStore.getState().completeStream();
              useWorldStore.getState().setProcessingPhase('idle');
            },
            () => {
              imageJobPending = false;
              useWorldStore.getState().cancelImageLoading();
              // U-087: ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨ ì‹œì—ë„ Render ë‹¨ê³„ ì™„ë£Œ + ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ
              useAgentStore.getState().handleStage({
                type: 'stage',
                name: 'render',
                status: 'complete',
              });
              useAgentStore.getState().completeStream();
              useWorldStore.getState().setProcessingPhase('idle');
            },
          );
        } else {
          // ì´ë¯¸ì§€ ì¡ì´ ì—†ìœ¼ë©´ ë°”ë¡œ ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ + idle
          useAgentStore.getState().completeStream();
          useWorldStore.getState().setProcessingPhase('idle');
        }
      },
    };

    // ìŠ¤íŠ¸ë¦¼ ì‹œì‘
    cancelFn = startTurnStream(turnInput, callbacks);
  };

  /**
   * ìŠ¤íŠ¸ë¦¼ì„ ì·¨ì†Œí•©ë‹ˆë‹¤.
   *
   * ì¶”í›„ Cancel/Pause/Autopilot UXë¥¼ ìœ„í•œ ê¸°ë³¸ ê³¨ê²©ì…ë‹ˆë‹¤.
   * í˜„ì¬ executeTurnStreamì€ Abort ì‹œ onCompleteë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šìœ¼ë¯€ë¡œ,
   * Cancel ë²„íŠ¼ì„ ë„£ì„ ê³„íšì´ë¼ë©´ "ì·¨ì†Œ ì‹œ UI ë³µêµ¬ ì •ì±…"ì„ ë³„ë„ë¡œ ëª…ì‹œí•´ì•¼ í•©ë‹ˆë‹¤.
   */
  const cancel = (): void => {
    cancelFn?.();
    cancelFn = null;
  };

  return {
    runTurn,
    cancel,
  };
}

// =============================================================================
// React Hook (ì„ íƒì  ì‚¬ìš©)
// =============================================================================

/**
 * Turn Runnerë¥¼ React ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•œ í›….
 *
 * U-044: ì„¸ì…˜ ì–¸ì–´ë¥¼ ì™¸ë¶€ì—ì„œ ì£¼ì…ë°›ì•„ TurnInput ìƒì„± ì‹œ SSOT ìœ ì§€.
 *
 * @param deps - ì˜ì¡´ì„± (i18n ë²ˆì—­ í•¨ìˆ˜, í…Œë§ˆ, ì„¸ì…˜ ì–¸ì–´)
 * @returns Turn Runner ì¸í„°í˜ì´ìŠ¤ ë° ì·¨ì†Œ íš¨ê³¼
 *
 * @example
 * ```tsx
 * // ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©
 * const { runTurn, cancel } = useTurnRunner({
 *   t,
 *   theme: 'dark',
 *   language: sessionLanguage, // U-044: ì„¸ì…˜ ì–¸ì–´ SSOT
 * });
 * ```
 */

export function useTurnRunner(deps: {
  t: (key: string, options?: Record<string, unknown>) => string;
  theme: 'dark' | 'light';
  /** U-044: ì„¸ì…˜ ì–¸ì–´ (SSOT) */
  language: Language;
}): TurnRunner {
  const { t, theme, language } = deps;

  // ì·¨ì†Œ í•¨ìˆ˜ ì €ì¥ ref
  const cancelFnRef = useRef<(() => void) | null>(null);

  // U-066: ì´ë¯¸ì§€ ì¡ AbortController ref
  const imageJobControllerRef = useRef<AbortController | null>(null);

  // U-080: ì´ë¯¸ì§€ ìƒì„± ìš”ì²­ ì¤‘ë³µ ë°©ì§€ (StrictMode ëŒ€ì‘)
  const imageJobPendingRef = useRef<boolean>(false);

  // U-097: text-first delivery - ì´ë¯¸ì§€ ì¡ì„ onFinalì—ì„œ ë³´ê´€, onCompleteì—ì„œ ì‹¤í–‰
  const pendingImageJobRef = useRef<{
    should_generate: boolean;
    prompt: string;
    model_label?: string;
  } | null>(null);

  // U-089: ì •ë°€ë¶„ì„ ì˜¤ë²„ë ˆì´ ìµœì†Œ í‘œì‹œ ì‹œê°„ ê´€ë¦¬
  const analyzingStartTimeRef = useRef<number>(0);

  // runTurnì„ useCallbackìœ¼ë¡œ ì •ì˜
  const runTurn = useCallback(
    (params: RunTurnParams): void => {
      // ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì´ë©´ ë¬´ì‹œ
      const isStreaming = useAgentStore.getState().isStreaming;
      if (isStreaming) return;

      // Store ì•¡ì…˜ ê°€ì ¸ì˜¤ê¸°
      const agentStore = useAgentStore.getState();
      const worldStore = useWorldStore.getState();

      // U-089: ì •ë°€ë¶„ì„ íŠ¸ë¦¬ê±° ê°ì§€
      const visionAnalysis = isVisionTrigger(params.actionId, params.text);

      /**
       * U-089: ë¶„ì„ ìƒíƒœë¥¼ í•´ì œí•©ë‹ˆë‹¤.
       * ìµœì†Œ í‘œì‹œ ì‹œê°„(500ms)ì„ ë³´ì¥í•˜ì—¬ ì˜¤ë²„ë ˆì´ ê¹œë¹¡ì„ì„ ë°©ì§€í•©ë‹ˆë‹¤.
       */
      const finishAnalyzing = () => {
        const elapsed = Date.now() - analyzingStartTimeRef.current;
        const remaining = ANALYZING_MIN_DISPLAY_MS - elapsed;
        if (remaining > 0) {
          setTimeout(() => {
            useWorldStore.getState().setIsAnalyzing(false);
          }, remaining);
        } else {
          useWorldStore.getState().setIsAnalyzing(false);
        }
      };

      // ì¬í™” ìŠ¤ëƒ…ìƒ· ê°€ì ¸ì˜¤ê¸°
      // U-097: credit í•„ë“œëŠ” EconomyOutput ì „ìš©ì´ë¯€ë¡œ ì…ë ¥ ìŠ¤ëƒ…ìƒ·ì—ì„œ ì œì™¸
      // (ë°±ì—”ë“œ EconomySnapshotì€ extra="forbid"ë¡œ ì„¤ì •ë¨)
      const { signal, memory_shard } = worldStore.economy;
      const economySnapshot = { signal, memory_shard };

      // U-068: ì´ì „ ì´ë¯¸ì§€ URL ê°€ì ¸ì˜¤ê¸° (ì°¸ì¡° ì´ë¯¸ì§€ë¡œ ì‚¬ìš©)
      const previousImageUrl =
        worldStore.sceneState.imageUrl ?? worldStore.sceneState.previousImageUrl;

      // TurnInput ìƒì„± (U-044: ì£¼ì…ëœ ì„¸ì…˜ ì–¸ì–´ ì‚¬ìš©)
      const turnInput = buildTurnInput({
        text:
          params.text ||
          (params.actionId ? t('action.card_select', { cardId: params.actionId }) : ''),
        actionId: params.actionId,
        click: params.click,
        drop: params.drop,
        economySnapshot,
        theme,
        language,
        previousImageUrl,
      });

      // Agent Store ì‹œì‘
      agentStore.startStream();

      // U-089: ì •ë°€ë¶„ì„ ì‹œ isAnalyzing í™œì„±í™” (ê¸°ì¡´ ì´ë¯¸ì§€ ìœ ì§€ + ë¶„ì„ ì˜¤ë²„ë ˆì´)
      if (visionAnalysis) {
        worldStore.setIsAnalyzing(true);
        analyzingStartTimeRef.current = Date.now();
      }

      // U-071: ì²˜ë¦¬ ë‹¨ê³„ë¥¼ 'processing'ìœ¼ë¡œ ì „í™˜
      worldStore.setProcessingPhase('processing');

      // U-089: ì •ë°€ë¶„ì„ ì‹œ Scene ìƒíƒœë¥¼ ë³€ê²½í•˜ì§€ ì•ŠìŒ (ê¸°ì¡´ ì´ë¯¸ì§€ ìœ ì§€)
      // ì¼ë°˜ í„´: Scene Canvasë¥¼ ë¡œë”© ìƒíƒœë¡œ ì „í™˜ (U-031)
      if (!visionAnalysis) {
        worldStore.setSceneState({ status: 'loading', message: t('scene.status.syncing') });
      }

      // ìŠ¤íŠ¸ë¦¼ ì½œë°± ì„¤ì • (RU-003-Q3: agentStore + worldStoreë¡œ ë¼ìš°íŒ…)
      // RU-003-T1: sceneState ì „ì´ëŠ” worldStore.applyTurnOutputì—ì„œ SSOTë¡œ ì²˜ë¦¬
      const callbacks: StreamCallbacks = {
        onStage: (event) => {
          useAgentStore.getState().handleStage(event);
        },
        onBadges: (event) => {
          useAgentStore.getState().handleBadges(event);
        },
        onNarrativeDelta: (event) => {
          useAgentStore.getState().handleNarrativeDelta(event);
        },
        // U-097: onFinalì—ì„œëŠ” í…ìŠ¤íŠ¸/ìƒíƒœë§Œ ë°˜ì˜. ì´ë¯¸ì§€ ìƒì„±ì€ onCompleteì—ì„œ ì‹œì‘.
        onFinal: (event) => {
          pendingImageJobRef.current = event.data.render?.image_job ?? null;

          useAgentStore.getState().handleFinal(event);
          useWorldStore.getState().setProcessingPhase('rendering');
          useWorldStore.getState().applyTurnOutput(event.data);
          useWorldStore.getState().setConnected(true);
        },
        onError: (event) => {
          useAgentStore.getState().handleError(event);
          useWorldStore.getState().setConnected(false);
          useWorldStore.getState().setProcessingPhase('idle');
          if (visionAnalysis) {
            finishAnalyzing();
          }
          const errorCode = event.code;
          if (errorCode === 'SAFETY_BLOCKED') {
            useWorldStore.getState().setSceneState({ status: 'blocked', message: event.message });
          } else if (errorCode === 'INSUFFICIENT_BALANCE') {
            useWorldStore
              .getState()
              .setSceneState({ status: 'low_signal', message: event.message });
          } else {
            useWorldStore.getState().setSceneState({ status: 'offline', message: event.message });
          }
        },
        // U-097: onCompleteì—ì„œ ì´ë¯¸ì§€ ìƒì„± ì‹œì‘ (text-first delivery)
        // ì´ ì‹œì ì—ì„œ narrative_delta ìŠ¤íŠ¸ë¦¬ë° + final ì²˜ë¦¬ê°€ ëª¨ë‘ ì™„ë£Œëœ ìƒíƒœ.
        // U-087: ì´ë¯¸ì§€ ì¡ì´ ìˆìœ¼ë©´ completeStream()ì„ ì´ë¯¸ì§€ ì™„ë£Œê¹Œì§€ ì§€ì—°í•˜ì—¬
        //   Agent Console ëŒ€ê¸°ì—´ì—ì„œ Render ë‹¨ê³„ê°€ "ì§„í–‰ ì¤‘(â—)"ìœ¼ë¡œ ìœ ì§€ë˜ë„ë¡ í•œë‹¤.
        onComplete: () => {
          if (visionAnalysis) {
            finishAnalyzing();
          }

          // U-097: ì´ë¯¸ì§€ ì¡ì´ ìˆìœ¼ë©´ ì´ ì‹œì ì—ì„œ ë¹„ë™ê¸° ìƒì„± ì‹œì‘
          const job = pendingImageJobRef.current;
          pendingImageJobRef.current = null;

          if (job?.should_generate && job.prompt) {
            if (imageJobPendingRef.current) {
              useAgentStore.getState().completeStream();
              useWorldStore.getState().setProcessingPhase('idle');
              return;
            }
            imageJobPendingRef.current = true;

            // U-087: Render ë‹¨ê³„ë¥¼ ë‹¤ì‹œ in_progressë¡œ ì„¤ì • (ì´ë¯¸ì§€ ë Œë”ë§ ì§„í–‰ í‘œì‹œ)
            useAgentStore.getState().handleStage({
              type: 'stage',
              name: 'render',
              status: 'start',
            });

            useWorldStore.getState().setProcessingPhase('image_pending');

            const worldStore = useWorldStore.getState();
            const currentTurnId = worldStore.turnCount;
            const previousImageUrl =
              worldStore.sceneState.imageUrl ?? worldStore.sceneState.previousImageUrl;

            imageJobControllerRef.current?.abort();
            worldStore.setImageLoading(currentTurnId);

            const modelLabel: ImageModelLabel = job.model_label === 'FAST' ? 'FAST' : 'QUALITY';
            const { width: cw, height: ch } = worldStore.sceneCanvasSize;
            const sizing = selectImageSizing(cw, ch);

            imageJobControllerRef.current = startImageGeneration(
              {
                prompt: job.prompt,
                language,
                aspectRatio: sizing.aspectRatio,
                imageSize: sizing.imageSize,
                modelLabel,
                turnId: currentTurnId,
                referenceImageUrl: previousImageUrl,
              },
              (response) => {
                imageJobPendingRef.current = false;
                if (response.success && response.imageUrl && response.turnId !== undefined) {
                  useWorldStore
                    .getState()
                    .applyLateBindingImage(response.imageUrl, response.turnId);
                } else {
                  useWorldStore.getState().cancelImageLoading();
                }
                // U-087: Render ë‹¨ê³„ ì™„ë£Œ í›„ ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ
                useAgentStore.getState().handleStage({
                  type: 'stage',
                  name: 'render',
                  status: 'complete',
                });
                useAgentStore.getState().completeStream();
                useWorldStore.getState().setProcessingPhase('idle');
              },
              () => {
                imageJobPendingRef.current = false;
                useWorldStore.getState().cancelImageLoading();
                // U-087: ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨ ì‹œì—ë„ Render ë‹¨ê³„ ì™„ë£Œ + ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ
                useAgentStore.getState().handleStage({
                  type: 'stage',
                  name: 'render',
                  status: 'complete',
                });
                useAgentStore.getState().completeStream();
                useWorldStore.getState().setProcessingPhase('idle');
              },
            );
          } else {
            // ì´ë¯¸ì§€ ì¡ì´ ì—†ìœ¼ë©´ ë°”ë¡œ ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ + idle
            useAgentStore.getState().completeStream();
            useWorldStore.getState().setProcessingPhase('idle');
          }
        },
      };

      // ìŠ¤íŠ¸ë¦¼ ì‹œì‘ ë° ì·¨ì†Œ í•¨ìˆ˜ ì €ì¥
      cancelFnRef.current = startTurnStream(turnInput, callbacks);
    },
    [t, theme, language],
  );

  // cancel í•¨ìˆ˜
  const cancel = useCallback((): void => {
    cancelFnRef.current?.();
    cancelFnRef.current = null;
  }, []);

  // ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ ìŠ¤íŠ¸ë¦¼ ë° ì´ë¯¸ì§€ ì¡ ì·¨ì†Œ
  useEffect(() => {
    return () => {
      cancelFnRef.current?.();
      imageJobControllerRef.current?.abort();
    };
  }, []);

  return { runTurn, cancel };
}
</file>

<file path="frontend/src/schemas/turn.ts">
/**
 * Unknown World - TurnInput/TurnOutput Zod ìŠ¤í‚¤ë§ˆ.
 *
 * ì´ ëª¨ë“ˆì€ ë°±ì—”ë“œ Pydantic ëª¨ë¸(U-005)ê³¼ 1:1 ëŒ€ì‘í•˜ëŠ” Zod ìŠ¤í‚¤ë§ˆë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
 * í´ë¼ì´ì–¸íŠ¸ ì¸¡ ê²€ì¦ ë° íƒ€ì… ì•ˆì „ì„±ì„ ì œê³µí•©ë‹ˆë‹¤.
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - RULE-003: êµ¬ì¡°í™” ì¶œë ¥(JSON Schema) ìš°ì„  + ì´ì¤‘ ê²€ì¦ (ì„œë²„ Pydantic + í´ë¼ Zod)
 *   - RULE-004: ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì•ˆì „ í´ë°± ì œê³µ (UI ë©ˆì¶¤ ë°©ì§€)
 *   - RULE-005: ì¬í™” ì¸ë°”ë¦¬ì–¸íŠ¸ (cost, balance_after í•„ìˆ˜, ì”ì•¡ ìŒìˆ˜ ê¸ˆì§€)
 *   - RULE-006: ko/en ì–¸ì–´ ì •ì±… (Language enumìœ¼ë¡œ ê³ ì •)
 *   - RULE-009: ì¢Œí‘œ ê·œì•½ (0~1000, bbox [ymin,xmin,ymax,xmax])
 *
 * Q1 ê²°ì • ì‚¬í•­:
 *   - schema_version í¬í•¨ (Option A): SaveGame/ë§ˆì´ê·¸ë ˆì´ì…˜/ê²€ì¦ì— ìœ ë¦¬
 *
 * @module schemas/turn
 */

import { z } from 'zod';

// =============================================================================
// ìŠ¤í‚¤ë§ˆ ë²„ì „ (Q1 ê²°ì •: Option A - í¬í•¨)
// =============================================================================

/**
 * í˜„ì¬ ìŠ¤í‚¤ë§ˆ ë²„ì „.
 * SaveGame/ë§ˆì´ê·¸ë ˆì´ì…˜/ê²€ì¦ì— ì‚¬ìš©ë©ë‹ˆë‹¤.
 */
export const SCHEMA_VERSION = '1.0.0' as const;

// =============================================================================
// ê³µí†µ Enum íƒ€ì…
// =============================================================================

/**
 * ì§€ì› ì–¸ì–´ (RULE-006).
 * ko/en í˜¼í•© ì¶œë ¥ ê¸ˆì§€. TurnInput.languageë¥¼ SSOTë¡œ ì‚¼ì•„
 * ëª¨ë“  UI/ë‚´ëŸ¬í‹°ë¸Œ/ì‹œìŠ¤í…œ ë©”ì‹œì§€ëŠ” ë™ì¼ ì–¸ì–´ë¡œ ê³ ì •í•©ë‹ˆë‹¤.
 */
export const LanguageSchema = z.enum(['ko-KR', 'en-US']);
export type Language = z.infer<typeof LanguageSchema>;

/**
 * í…Œë§ˆ ì„¤ì •.
 */
export const ThemeSchema = z.enum(['dark', 'light']);
export type Theme = z.infer<typeof ThemeSchema>;

/**
 * ì—ì´ì „íŠ¸ ì‹¤í–‰ ë‹¨ê³„ (RULE-008).
 * ì—ì´ì „íŠ¸í˜• ì‹œìŠ¤í…œì„ì„ UIë¡œ ì¦ëª…í•˜ê¸° ìœ„í•œ ë‹¨ê³„ í‘œì‹œ.
 */
export const AgentPhaseSchema = z.enum([
  'parse',
  'validate',
  'plan',
  'resolve',
  'render',
  'verify',
  'commit',
]);
export type AgentPhase = z.infer<typeof AgentPhaseSchema>;

/**
 * ê²€ì¦ ë°°ì§€ (RULE-008).
 * í„´ ê²°ê³¼ì— ëŒ€í•œ ê²€ì¦ ìƒíƒœë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
 */
export const ValidationBadgeSchema = z.enum([
  'schema_ok',
  'schema_fail',
  'economy_ok',
  'economy_fail',
  'safety_ok',
  'safety_blocked',
  'consistency_ok',
  'consistency_fail',
]);
export type ValidationBadge = z.infer<typeof ValidationBadgeSchema>;

/**
 * ëª¨ë¸/í’ˆì§ˆ ì„ íƒ ë¼ë²¨ (RULE-008).
 * í”„ë¡¬í”„íŠ¸ ë…¸ì¶œ ì—†ì´ "ì™œ ì´ ì„ íƒì´ì—ˆëŠ”ì§€"ë¥¼ ì‚¬ìš©ì ì¹œí™” ë¼ë²¨ë¡œ í‘œì‹œ.
 */
export const ModelLabelSchema = z.enum(['FAST', 'QUALITY', 'CHEAP', 'REF']);
export type ModelLabel = z.infer<typeof ModelLabelSchema>;

/**
 * í–‰ë™ ìœ„í—˜ë„ ìˆ˜ì¤€.
 */
export const RiskLevelSchema = z.enum(['low', 'medium', 'high']);
export type RiskLevel = z.infer<typeof RiskLevelSchema>;

// =============================================================================
// ê³µí†µ í•˜ìœ„ íƒ€ì…
// =============================================================================

/**
 * ì •ê·œí™” ì¢Œí‘œ (RULE-009).
 * 0~1000 ë²”ìœ„ì˜ ì •ìˆ˜ì…ë‹ˆë‹¤.
 */
export const CoordinateSchema = z.number().int().min(0).max(1000).describe('ì •ê·œí™” ì¢Œí‘œ (0~1000)');
export type Coordinate = z.infer<typeof CoordinateSchema>;

/**
 * 2D ë°”ìš´ë”© ë°•ìŠ¤ (RULE-009).
 * ì¢Œí‘œëŠ” 0~1000 ì •ê·œí™” ì¢Œí‘œê³„ì´ë©°, bboxëŠ” [ymin, xmin, ymax, xmax] ìˆœì„œì…ë‹ˆë‹¤.
 * ì´ë¯¸ì§€ ì´í•´ bbox í¬ë§·ê³¼ í˜¸í™˜ë©ë‹ˆë‹¤.
 */
export const Box2DSchema = z
  .object({
    ymin: CoordinateSchema.describe('Y ìµœì†Œê°’ (ìƒë‹¨)'),
    xmin: CoordinateSchema.describe('X ìµœì†Œê°’ (ì¢Œì¸¡)'),
    ymax: CoordinateSchema.describe('Y ìµœëŒ€ê°’ (í•˜ë‹¨)'),
    xmax: CoordinateSchema.describe('X ìµœëŒ€ê°’ (ìš°ì¸¡)'),
  })
  .strict();
export type Box2D = z.infer<typeof Box2DSchema>;

/**
 * ì¬í™” ìˆ˜ëŸ‰.
 * signalê³¼ memory_shardëŠ” 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤ (RULE-005).
 */
export const CurrencyAmountSchema = z
  .object({
    signal: z.number().int().min(0).describe('ì‹œê·¸ë„ (ê¸°ë³¸ ì¬í™”, 0 ì´ìƒ)'),
    memory_shard: z.number().int().min(0).describe('ê¸°ì–µ íŒŒí¸ (í¬ê·€ ì¬í™”, 0 ì´ìƒ)'),
  })
  .strict();
export type CurrencyAmount = z.infer<typeof CurrencyAmountSchema>;

// =============================================================================
// TurnInput ê´€ë ¨ íƒ€ì…
// =============================================================================

/**
 * í´ë¦­ ì…ë ¥ ì •ë³´.
 * í™”ë©´ ì˜¤ë¸Œì íŠ¸ í´ë¦­ ì‹œ ì „ë‹¬ë˜ëŠ” ì •ë³´ì…ë‹ˆë‹¤.
 */
export const ClickInputSchema = z
  .object({
    object_id: z.string().describe('í´ë¦­í•œ ì˜¤ë¸Œì íŠ¸ ID'),
    box_2d: Box2DSchema.nullable().default(null).describe('í´ë¦­ ìœ„ì¹˜ ë°”ìš´ë”© ë°•ìŠ¤ (ì„ íƒ)'),
  })
  .strict();
export type ClickInput = z.infer<typeof ClickInputSchema>;

/**
 * ë“œë¡­ ì…ë ¥ ì •ë³´ (U-012).
 * ì¸ë²¤í† ë¦¬ ì•„ì´í…œì„ í•«ìŠ¤íŒŸì— ë“œë¡­í•  ë•Œ ì „ë‹¬ë˜ëŠ” ì •ë³´ì…ë‹ˆë‹¤.
 * Q1 ê²°ì •: Option B - target_box_2d í¬í•¨í•˜ì—¬ ì„œë²„ê°€ ì •í™•í•œ ìœ„ì¹˜ í•´ì„ ê°€ëŠ¥.
 */
export const DropInputSchema = z
  .object({
    item_id: z.string().describe('ë“œë¡­í•œ ì¸ë²¤í† ë¦¬ ì•„ì´í…œ ID'),
    target_object_id: z.string().describe('ë“œë¡­ ëŒ€ìƒ í•«ìŠ¤íŒŸ ì˜¤ë¸Œì íŠ¸ ID'),
    target_box_2d: Box2DSchema.describe('ë“œë¡­ ëŒ€ìƒì˜ ë°”ìš´ë”© ë°•ìŠ¤ (0~1000 ì •ê·œí™”)'),
  })
  .strict();
export type DropInput = z.infer<typeof DropInputSchema>;

/**
 * í´ë¼ì´ì–¸íŠ¸ ì •ë³´.
 */
export const ClientInfoSchema = z
  .object({
    viewport_w: z.number().int().positive().describe('ë·°í¬íŠ¸ ë„ˆë¹„ (í”½ì…€, ì–‘ìˆ˜)'),
    viewport_h: z.number().int().positive().describe('ë·°í¬íŠ¸ ë†’ì´ (í”½ì…€, ì–‘ìˆ˜)'),
    theme: ThemeSchema.default('dark').describe('í˜„ì¬ í…Œë§ˆ'),
  })
  .strict();
export type ClientInfo = z.infer<typeof ClientInfoSchema>;

/**
 * ì¬í™” ìŠ¤ëƒ…ìƒ· (í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë²„).
 * í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ìœ í•œ í˜„ì¬ ì¬í™” ìƒíƒœì…ë‹ˆë‹¤.
 */
export const EconomySnapshotSchema = z
  .object({
    signal: z.number().int().min(0).describe('í˜„ì¬ ì‹œê·¸ë„ ì”ì•¡ (0 ì´ìƒ)'),
    memory_shard: z.number().int().min(0).describe('í˜„ì¬ ê¸°ì–µ íŒŒí¸ ì”ì•¡ (0 ì´ìƒ)'),
  })
  .strict();
export type EconomySnapshot = z.infer<typeof EconomySnapshotSchema>;

/**
 * í„´ ì…ë ¥ (í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë²„).
 * ì‚¬ìš©ìê°€ í„´ì„ ì§„í–‰í•  ë•Œ ì„œë²„ë¡œ ì „ì†¡í•˜ëŠ” ì…ë ¥ ë°ì´í„°ì…ë‹ˆë‹¤.
 *
 * U-012: drop í•„ë“œ ì¶”ê°€ - ì¸ë²¤í† ë¦¬ ì•„ì´í…œì„ í•«ìŠ¤íŒŸì— ë“œë¡­í•  ë•Œ ì‚¬ìš©.
 */
export const TurnInputSchema = z
  .object({
    language: LanguageSchema.describe('ìš”ì²­ ì–¸ì–´ (ì‘ë‹µë„ ë™ì¼ ì–¸ì–´ë¡œ ê³ ì •)'),
    text: z.string().default('').describe('ì‚¬ìš©ì ìì—°ì–´ ì…ë ¥'),
    action_id: z.string().nullable().default(null).describe('ì„ íƒí•œ ì•¡ì…˜ ì¹´ë“œ ID (ì„ íƒ)'),
    click: ClickInputSchema.nullable().default(null).describe('ì˜¤ë¸Œì íŠ¸ í´ë¦­ ì •ë³´ (ì„ íƒ)'),
    drop: DropInputSchema.nullable().default(null).describe('ì•„ì´í…œ ë“œë¡­ ì •ë³´ (ì„ íƒ, U-012)'),
    client: ClientInfoSchema.describe('í´ë¼ì´ì–¸íŠ¸ í™˜ê²½ ì •ë³´'),
    economy_snapshot: EconomySnapshotSchema.describe('í˜„ì¬ ì¬í™” ìƒíƒœ'),
    previous_image_url: z
      .string()
      .nullable()
      .default(null)
      .describe('ì´ì „ í„´ ì´ë¯¸ì§€ URL (U-068: ì°¸ì¡° ì´ë¯¸ì§€ë¡œ ì‚¬ìš©í•˜ì—¬ ì—°ì†ì„± ìœ ì§€)'),
  })
  .strict();
export type TurnInput = z.infer<typeof TurnInputSchema>;

// =============================================================================
// TurnOutput ê´€ë ¨ íƒ€ì… - UI
// =============================================================================

/**
 * ë¹„ìš© ì¶”ì •ì¹˜ (U-009: ìµœì†Œ/ìµœëŒ€ ë²”ìœ„).
 * í–‰ë™ì˜ ì˜ˆìƒ ë¹„ìš© ë²”ìœ„ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
 */
export const CostEstimateSchema = z
  .object({
    min: CurrencyAmountSchema.describe('ìµœì†Œ ì˜ˆìƒ ë¹„ìš©'),
    max: CurrencyAmountSchema.describe('ìµœëŒ€ ì˜ˆìƒ ë¹„ìš©'),
  })
  .strict();
export type CostEstimate = z.infer<typeof CostEstimateSchema>;

/**
 * ì•¡ì…˜ ì¹´ë“œ (Action Deck) - U-065 ë‹¨ìˆœí™”.
 * ë§¤ í„´ AIê°€ ì¶”ì²œí•˜ëŠ” í–‰ë™ ì¹´ë“œì…ë‹ˆë‹¤.
 *
 * U-065 ë‹¨ìˆœí™”:
 *   - ì œê±°ëœ í•„ë“œ: description, cost_estimate, hint, reward_hint, disabled_reason
 *   - risk, is_alternativeëŠ” ìœ ì§€ (ê²Œì„ ë©”ì¹´ë‹‰ì— í•„ìˆ˜)
 *   - ì œê±°ëœ ì •ë³´ëŠ” narrativeì—ì„œ ìì—°ì–´ë¡œ í‘œí˜„
 */
export const ActionCardSchema = z
  .object({
    id: z.string().describe('ì¹´ë“œ ê³ ìœ  ID'),
    label: z.string().describe('ì¹´ë“œ ë¼ë²¨ (í‘œì‹œìš©)'),
    cost: CurrencyAmountSchema.describe('ì˜ˆìƒ ë¹„ìš© (ê¸°ë³¸)'),
    risk: RiskLevelSchema.default('low').describe('ìœ„í—˜ë„'),
    enabled: z.boolean().default(true).describe('ì‹¤í–‰ ê°€ëŠ¥ ì—¬ë¶€ (ì„œë²„ íŒë‹¨)'),
    is_alternative: z.boolean().default(false).describe('ì €ë¹„ìš© ëŒ€ì•ˆ ì¹´ë“œ ì—¬ë¶€'),
  })
  .strict();
export type ActionCard = z.infer<typeof ActionCardSchema>;

/**
 * ì¥ë©´ ì˜¤ë¸Œì íŠ¸ (í´ë¦­ ê°€ëŠ¥í•œ í•«ìŠ¤íŒŸ).
 * ì¢Œí‘œëŠ” 0~1000 ì •ê·œí™” ì¢Œí‘œê³„ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤ (RULE-009).
 */
export const SceneObjectSchema = z
  .object({
    id: z.string().describe('ì˜¤ë¸Œì íŠ¸ ê³ ìœ  ID'),
    label: z.string().describe('ì˜¤ë¸Œì íŠ¸ ë¼ë²¨ (í‘œì‹œìš©)'),
    box_2d: Box2DSchema.describe('ë°”ìš´ë”© ë°•ìŠ¤'),
    interaction_hint: z.string().nullable().default(null).describe('ìƒí˜¸ì‘ìš© íŒíŠ¸ (ì„ íƒ)'),
  })
  .strict();
export type SceneObject = z.infer<typeof SceneObjectSchema>;

/**
 * ì•¡ì…˜ ë± (Q1 ê²°ì •: ui.action_deck.cards[] êµ¬ì¡°) - U-065 ë‹¨ìˆœí™”.
 * ë§¤ í„´ AIê°€ ì œì‹œí•˜ëŠ” ì¶”ì²œ í–‰ë™ ì¹´ë“œ ë±ì…ë‹ˆë‹¤.
 *
 * U-065 ë‹¨ìˆœí™”:
 *   - max_length: 10 â†’ 5 (Gemini ìŠ¤í‚¤ë§ˆ ì œí•œ ëŒ€ì‘, Q2 ê²°ì •)
 */
export const ActionDeckSchema = z
  .object({
    cards: z.array(ActionCardSchema).max(5).default([]).describe('ì•¡ì…˜ ì¹´ë“œ ëª©ë¡ (3~5ì¥ ê¶Œì¥)'),
  })
  .strict();
export type ActionDeck = z.infer<typeof ActionDeckSchema>;

/**
 * Scene í‘œì‹œ ì •ë³´ (RU-003-T1: Scene ì´ë¯¸ì§€ SSOT).
 *
 * TurnOutputì—ì„œ Scene Canvasì— í‘œì‹œí•  ì´ë¯¸ì§€ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
 * image_urlì´ ì¡´ì¬í•˜ë©´ SceneCanvasëŠ” 'scene' ìƒíƒœë¡œ ì „í™˜ë©ë‹ˆë‹¤.
 * image_urlì´ ì—†ìœ¼ë©´ 'default' ìƒíƒœë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
 */
export const SceneOutputSchema = z
  .object({
    image_url: z
      .string()
      .nullable()
      .default(null)
      .describe('Scene ì´ë¯¸ì§€ URL (ì¡´ì¬ ì‹œ scene ìƒíƒœë¡œ ì „í™˜)'),
    alt_text: z.string().nullable().default(null).describe('ì´ë¯¸ì§€ ëŒ€ì²´ í…ìŠ¤íŠ¸ (ì ‘ê·¼ì„±ìš©, ì„ íƒ)'),
  })
  .strict();
export type SceneOutput = z.infer<typeof SceneOutputSchema>;

/**
 * Scene ê¸°ë³¸ê°’ (null ëŒ€ì‘).
 */
const DEFAULT_SCENE_OUTPUT: SceneOutput = { image_url: null, alt_text: null };

/**
 * UI ì¶œë ¥ ë°ì´í„° - U-065 ë‹¨ìˆœí™”.
 * AIê°€ ìƒì„±í•œ UI ìš”ì†Œë“¤ì…ë‹ˆë‹¤.
 * ì±„íŒ… ë²„ë¸”ì´ ì•„ë‹Œ ê²Œì„ UIë¡œ í‘œí˜„ë©ë‹ˆë‹¤ (RULE-002).
 *
 * RU-003-T1: scene í•„ë“œ ì¶”ê°€ - Scene Canvasì˜ ì´ë¯¸ì§€ í‘œì‹œ ì •ë³´ SSOT.
 * U-065 ë‹¨ìˆœí™”: objects ë°°ì—´ í¬ê¸° ì œí•œ (ìµœëŒ€ 5ê°œ, Q2 ê²°ì •)
 *
 * ìˆ˜ì •: scene í•„ë“œëŠ” ë°±ì—”ë“œì—ì„œ nullë¡œ ì˜¬ ìˆ˜ ìˆìœ¼ë¯€ë¡œ nullish()ë¥¼ ì‚¬ìš©í•˜ì—¬
 * null/undefined ì‹œ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
 */
export const UIOutputSchema = z
  .object({
    action_deck: ActionDeckSchema.default({ cards: [] }).describe('ì•¡ì…˜ ì¹´ë“œ ë±'),
    objects: z
      .array(SceneObjectSchema)
      .max(5)
      .default([])
      .describe('í´ë¦­ ê°€ëŠ¥í•œ ì¥ë©´ ì˜¤ë¸Œì íŠ¸ ëª©ë¡ (ìµœëŒ€ 5ê°œ)'),
    scene: SceneOutputSchema.nullish()
      .transform((val) => val ?? DEFAULT_SCENE_OUTPUT)
      .describe('Scene í‘œì‹œ ì •ë³´ (RU-003-T1, null í—ˆìš©)'),
  })
  .strict();
export type UIOutput = z.infer<typeof UIOutputSchema>;

// =============================================================================
// TurnOutput ê´€ë ¨ íƒ€ì… - World
// =============================================================================

/**
 * ì¤‘ìš” ì„¤ì • ê³ ì • í›„ë³´.
 * ì‚¬ìš©ìê°€ Memory Shardë¥¼ ì†Œë¹„í•´ ê³ ì •í•  ìˆ˜ ìˆëŠ” ì¤‘ìš” ì„¤ì •ì…ë‹ˆë‹¤.
 */
export const MemoryPinSchema = z
  .object({
    id: z.string().describe('í•€ ê³ ìœ  ID'),
    content: z.string().describe('ê³ ì •í•  ë‚´ìš©'),
    cost: CurrencyAmountSchema.describe('ê³ ì •ì— í•„ìš”í•œ ë¹„ìš©'),
  })
  .strict();
export type MemoryPin = z.infer<typeof MemoryPinSchema>;

/**
 * ì„¸ê³„ ê·œì¹™ (Rule Board).
 * í˜„ì¬ ì„¸ê³„ì— ì ìš© ì¤‘ì¸ ë¬¼ë¦¬ ë²•ì¹™ì´ë‚˜ ë©”íƒ€ ê·œì¹™ì…ë‹ˆë‹¤.
 */
export const WorldRuleSchema = z
  .object({
    id: z.string().describe('ê·œì¹™ ê³ ìœ  ID'),
    label: z.string().describe('ê·œì¹™ ì´ë¦„'),
    description: z.string().nullable().default(null).describe('ê·œì¹™ ìƒì„¸ ì„¤ëª… (ì„ íƒ)'),
  })
  .strict();
export type WorldRule = z.infer<typeof WorldRuleSchema>;

/**
 * í€˜ìŠ¤íŠ¸/ëª©í‘œ (Quest Panel) - U-078 ëª©í‘œ ì‹œìŠ¤í…œ ê°•í™”.
 * í”Œë ˆì´ì–´ê°€ ë‹¬ì„±í•´ì•¼ í•˜ëŠ” í˜„ì¬ ëª©í‘œì…ë‹ˆë‹¤.
 * is_main=trueì¸ í€˜ìŠ¤íŠ¸ê°€ ì£¼ ëª©í‘œ(Main Objective)ë¡œ Quest íŒ¨ë„ ìƒë‹¨ì— ê°•ì¡° í‘œì‹œë©ë‹ˆë‹¤.
 */
export const QuestSchema = z
  .object({
    id: z.string().describe('í€˜ìŠ¤íŠ¸ ê³ ìœ  ID'),
    label: z.string().describe('í€˜ìŠ¤íŠ¸ ì´ë¦„'),
    is_completed: z.boolean().default(false).describe('ë‹¬ì„± ì—¬ë¶€'),
    description: z.string().nullable().default(null).describe('ëª©í‘œ ìƒì„¸ ì„¤ëª… (ì„ íƒ)'),
    is_main: z.boolean().default(false).describe('ì£¼ ëª©í‘œ ì—¬ë¶€'),
    progress: z.number().int().min(0).max(100).default(0).describe('ì§„í–‰ë¥  (0~100)'),
    reward_signal: z.number().int().min(0).default(0).describe('ë‹¬ì„± ì‹œ Signal ë³´ìƒëŸ‰'),
  })
  .strict();
export type Quest = z.infer<typeof QuestSchema>;

/**
 * ì¸ë²¤í† ë¦¬ ì•„ì´í…œ ë°ì´í„° (U-075[Mvp]).
 * TurnOutputì—ì„œ ì¶”ê°€ë˜ëŠ” ì•„ì´í…œì˜ ìƒì„¸ ì •ë³´ì…ë‹ˆë‹¤.
 */
export const InventoryItemDataSchema = z
  .object({
    id: z.string().describe('ì•„ì´í…œ ê³ ìœ  ID'),
    label: z.string().describe('ì•„ì´í…œ í‘œì‹œ ì´ë¦„ (í˜„ì¬ ì–¸ì–´ì— ë§ê²Œ)'),
    description: z.string().default('').describe('ì•„ì´í…œ ì„¤ëª… (ì•„ì´ì½˜ ìƒì„±ìš©)'),
    icon_url: z.string().nullable().default(null).describe('ì•„ì´ì½˜ URL (ì„ íƒ, ìºì‹œëœ ê²½ìš°)'),
    quantity: z.number().int().min(1).default(1).describe('ì•„ì´í…œ ìˆ˜ëŸ‰'),
  })
  .strict();
export type InventoryItemData = z.infer<typeof InventoryItemDataSchema>;

/**
 * ì„¸ê³„ ìƒíƒœ ë³€í™” (Q2 ê²°ì •: Option A - delta ì¤‘ì‹¬) - U-065 ë‹¨ìˆœí™”.
 * ì´ë²ˆ í„´ì—ì„œ ë³€ê²½ëœ ì„¸ê³„ ìƒíƒœë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
 *
 * U-065 ë‹¨ìˆœí™” (Q3 ê²°ì •: Option A):
 *   - rules_changed, quests_updated â†’ ë°°ì—´ í¬ê¸° ì œí•œ (ìµœëŒ€ 3ê°œ)
 *   - memory_pins â†’ ë°°ì—´ í¬ê¸° ì œí•œ (ìµœëŒ€ 2ê°œ)
 *   - ìƒì„¸ ì •ë³´ëŠ” narrativeì—ì„œ ìì—°ì–´ë¡œ í‘œí˜„
 */
export const WorldDeltaSchema = z
  .object({
    rules_changed: z
      .array(WorldRuleSchema)
      .max(3)
      .default([])
      .describe('ë³€ê²½ëœ ê·œì¹™ ëª©ë¡ (ìµœëŒ€ 3ê°œ)'),
    inventory_added: z
      .array(InventoryItemDataSchema)
      .max(5)
      .default([])
      .describe('ì¶”ê°€ëœ ì¸ë²¤í† ë¦¬ ì•„ì´í…œ (ìµœëŒ€ 5ê°œ)'),
    inventory_removed: z
      .array(z.string())
      .max(5)
      .default([])
      .describe('ì œê±°ëœ ì¸ë²¤í† ë¦¬ ì•„ì´í…œ (ìµœëŒ€ 5ê°œ)'),
    quests_updated: z
      .array(QuestSchema)
      .max(3)
      .default([])
      .describe('ì—…ë°ì´íŠ¸ëœ í€˜ìŠ¤íŠ¸/ëª©í‘œ ëª©ë¡ (ìµœëŒ€ 3ê°œ)'),
    relationships_changed: z
      .array(z.string())
      .max(3)
      .default([])
      .describe('ë³€ê²½ëœ ê´€ê³„ (ìµœëŒ€ 3ê°œ)'),
    memory_pins: z
      .array(MemoryPinSchema)
      .max(2)
      .default([])
      .describe('ì¤‘ìš” ì„¤ì • ê³ ì • í›„ë³´ (ìµœëŒ€ 2ê°œ)'),
  })
  .strict();
export type WorldDelta = z.infer<typeof WorldDeltaSchema>;

// =============================================================================
// TurnOutput ê´€ë ¨ íƒ€ì… - Render
// =============================================================================

/**
 * ì´ë¯¸ì§€ ìƒì„± ì‘ì—… - U-065 ë‹¨ìˆœí™”.
 * ì¡°ê±´ë¶€ ì´ë¯¸ì§€ ìƒì„±/í¸ì§‘ ìš”ì²­ì…ë‹ˆë‹¤.
 *
 * U-065 ë‹¨ìˆœí™”: reference_image_ids ë°°ì—´ í¬ê¸° ì œí•œ (ìµœëŒ€ 2ê°œ)
 * U-091: rembg ëŸ°íƒ€ì„ ì œê±° - remove_background, image_type_hint í•„ë“œ ì‚­ì œ
 */
export const ImageJobSchema = z
  .object({
    should_generate: z.boolean().describe('ì´ë¯¸ì§€ë¥¼ ìƒì„±í•´ì•¼ í•˜ëŠ”ì§€'),
    prompt: z.string().default('').describe('ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸'),
    model_label: ModelLabelSchema.default('FAST').describe('ëª¨ë¸ ì„ íƒ ë¼ë²¨'),
    aspect_ratio: z.string().default('16:9').describe('ê°€ë¡œì„¸ë¡œ ë¹„ìœ¨'),
    image_size: z.string().default('1024x1024').describe('ì´ë¯¸ì§€ í¬ê¸°'),
    reference_image_ids: z
      .array(z.string())
      .max(2)
      .default([])
      .describe('ì°¸ì¡° ì´ë¯¸ì§€ ID ëª©ë¡ (ìµœëŒ€ 2ê°œ)'),
    reference_image_url: z
      .string()
      .nullable()
      .default(null)
      .describe('ì°¸ì¡° ì´ë¯¸ì§€ URL (ì„ íƒ, AI ëª¨ë¸ ì‘ë‹µ í˜¸í™˜ìš©)'),
  })
  .strict();
export type ImageJob = z.infer<typeof ImageJobSchema>;

/**
 * ë Œë”ë§ ì¶œë ¥ ë°ì´í„°.
 * ì´ë¯¸ì§€ ìƒì„±/í¸ì§‘ ê´€ë ¨ ì •ë³´ì…ë‹ˆë‹¤.
 *
 * U-053: image_url, image_id, generation_time_ms í•„ë“œ ì¶”ê°€ (í›„ì²˜ë¦¬ì—ì„œ ì±„ì›€)
 * U-091: rembg ëŸ°íƒ€ì„ ì œê±° - background_removed í•„ë“œ ì‚­ì œ
 */
export const RenderOutputSchema = z
  .object({
    image_job: ImageJobSchema.nullable().default(null).describe('ì´ë¯¸ì§€ ìƒì„± ì‘ì—… (ì„ íƒ)'),
    image_url: z
      .string()
      .nullable()
      .default(null)
      .describe('ìƒì„±ëœ ì´ë¯¸ì§€ URL (í›„ì²˜ë¦¬ì—ì„œ ì±„ì›€, U-053)'),
    image_id: z
      .string()
      .nullable()
      .default(null)
      .describe('ìƒì„±ëœ ì´ë¯¸ì§€ ID (í›„ì²˜ë¦¬ì—ì„œ ì±„ì›€, U-053)'),
    generation_time_ms: z
      .number()
      .int()
      .nullable()
      .default(null)
      .describe('ì´ë¯¸ì§€ ìƒì„± ì†Œìš” ì‹œê°„ (ms, U-053)'),
  })
  .strict();
export type RenderOutput = z.infer<typeof RenderOutputSchema>;

// =============================================================================
// TurnOutput ê´€ë ¨ íƒ€ì… - Economy
// =============================================================================

/**
 * ê±°ë˜ ì¥ë¶€(Ledger) ì—”íŠ¸ë¦¬ (RULE-005).
 * ê° í„´ì—ì„œ ë°œìƒí•œ ë¹„ìš©ê³¼ ì”ì•¡ ë³€í™”ë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤.
 */
export const LedgerEntrySchema = z
  .object({
    turnId: z.number().int().min(0).describe('í„´ ID'),
    actionId: z.string().optional().describe('ì•¡ì…˜ ID (ì„ íƒ)'),
    reason: z.string().describe('ë¹„ìš© ë°œìƒ ì‚¬ìœ '),
    cost: CurrencyAmountSchema.describe('ì†Œë¹„ëœ ë¹„ìš©'),
    balanceAfter: CurrencyAmountSchema.describe('ì†Œë¹„ í›„ ì”ì•¡'),
    modelLabel: ModelLabelSchema.optional().describe('ëª¨ë¸ ë¼ë²¨ (ì„ íƒ)'),
    timestamp: z.number().describe('ê¸°ë¡ ì‹œê° (timestamp)'),
  })
  .strict();
export type LedgerEntry = z.infer<typeof LedgerEntrySchema>;

/**
 * ê²½ì œ ì¶œë ¥ ë°ì´í„° (RULE-005).
 * ì´ë²ˆ í„´ì˜ ë¹„ìš©ê³¼ ì”ì•¡ ì •ë³´ì…ë‹ˆë‹¤.
 * ì”ì•¡ ìŒìˆ˜ëŠ” ì ˆëŒ€ ë¶ˆê°€ (ì„œë²„ Hard gate).
 */
export const EconomyOutputSchema = z
  .object({
    cost: CurrencyAmountSchema.describe('ì´ë²ˆ í„´ì— ì†Œë¹„ëœ ë¹„ìš©'),
    balance_after: CurrencyAmountSchema.describe('ì†Œë¹„ í›„ ì”ì•¡'),
    credit: z.number().int().default(0).describe('ì‚¬ìš© ì¤‘ì¸ í¬ë ˆë”§ (ë¹š, Signal ë‹¨ìœ„)'),
    low_balance_warning: z.boolean().default(false).describe('ì”ì•¡ ë¶€ì¡± ê²½ê³  ì—¬ë¶€'),
  })
  .strict();
export type EconomyOutput = z.infer<typeof EconomyOutputSchema>;

// =============================================================================
// TurnOutput ê´€ë ¨ íƒ€ì… - Safety
// =============================================================================

/**
 * ì•ˆì „ ì¶œë ¥ ë°ì´í„°.
 * ì•ˆì „ ì •ì±… ê´€ë ¨ ì •ë³´ì…ë‹ˆë‹¤.
 * ì°¨ë‹¨ ì‹œ ëª…ì‹œì  ë©”ì‹œì§€ì™€ í•¨ê»˜ ì•ˆì „í•œ ëŒ€ì²´ ê²°ê³¼ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
 */
export const SafetyOutputSchema = z
  .object({
    blocked: z.boolean().default(false).describe('ì•ˆì „ ì •ì±…ì— ì˜í•´ ì°¨ë‹¨ë˜ì—ˆëŠ”ì§€'),
    message: z
      .string()
      .nullable()
      .default(null)
      .describe('ì°¨ë‹¨ ì‹œ ì‚¬ìš©ìì—ê²Œ í‘œì‹œí•  ë©”ì‹œì§€ (ì„ íƒ)'),
  })
  .strict();
export type SafetyOutput = z.infer<typeof SafetyOutputSchema>;

// =============================================================================
// TurnOutput ê´€ë ¨ íƒ€ì… - Agent Console
// =============================================================================

/**
 * ì—ì´ì „íŠ¸ ì½˜ì†” ë°ì´í„° (RULE-008) - U-065 ë‹¨ìˆœí™”.
 * ì—ì´ì „íŠ¸í˜• ì‹œìŠ¤í…œì„ì„ UIë¡œ ì¦ëª…í•˜ê¸° ìœ„í•œ ì •ë³´ì…ë‹ˆë‹¤.
 *
 * U-065 ë‹¨ìˆœí™”: badges ë°°ì—´ í¬ê¸° ì œí•œ (ìµœëŒ€ 4ê°œ)
 * U-069: model_label í•„ë“œ ì¶”ê°€ - í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ í…ìŠ¤íŠ¸ ëª¨ë¸ í‘œì‹œ
 */
export const AgentConsoleSchema = z
  .object({
    current_phase: AgentPhaseSchema.default('commit').describe('í˜„ì¬ ì‹¤í–‰ ë‹¨ê³„'),
    badges: z.array(ValidationBadgeSchema).max(4).default([]).describe('ê²€ì¦ ë°°ì§€ ëª©ë¡ (ìµœëŒ€ 4ê°œ)'),
    repair_count: z.number().int().min(0).default(0).describe('ìë™ ë³µêµ¬ ì‹œë„ íšŸìˆ˜'),
    model_label: ModelLabelSchema.default('FAST').describe(
      'í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ í…ìŠ¤íŠ¸ ëª¨ë¸ ë¼ë²¨ (U-069)',
    ),
  })
  .strict();
export type AgentConsole = z.infer<typeof AgentConsoleSchema>;

// =============================================================================
// TurnOutput (ë©”ì¸ ì‘ë‹µ ìŠ¤í‚¤ë§ˆ)
// =============================================================================

/**
 * í„´ ì¶œë ¥ (ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸).
 * ì„œë²„ê°€ í„´ ì²˜ë¦¬ í›„ í´ë¼ì´ì–¸íŠ¸ë¡œ ë°˜í™˜í•˜ëŠ” êµ¬ì¡°í™”ëœ ì‘ë‹µì…ë‹ˆë‹¤.
 *
 * Hard Gate í•„ë“œ (RULE-003/004/005):
 *   - economy: costì™€ balance_after í•„ìˆ˜, ì”ì•¡ ìŒìˆ˜ ê¸ˆì§€
 *   - safety: blocked ì‹œ ì•ˆì „í•œ ëŒ€ì²´ ê²°ê³¼ ì œê³µ
 *   - language: ìš”ì²­ ì–¸ì–´ì™€ ë™ì¼í•˜ê²Œ ê³ ì • (í˜¼í•© ì¶œë ¥ ê¸ˆì§€)
 */
export const TurnOutputSchema = z
  .object({
    // í•„ìˆ˜ í•„ë“œ (Hard Gate)
    language: LanguageSchema.describe('ì‘ë‹µ ì–¸ì–´ (ìš”ì²­ê³¼ ë™ì¼)'),
    narrative: z.string().describe('ë‚´ëŸ¬í‹°ë¸Œ í…ìŠ¤íŠ¸ (í‘œì‹œìš©)'),
    economy: EconomyOutputSchema.describe('ê²½ì œ ì •ë³´ (ë¹„ìš©, ì”ì•¡)'),
    safety: SafetyOutputSchema.describe('ì•ˆì „ ì •ì±… ì •ë³´'),

    // UI ê´€ë ¨ í•„ë“œ (RU-003-T1: scene í•„ë“œ ì¶”ê°€)
    ui: UIOutputSchema.default({
      action_deck: { cards: [] },
      objects: [],
      scene: { image_url: null, alt_text: null },
    }).describe('UI ìš”ì†Œ'),

    // ì„¸ê³„ ìƒíƒœ í•„ë“œ
    world: WorldDeltaSchema.default({
      rules_changed: [],
      inventory_added: [],
      inventory_removed: [],
      quests_updated: [],
      relationships_changed: [],
      memory_pins: [],
    }).describe('ì„¸ê³„ ìƒíƒœ ë³€í™” (delta)'),

    // ë Œë”ë§ í•„ë“œ
    render: RenderOutputSchema.default({
      image_job: null,
      image_url: null,
      image_id: null,
      generation_time_ms: null,
    }).describe('ë Œë”ë§ ì •ë³´'),

    // ì—ì´ì „íŠ¸ ì½˜ì†” í•„ë“œ
    agent_console: AgentConsoleSchema.default({
      current_phase: 'commit',
      badges: [],
      repair_count: 0,
      model_label: 'FAST',
    }).describe('ì—ì´ì „íŠ¸ ì‹¤í–‰ ì •ë³´'),

    // U-072: ì„¸ì…˜ ìœ ë„ë¥¼ ìœ„í•œ íŒíŠ¸ í•„ë“œ (ì„ íƒ)
    hints: z
      .object({
        scanner: z.boolean().optional().describe('Scanner ì‚¬ìš© ìœ ë„ íŒíŠ¸ ì—¬ë¶€'),
      })
      .optional()
      .describe('í”Œë ˆì´ ìœ ë„ë¥¼ ìœ„í•œ íŒíŠ¸ í”Œë˜ê·¸'),
  })
  .strict();
export type TurnOutput = z.infer<typeof TurnOutputSchema>;

// =============================================================================
// ì•ˆì „ í´ë°± (RULE-004)
// =============================================================================

/**
 * ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì œê³µë˜ëŠ” ì•ˆì „ í´ë°± TurnOutput.
 * UIê°€ ë©ˆì¶”ì§€ ì•Šë„ë¡ ìµœì†Œí•œì˜ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
 *
 * U-063: í´ë°±ì—ì„œë„ ì¬í™” ì”ì•¡ì„ ìœ ì§€í•˜ë„ë¡ economySnapshot íŒŒë¼ë¯¸í„° ì¶”ê°€.
 * RULE-005: ì¬í™” ì¸ë°”ë¦¬ì–¸íŠ¸ - í´ë°± ì‹œì—ë„ ì”ì•¡ì´ 0ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•„ì•¼ í•¨.
 *
 * @param language - ìš”ì²­ ì–¸ì–´
 * @param repairCount - ë³µêµ¬ ì‹œë„ íšŸìˆ˜
 * @param errorMessage - ì˜¤ë¥˜ ë©”ì‹œì§€ (ì„ íƒ)
 * @param economySnapshot - í˜„ì¬ ì¬í™” ìŠ¤ëƒ…ìƒ· (ì„ íƒ, ì œê³µ ì‹œ ì”ì•¡ ìœ ì§€)
 */
export function createFallbackTurnOutput(
  language: Language,
  repairCount: number = 0,
  errorMessage?: string,
  economySnapshot?: { signal: number; memory_shard: number },
): TurnOutput {
  const fallbackNarrative =
    language === 'ko-KR'
      ? '[ì‹œìŠ¤í…œ] ì‘ë‹µì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.'
      : '[System] An error occurred while processing the response. Please try again.';

  const safetyMessage =
    language === 'ko-KR'
      ? 'ìŠ¤í‚¤ë§ˆ ê²€ì¦ ì‹¤íŒ¨ë¡œ ì¸í•œ í´ë°± ì‘ë‹µì…ë‹ˆë‹¤.'
      : 'This is a fallback response due to schema validation failure.';

  // U-063: í´ë°±ì—ì„œë„ ì¬í™” ì”ì•¡ ìœ ì§€ (RULE-005)
  // economySnapshotì´ ì œê³µë˜ë©´ í•´ë‹¹ ê°’ì„ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
  const balanceAfter = economySnapshot
    ? { signal: economySnapshot.signal, memory_shard: economySnapshot.memory_shard }
    : { signal: 100, memory_shard: 5 }; // ê¸°ë³¸ê°’ (í”„ë¡œí•„ ë¯¸ë¡œë“œ ìƒíƒœì˜ placeholder)

  return {
    language,
    narrative: errorMessage ?? fallbackNarrative,
    economy: {
      cost: { signal: 0, memory_shard: 0 },
      balance_after: balanceAfter,
      credit: 0,
      low_balance_warning: false,
    },
    safety: {
      blocked: false,
      message: safetyMessage,
    },
    ui: {
      action_deck: { cards: [] },
      objects: [],
      scene: { image_url: null, alt_text: null },
    },
    world: {
      rules_changed: [],
      inventory_added: [],
      inventory_removed: [],
      quests_updated: [],
      relationships_changed: [],
      memory_pins: [],
    },
    render: {
      image_job: null,
      image_url: null,
      image_id: null,
      generation_time_ms: null,
    },
    agent_console: {
      current_phase: 'commit',
      badges: ['schema_fail'],
      repair_count: repairCount,
      model_label: 'FAST',
    },
  };
}

// =============================================================================
// ê²€ì¦ í—¬í¼ í•¨ìˆ˜
// =============================================================================

/**
 * TurnOutput ê²€ì¦ ê²°ê³¼ íƒ€ì….
 */
export type TurnOutputParseResult =
  | { success: true; data: TurnOutput }
  | { success: false; error: z.ZodError; fallback: TurnOutput };

/**
 * TurnOutputì„ ì•ˆì „í•˜ê²Œ íŒŒì‹±í•©ë‹ˆë‹¤.
 * ì‹¤íŒ¨ ì‹œ í´ë°± TurnOutputì„ ë°˜í™˜í•©ë‹ˆë‹¤ (RULE-004).
 *
 * U-063: economySnapshot íŒŒë¼ë¯¸í„° ì¶”ê°€ - í´ë°± ì‹œì—ë„ ì¬í™” ì”ì•¡ ìœ ì§€.
 *
 * @param data - íŒŒì‹±í•  ë°ì´í„°
 * @param language - í´ë°± ì‹œ ì‚¬ìš©í•  ì–¸ì–´ (ê¸°ë³¸: ko-KR)
 * @param repairCount - í˜„ì¬ ë³µêµ¬ ì‹œë„ íšŸìˆ˜
 * @param economySnapshot - í˜„ì¬ ì¬í™” ìŠ¤ëƒ…ìƒ· (ì„ íƒ, í´ë°± ì‹œ ì”ì•¡ ìœ ì§€)
 */
export function safeParseTurnOutput(
  data: unknown,
  language: Language = 'ko-KR',
  repairCount: number = 0,
  economySnapshot?: { signal: number; memory_shard: number },
): TurnOutputParseResult {
  const result = TurnOutputSchema.safeParse(data);

  if (result.success) {
    return { success: true, data: result.data };
  }

  return {
    success: false,
    error: result.error,
    fallback: createFallbackTurnOutput(language, repairCount, undefined, economySnapshot),
  };
}

/**
 * TurnInputì„ ê²€ì¦í•©ë‹ˆë‹¤.
 * ì…ë ¥ ë°ì´í„°ì˜ ìœ íš¨ì„±ì„ ì—„ê²©í•˜ê²Œ ê²€ì‚¬í•©ë‹ˆë‹¤.
 *
 * @param data - ê²€ì¦í•  ë°ì´í„°
 * @throws {z.ZodError} ê²€ì¦ ì‹¤íŒ¨ ì‹œ
 */
export function parseTurnInput(data: unknown): TurnInput {
  return TurnInputSchema.parse(data);
}

/**
 * TurnInput ì•ˆì „ íŒŒì‹± ê²°ê³¼ íƒ€ì….
 */
export type TurnInputSafeParseResult = ReturnType<typeof TurnInputSchema.safeParse>;

/**
 * TurnInputì„ ì•ˆì „í•˜ê²Œ íŒŒì‹±í•©ë‹ˆë‹¤.
 *
 * @param data - íŒŒì‹±í•  ë°ì´í„°
 */
export function safeParseTurnInput(data: unknown): TurnInputSafeParseResult {
  return TurnInputSchema.safeParse(data);
}
</file>

<file path="frontend/src/App.tsx">
/**
 * Unknown World - ë©”ì¸ ê²Œì„ UI ë ˆì´ì•„ì›ƒ
 *
 * RULE-002 ì¤€ìˆ˜: ì±„íŒ… ë²„ë¸” UI ê¸ˆì§€
 * - ë‚´ëŸ¬í‹°ë¸ŒëŠ” "ì±„íŒ…"ì´ ì•„ë‹ˆë¼ "ê²Œì„ ë¡œê·¸/ë‚´ëŸ¬í‹°ë¸Œ í”¼ë“œ" í˜•íƒœ
 * - ê³ ì • íŒ¨ë„: Scene Canvas, Action Deck, Inventory, Quest,
 *   Rule Board, Economy HUD, Agent Console, Scanner Slot
 *
 * RULE-008: Agent Consoleì—ì„œ ë‹¨ê³„/ë°°ì§€/ë³µêµ¬ë§Œ í‘œì‹œ (í”„ë¡¬í”„íŠ¸ ë…¸ì¶œ ê¸ˆì§€)
 *
 * RU-003-Q4: App.tsxëŠ” "ë ˆì´ì•„ì›ƒ + ì´ë²¤íŠ¸ ë¼ìš°íŒ…"ì— ì§‘ì¤‘
 * - ì„¸ì…˜/ì›”ë“œ ìƒíƒœëŠ” worldStoreë¡œ ì´ë™
 * - TurnOutput ë°˜ì˜ì€ worldStore.applyTurnOutputìœ¼ë¡œ ë‹¨ì¼í™”
 *
 * RU-004-Q4: ì„¸ì…˜ ë¼ì´í”„ì‚¬ì´í´ SSOT
 * - ì„¸ì…˜ ì´ˆê¸°í™”/ë³µì›/ë¦¬ì…‹/ë³€ê²½ì€ sessionLifecycle ëª¨ë“ˆë¡œ ë‹¨ì¼í™”
 * - App.tsxëŠ” ì„¸ì…˜ API í˜¸ì¶œ + UI ì „í™˜ë§Œ ë‹´ë‹¹
 *
 * U-015[Mvp]: SaveGame + Reset + Demo Profiles
 * - í”„ë¡œí•„ ì„ íƒ í™”ë©´ â†’ ê²Œì„ ì‹œì‘ í”Œë¡œìš°
 * - ë¦¬ì…‹ ë²„íŠ¼ìœ¼ë¡œ í”„ë¡œí•„ ì´ˆê¸° ìƒíƒœë¡œ ë³µêµ¬
 * - localStorage ê¸°ë°˜ ì„¸ì´ë¸Œ/ë¡œë“œ
 *
 * @see vibe/ref/frontend-style-guide.md
 * @see vibe/prd.md 6.7/6.8/9ì¥
 */

import { useState, useCallback, useEffect, useMemo } from 'react';
import { useTranslation } from 'react-i18next';
import {
  DndContext,
  DragEndEvent,
  DragStartEvent,
  useSensor,
  useSensors,
  PointerSensor,
  KeyboardSensor,
} from '@dnd-kit/core';
import { Panel } from './components/Panel';
import { GameHeader } from './components/GameHeader';
import { NarrativeFeed } from './components/NarrativeFeed';
import { AgentConsole } from './components/AgentConsole';
import { EconomyHud } from './components/EconomyHud';
import { SceneCanvas, type HotspotClickData } from './components/SceneCanvas';
import { ActionDeck } from './components/ActionDeck';
import { InventoryPanel } from './components/InventoryPanel';
// U-013: Quest + Rule Board + Mutation Timeline
import { QuestPanel } from './components/QuestPanel';
// U-078: Objective Tracker (ë¯¸ë‹ˆ íŠ¸ë˜ì»¤)
import { ObjectiveTracker } from './components/ObjectiveTracker';
import { RuleBoard } from './components/RuleBoard';
import { MutationTimeline } from './components/MutationTimeline';
// U-022: Scanner Slot
import { ScannerSlot } from './components/ScannerSlot';
// U-015: SaveGame + Demo Profiles
import { DemoProfileSelect } from './components/DemoProfileSelect';
import { ResetButton, ChangeProfileButton } from './components/ResetButton';
// U-117: OnboardingGuide ì œê±° (ì˜¨ë³´ë”© íŒì—… ì‚­ì œ, hover íŒíŠ¸ëŠ” ìœ ì§€)
import { useAgentStore } from './stores/agentStore';
import { useInventoryStore, selectItemCount } from './stores/inventoryStore';
import { useUIPrefsStore, applyUIPrefsToDOM } from './stores/uiPrefsStore';
import { useWorldStore } from './stores/worldStore';
import { useTurnRunner } from './turn/turnRunner';
import type { ActionCard, DropInput } from './schemas/turn';
import { getCurrentThemeFromDOM } from './demo/demoFixtures';
import { isInventoryDragData, isHotspotDropData } from './dnd/types';
// U-117: initializeOnboarding ì œê±° (ì˜¨ë³´ë”© ê°€ì´ë“œ ì‚­ì œ)
// U-116: ì„¸ì…˜ ë¼ì´í”„ì‚¬ì´í´ SSOT (SaveGame ì œê±°)
import {
  bootstrapSession,
  startSessionFromProfile,
  resetToCurrentProfile,
  clearSessionAndReturnToSelect,
  setSessionLanguage,
  getInitialSessionLanguage,
} from './save/sessionLifecycle';
import type { DemoProfile } from './data/demoProfiles';
import type { SupportedLanguage } from './i18n';

// =============================================================================
// ê²Œì„ ìƒíƒœ íƒ€ì…
// =============================================================================

type GamePhase = 'profile_select' | 'playing';

// =============================================================================
// ë©”ì¸ App ì»´í¬ë„ŒíŠ¸
// =============================================================================

function App() {
  const { t } = useTranslation();

  // U-116: í•­ìƒ profile_selectë¡œ ì‹œì‘ (SaveGame ì œê±°)
  const [gamePhase, setGamePhase] = useState<GamePhase>(() => {
    bootstrapSession(); // ë ˆê±°ì‹œ ë°ì´í„° ì •ë¦¬
    return 'profile_select';
  });

  // í˜„ì¬ ì„ íƒëœ í”„ë¡œí•„ ID (ì„¸ì…˜ ë‚´ì—ì„œë§Œ ìœ ì§€, ìƒˆë¡œê³ ì¹¨ ì‹œ ì´ˆê¸°í™”)
  const [currentProfileId, setCurrentProfileId] = useState<string | null>(null);

  // U-044: ì„¸ì…˜ ì–¸ì–´ SSOT
  // - SaveGame.languageë¥¼ ê¶Œìœ„ìë¡œ ì‚¬ìš©í•˜ì—¬ ë“œë¦¬í”„íŠ¸ ë°©ì§€
  // - profile_selectì—ì„œë§Œ ë³€ê²½ ê°€ëŠ¥ (í† ê¸€=ë¦¬ì…‹ ì •ì±…)
  const [sessionLanguage, setSessionLanguageState] = useState<SupportedLanguage>(() => {
    return getInitialSessionLanguage();
  });

  // ë¡œì»¬ UI ìƒíƒœ
  const [inputText, setInputText] = useState('');

  // Store ìƒíƒœ (ì…€ë ‰í„° ìµœì í™”)
  const economy = useWorldStore((state) => state.economy);
  const isConnected = useWorldStore((state) => state.isConnected);
  const sceneObjects = useWorldStore((state) => state.sceneObjects);
  const narrativeEntries = useWorldStore((state) => state.narrativeEntries);
  const appendSystemNarrative = useWorldStore((state) => state.appendSystemNarrative);
  const appendActionLog = useWorldStore((state) => state.appendActionLog);

  const { startDrag, endDrag } = useInventoryStore();
  const inventoryItemCount = useInventoryStore(selectItemCount);

  // AgentStore ì…€ë ‰í„°
  const isStreaming = useAgentStore((state) => state.isStreaming);
  const narrativeBuffer = useAgentStore((state) => state.narrativeBuffer);

  // U-087: ì…ë ¥ ì ê¸ˆ SSOT - ì²˜ë¦¬ ì¤‘ ëª¨ë“  ì‚¬ìš©ì ì…ë ¥ì„ ì°¨ë‹¨
  const processingPhase = useWorldStore((state) => state.sceneState.processingPhase);
  const imageLoading = useWorldStore((state) => state.sceneState.imageLoading);
  const isInputLocked = isStreaming || processingPhase !== 'idle' || imageLoading === true;

  const { uiScale, increaseUIScale, decreaseUIScale } = useUIPrefsStore();

  // DOMì— UI ì„¤ì • ì ìš© (U-028â†’U-037)
  useEffect(() => {
    applyUIPrefsToDOM({ uiScale });
  }, [uiScale]);

  // ==========================================================================
  // U-015 + RU-004-Q4: í”„ë¡œí•„/ì„¸ì´ë¸Œ ê´€ë ¨ ë¡œì§ (sessionLifecycle SSOT)
  // ==========================================================================

  /**
   * í”„ë¡œí•„ì„ ì„ íƒí•˜ê³  ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.
   * U-116: SaveGame ì—†ì´ storeì— ì§ì ‘ ì ìš©í•©ë‹ˆë‹¤.
   */
  const handleSelectProfile = useCallback(
    (profile: DemoProfile) => {
      const result = startSessionFromProfile({ profile, t, language: sessionLanguage });
      if (result.success) {
        setCurrentProfileId(result.profileId);
        setGamePhase('playing');
      }
    },
    [t, sessionLanguage],
  );

  /**
   * U-044: profile_selectì—ì„œ ì–¸ì–´ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.
   * í† ê¸€=ë¦¬ì…‹ ì •ì±…ì— ë”°ë¼ profile_selectì—ì„œë§Œ í˜¸ì¶œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
   */
  const handleLanguageChange = useCallback(async (language: SupportedLanguage) => {
    await setSessionLanguage(language);
    setSessionLanguageState(language);
  }, []);

  /**
   * í˜„ì¬ í”„ë¡œí•„ì˜ ì´ˆê¸° ìƒíƒœë¡œ ë¦¬ì…‹í•©ë‹ˆë‹¤.
   * U-116: store ì „ì²´ ì´ˆê¸°í™” + ë™ì¼ í”„ë¡œí•„ë¡œ ì¬ì‹œì‘í•©ë‹ˆë‹¤.
   */
  const handleReset = useCallback(() => {
    const result = resetToCurrentProfile({ t, currentProfileId });
    if (result.success && result.profileId) {
      setCurrentProfileId(result.profileId);
    }
  }, [t, currentProfileId]);

  /**
   * í”„ë¡œí•„ ì„ íƒ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.
   * U-116: ëª¨ë“  store ì´ˆê¸°í™” + profile_selectë¡œ ì „í™˜í•©ë‹ˆë‹¤.
   */
  const handleChangeProfile = useCallback(() => {
    clearSessionAndReturnToSelect();
    setCurrentProfileId(null);
    setGamePhase('profile_select');
  }, []);

  // U-117: ì˜¨ë³´ë”© ê°€ì´ë“œ ì´ˆê¸°í™” ì œê±° (íŒì—… ì‚­ì œ, hover íŒíŠ¸ë§Œ ìœ ì§€)

  // RU-003-Q3: Turn Runner (ìŠ¤íŠ¸ë¦¼ ì‹œì‘/ì·¨ì†Œ/ì½œë°± ë¼ìš°íŒ… ë‹´ë‹¹)
  // U-044: ì„¸ì…˜ ì–¸ì–´ë¥¼ SSOTë¡œ ì£¼ì…í•˜ì—¬ ë“œë¦¬í”„íŠ¸ ë°©ì§€
  const turnRunnerDeps = useMemo(
    () => ({
      t,
      theme: getCurrentThemeFromDOM(),
      language: sessionLanguage,
    }),
    [t, sessionLanguage],
  );
  const turnRunner = useTurnRunner(turnRunnerDeps);

  /**
   * í„´ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
   */
  const executeTurn = useCallback(
    (text: string, actionId?: string, clickData?: HotspotClickData, dropData?: DropInput) => {
      turnRunner.runTurn({
        text,
        actionId,
        click: clickData,
        drop: dropData,
      });
      setInputText('');
    },
    [turnRunner],
  );

  /**
   * ì…ë ¥ ì œì¶œ í•¸ë“¤ëŸ¬
   */
  const handleSubmit = useCallback(() => {
    // U-087: ì…ë ¥ ì ê¸ˆ ì‹œ ì œì¶œ ì°¨ë‹¨
    if (isInputLocked) return;
    if (inputText.trim()) {
      executeTurn(inputText.trim());
    }
  }, [inputText, executeTurn, isInputLocked]);

  /**
   * ì¹´ë“œ í´ë¦­ í•¸ë“¤ëŸ¬
   * U-070: Q2 Option A - ëª¨ë“  í”Œë ˆì´ì–´ í–‰ë™ì— ì•¡ì…˜ ë¡œê·¸ ì ìš©
   */
  const handleCardClick = useCallback(
    (card: ActionCard) => {
      // U-087: ì…ë ¥ ì ê¸ˆ ì‹œ í—ˆìœ„ ì•¡ì…˜ ë¡œê·¸ ë°©ì§€ (ì¦‰ì‹œ ë°˜í™˜)
      if (isInputLocked) return;
      // U-070: ì•¡ì…˜ ë¡œê·¸ ì¶”ê°€ (TurnInput ì „ì†¡ ì „ì— ì¦‰ê°ì  í”¼ë“œë°±)
      appendActionLog(t('action_log.click_action', { action: card.label }));
      executeTurn(card.label, card.id);
    },
    [executeTurn, appendActionLog, t, isInputLocked],
  );

  /**
   * í•«ìŠ¤íŒŸ í´ë¦­ í•¸ë“¤ëŸ¬ (U-010)
   * U-070: í•«ìŠ¤íŒŸ í´ë¦­ì—ë„ ì•¡ì…˜ ë¡œê·¸ ì ìš©
   */
  const handleHotspotClick = useCallback(
    (data: HotspotClickData) => {
      // U-087: ì…ë ¥ ì ê¸ˆ ì‹œ í—ˆìœ„ ì•¡ì…˜ ë¡œê·¸ ë°©ì§€ (ì¦‰ì‹œ ë°˜í™˜)
      if (isInputLocked) return;
      const clickedObject = sceneObjects.find((obj) => obj.id === data.object_id);
      const clickText = clickedObject
        ? t('scene.hotspot.click_action', { label: clickedObject.label })
        : data.object_id;

      // U-070: ì•¡ì…˜ ë¡œê·¸ ì¶”ê°€ (TurnInput ì „ì†¡ ì „ì— ì¦‰ê°ì  í”¼ë“œë°±)
      const hotspotLabel = clickedObject?.label ?? data.object_id;
      appendActionLog(t('action_log.click_hotspot', { hotspot: hotspotLabel }));

      executeTurn(clickText, undefined, data);
    },
    [executeTurn, sceneObjects, t, appendActionLog, isInputLocked],
  );

  /**
   * í‚¤ë³´ë“œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
   */
  const handleKeyDown = useCallback(
    (e: React.KeyboardEvent) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSubmit();
      }
    },
    [handleSubmit],
  );

  /**
   * ë“œë˜ê·¸ ì‹œì‘ í•¸ë“¤ëŸ¬ (U-011)
   */
  const handleDragStart = useCallback(
    (event: DragStartEvent) => {
      // U-087: ì…ë ¥ ì ê¸ˆ ì‹œ ë“œë˜ê·¸ ì‹œì‘ ì°¨ë‹¨
      if (isInputLocked) return;
      const { active } = event;
      if (isInventoryDragData(active.data.current)) {
        startDrag(active.data.current.item_id);
      }
    },
    [startDrag, isInputLocked],
  );

  /**
   * ë“œë˜ê·¸ ì¢…ë£Œ í•¸ë“¤ëŸ¬ (U-011 + U-012)
   * U-070: ì•„ì´í…œâ†’í•«ìŠ¤íŒŸ ë“œë¡­ ì‹œ ì•¡ì…˜ ë¡œê·¸ ì¶”ê°€
   */
  const handleDragEnd = useCallback(
    (event: DragEndEvent) => {
      const { active, over } = event;
      endDrag();

      // U-087: ì…ë ¥ ì ê¸ˆ ì‹œ ë“œë¡­ ì²˜ë¦¬ ì°¨ë‹¨ (í—ˆìœ„ ì•¡ì…˜ ë¡œê·¸ ë°©ì§€)
      if (isInputLocked) return;

      const activeData = active.data.current;
      if (!isInventoryDragData(activeData)) {
        return;
      }

      const itemId = activeData.item_id;
      const itemName = activeData.item.name;

      const overData = over?.data.current;
      if (!over || !isHotspotDropData(overData)) {
        appendSystemNarrative(
          `[${t('connection.online')}] ${t('scene.hotspot.drop_invalid', { item: itemName })}`,
        );
        return;
      }

      const { object_id: targetObjectId, box_2d: targetBox2d, label: targetLabel } = overData;

      // U-070: ì•¡ì…˜ ë¡œê·¸ ì¶”ê°€ (TurnInput ì „ì†¡ ì „ì— ì¦‰ê°ì  í”¼ë“œë°±)
      appendActionLog(
        t('action_log.use_item_on_hotspot', {
          item: itemName,
          hotspot: targetLabel,
        }),
      );

      const dropText = t('scene.hotspot.drop_action', {
        item: itemName,
        target: targetLabel,
      });

      const dropInput: DropInput = {
        item_id: itemId,
        target_object_id: targetObjectId,
        target_box_2d: targetBox2d,
      };

      executeTurn(dropText, undefined, undefined, dropInput);
    },
    [endDrag, executeTurn, appendSystemNarrative, appendActionLog, t, isInputLocked],
  );

  // dnd-kit ì„¼ì„œ ì„¤ì • (U-117: distance 5pxë¡œ í´ë¦­/ë“œë˜ê·¸ êµ¬ë¶„)
  const sensors = useSensors(
    useSensor(PointerSensor, {
      activationConstraint: {
        distance: 5,
      },
    }),
    useSensor(KeyboardSensor),
  );

  // ==========================================================================
  // ë Œë”ë§: í”„ë¡œí•„ ì„ íƒ í™”ë©´
  // U-116: SaveGame ì œê±° â†’ Continue ë²„íŠ¼ ë¶ˆí•„ìš”, í•­ìƒ ìƒˆ ì„¸ì…˜ ì‹œì‘
  // ==========================================================================
  if (gamePhase === 'profile_select') {
    return (
      <>
        <div className="crt-overlay" aria-hidden="true" />
        <DemoProfileSelect
          onSelectProfile={handleSelectProfile}
          currentLanguage={sessionLanguage}
          onLanguageChange={handleLanguageChange}
        />
      </>
    );
  }

  // ==========================================================================
  // ë Œë”ë§: ê²Œì„ í”Œë ˆì´ í™”ë©´
  // ==========================================================================
  return (
    <>
      <div className="crt-overlay" aria-hidden="true" />

      <DndContext sensors={sensors} onDragStart={handleDragStart} onDragEnd={handleDragEnd}>
        <div className="game-container">
          <GameHeader
            signal={economy.signal}
            memoryShard={economy.memory_shard}
            credit={economy.credit}
            isConnected={isConnected}
            uiScale={uiScale}
            onIncreaseScale={increaseUIScale}
            onDecreaseScale={decreaseUIScale}
          >
            {/* U-015: ë¦¬ì…‹/í”„ë¡œí•„ ë³€ê²½ ë²„íŠ¼ (U-087: isInputLockedë¡œ í™•ì¥) */}
            <ResetButton onReset={handleReset} disabled={isInputLocked} compact requireConfirm />
            <ChangeProfileButton onClick={handleChangeProfile} disabled={isInputLocked} />
          </GameHeader>

          {/* U-077: ì¢Œì¸¡ ì‚¬ì´ë“œë°” íŒ¨ë„ ì˜ì—­ ë¶„ë°° (U-081 í¡ìˆ˜) */}
          <aside className="sidebar-left">
            {/* U-077: Inventory - flex-1 + min-height ë³´ì¥, ì•„ì´í…œ ê°œìˆ˜ ë™ì  íƒ€ì´í‹€ */}
            <Panel
              title={
                inventoryItemCount > 0
                  ? t('inventory.count', { count: inventoryItemCount })
                  : t('panel.inventory.title')
              }
              className="panel-inventory flex-1"
            >
              <InventoryPanel />
            </Panel>
            {/* U-013: Quest Panel (U-077: max-height + ë‚´ë¶€ ìŠ¤í¬ë¡¤) */}
            <Panel title={t('panel.quest.title')} className="panel-quest">
              <QuestPanel />
            </Panel>
            {/* U-013: Rule Board + Mutation Timeline (U-077: max-height + ë‚´ë¶€ ìŠ¤í¬ë¡¤) */}
            <Panel title={t('panel.rule_board.title')} className="panel-rule-board">
              <RuleBoard />
              <MutationTimeline />
            </Panel>
          </aside>

          <main className="game-center">
            {/* U-078: ëª©í‘œ ë¯¸ë‹ˆ íŠ¸ë˜ì»¤ (í•­ìƒ ìƒë‹¨ì— í‘œì‹œ, Q2: Option B) */}
            <ObjectiveTracker />
            {/* U-087: isInputLockedë¡œ í•«ìŠ¤íŒŸ í´ë¦­/ë“œë¡­ ë¹„í™œì„±í™” */}
            <SceneCanvas onHotspotClick={handleHotspotClick} disabled={isInputLocked} />
            {/* U-086: isStreaming/isImageLoading ì „ë‹¬ â†’ í…ìŠ¤íŠ¸ ìš°ì„  íƒ€ì´í•‘ + ì´ë¯¸ì§€ pending ìƒíƒœ ë¼ì¸ */}
            <NarrativeFeed
              entries={narrativeEntries}
              streamingText={narrativeBuffer}
              isStreaming={isStreaming}
              isImageLoading={imageLoading === true}
            />
          </main>

          {/* U-082: ìš°ì¸¡ ì‚¬ì´ë“œë°” - Agent Console ì¶•ì†Œ + Economy HUD flex-1 í™•ëŒ€
               (U-049 Q1 Option A ë°˜ì „: Economyê°€ ìœ ì—° í™•ì¥, Agent Consoleì€ ì½˜í…ì¸  ê¸°ë°˜) */}
          <aside className="sidebar-right">
            <Panel title={t('panel.agent_console.title')} className="panel-agent-console" hasChrome>
              <AgentConsole />
            </Panel>
            <Panel title={t('economy.hud_label')} className="panel-economy" hasChrome>
              <EconomyHud />
            </Panel>
            <Panel title={t('panel.scanner.title')} className="panel-scanner" hasChrome>
              {/* U-087: isInputLockedë¡œ í™•ì¥ (ìŠ¤íŠ¸ë¦¬ë°+ì´ë¯¸ì§€+ì²˜ë¦¬ ë‹¨ê³„ ëª¨ë‘ ì°¨ë‹¨) */}
              <ScannerSlot language={sessionLanguage} disabled={isInputLocked} />
            </Panel>
          </aside>

          <footer className="game-footer">
            {/* U-087: isInputLockedë¡œ ActionDeck ì „ì²´ ë¹„í™œì„±í™” */}
            <ActionDeck onCardClick={handleCardClick} disabled={isInputLocked} />
            <div className="command-input-area">
              <span className="command-prompt">&gt;</span>
              <input
                type="text"
                className="command-input"
                placeholder={isInputLocked ? t('ui.input_locked') : t('ui.command_placeholder')}
                aria-label={t('ui.command_placeholder')}
                value={inputText}
                onChange={(e) => setInputText(e.target.value)}
                onKeyDown={handleKeyDown}
                disabled={isInputLocked}
              />
              <button type="button" onClick={handleSubmit} disabled={isInputLocked}>
                {isInputLocked ? t('ui.wait') : t('ui.execute')}
              </button>
            </div>
          </footer>
          {/* U-079: ì¬í™” íšë“ í† ìŠ¤íŠ¸ ì•Œë¦¼ */}
          <CurrencyToastUI />
        </div>
      </DndContext>

      {/* U-087: ì…ë ¥ ì ê¸ˆ ì˜¤ë²„ë ˆì´ - ì²˜ë¦¬ ì¤‘ pointer-events ì°¨ë‹¨ */}
      {isInputLocked && (
        <div className="input-lock-overlay" aria-live="polite" role="status">
          <span className="input-lock-label">{t('ui.input_locked')}</span>
        </div>
      )}

      {/* U-117: ì˜¨ë³´ë”© ê°€ì´ë“œ íŒì—… ì œê±° (hover íŒíŠ¸ëŠ” InteractionHintë¡œ ìœ ì§€) */}
    </>
  );
}

/**
 * U-079: ì¬í™” íšë“ í† ìŠ¤íŠ¸ ì•Œë¦¼ ì»´í¬ë„ŒíŠ¸.
 * worldStore.currencyToast ìƒíƒœë¥¼ êµ¬ë…í•˜ì—¬ íŒì—… í‘œì‹œ.
 */
function CurrencyToastUI() {
  const toast = useWorldStore((state) => state.currencyToast);
  const dismiss = useWorldStore((state) => state.dismissCurrencyToast);

  if (!toast) return null;

  return (
    <div className="currency-toast" role="alert" aria-live="assertive">
      <span className="currency-toast-icon">
        {toast.signalDelta > 0 ? '\u26A1' : '\uD83D\uDCB8'}
      </span>
      <span className="currency-toast-amount">
        {toast.signalDelta > 0 ? '+' : ''}
        {toast.signalDelta} Signal
      </span>
      <span className="currency-toast-reason">{toast.reason}</span>
      <button type="button" className="currency-toast-close" onClick={dismiss} aria-label="Close">
        {'\u2715'}
      </button>
    </div>
  );
}

export default App;
</file>

<file path="frontend/src/stores/worldStore.ts">
/**
 * Unknown World - World/Session ìƒíƒœ ê´€ë¦¬ (Zustand) (RU-003-Q4).
 *
 * TurnOutput ë°˜ì˜ìœ¼ë¡œ ê°±ì‹ ë˜ëŠ” ì„¸ì…˜ ì›”ë“œ/UI ìƒíƒœë¥¼ SSOTë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.
 * App.tsxì˜ ë¡œì»¬ ìƒíƒœë¥¼ ì´ ìŠ¤í† ì–´ë¡œ ì´ë™í•˜ì—¬ ì±…ì„ ê²½ê³„ë¥¼ ëª…í™•íˆ í•©ë‹ˆë‹¤.
 *
 * ì„¤ê³„ ì›ì¹™:
 *   - RU-003 Q1 ê²°ì •: ë„ë©”ì¸ë³„ store ë¶„ë¦¬ (Option A)
 *   - RULE-005: Economy ì¸ë°”ë¦¬ì–¸íŠ¸ (ì”ì•¡ ìŒìˆ˜ ê¸ˆì§€)
 *   - RULE-006: ko/en i18n ì •ì±… ì¤€ìˆ˜
 *
 * í™•ì¥ (U-013):
 *   - Quest/Rules/MutationEvent ìƒíƒœ ì¶”ê°€
 *   - applyTurnOutputì—ì„œ quests_updated, rules_changed ë°˜ì˜
 *
 * ìˆœí™˜ import ë°©ì§€:
 *   - worldStore â†’ (actionDeckStore/inventoryStore) ë‹¨ë°©í–¥ë§Œ í—ˆìš©
 *   - ì—­ë°©í–¥ import ê¸ˆì§€
 *
 * @module stores/worldStore
 */

import { create } from 'zustand';
import type { TurnOutput, SceneObject, Quest, WorldRule } from '../schemas/turn';
import type { SceneCanvasState, SceneProcessingPhase } from '../types/scene';
import type { CanvasSize } from '../utils/box2d';
import { useActionDeckStore } from './actionDeckStore';
import { useInventoryStore, parseInventoryAdded } from './inventoryStore';
import { useEconomyStore } from './economyStore';
import { ITEM_SELL_PRICE_SIGNAL } from '../save/constants';
import i18n from '../i18n';

// =============================================================================
// íƒ€ì… ì •ì˜
// =============================================================================

/** ì¬í™” ìƒíƒœ */
export interface EconomyState {
  signal: number;
  memory_shard: number;
  /** ì‚¬ìš© ì¤‘ì¸ í¬ë ˆë”§ (ë¹š, Signal ë‹¨ìœ„, U-079) */
  credit: number;
}

/**
 * ë‚´ëŸ¬í‹°ë¸Œ ì—”íŠ¸ë¦¬ íƒ€ì…
 *
 * U-070[Mvp]: ì•¡ì…˜ ë¡œê·¸ ì§€ì›ì„ ìœ„í•´ type í•„ë“œ ì¶”ê°€
 * - "narrative": ì¼ë°˜ ê²Œì„ ë‚´ëŸ¬í‹°ë¸Œ (ì„œë²„ì—ì„œ ìƒì„±)
 * - "action_log": í”Œë ˆì´ì–´ í–‰ë™ ë¡œê·¸ (í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìƒì„±, ì¦‰ê°ì  í”¼ë“œë°±)
 * - "system": ì‹œìŠ¤í…œ ë©”ì‹œì§€ (ë“œë¡­ ì‹¤íŒ¨ ë“±)
 */
export type NarrativeEntryType = 'narrative' | 'action_log' | 'system';

/** ë‚´ëŸ¬í‹°ë¸Œ ì—”íŠ¸ë¦¬ */
export interface NarrativeEntry {
  turn: number;
  text: string;
  /** U-070: ì—”íŠ¸ë¦¬ íƒ€ì… (ê¸°ë³¸ê°’: "narrative") */
  type?: NarrativeEntryType;
}

/**
 * ë£° ë³€í˜• ì´ë²¤íŠ¸ (U-013: Mutation Timeline)
 * ê·œì¹™ì´ ë³€ê²½ëœ ì‹œì ê³¼ ë‚´ìš©ì„ ê¸°ë¡í•©ë‹ˆë‹¤.
 */
export interface MutationEvent {
  /** ë³€í˜• ë°œìƒ í„´ */
  turn: number;
  /** ë³€í˜•ëœ ê·œì¹™ ID */
  ruleId: string;
  /** ë³€í˜• ìœ í˜•: ì¶”ê°€/ìˆ˜ì •/ì œê±° */
  type: 'added' | 'modified' | 'removed';
  /** ê·œì¹™ ë¼ë²¨ (í‘œì‹œìš©) */
  label: string;
  /** ê·œì¹™ ì„¤ëª… (ì„ íƒ) */
  description?: string;
  /** íƒ€ì„ìŠ¤íƒ¬í”„ */
  timestamp: number;
}

/**
 * U-079: ì¬í™” íšë“ í† ìŠ¤íŠ¸ ì•Œë¦¼ ë°ì´í„°.
 * ì•„ì´í…œ íŒë§¤, í€˜ìŠ¤íŠ¸ ë³´ìƒ ë“± ì¬í™” ë³€ë™ ì‹œ íŒì—… í‘œì‹œ.
 */
export interface CurrencyToast {
  /** í† ìŠ¤íŠ¸ ê³ ìœ  ID (ì¤‘ë³µ ë°©ì§€) */
  id: string;
  /** ë³€ë™ëœ Signal ì–‘ (ì–‘ìˆ˜: íšë“, ìŒìˆ˜: ì†Œë¹„) */
  signalDelta: number;
  /** ë³€ë™ ì‚¬ìœ  í‘œì‹œ í…ìŠ¤íŠ¸ */
  reason: string;
  /** ìƒì„± ì‹œê°„ (ìë™ ë‹«í˜ ê³„ì‚°ìš©) */
  createdAt: number;
}

/** World/Session ìƒíƒœ */
export interface WorldState {
  /** ì¬í™” ìƒíƒœ (RULE-005) */
  economy: EconomyState;
  /** ì—°ê²° ìƒíƒœ */
  isConnected: boolean;
  /** Scene Canvas ìƒíƒœ (U-031) */
  sceneState: SceneCanvasState;
  /** Scene Objects (U-010: í•«ìŠ¤íŒŸ ì˜¤ë²„ë ˆì´) */
  sceneObjects: SceneObject[];
  /** ë‚´ëŸ¬í‹°ë¸Œ íˆìŠ¤í† ë¦¬ */
  narrativeEntries: NarrativeEntry[];
  /** í˜„ì¬ í„´ ì¹´ìš´íŠ¸ */
  turnCount: number;

  // ============ U-013: Quest + Rule Board í™•ì¥ ============

  /** í˜„ì¬ í€˜ìŠ¤íŠ¸/ëª©í‘œ ëª©ë¡ */
  quests: Quest[];
  /** í˜„ì¬ ì ìš© ì¤‘ì¸ ê·œì¹™ ëª©ë¡ */
  activeRules: WorldRule[];
  /** ë£° ë³€í˜• ì´ë²¤íŠ¸ íƒ€ì„ë¼ì¸ (ìµœì‹ ìˆœ) */
  mutationTimeline: MutationEvent[];

  // ============ U-085: Scene Canvas í‘œì‹œ í¬ê¸° (SSOT) ============

  /**
   * Scene Canvasì˜ ì‹¤ì œ ë Œë”ë§ í¬ê¸°(px) (U-085).
   * ResizeObserverë¡œ ì¸¡ì •ëœ ê°’ì´ ë””ë°”ìš´ìŠ¤(100ms) + 5px ì´ìƒ ë³€í™” ì‹œ ê°±ì‹ ë©ë‹ˆë‹¤.
   * ì´ë¯¸ì§€ ìƒì„± ìš”ì²­ ì‹œ aspect_ratio/image_size ì„ íƒì˜ SSOTë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.
   */
  sceneCanvasSize: CanvasSize;

  // ============ U-089: ì •ë°€ë¶„ì„ ìƒíƒœ ============

  /**
   * ì •ë°€ë¶„ì„(Agentic Vision) ì‹¤í–‰ ì¤‘ ì—¬ë¶€ (U-089).
   * trueì¼ ë•Œ SceneImageëŠ” ê¸°ì¡´ ì´ë¯¸ì§€ë¥¼ ìœ ì§€í•˜ê³  ë¶„ì„ ì „ìš© ì˜¤ë²„ë ˆì´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
   */
  isAnalyzing: boolean;

  // ============ U-079: ì¬í™” íšë“ í† ìŠ¤íŠ¸ ì•Œë¦¼ ============

  /**
   * í˜„ì¬ í‘œì‹œ ì¤‘ì¸ í† ìŠ¤íŠ¸ ì•Œë¦¼ (U-079).
   * nullì´ë©´ í† ìŠ¤íŠ¸ ì—†ìŒ, ê°’ì´ ìˆìœ¼ë©´ ì¼ì • ì‹œê°„ í›„ ìë™ ì‚¬ë¼ì§.
   */
  currencyToast: CurrencyToast | null;
}

/** World Store ì•¡ì…˜ */
export interface WorldActions {
  /**
   * TurnOutputì„ ë°›ì•„ ëª¨ë“  ê´€ë ¨ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
   * ì´ ë©”ì„œë“œê°€ TurnOutput ë°˜ì˜ì˜ SSOTì…ë‹ˆë‹¤.
   */
  applyTurnOutput: (output: TurnOutput) => void;

  /**
   * ì‹œìŠ¤í…œ ë‚´ëŸ¬í‹°ë¸Œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤ (í„´ ë¯¸ë°œìƒ í”¼ë“œë°±ìš©).
   * ë“œë¡­ ì‹¤íŒ¨ ë“± í„´ì„ ë°œìƒì‹œí‚¤ì§€ ì•ŠëŠ” í”¼ë“œë°±ì— ì‚¬ìš©í•©ë‹ˆë‹¤.
   */
  appendSystemNarrative: (text: string) => void;

  /**
   * U-070[Mvp]: ì•¡ì…˜ ë¡œê·¸ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
   * í”Œë ˆì´ì–´ í–‰ë™ì— ëŒ€í•œ ì¦‰ê°ì  í”¼ë“œë°±ìœ¼ë¡œ, TurnInput ì „ì†¡ ì „ì— í˜¸ì¶œí•©ë‹ˆë‹¤.
   * PRD 9.0: "í–‰ë™ ì‹¤í–‰: ..." í˜•ì‹ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
   */
  appendActionLog: (text: string) => void;

  /** Scene ìƒíƒœ ì„¤ì • */
  setSceneState: (state: SceneCanvasState) => void;

  /** ì—°ê²° ìƒíƒœ ì„¤ì • */
  setConnected: (connected: boolean) => void;

  /** ê²½ì œ ìƒíƒœ ì„¤ì • (ì§ì ‘ ì¡°ì‘ìš©, ì¼ë°˜ì ìœ¼ë¡œ applyTurnOutput ì‚¬ìš©) */
  setEconomy: (economy: EconomyState) => void;

  /** Scene Objects ì„¤ì • (ì§ì ‘ ì¡°ì‘ìš©) */
  setSceneObjects: (objects: SceneObject[]) => void;

  /** ì´ˆê¸°í™” (ì´ˆê¸° ë‚´ëŸ¬í‹°ë¸Œ ë©”ì‹œì§€ í¬í•¨) */
  initialize: (welcomeMessage: string) => void;

  /** ìƒíƒœ ì™„ì „ ì´ˆê¸°í™” */
  reset: () => void;

  // ============ U-066: Late-binding ì´ë¯¸ì§€ ê´€ë¦¬ ============

  /**
   * ì´ë¯¸ì§€ ë¡œë”© ìƒíƒœë¥¼ ì„¤ì •í•©ë‹ˆë‹¤ (U-066).
   * ì´ë¯¸ì§€ ìƒì„± ì‹œì‘ ì‹œ í˜¸ì¶œí•˜ì—¬ ë¡œë”© ì¸ë””ì¼€ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
   *
   * @param turnId - ì´ë¯¸ì§€ë¥¼ ìš”ì²­í•œ í„´ ID
   */
  setImageLoading: (turnId: number) => void;

  /**
   * Late-binding ì´ë¯¸ì§€ë¥¼ ì ìš©í•©ë‹ˆë‹¤ (U-066).
   * ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ ì‹œ í˜¸ì¶œí•˜ì—¬, turnIdê°€ ì¼ì¹˜í•  ë•Œë§Œ ì´ë¯¸ì§€ë¥¼ ë°˜ì˜í•©ë‹ˆë‹¤.
   *
   * @param imageUrl - ìƒì„±ëœ ì´ë¯¸ì§€ URL
   * @param turnId - ì´ë¯¸ì§€ë¥¼ ìš”ì²­í•œ í„´ ID (ê°€ë“œìš©)
   * @returns ì´ë¯¸ì§€ê°€ ì ìš©ë˜ì—ˆëŠ”ì§€ ì—¬ë¶€
   */
  applyLateBindingImage: (imageUrl: string, turnId: number) => boolean;

  /**
   * ì´ë¯¸ì§€ ë¡œë”©ì„ ì·¨ì†Œí•©ë‹ˆë‹¤ (U-066).
   * ìƒˆ í„´ ì‹œì‘ ë˜ëŠ” ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨ ì‹œ í˜¸ì¶œí•©ë‹ˆë‹¤.
   */
  cancelImageLoading: () => void;

  // ============ U-085: Scene Canvas í¬ê¸° SSOT ============

  /**
   * Scene Canvas í‘œì‹œ í¬ê¸°ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤ (U-085).
   * SceneCanvas ì»´í¬ë„ŒíŠ¸ì˜ ResizeObserverì—ì„œ í˜¸ì¶œí•©ë‹ˆë‹¤.
   *
   * @param size - Scene Canvas í¬ê¸° (width, height px)
   */
  setSceneCanvasSize: (size: CanvasSize) => void;

  // ============ U-071: ì²˜ë¦¬ ë‹¨ê³„ UI ê´€ë¦¬ ============

  /**
   * ì²˜ë¦¬ ë‹¨ê³„ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤ (U-071).
   * Scene Canvasì— í˜„ì¬ ì²˜ë¦¬ ìƒíƒœë¥¼ í‘œì‹œí•˜ê¸° ìœ„í•´ ì‚¬ìš©í•©ë‹ˆë‹¤.
   *
   * @param phase - í˜„ì¬ ì²˜ë¦¬ ë‹¨ê³„ (idle, processing, image_pending, rendering)
   */
  setProcessingPhase: (phase: SceneProcessingPhase) => void;

  // ============ U-089: ì •ë°€ë¶„ì„ ìƒíƒœ ê´€ë¦¬ ============

  /**
   * ì •ë°€ë¶„ì„(Agentic Vision) ì‹¤í–‰ ìƒíƒœë¥¼ ì„¤ì •í•©ë‹ˆë‹¤ (U-089).
   * trueë¡œ ì„¤ì •í•˜ë©´ SceneImageê°€ ê¸°ì¡´ ì´ë¯¸ì§€ë¥¼ ìœ ì§€í•˜ë©´ì„œ ë¶„ì„ ì „ìš© ì˜¤ë²„ë ˆì´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
   *
   * @param analyzing - ë¶„ì„ ì‹¤í–‰ ì¤‘ ì—¬ë¶€
   */
  setIsAnalyzing: (analyzing: boolean) => void;

  // ============ U-079: ì•„ì´í…œ íŒë§¤ + í† ìŠ¤íŠ¸ ============

  /**
   * ì•„ì´í…œì„ íŒë§¤í•˜ì—¬ Signalì„ íšë“í•©ë‹ˆë‹¤ (U-079).
   * ì¸ë²¤í† ë¦¬ì—ì„œ ìˆ˜ëŸ‰ 1 ê°ì†Œ, economyì— íŒë§¤ ê°€ê²© ì¶”ê°€, Ledger ê¸°ë¡.
   *
   * @param itemId - íŒë§¤í•  ì•„ì´í…œ ID
   * @param itemName - ì•„ì´í…œ ì´ë¦„ (í† ìŠ¤íŠ¸ í‘œì‹œìš©)
   */
  sellItem: (itemId: string, itemName: string) => void;

  /**
   * ì¬í™” íšë“ í† ìŠ¤íŠ¸ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤ (U-079).
   * ì¼ì • ì‹œê°„ í›„ ìë™ìœ¼ë¡œ ì‚¬ë¼ì§‘ë‹ˆë‹¤.
   */
  showCurrencyToast: (toast: Omit<CurrencyToast, 'id' | 'createdAt'>) => void;

  /**
   * í† ìŠ¤íŠ¸ë¥¼ ë‹«ìŠµë‹ˆë‹¤ (U-079).
   */
  dismissCurrencyToast: () => void;
}

export type WorldStore = WorldState & WorldActions;

// =============================================================================
// ì´ˆê¸° ìƒíƒœ
// =============================================================================

/**
 * ì´ˆê¸° ìƒíƒœë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
 *
 * ## ì¤‘ìš”: ì´ ê°’ë“¤ì€ "í”Œë ˆì´ ì „ placeholder"ì…ë‹ˆë‹¤.
 *
 * ì‹¤ì œ ê²Œì„ ì‹œì‘ ê°’ì€ startSessionFromProfile()ì—ì„œ í”„ë¡œí•„ ë°ì´í„°ë¡œ ì£¼ì…ë©ë‹ˆë‹¤.
 * profile_select ìƒíƒœì—ì„œëŠ” HUDê°€ ë…¸ì¶œë˜ì§€ ì•Šìœ¼ë¯€ë¡œ
 * ì´ placeholder ê°’ì´ í™”ë©´ì— í‘œì‹œë  ì¼ì€ ì—†ìŠµë‹ˆë‹¤.
 *
 * @see save/sessionLifecycle.ts
 */
function createInitialState(): WorldState {
  return {
    // RU-004-Q5: Placeholder - ì‹¤ì œ ê°’ì€ í”„ë¡œí•„/ì„¸ì´ë¸Œì—ì„œ ì£¼ì…ë¨
    economy: { signal: 100, memory_shard: 5, credit: 0 },
    isConnected: true,
    sceneState: {
      status: 'default',
      message: '',
      imageUrl: undefined,
      previousImageUrl: undefined,
      processingPhase: 'idle',
      imageLoading: false,
      pendingImageTurnId: undefined,
    },
    sceneObjects: [],
    narrativeEntries: [],
    turnCount: 0,
    // U-013: Quest + Rule Board ì´ˆê¸° ìƒíƒœ
    quests: [],
    activeRules: [],
    mutationTimeline: [],
    // U-085: Scene Canvas í¬ê¸° (ì´ˆê¸°ê°’ 0x0, ì¸¡ì • í›„ ê°±ì‹ )
    sceneCanvasSize: { width: 0, height: 0 },
    // U-089: ì •ë°€ë¶„ì„ ìƒíƒœ
    isAnalyzing: false,
    // U-079: ì¬í™” íšë“ í† ìŠ¤íŠ¸
    currencyToast: null,
  };
}

// =============================================================================
// Zustand Store
// =============================================================================

/**
 * World/Session ìƒíƒœ ìŠ¤í† ì–´.
 *
 * TurnOutput ë°˜ì˜ì˜ SSOTë¡œ, App.tsxì˜ ë¡œì»¬ ìƒíƒœë¥¼ ëŒ€ì²´í•©ë‹ˆë‹¤.
 *
 * @example
 * ```tsx
 * // ì»´í¬ë„ŒíŠ¸ì—ì„œ ìƒíƒœ êµ¬ë…
 * const { economy, narrativeEntries } = useWorldStore();
 *
 * // TurnOutput ë°˜ì˜ (ìŠ¤íŠ¸ë¦¼ ì™„ë£Œ ì‹œ)
 * const applyTurnOutput = useWorldStore((state) => state.applyTurnOutput);
 * applyTurnOutput(turnOutput);
 *
 * // ì‹œìŠ¤í…œ í”¼ë“œë°± ì¶”ê°€ (ë“œë¡­ ì‹¤íŒ¨ ë“±)
 * const appendSystemNarrative = useWorldStore((state) => state.appendSystemNarrative);
 * appendSystemNarrative('ì•„ì´í…œì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
 * ```
 */
export const useWorldStore = create<WorldStore>((set, get) => ({
  // ì´ˆê¸° ìƒíƒœ
  ...createInitialState(),

  // ì•¡ì…˜

  applyTurnOutput: (output) => {
    const state = get();

    // 1. í„´ ì¹´ìš´íŠ¸ ì¦ê°€
    const newTurnCount = state.turnCount + 1;

    // 2. ë‚´ëŸ¬í‹°ë¸Œ ì¶”ê°€ (U-070: type ëª…ì‹œ)
    const newNarrativeEntry: NarrativeEntry = {
      turn: newTurnCount,
      text: output.narrative,
      type: 'narrative',
    };

    const newNarrativeEntries = [...state.narrativeEntries, newNarrativeEntry];

    // U-072: Scanner íŒíŠ¸ ìœ ë„ (Option A: ë°±ì—”ë“œ í”Œë˜ê·¸ ê¸°ë°˜)
    if (output.hints?.scanner) {
      newNarrativeEntries.push({
        turn: newTurnCount,
        text: i18n.t('scanner.hint_narrative'),
        type: 'system',
      });
    }

    // 3. ê²½ì œ ìƒíƒœ ì—…ë°ì´íŠ¸ (RULE-005: balance_after ë°˜ì˜)
    const newEconomy: EconomyState = {
      signal: output.economy.balance_after.signal,
      memory_shard: output.economy.balance_after.memory_shard,
      credit: output.economy.credit,
    };

    // 4. Scene Objects ì—…ë°ì´íŠ¸ (U-010: í•«ìŠ¤íŒŸ ì˜¤ë²„ë ˆì´)
    // U-090: í•«ìŠ¤íŒŸ ìƒíƒœ ê´€ë¦¬ ì •ì±…
    //   - ìƒˆ ì´ë¯¸ì§€ ìƒì„±(ì¥ë©´ ì „í™˜) â†’ í•«ìŠ¤íŒŸ ì „ì²´ ì´ˆê¸°í™” (Q1: Option A)
    //   - ì„œë²„ì—ì„œ objects ë¹„ì–´ìˆìŒ(ì¼ë°˜ í„´) â†’ ê¸°ì¡´ í•«ìŠ¤íŒŸ ìœ ì§€
    //   - ì„œë²„ì—ì„œ objects ìˆìŒ(ì •ë°€ë¶„ì„ í„´) â†’ ê¸°ì¡´ í•«ìŠ¤íŒŸì— ë³‘í•©
    //
    // ì¥ë©´ ì „í™˜ ê°ì§€:
    //   - render.image_urlì´ ì¡´ì¬ â†’ ì´ë²ˆ í„´ì—ì„œ ìƒˆ ì´ë¯¸ì§€ê°€ ìƒì„±ë¨ (ë™ê¸° ìƒì„± ì™„ë£Œ)
    //   - render.image_job.should_generate === true â†’ ë¹„ë™ê¸°(late-binding) ì´ë¯¸ì§€ ìƒì„± ì˜ˆì •
    //   ì–´ëŠ ê²½ìš°ë“  ìƒˆ ì¥ë©´ì´ë¯€ë¡œ ê¸°ì¡´ í•«ìŠ¤íŒŸì„ ì´ˆê¸°í™”í•œë‹¤.
    const isNewImageGeneration =
      !!output.render?.image_url || output.render?.image_job?.should_generate === true;

    let newSceneObjects: SceneObject[];

    if (isNewImageGeneration) {
      // Q1 Option A: ì¥ë©´ ì „í™˜(ìƒˆ ì´ë¯¸ì§€ ìƒì„±) â†’ í•«ìŠ¤íŒŸ ì „ì²´ ì´ˆê¸°í™”
      // ìƒˆ ì¥ë©´ì—ì„œëŠ” ì •ë°€ë¶„ì„ì„ ë‹¤ì‹œ í•´ì•¼ í•¨
      newSceneObjects = [];
    } else if (output.ui.objects.length > 0) {
      // ì •ë°€ë¶„ì„ ê²°ê³¼ ìˆìŒ â†’ ê¸°ì¡´ í•«ìŠ¤íŒŸì— ë³‘í•©
      // ë™ì¼ IDëŠ” ìƒˆ ê²°ê³¼ë¡œ ì—…ë°ì´íŠ¸, ìƒˆ IDëŠ” ì¶”ê°€
      const mergedMap = new Map(state.sceneObjects.map((o) => [o.id, o]));
      for (const obj of output.ui.objects) {
        mergedMap.set(obj.id, obj);
      }
      newSceneObjects = Array.from(mergedMap.values());
    } else {
      // ì¼ë°˜ í„´(objects ë¹„ì–´ìˆìŒ) â†’ ê¸°ì¡´ í•«ìŠ¤íŒŸ ìœ ì§€
      newSceneObjects = state.sceneObjects;
    }

    // 5. Scene ìƒíƒœ ì „ì´ (RU-003-T1: Scene ì´ë¯¸ì§€ SSOT)
    // - output.ui.scene.image_urlì´ ì¡´ì¬í•˜ë©´ 'scene' ìƒíƒœë¡œ ì „í™˜
    // - ì—†ìœ¼ë©´ 'default' ìƒíƒœ ìœ ì§€
    // - safety.blockedì¸ ê²½ìš° 'blocked' ìƒíƒœë¡œ ì „í™˜
    let newSceneState: SceneCanvasState;
    const currentImageUrl = state.sceneState.imageUrl ?? state.sceneState.previousImageUrl;

    if (output.safety.blocked) {
      newSceneState = {
        status: 'blocked',
        message: output.safety.message ?? undefined,
        previousImageUrl: currentImageUrl,
      };
    } else if (output.ui.scene?.image_url || output.render?.image_url) {
      // U-053: render.image_url ë˜ëŠ” ui.scene.image_url ì¤‘ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ scene ìƒíƒœë¡œ ì „í™˜
      const imageUrl = output.ui.scene?.image_url || output.render?.image_url;
      newSceneState = {
        status: 'scene',
        imageUrl: imageUrl!,
        message: output.ui.scene?.alt_text ?? undefined,
        // ìƒˆë¡œìš´ ì´ë¯¸ì§€ê°€ ì™”ìœ¼ë¯€ë¡œ ì´ì „ ì´ë¯¸ì§€ëŠ” ë³´ì¡´ (ë¡œë”© ì¤‘ì´ ì•„ë‹˜)
        previousImageUrl: currentImageUrl,
      };
    } else {
      newSceneState = {
        status: 'default',
        message: '',
        previousImageUrl: currentImageUrl,
      };
    }

    // 7. í•˜ìœ„ ìŠ¤í† ì–´ ì—…ë°ì´íŠ¸ (ìˆœí™˜ import ë°©ì§€: worldStore â†’ í•˜ìœ„ store ë‹¨ë°©í–¥)
    // Action Deck ì¹´ë“œ ì—…ë°ì´íŠ¸ (U-009)
    useActionDeckStore.getState().setCards(output.ui.action_deck.cards);

    // Inventory ì—…ë°ì´íŠ¸ (U-011)
    if (output.world.inventory_added.length > 0) {
      useInventoryStore.getState().addItems(parseInventoryAdded(output.world.inventory_added));
    }
    // U-096: ì•„ì´í…œ ì†Œë¹„ ì‹œ fade-out ì• ë‹ˆë©”ì´ì…˜ í›„ ì œê±°
    if (output.world.inventory_removed.length > 0) {
      const removedIds = output.world.inventory_removed;
      const invStore = useInventoryStore.getState();

      // 1ë‹¨ê³„: ì†Œë¹„ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ (fade-out CSS í´ë˜ìŠ¤ ì ìš©)
      invStore.markConsuming(removedIds);

      // 2ë‹¨ê³„: ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ì‹¤ì œ ì œê±° (500ms = CSS transition ì‹œê°„)
      setTimeout(() => {
        useInventoryStore.getState().clearConsuming(removedIds);
      }, 500);
    }

    // Economy Store ì—…ë°ì´íŠ¸ (U-014: Ledger ê¸°ë¡)
    // U-069: ì„œë²„ì—ì„œ ì „ë‹¬ëœ model_label ì‚¬ìš© (FAST/QUALITY í‹°ì–´ë§)
    const economyStore = useEconomyStore.getState();
    economyStore.addLedgerEntry({
      turnId: newTurnCount,
      reason: 'economy.ledger_reason.turn_cost', // U-099: i18n í‚¤ ê¸°ë°˜ ì‚¬ìœ  (ì–¸ì–´ í˜¼í•© ë°©ì§€)
      cost: output.economy.cost,
      balanceAfter: output.economy.balance_after,
      modelLabel: output.agent_console.model_label ?? 'FAST',
      lowBalanceWarning: output.economy.low_balance_warning,
    });
    // ì”ì•¡ ë¶€ì¡± ìƒíƒœ ì—…ë°ì´íŠ¸
    economyStore.updateBalanceLowStatus(newEconomy);

    // 6. Quest ìƒíƒœ ì—…ë°ì´íŠ¸ (U-013, U-078: ëª©í‘œ ì‹œìŠ¤í…œ ê°•í™”)
    // quests_updatedëŠ” ì „ì²´ í€˜ìŠ¤íŠ¸ ëª©ë¡ì´ ì•„ë‹Œ "ì—…ë°ì´íŠ¸ëœ" í€˜ìŠ¤íŠ¸ë§Œ í¬í•¨
    // ê¸°ì¡´ í€˜ìŠ¤íŠ¸ë¥¼ ì—…ë°ì´íŠ¸í•˜ê±°ë‚˜ ìƒˆ í€˜ìŠ¤íŠ¸ë¥¼ ì¶”ê°€
    // U-078: ì„œë¸Œ ëª©í‘œ ì™„ë£Œ ì‹œ ë³´ìƒ ì•Œë¦¼ ì‹œìŠ¤í…œ ë‚´ëŸ¬í‹°ë¸Œ ì¶”ê°€
    const newQuests = [...state.quests];
    for (const updatedQuest of output.world.quests_updated) {
      const existingIndex = newQuests.findIndex((q) => q.id === updatedQuest.id);
      if (existingIndex >= 0) {
        // U-078: ë¯¸ì™„ë£Œ â†’ ì™„ë£Œ ì „í™˜ ê°ì§€ (ë³´ìƒ í”¼ë“œë°±ìš©)
        const prevQuest = newQuests[existingIndex];
        if (
          !prevQuest.is_completed &&
          updatedQuest.is_completed &&
          updatedQuest.reward_signal > 0
        ) {
          newNarrativeEntries.push({
            turn: newTurnCount,
            text: `ğŸ¯ ${i18n.t('quest.objective_complete')} ${i18n.t('quest.reward_earned', { signal: updatedQuest.reward_signal })}`,
            type: 'system',
          });
        }
        // ê¸°ì¡´ í€˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        newQuests[existingIndex] = updatedQuest;
      } else {
        // ìƒˆ í€˜ìŠ¤íŠ¸ ì¶”ê°€
        newQuests.push(updatedQuest);
      }
    }

    // 7. Rules ìƒíƒœ ì—…ë°ì´íŠ¸ + Mutation Timeline ê¸°ë¡ (U-013)
    const newActiveRules = [...state.activeRules];
    const newMutationEvents: MutationEvent[] = [];
    const now = Date.now();

    for (const changedRule of output.world.rules_changed) {
      const existingIndex = newActiveRules.findIndex((r) => r.id === changedRule.id);
      if (existingIndex >= 0) {
        // ê¸°ì¡´ ê·œì¹™ ìˆ˜ì •
        newActiveRules[existingIndex] = changedRule;
        newMutationEvents.push({
          turn: newTurnCount,
          ruleId: changedRule.id,
          type: 'modified',
          label: changedRule.label,
          description: changedRule.description ?? undefined,
          timestamp: now,
        });
      } else {
        // ìƒˆ ê·œì¹™ ì¶”ê°€
        newActiveRules.push(changedRule);
        newMutationEvents.push({
          turn: newTurnCount,
          ruleId: changedRule.id,
          type: 'added',
          label: changedRule.label,
          description: changedRule.description ?? undefined,
          timestamp: now,
        });
      }
    }

    // íƒ€ì„ë¼ì¸ì— ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€ (ìµœì‹ ìˆœ ì •ë ¬)
    const updatedTimeline = [...newMutationEvents, ...state.mutationTimeline];

    // 8. ìƒíƒœ ì—…ë°ì´íŠ¸ (RU-003-T1: sceneState í¬í•¨, U-013: quest/rules)
    set({
      turnCount: newTurnCount,
      narrativeEntries: newNarrativeEntries,
      economy: newEconomy,
      sceneObjects: newSceneObjects,
      sceneState: newSceneState,
      // U-013 í™•ì¥
      quests: newQuests,
      activeRules: newActiveRules,
      mutationTimeline: updatedTimeline,
    });

    // === í–¥í›„ í™•ì¥ ìŠ¬ë¡¯ (RU-003-Q4 Step 4) ===
    // TODO: output.world.memory_pins â†’ Memory Pin íŒ¨ë„ ì—…ë°ì´íŠ¸
  },

  appendSystemNarrative: (text) => {
    set((state) => ({
      narrativeEntries: [
        ...state.narrativeEntries,
        {
          turn: state.turnCount, // í˜„ì¬ í„´ìœ¼ë¡œ ê¸°ë¡ (í„´ ì¦ê°€ ì—†ìŒ)
          text,
          type: 'system',
        },
      ],
    }));
  },

  // U-070[Mvp]: ì•¡ì…˜ ë¡œê·¸ ì¶”ê°€
  appendActionLog: (text) => {
    set((state) => ({
      narrativeEntries: [
        ...state.narrativeEntries,
        {
          turn: state.turnCount, // í˜„ì¬ í„´ìœ¼ë¡œ ê¸°ë¡ (í„´ ì¦ê°€ ì—†ìŒ)
          text,
          type: 'action_log',
        },
      ],
    }));
  },

  setSceneState: (sceneState) => {
    // U-071 ë²„ê·¸ ìˆ˜ì •: processingPhaseë¥¼ ë³´ì¡´í•˜ë©° ë³‘í•©
    set((state) => ({
      sceneState: {
        ...state.sceneState,
        ...sceneState,
      },
    }));
  },

  setConnected: (isConnected) => {
    set({ isConnected });
  },

  setEconomy: (economy) => {
    set({ economy });
  },

  setSceneObjects: (sceneObjects) => {
    set({ sceneObjects });
  },

  initialize: (welcomeMessage) => {
    set({
      ...createInitialState(),
      narrativeEntries: [{ turn: 0, text: welcomeMessage, type: 'narrative' }],
    });
  },

  reset: () => {
    set(createInitialState());
  },

  // ============ U-066: Late-binding ì´ë¯¸ì§€ ê´€ë¦¬ ============

  setImageLoading: (turnId) => {
    set((state) => ({
      sceneState: {
        ...state.sceneState,
        imageLoading: true,
        pendingImageTurnId: turnId,
        sceneRevision: turnId,
        // ì´ì „ ì´ë¯¸ì§€ URL ë³´ì¡´ (Option A: ì´ì „ ì´ë¯¸ì§€ ìœ ì§€)
        previousImageUrl: state.sceneState.imageUrl ?? state.sceneState.previousImageUrl,
      },
    }));
  },

  applyLateBindingImage: (imageUrl, turnId) => {
    const state = get();

    // late-binding ê°€ë“œ: pendingImageTurnIdì™€ ì¼ì¹˜í•  ë•Œë§Œ ì ìš©
    if (state.sceneState.pendingImageTurnId !== turnId) {
      // ì´ë¯¸ ìƒˆ í„´ì´ ì‹œì‘ë˜ì–´ ì´ì „ ìš”ì²­ì€ ë¬´ì‹œ
      return false;
    }

    set({
      sceneState: {
        status: 'scene',
        imageUrl,
        imageLoading: false,
        pendingImageTurnId: undefined,
        sceneRevision: turnId,
        // ì´ì „ ì´ë¯¸ì§€ URLì€ ì„±ê³µ ì‹œ í˜„ì¬ ì´ë¯¸ì§€ë¡œ ëŒ€ì²´
        previousImageUrl: undefined,
      },
    });

    return true;
  },

  cancelImageLoading: () => {
    set((state) => ({
      sceneState: {
        ...state.sceneState,
        imageLoading: false,
        pendingImageTurnId: undefined,
        // ì´ì „ ì´ë¯¸ì§€ ìœ ì§€ (í´ë°±)
        imageUrl: state.sceneState.previousImageUrl ?? state.sceneState.imageUrl,
        previousImageUrl: undefined,
      },
    }));
  },

  // ============ U-085: Scene Canvas í¬ê¸° SSOT ============

  setSceneCanvasSize: (size) => {
    set({ sceneCanvasSize: size });
  },

  // ============ U-071: ì²˜ë¦¬ ë‹¨ê³„ UI ê´€ë¦¬ ============

  setProcessingPhase: (phase) => {
    set((state) => ({
      sceneState: {
        ...state.sceneState,
        processingPhase: phase,
      },
    }));
  },

  // ============ U-089: ì •ë°€ë¶„ì„ ìƒíƒœ ê´€ë¦¬ ============

  setIsAnalyzing: (analyzing) => {
    set({ isAnalyzing: analyzing });
  },

  // ============ U-079: ì•„ì´í…œ íŒë§¤ + í† ìŠ¤íŠ¸ ============

  sellItem: (itemId, itemName) => {
    const state = get();

    // 1. ì¸ë²¤í† ë¦¬ì—ì„œ ì•„ì´í…œ ìˆ˜ëŸ‰ ê°ì†Œ (1ê°œ ì œê±°)
    const invStore = useInventoryStore.getState();
    const item = invStore.items.find((i) => i.id === itemId);
    if (!item) return; // ì•„ì´í…œ ì—†ìœ¼ë©´ ë¬´ì‹œ

    // fade-out ì• ë‹ˆë©”ì´ì…˜ í›„ ì œê±°
    invStore.markConsuming([itemId]);
    setTimeout(() => {
      useInventoryStore.getState().clearConsuming([itemId]);
    }, 500);

    // 2. Signal ì¶”ê°€ (RULE-005: ì”ì•¡ ìŒìˆ˜ ê¸ˆì§€ì´ë¯€ë¡œ ì¶”ê°€ë§Œ)
    const sellPrice = ITEM_SELL_PRICE_SIGNAL;
    const newEconomy: EconomyState = {
      signal: state.economy.signal + sellPrice,
      memory_shard: state.economy.memory_shard,
      credit: state.economy.credit,
    };

    // 3. ë‚´ëŸ¬í‹°ë¸Œì— íŒë§¤ ê¸°ë¡ ì¶”ê°€
    const sellText = i18n.t('inventory.sell_narrative', {
      item: itemName,
      signal: sellPrice,
    });

    set({
      economy: newEconomy,
      narrativeEntries: [
        ...state.narrativeEntries,
        {
          turn: state.turnCount,
          text: sellText,
          type: 'system' as const,
        },
      ],
    });

    // 4. Economy Storeì— Ledger ê¸°ë¡
    const economyStore = useEconomyStore.getState();
    economyStore.addLedgerEntry({
      turnId: state.turnCount,
      reason: `inventory.sell_ledger_reason|${itemName}`, // U-099: í‚¤|íŒŒë¼ë¯¸í„° í˜•ì‹
      cost: { signal: -sellPrice, memory_shard: 0 }, // ìŒìˆ˜ cost = ìˆ˜ì…
      balanceAfter: newEconomy,
      modelLabel: 'FAST',
    });
    economyStore.updateBalanceLowStatus(newEconomy);

    // 5. í† ìŠ¤íŠ¸ ì•Œë¦¼
    get().showCurrencyToast({
      signalDelta: sellPrice,
      reason: i18n.t('inventory.sell_toast', { item: itemName }),
    });
  },

  showCurrencyToast: (toastData) => {
    const toast: CurrencyToast = {
      ...toastData,
      id: `toast-${Date.now()}`,
      createdAt: Date.now(),
    };
    set({ currencyToast: toast });

    // 3ì´ˆ í›„ ìë™ ë‹«í˜
    setTimeout(() => {
      const current = useWorldStore.getState().currencyToast;
      if (current?.id === toast.id) {
        useWorldStore.getState().dismissCurrencyToast();
      }
    }, 3000);
  },

  dismissCurrencyToast: () => {
    set({ currencyToast: null });
  },
}));

// =============================================================================
// ì…€ë ‰í„° (ì„±ëŠ¥ ìµœì í™”ìš©)
// =============================================================================

/** ê²½ì œ ìƒíƒœ ì…€ë ‰í„° */
export const selectEconomy = (state: WorldStore) => state.economy;

/** Signal ì”ì•¡ ì…€ë ‰í„° */
export const selectSignal = (state: WorldStore) => state.economy.signal;

/** Memory Shard ì”ì•¡ ì…€ë ‰í„° */
export const selectMemoryShard = (state: WorldStore) => state.economy.memory_shard;

/** ì—°ê²° ìƒíƒœ ì…€ë ‰í„° */
export const selectIsConnected = (state: WorldStore) => state.isConnected;

/** Scene ìƒíƒœ ì…€ë ‰í„° */
export const selectSceneState = (state: WorldStore) => state.sceneState;

/** Scene Objects ì…€ë ‰í„° */
export const selectSceneObjects = (state: WorldStore) => state.sceneObjects;

/** ë‚´ëŸ¬í‹°ë¸Œ ì—”íŠ¸ë¦¬ ì…€ë ‰í„° */
export const selectNarrativeEntries = (state: WorldStore) => state.narrativeEntries;

/** í„´ ì¹´ìš´íŠ¸ ì…€ë ‰í„° */
export const selectTurnCount = (state: WorldStore) => state.turnCount;

// ============ U-013: Quest + Rule Board ì…€ë ‰í„° ============

/** í€˜ìŠ¤íŠ¸ ëª©ë¡ ì…€ë ‰í„° */
export const selectQuests = (state: WorldStore) => state.quests;

/** í™œì„± ê·œì¹™ ëª©ë¡ ì…€ë ‰í„° */
export const selectActiveRules = (state: WorldStore) => state.activeRules;

/** ë®¤í…Œì´ì…˜ íƒ€ì„ë¼ì¸ ì…€ë ‰í„° */
export const selectMutationTimeline = (state: WorldStore) => state.mutationTimeline;

/** ì§„í–‰ ì¤‘ì¸ í€˜ìŠ¤íŠ¸ ì…€ë ‰í„° */
export const selectActiveQuests = (state: WorldStore) =>
  state.quests.filter((q) => !q.is_completed);

/** ì™„ë£Œëœ í€˜ìŠ¤íŠ¸ ì…€ë ‰í„° */
export const selectCompletedQuests = (state: WorldStore) =>
  state.quests.filter((q) => q.is_completed);

// ============ U-078: ëª©í‘œ ì‹œìŠ¤í…œ ì…€ë ‰í„° ============

/** ì£¼ ëª©í‘œ(Main Objective) ì…€ë ‰í„° - is_main=trueì¸ ì²« ë²ˆì§¸ í€˜ìŠ¤íŠ¸ */
export const selectMainObjective = (state: WorldStore) =>
  state.quests.find((q) => q.is_main) ?? null;

/** ì„œë¸Œ ëª©í‘œ(Sub-objectives) ì…€ë ‰í„° - is_main=falseì¸ í€˜ìŠ¤íŠ¸ */
export const selectSubObjectives = (state: WorldStore) => state.quests.filter((q) => !q.is_main);

// ============ U-085: Scene Canvas í¬ê¸° ì…€ë ‰í„° ============

/** Scene Canvas í¬ê¸° ì…€ë ‰í„° */
export const selectSceneCanvasSize = (state: WorldStore) => state.sceneCanvasSize;

// ============ U-089: ì •ë°€ë¶„ì„ ì…€ë ‰í„° ============

/** ì •ë°€ë¶„ì„ ì‹¤í–‰ ì¤‘ ì—¬ë¶€ ì…€ë ‰í„° */
export const selectIsAnalyzing = (state: WorldStore) => state.isAnalyzing;

/** U-079: ì¬í™” íšë“ í† ìŠ¤íŠ¸ ì…€ë ‰í„° */
export const selectCurrencyToast = (state: WorldStore) => state.currencyToast;

// =============================================================================
// DEV: ë””ë²„ê·¸ìš© ê¸€ë¡œë²Œ ë…¸ì¶œ (í”„ë¡œë•ì…˜ì—ì„œ ì œê±°ë¨)
// =============================================================================

if (import.meta.env.DEV && typeof window !== 'undefined') {
  (window as unknown as Record<string, unknown>).__worldStore = useWorldStore;
}
</file>

<file path="frontend/src/locales/en-US/translation.json">
{
  "language": {
    "toggle": "Change Language",
    "toggle_tooltip": "Click to change language. A new game will start after change.",
    "ko-KR": "í•œêµ­ì–´",
    "en-US": "English"
  },
  "error": {
    "unknown_error": "An unknown error occurred.",
    "response_processing": "[System] An error occurred while processing response data.",
    "connection_failed": "[System] Failed to connect to server. Please try again."
  },
  "profile": {
    "select_title": "Select Your Profile",
    "select_hint": "Each profile has different starting conditions and objectives",
    "or": "or",
    "continue_saved": "Continue Saved Game",
    "change": "Change Profile",
    "change_tooltip": "Start a new game with a different profile",
    "narrator": {
      "name": "Narrator",
      "description": "Explore diverse stories with abundant resources",
      "welcome": "Welcome to the Ancient Library. Forgotten tales slumber within these walls...",
      "items": {
        "ancient_tome": "Ancient Tome",
        "quill_pen": "Quill Pen",
        "memory_fragment": "Memory Fragment"
      },
      "quest": {
        "discover_origin": "Discover the World's Origin",
        "discover_origin_desc": "Find clues and uncover how this world was created",
        "collect_memories": "Collect 3 Memory Fragments",
        "read_ancient_tome": "Decipher the Ancient Tome"
      },
      "rule": {
        "time_flows": "Flow of Time",
        "time_flows_desc": "Time flows normally",
        "memories_persist": "Memory Persistence",
        "memories_persist_desc": "Once obtained, memories never fade"
      },
      "scene": {
        "bookshelf": "Mysterious Bookshelf",
        "bookshelf_hint": "Ancient books are glowing",
        "portal": "Glowing Portal",
        "portal_hint": "It seems to lead somewhere"
      }
    },
    "explorer": {
      "name": "Explorer",
      "description": "Explore unknown territories and uncover secrets",
      "welcome": "You wake up in a dark maze. You must find the exit and escape...",
      "items": {
        "compass": "Compass",
        "rope": "Rope",
        "lantern": "Lantern",
        "map_fragment": "Map Fragment"
      },
      "quest": {
        "find_exit": "Find the Exit",
        "find_exit_desc": "Explore the maze and find the hidden exit to escape",
        "explore_areas": "Explore 3 Areas",
        "gather_supplies": "Gather Supplies"
      },
      "rule": {
        "gravity": "Gravity Law",
        "gravity_desc": "Objects fall downward",
        "darkness": "Darkness Law",
        "darkness_desc": "You cannot see without light"
      },
      "scene": {
        "door": "Ancient Door",
        "door_hint": "Looks like it needs a key",
        "mechanism": "Strange Mechanism",
        "mechanism_hint": "It might be operable",
        "passage": "Hidden Passage",
        "passage_hint": "Where does it lead?"
      }
    },
    "tech": {
      "name": "Tech Expert",
      "description": "Strategize efficiently with limited resources",
      "welcome": "System boot complete. Find the optimal path with limited energy...",
      "items": {
        "data_core": "Data Core",
        "circuit_board": "Circuit Board",
        "energy_cell": "Energy Cell",
        "scanner": "Scanner Device"
      },
      "quest": {
        "analyze_system": "Complete System Analysis",
        "analyze_system_desc": "Access the core terminal and analyze the system structure",
        "optimize_resources": "Optimize Resource Efficiency",
        "scan_terminal": "Perform Terminal Scan"
      },
      "rule": {
        "energy_conservation": "Energy Conservation",
        "energy_conservation_desc": "Energy is neither created nor destroyed",
        "data_integrity": "Data Integrity",
        "data_integrity_desc": "Corrupted data cannot be recovered",
        "system_limits": "System Limits",
        "system_limits_desc": "There are limits to concurrent processing"
      },
      "scene": {
        "terminal": "Main Terminal",
        "terminal_hint": "You can access the system",
        "conduit": "Power Conduit",
        "conduit_hint": "Energy is flowing through it"
      }
    }
  },
  "reset": {
    "button": "Reset",
    "confirm": "Click again to confirm",
    "cancel": "Cancel",
    "tooltip": "Return to the initial state of current profile"
  },
  "demo": {
    "items": {
      "keycard-alpha": {
        "name": "Keycard A"
      },
      "medkit": {
        "name": "Medkit"
      },
      "flashlight": {
        "name": "Flashlight"
      },
      "data-chip": {
        "name": "Data Chip"
      }
    },
    "scene": {
      "terminal": {
        "label": "Terminal",
        "hint": "An active terminal"
      },
      "door": {
        "label": "Door",
        "hint": "It appears to be locked"
      }
    },
    "quest": {
      "terminal": {
        "label": "Access the terminal"
      },
      "escape": {
        "label": "Find facility exit"
      },
      "collect": {
        "label": "Collect data chips"
      }
    },
    "rule": {
      "gravity": {
        "label": "Gravity Law",
        "description": "Objects fall downward"
      },
      "time": {
        "label": "Time Flow",
        "description": "Time flows at normal speed"
      }
    }
  },
  "quest": {
    "empty": "[ NO OBJECTIVES ]",
    "completed": "DONE",
    "section": {
      "active": "Active",
      "completed": "Completed"
    },
    "main_objective": "Main Objective",
    "sub_objectives": "Sub-objectives",
    "progress": "Progress {{progress}}%",
    "reward_preview": "Reward: {{signal}} Signal",
    "reward_earned": "+{{signal}} Signal earned!",
    "objective_complete": "Objective Complete!",
    "free_exploration": "Free Exploration",
    "free_exploration_desc": "Explore the world freely without a set objective",
    "no_sub_objectives": "No sub-objectives yet",
    "tracker_no_objective": "No Objective"
  },
  "rule_board": {
    "empty": "[ NO RULES ]",
    "active_count": "Active Rules: {{count}}"
  },
  "mutation": {
    "empty": "[ NO MUTATIONS ]",
    "timeline_title": "Mutation Timeline",
    "event_count": "{{count}} events",
    "more_events": "+{{count}} more",
    "turn_label": "T{{turn}}",
    "type": {
      "added": "Added",
      "modified": "Modified",
      "removed": "Removed"
    }
  },
  "scene": {
    "status": {
      "default": "NO SIGNAL DATA",
      "loading": "SYNCHRONIZING...",
      "offline": "CONNECTION LOST",
      "blocked": "ACCESS RESTRICTED",
      "low_signal": "LOW SIGNAL",
      "image_error": "Unable to load scene image.",
      "image_loading": "Loading scene image...",
      "image_generating": "Generating new scene...",
      "initial_sync": "Awaiting global data synchronization...",
      "syncing": "Synchronizing data...",
      "alt": "Scene Image"
    },
    "processing": {
      "processing": "Generating scene...",
      "image_pending": "Forming image...",
      "rendering": "Applying results..."
    },
    "analyzing": {
      "message": "ANALYZING SCENE...",
      "hint": "Scanning for objects"
    },
    "hotspot": {
      "layer_label": "Clickable Objects Area",
      "hint_prefix": "Hint",
      "click_action": "Click {{label}}",
      "drop_hint": "Drop here to use",
      "drop_action": "Use {{item}} on {{target}}",
      "drop_invalid": "You cannot use {{item}} there.",
      "demo_hint": "[DEMO TARGET]"
    }
  },
  "agent": {
    "console": {
      "queue": "Queue",
      "badges": "Badges",
      "repair": "Auto-repair",
      "status": {
        "idle": "IDLE",
        "processing": "PROCESSING"
      },
      "badges_empty": "[ Awaiting Validation ]",
      "repaired": "(Repaired)",
      "phase": {
        "parse": "Parse",
        "validate": "Validate",
        "plan": "Plan",
        "resolve": "Resolve",
        "render": "Render",
        "verify": "Verify",
        "commit": "Commit"
      },
      "badge": {
        "schema": "Schema",
        "economy": "Economy",
        "safety": "Safety",
        "consistency": "Consistency",
        "ok": "OK",
        "fail": "FAIL"
      },
      "model": {
        "fast": "Fast (FAST)",
        "quality": "Quality (QUALITY)",
        "cheap": "Cheap",
        "ref": "Reference"
      },
      "expand": "Details",
      "collapse": "Collapse",
      "queue_idle": "Waiting..."
    }
  },
  "ui": {
    "logo": "UNKNOWN WORLD",
    "command_placeholder": "Enter command...",
    "processing": "Processing...",
    "execute": "EXECUTE",
    "wait": "WAIT",
    "panel_placeholder": "[ Ready ]",
    "scale_decrease": "Decrease text size",
    "scale_increase": "Increase text size",
    "scale_label": "UI Scale Settings",
    "input_locked": "Processingâ€¦",
    "input_locked_detail": "Awaiting turn results"
  },
  "economy": {
    "signal": "Signal",
    "shard": "Shard",
    "signal_cost": "Signal cost",
    "shard_cost": "Shard cost",
    "risk_level": "Risk level",
    "hud_label": "Economy Status",
    "estimated_cost": "Est. Cost",
    "confirmed_cost": "Confirmed",
    "insufficient_funds": "Insufficient funds",
    "low_balance_warning": "Low balance",
    "low_balance_title": "Low Signal - Alternatives",
    "credit": "Credit",
    "credit_desc": "Current credit (debt) being used. Will be repaid first when earning currency.",
    "fast_fallback_notice": "Images will be generated in basic quality (FAST) for free",
    "hint_sell_items": "Sell inventory items to earn Signal",
    "hint_earn_actions": "Select currency earning cards (\u26A1)",
    "hint_complete_quests": "Complete objectives to earn rewards",
    "alternatives_title": "Alternatives",
    "alternative_text_only": "Text-only (no images)",
    "alternative_low_quality": "Low quality / Fast response",
    "ledger_title": "Resource Log",
    "ledger_empty": "[ NO HISTORY ]",
    "model_label": {
      "FAST": "Fast",
      "QUALITY": "Quality",
      "CHEAP": "Cheap",
      "REF": "Ref"
    },
    "ledger_reason": {
      "turn_cost": "Turn Cost"
    }
  },
  "connection": {
    "online": "ONLINE",
    "offline": "OFFLINE"
  },
  "inventory": {
    "empty": "[ NO ITEMS ]",
    "empty_hint": "Explore scenes to find items",
    "count": "Inventory ({{count}})",
    "grid_label": "Inventory Items",
    "list_label": "Inventory Items",
    "item_label": "{{name}} (Qty: {{quantity}})",
    "drag_hint": "Drag to use",
    "item_consumed": "{{name}} consumed",
    "sell_tooltip": "Sell (+{{price}} Signal)",
    "sell_aria": "Sell {{item}} (+{{price}} Signal)",
    "sell_narrative": "\uD83D\uDCB0 Sold {{item}} and earned {{signal}} Signal.",
    "sell_toast": "Sold {{item}}!",
    "sell_ledger_reason": "Item sold"
  },
  "interaction": {
    "hotspot_click": "Click to investigate",
    "item_drag": "Drag to use",
    "drop_here": "Drop here",
    "_u117_removed": "Onboarding guide keys removed (U-117)"
  },
  "common": {
    "next": "Next"
  },
  "panel": {
    "inventory": {
      "title": "Inventory",
      "placeholder": "[ Drag & Drop Area ]"
    },
    "quest": {
      "title": "Quest",
      "placeholder": "[ Objectives / Quest List ]"
    },
    "rule_board": {
      "title": "Rule Board",
      "placeholder": "[ World Rules / Mutation Timeline ]"
    },
    "agent_console": {
      "title": "Agent Console"
    },
    "memory_pin": {
      "title": "Memory Pin",
      "placeholder": "[ Pinned Memories / Clues ]"
    },
    "scanner": {
      "title": "Scanner",
      "placeholder": "[ Image Upload Slot ]"
    }
  },
  "scanner": {
    "dropzone_label": "Drop image or click to upload",
    "dropzone_text": "Drop Image Here",
    "dropzone_hint": "Or click to browse files",
    "upload_label": "Upload image",
    "preview_alt": "Upload image preview",
    "uploading": "Uploading...",
    "analyzing": "Analyzing...",
    "retry": "Retry",
    "cancel": "Cancel",
    "select_items": "Select items to add to inventory",
    "add_to_inventory": "Add ({{count}})",
    "detected_objects": "Objects detected: {{count}}",
    "item_candidates": "Item candidates: {{count}}",
    "no_candidates": "No item candidates found",
    "discovery_message": {
      "one": "You found an item!",
      "two": "You found two items!",
      "three": "You found three items! What an amazing discovery!"
    },
    "error": {
      "unsupported_format": "Unsupported image format",
      "file_too_large": "File too large (max 20MB)",
      "unknown": "An unknown error occurred"
    },
    "item_type": {
      "key": "Key",
      "weapon": "Weapon",
      "tool": "Tool",
      "clue": "Clue",
      "material": "Material",
      "consumable": "Consumable",
      "document": "Document",
      "artifact": "Artifact"
    },
    "tooltip": {
      "title": "Scanner",
      "description": "Upload a real-world photo to transform it into in-game items or clues"
    },
    "affordance": {
      "idle_hint": "Image â†’ Item",
      "drag_active": "Drop here!"
    }
  },
  "action": {
    "default": {
      "explore": {
        "label": "Explore",
        "description": "Look around"
      },
      "investigate": {
        "label": "Investigate",
        "description": "Examine closely"
      },
      "talk": {
        "label": "Talk",
        "description": "Start a conversation"
      }
    },
    "card_select": "Card selected: {{cardId}}",
    "deck_label": "Action Cards",
    "alternative": "ALT",
    "insufficient_balance": "Insufficient balance",
    "server_disabled": "Unavailable",
    "vision_badge": "VISION",
    "earn_badge": "Earn Signal",
    "all_disabled_notice": "No actions available. Check alternatives.",
    "risk": {
      "low": "Low",
      "medium": "Med",
      "high": "High"
    },
    "cost_range": "{{min}}~{{max}}"
  },
  "narrative": {
    "welcome": "Welcome to the Unknown World...",
    "turn_label": "[TURN {{turn}}]",
    "streaming_label": "[STREAMING]",
    "fast_forward_title": "Click to fast-forward",
    "fast_forward_aria": "Click or press Enter/Space to display text instantly",
    "image_pending_label": "Forming imageâ€¦"
  },
  "action_log": {
    "use_item_on_hotspot": "Action: Use {{item}} on {{hotspot}}",
    "click_hotspot": "Action: Examine {{hotspot}}",
    "click_action": "Action: {{action}}"
  }
}
</file>

<file path="frontend/src/locales/ko-KR/translation.json">
{
  "language": {
    "toggle": "ì–¸ì–´ ë³€ê²½",
    "toggle_tooltip": "í´ë¦­í•˜ì—¬ ì–¸ì–´ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤. ë³€ê²½ í›„ ìƒˆ ê²Œì„ì´ ì‹œì‘ë©ë‹ˆë‹¤.",
    "ko-KR": "í•œêµ­ì–´",
    "en-US": "English"
  },
  "error": {
    "unknown_error": "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
    "response_processing": "[ì‹œìŠ¤í…œ] ì‘ë‹µ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
    "connection_failed": "[ì‹œìŠ¤í…œ] ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”."
  },
  "profile": {
    "select_title": "í”„ë¡œí•„ì„ ì„ íƒí•˜ì„¸ìš”",
    "select_hint": "í”„ë¡œí•„ë§ˆë‹¤ ë‹¤ë¥¸ ì‹œì‘ ì¡°ê±´ê³¼ ëª©í‘œê°€ ìˆìŠµë‹ˆë‹¤",
    "or": "ë˜ëŠ”",
    "continue_saved": "ì €ì¥ëœ ê²Œì„ ê³„ì†í•˜ê¸°",
    "change": "í”„ë¡œí•„ ë³€ê²½",
    "change_tooltip": "ë‹¤ë¥¸ í”„ë¡œí•„ë¡œ ìƒˆ ê²Œì„ ì‹œì‘",
    "narrator": {
      "name": "ì„œì‚¬ê¾¼",
      "description": "í’ë¶€í•œ ìì›ìœ¼ë¡œ ë‹¤ì–‘í•œ ì´ì•¼ê¸°ë¥¼ íƒí—˜í•˜ì„¸ìš”",
      "welcome": "ê³ ëŒ€ì˜ ë„ì„œê´€ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤. ì´ê³³ì—ëŠ” ìŠí˜€ì§„ ì´ì•¼ê¸°ë“¤ì´ ì ë“¤ì–´ ìˆìŠµë‹ˆë‹¤...",
      "items": {
        "ancient_tome": "ê³ ëŒ€ ì„œì±…",
        "quill_pen": "ê¹ƒíœ",
        "memory_fragment": "ê¸°ì–µ ì¡°ê°"
      },
      "quest": {
        "discover_origin": "ì„¸ê³„ì˜ ê¸°ì›ì„ ë°œê²¬í•˜ê¸°",
        "discover_origin_desc": "ì´ ì„¸ê³„ê°€ ì–´ë–»ê²Œ ë§Œë“¤ì–´ì¡ŒëŠ”ì§€ ë‹¨ì„œë¥¼ ì°¾ì•„ ë°í˜€ë‚´ì„¸ìš”",
        "collect_memories": "ê¸°ì–µ ì¡°ê° 3ê°œ ìˆ˜ì§‘í•˜ê¸°",
        "read_ancient_tome": "ê³ ëŒ€ ì„œì±…ì„ í•´ë…í•˜ê¸°"
      },
      "rule": {
        "time_flows": "ì‹œê°„ì˜ íë¦„",
        "time_flows_desc": "ì‹œê°„ì€ ì •ìƒì ìœ¼ë¡œ íë¦…ë‹ˆë‹¤",
        "memories_persist": "ê¸°ì–µì˜ ì§€ì†",
        "memories_persist_desc": "í•œë²ˆ ì–»ì€ ê¸°ì–µì€ ì‚¬ë¼ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤"
      },
      "scene": {
        "bookshelf": "ì‹ ë¹„í•œ ì±…ì¥",
        "bookshelf_hint": "ì˜¤ë˜ëœ ì±…ë“¤ì´ ë¹›ë‚˜ê³  ìˆë‹¤",
        "portal": "ë¹›ë‚˜ëŠ” í¬íƒˆ",
        "portal_hint": "ì–´ë”˜ê°€ë¡œ í†µí•˜ëŠ” ê²ƒ ê°™ë‹¤"
      }
    },
    "explorer": {
      "name": "íƒí—˜ê°€",
      "description": "ë¯¸ì§€ì˜ ì˜ì—­ì„ íƒí—˜í•˜ê³  ë¹„ë°€ì„ ë°œê²¬í•˜ì„¸ìš”",
      "welcome": "ì–´ë‘ìš´ ë¯¸ë¡œì—ì„œ ëˆˆì„ ë–´ìŠµë‹ˆë‹¤. ì¶œêµ¬ë¥¼ ì°¾ì•„ ì´ê³³ì„ íƒˆì¶œí•´ì•¼ í•©ë‹ˆë‹¤...",
      "items": {
        "compass": "ë‚˜ì¹¨ë°˜",
        "rope": "ë°§ì¤„",
        "lantern": "ëœí„´",
        "map_fragment": "ì§€ë„ ì¡°ê°"
      },
      "quest": {
        "find_exit": "íƒˆì¶œêµ¬ ì°¾ê¸°",
        "find_exit_desc": "ë¯¸ë¡œë¥¼ íƒí—˜í•˜ê³  ìˆ¨ê²¨ì§„ ì¶œêµ¬ë¥¼ ì°¾ì•„ íƒˆì¶œí•˜ì„¸ìš”",
        "explore_areas": "3ê°œ êµ¬ì—­ íƒí—˜í•˜ê¸°",
        "gather_supplies": "ë³´ê¸‰í’ˆ ìˆ˜ì§‘"
      },
      "rule": {
        "gravity": "ì¤‘ë ¥ ë²•ì¹™",
        "gravity_desc": "ë¬¼ì²´ëŠ” ì•„ë˜ë¡œ ë–¨ì–´ì§‘ë‹ˆë‹¤",
        "darkness": "ì–´ë‘ ì˜ ë²•ì¹™",
        "darkness_desc": "ë¹› ì—†ì´ëŠ” ì•ì„ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
      },
      "scene": {
        "door": "ê³ ëŒ€ì˜ ë¬¸",
        "door_hint": "ì—´ì‡ ê°€ í•„ìš”í•´ ë³´ì¸ë‹¤",
        "mechanism": "ì´ìƒí•œ ì¥ì¹˜",
        "mechanism_hint": "ì‘ë™ì‹œí‚¬ ìˆ˜ ìˆì„ ê²ƒ ê°™ë‹¤",
        "passage": "ìˆ¨ê²¨ì§„ í†µë¡œ",
        "passage_hint": "ì–´ë””ë¡œ ì´ì–´ì§ˆê¹Œ?"
      }
    },
    "tech": {
      "name": "ê¸°ìˆ  ì „ë¬¸ê°€",
      "description": "ì œí•œëœ ìì›ìœ¼ë¡œ íš¨ìœ¨ì ì¸ ì „ëµì„ ì„¸ìš°ì„¸ìš”",
      "welcome": "ì‹œìŠ¤í…œ ë¶€íŒ… ì™„ë£Œ. ì œí•œëœ ì—ë„ˆì§€ë¡œ ìµœì ì˜ ê²½ë¡œë¥¼ ì°¾ì•„ì•¼ í•©ë‹ˆë‹¤...",
      "items": {
        "data_core": "ë°ì´í„° ì½”ì–´",
        "circuit_board": "íšŒë¡œ ê¸°íŒ",
        "energy_cell": "ì—ë„ˆì§€ ì…€",
        "scanner": "ìŠ¤ìºë„ˆ ì¥ì¹˜"
      },
      "quest": {
        "analyze_system": "ì‹œìŠ¤í…œ ë¶„ì„ ì™„ë£Œí•˜ê¸°",
        "analyze_system_desc": "í•µì‹¬ í„°ë¯¸ë„ì— ì ‘ê·¼í•˜ì—¬ ì‹œìŠ¤í…œì˜ êµ¬ì¡°ë¥¼ íŒŒì•…í•˜ì„¸ìš”",
        "optimize_resources": "ìì› íš¨ìœ¨ ìµœì í™”í•˜ê¸°",
        "scan_terminal": "í„°ë¯¸ë„ ìŠ¤ìº” ìˆ˜í–‰í•˜ê¸°"
      },
      "rule": {
        "energy_conservation": "ì—ë„ˆì§€ ë³´ì¡´",
        "energy_conservation_desc": "ì—ë„ˆì§€ëŠ” ìƒì„±ë˜ê±°ë‚˜ ì†Œë©¸ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤",
        "data_integrity": "ë°ì´í„° ë¬´ê²°ì„±",
        "data_integrity_desc": "ì†ìƒëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤",
        "system_limits": "ì‹œìŠ¤í…œ í•œê³„",
        "system_limits_desc": "ë™ì‹œ ì²˜ë¦¬ëŸ‰ì— ì œí•œì´ ìˆìŠµë‹ˆë‹¤"
      },
      "scene": {
        "terminal": "ë©”ì¸ í„°ë¯¸ë„",
        "terminal_hint": "ì‹œìŠ¤í…œì— ì ‘ì†í•  ìˆ˜ ìˆë‹¤",
        "conduit": "ì „ë ¥ ë„ê´€",
        "conduit_hint": "ì—ë„ˆì§€ê°€ íë¥´ê³  ìˆë‹¤"
      }
    }
  },
  "reset": {
    "button": "ë¦¬ì…‹",
    "confirm": "ë‹¤ì‹œ í´ë¦­í•˜ì—¬ í™•ì¸",
    "cancel": "ì·¨ì†Œ",
    "tooltip": "í˜„ì¬ í”„ë¡œí•„ì˜ ì´ˆê¸° ìƒíƒœë¡œ ë˜ëŒë¦½ë‹ˆë‹¤"
  },
  "demo": {
    "items": {
      "keycard-alpha": {
        "name": "í‚¤ì¹´ë“œ A"
      },
      "medkit": {
        "name": "ì‘ê¸‰ í‚¤íŠ¸"
      },
      "flashlight": {
        "name": "ì†ì „ë“±"
      },
      "data-chip": {
        "name": "ë°ì´í„°ì¹©"
      }
    },
    "scene": {
      "terminal": {
        "label": "í„°ë¯¸ë„",
        "hint": "í™œì„±í™”ëœ í„°ë¯¸ë„ì´ë‹¤"
      },
      "door": {
        "label": "ë¬¸",
        "hint": "ì ê²¨ìˆëŠ” ê²ƒ ê°™ë‹¤"
      }
    },
    "quest": {
      "terminal": {
        "label": "í„°ë¯¸ë„ì— ì ‘ì†í•˜ê¸°"
      },
      "escape": {
        "label": "ì‹œì„¤ íƒˆì¶œêµ¬ ì°¾ê¸°"
      },
      "collect": {
        "label": "ë°ì´í„°ì¹© ìˆ˜ì§‘"
      }
    },
    "rule": {
      "gravity": {
        "label": "ì¤‘ë ¥ ë²•ì¹™",
        "description": "ë¬¼ì²´ëŠ” ì•„ë˜ë¡œ ë–¨ì–´ì§„ë‹¤"
      },
      "time": {
        "label": "ì‹œê°„ íë¦„",
        "description": "ì‹œê°„ì€ ì •ìƒ ì†ë„ë¡œ íë¥¸ë‹¤"
      }
    }
  },
  "quest": {
    "empty": "[ ëª©í‘œ ì—†ìŒ ]",
    "completed": "ì™„ë£Œ",
    "section": {
      "active": "ì§„í–‰ ì¤‘",
      "completed": "ì™„ë£Œë¨"
    },
    "main_objective": "ì£¼ ëª©í‘œ",
    "sub_objectives": "ì„¸ë¶€ ëª©í‘œ",
    "progress": "ì§„í–‰ë¥  {{progress}}%",
    "reward_preview": "ë³´ìƒ: {{signal}} Signal",
    "reward_earned": "+{{signal}} Signal íšë“!",
    "objective_complete": "ëª©í‘œ ë‹¬ì„±!",
    "free_exploration": "ììœ  íƒìƒ‰ ì¤‘",
    "free_exploration_desc": "ì •í•´ì§„ ëª©í‘œ ì—†ì´ ì„¸ê³„ë¥¼ ììœ ë¡­ê²Œ íƒí—˜í•˜ì„¸ìš”",
    "no_sub_objectives": "ì„¸ë¶€ ëª©í‘œê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤",
    "tracker_no_objective": "ëª©í‘œ ì—†ìŒ"
  },
  "rule_board": {
    "empty": "[ ê·œì¹™ ì—†ìŒ ]",
    "active_count": "í™œì„± ê·œì¹™: {{count}}ê°œ"
  },
  "mutation": {
    "empty": "[ ë³€í˜• ì´ë ¥ ì—†ìŒ ]",
    "timeline_title": "ë³€í˜• íƒ€ì„ë¼ì¸",
    "event_count": "{{count}}ê°œ ì´ë²¤íŠ¸",
    "more_events": "+{{count}}ê°œ ë” ë³´ê¸°",
    "turn_label": "T{{turn}}",
    "type": {
      "added": "ì¶”ê°€ë¨",
      "modified": "ìˆ˜ì •ë¨",
      "removed": "ì œê±°ë¨"
    }
  },
  "scene": {
    "status": {
      "default": "ë°ì´í„° ëŒ€ê¸° ì¤‘",
      "loading": "ë™ê¸°í™” ì¤‘...",
      "offline": "ì—°ê²° ëŠê¹€",
      "blocked": "ì ‘ê·¼ ì œí•œë¨",
      "low_signal": "ì‹ í˜¸ ì•½í•¨",
      "image_error": "ì¥ë©´ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
      "image_loading": "ì¥ë©´ ì´ë¯¸ì§€ ë¡œë”© ì¤‘...",
      "image_generating": "ìƒˆ ì¥ë©´ ìƒì„± ì¤‘...",
      "initial_sync": "ì „ì—­ ë°ì´í„° ë™ê¸°í™” ëŒ€ê¸° ì¤‘...",
      "syncing": "ë°ì´í„° ë™ê¸°í™” ì¤‘...",
      "alt": "ì¥ë©´ ì´ë¯¸ì§€"
    },
    "processing": {
      "processing": "ì¥ë©´ ìƒì„± ì¤‘...",
      "image_pending": "ì´ë¯¸ì§€ í˜•ì„± ì¤‘...",
      "rendering": "ê²°ê³¼ ì ìš© ì¤‘..."
    },
    "analyzing": {
      "message": "ì¥ë©´ ë¶„ì„ ì¤‘...",
      "hint": "ì˜¤ë¸Œì íŠ¸ë¥¼ íƒìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤"
    },
    "hotspot": {
      "layer_label": "í´ë¦­ ê°€ëŠ¥í•œ ì˜¤ë¸Œì íŠ¸ ì˜ì—­",
      "hint_prefix": "íŒíŠ¸",
      "click_action": "{{label}} í´ë¦­",
      "drop_hint": "ì—¬ê¸°ì— ë“œë¡­í•˜ì—¬ ì‚¬ìš©",
      "drop_action": "{{item}}ì„(ë¥¼) {{target}}ì— ì‚¬ìš©",
      "drop_invalid": "ê·¸ê³³ì—ëŠ” {{item}}ì„(ë¥¼) ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
      "demo_hint": "[ë°ëª¨ ëŒ€ìƒ]"
    }
  },
  "agent": {
    "console": {
      "queue": "ëŒ€ê¸°ì—´",
      "badges": "ê²€ì¦ ë°°ì§€",
      "repair": "ìë™ ë³µêµ¬",
      "status": {
        "idle": "ëŒ€ê¸° ì¤‘",
        "processing": "ì²˜ë¦¬ ì¤‘"
      },
      "badges_empty": "[ ê²€ì¦ ëŒ€ê¸° ì¤‘ ]",
      "repaired": "(ë³µêµ¬ë¨)",
      "phase": {
        "parse": "Parse",
        "validate": "Validate",
        "plan": "Plan",
        "resolve": "Resolve",
        "render": "Render",
        "verify": "Verify",
        "commit": "Commit"
      },
      "badge": {
        "schema": "Schema",
        "economy": "Economy",
        "safety": "Safety",
        "consistency": "Consistency",
        "ok": "OK",
        "fail": "FAIL"
      },
      "model": {
        "fast": "ë¹ ë¦„ (FAST)",
        "quality": "ê³ í’ˆì§ˆ (QUALITY)",
        "cheap": "ì €ë¹„ìš©",
        "ref": "ì°¸ì¡°"
      },
      "expand": "ìƒì„¸ ë³´ê¸°",
      "collapse": "ì ‘ê¸°",
      "queue_idle": "ëŒ€ê¸° ì¤‘..."
    }
  },
  "ui": {
    "logo": "UNKNOWN WORLD",
    "command_placeholder": "ëª…ë ¹ì„ ì…ë ¥í•˜ì„¸ìš”...",
    "processing": "ì²˜ë¦¬ ì¤‘...",
    "execute": "ì‹¤í–‰",
    "wait": "ëŒ€ê¸°",
    "panel_placeholder": "[ ì¤€ë¹„ ì¤‘ ]",
    "scale_decrease": "ê¸€ì í¬ê¸° ì¤„ì´ê¸°",
    "scale_increase": "ê¸€ì í¬ê¸° ëŠ˜ë¦¬ê¸°",
    "scale_label": "UI ìŠ¤ì¼€ì¼ ì„¤ì •",
    "input_locked": "ì²˜ë¦¬ ì¤‘â€¦",
    "input_locked_detail": "í„´ ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ì…ë‹ˆë‹¤"
  },
  "economy": {
    "signal": "Signal",
    "shard": "Shard",
    "signal_cost": "Signal ì†Œëª¨",
    "shard_cost": "Shard ì†Œëª¨",
    "risk_level": "ìœ„í—˜ë„",
    "hud_label": "ì¬í™” í˜„í™©",
    "estimated_cost": "ì˜ˆìƒ ë¹„ìš©",
    "confirmed_cost": "í™•ì • ë¹„ìš©",
    "insufficient_funds": "ì”ì•¡ ë¶€ì¡±",
    "low_balance_warning": "ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤",
    "low_balance_title": "Signal ë¶€ì¡± - ëŒ€ì•ˆ ì•ˆë‚´",
    "credit": "í¬ë ˆë”§",
    "credit_desc": "í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ í¬ë ˆë”§(ë¶€ì±„)ì…ë‹ˆë‹¤. ì¬í™” íšë“ ì‹œ ìš°ì„  ìƒí™˜ë©ë‹ˆë‹¤.",
    "fast_fallback_notice": "ì´ë¯¸ì§€ëŠ” ê¸°ë³¸ í’ˆì§ˆ(FAST)ë¡œ ë¬´ë£Œ ìƒì„±ë©ë‹ˆë‹¤",
    "hint_sell_items": "ì¸ë²¤í† ë¦¬ ì•„ì´í…œì„ íŒë§¤í•˜ì—¬ Signalì„ íšë“í•˜ì„¸ìš”",
    "hint_earn_actions": "ì¬í™” íšë“ ì¹´ë“œ(âš¡)ë¥¼ ì„ íƒí•˜ì„¸ìš”",
    "hint_complete_quests": "ëª©í‘œë¥¼ ë‹¬ì„±í•˜ì—¬ ë³´ìƒì„ ë°›ìœ¼ì„¸ìš”",
    "alternatives_title": "ëŒ€ì•ˆ í–‰ë™",
    "alternative_text_only": "í…ìŠ¤íŠ¸ë§Œ ìƒì„± (ì´ë¯¸ì§€ ì—†ìŒ)",
    "alternative_low_quality": "ì €í’ˆì§ˆ/ë¹ ë¥¸ ì‘ë‹µ ì„ íƒ",
    "ledger_title": "ê±°ë˜ ì¥ë¶€",
    "ledger_empty": "[ ì´ë ¥ ì—†ìŒ ]",
    "model_label": {
      "FAST": "ë¹ ë¦„",
      "QUALITY": "ê³ í’ˆì§ˆ",
      "CHEAP": "ì €ë¹„ìš©",
      "REF": "ì°¸ì¡°"
    },
    "ledger_reason": {
      "turn_cost": "í„´ ì§„í–‰ ë¹„ìš©"
    }
  },
  "connection": {
    "online": "ì˜¨ë¼ì¸",
    "offline": "ì˜¤í”„ë¼ì¸"
  },
  "inventory": {
    "empty": "[ ì•„ì´í…œ ì—†ìŒ ]",
    "empty_hint": "ì¥ë©´ì„ íƒìƒ‰í•˜ì—¬ ì•„ì´í…œì„ ì°¾ìœ¼ì„¸ìš”",
    "count": "Inventory ({{count}})",
    "grid_label": "ì¸ë²¤í† ë¦¬ ì•„ì´í…œ ëª©ë¡",
    "list_label": "ì¸ë²¤í† ë¦¬ ì•„ì´í…œ ëª©ë¡",
    "item_label": "{{name}} (ìˆ˜ëŸ‰: {{quantity}})",
    "drag_hint": "ë“œë˜ê·¸í•˜ì—¬ ì‚¬ìš©",
    "item_consumed": "{{name}} ì‚¬ìš©ë¨",
    "sell_tooltip": "íŒë§¤ (+{{price}} Signal)",
    "sell_aria": "{{item}} íŒë§¤ (+{{price}} Signal)",
    "sell_narrative": "ğŸ’° {{item}}ì„(ë¥¼) íŒë§¤í•˜ì—¬ {{signal}} Signalì„ íšë“í–ˆìŠµë‹ˆë‹¤.",
    "sell_toast": "{{item}} íŒë§¤ ì™„ë£Œ!",
    "sell_ledger_reason": "ì•„ì´í…œ íŒë§¤"
  },
  "interaction": {
    "hotspot_click": "í´ë¦­í•˜ì—¬ ì¡°ì‚¬",
    "item_drag": "ë“œë˜ê·¸í•˜ì—¬ ì‚¬ìš©",
    "drop_here": "ì—¬ê¸°ì— ë†“ê¸°",
    "_u117_removed": "ì˜¨ë³´ë”© ê°€ì´ë“œ í‚¤ ì œê±°ë¨ (U-117)"
  },
  "common": {
    "next": "ë‹¤ìŒ"
  },
  "panel": {
    "inventory": {
      "title": "Inventory",
      "placeholder": "[ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì˜ì—­ ]"
    },
    "quest": {
      "title": "Quest",
      "placeholder": "[ ëª©í‘œ/í€˜ìŠ¤íŠ¸ ëª©ë¡ ]"
    },
    "rule_board": {
      "title": "Rule Board",
      "placeholder": "[ ì›”ë“œ ê·œì¹™/ë³€í˜• íƒ€ì„ë¼ì¸ ]"
    },
    "agent_console": {
      "title": "Agent Console"
    },
    "memory_pin": {
      "title": "Memory Pin",
      "placeholder": "[ ê³ ì •ëœ ê¸°ì–µ/ë‹¨ì„œ ]"
    },
    "scanner": {
      "title": "Scanner",
      "placeholder": "[ ì´ë¯¸ì§€ ì—…ë¡œë“œ ìŠ¬ë¡¯ ]"
    }
  },
  "scanner": {
    "dropzone_label": "ì´ë¯¸ì§€ë¥¼ ë“œë¡­í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ",
    "dropzone_text": "ì´ë¯¸ì§€ë¥¼ ë“œë¡­í•˜ì„¸ìš”",
    "dropzone_hint": "ë˜ëŠ” í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ",
    "upload_label": "ì´ë¯¸ì§€ ì—…ë¡œë“œ",
    "preview_alt": "ì—…ë¡œë“œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°",
    "uploading": "ì—…ë¡œë“œ ì¤‘...",
    "analyzing": "ë¶„ì„ ì¤‘...",
    "retry": "ë‹¤ì‹œ ì‹œë„",
    "cancel": "ì·¨ì†Œ",
    "select_items": "ì¸ë²¤í† ë¦¬ì— ì¶”ê°€í•  ì•„ì´í…œì„ ì„ íƒí•˜ì„¸ìš”",
    "add_to_inventory": "ì¶”ê°€ ({{count}}ê°œ)",
    "detected_objects": "ê°ì§€ëœ ì˜¤ë¸Œì íŠ¸: {{count}}ê°œ",
    "item_candidates": "ì•„ì´í…œ í›„ë³´: {{count}}ê°œ",
    "no_candidates": "ì•„ì´í…œ í›„ë³´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤",
    "discovery_message": {
      "one": "ì•„ì´í…œì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤!",
      "two": "ë‘ ê°€ì§€ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤!",
      "three": "ì„¸ ê°€ì§€ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤! ëŒ€ë‹¨í•œ ë°œê²¬ì´ë„¤ìš”!"
    },
    "error": {
      "unsupported_format": "ì§€ì›í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ í˜•ì‹ì…ë‹ˆë‹¤",
      "file_too_large": "íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤ (ìµœëŒ€ 20MB)",
      "unknown": "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤"
    },
    "item_type": {
      "key": "ì—´ì‡ ",
      "weapon": "ë¬´ê¸°",
      "tool": "ë„êµ¬",
      "clue": "ë‹¨ì„œ",
      "material": "ì¬ë£Œ",
      "consumable": "ì†Œëª¨í’ˆ",
      "document": "ë¬¸ì„œ",
      "artifact": "ìœ ë¬¼"
    },
    "tooltip": {
      "title": "ìŠ¤ìºë„ˆ",
      "description": "í˜„ì‹¤ì˜ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ë©´ ê²Œì„ ì† ì•„ì´í…œì´ë‚˜ ë‹¨ì„œë¡œ ë³€í™˜ë©ë‹ˆë‹¤"
    },
    "affordance": {
      "idle_hint": "ì´ë¯¸ì§€ â†’ ì•„ì´í…œ",
      "drag_active": "ì—¬ê¸°ì— ë†“ìœ¼ì„¸ìš”!"
    }
  },
  "action": {
    "default": {
      "explore": {
        "label": "íƒìƒ‰í•˜ê¸°",
        "description": "ì£¼ë³€ì„ ì‚´í´ë³¸ë‹¤"
      },
      "investigate": {
        "label": "ì¡°ì‚¬í•˜ê¸°",
        "description": "ìì„¸íˆ ì‚´í´ë³¸ë‹¤"
      },
      "talk": {
        "label": "ëŒ€í™”í•˜ê¸°",
        "description": "ë§ì„ ê±¸ì–´ë³¸ë‹¤"
      }
    },
    "card_select": "ì¹´ë“œ ì„ íƒ: {{cardId}}",
    "deck_label": "í–‰ë™ ì„ íƒ ì¹´ë“œ",
    "alternative": "ëŒ€ì•ˆ",
    "insufficient_balance": "ì”ì•¡ ë¶€ì¡±",
    "server_disabled": "ì‚¬ìš© ë¶ˆê°€",
    "vision_badge": "ì •ë°€ë¶„ì„",
    "earn_badge": "Signal íšë“",
    "all_disabled_notice": "ì‹¤í–‰ ê°€ëŠ¥í•œ í–‰ë™ì´ ì—†ìŠµë‹ˆë‹¤. ëŒ€ì•ˆì„ í™•ì¸í•˜ì„¸ìš”.",
    "risk": {
      "low": "ë‚®ìŒ",
      "medium": "ë³´í†µ",
      "high": "ë†’ìŒ"
    },
    "cost_range": "{{min}}~{{max}}"
  },
  "narrative": {
    "welcome": "ë¯¸ì§€ì˜ ì„¸ê³„ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤...",
    "turn_label": "[TURN {{turn}}]",
    "streaming_label": "[STREAMING]",
    "fast_forward_title": "í´ë¦­í•˜ì—¬ ë¹ ë¥´ê²Œ ë„˜ê¸°ê¸°",
    "fast_forward_aria": "í´ë¦­í•˜ê±°ë‚˜ Enter/Spaceë¥¼ ëˆŒëŸ¬ í…ìŠ¤íŠ¸ë¥¼ ì¦‰ì‹œ í‘œì‹œí•©ë‹ˆë‹¤",
    "image_pending_label": "ì´ë¯¸ì§€ í˜•ì„± ì¤‘â€¦"
  },
  "action_log": {
    "use_item_on_hotspot": "í–‰ë™ ì‹¤í–‰: {{item}}ì„(ë¥¼) {{hotspot}}ì— ì‚¬ìš©í•œë‹¤",
    "click_hotspot": "í–‰ë™ ì‹¤í–‰: {{hotspot}}ì„(ë¥¼) ì¡°ì‚¬í•œë‹¤",
    "click_action": "í–‰ë™ ì‹¤í–‰: {{action}}"
  }
}
</file>

<file path="frontend/src/style.css">
/**
 * Unknown World - CRT í…Œë§ˆ ìŠ¤íƒ€ì¼ì‹œíŠ¸ (ë‹¨ì¼ CSS SSOT)
 *
 * RULE-002 ì¤€ìˆ˜: ì±„íŒ… ë²„ë¸” UI ê¸ˆì§€ - ê²Œì„ ë¡œê·¸/HUD í˜•íƒœë§Œ í—ˆìš©
 * Frontend Style Guide ì¤€ìˆ˜: CRT í„°ë¯¸ë„ ë ˆíŠ¸ë¡œ ë¯¸í•™
 *
 * @see vibe/ref/frontend-style-guide.md
 */

/* ============================================
   1. CRT í…Œë§ˆ í† í° (CSS Variables)
   ============================================ */
:root {
  color-scheme: dark; /* U-049: ì‹œìŠ¤í…œ ë¸Œë¼ìš°ì € ìš”ì†Œ(ìŠ¤í¬ë¡¤ë°” ë“±)ë¥¼ ë‹¤í¬ ëª¨ë“œë¡œ ê°•ì œ */
  /* ê¸°ë³¸ ìƒ‰ìƒ - CRT ì¸ê´‘ ë…¹ìƒ‰ í…Œë§ˆ */
  --bg-color: #0d0d0d; /* ë°°ê²½: ê±°ì˜ ìˆœìˆ˜í•œ ê²€ì • */
  --text-color: #33ff00; /* ì£¼ í…ìŠ¤íŠ¸: ì¸ê´‘ ë…¹ìƒ‰ (CRT ê·¸ë¦°) */
  --text-dim: #22a000; /* ë³´ì¡° í…ìŠ¤íŠ¸: ì•½ê°„ ë” ë°ê²Œ í•˜ì—¬ ê°€ë…ì„± í–¥ìƒ (U-049) */
  --accent-color: #ff00ff; /* ê°•ì¡°ìƒ‰: ë§ˆì  íƒ€ */
  --border-color: #33ff00; /* í…Œë‘ë¦¬: ì¸ê´‘ ë…¹ìƒ‰ */
  --panel-bg: rgba(0, 15, 0, 0.7); /* íŒ¨ë„ ë°°ê²½: ëŒ€ë¹„ í–¥ìƒì„ ìœ„í•´ ë¶ˆíˆ¬ëª…ë„ ì¦ê°€ (U-049) */
  --warning-color: #ffaa00; /* ê²½ê³ : ì£¼í™©ìƒ‰ */
  --error-color: #ff3333; /* ì—ëŸ¬: ë¶‰ì€ìƒ‰ */

  /* CRT íš¨ê³¼ */
  --crt-scanline: rgba(18, 16, 16, 0.1);
  --crt-flicker: 0.03;
  --glow-intensity: 5px;
  --crt-flicker-opacity-min: 0.97;
  --crt-flicker-opacity-max: 1;

  /* íƒ€ì´í¬ê·¸ë˜í”¼ */
  --font-main: 'NeoDunggeunmo', 'VT323', monospace;
  --font-micro-en:
    'Share Tech Mono', 'Consolas', monospace; /* U-037: ì˜ë¬¸ ë§ˆì´í¬ë¡œ í…ìŠ¤íŠ¸ ê°€ë…ì„± */
  --font-size-base: 16px;
  --font-size-lg: 1.2rem;
  --font-size-xl: 1.5rem;
  --font-size-2xl: 2rem;
  --line-height-base: 1.5;

  /* ë§ˆì´í¬ë¡œ í…ìŠ¤íŠ¸ (U-049: ê°€ë…ì„±ì„ ìœ„í•´ ìµœì†Œ í¬ê¸° ìƒí–¥) */
  --font-size-xs: 0.8125rem; /* 13px at 1.0 scale - ìµœì†Œ ë§ˆì´í¬ë¡œ í…ìŠ¤íŠ¸ */
  --font-size-sm: 0.9375rem; /* 15px at 1.0 scale - ì‘ì€ í…ìŠ¤íŠ¸ */

  /* UI ìŠ¤ì¼€ì¼ (U-028: ì „ì—­ ìŠ¤ì¼€ì¼ ì¡°ì ˆ) */
  --ui-scale-factor: 1;

  /* ë ˆì´ì•„ì›ƒ - ê¸°ë³¸ ìŠ¤í˜ì´ì‹± */
  --spacing-xs: 4px;
  --spacing-sm: 8px;
  --spacing-md: 16px;
  --spacing-lg: 24px;
  --spacing-xl: 32px;
  --border-radius: 4px;

  /* U-073: ë ˆì´ì•„ì›ƒ í™•ì¥ - ì¢Œìš° ë¹ˆê³µê°„ í™œìš©
   * Q1: 1800px (ì™€ì´ë“œ, ì¢Œìš° íŒ¨ë„ ì¶©ë¶„íˆ ë„“ê²Œ)
   * Q3 Option B: ì¥ì‹ìš© íŒ¨í„´/í…ìŠ¤ì²˜ (ê²Œì„ í…Œë§ˆ ê°•í™”)
   * ì‚¬ì´ë“œ íŒ¨ë„ì€ minmaxë¡œ ìœ ì—°í•˜ê²Œ ì¡°ì ˆ */
  --layout-max-width: 1800px;
  --layout-side-panel-min: 280px;
  --layout-side-panel-max: 380px;
  --layout-center-min: 400px;
  --layout-gap: var(--spacing-sm);

  /* ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
  --header-height: 60px;
  --footer-height: 140px; /* U-050 v6: ì»´íŒ©íŠ¸ ì¹´ë“œì— ë§ì¶° ë†’ì´ ì¡°ì • */

  /* ===========================================
     U-058: í•«ìŠ¤íŒŸ ë””ìì¸ í† í° (Magenta ê³„ì—´)
     - Q1 Option C: Magenta/Purple ê³„ì—´
     - Q2 Option A: Lì ë¸Œë¼ì¼“ ìŠ¤íƒ€ì¼
     =========================================== */
  --hotspot-primary: #e040fb; /* ë°ì€ ë§ˆì  íƒ€ (ê¸°ë³¸) */
  --hotspot-primary-dim: #9c27b0; /* ì–´ë‘ìš´ í¼í”Œ (ë¹„í™œì„±) */
  --hotspot-hover: #f06292; /* í•‘í¬ (í˜¸ë²„) */
  --hotspot-active: #ff4081; /* ë°ì€ í•‘í¬ (í´ë¦­/í™œì„±) */
  --hotspot-drop: #ffab40; /* ì•°ë²„ (ë“œë¡­ íƒ€ê²Ÿ) */
  --hotspot-glow: rgba(224, 64, 251, 0.4); /* ê¸€ë¡œìš°ìš© íˆ¬ëª… ë§ˆì  íƒ€ */
  --hotspot-bg: rgba(224, 64, 251, 0.06); /* ë°°ê²½ìš© ë¯¸ì„¸ í‹´íŠ¸ */

  /* ì½”ë„ˆ ë§ˆì»¤ í¬ê¸° */
  --hotspot-corner-size: 12px;
  --hotspot-corner-thickness: 2px;
  --hotspot-stroke-width: 1px;
}

/* ============================================
   2. í°íŠ¸ ì •ì˜
   ============================================ */
@font-face {
  font-family: 'NeoDunggeunmo';
  src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.3/NeoDunggeunmo.woff')
    format('woff');
  font-weight: normal;
  font-display: swap;
}

/* ============================================
   3. Reset & Base
   ============================================ */
*,
*::before,
*::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html {
  /* U-028: UI ìŠ¤ì¼€ì¼ ì ìš© - font-sizeê°€ ìŠ¤ì¼€ì¼ íŒ©í„°ì— ë°˜ì‘ */
  font-size: calc(var(--font-size-base) * var(--ui-scale-factor));
  line-height: var(--line-height-base);
}

html,
body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background-color: var(--bg-color);
  color: var(--text-color);
  /* U-049: í‘œì¤€ ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ (Firefox ë“±) */
  scrollbar-width: thin;
  scrollbar-color: rgba(51, 255, 0, 0.3) var(--bg-color);
}

body {
  font-family: var(--font-main);
  min-height: 100vh;
  overflow: hidden;
  /* U-057: ê¸°ë³¸ ê¸€ë¡œìš° ì™„í™” - ë¶„ìœ„ê¸° ìœ ì§€í•˜ë©´ì„œ ê°€ë…ì„± ê°œì„  */
  /* ê¸°ì¡´: 0 0 5px (glow-intensity) â†’ ì™„í™”: 0 0 2px */
  text-shadow:
    0 0 1px rgba(0, 0, 0, 0.8),
    0 0 2px var(--text-dim);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;

  /* U-073 Q3 Option B: ì¥ì‹ìš© íŒ¨í„´/í…ìŠ¤ì²˜ (ê²Œì„ í…Œë§ˆ ê°•í™”)
   * - ì¢Œìš° ë¹ˆê³µê°„ì— CRT ê·¸ë¦¬ë“œ íŒ¨í„´ í‘œì‹œ
   * - ê²Œì„ ì»¨í…Œì´ë„ˆ ì™¸ë¶€ ì˜ì—­ì—ë§Œ ë³´ì„ */
  background-image:
    /* ìˆ˜ì§ ìŠ¤ìº”ë¼ì¸ */
    repeating-linear-gradient(
      90deg,
      transparent,
      transparent 2px,
      rgba(51, 255, 0, 0.015) 2px,
      rgba(51, 255, 0, 0.015) 4px
    ),
    /* ìˆ˜í‰ ìŠ¤ìº”ë¼ì¸ */
    repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(51, 255, 0, 0.02) 2px,
        rgba(51, 255, 0, 0.02) 4px
      ),
    /* ë¯¸ì„¸í•œ ê·¸ë¦¬ë“œ ë„íŠ¸ íŒ¨í„´ */
    radial-gradient(circle at center, rgba(51, 255, 0, 0.03) 1px, transparent 1px);
  background-size:
    4px 100%,
    100% 4px,
    20px 20px;
  background-position:
    0 0,
    0 0,
    10px 10px;
}

#root {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* ============================================
   4. CRT ì˜¤ë²„ë ˆì´ íš¨ê³¼
   ============================================ */

/* ìŠ¤ìº”ë¼ì¸ ì˜¤ë²„ë ˆì´ - U-050 v6: ìŠ¤ìº”ë¼ì¸ ê°•ë„ ì™„í™” */
.crt-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  /* ìŠ¤ìº”ë¼ì¸: ì ë‹¹íˆ (0.35) - ë¶„ìœ„ê¸°ì™€ ê°€ë…ì„± ê· í˜• */
  background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.35) 50%);
  background-size: 100% 2px;
  pointer-events: none;
  z-index: 9999;
  /* í”Œë¦¬ì»¤: ëŠë¦¬ê²Œ (0.5s), ë¯¸ì„¸í•œ ë³€í™”ë§Œ */
  animation: flicker 0.5s infinite;
}

/* 
 * U-037: ì¤‘ìš”ë„ ê¸°ë°˜ ë ˆì´ì–´ë§
 * - Critical: ì˜¤ë²„ë ˆì´(9999) ìœ„ë¡œ ëš«ê³  ì˜¬ë¼ì™€ ì„ ëª…í•˜ê²Œ í‘œì‹œ
 * - Ambient: ì˜¤ë²„ë ˆì´ ì•„ë˜ì— ìœ„ì¹˜í•˜ì—¬ CRT ë¶„ìœ„ê¸° ì ìš©
 */

/* Critical ë³´í˜¸ ë ˆì´ì–´ (ì˜¤ë²„ë ˆì´ ìœ„) */
[data-ui-importance='critical'],
.ui-critical,
.phase-item,
.currency-value,
.action-card-cost,
.agent-error {
  position: relative;
  z-index: 10000;
}

/* Ambient ë¶„ìœ„ê¸° ë ˆì´ì–´ (ì˜¤ë²„ë ˆì´ ì•„ë˜) */
.game-title,
.panel-header,
.action-card-title {
  position: relative;
  z-index: 1; /* 9999 ì˜¤ë²„ë ˆì´ë³´ë‹¤ ì•„ë˜ */
}

#root {
  min-height: 100vh;
}

/* í”Œë¦¬ì»¤(ê¹œë¹¡ì„) ì• ë‹ˆë©”ì´ì…˜ - U-050 v5: ë¯¸ì„¸í•œ ê¹œë¹¡ì„ */
@keyframes flicker {
  0%,
  100% {
    opacity: 0.95;
  }
  25% {
    opacity: 1;
  }
  50% {
    opacity: 0.97;
  }
  75% {
    opacity: 0.99;
  }
}

/* ê¸€ë¦¬ì¹˜ íš¨ê³¼ (íƒ€ì´í‹€ìš©) */
.glitch {
  position: relative;
}

.glitch::before,
.glitch::after {
  content: attr(data-text);
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

.glitch::before {
  left: 2px;
  text-shadow: -1px 0 #ff0000;
  clip-path: inset(0 0 0 0);
  animation: glitch-anim-1 5s infinite linear alternate-reverse;
}

.glitch::after {
  left: -2px;
  text-shadow: -1px 0 #0000ff;
  clip-path: inset(0 0 0 0);
  animation: glitch-anim-2 5s infinite linear alternate-reverse;
}

@keyframes glitch-anim-1 {
  0%,
  100% {
    clip-path: inset(0 0 95% 0);
  }
  20% {
    clip-path: inset(30% 0 50% 0);
  }
  40% {
    clip-path: inset(10% 0 70% 0);
  }
  60% {
    clip-path: inset(80% 0 5% 0);
  }
  80% {
    clip-path: inset(45% 0 35% 0);
  }
}

@keyframes glitch-anim-2 {
  0%,
  100% {
    clip-path: inset(95% 0 0 0);
  }
  20% {
    clip-path: inset(50% 0 30% 0);
  }
  40% {
    clip-path: inset(70% 0 10% 0);
  }
  60% {
    clip-path: inset(5% 0 80% 0);
  }
  80% {
    clip-path: inset(35% 0 45% 0);
  }
}

/* ============================================
   5. ê²Œì„ ë ˆì´ì•„ì›ƒ (CSS Grid)
   - RULE-002: ì±„íŒ… UIê°€ ì•„ë‹Œ ê²Œì„ UI ê³ ì •
   ============================================ */

.game-container {
  display: grid;
  grid-template-areas:
    'header header header'
    'sidebar-left center sidebar-right'
    'footer footer footer';
  /* U-073: minmax ê¸°ë°˜ ìœ ì—°í•œ ì‚¬ì´ë“œ íŒ¨ë„ ë„ˆë¹„
   * - ì‚¬ì´ë“œ íŒ¨ë„: ìµœì†Œ~ìµœëŒ€ ë²”ìœ„ ë‚´ì—ì„œ ìë™ ì¡°ì ˆ
   * - ì¤‘ì•™: ë‚¨ì€ ê³µê°„ í™œìš© (ìµœì†Œ 400px ë³´ì¥)
   * Q1 Option A: 1600px max-width */
  grid-template-columns:
    minmax(var(--layout-side-panel-min), var(--layout-side-panel-max))
    minmax(var(--layout-center-min), 1fr)
    minmax(var(--layout-side-panel-min), var(--layout-side-panel-max));
  grid-template-rows: var(--header-height) 1fr var(--footer-height);
  /* U-049: ìŠ¤í¬ë¡¤ ë°©ì§€ - dvh ì‚¬ìš© ë° overflow ì œì–´ */
  height: 100dvh;
  height: 100vh; /* dvh ë¯¸ì§€ì› ë¸Œë¼ìš°ì € í´ë°± */
  max-height: 100dvh;
  max-height: 100vh;
  width: 100%;
  /* U-073: 1600px max-width + ì¤‘ì•™ ì •ë ¬ */
  max-width: var(--layout-max-width);
  margin: 0 auto;
  padding: var(--layout-gap);
  gap: var(--layout-gap);
  overflow: hidden; /* U-049: ì˜ë„ì¹˜ ì•Šì€ ìŠ¤í¬ë¡¤ ë°©ì§€ */
  /* U-073: ê²Œì„ ì˜ì—­ ë°°ê²½ - ì¢Œìš° íŒ¨í„´ì´ ê²Œì„ ë‚´ë¶€ì— ì¹¨ë²”í•˜ì§€ ì•Šë„ë¡ */
  background-color: var(--bg-color);
}

/* ============================================
   6. Header ì˜ì—­
   - Title, Language Toggle, Theme Toggle,
     Connection Status, Economy HUD
   ============================================ */

.game-header {
  grid-area: header;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 var(--spacing-md);
  border: 1px solid var(--border-color);
  background-color: var(--panel-bg);
  box-shadow:
    inset 0 0 20px rgba(0, 0, 0, 0.5),
    0 0 10px var(--text-dim);
}

.game-title {
  font-size: var(--font-size-2xl);
  color: var(--text-color);
  text-transform: uppercase;
  letter-spacing: 4px;
}

.header-controls {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
}

.economy-hud {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-xs) var(--spacing-sm);
  border: 1px solid var(--text-dim);
  background-color: rgba(0, 0, 0, 0.5);
}

.economy-hud .signal-icon {
  color: var(--accent-color);
}

.connection-status {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  font-size: 0.875rem;
}

.status-indicator {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background-color: var(--text-color);
  box-shadow: 0 0 6px var(--text-color);
  animation: pulse 2s infinite;
}

.status-indicator.offline {
  background-color: var(--error-color);
  box-shadow: 0 0 6px var(--error-color);
  animation: none;
}

@keyframes pulse {
  0%,
  100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

/* ============================================
   7. Sidebar (Left) ì˜ì—­
   - Inventory, Quest/Objective, Rule Board
   - U-049: ì»¬ëŸ¼ ì „ì²´ ìŠ¤í¬ë¡¤ ì œê±°, íŒ¨ë„ ì½˜í…ì¸  ë‹¨ìœ„ ìŠ¤í¬ë¡¤
   ============================================ */

.sidebar-left {
  grid-area: sidebar-left;
  display: flex;
  flex-direction: column;
  gap: var(--layout-gap); /* U-073: ë ˆì´ì•„ì›ƒ ê°­ í†µì¼ */
  min-height: 0; /* U-049: flex ìì‹ ì¶•ì†Œ í—ˆìš© */
  overflow: hidden; /* U-049: ì»¬ëŸ¼ ì „ì²´ ìŠ¤í¬ë¡¤ ì œê±° */
}

/* ============================================
   8. Center ì˜ì—­
   - Scene Canvas, Narrative Feed (ë¡œê·¸ í˜•íƒœ)
   ============================================ */

.game-center {
  grid-area: center;
  display: flex;
  flex-direction: column;
  gap: var(--layout-gap); /* U-073: ë ˆì´ì•„ì›ƒ ê°­ í†µì¼ */
  overflow: hidden;
}

.scene-canvas {
  /* U-073: 4:3 ë¹„ìœ¨ Scene Canvas - ë¡œê·¸ì°½ ê³µê°„ í™•ë³´ */
  flex: 0 0 auto;
  aspect-ratio: 4 / 3;
  width: 100%;
  /* NarrativeFeed ì¶©ë¶„í•œ ê³µê°„ í™•ë³´ */
  max-height: calc(100vh - var(--header-height) - var(--footer-height) - 250px);
  border: 1px solid var(--border-color);
  background-color: var(--panel-bg);
  box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  min-height: 200px;
  overflow: hidden; /* ë‚´ë¶€ ì´ë¯¸ì§€ ë„˜ì¹¨ ë°©ì§€ */
}

/* U-020: Scene Image ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
.scene-image-container {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
}

.scene-placeholder {
  color: var(--text-color);
  font-size: var(--font-size-lg);
  text-align: center;
  background-color: rgba(0, 0, 0, 0.6);
  padding: var(--spacing-md);
  border: 1px solid var(--text-dim);
  /* U-057: ê¸€ë¡œìš° ì™„í™” (10px â†’ 3px) */
  text-shadow: 0 0 3px rgba(51, 255, 0, 0.4);
  -webkit-font-smoothing: antialiased;
}

/* U-031: Scene Canvas ìƒíƒœë³„ placeholder ìŠ¤íƒ€ì¼ */
.scene-status-label {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-sm);
  font-size: var(--font-size-lg);
  text-transform: uppercase;
  letter-spacing: 2px;
}

.scene-status-emoji {
  font-size: 1.5em;
}

.scene-status-message {
  margin-top: var(--spacing-xs);
  font-size: var(--font-size-sm);
}

/* ìƒíƒœë³„ ë°°ê²½ ì´ë¯¸ì§€ ì ìš© (containerë¡œ ì´ë™) */
.scene-image-container.scene-status-loading,
.scene-image-container.scene-status-offline,
.scene-image-container.scene-status-blocked,
.scene-image-container.scene-status-low_signal,
.scene-image-container.scene-status-default {
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
}

/* ë¡œë”© ìƒíƒœ: í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ */
.scene-image-container.scene-status-loading .scene-placeholder {
  animation: loading-pulse 2s ease-in-out infinite;
}

@keyframes loading-pulse {
  0%,
  100% {
    opacity: 0.7;
  }
  50% {
    opacity: 1;
  }
}

/* ì˜¤í”„ë¼ì¸ ìƒíƒœ: ì •ì  ë…¸ì´ì¦ˆ íš¨ê³¼ */
.scene-image-container.scene-status-offline {
  position: relative;
}

.scene-image-container.scene-status-offline::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: repeating-linear-gradient(
    0deg,
    transparent,
    transparent 2px,
    rgba(0, 0, 0, 0.1) 2px,
    rgba(0, 0, 0, 0.1) 4px
  );
  pointer-events: none;
  animation: static-noise 0.5s steps(5) infinite;
}

@keyframes static-noise {
  0%,
  100% {
    opacity: 0.3;
  }
  50% {
    opacity: 0.5;
  }
}

/* ì°¨ë‹¨ ìƒíƒœ: ê²½ê³ ìƒ‰ í…Œë‘ë¦¬ */
.scene-image-container.scene-status-blocked {
  border-color: var(--warning-color);
  box-shadow: inset 0 0 30px rgba(255, 170, 0, 0.2);
}

.scene-image-container.scene-status-blocked .scene-status-label {
  color: var(--warning-color);
}

/* ì €ì‹ í˜¸ ìƒíƒœ: í¬ë¯¸í•œ í‘œì‹œ */
.scene-image-container.scene-status-low_signal .scene-placeholder {
  opacity: 0.8;
}

.scene-image-container.scene-status-low_signal .scene-status-label {
  color: var(--text-dim);
}

/* ì •ìƒ ì¥ë©´ í‘œì‹œ */
.scene-image-container.scene-active {
  background-color: transparent;
}

.scene-image-container .scene-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  /* U-020: í˜ì´ë“œ ì¸ íš¨ê³¼ */
  opacity: 0;
  transition: opacity 0.3s ease-in-out;
}

/* U-020: ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ í‘œì‹œ */
.scene-image-container .scene-image.scene-image-loaded {
  opacity: 1;
}

/* ============================================
   8.0.1 ì´ë¯¸ì§€ ë¡œë”© ì¸ë””ì¼€ì´í„° (U-020)
   - RULE-008: í…ìŠ¤íŠ¸ ìš°ì„  + Lazy ì´ë¯¸ì§€ ì •ì±…
   - Q1 Option A: ì´ì „ ì´ë¯¸ì§€ ìœ ì§€ + ë¡œë”© ìƒíƒœ í‘œì‹œ
   ============================================ */

/* ë¡œë”© ì¸ë””ì¼€ì´í„° ì»¨í…Œì´ë„ˆ */
.scene-loading-indicator {
  position: absolute;
  bottom: var(--spacing-md);
  right: var(--spacing-md);
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  padding: var(--spacing-xs) var(--spacing-sm);
  background-color: rgba(0, 20, 0, 0.9);
  border: 1px solid var(--accent-color);
  border-radius: 2px;
  z-index: 15;
  animation: loading-fade-in 0.2s ease-out;
}

@keyframes loading-fade-in {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* ë¡œë”© ìŠ¤í”¼ë„ˆ */
.scene-loading-spinner {
  width: 14px;
  height: 14px;
  border: 2px solid var(--text-dim);
  border-top-color: var(--accent-color);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

/* ë¡œë”© í…ìŠ¤íŠ¸ */
.scene-loading-text {
  font-size: var(--font-size-xs);
  color: var(--accent-color);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* ì´ë¯¸ì§€ ë¡œë”© ì¤‘ ìº”ë²„ìŠ¤ ìƒíƒœ */
.scene-image-container.image-loading {
  /* ì•½ê°„ì˜ ì‹œê°ì  íŒíŠ¸ */
}

.scene-image-container.image-loading::before {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 3px;
  background: linear-gradient(90deg, transparent 0%, var(--accent-color) 50%, transparent 100%);
  animation: loading-bar 1.5s ease-in-out infinite;
  z-index: 20;
}

@keyframes loading-bar {
  0% {
    transform: translateX(-100%);
  }
  100% {
    transform: translateX(100%);
  }
}

/* ============================================
   8.0.2 ì²˜ë¦¬ ì¤‘ ì˜¤ë²„ë ˆì´ (U-071)
   - Scene Canvas ì¤‘ì•™ì— CRT í…Œë§ˆ ë¡œë”© ì¸ë””ì¼€ì´í„°
   - ì²˜ë¦¬ ë‹¨ê³„ë³„ ë©”ì‹œì§€ í‘œì‹œ (processing, image_pending)
   - prefers-reduced-motion ì§€ì›
   ============================================ */

/* ì²˜ë¦¬ ì¤‘ ì»¨í…Œì´ë„ˆ ìƒíƒœ */
.scene-image-container.scene-processing {
  /* ë°°ê²½ì„ placeholder ì´ë¯¸ì§€ë¡œ ëŒ€ì²´ (Option C) */
  background-color: rgba(0, 10, 0, 0.9);
}

/* ì²˜ë¦¬ ì¤‘ ì˜¤ë²„ë ˆì´ (ì¤‘ì•™ ë°°ì¹˜) */
.scene-processing-overlay {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-md);
  background: radial-gradient(
    ellipse at center,
    rgba(0, 30, 0, 0.95) 0%,
    rgba(0, 10, 0, 0.98) 100%
  );
  z-index: 25;
  animation: processing-fade-in 0.3s ease-out;
}

@keyframes processing-fade-in {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* CRT í…Œë§ˆ ìŠ¤í”¼ë„ˆ */
.scene-processing-spinner {
  position: relative;
  width: 64px;
  height: 64px;
}

.scene-processing-spinner .spinner-ring {
  position: absolute;
  border-radius: 50%;
  border: 2px solid transparent;
}

.scene-processing-spinner .spinner-ring-outer {
  inset: 0;
  border-top-color: var(--text-color);
  border-right-color: var(--text-color);
  animation: spin-outer 1.5s linear infinite;
  box-shadow: 0 0 10px var(--text-color);
}

.scene-processing-spinner .spinner-ring-inner {
  inset: 8px;
  border-bottom-color: var(--accent-color);
  border-left-color: var(--accent-color);
  animation: spin-inner 1s linear infinite reverse;
  box-shadow: 0 0 8px var(--accent-color);
}

.scene-processing-spinner .spinner-glow {
  position: absolute;
  inset: 16px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(51, 255, 0, 0.15) 0%, transparent 70%);
  animation: glow-pulse 2s ease-in-out infinite;
}

@keyframes spin-outer {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@keyframes spin-inner {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@keyframes glow-pulse {
  0%,
  100% {
    opacity: 0.5;
    transform: scale(1);
  }
  50% {
    opacity: 1;
    transform: scale(1.1);
  }
}

/* ì²˜ë¦¬ ë‹¨ê³„ ë©”ì‹œì§€ í…ìŠ¤íŠ¸ */
.scene-processing-text {
  font-size: var(--font-size-lg);
  color: var(--text-color);
  text-transform: uppercase;
  letter-spacing: 3px;
  text-shadow: 0 0 10px var(--text-color);
  animation: text-flicker 3s ease-in-out infinite;
}

@keyframes text-flicker {
  0%,
  100% {
    opacity: 1;
  }
  50% {
    opacity: 0.8;
  }
  75% {
    opacity: 0.95;
  }
}

/* CRT ìŠ¤ìº”ë¼ì¸ íš¨ê³¼ (ì˜¤ë²„ë ˆì´ ë‚´ë¶€) */
.scene-processing-scanlines {
  position: absolute;
  inset: 0;
  background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
  background-size: 100% 4px;
  pointer-events: none;
  animation: scanline-scroll 8s linear infinite;
  opacity: 0.6;
}

@keyframes scanline-scroll {
  from {
    background-position: 0 0;
  }
  to {
    background-position: 0 100%;
  }
}

/* U-066: ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì¸ë””ì¼€ì´í„° - processingê³¼ ë™ì¼ ìŠ¤íƒ€ì¼ ì ìš© */
.scene-generating-indicator {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-md);
  background: radial-gradient(ellipse at center, rgba(0, 30, 0, 0.9) 0%, rgba(0, 10, 0, 0.95) 100%);
  z-index: 20;
}

.scene-generating-spinner {
  width: 48px;
  height: 48px;
  border: 3px solid var(--text-dim);
  border-top-color: var(--accent-color);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  box-shadow: 0 0 15px var(--accent-color);
}

.scene-generating-text {
  font-size: var(--font-size-sm);
  color: var(--accent-color);
  text-transform: uppercase;
  letter-spacing: 2px;
  text-shadow: 0 0 8px var(--accent-color);
}

/* ============================================
   U-089: ì •ë°€ë¶„ì„(Agentic Vision) ì „ìš© ì˜¤ë²„ë ˆì´
   Q1: Option A - ìŠ¤ìº”ë¼ì¸ ìŠ¤ìœ•(ìœ„â†’ì•„ë˜) + ì‹œì•ˆ ê¸€ë¡œìš° ë¼ë²¨
   Q2: Option B - opacity 0.5 + ì‹œì•ˆ í‹´íŠ¸
   ============================================ */

/* ë¶„ì„ ëª¨ë“œ - ê¸°ì¡´ ì´ë¯¸ì§€ ì–´ë‘¡ê²Œ ì²˜ë¦¬ (opacity 0.5 + cyan tint) */
.scene-image-container.scene-analyzing .scene-image {
  opacity: 0.5;
  filter: brightness(0.7) saturate(0.6);
  transition:
    opacity 0.3s ease,
    filter 0.3s ease;
}

/* ë¶„ì„ ì™„ë£Œ í›„ ì´ë¯¸ì§€ ì›ë³µ */
.scene-image-container:not(.scene-analyzing) .scene-image {
  transition:
    opacity 0.3s ease,
    filter 0.3s ease;
}

/* ë¶„ì„ ì „ìš© ì˜¤ë²„ë ˆì´ ì»¨í…Œì´ë„ˆ */
.scene-analyzing-overlay {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-sm);
  /* ì‹œì•ˆ í‹´íŠ¸ ë°°ê²½ */
  background: rgba(0, 255, 255, 0.05);
  z-index: 15;
  pointer-events: none;
  animation: analyzing-overlay-in 0.3s ease-out;
}

@keyframes analyzing-overlay-in {
  from {
    opacity: 0;
    background: rgba(0, 255, 255, 0);
  }
  to {
    opacity: 1;
    background: rgba(0, 255, 255, 0.05);
  }
}

/* ìŠ¤ìº”ë¼ì¸ ìŠ¤ìœ• íš¨ê³¼ (ìœ„â†’ì•„ë˜ ë°˜ë³µ) */
.scene-analyzing-scanline {
  position: absolute;
  inset: 0;
  overflow: hidden;
  pointer-events: none;
}

.scene-analyzing-scanline::before {
  content: '';
  position: absolute;
  width: 100%;
  height: 4px;
  background: linear-gradient(
    transparent,
    rgba(0, 255, 255, 0.3),
    rgba(0, 255, 255, 0.7),
    rgba(0, 255, 255, 0.3),
    transparent
  );
  box-shadow:
    0 0 20px rgba(0, 255, 255, 0.4),
    0 0 60px rgba(0, 255, 255, 0.15);
  animation: analyzing-sweep 2.5s ease-in-out infinite;
}

@keyframes analyzing-sweep {
  0% {
    top: -5%;
  }
  100% {
    top: 105%;
  }
}

/* ë‘ ë²ˆì§¸ ìŠ¤ìº”ë¼ì¸ (ë”œë ˆì´ ì ìš©) */
.scene-analyzing-scanline::after {
  content: '';
  position: absolute;
  width: 100%;
  height: 2px;
  background: linear-gradient(
    transparent,
    rgba(0, 255, 255, 0.15),
    rgba(0, 255, 255, 0.4),
    rgba(0, 255, 255, 0.15),
    transparent
  );
  box-shadow: 0 0 12px rgba(0, 255, 255, 0.2);
  animation: analyzing-sweep 2.5s ease-in-out infinite;
  animation-delay: 1.25s;
}

/* ë¶„ì„ ë©”ì¸ í…ìŠ¤íŠ¸ (ì‹œì•ˆ ê¸€ë¡œìš°) */
.scene-analyzing-text {
  font-family: var(--font-main);
  font-size: var(--font-size-lg);
  color: rgba(0, 255, 255, 0.95);
  text-transform: uppercase;
  letter-spacing: 0.15em;
  text-shadow:
    0 0 10px rgba(0, 255, 255, 0.6),
    0 0 20px rgba(0, 255, 255, 0.3),
    0 0 40px rgba(0, 255, 255, 0.15);
  z-index: 2;
  animation: analyzing-text-pulse 2s ease-in-out infinite;
}

@keyframes analyzing-text-pulse {
  0%,
  100% {
    opacity: 1;
    text-shadow:
      0 0 10px rgba(0, 255, 255, 0.6),
      0 0 20px rgba(0, 255, 255, 0.3),
      0 0 40px rgba(0, 255, 255, 0.15);
  }
  50% {
    opacity: 0.8;
    text-shadow:
      0 0 15px rgba(0, 255, 255, 0.8),
      0 0 30px rgba(0, 255, 255, 0.4),
      0 0 50px rgba(0, 255, 255, 0.2);
  }
}

/* ë¶„ì„ ì„œë¸Œ í…ìŠ¤íŠ¸ (íŒíŠ¸) */
.scene-analyzing-subtext {
  font-family: var(--font-main);
  font-size: var(--font-size-xs);
  color: rgba(0, 255, 255, 0.5);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  z-index: 2;
}

/* reduced-motion: ì²˜ë¦¬ ì¤‘ ì• ë‹ˆë©”ì´ì…˜ ì™„í™” (U-071) */
@media (prefers-reduced-motion: reduce) {
  .scene-processing-overlay {
    animation: none;
  }

  .scene-processing-spinner .spinner-ring-outer,
  .scene-processing-spinner .spinner-ring-inner {
    animation: none;
    border-color: var(--text-color);
  }

  .scene-processing-spinner .spinner-ring-inner {
    border-color: var(--accent-color);
  }

  .scene-processing-spinner .spinner-glow {
    animation: none;
    opacity: 0.7;
  }

  .scene-processing-text {
    animation: none;
  }

  .scene-processing-scanlines {
    animation: none;
    opacity: 0.3;
  }

  .scene-generating-spinner {
    animation: none;
    border-color: var(--accent-color);
  }

  /* U-089: ì •ë°€ë¶„ì„ ì• ë‹ˆë©”ì´ì…˜ ë¹„í™œì„±í™” (prefers-reduced-motion) */
  .scene-analyzing-overlay {
    animation: none;
  }

  .scene-analyzing-scanline::before,
  .scene-analyzing-scanline::after {
    animation: none;
    top: 50%;
    opacity: 0.5;
  }

  .scene-analyzing-text {
    animation: none;
    opacity: 1;
  }
}

/* ============================================
   8.0.3 ì´ë¯¸ì§€ ì—ëŸ¬ ë°°ì§€ (U-020)
   - RULE-004: ì‹¤íŒ¨ ì‹œ ì•ˆì „í•œ í´ë°±
   ============================================ */

.scene-error-badge {
  position: absolute;
  top: var(--spacing-md);
  right: var(--spacing-md);
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  padding: var(--spacing-xs) var(--spacing-sm);
  background-color: rgba(40, 0, 0, 0.9);
  border: 1px solid var(--warning-color);
  border-radius: 2px;
  z-index: 15;
  animation: error-shake 0.3s ease-out;
}

@keyframes error-shake {
  0%,
  100% {
    transform: translateX(0);
  }
  25% {
    transform: translateX(-4px);
  }
  75% {
    transform: translateX(4px);
  }
}

.scene-error-icon {
  font-size: 0.875rem;
}

.scene-error-text {
  font-size: var(--font-size-xs);
  color: var(--warning-color);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* reduced-motion: ë¡œë”©/ì—ëŸ¬ ì• ë‹ˆë©”ì´ì…˜ ì™„í™” */
@media (prefers-reduced-motion: reduce) {
  .scene-loading-indicator {
    animation: none;
  }

  .scene-loading-spinner {
    animation: none;
    border-color: var(--accent-color);
  }

  .scene-canvas.image-loading::before {
    animation: none;
    transform: none;
  }

  .scene-error-badge {
    animation: none;
  }

  .scene-canvas .scene-image {
    transition: none;
    opacity: 1;
  }

  .scene-canvas .scene-image.scene-image-loaded {
    opacity: 1;
  }
}

/* ============================================
   8.1 í•«ìŠ¤íŒŸ ì˜¤ë²„ë ˆì´ (U-010)
   - RULE-009: ì¢Œí‘œ ê·œì•½ (0~1000 ì •ê·œí™”)
   - í´ë¦­ ê°€ëŠ¥í•œ ì˜¤ë¸Œì íŠ¸ ì˜ì—­ í‘œì‹œ
   ============================================ */

/* í•«ìŠ¤íŒŸ ë ˆì´ì–´ (ì¥ë©´ ì´ë¯¸ì§€ ìœ„ ì˜¤ë²„ë ˆì´) */
.hotspot-layer {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 10;
}

/* ê°œë³„ í•«ìŠ¤íŒŸ ì˜¤ë²„ë ˆì´ */
/* U-050: Option A - ë©´ ìµœì†Œí™”, í…Œë‘ë¦¬/outline ì¤‘ì‹¬ ê°•ì¡° */
.hotspot-overlay {
  position: absolute;
  pointer-events: auto;
  cursor: pointer;
  /* ë©´: ê±°ì˜ íˆ¬ëª… (ì½˜í…ì¸  ë³´í˜¸) */
  background-color: rgba(51, 255, 0, 0.02);
  /* í…Œë‘ë¦¬: ëŒ€ì‹œ íŒ¨í„´ìœ¼ë¡œ ì‹œê°ì  êµ¬ë¶„ + ì¡´ì¬ê° */
  border: 1.5px dashed var(--text-color);
  border-radius: 2px;
  /* ê¸€ë¡œìš°: ë§¤ìš° ì–•ê³  ì¢ê²Œ (4px blur, ë‚®ì€ opacity) */
  box-shadow: 0 0 4px rgba(51, 255, 0, 0.15);
  transition:
    border-color 0.2s,
    border-style 0.2s,
    background-color 0.2s,
    box-shadow 0.2s;
}

/* í•«ìŠ¤íŒŸ í˜¸ë²„ íš¨ê³¼ - U-050: í…Œë‘ë¦¬ ì¤‘ì‹¬, ë©´ ìµœì†Œí™” */
.hotspot-overlay.hovered {
  /* ë©´: ì•„ì£¼ ë¯¸ì„¸í•œ í‹´íŠ¸ë§Œ (ë®ì„ ë°©ì§€) */
  background-color: rgba(255, 0, 255, 0.04);
  /* í…Œë‘ë¦¬: solidë¡œ ì „í™˜ + ê°•ì¡°ìƒ‰ */
  border: 2px solid var(--accent-color);
  /* ê¸€ë¡œìš°: ì»´íŒ©íŠ¸í•˜ê²Œ (6px blur) */
  box-shadow:
    0 0 6px rgba(255, 0, 255, 0.35),
    inset 0 0 2px rgba(255, 0, 255, 0.1);
  /* scale ì œê±° - ë®ì„ ë°©ì§€ */
  transform: none;
}

/* í•«ìŠ¤íŒŸ í¬ì»¤ìŠ¤ íš¨ê³¼ (ì ‘ê·¼ì„±) */
.hotspot-overlay:focus {
  outline: 2px solid var(--accent-color);
  outline-offset: 2px;
}

/* ë¹„í™œì„±í™”ëœ í•«ìŠ¤íŒŸ */
.hotspot-overlay.disabled {
  cursor: not-allowed;
  border-color: var(--text-dim);
  background-color: rgba(0, 0, 0, 0.3);
  box-shadow: none;
  opacity: 0.5;
}

.hotspot-overlay.disabled:hover {
  transform: none;
  border-color: var(--text-dim);
  background-color: rgba(0, 0, 0, 0.3);
}

/* ============================================
   8.2 í•«ìŠ¤íŒŸ ë“œë¡­ íƒ€ê²Ÿ ìƒíƒœ (U-012)
   - ë“œë˜ê·¸ ì˜¤ë²„ ì‹œ í•˜ì´ë¼ì´íŠ¸ ê°•í™”
   - ë“œë¡­ ê°€ëŠ¥/ë¶ˆê°€ ìƒíƒœ ì‹œê°í™”
   ============================================ */

/* ë“œë¡­ íƒ€ê²Ÿ í™œì„± ìƒíƒœ (ì•„ì´í…œì´ ìœ„ì— ìˆì„ ë•Œ) */
/* U-050: ë©´ ìµœì†Œí™”, ê¸€ë¡œìš° ì¶•ì†Œ, í„ìŠ¤ ëŠë¦¬ê²Œ */
.hotspot-overlay.drop-target-active {
  /* ë©´: ë¯¸ì„¸í•œ ê²½ê³  í‹´íŠ¸ */
  background-color: rgba(255, 170, 0, 0.06);
  /* í…Œë‘ë¦¬: ë‘ê»ê²Œ + solid */
  border: 2.5px solid var(--warning-color);
  /* ê¸€ë¡œìš°: ì ë‹¹íˆ (8px blur) */
  box-shadow:
    0 0 8px rgba(255, 170, 0, 0.4),
    inset 0 0 3px rgba(255, 170, 0, 0.15);
  /* scale ì¶•ì†Œ */
  transform: scale(1.01);
  /* í„ìŠ¤: ëŠë¦¬ê²Œ (0.6s â†’ 1.2s) */
  animation: drop-target-pulse 1.2s ease-in-out infinite;
}

/* ë“œë¡­ íƒ€ê²Ÿ í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ - U-050: ë¶€ë“œëŸ½ê²Œ */
@keyframes drop-target-pulse {
  0%,
  100% {
    box-shadow:
      0 0 8px rgba(255, 170, 0, 0.4),
      inset 0 0 3px rgba(255, 170, 0, 0.15);
  }
  50% {
    box-shadow:
      0 0 12px rgba(255, 170, 0, 0.5),
      inset 0 0 4px rgba(255, 170, 0, 0.2);
  }
}

/* ë“œë¡­ íŒíŠ¸ ìŠ¤íƒ€ì¼ (íˆ´íŒ ë‚´) */
.hotspot-tooltip-drop-hint {
  display: block;
  margin-top: 4px;
  font-size: var(--font-size-sm);
  font-weight: bold;
  color: var(--warning-color);
  text-transform: uppercase;
  letter-spacing: 1px;
  animation: drop-hint-blink 0.8s ease-in-out infinite;
}

@keyframes drop-hint-blink {
  0%,
  100% {
    opacity: 1;
  }
  50% {
    opacity: 0.6;
  }
}

/* ë“œë¡­ íƒ€ê²Ÿ í™œì„±í™” ì‹œ íˆ´íŒ í…Œë‘ë¦¬ ë³€ê²½ - U-050: ê¸€ë¡œìš° ì¶•ì†Œ */
.hotspot-overlay.drop-target-active .hotspot-tooltip {
  border-color: var(--warning-color);
  box-shadow:
    0 0 6px rgba(255, 170, 0, 0.3),
    0 2px 8px rgba(0, 0, 0, 0.7);
}

.hotspot-overlay.drop-target-active .hotspot-tooltip::after {
  border-top-color: var(--warning-color);
}

/* reduced-motion: ë“œë¡­ ì• ë‹ˆë©”ì´ì…˜ ì™„í™” */
@media (prefers-reduced-motion: reduce) {
  .hotspot-overlay.drop-target-active {
    animation: none;
    transform: none;
  }

  .hotspot-tooltip-drop-hint {
    animation: none;
  }
}

/* í•«ìŠ¤íŒŸ íˆ´íŒ - U-050: ê¸€ë¡œìš° ì¶•ì†Œ, ê°€ë…ì„± ê°œì„  */
.hotspot-tooltip {
  position: absolute;
  bottom: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
  min-width: 100px;
  max-width: 200px;
  padding: var(--spacing-xs) var(--spacing-sm);
  /* ë°°ê²½: ì•½ê°„ ë” ë¶ˆíˆ¬ëª…í•˜ê²Œ (ê°€ë…ì„±) */
  background-color: rgba(0, 15, 0, 0.92);
  border: 1px solid var(--accent-color);
  border-radius: 2px;
  /* ê¸€ë¡œìš°: ì¶•ì†Œ (10px â†’ 5px) */
  box-shadow:
    0 0 5px rgba(255, 0, 255, 0.25),
    0 2px 8px rgba(0, 0, 0, 0.7);
  z-index: 20;
  white-space: nowrap;
  animation: tooltip-fade-in 0.15s ease-out;
  /* ë‹¤ë¥¸ í•«ìŠ¤íŒŸ í´ë¦­ì„ ì°¨ë‹¨í•˜ì§€ ì•Šë„ë¡ ì´ë²¤íŠ¸ íˆ¬ê³¼ */
  pointer-events: none;
}

@keyframes tooltip-fade-in {
  from {
    opacity: 0;
    transform: translateX(-50%) translateY(4px);
  }
  to {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
}

/* íˆ´íŒ í™”ì‚´í‘œ (í•˜ë‹¨ ê°€ë¦¬í‚¤ê¸°) */
.hotspot-tooltip::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 6px solid transparent;
  border-top-color: var(--accent-color);
}

/* íˆ´íŒ ë¼ë²¨ */
/* U-057: íˆ´íŒ ë¼ë²¨ ê¸€ë¡œìš° ì™„í™” */
.hotspot-tooltip-label {
  display: block;
  font-size: var(--font-size-sm);
  font-weight: bold;
  color: var(--text-color);
  text-transform: uppercase;
  letter-spacing: 1px;
  text-shadow: 0 0 2px rgba(51, 255, 0, 0.3);
  -webkit-font-smoothing: antialiased;
}

/* íˆ´íŒ íŒíŠ¸ */
.hotspot-tooltip-hint {
  display: block;
  margin-top: 2px;
  font-size: var(--font-size-xs);
  color: var(--text-dim);
}

/* í•«ìŠ¤íŒŸ ìˆì„ ë•Œ Scene Canvas ì¡°ì • */
.scene-canvas.has-hotspots {
  /* í•«ìŠ¤íŒŸ ë ˆì´ì–´ë¥¼ ìœ„í•œ position ì»¨í…ìŠ¤íŠ¸ í™•ë³´ */
  position: relative;
}

/* ëª¨ë°”ì¼ì—ì„œ í•«ìŠ¤íŒŸ í„°ì¹˜ ì˜ì—­ í™•ëŒ€ - U-050: íˆ´íŒ ìœ„ì¹˜ ì¡°ì • */
@media (max-width: 768px) {
  .hotspot-overlay {
    /* í„°ì¹˜ ì˜ì—­ ìµœì†Œ 44px ë³´ì¥ */
    min-width: 44px;
    min-height: 44px;
  }

  .hotspot-tooltip {
    /* í™”ë©´ ìƒë‹¨ ê°€ë¦¼ ë°©ì§€: ì•„ë˜ë¡œ í‘œì‹œ */
    bottom: auto;
    top: calc(100% + 6px);
    max-width: 140px;
    font-size: 0.8rem;
  }

  .hotspot-tooltip::after {
    /* í™”ì‚´í‘œ ë°©í–¥ ë°˜ì „ */
    top: auto;
    bottom: 100%;
    border-top-color: transparent;
    border-bottom-color: var(--accent-color);
  }

  .hotspot-overlay.drop-target-active .hotspot-tooltip::after {
    border-bottom-color: var(--warning-color);
  }
}

/* íƒœë¸”ë¦¿ ì¤‘ê°„ í¬ê¸° - U-050 */
@media (min-width: 769px) and (max-width: 1200px) {
  .hotspot-tooltip {
    max-width: 170px;
  }
}

/* ì ‘ê·¼ì„±: reduced-motionì—ì„œ ì• ë‹ˆë©”ì´ì…˜ ì™„í™” */
@media (prefers-reduced-motion: reduce) {
  .hotspot-overlay {
    transition: none;
  }

  .hotspot-overlay.hovered {
    transform: none;
  }

  .hotspot-tooltip {
    animation: none;
  }
}

/* ë‚´ëŸ¬í‹°ë¸Œ í”¼ë“œ - RULE-002: ì±„íŒ… ë²„ë¸” ì•„ë‹˜, ê²Œì„ ë¡œê·¸ í˜•íƒœ */
.narrative-feed {
  /* U-073: Scene Canvas 1:1 ë¹„ìœ¨ì— ë§ì¶° ë‚¨ì€ ê³µê°„ í™œìš© */
  flex: 1;
  min-height: 200px; /* ìµœì†Œ 6~7ì¤„ í‘œì‹œ ê°€ëŠ¥ */
  border: 1px solid var(--border-color);
  background-color: var(--panel-bg);
  box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.8);
  overflow-y: auto;
  overflow-x: hidden; /* U-049: ë¶ˆí•„ìš”í•œ ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€ */
  scrollbar-width: thin; /* Firefox: ì–‡ì€ ìŠ¤í¬ë¡¤ë°” */
  padding: var(--spacing-sm);
}

.narrative-entry {
  padding: var(--spacing-xs) 0;
  border-bottom: 1px solid rgba(51, 255, 0, 0.2);
}

.narrative-entry:last-child {
  border-bottom: none;
}

.narrative-timestamp {
  color: var(--text-dim);
  font-size: 0.75rem;
  margin-right: var(--spacing-sm);
}

.narrative-text {
  color: var(--text-color);
}

/* ============================================
   8.1. U-070: Action Log Entry ìŠ¤íƒ€ì¼
   - ì•¡ì…˜ ë¡œê·¸ëŠ” ë‚´ëŸ¬í‹°ë¸Œì™€ ì‹œê°ì ìœ¼ë¡œ êµ¬ë¶„ë¨
   - PRD 9.0: "í–‰ë™ ì‹¤í–‰: ..." í˜•ì‹ìœ¼ë¡œ í‘œì‹œ
   - Q1 Option A: ë™ì¼ ì˜ì—­ì— ë‹¤ë¥¸ ìŠ¤íƒ€ì¼(dim, ì´íƒ¤ë¦­)
   ============================================ */

.action-log-entry {
  color: var(--text-muted, #4a7a4a);
  font-style: italic;
  font-size: 0.8em;
  padding-left: 0.8em;
  border-left: 1px solid var(--text-muted, #4a7a4a);
  border-bottom: none;
  margin: 2px 0;
  opacity: 0.7;
}

.action-log-entry .narrative-text {
  color: var(--text-muted, #4a7a4a);
  font-style: italic;
}

.action-log-icon {
  color: var(--text-muted, #4a7a4a);
  margin-right: 4px;
  font-style: normal;
  font-size: 0.9em;
}

/* System entry ìŠ¤íƒ€ì¼ (ë“œë¡­ ì‹¤íŒ¨ ë“±) */
.system-entry {
  color: var(--text-dim);
  opacity: 0.7;
  font-size: 0.85em;
}

.system-entry .narrative-text {
  color: var(--text-dim);
}

/* ============================================
   9. Sidebar (Right) ì˜ì—­
   - Agent Console, Memory Pin, Scanner Slot
   - U-049: ì»¬ëŸ¼ ì „ì²´ ìŠ¤í¬ë¡¤ ì œê±°, íŒ¨ë„ ì½˜í…ì¸  ë‹¨ìœ„ ìŠ¤í¬ë¡¤
   ============================================ */

.sidebar-right {
  grid-area: sidebar-right;
  display: flex;
  flex-direction: column;
  gap: var(--layout-gap); /* U-073: ë ˆì´ì•„ì›ƒ ê°­ í†µì¼ */
  min-height: 0; /* U-049: flex ìì‹ ì¶•ì†Œ í—ˆìš© */
  overflow: hidden; /* U-049: ì»¬ëŸ¼ ì „ì²´ ìŠ¤í¬ë¡¤ ì œê±° */
}

/* ============================================
   10. Footer ì˜ì—­
   - Action Deck, Command Input
   ============================================ */

.game-footer {
  grid-area: footer;
  display: flex;
  flex-direction: column;
  /* U-050 v5: ì¹´ë“œì™€ ì…ë ¥ì°½ ì‚¬ì´ ê°„ê²© ì¶•ì†Œ */
  gap: 2px;
  padding: var(--spacing-sm);
  border: 1px solid var(--border-color);
  background-color: var(--panel-bg);
  box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
}

/* ============================================
   10.1 Action Deck (U-009: ê²Œì„ ì¹´ë“œ UI)
   - RULE-002: ì±„íŒ… ë²„íŠ¼ì´ ì•„ë‹Œ ê²Œì„ ì¹´ë“œ
   - RULE-005: ë¹„ìš©/ìœ„í—˜/ë³´ìƒ í‘œì‹œ
   ============================================ */

.action-deck {
  display: flex;
  /* U-083: ë±ƒì§€ ìœ ë¬´ì™€ ê´€ê³„ì—†ì´ ì¹´ë“œ ë†’ì´ë¥¼ ì¼ê´€ë˜ê²Œ ìœ ì§€ */
  align-items: stretch;
  gap: var(--spacing-sm);
  /* U-050 v6: ì¹´ë“œ ë†’ì´ ì¶•ì†Œì— ë§ì¶° min-height ê°ì†Œ */
  min-height: 85px;
  padding: var(--spacing-xs) 0 0;
  /* U-049: ë“œë˜ê·¸ ìŠ¤í¬ë¡¤ - ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
  overflow-x: auto;
  overflow-y: visible;
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE/Edge */
  /* í„°ì¹˜ ë””ë°”ì´ìŠ¤ ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
  -webkit-overflow-scrolling: touch;
  scroll-behavior: smooth;
  /* ë“œë˜ê·¸ ìŠ¤í¬ë¡¤ì„ ìœ„í•œ ì»¤ì„œ */
  cursor: grab;
  /* ì¹´ë“œ ìŠ¤ëƒ… */
  scroll-snap-type: x mandatory;
  scroll-padding: 0 var(--spacing-sm);
}

.action-deck::-webkit-scrollbar {
  display: none; /* Chrome/Safari */
}

.action-deck:active,
.action-deck.is-dragging {
  cursor: grabbing;
  user-select: none; /* ë“œë˜ê·¸ ì¤‘ í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
}

/* U-049: í„°ì¹˜ ë””ë°”ì´ìŠ¤ ìµœì í™” (Web Interface Guidelines) */
.action-deck {
  touch-action: pan-x; /* ìˆ˜í‰ ìŠ¤í¬ë¡¤ë§Œ í—ˆìš© */
  -webkit-tap-highlight-color: transparent;
}

.action-deck .action-card {
  scroll-snap-align: start;
  flex-shrink: 0; /* ì¹´ë“œ ì¶•ì†Œ ë°©ì§€ */
}

/* ì¹´ë“œ ê¸°ë³¸ ìŠ¤íƒ€ì¼ - ê²Œì„ ì¹´ë“œì²˜ëŸ¼ ë³´ì´ê²Œ */
.action-card {
  position: relative;
  min-width: 160px;
  max-width: 200px;
  /* U-050 v6: padding ì¶•ì†Œ - ì»´íŒ©íŠ¸í•œ ì¹´ë“œ */
  padding: var(--spacing-xs) var(--spacing-sm) var(--spacing-sm);
  border: 2px solid var(--border-color);
  border-radius: var(--border-radius);
  /* U-049: ë°°ê²½ ëŒ€ë¹„ ê°•í™” - ë” ë¶ˆíˆ¬ëª…í•œ ë°°ê²½ */
  background: linear-gradient(180deg, rgba(0, 20, 0, 0.98) 0%, rgba(0, 10, 0, 0.99) 100%);
  /* U-049: ë‚´ë¶€ ê·¸ë¦¼ìë¡œ ê¹Šì´ê° ì¶”ê°€ */
  box-shadow:
    inset 0 0 20px rgba(0, 0, 0, 0.6),
    inset 0 1px 0 rgba(51, 255, 0, 0.1);
  cursor: pointer;
  transition:
    border-color 0.2s,
    box-shadow 0.2s,
    transform 0.15s;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

/* ìœ„í—˜ë„ë³„ í…Œë‘ë¦¬ ìƒ‰ìƒ */
.action-card.risk-border-low {
  border-color: var(--text-color);
}

.action-card.risk-border-medium {
  border-color: var(--warning-color);
}

.action-card.risk-border-high {
  border-color: var(--error-color);
}

/* í˜¸ë²„ íš¨ê³¼ - ì¹´ë“œê°€ ì‚´ì§ ì˜¬ë¼ì˜¤ëŠ” ëŠë‚Œ */
.action-card:hover:not(:disabled) {
  border-color: var(--accent-color);
  box-shadow:
    0 0 15px var(--accent-color),
    0 4px 20px rgba(0, 0, 0, 0.5);
  transform: translateY(-4px);
}

/* ì¹´ë“œ íƒ€ì´í‹€ - U-050 v6: ì»´íŒ©íŠ¸ ì¹´ë“œì— ë§ì¶° í¬ê¸° ì¶•ì†Œ */
/* U-057: ê¸€ë¡œìš° ì™„í™” (10px/20px â†’ 3px) - ê°€ë…ì„± ê°œì„  */
.action-card-title {
  font-size: 0.85rem;
  font-weight: bold;
  color: var(--text-color);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  /* U-057: ê³¼ë„í•œ ê¸€ë¡œìš° ì™„í™” - ë¶„ìœ„ê¸° ìœ ì§€ + ê°€ë…ì„± */
  text-shadow:
    0 0 3px rgba(51, 255, 0, 0.4),
    0 1px 2px rgba(0, 0, 0, 0.9);
  padding-bottom: 2px;
  border-bottom: 1px solid var(--text-dim);
  -webkit-font-smoothing: antialiased;
  /* U-083: ë‚¨ëŠ” ê³µê°„ì„ íƒ€ì´í‹€ì´ ì°¨ì§€ â†’ ë¹„ìš©/ë±ƒì§€ê°€ í•­ìƒ ì¹´ë“œ í•˜ë‹¨ ì •ë ¬ */
  flex: 1;
}

/* ì¹´ë“œ ì„¤ëª… - U-050 v6: ì»´íŒ©íŠ¸ ì¹´ë“œì— ë§ì¶° ì¶•ì†Œ */
.action-card-description {
  font-size: 0.7rem;
  color: var(--text-dim);
  line-height: 1.2;
  min-height: 1.5em;
}

/* ë¹„ìš© í‘œì‹œ ì˜ì—­ - U-050 v6: ì»´íŒ©íŠ¸ ë„ˆë¹„, ê°€ìš´ë° ì •ë ¬ */
.action-card-cost {
  display: flex;
  align-items: center;
  justify-content: center;
  flex-wrap: wrap;
  gap: 4px;
  font-size: 0.65rem;
  color: var(--warning-color);
  padding: 2px var(--spacing-xs);
  /* U-050 v6: ì»¨í…ì¸ ì— ë§ëŠ” ë„ˆë¹„ + ì¹´ë“œ ë‚´ ê°€ìš´ë° ë°°ì¹˜ */
  width: fit-content;
  margin: 0 auto;
  /* U-083: ë¹„ìš© í–‰ì„ ì¹´ë“œ í•˜ë‹¨ìœ¼ë¡œ ë°€ì–´ë„£ê¸° (íƒ€ì´í‹€ flex:1ê³¼ ì—°ë™) */
  margin-top: auto;
  /* U-049: ë” ê°•í•œ ë°°ê²½ ëŒ€ë¹„ */
  background: linear-gradient(180deg, rgba(0, 0, 0, 0.7) 0%, rgba(0, 0, 0, 0.85) 100%);
  border: 1px solid rgba(51, 255, 0, 0.2);
  border-radius: 2px;
  /* U-049: í…ìŠ¤íŠ¸ ê·¸ë¦¼ì */
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
}

.action-card-cost .cost-item {
  display: inline-flex;
  align-items: center;
  gap: 2px;
}

.action-card-cost .cost-separator {
  color: var(--text-dim);
  margin: 0 2px;
}

.action-card-cost .cost-value {
  font-weight: bold;
  font-family: var(--font-micro-en);
}

/* ìœ„í—˜ë„ ë¼ë²¨ ìƒ‰ìƒ */
.action-card-cost .risk-label {
  text-transform: uppercase;
  font-size: 0.625rem;
  font-weight: bold;
}

.action-card-cost .risk-label.risk-low {
  color: var(--text-color);
}

.action-card-cost .risk-label.risk-medium {
  color: var(--warning-color);
}

.action-card-cost .risk-label.risk-high {
  color: var(--error-color);
}

/* íŒíŠ¸ ì˜ì—­ (ìœ„í—˜/ë³´ìƒ) */
.action-card-hints {
  display: flex;
  flex-direction: column;
  gap: 2px;
  font-size: 0.625rem;
  padding-top: var(--spacing-xs);
  border-top: 1px dashed var(--text-dim);
}

.action-card-hints .hint-item {
  display: flex;
  align-items: flex-start;
  gap: 4px;
}

.action-card-hints .hint-icon {
  flex-shrink: 0;
}

.action-card-hints .hint-risk {
  color: var(--warning-color);
}

.action-card-hints .hint-reward {
  color: var(--accent-color);
}

.action-card-hints .hint-text {
  color: var(--text-dim);
  line-height: 1.2;
}

/* U-083: ë±ƒì§€ ì»¨í…Œì´ë„ˆ - ë¹„ìš© ì•„ë˜ ë³„ë„ í–‰ (Q3: Option C) */
.action-card-badges {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 3px;
  margin-top: 3px;
}

/* U-083: í†µí•© ë±ƒì§€ ê¸°ë³¸ ìŠ¤íƒ€ì¼ (Q2: ellipsis + íˆ´íŒ) */
.action-card-badge {
  display: inline-flex;
  align-items: center;
  gap: 2px;
  padding: 1px 5px;
  font-size: 0.55rem;
  font-weight: bold;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-radius: 2px;
  max-width: 90px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  line-height: 1.3;
}

/* U-083: ë±ƒì§€ íƒ€ì…ë³„ ìƒ‰ìƒ */
.action-card-badge.badge-alternative {
  background-color: var(--text-color);
  color: var(--bg-color);
}

.action-card-badge.badge-quality {
  background: linear-gradient(135deg, #ffd700, #ff8c00);
  color: #000;
}

.action-card-badge.badge-vision {
  background: linear-gradient(135deg, #00e5ff, #00b0ff);
  color: #000;
}

.action-card-badge.badge-earn {
  background: linear-gradient(135deg, rgba(255, 200, 0, 0.4), rgba(255, 165, 0, 0.35));
  border: 1px solid rgba(255, 200, 0, 0.5);
  color: #ffc800;
}

/* U-083: "ì™¸ Nê°œ" ì˜¤ë²„í”Œë¡œ í‘œì‹œ (Q1: Option B) */
.action-card-badge.badge-overflow {
  background-color: var(--text-dim);
  color: var(--bg-color);
  font-size: 0.5rem;
  max-width: unset;
  cursor: help;
}

/* ëŒ€ì•ˆ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
.action-card.card-alternative {
  border-style: dashed;
  opacity: 0.85;
  min-width: 140px;
}

.action-card.card-alternative:hover:not(:disabled) {
  opacity: 1;
}

/* U-069: QUALITY ëª¨ë¸ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
.action-card.card-quality {
  border-color: #ffd700;
}

.action-card.card-quality:hover:not(:disabled) {
  border-color: #ffd700;
  box-shadow:
    0 0 15px rgba(255, 215, 0, 0.4),
    0 0 30px rgba(255, 215, 0, 0.2);
}

/* U-083: quality-badgeëŠ” .action-card-badge.badge-qualityë¡œ í†µí•©ë¨ (í•˜ìœ„ í˜¸í™˜ ì œê±°) */

.action-card-cost .quality-cost {
  color: #ffd700;
}

.action-card-cost .cost-multiplier {
  font-size: 0.55rem;
  margin-left: 1px;
  opacity: 0.8;
}

/* U-076: VISION(ì •ë°€ë¶„ì„) ì¹´ë“œ ìŠ¤íƒ€ì¼ */
.action-card.card-vision {
  border-color: #00e5ff;
}

.action-card.card-vision:hover:not(:disabled) {
  border-color: #00e5ff;
  box-shadow:
    0 0 15px rgba(0, 229, 255, 0.4),
    0 0 30px rgba(0, 229, 255, 0.2);
}

/* U-083: vision-badgeëŠ” .action-card-badge.badge-visionìœ¼ë¡œ í†µí•©ë¨ (í•˜ìœ„ í˜¸í™˜ ì œê±°) */

.action-card-cost .vision-cost {
  color: #00e5ff;
}

/* ë¹„í™œì„±í™”ëœ ì¹´ë“œ */
.action-card.card-disabled,
.action-card:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  border-color: var(--text-dim);
  transform: none;
}

.action-card.card-disabled:hover,
.action-card:disabled:hover {
  border-color: var(--text-dim);
  box-shadow: none;
  transform: none;
}

/* ë¹„í™œì„±í™” ì˜¤ë²„ë ˆì´ */
.action-card .card-disabled-overlay {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: rgba(0, 0, 0, 0.7);
  border-radius: var(--border-radius);
}

.action-card .card-disabled-overlay .disabled-reason {
  padding: var(--spacing-xs) var(--spacing-sm);
  font-size: 0.625rem;
  font-weight: bold;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--error-color);
  background-color: rgba(0, 0, 0, 0.8);
  border: 1px solid var(--error-color);
  text-shadow: 0 0 5px var(--error-color);
}

/* ëª¨ë“  ì¹´ë“œ ë¹„í™œì„±í™” ì•ˆë‚´ */
.action-deck .deck-empty-notice {
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 200px;
  padding: var(--spacing-md);
  color: var(--warning-color);
  font-size: 0.75rem;
  text-align: center;
  border: 1px dashed var(--warning-color);
  background-color: rgba(255, 170, 0, 0.1);
}

.command-input-area {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-xs);
  border: 1px solid var(--text-dim);
  background-color: rgba(0, 0, 0, 0.5);
}

.command-prompt {
  color: var(--text-color);
  font-size: var(--font-size-lg);
}

.command-input {
  flex: 1;
  background: transparent;
  border: none;
  color: var(--text-color);
  font-family: var(--font-main);
  font-size: var(--font-size-lg);
  outline: none;
  text-shadow: 0 0 5px var(--text-dim);
}

.command-input::placeholder {
  color: var(--text-dim);
}

/* ============================================
   11. ê³µí†µ íŒ¨ë„ ìŠ¤íƒ€ì¼
   - U-049: flex ìŠ¤í¬ë¡¤ ì „ëµ ì •ë¦¬ (min-height: 0 í•µì‹¬)
   ============================================ */

.panel {
  border: 1px solid var(--border-color);
  background-color: var(--panel-bg);
  box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.8);
  display: flex;
  flex-direction: column;
  min-height: 0; /* U-049: flex item ì¶•ì†Œ í—ˆìš© (í•„ìˆ˜) */
  overflow: hidden; /* U-049: íŒ¨ë„ ìì²´ ìŠ¤í¬ë¡¤ ë°©ì§€ */
}

.panel-header {
  padding: var(--spacing-xs) var(--spacing-sm);
  border-bottom: 1px solid var(--text-dim);
  background-color: rgba(0, 0, 0, 0.3);
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0; /* U-049: í—¤ë”ëŠ” ì¶•ì†Œí•˜ì§€ ì•ŠìŒ */
}

.panel-title {
  font-size: 0.875rem;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--text-color);
}

.panel-content {
  flex: 1;
  padding: var(--spacing-sm);
  overflow-y: auto;
  overflow-x: hidden; /* U-049: ìš°ì¸¡ íŒ¨ë„ ë“± ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€ */
  scrollbar-width: thin; /* Firefox: ì–‡ì€ ìŠ¤í¬ë¡¤ë°” */
  min-height: 0; /* U-049: flex ìì‹ ì¶•ì†Œ í—ˆìš© (í•„ìˆ˜) */
}

.panel-placeholder {
  color: var(--text-dim);
  font-size: 0.875rem;
  text-align: center;
  padding: var(--spacing-md);
}

/* ===========================================
   11.1 ì‚¬ì´ë“œë°” íŒ¨ë„ë³„ ë†’ì´ ì „ëµ (U-082 ë°˜ì „)
   - U-049 ì›ë³¸: Agent Console flex-1 / Economy ê³ ì •
   - U-082 ë³€ê²½: Agent Console ì½˜í…ì¸  ê¸°ë°˜ / Economy flex-1
   - Agent Console: ê¸°ë³¸ ì ‘í˜(collapsed), í•„ìš” ì‹œ í™•ì¥
   - Economy HUD: ìœ ì—° í™•ì¥ìœ¼ë¡œ ì¬í™” í˜„í™© ê°€ì‹œì„± ê°•í™”
   =========================================== */

/* Agent Console: flex 1.2 (U-099: Economyì™€ 1.2:1.8 ë¹„ìœ¨) */
.panel-agent-console {
  flex: 1.2;
  min-height: 0; /* flex ìì‹ ì¶•ì†Œ í—ˆìš© */
}

.panel-agent-console .panel-content {
  overflow-y: auto; /* ì½˜í…ì¸ ê°€ ë„˜ì¹  ê²½ìš° ë‚´ë¶€ ìŠ¤í¬ë¡¤ */
}

/* Economy HUD: flex 1.8 (U-099: Agent Console ëŒ€ë¹„ 1.5ë°° ê³µê°„) */
.panel-economy {
  flex: 1.8;
  min-height: 0; /* flex ìì‹ ì¶•ì†Œ í—ˆìš© */
}

.panel-economy .panel-content {
  display: flex;
  flex-direction: column;
  min-height: 0; /* U-049: flex ìì‹ ì¶•ì†Œ í—ˆìš© */
}

/* Scanner Slot: ì½˜í…ì¸  ê¸°ë°˜ ë†’ì´ */
.panel-scanner {
  flex-shrink: 0; /* ë‹¤ë¥¸ íŒ¨ë„ì— ë°€ë ¤ ì¶•ì†Œë˜ì§€ ì•ŠìŒ */
  overflow: visible; /* U-072: ì˜¨ë³´ë”© ë§í’ì„ ì´ íŒ¨ë„ ë°–ìœ¼ë¡œ ë‚˜ê°ˆ ìˆ˜ ìˆë„ë¡ */
}

.panel-scanner .panel-content {
  overflow: visible; /* U-072: ì˜¨ë³´ë”© ë§í’ì„  ì˜ë¦¼ ë°©ì§€ */
}

/* ===========================================
   11.2 ì¢Œì¸¡ ì‚¬ì´ë“œë°” íŒ¨ë„ë³„ ë†’ì´ ì „ëµ (U-077 + U-081 í¡ìˆ˜)
   - Inventory: flex-1 + min-height ë³´ì¥ (ì ˆëŒ€ ì¶•ì†Œ ê¸ˆì§€)
   - Quest/Rule Board: max-height + ë‚´ë¶€ ìŠ¤í¬ë¡¤
   - ëª¨ë“  íŒ¨ë„ í—¤ë” í•­ìƒ ë³´ì„
   =========================================== */

/* Inventory íŒ¨ë„: ìµœì†Œ ë†’ì´ ë³´ì¥ + ë‚´ë¶€ ìŠ¤í¬ë¡¤ ìœ„ì„ */
.panel-inventory {
  min-height: 120px; /* U-077: ìµœì†Œ ê°€ì‹œì„± ë³´ì¥ */
}

/* U-077: ì¸ë²¤í† ë¦¬ íŒ¨ë„ ë‚´ë¶€ ìŠ¤í¬ë¡¤ì„ inventory-panel-contentì— ìœ„ì„ */
.panel-inventory .panel-content {
  overflow: hidden;
}

/* Quest íŒ¨ë„: max-height ì œí•œ + ë‚´ë¶€ ìŠ¤í¬ë¡¤ */
.panel-quest {
  max-height: 200px; /* U-077(U-081 í¡ìˆ˜): ê³¼ë„í•œ í™•ì¥ ë°©ì§€ */
  flex-shrink: 0;
}

.panel-quest .panel-content {
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--text-dim) transparent;
}

/* Rule Board íŒ¨ë„: max-height ì œí•œ + ë‚´ë¶€ ìŠ¤í¬ë¡¤ */
.panel-rule-board {
  max-height: 200px; /* U-077(U-081 í¡ìˆ˜): ê³¼ë„í•œ í™•ì¥ ë°©ì§€ */
  flex-shrink: 0;
}

.panel-rule-board .panel-content {
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--text-dim) transparent;
}

/* U-077: ë°˜ì‘í˜• - ë·°í¬íŠ¸ ë†’ì´ê°€ ì‘ì„ ë•Œ ì¡°ì • */
@media (max-height: 768px) {
  .panel-inventory {
    min-height: 100px;
  }

  .panel-quest {
    max-height: 150px;
  }

  .panel-rule-board {
    max-height: 150px;
  }
}

/* ============================================
   12. ë²„íŠ¼ ìŠ¤íƒ€ì¼
   ============================================ */

button,
.btn {
  background: var(--text-color);
  color: var(--bg-color);
  border: none;
  padding: var(--spacing-xs) var(--spacing-sm);
  font-family: var(--font-main);
  font-size: var(--font-size-lg);
  cursor: pointer;
  text-transform: uppercase;
  font-weight: bold;
  transition:
    background 0.2s,
    color 0.2s;
}

/* U-050 v3: ë²„íŠ¼ í˜¸ë²„ - ì•„ì´ì½˜ ì‹ë³„ì„± + í…Œë‘ë¦¬ ëŠê¹€ ë°©ì§€ */
button:hover,
.btn:hover {
  /* ë©´: ì•½í•œ í‹´íŠ¸ë¡œ ë³€ê²½ (ì•„ì´ì½˜ ë®ì„ ë°©ì§€) */
  background: rgba(255, 0, 255, 0.15);
  color: var(--accent-color);
  /* box-shadowë¡œ í…Œë‘ë¦¬ íš¨ê³¼ (outline ëŠê¹€ ë°©ì§€) */
  box-shadow:
    inset 0 0 0 2px var(--accent-color),
    0 0 8px rgba(255, 0, 255, 0.4);
}

button:disabled,
.btn:disabled {
  background: var(--text-dim);
  cursor: not-allowed;
}

/* ============================================
   13. ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í„°ë§ˆì´ì§• (U-049: ë‹¤í¬ í…Œë§ˆ ê°•ì œ)
   ============================================ */

/* ì „ì—­ ì›¹í‚· ìŠ¤í¬ë¡¤ë°” (Chrome, Safari, Edge) */
::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}

::-webkit-scrollbar-track {
  background: var(--bg-color);
}

::-webkit-scrollbar-thumb {
  background: rgba(51, 255, 0, 0.25); /* íŠ€ì§€ ì•ŠëŠ” ì–´ë‘ìš´ ë…¹ìƒ‰ */
  border: 1px solid rgba(51, 255, 0, 0.4);
  border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(51, 255, 0, 0.5);
}

/* ìŠ¤í¬ë¡¤ë°” í™”ì‚´í‘œ ì œê±° */
::-webkit-scrollbar-button {
  display: none;
  width: 0;
  height: 0;
}

/* ì½”ë„ˆ(ê°€ë¡œ/ì„¸ë¡œ ìŠ¤í¬ë¡¤ ë§Œë‚˜ëŠ” ì§€ì ) */
::-webkit-scrollbar-corner {
  background: var(--bg-color);
}

/* ============================================
   14. ë°˜ì‘í˜• ë””ìì¸
   U-073: ë ˆì´ì•„ì›ƒ í™•ì¥ - ì™€ì´ë“œìŠ¤í¬ë¦° ì§€ì› ì¶”ê°€
   ============================================ */

/* ì™€ì´ë“œìŠ¤í¬ë¦° (1920px ì´ìƒ): íŒ¨ë„ ìµœëŒ€ ë„ˆë¹„ í™•ì¥, ê°„ê²© ì¦ê°€
 * U-073: 1800px max-width ë‚´ì—ì„œ íŒ¨ë„ì´ ë” ë„“ì–´ì§ */
@media (min-width: 1920px) {
  :root {
    --layout-side-panel-max: 420px;
    --layout-gap: var(--spacing-md);
  }
}

/* ì¼ë°˜ (1366px ~ 1919px): ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ìœ ì§€ */
/* ê¸°ë³¸ê°’ ì‚¬ìš©: --layout-side-panel-min: 260px, --layout-side-panel-max: 340px */

/* ì»´íŒ©íŠ¸ (1024px ~ 1365px): íŒ¨ë„ ë„ˆë¹„ ì¶•ì†Œ */
@media (max-width: 1365px) and (min-width: 1025px) {
  :root {
    --layout-side-panel-min: 220px;
    --layout-side-panel-max: 280px;
  }
}

/* íƒœë¸”ë¦¿ (769px ~ 1024px): ì¢Œì¸¡ ì‚¬ì´ë“œë°” ìˆ¨ê¹€ */
@media (max-width: 1024px) {
  :root {
    --layout-side-panel-min: 200px;
    --layout-side-panel-max: 260px;
  }

  .game-container {
    grid-template-areas:
      'header header'
      'center sidebar-right'
      'footer footer';
    grid-template-columns:
      minmax(var(--layout-center-min), 1fr)
      minmax(var(--layout-side-panel-min), var(--layout-side-panel-max));
  }

  .sidebar-left {
    display: none;
  }
}

/* ëª¨ë°”ì¼ (768px ì´í•˜): ë‹¨ì¼ ì»¬ëŸ¼ */
@media (max-width: 768px) {
  :root {
    font-size: 14px;
    --header-height: 50px;
    --footer-height: 100px;
    --layout-gap: var(--spacing-xs);
  }

  .game-container {
    grid-template-areas:
      'header'
      'center'
      'footer';
    grid-template-columns: 1fr;
    grid-template-rows: var(--header-height) 1fr var(--footer-height);
    padding: var(--spacing-xs);
    gap: var(--spacing-xs);
  }

  .sidebar-left,
  .sidebar-right {
    display: none;
  }

  /* U-073: ëª¨ë°”ì¼ì—ì„œ Scene Canvas ë¹„ìœ¨ ì¡°ì • */
  .scene-canvas {
    aspect-ratio: 4 / 3; /* ëª¨ë°”ì¼ì—ì„œëŠ” 4:3 ë¹„ìœ¨ */
    max-height: calc(100vh - var(--header-height) - var(--footer-height) - 100px);
  }

  .game-header {
    padding: 0 var(--spacing-sm);
  }

  .game-title {
    font-size: var(--font-size-lg);
    letter-spacing: 2px;
  }

  .economy-hud {
    display: none;
  }

  .action-deck {
    flex-wrap: nowrap;
    overflow-x: auto;
  }

  .action-card {
    min-width: 120px;
  }
}

/* ============================================
   15. ìœ í‹¸ë¦¬í‹° í´ë˜ìŠ¤
   ============================================ */

.text-dim {
  color: var(--text-dim);
}

.text-accent {
  color: var(--accent-color);
}

.text-warning {
  color: var(--warning-color);
}

.text-error {
  color: var(--error-color);
}

.text-glow {
  text-shadow: 0 0 10px var(--text-color);
}

.visually-hidden {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

/* ============================================
   16. Agent Console ìŠ¤íƒ€ì¼ (U-008)
   - RULE-008: ë‹¨ê³„/ë°°ì§€/ë³µêµ¬ í‘œì‹œ
   ============================================ */

.agent-console-content {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
  font-size: 0.75rem;
}

/* U-114: Agent Console í•­ìƒ í‘œì‹œ ì˜ì—­ (Queue ìƒì‹œ ë…¸ì¶œ) */
.agent-console-always {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
}

.agent-console-summary {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  flex-wrap: wrap;
}

/* U-114: ëŒ€ê¸°ì—´(Queue) ìƒì‹œ ë…¸ì¶œ */
.agent-queue-always {
  padding: var(--spacing-xs);
}

.agent-queue-always .queue-items {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;
  width: 100%;
}

/* U-114 Q1 Option A: idle ì‹œ "ëŒ€ê¸° ì¤‘..." í…ìŠ¤íŠ¸ */
.queue-idle {
  color: var(--text-dim);
  font-size: 0.75rem;
  text-align: center;
  padding: var(--spacing-xs) 0;
  font-family: var(--font-micro-en);
  letter-spacing: 1px;
  text-transform: uppercase;
}

/* U-123: ëŒ€ê¸°ì—´/ë°°ì§€ êµ¬ë¶„ì„  (CRT í…Œë§ˆ, ë°˜íˆ¬ëª…) */
.agent-console-divider {
  border: none;
  border-top: 1px solid var(--border-color, var(--text-dim));
  opacity: 0.3;
  margin: var(--spacing-xs) 0;
}

/* U-123: ë°°ì§€ ì„¹ì…˜ (í•­ìƒ ë…¸ì¶œ, ì ‘ê¸° ì—†ìŒ) */
.agent-badges-section {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
}

.agent-badges-section .badges-panel {
  padding: 0 var(--spacing-xs);
  border-top: none;
}

.agent-badges-section .badges-panel .badges-grid {
  gap: 2px;
}

/* ìŠ¤íŠ¸ë¦¬ë° ìƒíƒœ */
.streaming-status {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  padding: 0; /* U-082: ì¸ë¼ì¸ í‘œì‹œë¡œ ë³€ê²½ */
}

.streaming-status .status-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background-color: var(--text-dim);
  transition: background-color 0.3s;
}

.streaming-status .status-dot.active {
  background-color: var(--accent-color);
  box-shadow: 0 0 8px var(--accent-color);
  animation: pulse 1s infinite;
}

.streaming-status .status-text {
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-dim);
}

.streaming-status .status-dot.active + .status-text {
  color: var(--accent-color);
}

/* ë‹¨ê³„ í */
.phase-queue {
  padding: var(--spacing-xs);
}

.phase-queue .queue-label,
.agent-queue-always .queue-label,
.badges-panel .badges-label,
.repair-trace .repair-label {
  font-size: 0.75rem; /* 12pxë¡œ ìƒí–¥ */
  text-transform: uppercase;
  letter-spacing: 2px;
  color: #33ff00; /* ìˆœìˆ˜ ì¸ê´‘ ë…¹ìƒ‰ìœ¼ë¡œ ê³ ì • */
  opacity: 1; /* íˆ¬ëª…ë„ ì œê±°í•˜ì—¬ ìµœëŒ€ ë°ê¸° */
  margin-bottom: var(--spacing-sm);
  font-weight: 600; /* ë” êµµê²Œ */
  /* U-057: ê¸€ë¡œìš° ì™„í™” (5px â†’ 2px) - ë¼ë²¨ ê°€ë…ì„± ê°œì„  */
  text-shadow: 0 0 2px rgba(51, 255, 0, 0.3);
  -webkit-font-smoothing: antialiased;
}

.badges-panel .badges-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 6px; /* ê°„ê²© ìƒí–¥ */
  width: 100%;
}

.phase-queue .queue-items,
.agent-queue-always .queue-items {
  display: grid;
  grid-template-columns: repeat(4, 1fr); /* 4ì—´ ë°°ì¹˜ ê°•ì œ */
  gap: 6px;
  width: 100%;
}

/* U-037: Phase Item ì‹ë³„ì„± ê·¹ëŒ€í™” */
.phase-item {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  padding: 6px 2px;
  background-color: rgba(0, 20, 0, 0.95); /* ë°°ê²½ ë” ì–´ë‘¡ê²Œ */
  border: 1px solid var(--text-dim);
  border-radius: 2px;
  font-family: var(--font-micro-en);
  font-size: 0.8125rem; /* 13pxë¡œ ìƒí–¥ */
  font-weight: 600; /* ë” êµµê²Œ */
  letter-spacing: 0.02em;
  box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.8);
}

/* í…ìŠ¤íŠ¸ ì„ ëª…ë„ ë° ê¸€ë¡œìš° ìµœì í™” (ë²ˆì§ ë°©ì§€) */
/* U-057: filter drop-shadowë„ ì œê±° - ì™„ì „ ì„ ëª… */
.phase-item > * {
  position: relative;
  z-index: 2;
  text-shadow: none !important; /* ë²ˆì§ ë°©ì§€ë¥¼ ìœ„í•´ ê·¸ë¦¼ì ì œê±° */
  filter: none !important; /* U-057: drop-shadowë„ ì œê±°í•˜ì—¬ ì™„ì „ ì„ ëª… */
  opacity: 1 !important;
  -webkit-font-smoothing: antialiased;
}

/* ìƒíƒœë³„ ìƒ‰ìƒ ëŒ€ë¹„ ìƒí–¥ */
.phase-item.pending {
  color: #88ff88 !important; /* ë” ë°ì€ ë…¹ìƒ‰ */
  border-color: rgba(51, 255, 0, 0.4);
}

.phase-item.in_progress,
.phase-item.in-progress {
  color: #ff00ff !important;
  border-color: #ff00ff;
  background-color: rgba(30, 0, 30, 0.95);
  box-shadow: 0 0 8px rgba(255, 0, 255, 0.4);
  /* U-087: ê¹œë¹¡ì„(pulse) ëŒ€ì‹  ë¶€ë“œëŸ¬ìš´ glow ì• ë‹ˆë©”ì´ì…˜ */
  animation: phase-glow 2.5s ease-in-out infinite;
}

/* ì”¬ í”Œë ˆì´ìŠ¤í™€ë” ì„œë¸Œ ë©”ì‹œì§€ ê°€ë…ì„± (Critical) */
.scene-status-message {
  color: var(--text-color) !important;
  opacity: 1 !important;
  text-shadow: 0 1px 3px rgba(0, 0, 0, 1) !important;
  font-size: 0.9375rem !important; /* 15pxë¡œ ìƒí–¥ */
  font-weight: 500 !important;
  margin-top: var(--spacing-sm);
  z-index: 10;
  position: relative;
}

/* ì”¬ í”Œë ˆì´ìŠ¤í™€ë” ì„œë¸Œ ë©”ì‹œì§€ ë³´í˜¸ */
.scene-placeholder .status-sub {
  color: var(--text-color);
  opacity: 0.9;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 1);
  font-size: var(--font-size-sm);
}

/* Scene CanvasëŠ” ì—¬ì „íˆ ê°•ë ¥í•œ CRT ë¶„ìœ„ê¸° ìœ ì§€ (Q2: Option A) */
.scene-canvas::after {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.3) 50%);
  background-size: 100% 4px;
  pointer-events: none;
  z-index: 5;
  animation: flicker 0.15s infinite;
}

/* Economy HUD ë° ê¸°íƒ€ Critical í…ìŠ¤íŠ¸ ë³´í˜¸ */
.currency-value,
.action-card-cost {
  position: relative;
  z-index: 2;
  font-family: var(--font-micro-en);
  text-shadow: 0 0 2px rgba(51, 255, 0, 0.3);
}

/* U-037: pending ìƒíƒœ - ë°ì€ ìƒ‰ìƒ + ë°°ê²½ ëŒ€ë¹„ */
.phase-item.pending {
  color: var(--text-color);
  background-color: rgba(0, 20, 0, 0.5);
  border-color: rgba(51, 255, 0, 0.3);
  opacity: 0.8;
}

/* U-087: ë‘ ë²ˆì§¸ in_progress ì •ì˜ëŠ” ì²« ë²ˆì§¸ì™€ í†µí•©ë¨ - animationë§Œ ìœ ì§€ */
.phase-item.in_progress,
.phase-item.in-progress {
  color: var(--accent-color);
  background-color: rgba(40, 0, 40, 0.5);
  border-color: var(--accent-color);
  box-shadow: 0 0 5px var(--accent-color);
}

.phase-item.completed {
  color: var(--text-color);
  background-color: rgba(0, 30, 0, 0.5);
  border-color: var(--text-color);
}

.phase-item.failed {
  color: var(--error-color);
  background-color: rgba(40, 0, 0, 0.5);
  border-color: var(--error-color);
}

.phase-icon {
  font-size: 0.5rem;
}

.phase-icon.in-progress {
  animation: spin 2s linear infinite;
}

/* U-087: in_progress ë‹¨ê³„ ë¶€ë“œëŸ¬ìš´ glow (pulse ê¹œë¹¡ì„ ëŒ€ì²´) */
@keyframes phase-glow {
  0%,
  100% {
    box-shadow: 0 0 5px rgba(255, 0, 255, 0.4);
  }
  50% {
    box-shadow: 0 0 14px rgba(255, 0, 255, 0.7);
  }
}

@keyframes spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

.phase-label {
  white-space: nowrap;
}

/* ë°°ì§€ íŒ¨ë„ */
.badges-panel {
  padding: var(--spacing-xs);
  border-top: 1px solid var(--text-dim);
}

.badges-panel .badges-label {
  font-size: 0.625rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-dim);
  margin-bottom: var(--spacing-xs);
}

.badges-panel .badges-empty {
  color: var(--text-color);
  font-size: 0.8125rem; /* 13pxë¡œ ìƒí–¥ */
  font-weight: 500;
  text-align: center;
  padding: var(--spacing-sm);
  opacity: 0.9;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 1);
  position: relative;
  z-index: 2;
}

/* ë°°ì§€ ê·¸ë¦¬ë“œ ê°€ë…ì„± ìƒí–¥ (U-037) */
.badge-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 4px 6px;
  background-color: rgba(0, 20, 0, 0.9);
  border: 1px solid var(--text-dim);
  font-family: var(--font-micro-en);
  font-size: 0.75rem;
  z-index: 2;
  position: relative;
}

.badge-label {
  color: var(--text-color);
  opacity: 0.8;
}

.badge-status {
  font-weight: bold;
  text-transform: uppercase;
}

/* Auto-repair íŠ¸ë ˆì´ìŠ¤ */
.repair-trace {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  padding: var(--spacing-xs);
  border-top: 1px solid var(--text-dim);
  font-size: 0.625rem;
}

.repair-trace .repair-label {
  color: var(--text-dim);
}

.repair-trace .repair-count {
  color: var(--warning-color);
  font-weight: bold;
}

.repair-trace .repair-status {
  color: var(--warning-color);
  font-size: 0.5rem;
}

/* ì—ëŸ¬ í‘œì‹œ */
.agent-error {
  display: flex;
  align-items: flex-start;
  gap: var(--spacing-xs);
  padding: var(--spacing-xs);
  background-color: rgba(255, 51, 51, 0.1);
  border: 1px solid var(--error-color);
  font-size: 0.625rem;
}

.agent-error .error-icon {
  color: var(--error-color);
}

.agent-error .error-message {
  color: var(--error-color);
  flex: 1;
  word-break: break-word;
}

.agent-error .error-code {
  color: var(--text-dim);
  font-size: 0.5rem;
}

/* ============================================
   17. ë‚´ëŸ¬í‹°ë¸Œ ìŠ¤íŠ¸ë¦¬ë° íš¨ê³¼
   ============================================ */

.narrative-entry.streaming {
  opacity: 0.8;
}

.cursor-blink {
  animation: blink 1s infinite;
  color: var(--accent-color);
}

@keyframes blink {
  0%,
  50% {
    opacity: 1;
  }
  51%,
  100% {
    opacity: 0;
  }
}

/* ============================================
   17.2 U-086: ì´ë¯¸ì§€ pending ìƒíƒœ ë¼ì¸
   - íƒ€ì´í•‘ ì™„ë£Œ í›„ ì´ë¯¸ì§€ ìƒì„± ëŒ€ê¸° ì¤‘ í‘œì‹œ
   - RULE-002: ê²Œì„ ë¡œê·¸ ì‹œìŠ¤í…œ ë©”ì‹œì§€ (ì±„íŒ… ë²„ë¸” ì•„ë‹˜)
   - ë‹¨ìˆœ DOM 1ê°œ (ì„±ëŠ¥)
   ============================================ */

.image-pending-line {
  padding: var(--spacing-xs) 0;
  border-bottom: none;
  opacity: 0.8;
}

.image-pending-label {
  color: var(--text-dim);
  font-size: 0.85rem;
  font-style: italic;
  text-shadow: 0 0 4px var(--text-dim);
}

.image-pending-cursor {
  animation: blink 1s infinite;
  color: var(--text-dim);
  font-size: 0.85rem;
  margin-left: 2px;
}

/* ============================================
   18. ì•¡ì…˜ ì¹´ë“œ ë¹„í™œì„±í™” ìƒíƒœ
   ============================================ */

.action-card:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  border-color: var(--text-dim);
}

.action-card:disabled:hover {
  border-color: var(--text-dim);
  box-shadow: none;
}

/* ============================================
   19. Economy HUD ì•„ì´ì½˜ (U-029: nanobanana ì—ì…‹)
   ============================================ */

.economy-hud .shard-icon {
  margin-left: var(--spacing-sm);
}

/* ì—ì…‹ ì•„ì´ì½˜ ë˜í¼ - í´ë°± íŒ¨í„´ (U-029/U-030) */
.icon-wrapper {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.icon-wrapper .icon-img {
  width: 20px;
  height: 20px;
  object-fit: contain;
  /* (U-029) ì•„ì´ì½˜ í‘œì‹œ (U-091: rembg ëŸ°íƒ€ì„ ì œê±°, í”„ë¡¬í”„íŠ¸ë¡œ ì–´ë‘ìš´ ë°°ê²½ ìœ ë„) */
  display: block;
}

.icon-wrapper .icon-img.hidden {
  display: none;
}

/* í´ë°± í…ìŠ¤íŠ¸ëŠ” ê¸°ë³¸ ìˆ¨ê¹€, ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ í‘œì‹œ */
.icon-wrapper .icon-fallback {
  display: none;
  font-size: 1rem;
}

/* ì´ë¯¸ì§€ ìˆ¨ê¹€ ì‹œ í´ë°± í‘œì‹œ */
.icon-wrapper .icon-img.hidden + .icon-fallback {
  display: inline;
}

/* Risk ë“±ê¸‰ë³„ ì•„ì´ì½˜ í•„í„°ë§ (í•„ìš” ì‹œ) */
.icon-img.risk-low {
  filter: drop-shadow(0 0 2px var(--text-color));
}

.icon-img.risk-high {
  filter: drop-shadow(0 0 2px var(--error-color));
}

/* ë°°ì§€ ì•„ì´ì½˜ (Agent Console) */
.badge-icon-img {
  width: 14px;
  height: 14px;
  object-fit: contain;
  vertical-align: middle;
  margin-right: 2px;
}

/* ============================================
   20. Flex ìœ í‹¸ë¦¬í‹°
   ============================================ */

.flex-1 {
  flex: 1;
}

/* ============================================
   21. ê°€ë…ì„± ë³´í˜¸ í´ë˜ìŠ¤ (U-057: í…ìŠ¤íŠ¸ ë²ˆì§ ì‹ë³„ì„± ê°œì„ )
   - í˜ì–´ë§ ê²°ì •:
     - Q1 Option A: ë³¸ë¬¸ í…ìŠ¤íŠ¸ë§Œ ë³´í˜¸, ì œëª©/ë¼ë²¨ì€ ê¸€ë¡œìš° ìœ ì§€
     - Q2 Option B: 1px ë¯¸ë§Œì˜ ë¯¸ì„¸ ê¸€ë¡œìš° (ë¶„ìœ„ê¸° ìœ ì§€ + ê°€ë…ì„±)
     - Q3 Option A: 12px ì´í•˜ í…ìŠ¤íŠ¸ë§Œ font-weight ìƒí–¥
   ============================================ */

/* ê°€ë…ì„± ìš°ì„  ì˜ì—­ - CRT íš¨ê³¼ ì™„ì „ ì œê±° */
.readable-text {
  text-shadow: none !important;
  filter: none !important;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* ë¶„ìœ„ê¸° ìœ ì§€í•˜ë©´ì„œ ê°€ë…ì„± í™•ë³´ - ë¯¸ì„¸í•œ ê¸€ë¡œìš°ë§Œ */
.readable-glow {
  text-shadow: 0 0 0.5px currentColor !important;
  filter: none !important;
  -webkit-font-smoothing: antialiased;
}

/* ì¤‘ìš” í…ìŠ¤íŠ¸ ê°•ì¡° - ì•½ê°„ì˜ ê¸€ë¡œìš° */
.readable-emphasis {
  text-shadow: 0 0 2px rgba(51, 255, 0, 0.3) !important;
  filter: none !important;
}

/* ì‘ì€ í…ìŠ¤íŠ¸ ê°€ë…ì„± ë³´ì • (12px ì´í•˜) - Q3 Option A */
.readable-small {
  font-weight: 500;
  letter-spacing: 0.02em;
  -webkit-font-smoothing: antialiased;
}

/* ============================================
   21.0.0 ë³¸ë¬¸/ì„¤ëª… í…ìŠ¤íŠ¸ ê°€ë…ì„± (U-057)
   - Q1 Option A: ë³¸ë¬¸ í…ìŠ¤íŠ¸ë§Œ ë³´í˜¸, ì œëª©/ë¼ë²¨ì€ ê¸€ë¡œìš° ìœ ì§€
   - p, span, ì„¤ëª… í…ìŠ¤íŠ¸ëŠ” íš¨ê³¼ ì œê±°/ì™„í™”
   ============================================ */

/* ë³¸ë¬¸/ì„¤ëª… í…ìŠ¤íŠ¸ - íš¨ê³¼ ìµœì†Œí™” */
.narrative-text,
.action-card-description,
.quest-label,
.rule-card-description,
.timeline-event-description,
.scanner-caption,
.hotspot-tooltip-hint,
.ledger-reason {
  text-shadow: none;
  filter: none;
  -webkit-font-smoothing: antialiased;
}

/* ì œëª©/ë¼ë²¨ - ë¯¸ì„¸ ê¸€ë¡œìš° ìœ ì§€ (Q2 Option B: 1px ë¯¸ë§Œ) */
.game-title,
.panel-title,
.action-card-title,
.quest-section-title,
.rule-card-label,
.timeline-title,
.scanner-candidates-title {
  text-shadow: 0 0 3px rgba(51, 255, 0, 0.4);
  filter: none;
}

/* ì‘ì€ í°íŠ¸ (12px/0.75rem ì´í•˜) ê°€ë…ì„± ê°•í™” - Q3 Option A */
.action-card-cost,
.action-card-hints,
.action-card-hints .hint-text,
.action-card-badge,
.card-disabled-overlay .disabled-reason,
.narrative-timestamp,
.phase-queue .queue-label,
.agent-queue-always .queue-label,
.badges-panel .badges-label,
.repair-trace .repair-label,
.repair-trace .repair-status,
.agent-error .error-code,
.timeline-event-turn,
.timeline-event-type,
.ledger-model,
.scanner-stats,
.scanner-candidate-type,
.cost-label,
.timeline-more-text {
  font-weight: 500;
  letter-spacing: 0.02em;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* ============================================
   21.0.1 ì¤‘ìš”ë„ ê¸°ë°˜ ë ˆì´ì–´ë§ (U-037: critical/ambient)
   - critical: ì–´ë‘ìš´ ë°°ê²½/íŒ¨ë„ ë‚´ë¶€ì˜ ì‘ì€ í…ìŠ¤íŠ¸ (ë§ˆì´í¬ë¡œ í…ìŠ¤íŠ¸)
   - ambient: ë¶„ìœ„ê¸°/ì¥ì‹, ë¡œê³ /íƒ€ì´í‹€/íŒ¨ë„ í—¤ë” (ê¸°ë³¸ ìŠ¤íƒ€ì¼)
   - Scene Canvas ì¤‘ì‹¬ìœ¼ë¡œ CRT ë¶„ìœ„ê¸° ì§‘ì¤‘ (Q2: Option A)
   ============================================ */

/*
 * Critical ì˜ì—­ ê¸°ì¤€ (U-037 ì¬ì •ì˜):
 * - ë°•ìŠ¤/íŒ¨ë„ ë‚´ë¶€ ì½˜í…ì¸  (ì–´ë‘ìš´ ë°°ê²½ ìœ„ í…ìŠ¤íŠ¸)
 * - ë§ˆì´í¬ë¡œ í…ìŠ¤íŠ¸ (0.75rem ì´í•˜: ë°°ì§€, ë¹„ìš©, íƒ€ì„ìŠ¤íƒ¬í”„ ë“±)
 * - ë°°ê²½ìƒ‰ì´ ë‹¤ì–‘í•  ìˆ˜ ìˆëŠ” ì˜ì—­ (ì—ëŸ¬ ë°•ìŠ¤ ë“±)
 *
 * Non-Critical (ê¸°ë³¸ ìŠ¤íƒ€ì¼):
 * - ë¡œê³ /íƒ€ì´í‹€ (UNKNOWN WORLD) - ì¶©ë¶„íˆ í¬ê³  ë°ìŒ
 * - íŒ¨ë„ í—¤ë”/ë¼ë²¨ (INVENTORY, QUEST ë“±) - ë°ì€ ë°°ê²½
 * - ì•¡ì…˜ ì¹´ë“œ ì œëª© (íƒìƒ‰í•˜ê¸° ë“±) - ì¶©ë¶„íˆ í° í°íŠ¸
 */

/* Critical ì˜ì—­: íŒ¨ë„ ë‚´ë¶€ ì‘ì€ í…ìŠ¤íŠ¸ ê°€ë…ì„± ë³´ì¥ */
[data-ui-importance='critical'],
.ui-critical {
  /* í…ìŠ¤íŠ¸ ëŒ€ë¹„ ê°•í™” - ì–´ë‘ìš´ ë°°ê²½ì—ì„œ ì½í˜ ë³´ì¥ */
  color: var(--text-color);
  text-shadow:
    0 0 2px var(--text-color),
    0 1px 1px rgba(0, 0, 0, 0.9);
}

/* Critical ì˜ì—­ ë‚´ ë³´ì¡° í…ìŠ¤íŠ¸(dim)ë„ ê°€ë…ì„± ë³´ì¥ */
[data-ui-importance='critical'] .text-dim,
.ui-critical .text-dim {
  color: var(--text-dim);
  text-shadow: 0 1px 1px rgba(0, 0, 0, 0.9);
}

/* Ambient ì˜ì—­: CRT ë¶„ìœ„ê¸° í—ˆìš© (ê¸°ë³¸ê°’) */
[data-ui-importance='ambient'],
.ui-ambient {
  /* ê¸°ë³¸ CRT ìŠ¤íƒ€ì¼ ìœ ì§€ - ë¡œê³ /íƒ€ì´í‹€/íŒ¨ë„ í—¤ë” */
}

/* ============================================
   21.1 ë§ˆì´í¬ë¡œ í…ìŠ¤íŠ¸ Critical ì ìš© (ì‘ì€ í°íŠ¸)
   - 0.75rem ì´í•˜ í…ìŠ¤íŠ¸ëŠ” ìë™ Critical
   ============================================ */

/* Action Card ë¹„ìš©/ìœ„í—˜ ì •ë³´ (ì‘ì€ í…ìŠ¤íŠ¸, ì–´ë‘ìš´ ì¹´ë“œ ë°°ê²½) */
/* U-057: ê¸€ë¡œìš° ì™„í™” - ì‘ì€ í…ìŠ¤íŠ¸ ê°€ë…ì„± ìš°ì„  */
.action-card-cost {
  text-shadow: 0 1px 1px rgba(0, 0, 0, 0.9);
  -webkit-font-smoothing: antialiased;
}

/* ì—ëŸ¬/ì°¨ë‹¨ ë©”ì‹œì§€ (ë°°ê²½ìƒ‰ ë‹¤ì–‘, ì¤‘ìš” ì •ë³´) */
/* U-057: ì—ëŸ¬ ë©”ì‹œì§€ë„ ê°€ë…ì„± ìš°ì„  */
.agent-error {
  text-shadow: 0 1px 1px rgba(0, 0, 0, 0.9);
  -webkit-font-smoothing: antialiased;
}

/* ë°°ì§€ ìƒíƒœ í…ìŠ¤íŠ¸ (ì‘ì€ í°íŠ¸, íŒ¨ë„ ë‚´ë¶€) */
/* U-057: ì‘ì€ í…ìŠ¤íŠ¸ëŠ” ê¸€ë¡œìš° ì œê±° */
.badge-status {
  text-shadow: none;
  -webkit-font-smoothing: antialiased;
}

/* ë‚´ëŸ¬í‹°ë¸Œ íƒ€ì„ìŠ¤íƒ¬í”„ (ì‘ì€ í°íŠ¸) */
/* U-057: íƒ€ì„ìŠ¤íƒ¬í”„ ê°€ë…ì„± ê°œì„  */
.narrative-timestamp {
  text-shadow: none;
  font-weight: 500;
  -webkit-font-smoothing: antialiased;
}

/* ë³µêµ¬ íŠ¸ë ˆì´ìŠ¤ (ì‘ì€ í°íŠ¸, ê²½ê³  ì •ë³´) */
/* U-057: ì‘ì€ í…ìŠ¤íŠ¸ ê¸€ë¡œìš° ì œê±° */
.repair-trace .repair-count {
  text-shadow: none;
  font-weight: 600;
  -webkit-font-smoothing: antialiased;
}

/* ============================================
   21.1 Scene Canvas ì¤‘ì‹¬ CRT ë¶„ìœ„ê¸° (Q2: Option A)
   - ì „ì—­ ì˜¤ë²„ë ˆì´ ëŒ€ì‹  Scene Canvasì— íš¨ê³¼ ì§‘ì¤‘
   ============================================ */

/* ì „ì—­ CRT ì˜¤ë²„ë ˆì´: ê°•ë„ ì•½í™” (critical ì˜ì—­ ë³´í˜¸) - U-050: 0.3 â†’ 0.25 */
.crt-overlay {
  opacity: 0.25;
}

/* Scene Canvas: CRT ë¶„ìœ„ê¸° ê°•í™” (ambient ì˜ì—­) */
.scene-canvas {
  position: relative;
}

/* U-050 v5: Scene Canvas CRT íš¨ê³¼ - ìŠ¤ìº”ë¼ì¸ ê°•ì¡°, ê¹œë¹¡ì„ ì™„í™” */
.scene-canvas::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  /* ìŠ¤ìº”ë¼ì¸: ì ë‹¹íˆ */
  background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.4) 50%);
  background-size: 100% 2px;
  pointer-events: none;
  z-index: 1;
  /* í”Œë¦¬ì»¤: ëŠë¦¬ê²Œ */
  animation: flicker 0.5s infinite;
  opacity: 0.8;
}

/* Scene Canvas placeholderëŠ” ë¶„ìœ„ê¸° ìœ ì§€í•˜ë©´ì„œ í…ìŠ¤íŠ¸ ì½í˜ ë³´ì¥ */
.scene-placeholder {
  position: relative;
  z-index: 2;
}

/* ============================================
   22. ë§ˆì´í¬ë¡œ í…ìŠ¤íŠ¸ ê°€ë…ì„± ìƒí–¥ (U-028â†’U-037)
   - 0.625rem â†’ --font-size-xs (0.75rem)
   - Critical ì˜ì—­ì€ ìë™ ê°€ë…ì„± ë³´ì¥
   ============================================ */

/* Agent Console ê¸°ë³¸ í°íŠ¸ ìƒí–¥ */
.agent-console-content {
  font-size: var(--font-size-xs);
}

/* í ë¼ë²¨ í°íŠ¸ ìƒí–¥ */
.phase-queue .queue-label,
.agent-queue-always .queue-label {
  font-size: calc(var(--font-size-xs) * 0.85);
}

/* ë‹¨ê³„ ì•„ì´í…œ í°íŠ¸ ìƒí–¥ */
.phase-item {
  font-size: calc(var(--font-size-xs) * 0.85);
}

/* ë°°ì§€ íŒ¨ë„ ë¼ë²¨ ìƒí–¥ */
.badges-panel .badges-label {
  font-size: calc(var(--font-size-xs) * 0.85);
}

.badges-panel .badges-empty {
  font-size: calc(var(--font-size-xs) * 0.85);
}

/* ë°°ì§€ ì•„ì´í…œ ìƒí–¥ */
.badge-item {
  font-size: calc(var(--font-size-xs) * 0.85);
}

/* ë³µêµ¬ íŠ¸ë ˆì´ìŠ¤ ìƒí–¥ */
.repair-trace {
  font-size: calc(var(--font-size-xs) * 0.85);
}

.repair-trace .repair-status {
  font-size: calc(var(--font-size-xs) * 0.7);
}

/* ì—ëŸ¬ í‘œì‹œ ìƒí–¥ */
.agent-error {
  font-size: calc(var(--font-size-xs) * 0.85);
}

.agent-error .error-code {
  font-size: calc(var(--font-size-xs) * 0.7);
}

/* ë‚´ëŸ¬í‹°ë¸Œ íƒ€ì„ìŠ¤íƒ¬í”„ ìƒí–¥ */
.narrative-timestamp {
  font-size: var(--font-size-xs);
}

/* ë‹¨ê³„ ì•„ì´ì½˜ ìƒí–¥ */
.phase-icon {
  font-size: calc(var(--font-size-xs) * 0.7);
}

/* ============================================
   22.1 ì ‘ê·¼ì„± ê°€ë“œ (U-037: prefers-reduced-motion)
   - ê´‘ê³¼ë¯¼/í”¼ë¡œ ë°©ì§€ë¥¼ ìœ„í•œ ìë™ ì™„í™”
   ============================================ */

@media (prefers-reduced-motion: reduce) {
  /* í”Œë¦¬ì»¤ ì• ë‹ˆë©”ì´ì…˜ ë¹„í™œì„±í™” - U-050: opacity ë” ë‚®ì¶¤ */
  .crt-overlay {
    animation: none;
    opacity: 0.12;
  }

  .scene-canvas::after {
    animation: none;
    opacity: 0.2;
  }

  /* ê¸€ë¦¬ì¹˜ íš¨ê³¼ ë¹„í™œì„±í™” */
  .glitch::before,
  .glitch::after {
    animation: none;
    opacity: 0;
  }

  /* í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ ë¹„í™œì„±í™” */
  .status-indicator {
    animation: none;
  }

  .streaming-status .status-dot.active {
    animation: none;
  }

  .phase-item.in_progress,
  .phase-item.in-progress {
    animation: none;
  }

  /* ë¡œë”© í„ìŠ¤ ë¹„í™œì„±í™” */
  .scene-canvas.scene-status-loading .scene-placeholder {
    animation: none;
  }

  /* ìŠ¤íƒœí‹± ë…¸ì´ì¦ˆ ë¹„í™œì„±í™” */
  .scene-canvas.scene-status-offline::before {
    animation: none;
    opacity: 0.2;
  }

  /* ì»¤ì„œ ê¹œë¹¡ì„ ì •ì  í‘œì‹œ */
  .cursor-blink {
    animation: none;
    opacity: 1;
  }

  /* U-086: ì´ë¯¸ì§€ pending ì»¤ì„œ ì• ë‹ˆë©”ì´ì…˜ ë¹„í™œì„±í™” */
  .image-pending-cursor {
    animation: none;
    opacity: 0.7;
  }

  /* ìŠ¤í•€ ì• ë‹ˆë©”ì´ì…˜ ë¹„í™œì„±í™” */
  .phase-icon.in-progress {
    animation: none;
  }
}

/* ============================================
   22.2 ê³ ëŒ€ë¹„ ëª¨ë“œ ì§€ì› (prefers-contrast)
   ============================================ */

@media (prefers-contrast: more) {
  /* Critical í…ìŠ¤íŠ¸ ëŒ€ë¹„ ì¶”ê°€ ìƒí–¥ */
  [data-ui-importance='critical'],
  .ui-critical,
  .economy-hud,
  .action-card-title,
  .action-card-cost {
    text-shadow:
      0 0 4px var(--text-color),
      0 2px 2px rgba(0, 0, 0, 1);
  }

  /* ë°°ê²½ ëŒ€ë¹„ ê°•í™” */
  .panel-content,
  .narrative-feed {
    background-color: rgba(0, 0, 0, 0.9);
  }

  /* í…Œë‘ë¦¬ ëŒ€ë¹„ ê°•í™” */
  .panel,
  .action-card {
    border-width: 2px;
  }
}

/* ============================================
   22.3 Economy HUD ìŠ¤íƒ€ì¼ (U-014)
   - RULE-005: ì˜ˆìƒ ë¹„ìš©/í™•ì • ë¹„ìš©/ì”ì•¡ ë¶€ì¡± í‘œì‹œ
   ============================================ */

/* Economy HUD ì»¨í…Œì´ë„ˆ */
.economy-hud {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-xs) var(--spacing-sm);
  border: 1px solid var(--text-dim);
  background-color: rgba(0, 0, 0, 0.5);
}

.economy-hud-full {
  flex: 1; /* U-099: ê°€ìš© ê³µê°„ì„ ì±„ì›Œ í•˜ë‹¨ ì—¬ë°± ê³¼ë‹¤ í•´ì†Œ */
  display: flex;
  flex-direction: column;
  align-items: stretch;
  padding: var(--spacing-sm);
  gap: var(--spacing-sm);
  min-height: 0; /* U-049: flex ìì‹ ì¶•ì†Œ í—ˆìš© */
}

/* ì”ì•¡ ë¶€ì¡± ì‹œ ê²½ê³  ìŠ¤íƒ€ì¼ */
.economy-hud.economy-hud-low,
.economy-hud-low {
  border-color: var(--warning-color);
  background-color: rgba(255, 170, 0, 0.1);
}

/* ì”ì•¡ í‘œì‹œ */
.economy-balance {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  flex-wrap: wrap;
}

.economy-balance.balance-low {
  animation: balance-warning-pulse 1.5s ease-in-out infinite;
}

@keyframes balance-warning-pulse {
  0%,
  100% {
    opacity: 1;
  }
  50% {
    opacity: 0.7;
  }
}

.balance-item {
  display: flex;
  align-items: center;
  gap: 4px;
}

/* U-082: ì”ì•¡ í°íŠ¸ ì‚¬ì´ì¦ˆ í™•ëŒ€ (ê°€ì‹œì„± ê°•í™”) */
.balance-value {
  font-family: var(--font-micro-en);
  font-weight: bold;
  font-size: 1.25rem; /* U-082: var(--font-size-sm) â†’ 1.25rem í™•ëŒ€ */
}

.balance-label {
  font-size: var(--font-size-xs);
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* ì”ì•¡ ë¶€ì¡± ê²½ê³  */
.balance-warning {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-left: var(--spacing-xs);
  padding: 2px 6px;
  background-color: rgba(255, 170, 0, 0.2);
  border: 1px solid var(--warning-color);
  border-radius: 2px;
}

.balance-warning .warning-icon {
  color: var(--warning-color);
}

.balance-warning .warning-text {
  font-size: var(--font-size-xs);
  color: var(--warning-color);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.balance-warning-icon {
  color: var(--warning-color);
  margin-left: var(--spacing-xs);
  animation: blink 1s infinite;
}

/* ë¹„ìš© í‘œì‹œ */
.economy-cost {
  padding: var(--spacing-xs);
  background-color: rgba(0, 20, 0, 0.8);
  border: 1px solid var(--text-dim);
  border-radius: 2px;
}

.economy-cost.cost-estimate {
  border-color: var(--accent-color);
  border-style: dashed;
}

.economy-cost.cost-confirmed {
  border-color: var(--text-color);
}

.economy-cost.cost-unaffordable {
  border-color: var(--error-color);
  background-color: rgba(255, 51, 51, 0.1);
}

.cost-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: var(--spacing-xs);
}

.cost-title {
  font-size: var(--font-size-xs);
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.cost-label {
  font-size: 0.625rem;
  color: var(--accent-color);
  padding: 1px 4px;
  background-color: rgba(255, 0, 255, 0.1);
  border: 1px solid var(--accent-color);
  border-radius: 2px;
}

.cost-values {
  display: flex;
  align-items: center;
  gap: 4px;
  flex-wrap: wrap;
}

.cost-item {
  display: inline-flex;
  align-items: center;
  gap: 2px;
}

.cost-separator {
  color: var(--text-dim);
  margin: 0 2px;
}

/* U-082: ë¹„ìš© í°íŠ¸ ì‚¬ì´ì¦ˆ í™•ëŒ€ */
.cost-value {
  font-family: var(--font-micro-en);
  font-weight: bold;
  font-size: 1rem; /* U-082: í™•ëŒ€ */
  color: var(--warning-color);
}

.cost-warning {
  margin-top: var(--spacing-xs);
  padding: 2px 4px;
  background-color: rgba(255, 51, 51, 0.2);
  border-radius: 2px;
}

.cost-warning .warning-text {
  font-size: var(--font-size-xs);
  color: var(--error-color);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* ì˜ˆìƒ ë¹„ìš© ë¯¸ë‹ˆ í‘œì‹œ (í—¤ë”ìš©) */
.economy-estimate-mini {
  display: inline-flex;
  align-items: center;
  gap: 2px;
  margin-left: var(--spacing-xs);
  padding: 1px 6px;
  background-color: rgba(255, 0, 255, 0.1);
  border: 1px dashed var(--accent-color);
  border-radius: 2px;
  font-family: var(--font-micro-en);
  font-size: var(--font-size-xs);
  color: var(--accent-color);
}

.economy-estimate-mini.unaffordable {
  border-color: var(--error-color);
  background-color: rgba(255, 51, 51, 0.1);
  color: var(--error-color);
}

.estimate-prefix {
  opacity: 0.7;
}

.estimate-value {
  font-weight: bold;
}

/* ëŒ€ì•ˆ ì•ˆë‚´ */
.economy-alternatives {
  padding: var(--spacing-sm);
  background-color: rgba(51, 255, 0, 0.05);
  border: 1px dashed var(--text-color);
  border-radius: 2px;
}

.alternatives-header {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  margin-bottom: var(--spacing-xs);
}

.alternatives-icon {
  font-size: 1rem;
}

.alternatives-title {
  font-size: var(--font-size-xs);
  color: var(--text-color);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.alternatives-list {
  list-style: none;
  padding-left: calc(1rem + var(--spacing-xs));
}

.alternatives-list li {
  font-size: var(--font-size-xs);
  color: var(--text-dim);
  line-height: 1.5;
}

.alternatives-list li::before {
  content: 'â€¢ ';
  color: var(--text-color);
}

/* ===========================================
   22.4 Economy Ledger ìŠ¤íƒ€ì¼ (U-049)
   - ê±°ë˜ ì¥ë¶€ ì˜ì—­ë§Œ ë‚´ë¶€ ìŠ¤í¬ë¡¤
   - ì”ì•¡/ë¹„ìš© ì˜ì—­ì€ ê³ ì •
   =========================================== */

.economy-ledger {
  display: flex;
  flex-direction: column;
  min-height: 0; /* U-049: flex ìì‹ ì¶•ì†Œ í—ˆìš© (í•„ìˆ˜) */
  /* U-099: flex: 1 ì ìš© â†’ ê°€ìš© ê³µê°„ì„ ì±„ì›Œ í•˜ë‹¨ ì—¬ë°± ê³¼ë‹¤ í•´ì†Œ */
  flex: 1;
  border-top: 1px solid var(--text-dim);
  margin-top: var(--spacing-sm);
  padding-top: var(--spacing-sm);
  overflow: hidden; /* ìì‹ì¸ ledger-listì˜ ìŠ¤í¬ë¡¤ ë³´ì¥ */
}

.ledger-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: var(--spacing-xs);
  flex-shrink: 0; /* U-049: í—¤ë”ëŠ” ì¶•ì†Œí•˜ì§€ ì•ŠìŒ */
}

.ledger-title {
  font-size: var(--font-size-xs);
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* U-049: ledger-listë§Œ ìŠ¤í¬ë¡¤ (í•µì‹¬) */
.ledger-list {
  display: flex;
  flex-direction: column;
  gap: 4px;
  overflow-y: auto;
  overflow-x: hidden; /* U-049: ë¶ˆí•„ìš”í•œ ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€ */
  scrollbar-width: thin; /* Firefox: ì–‡ì€ ìŠ¤í¬ë¡¤ë°” */
  min-height: 0; /* U-049: flex ìì‹ ì¶•ì†Œ í—ˆìš© */
  /* U-099: flex: 1ë¡œ í™•ì¥ í—ˆìš© + max-height ì œê±° (ë¶€ëª¨ íŒ¨ë„ í¬ê¸°ì— ë§ì¶¤) */
  flex: 1;
  padding-right: var(--spacing-xs); /* ìŠ¤í¬ë¡¤ë°” ê³µê°„ */
}

.ledger-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--spacing-xs);
  background-color: rgba(0, 20, 0, 0.5);
  border: 1px solid var(--text-dim);
  border-radius: 2px;
  font-size: var(--font-size-xs);
}

.ledger-info {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  flex: 1;
  min-width: 0;
}

.ledger-turn {
  font-family: var(--font-micro-en);
  font-weight: bold;
  color: var(--text-color);
  flex-shrink: 0;
}

.ledger-reason {
  color: var(--text-dim);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.ledger-values {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  flex-shrink: 0;
}

.ledger-cost {
  font-family: var(--font-micro-en);
  color: var(--warning-color);
  font-weight: bold;
}

.ledger-model {
  font-family: var(--font-micro-en);
  font-size: 0.625rem;
  color: var(--accent-color);
  padding: 1px 3px;
  background-color: rgba(255, 0, 255, 0.1);
  border: 1px solid var(--accent-color);
  border-radius: 2px;
}

.ledger-empty {
  font-size: var(--font-size-xs);
  color: var(--text-dim);
  text-align: center;
  padding: var(--spacing-sm);
}

/* reduced-motion: ê²½ê³  ì• ë‹ˆë©”ì´ì…˜ ë¹„í™œì„±í™” */
@media (prefers-reduced-motion: reduce) {
  .economy-balance.balance-low {
    animation: none;
  }

  .balance-warning-icon {
    animation: none;
    opacity: 1;
  }
}

/* ============================================
   23. UI ìŠ¤ì¼€ì¼ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (U-028â†’U-037)
   ============================================ */

.ui-controls {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
}

.ui-scale-btn {
  background: transparent;
  color: var(--text-color);
  border: 1px solid var(--text-dim);
  padding: 2px 6px;
  font-family: var(--font-main);
  font-size: var(--font-size-xs);
  cursor: pointer;
  text-transform: uppercase;
  transition:
    border-color 0.2s,
    color 0.2s,
    box-shadow 0.2s;
  min-width: 28px;
  text-align: center;
}

.ui-scale-btn:hover {
  border-color: var(--accent-color);
  color: var(--accent-color);
}

.ui-scale-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.ui-scale-btn:disabled:hover {
  border-color: var(--text-dim);
  color: var(--text-dim);
}

.ui-scale-display {
  font-size: var(--font-size-xs);
  color: var(--text-dim);
  min-width: 32px;
  text-align: center;
}

/* ============================================
   24. UI Chrome Pack (U-032)
   - íŒ¨ë„/ì¹´ë“œì— ì ìš©ë˜ëŠ” ì¥ì‹(ì½”ë„ˆ/í”„ë ˆì„)
   - Readable ëª¨ë“œì—ì„œ ì™„í™”
   ============================================ */

/* Chrome ì—ì…‹ ê²½ë¡œ ë³€ìˆ˜ */
:root {
  --chrome-panel-corner: url('/ui/chrome/panel-corner-br.png');
  --chrome-card-frame: url('/ui/chrome/card-frame.png');
  --chrome-scanner-frame: url('/ui/chrome/scanner-frame.png');
  --chrome-corner-size: 32px;
  --chrome-glow-color: rgba(51, 255, 0, 0.3);
}

/* Game Header Chrome - ìƒë‹¨ ì½”ë„ˆ (U-032) */
.game-header.has-chrome {
  position: relative;
}

.game-header.has-chrome::before,
.game-header.has-chrome::after {
  content: '';
  position: absolute;
  width: var(--chrome-corner-size);
  height: var(--chrome-corner-size);
  background-image: var(--chrome-panel-corner);
  background-size: contain;
  background-repeat: no-repeat;
  pointer-events: none;
  opacity: 0.9;
  filter: drop-shadow(0 0 5px var(--chrome-glow-color));
  z-index: 2;
}

.game-header.has-chrome::before {
  top: -2px;
  left: -2px;
  transform: rotate(90deg);
}

.game-header.has-chrome::after {
  top: -2px;
  right: -2px;
  transform: rotate(180deg);
}

/* Panel Header Chrome - ì½”ë„ˆ ì¥ì‹ (4ë°©í–¥ CSS transform) */
.panel-header.has-chrome {
  position: relative;
}

.panel-header.has-chrome::before,
.panel-header.has-chrome::after {
  content: '';
  position: absolute;
  width: var(--chrome-corner-size);
  height: var(--chrome-corner-size);
  background-image: var(--chrome-panel-corner);
  background-size: contain;
  background-repeat: no-repeat;
  pointer-events: none;
  opacity: 0.8;
  filter: drop-shadow(0 0 4px var(--chrome-glow-color));
}

/* ì¢Œìƒë‹¨ ì½”ë„ˆ */
.panel-header.has-chrome::before {
  top: -2px;
  left: -2px;
  transform: rotate(90deg);
}

/* ìš°ìƒë‹¨ ì½”ë„ˆ */
.panel-header.has-chrome::after {
  top: -2px;
  right: -2px;
  transform: rotate(180deg);
}

/* Panel Chrome - í•˜ë‹¨ ì½”ë„ˆìš© ë˜í¼ */
.panel.has-chrome {
  position: relative;
}

.panel.has-chrome .panel-content {
  position: relative;
}

.panel.has-chrome .panel-content::before,
.panel.has-chrome .panel-content::after {
  content: '';
  position: absolute;
  width: var(--chrome-corner-size);
  height: var(--chrome-corner-size);
  background-image: var(--chrome-panel-corner);
  background-size: contain;
  background-repeat: no-repeat;
  pointer-events: none;
  opacity: 0.6;
  filter: drop-shadow(0 0 3px var(--chrome-glow-color));
}

/* ì¢Œí•˜ë‹¨ ì½”ë„ˆ */
.panel.has-chrome .panel-content::before {
  bottom: 0;
  left: -2px;
  transform: rotate(0deg);
}

/* ìš°í•˜ë‹¨ ì½”ë„ˆ (ì›ë³¸ ë°©í–¥) */
.panel.has-chrome .panel-content::after {
  bottom: 0;
  right: -2px;
  transform: rotate(270deg);
}

/* Action Card Chrome - í”„ë ˆì„ ì˜¤ë²„ë ˆì´ */
.action-card.has-chrome {
  position: relative;
  overflow: visible;
}

.action-card.has-chrome::before {
  content: '';
  position: absolute;
  top: -4px;
  left: -4px;
  right: -4px;
  bottom: -4px;
  background-image: var(--chrome-card-frame);
  background-size: 100% 100%;
  background-repeat: no-repeat;
  pointer-events: none;
  /* U-049: ë°°ê²½ íˆ¬ëª…ë„ ë‚®ì¶°ì„œ í…ìŠ¤íŠ¸ ê°€ë…ì„± í–¥ìƒ */
  opacity: 0.4;
  filter: drop-shadow(0 0 6px var(--chrome-glow-color));
  /* U-049: z-indexë¥¼ ë‚®ì¶°ì„œ í…ìŠ¤íŠ¸ ë’¤ì— ìœ„ì¹˜ */
  z-index: 0;
}

/* U-049: ì¹´ë“œ ë‚´ìš©ì€ chrome ë°°ê²½ ìœ„ì— í‘œì‹œ */
.action-card.has-chrome > * {
  position: relative;
  z-index: 1;
}

/* Scanner Slot Chrome - ì¥ì‹ í”„ë ˆì„ (U-032) */
.scanner-slot.has-chrome {
  position: relative;
  min-height: 100px;
  border: 1px dashed var(--text-dim);
  display: flex;
  align-items: center;
  justify-content: center;
  margin: var(--spacing-md) var(--spacing-sm);
  background-color: rgba(0, 0, 0, 0.4);
}

/* ============================================
   31. Scanner Slot ìŠ¤íƒ€ì¼ (U-022[Mvp])
   - PRD 6.7: ì´ë¯¸ì§€ ë“œë/ì—…ë¡œë“œ â†’ ì•„ì´í…œí™”
   - RULE-002: ê²Œì„ UIë¡œ ìƒì‹œ ë…¸ì¶œ
   - Q1 Option B: ì‚¬ìš©ì í™•ì¸ í›„ ì¸ë²¤í† ë¦¬ ì¶”ê°€
   ============================================ */

.scanner-slot-container {
  position: relative;
  display: flex;
  flex-direction: column;
  gap: var(--spacing-sm);
  min-height: 120px;
  padding: var(--spacing-xs);
  overflow: visible;
}

/* ë“œëì¡´ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
.scanner-dropzone {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-xs);
  min-height: 100px;
  padding: var(--spacing-md);
  border: 2px dashed var(--text-dim);
  border-radius: var(--border-radius);
  background-color: rgba(0, 20, 0, 0.5);
  /* ê²©ì ë¬´ëŠ¬ ë°°ê²½ ì¶”ê°€ (ê¸°ì¡´ ë°°ê²½ì˜ ëŠë‚Œì„ ê³„ìŠ¹) */
  background-image:
    linear-gradient(rgba(0, 255, 0, 0.05) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0, 255, 0, 0.05) 1px, transparent 1px);
  background-size: 20px 20px;
  cursor: pointer;
  transition:
    border-color 0.2s,
    background-color 0.2s,
    box-shadow 0.2s;
  position: relative;
  overflow: hidden;
}

/* ìŠ¤ìº”ë¼ì¸ ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€ (ì¥ì¹˜ ëŠë‚Œ) */
.scanner-dropzone::after {
  content: '';
  position: absolute;
  top: -100%;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(to bottom, transparent, rgba(0, 255, 0, 0.05) 50%, transparent);
  animation: scanning-idle 4s linear infinite;
  pointer-events: none;
}

@keyframes scanning-idle {
  0% {
    top: -100%;
  }
  100% {
    top: 100%;
  }
}

.scanner-dropzone:hover:not(.disabled) {
  border-color: var(--text-color);
  background-color: rgba(0, 30, 0, 0.6);
  background-image:
    linear-gradient(rgba(0, 255, 0, 0.08) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0, 255, 0, 0.08) 1px, transparent 1px);
}

.scanner-dropzone:focus-visible {
  outline: 2px solid var(--accent-color);
  outline-offset: 2px;
}

/* ë“œë˜ê·¸ ì˜¤ë²„ ìƒíƒœ */
.scanner-dropzone.drag-over {
  border-color: var(--accent-color);
  background-color: rgba(40, 0, 40, 0.4);
  box-shadow:
    0 0 15px var(--accent-color),
    inset 0 0 10px rgba(255, 0, 255, 0.1);
}

/* ë¹„í™œì„±í™” ìƒíƒœ */
.scanner-dropzone.disabled {
  cursor: not-allowed;
  opacity: 0.5;
  border-color: var(--text-dim);
}

.scanner-dropzone.disabled:hover {
  border-color: var(--text-dim);
  background-color: rgba(0, 20, 0, 0.5);
}

.scanner-dropzone-icon {
  font-size: 2rem;
  opacity: 0.8;
}

.scanner-dropzone-text {
  font-size: var(--font-size-sm);
  color: var(--text-color);
  text-transform: uppercase;
  letter-spacing: 1px;
  text-align: center;
}

.scanner-dropzone-hint {
  font-size: var(--font-size-xs);
  color: var(--text-dim);
  text-align: center;
  min-height: 1.2em; /* U-072: ë¹ˆ ìƒíƒœì—ì„œë„ ë†’ì´ ìœ ì§€í•˜ì—¬ ë ˆì´ì•„ì›ƒ ì‹œí”„íŠ¸ ë°©ì§€ */
}

/* U-072: ë“œë˜ê·¸ ì˜¤ë²„ ì‹œ ìˆ¨ê¹€ - visibilityë¡œ ê³µê°„ ìœ ì§€í•˜ì—¬ ë ˆì´ì•„ì›ƒ ì‹œí”„íŠ¸ ë°©ì§€ */
.scanner-dropzone-hint.hidden {
  visibility: hidden;
}

/* í”„ë¦¬ë·° ì´ë¯¸ì§€ */
.scanner-preview {
  width: 100%;
  max-height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid var(--text-dim);
  border-radius: 2px;
  overflow: hidden;
  background-color: rgba(0, 0, 0, 0.5);
}

.scanner-preview-img {
  max-width: 100%;
  max-height: 80px;
  object-fit: contain;
}

.scanner-preview-small {
  width: 48px;
  height: 48px;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid var(--text-dim);
  border-radius: 2px;
  overflow: hidden;
  background-color: rgba(0, 0, 0, 0.5);
}

.scanner-preview-img-small {
  max-width: 100%;
  max-height: 100%;
  object-fit: cover;
}

/* ë¡œë”© ìƒíƒœ */
.scanner-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-md);
}

.scanner-loading-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--spacing-xs);
}

.scanner-loading-spinner {
  width: 24px;
  height: 24px;
  border: 3px solid var(--text-dim);
  border-top-color: var(--accent-color);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.scanner-loading-text {
  font-size: var(--font-size-sm);
  color: var(--accent-color);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* ì—ëŸ¬ ìƒíƒœ */
.scanner-error {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-md);
}

.scanner-error-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--spacing-xs);
}

.scanner-error-icon {
  font-size: 1.5rem;
}

.scanner-error-message {
  font-size: var(--font-size-sm);
  color: var(--warning-color);
  text-align: center;
}

/* ê²°ê³¼ ìƒíƒœ */
.scanner-result {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-sm);
  padding: var(--spacing-xs);
}

/* U-095: ë‹¤ìˆ˜ ì•„ì´í…œ ë°œê²¬ í”¼ë“œë°± ë©”ì‹œì§€ */
.scanner-discovery-message {
  text-align: center;
  font-size: var(--font-sm);
  font-weight: 600;
  color: var(--color-accent, #00ff88);
  padding: var(--spacing-xs) var(--spacing-sm);
  border: 1px solid var(--color-accent-dim, rgba(0, 255, 136, 0.3));
  border-radius: var(--radius-sm, 4px);
  background: rgba(0, 255, 136, 0.08);
  animation: scanner-discovery-pulse 1.5s ease-in-out;
}

@keyframes scanner-discovery-pulse {
  0% {
    opacity: 0;
    transform: scale(0.95);
  }
  50% {
    opacity: 1;
    transform: scale(1.02);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}

.scanner-result-header {
  display: flex;
  align-items: flex-start;
  gap: var(--spacing-sm);
}

.scanner-result-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.scanner-caption {
  font-size: var(--font-size-sm);
  color: var(--text-color);
  line-height: 1.3;
}

.scanner-stats {
  font-size: var(--font-size-xs);
  color: var(--text-dim);
}

/* ì•„ì´í…œ í›„ë³´ ëª©ë¡ */
.scanner-candidates {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
}

.scanner-candidates-title {
  font-size: var(--font-size-xs);
  color: var(--text-color);
  text-transform: uppercase;
  letter-spacing: 1px;
  padding-bottom: var(--spacing-xs);
  border-bottom: 1px solid rgba(51, 255, 0, 0.2);
}

.scanner-candidates-list {
  display: flex;
  flex-direction: column;
  gap: 4px;
  max-height: 150px;
  overflow-y: auto;
  overflow-x: hidden;
  scrollbar-width: thin;
}

.scanner-candidate {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  padding: var(--spacing-xs);
  background-color: rgba(0, 20, 0, 0.5);
  border: 1px solid var(--text-dim);
  border-radius: 2px;
  cursor: pointer;
  transition:
    border-color 0.2s,
    background-color 0.2s;
  text-align: left;
  width: 100%;
  font-family: var(--font-main);
}

.scanner-candidate:hover {
  border-color: var(--text-color);
  background-color: rgba(0, 30, 0, 0.7);
}

.scanner-candidate.selected {
  border-color: var(--accent-color);
  background-color: rgba(40, 0, 40, 0.4);
}

.scanner-candidate-checkbox {
  font-size: 0.875rem;
  color: var(--text-color);
  flex-shrink: 0;
}

.scanner-candidate.selected .scanner-candidate-checkbox {
  color: var(--accent-color);
}

.scanner-candidate-icon {
  font-size: 1.25rem;
  flex-shrink: 0;
}

.scanner-candidate-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 1px;
  min-width: 0;
}

.scanner-candidate-name {
  font-size: var(--font-size-sm);
  color: var(--text-color);
  font-weight: bold;
}

.scanner-candidate-desc {
  font-size: var(--font-size-xs);
  color: var(--text-dim);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.scanner-candidate-type {
  font-size: 0.625rem;
  color: var(--accent-color);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.scanner-no-candidates {
  font-size: var(--font-size-sm);
  color: var(--text-dim);
  text-align: center;
  padding: var(--spacing-md);
}

/* ì•¡ì…˜ ë²„íŠ¼ */
.scanner-actions {
  display: flex;
  justify-content: flex-end;
  gap: var(--spacing-xs);
  margin-top: var(--spacing-xs);
}

.scanner-btn {
  padding: var(--spacing-xs) var(--spacing-sm);
  font-family: var(--font-main);
  font-size: var(--font-size-xs);
  text-transform: uppercase;
  letter-spacing: 1px;
  cursor: pointer;
  transition:
    background-color 0.2s,
    border-color 0.2s,
    color 0.2s;
}

.scanner-btn-cancel,
.scanner-btn-retry {
  background: transparent;
  border: 1px solid var(--text-dim);
  color: var(--text-color);
}

.scanner-btn-cancel:hover,
.scanner-btn-retry:hover {
  border-color: var(--text-color);
}

.scanner-btn-add {
  background: var(--text-color);
  border: 1px solid var(--text-color);
  color: var(--bg-color);
}

.scanner-btn-add:hover:not(:disabled) {
  background: var(--accent-color);
  border-color: var(--accent-color);
  color: white;
}

.scanner-btn-add:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* ============================================
   U-072: Scanner ì˜ë¯¸ë¡ ì  ì‚¬ìš© ìœ ë„ UX
   ============================================ */

/* íˆ´íŒ */
.scanner-tooltip {
  position: absolute;
  top: -60px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 20, 0, 0.95);
  border: 1px solid var(--text-dim);
  border-radius: 4px;
  padding: var(--spacing-xs) var(--spacing-sm);
  z-index: 100;
  min-width: 180px;
  text-align: center;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
  pointer-events: none;
}

.scanner-tooltip::after {
  content: '';
  position: absolute;
  bottom: -6px;
  left: 50%;
  transform: translateX(-50%);
  border-left: 6px solid transparent;
  border-right: 6px solid transparent;
  border-top: 6px solid var(--text-dim);
}

.scanner-tooltip-title {
  font-size: var(--font-size-sm);
  color: var(--accent-color);
  margin-bottom: 4px;
  text-shadow: 0 0 4px var(--accent-color);
}

.scanner-tooltip-desc {
  font-size: var(--font-size-xs);
  color: var(--text-dim);
  line-height: 1.3;
}

/* ì–´í¬ë˜ìŠ¤ íŒíŠ¸ (idle ìƒíƒœ) */
.scanner-affordance-hint {
  font-size: var(--font-size-xs);
  color: var(--accent-color);
  margin-top: var(--spacing-xs);
  padding: 2px 8px;
  border: 1px dashed var(--accent-color);
  border-radius: 4px;
  opacity: 0.7;
  animation: scanner-affordance-glow 3s ease-in-out infinite;
}

/* U-072: ë“œë˜ê·¸ ì˜¤ë²„/ë¹„í™œì„±í™” ì‹œ ìˆ¨ê¹€ - visibilityë¡œ ê³µê°„ ìœ ì§€í•˜ì—¬ ë ˆì´ì•„ì›ƒ ì‹œí”„íŠ¸ ë°©ì§€ */
.scanner-affordance-hint.hidden {
  visibility: hidden;
  animation: none; /* ìˆ¨ê¹€ ìƒíƒœì—ì„œ ì• ë‹ˆë©”ì´ì…˜ ì¤‘ë‹¨ */
}

@keyframes scanner-affordance-glow {
  0%,
  100% {
    opacity: 0.5;
    text-shadow: none;
  }
  50% {
    opacity: 1;
    text-shadow: 0 0 6px var(--accent-color);
  }
}

/* ë“œë˜ê·¸ ì˜¤ë²„ ì‹œ ì–´í¬ë˜ìŠ¤ ê°•í™” */
.scanner-dropzone.drag-over .scanner-dropzone-text {
  color: var(--accent-color);
  text-shadow: 0 0 8px var(--accent-color);
  font-weight: bold;
}

/* reduced-motion */
@media (prefers-reduced-motion: reduce) {
  .scanner-loading-spinner {
    animation: none;
    border-color: var(--accent-color);
  }

  .scanner-dropzone {
    transition: none;
  }

  .scanner-candidate {
    transition: none;
  }

  /* U-072: ì–´í¬ë˜ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ ë¹„í™œì„±í™” */
  .scanner-affordance-hint {
    animation: none;
    opacity: 0.7;
  }
}

.scanner-slot.has-chrome::before {
  content: '';
  position: absolute;
  top: -10px;
  left: -10px;
  right: -10px;
  bottom: -10px;
  background-image: var(--chrome-scanner-frame);
  background-size: 100% 100%;
  background-repeat: no-repeat;
  pointer-events: none;
  opacity: 0.8;
  filter: drop-shadow(0 0 8px var(--chrome-glow-color));
  z-index: 1;
}

/* Chrome í˜¸ë²„ íš¨ê³¼ ê°•í™” */
.action-card.has-chrome:hover::before,
.scanner-slot.has-chrome:hover::before {
  opacity: 1;
  filter: drop-shadow(0 0 10px var(--accent-color));
}

/* reduced-motion: Chrome íš¨ê³¼ ì™„í™” */
@media (prefers-reduced-motion: reduce) {
  .game-header.has-chrome::before,
  .game-header.has-chrome::after,
  .panel-header.has-chrome::before,
  .panel-header.has-chrome::after,
  .panel.has-chrome .panel-content::before,
  .panel.has-chrome .panel-content::after {
    filter: none;
  }

  .action-card.has-chrome::before,
  .scanner-slot.has-chrome::before {
    filter: none;
  }

  .action-card.has-chrome:hover::before,
  .scanner-slot.has-chrome:hover::before {
    filter: none;
  }
}

/* Chrome í´ë°±: ì´ë¯¸ì§€ ë¡œë”© ì‹¤íŒ¨ ì‹œ CSS í…Œë‘ë¦¬ë¡œ ëŒ€ì²´ */
.panel-header.has-chrome.chrome-fallback::before,
.panel-header.has-chrome.chrome-fallback::after,
.panel.has-chrome.chrome-fallback .panel-content::before,
.panel.has-chrome.chrome-fallback .panel-content::after {
  background-image: none;
  background-color: var(--text-color);
  width: 8px;
  height: 8px;
  border-radius: 1px;
}

.action-card.has-chrome.chrome-fallback::before,
.scanner-slot.has-chrome.chrome-fallback::before {
  background-image: none;
  border: 1px solid var(--text-color);
  background-color: transparent;
}

/* ============================================
   25. Inventory Panel ìŠ¤íƒ€ì¼ (U-011, U-088)
   - RULE-002: ê²Œì„ UIë¡œ ìƒì‹œ ë…¸ì¶œ
   - U-088: Row(í–‰) ë ˆì´ì•„ì›ƒ ì „í™˜
     Q1: Row 48px, ì•„ì´ì½˜ 32px (ì»´íŒ©íŠ¸)
     Q2: êµ¬ë¶„ì„  + ì¤„ë¬´ëŠ¬ ì¡°í•©
     Q3: Hover íˆ´íŒë§Œ (U-056 ìœ ì§€)
     Q4: ì•„ì´ì½˜ ì˜ì—­ë§Œ ë“œë˜ê·¸ ê°€ëŠ¥
   ============================================ */

.inventory-panel-content {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-sm);
  height: 100%;
  min-height: 120px;
  /* U-077: ìŠ¤í¬ë¡¤ ê°€ëŠ¥ + CRT í…Œë§ˆ ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” (Q2: Option B) */
  overflow-y: auto;
  overflow-x: hidden;
  scrollbar-width: thin; /* Firefox: ì–‡ì€ ìŠ¤í¬ë¡¤ë°” */
  scrollbar-color: rgba(51, 255, 0, 0.5) rgba(0, 20, 0, 0.8); /* Firefox: ë…¹ìƒ‰ thumb / ì–´ë‘ìš´ track */
}

/* U-077: CRT í…Œë§ˆ ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” - WebKit (Q2: Option B) */
.inventory-panel-content::-webkit-scrollbar {
  width: 6px;
}

.inventory-panel-content::-webkit-scrollbar-track {
  background: rgba(0, 20, 0, 0.8);
  border-left: 1px solid rgba(51, 255, 0, 0.2);
}

.inventory-panel-content::-webkit-scrollbar-thumb {
  background: rgba(51, 255, 0, 0.5);
  border-radius: 3px;
  border: 1px solid rgba(51, 255, 0, 0.3);
  box-shadow: 0 0 4px rgba(51, 255, 0, 0.3);
}

.inventory-panel-content::-webkit-scrollbar-thumb:hover {
  background: rgba(51, 255, 0, 0.7);
  box-shadow: 0 0 8px rgba(51, 255, 0, 0.5);
}

/* U-088: ì¸ë²¤í† ë¦¬ ë¦¬ìŠ¤íŠ¸ (Row ë ˆì´ì•„ì›ƒ) */
.inventory-list {
  display: flex;
  flex-direction: column;
  padding: 0;
}

/* ë¹ˆ ì¸ë²¤í† ë¦¬ */
.inventory-empty {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-xs);
  padding: var(--spacing-lg);
  color: var(--text-dim);
  text-align: center;
}

.inventory-empty-icon {
  font-size: 2rem;
  opacity: 0.5;
}

.inventory-empty-text {
  font-size: var(--font-size-sm);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* U-077: ë¹ˆ ìƒíƒœ íŒíŠ¸ í…ìŠ¤íŠ¸ (Q3: Option B) */
.inventory-empty-hint {
  font-size: 0.7rem;
  color: var(--text-dim);
  opacity: 0.7;
  margin-top: var(--spacing-xs);
  font-style: italic;
}

/* U-088+U-117: ì¸ë²¤í† ë¦¬ ì•„ì´í…œ (Row í˜•íƒœ, Row ì „ì²´ ë“œë˜ê·¸ ê°€ëŠ¥) */
.inventory-item {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: var(--spacing-sm);
  padding: 6px 12px;
  min-height: 48px; /* Q1: Row 48px */
  border-bottom: 1px solid rgba(51, 255, 0, 0.15); /* Q2: êµ¬ë¶„ì„  */
  background: transparent;
  cursor: grab; /* U-117: Row ì „ì²´ ë“œë˜ê·¸ ê°€ëŠ¥ */
  transition:
    background-color 0.2s,
    box-shadow 0.2s,
    opacity 0.2s;
  user-select: none;
  position: relative;
}

/* Q2: Option C - ì¤„ë¬´ëŠ¬ (zebra striping) */
.inventory-item:nth-child(even) {
  background: rgba(51, 255, 0, 0.03);
}

/* ë§ˆì§€ë§‰ RowëŠ” êµ¬ë¶„ì„  ì œê±° */
.inventory-item:last-child {
  border-bottom: none;
}

/* ì•„ì´í…œ í˜¸ë²„ */
.inventory-item:hover:not(.disabled):not(.dragging) {
  background: rgba(51, 255, 0, 0.08);
  box-shadow: inset 0 0 8px rgba(51, 255, 0, 0.1);
  /* U-077: íŒíŠ¸ íŒì—…ì´ í˜•ì œ ì•„ì´í…œ ìœ„ì— í‘œì‹œë˜ë„ë¡ */
  z-index: 2;
}

/* U-088: ì•„ì´í…œ ì„ íƒ ìƒíƒœ (Q3: Option A) */
.inventory-item.selected {
  background: rgba(255, 0, 255, 0.1);
  box-shadow: inset 3px 0 0 var(--accent-color);
}

/* U-117: ì•„ì´í…œ ë“œë˜ê·¸ ì¤‘ (Row ì „ì²´) */
.inventory-item.dragging {
  opacity: 0.4;
  border-bottom-style: dashed;
  box-shadow: none;
  cursor: grabbing;
}

/* ì•„ì´í…œ ë¹„í™œì„±í™” */
.inventory-item.disabled {
  cursor: not-allowed;
  opacity: 0.5;
}

.inventory-item.disabled:hover {
  background: transparent;
  box-shadow: none;
}

/* U-096: ì•„ì´í…œ ì†Œë¹„(ì‚­ì œ) fade-out ì• ë‹ˆë©”ì´ì…˜ (Row í˜•íƒœ) */
.inventory-item.item-consumed {
  animation: item-consume-fadeout 0.5s ease-out forwards;
  pointer-events: none;
  cursor: default;
}

@keyframes item-consume-fadeout {
  0% {
    opacity: 1;
    transform: translateX(0);
    filter: none;
  }
  40% {
    opacity: 0.7;
    transform: translateX(-4px);
    filter: brightness(1.5) saturate(0.5);
    box-shadow: inset 3px 0 0 var(--warning-color);
  }
  100% {
    opacity: 0;
    transform: translateX(-8px);
    filter: brightness(2) saturate(0);
    box-shadow: none;
  }
}

/* U-088: ë“œë˜ê·¸ ì˜¤ë²„ë ˆì´ â€” ì•„ì´ì½˜ë§Œ í‘œì‹œ (Q4: Option B) */
.inventory-overlay-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  border: 1px solid var(--accent-color);
  border-radius: 4px;
  background: rgba(0, 20, 0, 0.95);
  box-shadow:
    0 0 20px var(--accent-color),
    0 4px 16px rgba(0, 0, 0, 0.6);
  cursor: grabbing;
  z-index: 10001;
  pointer-events: none;
}

.inventory-overlay-icon .inventory-item-icon-img {
  width: 30px;
  height: 30px;
}

.inventory-overlay-icon .inventory-item-icon-emoji {
  font-size: 1.5rem;
}

/* U-088+U-117: ì•„ì´ì½˜ (32px, í‘œì‹œ ì „ìš© â€” ë“œë˜ê·¸ í•¸ë“¤ì€ Row ì „ì²´) */
.inventory-item-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px; /* Q1: 32px */
  height: 32px;
  flex-shrink: 0;
  border: 1px solid var(--text-dim);
  border-radius: 2px;
  background-color: rgba(0, 0, 0, 0.4);
  /* U-117: cursorëŠ” Row(.inventory-item)ì—ì„œ ê´€ë¦¬ */
  touch-action: none;
}

/* U-117: active cursorëŠ” Row(.inventory-item.dragging)ì—ì„œ ê´€ë¦¬ */

.inventory-item-icon-img {
  width: 26px;
  height: 26px;
  object-fit: contain;
  image-rendering: pixelated;
}

.inventory-item-icon-emoji {
  font-size: 1.3rem;
}

/* U-075: ì•„ì´ì½˜ ë¡œë”© ìƒíƒœ */
.inventory-item-icon-wrapper {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
}

.inventory-item-icon-img.loading {
  opacity: 0.5;
}

.inventory-item-icon-loading {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 16px;
  height: 16px;
  border: 2px solid transparent;
  border-top: 2px solid var(--primary-color);
  border-radius: 50%;
  animation: icon-loading-spin 1s linear infinite;
}

@keyframes icon-loading-spin {
  0% {
    transform: translate(-50%, -50%) rotate(0deg);
  }
  100% {
    transform: translate(-50%, -50%) rotate(360deg);
  }
}

/* U-088: ì•„ì´í…œ ì •ë³´ (Row ê°€ë¡œ ë°°ì¹˜) */
.inventory-item-info {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: var(--spacing-sm);
  flex: 1;
  min-width: 0; /* text-overflow ì‘ë™ì„ ìœ„í•´ í•„ìš” */
}

.inventory-item-name {
  font-size: var(--font-size-xs);
  color: var(--text-color);
  text-align: left;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex: 1;
  min-width: 0;
}

.inventory-item-quantity {
  font-family: var(--font-micro-en); /* ìˆ˜ì¹˜ ì‹ë³„ì„±ì„ ìœ„í•´ ë§ˆì´í¬ë¡œ í°íŠ¸ ì ìš© */
  font-size: var(--font-size-sm);
  color: var(--warning-color);
  font-weight: bold;
  text-shadow: 0 0 5px rgba(0, 0, 0, 0.9);
  flex-shrink: 0;
}

/* í¬ì»¤ìŠ¤ ìƒíƒœ (ì ‘ê·¼ì„±) */
.inventory-item:focus-visible {
  outline: 2px solid var(--accent-color);
  outline-offset: -2px;
}

.inventory-item:focus:not(:focus-visible) {
  outline: none;
}

/* ëª¨ë°”ì¼ ì¡°ì • (U-088) */
@media (max-width: 768px) {
  .inventory-item {
    padding: 4px 8px;
    min-height: 40px;
    gap: var(--spacing-xs);
  }

  .inventory-item-icon {
    width: 28px;
    height: 28px;
  }

  .inventory-item-icon-img {
    width: 22px;
    height: 22px;
  }

  .inventory-item-icon-emoji {
    font-size: 1.1rem;
  }

  .inventory-item-name {
    font-size: 0.625rem;
  }
}

/* reduced-motion (U-088) */
@media (prefers-reduced-motion: reduce) {
  .inventory-item {
    transition: none;
  }
}

/* ============================================
   26. Quest Panel ìŠ¤íƒ€ì¼ (U-013)
   - RULE-002: ê²Œì„ UIë¡œ ìƒì‹œ ë…¸ì¶œ
   - ì²´í¬ë¦¬ìŠ¤íŠ¸ í˜•íƒœë¡œ ëª©í‘œ í‘œì‹œ
   ============================================ */

.quest-panel-content {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-sm);
  padding: var(--spacing-xs);
}

/* ë¹ˆ ìƒíƒœ */
.quest-empty {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-xs);
  padding: var(--spacing-md);
  min-height: 80px;
}

.quest-empty-icon {
  font-size: 1.5rem;
  opacity: 0.5;
}

.quest-empty-text {
  font-size: var(--font-size-sm);
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 1px;
  text-align: center;
}

/* ì„¹ì…˜ */
.quest-section {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
}

.quest-section-title {
  font-size: var(--font-size-xs);
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 1px;
  padding-bottom: var(--spacing-xs);
  border-bottom: 1px solid rgba(51, 255, 0, 0.2);
}

/* í€˜ìŠ¤íŠ¸ ëª©ë¡ */
.quest-list {
  list-style: none;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

/* ê°œë³„ í€˜ìŠ¤íŠ¸ ì•„ì´í…œ */
.quest-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  padding: var(--spacing-xs);
  background-color: rgba(0, 20, 0, 0.5);
  border: 1px solid var(--text-dim);
  border-radius: 2px;
  transition:
    border-color 0.2s,
    background-color 0.2s;
}

.quest-item.quest-active {
  border-color: var(--text-color);
}

.quest-item.quest-completed {
  border-color: var(--text-dim);
  opacity: 0.7;
}

.quest-checkbox {
  font-size: 0.875rem;
  color: var(--text-color);
  flex-shrink: 0;
}

.quest-item.quest-completed .quest-checkbox {
  color: var(--text-dim);
}

.quest-label {
  font-size: var(--font-size-sm);
  color: var(--text-color);
  flex: 1;
  line-height: 1.3;
}

.quest-item.quest-completed .quest-label {
  color: var(--text-dim);
  text-decoration: line-through;
}

.quest-status-badge {
  font-size: 0.625rem;
  color: var(--accent-color);
  text-transform: uppercase;
  letter-spacing: 1px;
  padding: 2px 4px;
  background-color: rgba(255, 0, 255, 0.1);
  border: 1px solid var(--accent-color);
  border-radius: 2px;
}

/* ì™„ë£Œëœ í€˜ìŠ¤íŠ¸ ëª©ë¡ (ë ˆê±°ì‹œ, í•˜ìœ„í˜¸í™˜) */
.quest-list-completed {
  max-height: 100px;
  overflow-y: auto;
  overflow-x: hidden;
  scrollbar-width: thin;
}

/* ============================================
   26b. ëª©í‘œ ì‹œìŠ¤í…œ ê°•í™” ìŠ¤íƒ€ì¼ (U-078)
   - ì£¼ ëª©í‘œ(Main Objective) + ì„œë¸Œ ëª©í‘œ
   - ì§„í–‰ë¥  ë°”, ë³´ìƒ ë¯¸ë¦¬ë³´ê¸°
   - ObjectiveTracker (ë¯¸ë‹ˆ íŠ¸ë˜ì»¤)
   ============================================ */

/* ë¹ˆ ìƒíƒœ íŒíŠ¸ */
.quest-empty-hint {
  font-size: 0.6875rem;
  color: var(--text-dim);
  text-align: center;
  opacity: 0.7;
}

/* ---- ì£¼ ëª©í‘œ (Main Objective) ---- */
.main-objective {
  background: linear-gradient(135deg, rgba(0, 40, 0, 0.6) 0%, rgba(0, 20, 0, 0.8) 100%);
  border: 1px solid var(--text-color);
  border-radius: 3px;
  padding: var(--spacing-sm);
  display: flex;
  flex-direction: column;
  gap: 6px;
  position: relative;
  overflow: hidden;
}

.main-objective::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--accent-color), transparent);
}

.main-objective--completed {
  border-color: var(--text-dim);
  opacity: 0.8;
}

.main-objective__header {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
}

.main-objective__icon {
  font-size: 0.875rem;
}

.main-objective__badge {
  font-size: 0.5625rem;
  color: var(--accent-color);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  padding: 1px 6px;
  border: 1px solid var(--accent-color);
  border-radius: 2px;
  background-color: rgba(255, 0, 255, 0.08);
}

.main-objective__title {
  font-size: var(--font-size-sm);
  color: var(--text-color);
  font-weight: 600;
  line-height: 1.3;
  margin: 0;
}

.main-objective--completed .main-objective__title {
  text-decoration: line-through;
  color: var(--text-dim);
}

.main-objective__desc {
  font-size: 0.6875rem;
  color: var(--text-dim);
  line-height: 1.4;
  margin: 0;
}

/* ì§„í–‰ë¥  ë°” */
.objective-progress-bar {
  height: 14px;
  background-color: rgba(0, 20, 0, 0.8);
  border: 1px solid var(--text-dim);
  border-radius: 2px;
  position: relative;
  overflow: hidden;
}

.objective-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--text-color), rgba(51, 255, 0, 0.7));
  border-radius: 1px;
  transition: width 0.5s ease-out;
  box-shadow: 0 0 4px var(--text-color);
}

.objective-progress-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 0.5625rem;
  color: var(--text-color);
  text-shadow: 0 0 3px rgba(0, 0, 0, 0.8);
  letter-spacing: 0.5px;
}

/* ë³´ìƒ ë¯¸ë¦¬ë³´ê¸° */
.main-objective__reward {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 0.6875rem;
  color: var(--warning-color);
}

.main-objective__reward-icon {
  font-size: 0.75rem;
}

/* ì™„ë£Œ ë±ƒì§€ */
.main-objective__complete-badge {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 0.6875rem;
  color: var(--accent-color);
  animation: objectiveCompleteFlash 0.6s ease-out;
}

@keyframes objectiveCompleteFlash {
  0% {
    opacity: 0;
    transform: scale(0.8);
  }
  50% {
    opacity: 1;
    transform: scale(1.1);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}

/* ---- ì„œë¸Œ ëª©í‘œ (Sub-objectives) ---- */
.sub-objective-list {
  list-style: none;
  display: flex;
  flex-direction: column;
  gap: 3px;
}

.sub-objective-list--completed {
  max-height: 80px;
  overflow-y: auto;
  overflow-x: hidden;
  scrollbar-width: thin;
}

.sub-objective {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  padding: 4px var(--spacing-xs);
  background-color: rgba(0, 20, 0, 0.4);
  border: 1px solid transparent;
  border-radius: 2px;
  transition:
    border-color 0.2s,
    background-color 0.2s,
    opacity 0.3s;
}

.sub-objective--active {
  border-color: rgba(51, 255, 0, 0.3);
}

.sub-objective--completed {
  border-color: transparent;
  opacity: 0.6;
}

.sub-objective__check {
  font-size: 0.75rem;
  color: var(--text-dim);
  flex-shrink: 0;
  width: 14px;
  text-align: center;
  transition:
    color 0.3s,
    transform 0.3s;
}

.sub-objective__check--done {
  color: var(--accent-color);
  animation: checkBounce 0.4s ease-out;
}

@keyframes checkBounce {
  0% {
    transform: scale(0.5);
  }
  50% {
    transform: scale(1.3);
  }
  100% {
    transform: scale(1);
  }
}

.sub-objective__label {
  font-size: var(--font-size-sm);
  color: var(--text-color);
  flex: 1;
  line-height: 1.3;
}

.sub-objective--completed .sub-objective__label {
  color: var(--text-dim);
  text-decoration: line-through;
}

.sub-objective__reward {
  font-size: 0.5625rem;
  color: var(--warning-color);
  flex-shrink: 0;
  white-space: nowrap;
}

.sub-objective__earned {
  font-size: 0.5625rem;
  color: var(--accent-color);
  flex-shrink: 0;
  white-space: nowrap;
  animation: objectiveCompleteFlash 0.6s ease-out;
}

/* ---- ObjectiveTracker (ë¯¸ë‹ˆ íŠ¸ë˜ì»¤, U-078 Q2: Option B) ---- */
.objective-tracker {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  padding: 4px var(--spacing-sm);
  background-color: rgba(0, 20, 0, 0.7);
  border: 1px solid rgba(51, 255, 0, 0.2);
  border-radius: 2px;
  margin-bottom: var(--spacing-xs);
  min-height: 24px;
}

.objective-tracker--completed {
  border-color: var(--accent-color);
  opacity: 0.8;
}

.objective-tracker__icon {
  font-size: 0.75rem;
  flex-shrink: 0;
}

.objective-tracker__content {
  display: flex;
  align-items: center;
  gap: 4px;
  flex: 1;
  min-width: 0;
  overflow: hidden;
}

.objective-tracker__title {
  font-size: 0.6875rem;
  color: var(--text-color);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.objective-tracker__sub-count {
  font-size: 0.5625rem;
  color: var(--text-dim);
  flex-shrink: 0;
}

.objective-tracker__bar {
  width: 48px;
  height: 6px;
  background-color: rgba(0, 20, 0, 0.8);
  border: 1px solid var(--text-dim);
  border-radius: 1px;
  overflow: hidden;
  flex-shrink: 0;
}

.objective-tracker__bar-fill {
  height: 100%;
  background-color: var(--text-color);
  transition: width 0.5s ease-out;
  box-shadow: 0 0 3px var(--text-color);
}

/* ============================================
   27. Rule Board ìŠ¤íƒ€ì¼ (U-013)
   - RULE-002: ê²Œì„ UIë¡œ ìƒì‹œ ë…¸ì¶œ
   - ë£° ì¹´ë“œ í˜•íƒœë¡œ ê·œì¹™ í‘œì‹œ
   ============================================ */

.rule-board-content {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-sm);
  padding: var(--spacing-xs);
}

/* ë¹ˆ ìƒíƒœ */
.rule-board-empty {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-xs);
  padding: var(--spacing-md);
  min-height: 80px;
}

.rule-board-empty-icon {
  font-size: 1.5rem;
  opacity: 0.5;
}

.rule-board-empty-text {
  font-size: var(--font-size-sm);
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 1px;
  text-align: center;
}

/* í—¤ë” */
.rule-board-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding-bottom: var(--spacing-xs);
  border-bottom: 1px solid rgba(51, 255, 0, 0.2);
}

.rule-board-count {
  font-size: var(--font-size-xs);
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* ë£° ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ */
.rule-card-list {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
}

/* ê°œë³„ ë£° ì¹´ë“œ */
.rule-card {
  display: flex;
  flex-direction: column;
  gap: 4px;
  padding: var(--spacing-sm);
  background: linear-gradient(180deg, rgba(0, 30, 0, 0.8) 0%, rgba(0, 15, 0, 0.9) 100%);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  transition:
    border-color 0.2s,
    box-shadow 0.2s;
}

.rule-card:hover {
  border-color: var(--accent-color);
  box-shadow: 0 0 8px rgba(255, 0, 255, 0.2);
}

.rule-card-header {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
}

.rule-card-icon {
  font-size: 0.875rem;
  color: var(--warning-color);
  flex-shrink: 0;
}

.rule-card-label {
  font-size: var(--font-size-sm);
  font-weight: bold;
  color: var(--text-color);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.rule-card-description {
  font-size: var(--font-size-xs);
  color: var(--text-dim);
  line-height: 1.3;
  padding-left: calc(0.875rem + var(--spacing-xs));
}

/* ============================================
   28. Mutation Timeline ìŠ¤íƒ€ì¼ (U-013)
   - PRD 6.4: Rule Mutation Timeline
   - ì‹œê°„ìˆœ ì´ë²¤íŠ¸ í‘œì‹œ
   ============================================ */

.mutation-timeline-content {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-sm);
  padding: var(--spacing-xs);
  margin-top: var(--spacing-sm);
  border-top: 1px dashed var(--text-dim);
}

/* ë¹ˆ ìƒíƒœ */
.timeline-empty {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-xs);
  padding: var(--spacing-md);
  min-height: 60px;
}

.timeline-empty-icon {
  font-size: 1.5rem;
  opacity: 0.5;
}

.timeline-empty-text {
  font-size: var(--font-size-sm);
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 1px;
  text-align: center;
}

/* í—¤ë” */
.timeline-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding-bottom: var(--spacing-xs);
}

.timeline-title {
  font-size: var(--font-size-xs);
  color: var(--text-color);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.timeline-count {
  font-size: var(--font-size-xs);
  color: var(--text-dim);
}

/* íƒ€ì„ë¼ì¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤íŠ¸ */
.timeline-events {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
  max-height: 150px;
  overflow-y: auto;
  overflow-x: hidden;
  scrollbar-width: thin;
}

/* ê°œë³„ íƒ€ì„ë¼ì¸ ì´ë²¤íŠ¸ */
.timeline-event {
  display: flex;
  align-items: flex-start;
  gap: var(--spacing-xs);
  padding: var(--spacing-xs);
  background-color: rgba(0, 20, 0, 0.5);
  border-left: 3px solid var(--text-color);
  border-radius: 0 2px 2px 0;
  transition: background-color 0.2s;
}

.timeline-event:hover {
  background-color: rgba(0, 30, 0, 0.7);
}

/* ì´ë²¤íŠ¸ ìœ í˜•ë³„ í…Œë‘ë¦¬ ìƒ‰ìƒ */
.timeline-event-added {
  border-left-color: var(--text-color);
}

.timeline-event-modified {
  border-left-color: var(--warning-color);
}

.timeline-event-removed {
  border-left-color: var(--error-color);
}

/* ì´ë²¤íŠ¸ ë§ˆì»¤ */
.timeline-event-marker {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  flex-shrink: 0;
  min-width: 40px;
}

.timeline-event-icon {
  font-size: 0.75rem;
}

.timeline-event-turn {
  font-family: var(--font-micro-en);
  font-size: 0.625rem;
  color: var(--text-dim);
  text-transform: uppercase;
}

/* ì´ë²¤íŠ¸ ë‚´ìš© */
.timeline-event-content {
  display: flex;
  flex-direction: column;
  gap: 2px;
  flex: 1;
  min-width: 0;
}

.timeline-event-label {
  font-size: var(--font-size-xs);
  color: var(--text-color);
  font-weight: bold;
}

.timeline-event-type {
  font-size: 0.625rem;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.timeline-event-description {
  font-size: var(--font-size-xs);
  color: var(--text-dim);
  line-height: 1.2;
}

/* ë”ë³´ê¸° í‘œì‹œ */
.timeline-more {
  display: flex;
  justify-content: center;
  padding: var(--spacing-xs);
}

.timeline-more-text {
  font-size: 0.625rem;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* ëª¨ë°”ì¼ ì¡°ì • */
@media (max-width: 768px) {
  .quest-panel-content,
  .rule-board-content,
  .mutation-timeline-content {
    padding: 4px;
  }

  .quest-item,
  .rule-card,
  .timeline-event {
    padding: 4px;
  }

  .timeline-events {
    max-height: 100px;
  }
}

/* ============================================
   29. í”„ë¡œí•„ ì„ íƒ í™”ë©´ ìŠ¤íƒ€ì¼ (U-015[Mvp])
   - PRD 6.9: ë°ëª¨ í”„ë¡œí•„ 3ì¢… + ì¦‰ì‹œ ì‹œì‘
   ============================================ */

/* U-044: ì–¸ì–´ ì„ íƒ í† ê¸€ (í”„ë¡œí•„ ì„ íƒ í™”ë©´ ìš°ì¸¡ ìƒë‹¨) */
.language-toggle-container {
  position: fixed;
  top: var(--spacing-lg);
  right: var(--spacing-lg);
  z-index: 100;
}

.language-toggle-btn {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-sm) var(--spacing-md);
  background: rgba(0, 30, 0, 0.9);
  border: 1px solid var(--text-dim);
  border-radius: var(--border-radius);
  color: var(--text-color);
  font-family: var(--font-main);
  font-size: var(--font-size-sm);
  cursor: pointer;
  transition:
    border-color 0.2s,
    box-shadow 0.2s;
}

.language-toggle-btn:hover {
  border-color: var(--text-color);
  box-shadow: 0 0 10px var(--text-dim);
}

.language-toggle-btn:focus-visible {
  outline: 2px solid var(--accent-color);
  outline-offset: 2px;
}

.language-toggle-icon {
  font-size: 1.2rem;
}

.language-toggle-label {
  text-transform: uppercase;
  letter-spacing: 1px;
}

.profile-select-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: var(--spacing-xl);
  background: radial-gradient(ellipse at center, rgba(0, 30, 0, 0.3) 0%, var(--bg-color) 70%);
}

/* íƒ€ì´í‹€ í—¤ë” */
.profile-select-header {
  text-align: center;
  margin-bottom: var(--spacing-xl);
}

.profile-select-title {
  font-size: 3rem;
  color: var(--text-color);
  text-transform: uppercase;
  letter-spacing: 8px;
  margin-bottom: var(--spacing-md);
  text-shadow: 0 0 20px var(--text-color);
}

.profile-select-subtitle {
  font-size: var(--font-size-lg);
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 3px;
}

/* í”„ë¡œí•„ ì¹´ë“œ ê·¸ë¦¬ë“œ */
.profile-card-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: var(--spacing-lg);
  max-width: 900px;
  margin-bottom: var(--spacing-xl);
}

@media (max-width: 900px) {
  .profile-card-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 600px) {
  .profile-card-grid {
    grid-template-columns: 1fr;
  }
}

/* í”„ë¡œí•„ ì¹´ë“œ */
.profile-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--spacing-md);
  padding: var(--spacing-xl);
  min-width: 220px;
  min-height: 280px;
  border: 2px solid var(--text-dim);
  border-radius: var(--border-radius);
  background: linear-gradient(180deg, rgba(0, 30, 0, 0.9) 0%, rgba(0, 10, 0, 0.95) 100%);
  cursor: pointer;
  transition:
    border-color 0.3s,
    box-shadow 0.3s,
    transform 0.2s;
  text-align: center;
}

.profile-card:hover {
  border-color: var(--profile-accent, var(--accent-color));
  box-shadow:
    0 0 30px var(--profile-accent, var(--accent-color)),
    inset 0 0 20px rgba(0, 0, 0, 0.5);
  transform: translateY(-8px) scale(1.02);
}

.profile-card:focus-visible {
  outline: 2px solid var(--accent-color);
  outline-offset: 4px;
}

.profile-card-icon {
  font-size: 4rem;
  filter: drop-shadow(0 0 10px var(--profile-accent, var(--text-color)));
}

.profile-card-name {
  font-size: var(--font-size-xl);
  font-weight: bold;
  color: var(--text-color);
  text-transform: uppercase;
  letter-spacing: 2px;
  text-shadow: 0 0 8px var(--text-dim);
}

.profile-card-description {
  font-size: var(--font-size-sm);
  color: var(--text-dim);
  line-height: 1.4;
  padding: 0 var(--spacing-sm);
}

/* ê³„ì†í•˜ê¸° ì„¹ì…˜ */
.profile-continue-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--spacing-md);
  margin-bottom: var(--spacing-lg);
}

.profile-continue-divider {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  color: var(--text-dim);
  font-size: var(--font-size-sm);
  text-transform: uppercase;
  letter-spacing: 2px;
}

.profile-continue-divider::before,
.profile-continue-divider::after {
  content: '';
  width: 60px;
  height: 1px;
  background-color: var(--text-dim);
}

.profile-continue-btn {
  padding: var(--spacing-sm) var(--spacing-lg);
  font-size: var(--font-size-lg);
  background: transparent;
  border: 2px dashed var(--text-color);
  color: var(--text-color);
  text-transform: uppercase;
  letter-spacing: 2px;
  cursor: pointer;
  transition:
    background-color 0.2s,
    border-style 0.2s,
    box-shadow 0.2s;
}

.profile-continue-btn:hover {
  background-color: rgba(51, 255, 0, 0.1);
  border-style: solid;
  box-shadow: 0 0 15px var(--text-color);
}

/* í•˜ë‹¨ ì•ˆë‚´ */
.profile-select-footer {
  text-align: center;
}

.profile-select-hint {
  font-size: var(--font-size-sm);
  color: var(--text-dim);
  font-style: italic;
}

/* ============================================
   30. ë¦¬ì…‹ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (U-015[Mvp])
   ============================================ */

.reset-button-wrapper {
  display: inline-flex;
  align-items: center;
  gap: var(--spacing-xs);
}

.reset-button {
  display: inline-flex;
  align-items: center;
  gap: var(--spacing-xs);
  padding: var(--spacing-xs) var(--spacing-sm);
  background: transparent;
  border: 1px solid var(--text-dim);
  color: var(--text-color);
  font-size: var(--font-size-xs);
  text-transform: uppercase;
  letter-spacing: 1px;
  cursor: pointer;
  transition:
    border-color 0.2s,
    background-color 0.2s,
    color 0.2s;
}

.reset-button:hover:not(:disabled) {
  border-color: var(--warning-color);
  color: var(--warning-color);
}

.reset-button.confirming {
  border-color: var(--error-color);
  background-color: rgba(255, 51, 51, 0.1);
  color: var(--error-color);
  animation: confirm-pulse 0.5s ease-in-out infinite;
}

@keyframes confirm-pulse {
  0%,
  100% {
    opacity: 1;
  }
  50% {
    opacity: 0.7;
  }
}

.reset-button.compact {
  padding: var(--spacing-xs);
  min-width: 28px;
  justify-content: center;
}

.reset-button:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.reset-icon {
  font-size: 0.875rem;
}

.reset-text {
  white-space: nowrap;
}

.reset-cancel-button {
  padding: 2px 6px;
  background: transparent;
  border: 1px solid var(--text-dim);
  color: var(--text-dim);
  font-size: 0.75rem;
  cursor: pointer;
  transition:
    border-color 0.2s,
    color 0.2s;
}

.reset-cancel-button:hover {
  border-color: var(--text-color);
  color: var(--text-color);
}

/* í”„ë¡œí•„ ë³€ê²½ ë²„íŠ¼ */
.change-profile-button {
  display: inline-flex;
  align-items: center;
  gap: var(--spacing-xs);
  padding: var(--spacing-xs) var(--spacing-sm);
  background: transparent;
  border: 1px solid var(--text-dim);
  color: var(--text-color);
  font-size: var(--font-size-xs);
  text-transform: uppercase;
  letter-spacing: 1px;
  cursor: pointer;
  transition:
    border-color 0.2s,
    color 0.2s;
}

.change-profile-button:hover:not(:disabled) {
  border-color: var(--accent-color);
  color: var(--accent-color);
}

.change-profile-button:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.change-profile-icon {
  font-size: 0.875rem;
}

.change-profile-text {
  white-space: nowrap;
}

/* reduced-motion: í”„ë¡œí•„ ì„ íƒ ì• ë‹ˆë©”ì´ì…˜ ì™„í™” */
@media (prefers-reduced-motion: reduce) {
  .profile-card:hover {
    transform: none;
  }

  .reset-button.confirming {
    animation: none;
  }
}

/* =============================================================================
 * U-079: ì¬í™” ë¶€ì¡± ì‹œ ì´ë¯¸ì§€ ìƒì„± í—ˆìš© + ì¬í™” íšë“ ê²½ë¡œ ë‹¤ì–‘í™”
 * ============================================================================= */

/* ---- ì¸ë²¤í† ë¦¬ íŒë§¤ ë²„íŠ¼ ---- */
.inventory-sell-btn {
  display: flex;
  align-items: center;
  gap: 2px;
  padding: 2px 6px;
  border: 1px solid rgba(255, 200, 0, 0.5);
  border-radius: 4px;
  background: rgba(255, 200, 0, 0.1);
  color: #ffc800;
  font-size: var(--font-size-xs);
  font-family: var(--font-micro-en);
  cursor: pointer;
  transition: all 0.15s ease;
  white-space: nowrap;
  margin-left: auto;
  flex-shrink: 0;
}

.inventory-sell-btn:hover {
  background: rgba(255, 200, 0, 0.25);
  border-color: #ffc800;
  box-shadow: 0 0 8px rgba(255, 200, 0, 0.3);
}

.inventory-sell-btn:active {
  transform: scale(0.95);
}

.inventory-sell-btn .sell-icon {
  font-size: 0.75rem;
}

.inventory-sell-btn .sell-price {
  font-weight: 700;
}

/* ---- ì¬í™” íšë“ ì•¡ì…˜ ì¹´ë“œ ë°°ì§€ ---- */
/* U-083: .earn-badge â†’ .action-card-badge.badge-earn ìœ¼ë¡œ í†µí•©ë¨.
   ì•„ë˜ glow ì• ë‹ˆë©”ì´ì…˜ì€ badge-earnì— ì ìš©. */
.action-card-badge.badge-earn {
  animation: earn-badge-glow 2s ease-in-out infinite;
}

@keyframes earn-badge-glow {
  0%,
  100% {
    box-shadow: 0 0 4px rgba(255, 200, 0, 0.2);
  }
  50% {
    box-shadow: 0 0 10px rgba(255, 200, 0, 0.5);
  }
}

.action-card.card-earn {
  border-color: rgba(255, 200, 0, 0.4);
}

.action-card.card-earn:hover:not(:disabled) {
  border-color: #ffc800;
  box-shadow:
    0 0 12px rgba(255, 200, 0, 0.3),
    inset 0 0 12px rgba(255, 200, 0, 0.05);
}

/* ---- EconomyHud: FAST í´ë°± ì•ˆë‚´ ---- */
.economy-alternatives-enhanced .alternatives-header {
  display: flex;
  align-items: center;
  gap: 6px;
}

.fast-fallback-notice {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 8px;
  margin: 4px 0;
  background: rgba(51, 255, 0, 0.08);
  border: 1px solid rgba(51, 255, 0, 0.2);
  border-radius: 4px;
  font-size: var(--font-size-xs);
}

.fast-fallback-badge {
  display: inline-block;
  padding: 1px 5px;
  border-radius: 3px;
  background: rgba(51, 255, 0, 0.2);
  border: 1px solid rgba(51, 255, 0, 0.4);
  color: var(--primary-color);
  font-family: var(--font-micro-en);
  font-size: 0.625rem;
  font-weight: 700;
  letter-spacing: 1px;
}

.fast-fallback-text {
  color: var(--text-dim);
  font-size: var(--font-size-xs);
}

/* ---- ì¬í™” íšë“ í† ìŠ¤íŠ¸ ì•Œë¦¼ ---- */
.currency-toast {
  position: fixed;
  top: 60px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  border: 1px solid rgba(255, 200, 0, 0.5);
  border-radius: 8px;
  background: rgba(10, 10, 10, 0.95);
  box-shadow:
    0 4px 20px rgba(255, 200, 0, 0.2),
    0 0 30px rgba(255, 200, 0, 0.1);
  backdrop-filter: blur(8px);
  animation:
    toast-slide-in 0.3s ease-out,
    toast-fade-out 0.5s ease-in 2.5s forwards;
  pointer-events: auto;
}

.currency-toast-icon {
  font-size: 1.25rem;
}

.currency-toast-amount {
  font-family: var(--font-micro-en);
  font-size: 1.1rem;
  font-weight: 700;
  color: #ffc800;
}

.currency-toast-reason {
  font-size: var(--font-size-xs);
  color: var(--text-dim);
}

.currency-toast-close {
  padding: 2px 6px;
  border: none;
  background: transparent;
  color: var(--text-dim);
  cursor: pointer;
  font-size: 0.875rem;
  opacity: 0.6;
  transition: opacity 0.15s;
}

.currency-toast-close:hover {
  opacity: 1;
}

@keyframes toast-slide-in {
  from {
    transform: translateX(-50%) translateY(-20px);
    opacity: 0;
  }
  to {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }
}

@keyframes toast-fade-out {
  from {
    opacity: 1;
  }
  to {
    opacity: 0;
    pointer-events: none;
  }
}

/* reduced-motion: U-079 ì• ë‹ˆë©”ì´ì…˜ ì™„í™” */
@media (prefers-reduced-motion: reduce) {
  .action-card-badge.badge-earn {
    animation: none;
  }

  .currency-toast {
    animation: none;
    opacity: 1;
  }
}

/* =============================================================================
   U-087: ì…ë ¥ ì ê¸ˆ ì˜¤ë²„ë ˆì´ (í„´ ì²˜ë¦¬ ì¤‘ ëª¨ë“  ì‚¬ìš©ì ì…ë ¥ ì°¨ë‹¨)
   - isStreaming || processingPhase !== 'idle' || imageLoading ì¼ ë•Œ í™œì„±í™”
   - pointer-events: noneìœ¼ë¡œ ëª¨ë“  í´ë¦­/ë“œë˜ê·¸ë¥¼ ì°¨ë‹¨
   - ì‹œê°ì ìœ¼ë¡œ "ì²˜ë¦¬ ì¤‘"ì„ì„ ëª…í™•íˆ í‘œì‹œ
   ============================================================================= */

.input-lock-overlay {
  position: fixed;
  inset: 0;
  z-index: 9990; /* crt-overlay(9999) ë°”ë¡œ ì•„ë˜ */
  pointer-events: auto; /* ëª¨ë“  ì…ë ¥ ì´ë²¤íŠ¸ë¥¼ ê°€ë¡œì±” */
  cursor: wait;
  background: rgba(0, 0, 0, 0.15);
  display: flex;
  align-items: flex-end;
  justify-content: center;
  padding-bottom: 12px;
  animation: input-lock-fade-in 0.2s ease-out;
}

.input-lock-label {
  font-family: var(--font-family, 'Share Tech Mono', monospace);
  font-size: 0.75rem;
  color: var(--accent-color, #ff00ff);
  background: rgba(0, 0, 0, 0.7);
  padding: 4px 16px;
  border: 1px solid var(--accent-color, #ff00ff);
  border-radius: 2px;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  animation: input-lock-pulse 2s ease-in-out infinite;
  box-shadow: 0 0 8px rgba(255, 0, 255, 0.3);
}

@keyframes input-lock-fade-in {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes input-lock-pulse {
  0%,
  100% {
    opacity: 0.8;
  }
  50% {
    opacity: 1;
  }
}

/* U-087: ì ê¸ˆ ì¤‘ game-containerì˜ ì¸í„°ë™í‹°ë¸Œ ìš”ì†Œ ë¹„í™œì„±í™” ì‹œê° í”¼ë“œë°± */
.input-lock-overlay ~ .currency-toast {
  pointer-events: auto; /* í† ìŠ¤íŠ¸ ì•Œë¦¼ì€ ë‹«ê¸° ë²„íŠ¼ ìœ ì§€ */
}

/* U-087: reduced-motion ëŒ€ì‘ - ë°˜ë³µ ì• ë‹ˆë©”ì´ì…˜ ì™„í™” */
@media (prefers-reduced-motion: reduce) {
  .input-lock-overlay {
    animation: none;
  }

  .input-lock-label {
    animation: none;
    opacity: 1;
  }
}
</file>

</files>
