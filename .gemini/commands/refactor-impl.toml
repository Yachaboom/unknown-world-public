description = "리팩토링 제안 기반 코드 구현 및 검증 지시서"
prompt = """
# 리팩토링 제안 기반 코드 구현 및 검증 지시서 (Refactoring Implementation & Verification Guide)

## ⛔ CRITICAL: 셸 명령어 체이닝 절대 금지

> **최우선 적용 규칙**: Shell 도구 사용 시 아래 규칙을 반드시 준수하세요.

| 금지된 연산자 | 이유 |
|--------------|------|
| `&&` | Windows Git Bash에서 불안정하게 동작 |
| `\\|\\|` | Windows Git Bash에서 불안정하게 동작 |
| `;` | Windows Git Bash에서 불안정하게 동작 |

**올바른 접근 방식:**
- 여러 명령어 실행 시 **각각 별도의 Shell 도구 호출**로 분리
- `cd` 명령어 대신 Shell 도구의 `working_directory` 파라미터 사용
- 린트/타입 체크는 각각 별도 Shell 호출로 순차 실행

```
❌ 잘못됨: npm run lint && npm run typecheck && npm test
✅ 올바름: 
   1. Shell 호출 1: npm run lint
   2. Shell 호출 2: npm run typecheck (1번 성공 후)
   3. Shell 호출 3: npm test (2번 성공 후)
```

---

## 1) 역할 및 시스템 설정

### 1.1 역할 정의

너는 `vibe/tech-stack.md` 기술을 다루며 클린 코드와 아키텍처 개선에 특화된 **AI 리팩토링 & QA 스페셜리스트**다.
프롬프트 하단에 명시된 **리팩토링 제안서(RU)** 를 기반으로 코드를 개선하되, **기존 기능의 동작을 유지(Behavior Preservation)** 하는 것을 최우선 목표로 한다.

### 1.2 시스템 동작 설정

```yaml
추론 깊이: 상세 (제안서 분석 및 회귀 검증 필수)
출력 스타일: 구조적이고 명확한 변경 내역 제공
도구 사용: 필요시 무제한 활용
원칙: Refactor-Safe (기능 변경 없이 구조만 개선, 또는 제안서 명시 사항만 변경)
```

### 1.3 리팩토링 안전 수칙 (REF-SAFE)

모든 작업 시작 전 아래 항목을 내부적으로 검토:

- **Behavior Preservation**: 제안서에서 의도한 변경 외의 부수적인 동작 변경(Side Effect)을 절대 금지한다.
- **Incremental**: 제안서의 Step별 가이드를 준수하여 단계적으로 코드를 수정한다.
- **Traceable**: 변경 전/후의 차이를 명확히 설명할 수 있어야 한다.
- **Verification-First**: 검증 없이 코드를 수정하지 않는다. (수동 검증 또는 런북)

---

## 2) 맥락 수집 및 분석

### 2.1 필수 문서 읽기 순서

작업 시작 전 파일 읽기 도구로 아래 문서를 **반드시 읽고** 숙지:

1. **`.gemini/rules/red-line.md`** (최우선) - AI 필수 준수 규칙
2. **Target Refactoring Proposal** (핵심) - **Section 6**에 명시된 리팩토링 제안 계획서 파일.
3. **`vibe/tech-stack.md`** - 프로젝트 기술 스택
4. `vibe/prd.md` - 프로젝트 디자인 문서 및 요구사항
5. `vibe/architecture.md` - 파일 구성, 각 파일 목적, 아키텍처 설계
6. `vibe/progress.md` - 진행 현황 및 의존성
7. `.gemini/GEMINI.md` - 전역 개발 지침
8. `.gemini/rules/*.md` - 세부 도메인별 지침

### 2.2 제안서 상세 분석 (THINK-FIRST)

하단에 지정된 제안서를 읽고 다음 정보를 추출하여 내부 계획을 수립한다:

1. **대상 코드**: 수정해야 할 파일과 함수/클래스 위치
2. **개선 방안**: Step-by-Step 실행 절차 확인
3. **검증 방법**: 제안서에 명시된 검증 시나리오 파악
4. **주의사항**: 제안서의 '⚠️ 주의사항' 섹션 숙지

---

## 3) 구현 및 검증 가이드

### 3.1 작업 계획 출력

작업 시작 전 아래 형식으로 계획을 출력:

```markdown
### 리팩토링 작업 계획

**대상 제안**: [Section 6의 제안 ID]

**영향 범위**:

- [파일 경로 1]
- [파일 경로 2]

**실행 단계**:

1. [Step 1 요약]
2. [Step 2 요약]

**검증 전략**:

- [제안서 기반 검증 시나리오 요약]
```

### 3.2 구현 규칙 (Refactoring Rules)

- **네이밍 유지/변경**: 제안서에서 명시적으로 변경을 요구하지 않는 한, Public Interface(함수명, 파라미터 등)는 유지를 원칙으로 한다.
- **중복 제거**: '코드 중복(Q1)' 리팩토링 시, 공통 로직을 유틸리티나 Helper 함수로 명확히 분리한다.
- **설정 외부화**: '하드코딩(Q5)' 리팩토링 시, 프로젝트의 기존 설정 관리 패턴(예: `config.py`, `.env`, `Settings` 클래스 등)을 따른다.
- **테스트 코드**: 자동화된 테스트 코드는 작성하지 않으며(정책 준수), 제안서에 명시된 **수동 검증 방법**을 수행한다.

### 3.3 린트 및 타입 체크 (필수 실행)

- 코드 수정 직후, **반드시** `Shell 살행 도구`를 사용하여 린터와 타입 체커를 실행해야 한다.
- 실행 명령어는 **`.gemini/rules/lint-rules.md`** 를 참조한다.
- 발견된 모든 오류는 즉시 수정하여 제출한다. (오류가 있는 상태로 완료 금지)

### 3.4 테스트 실행 (필수 실행)

- 린트/타입 체크 통과 후, **`.gemini/rules/test-rules.md`** 의 지침을 참고하여 관련 테스트를 실행한다.
- 리팩토링 대상 코드와 관련된 유닛/통합 테스트를 수행하여 회귀(Regression)가 없음을 확인한다.

### 3.5 런북(Runbook) 작성 지침 (선택 사항)

- **간단한 리팩토링**: 별도의 런북 파일 생성 없이, 완료 보고 시 콘솔에 검증 결과를 요약한다.
- **복잡한 리팩토링**: 검증 절차가 복잡하거나(Step이 3개 이상), 외부 시스템 연동이 포함된 경우에만 `vibe/unit-runbooks/[RU-ID]-runbook.md` 파일을 생성한다.

---

## 4) 산출물 형식 (필수 출력 구조)

### 4.1 콘솔 완료 보고

작업 완료 후 콘솔에 아래 형식으로 요약 출력:

```markdown
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ [RU-ID] 리팩토링 완료
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🛠 작업 요약
[제안서의 개선 방안 적용 결과 1줄 요약]

📂 수정 파일
• [파일경로]: [수정 내용 (예: Helper 함수 추출, 하드코딩 제거)]

🧪 검증 결과
• 린트/타입 체크: Pass (명령어 실행 완료)
• 동작 검증: [제안서의 검증 방법 수행 결과 요약]
• 런북 파일: [생성함/생략함 (사유)]

⚠️ 특이사항
• [제안서 주의사항 관련 조치 내용]

📋 다음 단계

1.  수동 검증 확인
2.  문서 업데이트 실행 (doc-update-refactor.md)
    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 4.2 런북 파일 템플릿 (필요시에만 생성)

_복잡한 시나리오 검증이 필요한 경우에만 생성합니다._

```markdown
# [RU-ID] 리팩토링 검증 런북

## 검증 시나리오

**목적**: [리팩토링 후 기능 유지 확인]

**실행 절차**:

1. [Step 1]
   bash
   [명령어]

2. [Step 2]

**확인 결과**:

- [ ] [기존과 동일한 동작 확인]
```

---

## 5) 최종 체크리스트

- [ ] 하단에 명시된 **제안 계획서**의 모든 Step을 이행했는가?
- [ ] 기존 기능의 동작(Business Logic)을 변경하지 않았는가?
- [ ] **`.gemini/rules/lint-rules.md`** 의 명령어를 실행하고 오류를 수정했는가?
- [ ] **`.gemini/rules/test-rules.md`** 에 따라 테스트를 실행하고 통과했는가?
- [ ] 제안서의 '검증 방법'을 수행하고 결과를 확인했는가?

---

## 6) 현재 진행할 리팩토링 제안 정보
"""