---
applyTo: "**/*"
description: "Unknown World 공통 핵심 규칙(채팅 래퍼 금지, 구조화 출력, 검증/복구, 재화, i18n, 보안/관측)"
priority: high
tags: [core, prd, structured-output, economy, i18n, safety, observability]
---

# 핵심 규칙 (Core / Critical)

## 적용 대상

이 지침은 레포 내 **모든 파일/작업**에 적용됩니다.

## 규칙

**SSOT**: `vibe/prd.md`(제품/UX/금지사항), `vibe/tech-stack.md`(기술 선택/버전/모델 ID)  
**동기화 정책**: 이 문서의 RULE-001~010은 `.gemini/rules/red-line.md`와 **동일한 번호/의미**를 유지합니다. 불일치가 생기면 PRD/Tech-stack을 기준으로 두 문서를 함께 수정합니다.

### ✅ RULE-001: “Prompt-only wrapper / Generic chatbot” 금지

**설명**: Unknown World는 “대화 앱”이 아니라 **상태를 가진 게임 시스템**입니다. 단일 프롬프트/단일 텍스트 응답으로 끝나는 구조를 금지합니다.

**올바른 예시**:

```text
- 서버는 TurnInput을 받아 WorldState를 갱신하고,
- TurnOutput(JSON Schema)에 narrative + ui + world.delta + economy + safety + (선택) render.image_job 을 반환한다.
- 클라는 TurnOutput 스키마 검증(Zod) 후 UI를 그린다.
```

**잘못된 예시**:

```text
- /chat: string -> string
- 모델이 말만 하고 UI/상태/비용은 텍스트에서 파싱(정규식)한다.
```

**이유**: PRD의 “채팅 래퍼 회피” 원칙 및 “플레이 가능한 화면” 요구를 충족하려면 **구조화 + 상태 + 오케스트레이션**이 필수입니다. (참조: `vibe/prd.md`)

---

### ✅ RULE-002: 채팅 버블 UI 금지 (게임 UI로 보이게)

**설명**: 심사자/사용자가 “챗봇”으로 오해하지 않도록 **메신저형 버블 UI**는 금지합니다.

**올바른 예시**:

```text
- Narrative Feed(게임 로그)
- Scene Canvas(이미지+핫스팟)
- Action Deck(카드 3~6장, 비용/위험/보상)
- Inventory(DnD)
- Quest/Objective, Rule Board/Timeline
- Agent Console(Plan/Queue/Badges), Economy HUD
```

**잘못된 예시**:

```text
- 좌측/우측 채팅 버블
- “선택지 버튼”만 달린 채팅 UI
```

**이유**: PRD 9장(UI 형태 원칙)에서 명시적으로 금지합니다. (참조: `vibe/prd.md`)

---

### ✅ RULE-003: 구조화 출력(JSON Schema) 우선 + 이중 검증

**설명**: 모델 출력은 기본적으로 `application/json` + JSON Schema를 사용하며, **서버(Pydantic) + 클라(Zod)** 이중 검증을 전제합니다.

**올바른 예시**:

```text
- 서버: Pydantic 모델로 TurnOutput을 정의하고 response_json_schema로 강제
- 클라: Zod로 TurnOutput을 parse/strict 하여 스키마 위반을 UI로 숨기지 않는다
```

**잘못된 예시**:

```text
- JSON처럼 보이는 문자열을 try/catch 없이 JSON.parse만 한다
- 스키마 실패를 무시하고 UI를 그린다(“대충 되면 됨”)
```

**이유**: “예측 가능한 UI/상태/비용 처리”를 위해 파싱 가능한 계약이 필요합니다. (참조: `vibe/prd.md`, `vibe/ref/structured-outputs-guide.md`)

---

### ✅ RULE-004: 검증 실패는 자동 복구(Repair loop)로 처리 + 폴백 제공

**설명**: 스키마 실패/비즈니스 룰 실패/이미지 생성 실패는 “에러 종료”가 아니라 **복구 루프**로 처리합니다.

**올바른 예시**:

```text
- validate(schema) 실패 → repair #1 → 재검증 → (최대 N회) → 최종 폴백(텍스트-only + 안전한 UI)
- UI에는 Auto-repair #1/#2… 결과만 노출(프롬프트/내부추론 비노출)
```

**잘못된 예시**:

```text
- 실패 시 500/빈 화면
- 실패를 숨기고 이전 상태를 그대로 유지(사용자는 “멈춤”으로 인식)
```

**이유**: PRD는 “실패/불완전 출력 대비 + 자동 복구 설계”를 MVP 핵심으로 요구합니다. (참조: `vibe/prd.md`)

---

### ✅ RULE-005: 재화(Economy) 인바리언트는 절대 깨지지 않게

**설명**: 비용은 게임 메커닉입니다. 잔액 음수/불일치/미표기는 금지합니다.

**올바른 예시**:

```text
- 행동 전: 예상 비용(최소/최대) 표시
- 부족 시: 대체 행동(텍스트만/저해상도/Thinking 낮춤) 제안
- TurnOutput에 cost와 balance_after를 항상 포함
```

**잘못된 예시**:

```text
- “이미지 생성”을 먼저 실행하고 나중에 비용을 계산
- 잔액 음수인데도 진행
```

**이유**: PRD의 “비용 리스크를 게임 메커닉으로 전환” 요구사항을 지키기 위함입니다. (참조: `vibe/prd.md`)

---

### ✅ RULE-006: ko/en 언어 정책 준수 (혼합 출력 금지)

**설명**: `language`를 SSOT로 삼고, 모든 UI/내러티브/시스템 메시지는 동일 언어로 고정합니다.

**올바른 예시**:

```text
- TurnInput.language = "ko-KR" → TurnOutput 전체(내러티브/라벨/시스템 메시지)도 ko-KR
- 프롬프트는 언어별 .md 파일로 분리(권장)
```

**잘못된 예시**:

```text
- 버튼은 영어, 내러티브는 한국어(또는 그 반대)
- 모델이 섞어 쓰는 출력을 그대로 노출
```

**이유**: PRD 3.1/3.2의 다국어 정책을 충족해야 합니다. (참조: `vibe/prd.md`)

---

### ✅ RULE-007: 보안/인증 — Vertex 서비스 계정, 비밀정보 커밋/노출 금지

**설명**: 백엔드에서 Vertex 인증을 수행하며, 사용자의 API 키 입력(BYOK)을 요구하지 않습니다(MVP).

**올바른 예시**:

```text
- 서비스 계정은 런타임 환경변수/권한으로만 주입
- 로그에는 prompt_version/policy_label 정도만 남기고 프롬프트 원문/토큰/키는 남기지 않는다
```

**잘못된 예시**:

```text
- 서비스 계정 JSON 키 파일을 레포에 추가
- 사용자에게 “GEMINI_API_KEY를 입력하세요”를 강제
```

**이유**: PRD 8.2(서비스 계정 필수) 및 운영 보안 원칙 준수를 위함입니다. (참조: `vibe/prd.md`, `vibe/tech-stack.md`)

---

### ✅ RULE-008: 관측 가능성은 기능이다 (단, 내부추론/프롬프트 노출 금지)

**설명**: 에이전트형 시스템임을 “UI로 증명”해야 합니다.
또한 스트리밍 UX에서 **TTFB 2초 목표**를 지키기 위해, 단계/배지/텍스트를 먼저 보여주고 지연 작업(예: 이미지)은 텍스트 우선 + Lazy 처리로 진행합니다.

**올바른 예시**:

```text
- 단계: Parse → Validate → Plan → Resolve → Render → Verify → Commit
- 배지: Schema OK / Economy OK / Safety OK / Consistency OK
- 실패 시: Auto-repair #n 및 최종 대체 결과 제공
- TTFB: phase/badge/텍스트를 먼저 스트리밍하고, 이미지 등 지연 작업은 Lazy 처리
```

**잘못된 예시**:

```text
- “생각 중…”만 표시하고 무슨 일이 일어나는지 전혀 설명하지 않음
- 디버그를 위해 프롬프트 원문/내부 추론을 UI에 그대로 노출
- 모든 작업이 끝날 때까지 블로킹 후 한 번에 결과를 보여줌(체감 지연/멈춤)
```

**이유**: PRD 6.8/10장의 데모 요구(에이전트 동작 가시화/프롬프트 노출 금지)를 만족해야 합니다. (참조: `vibe/prd.md`)

---

### ✅ RULE-009: 핫스팟 좌표 규약 고정 (0~1000, bbox 순서)

**설명**: 클릭 가능한 오브젝트 좌표는 **정규화 0~1000**이며, bbox는 **[ymin, xmin, ymax, xmax]** 순서입니다.

**올바른 예시**:

```text
box_2d: [120, 240, 460, 610]  // ymin,xmin,ymax,xmax (0~1000)
```

**잘못된 예시**:

```text
box: [x, y, w, h]  // 로컬 픽셀 기반, 순서도 불명확
```

**이유**: 이미지 이해 bbox 포맷과의 호환을 보장하기 위함입니다. (참조: `vibe/prd.md`, `vibe/tech-stack.md`)

---

### ✅ RULE-010: 버전/스택 고정 — 임의 업그레이드 금지

**설명**: 기술/버전은 `vibe/tech-stack.md`를 SSOT로 합니다. 새 의존성/대규모 교체는 근거와 함께 문서 업데이트가 필요합니다.
추가로, PRD/Tech-stack에서 명시된 하드 제약(모델 ID 고정, 저장 방식 등)을 임의로 바꾸지 않습니다.

**올바른 예시**:

```text
- React/Vite/TS, FastAPI/Pydantic, google-genai 버전은 tech-stack에 맞춰 고정
- 변경이 필요하면: (1) 이유/영향 (2) 대안 (3) 문서 업데이트(tech-stack)까지 포함
- 이미지(생성/편집) 모델 ID는 고정: gemini-3-pro-image-preview (혼용 금지)
- 저장/로드는 SaveGame(JSON 직렬화)을 기본으로 하고, 문서 합의 없이 DB/ORM/SQL을 도입하지 않는다
```

**잘못된 예시**:

```text
- “최신이니까”라는 이유로 버전을 대거 올리거나 프레임워크를 교체
- 이미지 모델을 요청마다 임의 변경/혼용
- 문서에 없는 DB/ORM/마이그레이션을 MVP에 도입
```

**이유**: 데모 안정성과 재현성을 위해 버전 고정이 필수입니다. (참조: `vibe/tech-stack.md`)

---

### ✅ RULE-011: 개발 서버 포트 정책 (프론트 8001~8010, 백엔드 8011~8020)

**설명**: 포트 충돌을 방지하고 일관된 개발 환경을 유지하기 위해 포트 대역을 분리합니다.

**올바른 예시**:

```text
- 프론트엔드(Vite): --port 8001 (기본), 충돌 시 8002~8010
- 백엔드(Uvicorn): --port 8011 (기본), 충돌 시 8012~8020
- CORS 허용 오리진: http://localhost:8001 ~ http://localhost:8010
```

**잘못된 예시**:

```text
- 프론트엔드: --port 5173, 3000, 8000
- 백엔드: --port 8000, 5000
- 프론트/백엔드가 같은 포트 대역 사용
```

**이유**: 5173/8000/3000은 다른 도구와 충돌이 잦고, 포트 대역 분리로 디버깅과 kill 명령이 단순해집니다.

## 예외 처리

- PRD/요청에서 명시적으로 예외를 요구하는 경우에만 제한적으로 허용합니다.
- 예외를 적용했다면, 반드시 **근거(문서/이슈) + 영향 + 롤백 방법**을 함께 남깁니다.

## 체크리스트

- [ ] 채팅 래퍼/채팅 UI로 보이지 않는가?
- [ ] TurnOutput이 스키마로 강제/검증되는가?
- [ ] 검증 실패/비용 초과/이미지 실패에 대한 복구/폴백이 있는가?
- [ ] ko/en 혼합 출력이 없는가?
- [ ] 재화 잔액 음수/불일치가 없는가?
- [ ] 비밀정보가 커밋/로그/UI에 노출되지 않는가?

## 관련 지침

- `CLAUDE.md`
- `.gemini/rules/red-line.md`
- `vibe/prd.md`
- `vibe/tech-stack.md`
- `vibe/ref/frontend-style-guide.md`

