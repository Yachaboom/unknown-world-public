# [ID: RU-005-S2] ì—£ì§€ ì¼€ì´ìŠ¤: Cancel/ì˜ˆì™¸/ì–¸ì–´(i18n) ê²½ë¡œì—ì„œ stageÂ·repairÂ·final ì •ì±…ì„ ì¼ê´€ë˜ê²Œ

## ğŸ“Œ ê¸°ë³¸ ì •ë³´

| í•­ëª©               | ë‚´ìš©                                                                                          |
| ------------------ | --------------------------------------------------------------------------------------------- |
| **ID**             | RU-005-S2                                                                                     |
| **ì‹¬ê°ë„**         | Medium                                                                                        |
| **ì¹´í…Œê³ ë¦¬**       | ì—£ì§€ ì¼€ì´ìŠ¤ (Edge Cases)                                                                      |
| **ì˜í–¥ ë²”ìœ„**      | `backend/src/unknown_world/api/turn.py`, `backend/src/unknown_world/orchestrator/repair_loop.py`, `backend/src/unknown_world/validation/business_rules.py`, `backend/src/unknown_world/orchestrator/fallback.py`, `backend/src/unknown_world/api/turn_stream_events.py` |
| **ì˜ˆìƒ ì‘ì—… ì‹œê°„** | 45~90ë¶„                                                                                       |

---

## ğŸ” ë¬¸ì œì  ìƒì„¸ ë¶„ì„

### í˜„ì¬ ìƒí™©

í˜„ì¬ ìŠ¤íŠ¸ë¦¬ë°/ë³µêµ¬/ê²€ì¦ì€ ì „ë°˜ì ìœ¼ë¡œ ì•ˆì •í™”ë˜ì–´ ìˆì§€ë§Œ, â€œì—£ì§€ ì¼€ì´ìŠ¤â€ì—ì„œ RULE ìœ„ë°˜ ë˜ëŠ” ê´€ì¸¡ í’ˆì§ˆ ì €í•˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ë¬¸ì œê°€ ë˜ëŠ” ì´ìœ 

1. **ì˜ì–´(en-US)ì—ì„œë„ ë¹„ì¦ˆë‹ˆìŠ¤ ë£°/repair ë©”ì‹œì§€ê°€ í•œêµ­ì–´ë¡œ ë‚˜ì˜¬ ìˆ˜ ìˆìŒ (RULE-006 ìœ„í—˜)**
   - `validation/business_rules.py`ì˜ ì—ëŸ¬ ë©”ì‹œì§€/ìš”ì•½ì€ í•œêµ­ì–´ë¡œ ê³ ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
   - `repair_loop.py`ì˜ repair ì»¨í…ìŠ¤íŠ¸(_build_repair_context_schema/_business)ë„ í•œêµ­ì–´ ê³ ì •ì…ë‹ˆë‹¤.
   - ê²°ê³¼ì ìœ¼ë¡œ `TurnInput.language=en-US`ì¸ë° repair ë©”ì‹œì§€/ìš”ì•½ì´ í•œêµ­ì–´ë¡œ ì„ì—¬ ë‚˜ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
2. **í´ë¼ì´ì–¸íŠ¸ Abort(ì—°ê²° ì·¨ì†Œ) ì‹œ ì²˜ë¦¬ ì •ì±…ì´ ë¶ˆëª…í™•**
   - í”„ë¡ íŠ¸ ì •ì±…(RU-003-S1 ìš”ì•½)ì— ë”°ë¥´ë©´ AbortëŠ” â€œì •ìƒ ì™„ë£Œ(onComplete)ë¡œ ë³´ì§€ ì•ŠëŠ”ë‹¤â€.
   - ë°±ì—”ë“œì—ì„œë„ ì—°ê²°ì´ ëŠê¸°ëŠ” ìˆœê°„(ì„œë²„ Cancelled)ì—ëŠ” error/finalì„ ì–µì§€ë¡œ ë³´ë‚´ê¸°ë³´ë‹¤, ì¡°ìš©íˆ ì¤‘ë‹¨í•˜ëŠ” í¸ì´ ìì—°ìŠ¤ëŸ½ìŠµë‹ˆë‹¤.
3. **ì˜ˆì™¸/í´ë°± ê²½ë¡œì˜ stage fail í‘œê¸° ì •ì±… ë¶€ì¬**
   - ì˜ˆì™¸ ë°œìƒ ì‹œ error+finalë¡œ ì¢…ë£Œë˜ì§€ë§Œ, stage ê´€ì ì—ì„œëŠ” ì–´ë–¤ ë‹¨ê³„ì—ì„œ ì‹¤íŒ¨í–ˆëŠ”ì§€ UIì— ë‚¨ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ì˜í–¥ë°›ëŠ” ì½”ë“œ ìœ„ì¹˜

- `backend/src/unknown_world/validation/business_rules.py`
  - ì—ëŸ¬ ë©”ì‹œì§€/ìš”ì•½ì´ í•œêµ­ì–´ ê³ ì •
- `backend/src/unknown_world/orchestrator/repair_loop.py`
  - repair ì»¨í…ìŠ¤íŠ¸ ë©”ì‹œì§€ í•œêµ­ì–´ ê³ ì •
- `backend/src/unknown_world/api/turn.py`
  - ì˜ˆì™¸ ì²˜ë¦¬: error + final(í´ë°±)ë¡œ ì¢…ë£Œ(ì¢‹ìŒ) / CancelledError ì •ì±…ì€ ëª…ì‹œì ì´ì§€ ì•ŠìŒ

---

## ğŸ’¡ ê°œì„  ë°©ì•ˆ

### ì œì•ˆí•˜ëŠ” ì ‘ê·¼ë²•

ì—£ì§€ ì¼€ì´ìŠ¤ëŠ” â€œê¸°ëŠ¥â€ì´ ì•„ë‹ˆë¼ â€œì¸ë°”ë¦¬ì–¸íŠ¸ ìœ ì§€â€ê°€ ëª©ì ì…ë‹ˆë‹¤.

- **ì–¸ì–´(i18n) ì¸ë°”ë¦¬ì–¸íŠ¸(RULE-006)**: repair/ìš”ì•½/ì‹œìŠ¤í…œ ë©”ì‹œì§€ì—ì„œë„ í˜¼í•© ì¶œë ¥ì´ ì—†ë„ë¡ ë³´ì¥
- **Cancel ì¸ë°”ë¦¬ì–¸íŠ¸**: ì—°ê²°ì´ ëŠê¸´ ìš”ì²­ì€ ì„œë²„ê°€ ì–µì§€ë¡œ finalì„ ë³´ë‚´ì§€ ì•Šê³  ì¢…ë£Œ
- **ê´€ì¸¡ ì¸ë°”ë¦¬ì–¸íŠ¸(RULE-008)**: ì˜ˆì™¸/í´ë°± ì‹œì—ë„ ë‹¨ê³„ ì‹¤íŒ¨ê°€ ì„¤ëª… ê°€ëŠ¥í•˜ë„ë¡ ìµœì†Œ ì •ì±… ìˆ˜ë¦½

### êµ¬ì²´ì  ì‹¤í–‰ ë‹¨ê³„

#### Step 1: BusinessRules ë©”ì‹œì§€ i18n ë„ì…(ìµœì†Œ 2ê°œ ì–¸ì–´)

ê¶Œì¥(ìµœì†Œ ë³€ê²½) ë°©ì‹:

- `validate_business_rules(turn_input, turn_output)`ëŠ” ì´ë¯¸ `turn_input`ì„ ë°›ìœ¼ë¯€ë¡œ,
  - `turn_input.language`ì— ë”°ë¼ ì—ëŸ¬ ë©”ì‹œì§€/ìš”ì•½ í…ìŠ¤íŠ¸ë¥¼ ë¶„ê¸°í•©ë‹ˆë‹¤.

ì˜ˆì‹œ(ê°œë…):

- ko-KR:
  - â€œë‹¤ìŒ ë¹„ì¦ˆë‹ˆìŠ¤ ë£°ì„ ìœ„ë°˜í–ˆìŠµë‹ˆë‹¤:â€
  - â€œSignal ì¬í™”ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤: â€¦â€
- en-US:
  - â€œThe following business rules were violated:â€
  - â€œInsufficient Signal: have â€¦, need â€¦â€

#### Step 2: Repair context(i18n)ë„ ë™ì¼ ì •ì±…ìœ¼ë¡œ ë¶„ê¸°

`repair_loop.py`ì˜ `_build_repair_context_schema/_business`ëŠ” í˜„ì¬ í•œêµ­ì–´ ê³ ì •ì…ë‹ˆë‹¤.

ê¶Œì¥:

- í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ì— `language`ë¥¼ ì „ë‹¬í•´, ko/en ê°ê°ì˜ ì§§ì€ ì§€ì‹œë¬¸ì„ ë°˜í™˜
- (ì¤‘ìš”) í”„ë¡¬í”„íŠ¸ ì›ë¬¸/ìƒì„¸ ì˜¤ë¥˜ëŠ” ê³„ì† ë…¸ì¶œí•˜ì§€ ì•Šë˜, â€œë¬´ì—‡ì„ ê³ ì³ì•¼ í•˜ëŠ”ì§€â€ë§Œ ê°„ê²°íˆ ìœ ì§€(RULE-007/008)

#### Step 3: Abort(ì„œë²„ Cancelled) ì²˜ë¦¬ ì •ì±… ëª…ì‹œ

ê¶Œì¥ ì •ì±…(ì‹¤ìš©ì ):

- `asyncio.CancelledError`(ë˜ëŠ” í”„ë ˆì„ì›Œí¬ Cancel ì˜ˆì™¸)ëŠ” â€œí´ë¼ì´ì–¸íŠ¸ê°€ ì—°ê²°ì„ ëŠì€ ê²ƒâ€ìœ¼ë¡œ ë³´ê³ ,
  - ì¶”ê°€ ì´ë²¤íŠ¸(error/final)ë¥¼ ì†¡ì¶œí•˜ì§€ ì•Šê³  ì¦‰ì‹œ ì¢…ë£Œ
  - (ë¡œê·¸ë„ noisyí•˜ì§€ ì•Šê²Œ) warning/errorë¡œ ë‚¨ê¸°ì§€ ì•ŠìŒ

ì´ë ‡ê²Œ í•˜ë©´ í”„ë¡ íŠ¸ì˜ Abort ì •ì±…ê³¼ë„ ìì—°ìŠ¤ëŸ½ê²Œ ë§ìŠµë‹ˆë‹¤.

#### Step 4: ì˜ˆì™¸/í´ë°± ì‹œ stage fail í‘œê¸°(ì„ íƒ)

UI ì¦ê±° ê°•í™”ë¥¼ ìœ„í•´, pipeline(stage wrapper)ì—ì„œ ë‹¤ìŒì„ ê¶Œì¥í•©ë‹ˆë‹¤.

- stage ì‹¤í–‰ ì¤‘ ì˜ˆì™¸ ë°œìƒ â†’ í•´ë‹¹ stageì— `status=fail` ì†¡ì¶œ(ê°€ëŠ¥í•  ë•Œ)
- ì´í›„ `final(í´ë°±)`ë¡œ ì¢…ë£ŒëŠ” ìœ ì§€(RULE-004)

---

## ğŸ“ˆ ê¸°ëŒ€ íš¨ê³¼

### ì¦‰ê°ì  íš¨ê³¼

- âœ… en-US ìš”ì²­ì—ì„œë„ repair/ê²€ì¦ ë©”ì‹œì§€ê°€ ì˜ì–´ë¡œ ìœ ì§€ë˜ì–´ í˜¼í•© ì¶œë ¥(RULE-006) ë¦¬ìŠ¤í¬ ê°ì†Œ
- âœ… Abort ì‹œ ì„œë²„ê°€ ì–µì§€ë¡œ error/finalì„ ë³´ë‚´ì§€ ì•Šì•„ ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ ë™ì‘ì´ ì˜ˆì¸¡ ê°€ëŠ¥í•´ì§
- âœ… ì˜ˆì™¸/í´ë°±ì´ â€œì–´ëŠ ë‹¨ê³„ì—ì„œ ì‹¤íŒ¨í–ˆëŠ”ì§€â€ ë” ëª…í™•í•˜ê²Œ ê´€ì¸¡ ê°€ëŠ¥

### ì¥ê¸°ì  íš¨ê³¼

- ğŸ¯ ë‹¤êµ­ì–´ í™•ì¥(i18n ë¦¬ì†ŒìŠ¤ í‚¤ë¡œ ì „í™˜ ë“±)ì˜ ê¸°ë°˜ ë§ˆë ¨(í˜„ì¬ëŠ” ìµœì†Œ 2ê°œ ì–¸ì–´ë§Œ)

---

## âš ï¸ ì£¼ì˜ì‚¬í•­ ë° ê³ ë ¤ì‚¬í•­

### ë¦¬íŒ©í† ë§ ì‹œ ì£¼ì˜í•  ì 

1. i18n ë©”ì‹œì§€ëŠ” ì‚¬ìš©ì ë…¸ì¶œì…ë‹ˆë‹¤. â€œí”„ë¡¬í”„íŠ¸/ë‚´ë¶€ì¶”ë¡ â€ì´ ì„ì´ì§€ ì•Šë„ë¡ ë°˜ë“œì‹œ ì§§ê³  ì¼ë°˜ì ì¸ ë¬¸ì¥ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
2. AbortëŠ” ì •ìƒ ì¢…ë£Œë¡œ ì˜¤í•´ë˜ë©´ ì•ˆ ë©ë‹ˆë‹¤. ì„œë²„/í´ë¼ ëª¨ë‘ì—ì„œ â€œì‚¬ìš©ì ì·¨ì†Œâ€ì™€ â€œì‹¤íŒ¨ í´ë°±â€ì„ êµ¬ë¶„í•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

### í˜¸í™˜ì„± ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] en-US ìš”ì²­ì—ì„œ repair/ìš”ì•½/ì‹œìŠ¤í…œ ë©”ì‹œì§€ê°€ í•œêµ­ì–´ë¡œ ì„ì´ì§€ ì•ŠëŠ”ê°€?
- [ ] Abort ì‹œ ì„œë²„ê°€ ì¶”ê°€ ì´ë²¤íŠ¸ë¥¼ ë³´ë‚´ì§€ ì•Šê³  ì¡°ìš©íˆ ì¢…ë£Œë˜ëŠ”ê°€?
- [ ] ì˜ˆì™¸ ë°œìƒ ì‹œì—ë„ ìµœì¢…ì ìœ¼ë¡œëŠ” final(í´ë°±)ë¡œ ìˆ˜ë ´í•˜ëŠ”ê°€? (Abort ì œì™¸)

---

## ğŸ§ª ê²€ì¦ ë°©ë²• (ìˆ˜ë™ ê²€ì¦ ì¤‘ì‹¬)

> ìƒì„¸ëŠ” `RU-005-S3.md` ì°¸ê³ .

1. en-US ìš”ì²­ + (ì˜ë„ì ) ë¹„ì¦ˆë‹ˆìŠ¤ ë£° ì‹¤íŒ¨ ìœ ë„ â†’ repair ë©”ì‹œì§€ê°€ ì˜ì–´ì¸ì§€ í™•ì¸
2. ìš”ì²­ ë„ì¤‘ ë¸Œë¼ìš°ì €/í´ë¼ì´ì–¸íŠ¸ì—ì„œ Abort â†’ ì„œë²„ê°€ error/finalì„ ì¶”ê°€ë¡œ ë³´ë‚´ì§€ ì•ŠëŠ”ì§€ í™•ì¸

---

## ğŸ”§ ì‹¤í–‰ ê°€ì´ë“œ

### ê°œë°œìë¥¼ ìœ„í•œ ì‹¤í–‰ ì§€ì¹¨

1. `business_rules.py`ì˜ ë©”ì‹œì§€ë¥¼ ko/en 2ë¶„ê¸°ë¡œ ì •ë¦¬(ìµœì†Œ ë²”ìœ„)
2. `repair_loop.py`ì˜ repair contextë¥¼ ko/en 2ë¶„ê¸°ë¡œ ì •ë¦¬
3. `api/turn.py` ë˜ëŠ” pipeline wrapperì—ì„œ CancelledError ì²˜ë¦¬ ì •ì±…ì„ ëª…ì‹œ

---

## ğŸ“š ì°¸ê³  ìë£Œ

- `backend/src/unknown_world/validation/business_rules.py`
- `backend/src/unknown_world/orchestrator/repair_loop.py`
- `backend/src/unknown_world/api/turn.py`
- `vibe/refactors/RU-003-S1.md` (Abort ì •ì±… ë§¥ë½)

---

## ğŸ·ï¸ íƒœê·¸

`#refactoring` `#edge-cases` `#medium` `#i18n` `#cancel` `#streaming`

