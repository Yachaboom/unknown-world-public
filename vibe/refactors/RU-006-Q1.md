# [ID: RU-006-Q1] 파일 검증/제한 로직 중앙화

## 📌 기본 정보

| 항목 | 내용 |
|:---|:---|
| **ID** | RU-006-Q1 |
| **심각도** | High |
| **카테고리** | 코드 중복 (Q1) |
| **영향 범위** | `services/image_generation.py`, `services/image_understanding.py`, `storage/` (신규) |
| **예상 작업 시간** | 25분 |

---

## 🔍 문제점 상세 분석

### 현재 상황

파일 크기 제한, MIME 타입 검증, 프롬프트 길이 검증 등의 로직이 `image_generation.py`와 `image_understanding.py` 두 곳에서 각각 정의되어 있습니다. 제한값과 검증 로직이 분산되어 있어 정책 변경 시 여러 파일을 수정해야 합니다.

### 문제가 되는 이유

1. **정책 불일치 위험**: 두 서비스의 제한값이 달라질 수 있음 (현재는 동일하지만)
2. **유지보수 비용 증가**: 제한값 변경 시 여러 파일 수정 필요
3. **코드 중복**: 동일한 검증 패턴이 반복됨

### 영향받는 코드 위치

**image_understanding.py:**
```python
# 라인 52-64
ALLOWED_MIME_TYPES = frozenset({
    "image/jpeg", "image/jpg", "image/png", "image/gif", "image/webp",
})
MAX_FILE_SIZE_BYTES = 20 * 1024 * 1024

# 라인 269-295 (validate_image 함수)
def validate_image(content: bytes, content_type: str) -> str | None:
    if content_type.lower() not in ALLOWED_MIME_TYPES:
        return f"지원하지 않는 이미지 형식입니다: {content_type}"
    if len(content) > MAX_FILE_SIZE_BYTES:
        ...
```

**image_generation.py:**
```python
# 라인 57-68
SUPPORTED_SIZES: dict[str, tuple[int, int]] = {...}
DEFAULT_SIZE = "1024x1024"

# 라인 646-666 (validate_image_request 함수)
def validate_image_request(request: ImageGenerationRequest) -> str | None:
    if request.image_size not in SUPPORTED_SIZES:
        return f"지원하지 않는 이미지 크기: {request.image_size}"
    if len(request.prompt) < 3:
        return "프롬프트가 너무 짧습니다."
    ...
```

### 현재 코드 예시

```python
# image_understanding.py:52-68
ALLOWED_MIME_TYPES = frozenset(
    {
        "image/jpeg",
        "image/jpg",
        "image/png",
        "image/gif",
        "image/webp",
    }
)
MAX_FILE_SIZE_BYTES = 20 * 1024 * 1024  # 20MB
```

```python
# image_generation.py:57-64
SUPPORTED_SIZES: dict[str, tuple[int, int]] = {
    "1024x1024": (1024, 1024),
    "1280x768": (1280, 768),
    ...
}
DEFAULT_SIZE = "1024x1024"
```

---

## 💡 개선 방안

### 제안하는 접근법

스토리지 모듈(RU-006-Q4)에 `validation.py`를 추가하여 모든 파일 관련 검증 로직과 제한 상수를 중앙화합니다. 서비스 계층에서는 이 모듈을 import하여 사용합니다.

### 구체적 실행 단계

#### Step 1: 검증 상수 및 함수 중앙화

`backend/src/unknown_world/storage/validation.py` 생성:

**변경 후:**

```python
"""Unknown World - 파일 검증 및 제한 정책.

모든 이미지/아티팩트 관련 검증 로직과 상수를 중앙 관리합니다.

설계 원칙:
    - RULE-007: 에러 메시지에 파일 내용 노출 금지
    - RULE-004: 검증 실패 시 명확한 에러 메시지 반환
"""

from __future__ import annotations

from typing import Final

# =============================================================================
# 이미지 업로드 제한 (Scanner/Vision 공통)
# =============================================================================

ALLOWED_IMAGE_MIME_TYPES: Final[frozenset[str]] = frozenset(
    {
        "image/jpeg",
        "image/jpg",
        "image/png",
        "image/gif",
        "image/webp",
    }
)
"""지원하는 이미지 MIME 타입."""

MAX_IMAGE_FILE_SIZE_BYTES: Final[int] = 20 * 1024 * 1024  # 20MB
"""최대 이미지 파일 크기 (바이트)."""

MIN_IMAGE_FILE_SIZE_BYTES: Final[int] = 100
"""최소 이미지 파일 크기 (손상 파일 감지용)."""

# =============================================================================
# 이미지 생성 제한
# =============================================================================

SUPPORTED_IMAGE_SIZES: Final[dict[str, tuple[int, int]]] = {
    "1024x1024": (1024, 1024),
    "1280x768": (1280, 768),
    "768x1280": (768, 1280),
    "1536x1024": (1536, 1024),
    "1024x1536": (1024, 1536),
}
"""지원하는 이미지 생성 크기."""

DEFAULT_IMAGE_SIZE: Final[str] = "1024x1024"
"""기본 이미지 생성 크기."""

DEFAULT_ASPECT_RATIO: Final[str] = "1:1"
"""기본 가로세로 비율."""

MIN_PROMPT_LENGTH: Final[int] = 3
"""최소 프롬프트 길이."""

MAX_PROMPT_LENGTH: Final[int] = 2000
"""최대 프롬프트 길이."""

# =============================================================================
# bbox 정규화 범위 (RULE-009)
# =============================================================================

BBOX_MIN: Final[int] = 0
"""bbox 최소값."""

BBOX_MAX: Final[int] = 1000
"""bbox 최대값."""


# =============================================================================
# 검증 함수
# =============================================================================


def validate_image_upload(
    content: bytes,
    content_type: str,
    *,
    language: str = "ko-KR",
) -> str | None:
    """업로드 이미지를 검증합니다.

    Args:
        content: 이미지 바이트 데이터
        content_type: MIME 타입
        language: 에러 메시지 언어

    Returns:
        에러 메시지 (없으면 None)
    """
    is_ko = language == "ko-KR"

    # MIME 타입 검증
    if content_type.lower() not in ALLOWED_IMAGE_MIME_TYPES:
        return (
            f"지원하지 않는 이미지 형식입니다: {content_type}"
            if is_ko
            else f"Unsupported image format: {content_type}"
        )

    # 파일 크기 검증 (최대)
    if len(content) > MAX_IMAGE_FILE_SIZE_BYTES:
        size_mb = len(content) / (1024 * 1024)
        return (
            f"파일이 너무 큽니다: {size_mb:.1f}MB (최대 20MB)"
            if is_ko
            else f"File too large: {size_mb:.1f}MB (max 20MB)"
        )

    # 파일 크기 검증 (최소 - 손상 파일 감지)
    if len(content) < MIN_IMAGE_FILE_SIZE_BYTES:
        return (
            "이미지 파일이 손상되었거나 비어있습니다"
            if is_ko
            else "Image file is corrupted or empty"
        )

    return None


def validate_image_generation_request(
    prompt: str,
    image_size: str,
    *,
    language: str = "ko-KR",
) -> str | None:
    """이미지 생성 요청을 검증합니다.

    Args:
        prompt: 이미지 생성 프롬프트
        image_size: 요청된 이미지 크기
        language: 에러 메시지 언어

    Returns:
        에러 메시지 (없으면 None)
    """
    is_ko = language == "ko-KR"

    # 이미지 크기 검증
    if image_size not in SUPPORTED_IMAGE_SIZES:
        return (
            f"지원하지 않는 이미지 크기: {image_size}"
            if is_ko
            else f"Unsupported image size: {image_size}"
        )

    # 프롬프트 길이 검증 (너무 짧음)
    if len(prompt) < MIN_PROMPT_LENGTH:
        return (
            "프롬프트가 너무 짧습니다."
            if is_ko
            else "Prompt is too short."
        )

    # 프롬프트 길이 검증 (너무 김)
    if len(prompt) > MAX_PROMPT_LENGTH:
        return (
            f"프롬프트가 너무 깁니다 (최대 {MAX_PROMPT_LENGTH}자)."
            if is_ko
            else f"Prompt is too long (max {MAX_PROMPT_LENGTH} chars)."
        )

    return None


def get_max_file_size_mb() -> int:
    """최대 파일 크기를 MB 단위로 반환합니다."""
    return MAX_IMAGE_FILE_SIZE_BYTES // (1024 * 1024)
```

#### Step 2: 기존 서비스에서 import 변경

**image_understanding.py 수정:**

```python
# Before (삭제)
ALLOWED_MIME_TYPES = frozenset({...})
MAX_FILE_SIZE_BYTES = 20 * 1024 * 1024
BBOX_MIN = 0
BBOX_MAX = 1000

def validate_image(content: bytes, content_type: str) -> str | None:
    ...

# After (추가)
from unknown_world.storage.validation import (
    ALLOWED_IMAGE_MIME_TYPES as ALLOWED_MIME_TYPES,
    BBOX_MAX,
    BBOX_MIN,
    MAX_IMAGE_FILE_SIZE_BYTES as MAX_FILE_SIZE_BYTES,
    validate_image_upload as validate_image,
)
```

**image_generation.py 수정:**

```python
# Before (삭제)
SUPPORTED_SIZES: dict[str, tuple[int, int]] = {...}
DEFAULT_SIZE = "1024x1024"
DEFAULT_ASPECT_RATIO = "1:1"

def validate_image_request(request: ImageGenerationRequest) -> str | None:
    ...

# After (추가)
from unknown_world.storage.validation import (
    DEFAULT_ASPECT_RATIO,
    DEFAULT_IMAGE_SIZE as DEFAULT_SIZE,
    SUPPORTED_IMAGE_SIZES as SUPPORTED_SIZES,
    validate_image_generation_request,
)

def validate_image_request(request: ImageGenerationRequest) -> str | None:
    return validate_image_generation_request(
        prompt=request.prompt,
        image_size=request.image_size,
    )
```

#### Step 3: __init__.py 내보내기 업데이트

```python
# storage/__init__.py에 추가
from unknown_world.storage.validation import (
    ALLOWED_IMAGE_MIME_TYPES,
    BBOX_MAX,
    BBOX_MIN,
    DEFAULT_ASPECT_RATIO,
    DEFAULT_IMAGE_SIZE,
    MAX_IMAGE_FILE_SIZE_BYTES,
    MIN_IMAGE_FILE_SIZE_BYTES,
    MIN_PROMPT_LENGTH,
    MAX_PROMPT_LENGTH,
    SUPPORTED_IMAGE_SIZES,
    get_max_file_size_mb,
    validate_image_generation_request,
    validate_image_upload,
)
```

---

## 📈 기대 효과

### 즉각적 효과

- ✅ 파일 제한 상수가 단일 파일에서 관리됨
- ✅ 검증 함수 중복 제거 (~40줄 감소)
- ✅ i18n 지원 에러 메시지 통일

### 장기적 효과

- 🎯 제한 정책 변경 시 한 곳만 수정하면 됨
- 🎯 새로운 검증 규칙 추가가 용이함
- 🎯 테스트 작성 시 mock 대상이 명확함

### 정량적 개선 (가능한 경우)

| 지표 | 현재 | 개선 후 | 변화율 |
|:---|:---:|:---:|:---:|
| 상수 정의 위치 | 2곳 | 1곳 | -50% |
| 검증 함수 중복 | 2개 | 0개 | -100% |
| 정책 변경 시 수정 파일 | 2+ | 1 | -50% |

---

## ⚠️ 주의사항 및 고려사항

### 리팩토링 시 주의할 점

1. 기존 import 경로 호환성을 위해 별칭(alias) 사용
2. `ALLOWED_MIME_TYPES` 등 기존 상수명은 그대로 유지하여 외부 참조 호환
3. `api/scanner.py`에서도 `ALLOWED_MIME_TYPES`를 import하므로 동기화 필요

### 영향받는 다른 모듈

- **api/scanner.py**: `from image_understanding import ALLOWED_MIME_TYPES, MAX_FILE_SIZE_BYTES` 경로 수정
- **frontend/src/api/scanner.ts**: 상수값 동기화 필요 (현재 클라이언트에도 하드코딩됨)

### 호환성 체크리스트

- [ ] 기존 import 경로로 접근 가능 (alias 사용)
- [ ] 상수값 변경 없음 (20MB, MIME 타입 등)
- [ ] 검증 로직 동작 동일

---

## 🧪 검증 방법 (수동 검증 중심)

### 변경 전 확인 사항

1. Scanner API에 20MB 이상 파일 업로드 시 에러 메시지 확인
2. 이미지 생성 API에 빈 프롬프트 전송 시 에러 메시지 확인

### 변경 후 검증 시나리오

#### 시나리오 1: Scanner 업로드 검증

- **실행 방법**: `/api/scan`에 25MB JPEG 파일 업로드
- **기대 결과**: `"파일이 너무 큽니다: 25.0MB (최대 20MB)"` 응답
- **확인 사항**:
  - ✅ 에러 메시지 형식 동일
  - ✅ HTTP 상태 코드 동일

#### 시나리오 2: 이미지 생성 프롬프트 검증

- **테스트 입력**: `POST /api/image/generate` with `prompt: "ab"`
- **기대 동작**: `"프롬프트가 너무 짧습니다."` 응답
- **확인 사항**: 에러 메시지 동일

### 회귀 확인 체크리스트

- [ ] Scanner API 정상 동작
- [ ] 이미지 생성 API 정상 동작
- [ ] 에러 응답 형식 동일

---

## 🔧 실행 가이드

### 개발자를 위한 실행 지침

1. **준비 사항**
   - RU-006-Q4 (스토리지 인터페이스) 완료 권장
   - `storage/` 디렉토리 존재 확인

2. **실행 절차**
   - `storage/validation.py` 생성
   - `image_understanding.py`에서 import 변경
   - `image_generation.py`에서 import 변경
   - `api/scanner.py`에서 import 경로 확인

3. **검증 절차**
   - Mock 모드로 서버 실행
   - 파일 크기 초과 테스트
   - 잘못된 MIME 타입 테스트

### 예상 소요 시간

- 코드 수정: 15분
- 검증: 10분
- 총 예상 시간: 25분

---

## 📚 참고 자료

- 관련 설계 패턴: Single Source of Truth (SSOT)
- 관련 문서: `vibe/unit-plans/RU-006[Mvp].md`
- 관련 이슈: RULE-009 (bbox 정규화)

---

## 🏷️ 태그

`#refactoring` `#duplication` `#high` `#validation` `#ssot`

---

## 📝 노트

- 프론트엔드 `scanner.ts`의 `MAX_FILE_SIZE_BYTES` 상수도 동기화 필요
- 향후 아티팩트 저장 시에도 동일한 검증 함수 활용 예정
