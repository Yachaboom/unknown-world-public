# [ID: RU-002-S2] 스트림 이벤트( stage/badges/error 등 ) 검증 강화(Zod) + Unknown/확장 이벤트 폴백 처리로 “깨짐” 방지

## 📌 기본 정보

| 항목               | 내용                     |
| ------------------ | ------------------------ |
| **ID**             | RU-002-S2                |
| **심각도**         | Medium                   |
| **카테고리**       | 엣지 케이스 (Edge Cases) |
| **영향 범위**      | `frontend/src/api/turnStream.ts`, (권장) `frontend/src/types/turn_stream.ts`, `frontend/src/stores/agentStore.ts` |
| **예상 작업 시간** | 30~60분                  |

---

## 🔍 문제점 상세 분석

### 현재 상황

클라이언트는 NDJSON 라인을 JSON.parse한 뒤, `type`만 보고 곧바로 이벤트 타입으로 캐스팅해 처리합니다.

- `final`은 Zod로 TurnOutput을 검증하고 폴백을 제공하지만(`frontend/src/api/turnStream.ts` 199-215),
- `stage/badges/error/narrative_delta`는 “형태 검증 없이” 그대로 store로 흘러갑니다(`frontend/src/api/turnStream.ts` 186-225).

즉, 서버가 사소하게 계약을 바꾸거나(예: status 값/키 변경), 예외 상황에서 이벤트가 깨지면:

- queue가 갱신되지 않거나
- badges UI가 꼬이거나
- AgentConsole이 “원인 모를 상태”로 남는 식의 UX 결함이 발생할 수 있습니다.

또한 향후 `protocol`, `repair`, `telemetry` 같은 확장 이벤트를 도입할 때(현 PRD 요구와도 맞음), **Unknown event를 “그냥 버리는 것”**은 관측성 측면에서 손해입니다.

### 문제가 되는 이유

1. **“스키마/폴백”은 TurnOutput만의 문제가 아님**: stage/badges가 깨지면 “에이전트형 시스템”의 증거(Queue/Badges)가 사라져 데모 체감이 악화됩니다(RULE-008).  
2. **확장 이벤트 도입 시 깨짐 확률 증가**: Unknown type을 버리면, 새 이벤트 도입이 “조용히 무시”되어 디버깅이 어려워집니다.  
3. **부분적 무결성 깨짐은 사용자에게 ‘멈춤’처럼 보임**: UI가 오동작하면 기능 실패로 인식됩니다.

### 영향받는 코드 위치

- `frontend/src/api/turnStream.ts`
  - 라인: 180-226 (`dispatchEvent`가 캐스팅 기반)
  - 라인: 223-225 (unknown type은 console.warn 후 드랍)
- `frontend/src/stores/agentStore.ts`
  - 라인: 144-165 (stage 이벤트 상태 갱신이 status 값에 강하게 결합)

### 현재 코드 예시

```ts
// frontend/src/api/turnStream.ts
switch (type) {
  case StreamEventType.STAGE:
    callbacks.onStage?.(event as StageEvent);
    break;
  // ...
  default:
    console.warn('[TurnStream] Unknown event type:', type);
}
```

---

## 💡 개선 방안

### 제안하는 접근법

**스트림 이벤트도 “경량 검증 + 폴백”**을 적용합니다.

- 각 이벤트별 최소 Zod 스키마를 정의하고 safeParse
- 실패 시:
  - UI를 멈추지 않고(=drop)
  - (선택) AgentConsole에 “Unknown/Invalid event”를 남겨 관측성을 확보

### 구체적 실행 단계

#### Step 1: 이벤트별 Zod 스키마 정의(권장 위치: `frontend/src/types/turn_stream.ts`)

예시(개념):

- `StageEventSchema`: `{type:"stage", name: AgentPhase, status: "start"|"complete"|"ok"|"fail"}`
  - `complete`를 `ok`로 정규화(별칭)하면 RU-002-Q2의 버전 전략과도 호환
- `BadgesEventSchema`: v1(list) + v2(map) 둘 다 허용 후 내부 표준 형태로 변환
- `ErrorEventSchema`: `{type:"error", message: string, code?: string}`
- `NarrativeDeltaEventSchema`: `{type:"narrative_delta", text: string}`
- `FinalEventSchema`: `{type:"final", data?: unknown, turn_output?: unknown}` (alias 후 TurnOutput 검증은 기존대로)

#### Step 2: `dispatchEvent`에서 캐스팅 대신 safeDecode → callbacks로 전달

- decode 실패 시:
  - console.warn은 유지하되
  - (선택) `onError` 콜백에 “INVALID_EVENT”를 보내 AgentConsole에 표기

#### Step 3: AgentStore가 `stage.status=fail`을 표현할 수 있게 보강(선택)

- 현재 PhaseStatus에 `failed`가 이미 있으므로(`frontend/src/stores/agentStore.ts` 30),
- status 값이 `fail`이면 해당 phase를 failed로 표시하는 로직을 추가(향후 repair loop에 필요)

### 대안적 접근법 (선택사항)

- **대안 1(최소)**: Unknown event는 무시하되, stage/badges만 Zod 검증
  - 장점: 변경 최소
  - 단점: 확장 이벤트 관측성은 여전히 부족

---

## 📈 기대 효과

### 즉각적 효과

- ✅ stage/badges가 깨져도 UI 전체가 멈추지 않고, 원인 힌트가 남음
- ✅ PRD 요구(단계/배지 가시화, 내부추론 비노출)를 더 안정적으로 달성

### 장기적 효과

- 🎯 프로토콜 확장/버전업 시 회귀 위험 감소
- 🎯 “왜 Queue/Badges가 안 보이지?” 같은 디버깅 비용 감소

---

## ⚠️ 주의사항 및 고려사항

### 리팩토링 시 주의할 점

1. 이벤트 검증 실패 시 “너무 시끄러운 에러 UX”가 되지 않게, AgentConsole 표시는 요약된 형태로 유지합니다(RULE-008).  
2. Zod 스키마는 엄격하되, “alias 허용(complete/ok, data/turn_output)” 같은 **전방 호환성**을 함께 넣어야 RU-002-Q2와 충돌하지 않습니다.

### 호환성 체크리스트

- [ ] v1 이벤트(현행) 수신 시 정상 처리되는가?
- [ ] alias가 있어도(complete/ok, data/turn_output) 깨지지 않는가?
- [ ] unknown type 이벤트가 들어와도 UI가 멈추지 않는가?

---

## 🧪 검증 방법 (수동 검증 중심)

### 변경 전 확인 사항

- 브라우저 콘솔에서 unknown event/type 상황이 발생하면 어떻게 보이는지 확인(현행은 warn만)

### 변경 후 검증 시나리오

#### 시나리오 1: Unknown event type 주입(개발자용)

- **실행 방법**: 서버가 임시로 `{"type":"protocol","version":"1"}` 같은 이벤트를 한 줄 추가 송출
- **기대 결과**:
  - ✅ UI는 멈추지 않음
  - ✅ (선택) AgentConsole에 “unknown/ignored event” 힌트가 표시됨

#### 시나리오 2: stage.status 별칭 검증

- **실행 방법**: 서버가 `complete` 대신 `ok`를 보내도록 임시 변경
- **기대 결과**:
  - ✅ Queue가 정상적으로 진행/완료 표시

---

## 🔧 실행 가이드

### 개발자를 위한 실행 지침

1. **준비 사항**
   - RU-002-Q2(버전/alias 전략)와 함께 읽고 일관성 유지
2. **실행 절차**
   - 이벤트 Zod 스키마 정의 → dispatchEvent 적용 → store fail 상태 보강(선택)
3. **검증 절차**
   - 시나리오 1~2 수행

---

## 📚 참고 자료

- `vibe/prd.md` 6.8/8.4.3(관측/프로토콜)
- `.cursor/rules/00-core-critical.mdc` (RULE-003/004/008)

---

## 🏷️ 태그

`#refactoring` `#edge-cases` `#medium` `#streaming` `#validation`

---

## 📝 노트

- “final TurnOutput 검증”만으로는 충분하지 않고, **관측 UI(Queue/Badges)도 계약의 일부**로 다뤄야 합니다.


