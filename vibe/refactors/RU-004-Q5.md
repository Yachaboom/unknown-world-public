# [ID: RU-004-Q5] 하드코딩 정리: SaveGame/프로필/초기값 상수 분산으로 정책 변경 시 누락 위험

## 📌 기본 정보

| 항목               | 내용                                                                 |
| ------------------ | -------------------------------------------------------------------- |
| **ID**             | RU-004-Q5                                                            |
| **심각도**         | Medium                                                               |
| **카테고리**       | 하드코딩 (Hard-coded Values)                                         |
| **영향 범위**      | `frontend/src/save/saveGame.ts`, `frontend/src/data/demoProfiles.ts`, `frontend/src/stores/worldStore.ts`, `frontend/src/stores/economyStore.ts`, (간접) `frontend/src/App.tsx` |
| **예상 작업 시간** | 25~60분                                                              |

---

## 🔍 문제점 상세 분석

### 현재 상황

RU-004 범위에서 “정책/초기값”이 여러 파일에 흩어져 하드코딩되어 있습니다.

대표 예시:

- SaveGame
  - `SAVEGAME_VERSION = '1.0.0'`
  - `SAVEGAME_STORAGE_KEY = 'unknown_world_savegame'`
  - `CURRENT_PROFILE_KEY = 'unknown_world_current_profile'`
- Demo Profiles
  - 프로필별 초기 재화(200/150/80 등)
  - seed 생성 규칙: `demo-${profile.id}-${now}`
- Economy/World
  - `lowBalanceThreshold = 10`
  - `worldStore.createInitialState().economy = { signal: 100, memory_shard: 5 }`

이 값들은 모두 “데모 반복성”과 직접 연결된 정책인데, 한 번만 변경해도 다른 곳에서 누락될 수 있습니다.

### 문제가 되는 이유

1. **정책 변경 시 누락 위험**: 예를 들어 storage key를 바꾸면 App/SaveGame/문서가 동시에 맞춰져야 합니다.
2. **초기 상태 SSOT 약화**: “초기 상태는 프로필 초기 SaveGame”이라는 RU-004 목표와 달리, worldStore/economyStore에도 별도의 초기값이 존재합니다.
3. **향후 확장과 충돌**: seed/version 정책은 U-026(리플레이), U-025(엔딩 리포트)에서 중요한 의미를 갖게 됩니다.

---

## 💡 개선 방안

### 제안하는 접근법

“정책 상수”를 한 곳으로 모으고, 초기값의 의미를 명확히 구분합니다.

권장 구조(예시):

- `frontend/src/save/constants.ts`
  - SaveGame 관련 상수: 버전, storage key, seed prefix, 지원 버전 목록 등
- `frontend/src/demo/demoConstants.ts` (또는 `frontend/src/data/demoProfiles.ts` 내부 상수)
  - 데모 프로필 기본 정책(필요 시): 프로필별 기본 seed/초기 재화 범위, “데모 반복성” 정책 메모

그리고 아래 원칙을 문서/코드로 고정합니다.

- **World/Economy store의 “기본값”은 ‘플레이 전 placeholder’**로 취급한다  
  - 실제 게임 시작 값은 항상 프로필 초기 SaveGame 또는 SaveGame 복원에서 주입

### 구체적 실행 단계

#### Step 1: SaveGame 관련 상수 중앙화

`saveGame.ts`에 흩어진 상수를 `constants.ts`로 이동:

- `SAVEGAME_VERSION`
- `SAVEGAME_STORAGE_KEY`
- `CURRENT_PROFILE_KEY`
- (권장) `DEMO_SEED_PREFIX = 'demo'`
- (권장) `SUPPORTED_SAVEGAME_VERSIONS = ['1.0.0']`

#### Step 2: seed/버전 정책을 “의도적으로” 문서화

- Reset 시 seed를 매번 새로 만들지 / 고정 seed를 쓸지 정책을 결정하고 주석/문서로 남깁니다.
  - 데모 반복성(동일 시작) 중시라면 fixed seed가 유리
  - 세션 다양성 중시라면 now 기반 seed가 유리

#### Step 3: 초기값 의미 분리(플레이 전 placeholder vs 프로필 주입)

- `worldStore.createInitialState().economy` 같은 값은 “임시 값”임을 명시하거나,
  - (선택) `economy: null` 같은 “미초기화 상태”로 바꾸고, playing 진입 전에 반드시 프로필/세이브 주입을 강제

> 이 변경은 UI 표시를 바꾸지 않는 선에서(현재 profile_select에서는 HUD가 노출되지 않음) 안전하게 진행 가능합니다.  
> 단, S2(잘못된 playing 진입)도 함께 해결되어야 “placeholder가 화면에 보이는” 문제를 방지할 수 있습니다.

### 대안적 접근법 (선택사항)

- **대안 1**: 상수 파일을 만들지 않고, `saveGame.ts` 내에 “상수 섹션”을 SSOT로 유지  
  - 장점: 파일 추가 최소
  - 단점: demoProfiles/worldStore 등 다른 모듈에서도 같은 정책을 참조해야 하므로 분산이 남음

---

## 📈 기대 효과

### 즉각적 효과

- ✅ storage key/version/seed 정책 변경 시 수정 지점이 줄어 누락 위험 감소
- ✅ “초기 상태 SSOT”가 프로필/세이브 주입으로 명확해져 데모 안정성 향상

### 장기적 효과

- 🎯 SaveGame/Replay/Artifacts 확장 시 seed/version 정책이 일관되게 유지

---

## ⚠️ 주의사항 및 고려사항

1. 상수 중앙화는 “리팩토링”이므로 런타임 동작이 바뀌지 않도록 주의합니다(값 자체를 변경하지 않고 위치만 이동).
2. “미초기화 economy” 같은 설계 변경은 S2의 부팅/Continue 안정화가 선행되면 안전합니다.

---

## 🧪 검증 방법 (수동 검증 중심)

- 프로필 선택/Reset/Continue에서 저장 키와 seed/version이 기대대로 유지되는지 확인
- 잘못된 세이브 상태에서 profile_select로 안전하게 돌아오는지 확인(S2)

---

## 🔧 실행 가이드

1. 상수 파일 생성 또는 상수 섹션 SSOT화
2. 참조처(App/demoProfiles/stores)에서 import로 통일
3. RU-004-S3 수동 시나리오로 회귀 확인

---

## 📚 참고 자료

- `vibe/unit-plans/RU-004[Mvp].md`
- `frontend/src/save/saveGame.ts`
- `frontend/src/data/demoProfiles.ts`
- `frontend/src/stores/worldStore.ts`
- `frontend/src/stores/economyStore.ts`

---

## 🏷️ 태그

`#refactoring` `#hard-coded` `#medium` `#savegame` `#demo` `#constants`

---

## 📝 노트

- RU-004는 “데모 반복성”을 제품 품질로 끌어올리는 작업입니다. 값 자체는 작아 보여도(키/임계치/seed), 한 번의 누락이 데모를 깨뜨리므로 상수/정책을 한 곳에 모으는 것이 실용적입니다.

