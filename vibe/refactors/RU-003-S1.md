# [ID: RU-003-S1] 잠재 버그: 연결 상태/Scene 상태 리셋/취소(Abort) 전파 정책 정리

## 📌 기본 정보

| 항목               | 내용                     |
| ------------------ | ------------------------ |
| **ID**             | RU-003-S1                |
| **심각도**         | High                     |
| **카테고리**       | 잠재적 오류 (Potential Bugs) |
| **영향 범위**      | `frontend/src/App.tsx`, `frontend/src/api/turnStream.ts`, `frontend/src/stores/agentStore.ts`, (권장) `frontend/src/types/scene.ts` |
| **예상 작업 시간** | 20~45분                  |

---

## 🔍 문제점 상세 분석

### 현재 상황

현재 “연결 상태/씬 상태”는 기본 동작은 되지만, 다음과 같은 **사용자 체감 버그**가 숨어 있습니다.

#### (1) 연결 상태가 “한 번 꺼지면” 다시 켜지지 않음

- `isConnected`는 초기값 `true`에서 (`App.tsx` 260)  
  `onError`에서만 `false`로 전환되고(`App.tsx` 426), 성공 시 `true`로 복귀하는 경로가 없습니다.

#### (2) 에러/차단 Scene 상태가 `onComplete`에서 즉시 덮어써짐

- `onError`에서 `sceneState`를 `offline/blocked/low_signal`로 바꾸지만(`App.tsx` 427~435)  
  `onComplete`에서 무조건 `default`로 복원합니다(`App.tsx` 437~442).  
  → 결과적으로 “오프라인/차단” 플레이스홀더가 유지되지 않고, 종료 시점에 기본 화면으로 돌아가 버립니다.

#### (3) Abort(취소) 정책이 UI 복구와 충돌 가능

- `executeTurnStream`은 AbortError인 경우 `onComplete`를 호출하지 않는 정책입니다(`turnStream.ts` 375~402).  
  현재는 “언마운트 시 취소”만 있어 큰 문제는 드러나지 않지만, 향후 Cancel 버튼/Autopilot Pause가 들어오면 **isStreaming이 영구 true로 남는** 유형의 UX 장애로 이어질 수 있습니다.

### 문제가 되는 이유

1. **데모 신뢰도 하락**: 연결 상태가 잘못 표시되거나, 오프라인/차단 화면이 유지되지 않으면 “시스템이 불안정”하게 보입니다.  
2. **상태 경계 혼재(RU-003 핵심)**: 연결/씬 상태가 App local state + 콜백 로직에 흩어져 있어, 정책을 명확히 고정하기 어렵습니다.  
3. **향후 기능(취소/자동 실행) 도입을 막는 구조**: Abort 정책이 명시되지 않으면 UI가 쉽게 “멈춘 것처럼” 보입니다.

### 영향받는 코드 위치

- `frontend/src/App.tsx`
  - `isConnected` 선언: 260
  - `onError`: 424~436
  - `onComplete`: 437~442
- `frontend/src/api/turnStream.ts`
  - Abort 처리 및 onComplete 호출 정책: 375~402

---

## 💡 개선 방안

### 제안하는 접근법

“연결/씬/취소 정책”을 **명시적으로 정의**하고, App의 콜백에서 “무조건 리셋” 같은 암묵적 처리 대신, **상태 전이 규칙(state transition)**으로 구현합니다.

권장 정책(요약):

- **연결 상태**:
  - 스트림 시작 시 `connected=true`로 낙관적 복구
  - 네트워크/서버 에러 시 `connected=false`
  - 다음 성공 스트림에서 `connected=true`로 복귀
- **씬 상태**:
  - 성공 스트림 완료: `default` 또는 `scene`로 전이(SSOT 필드 기준)
  - 에러/차단/신호 부족: 해당 상태 유지(다음 성공 시에만 해제)
- **Abort(취소)**:
  - “취소는 실패가 아니라 사용자 행동”으로 분리
  - 취소 시에도 UI는 “스트리밍 종료 상태”로 복귀해야 함(단, 내러티브/턴 증가 등은 하지 않음)

### 구체적 실행 단계

#### Step 1: `onComplete`에서 sceneState 무조건 리셋 제거

**변경 전**:

- `onComplete`는 항상 `default`로 복귀

**변경 후(권장)**:

- `onError`에서 설정한 `offline/blocked/low_signal`을 **onComplete가 덮어쓰지 않도록** 분기
- 성공 케이스(최소: final 수신)에서만 default 복귀

#### Step 2: 성공 경로에서 `isConnected=true` 복구

권장 위치:

- `startStream()` 직후, 또는 `onFinal`에서 `true`로 복귀

#### Step 3: Abort(취소) UX 대비 골격 추가(정책만 고정)

현재 `turnStream.ts`의 Abort 정책은 “onComplete 호출 안 함”인데, Cancel 버튼이 생기면 UI 복구를 위해 아래 중 하나를 선택해야 합니다.

- **Option A(권장)**: Abort 시에도 `onComplete` 호출 + 별도 플래그로 “취소 종료”를 구분  
  - 장점: UI가 멈추지 않음(복구 일관성)
  - 단점: 취소와 실패를 구분해서 표시하려면 이벤트 모델 확장이 필요할 수 있음
- **Option B(현 정책 유지)**: Abort 시 App/Runner가 `completeStream()`을 직접 호출해 UI를 복구  
  - 장점: turnStream.ts 변경 최소
  - 단점: 취소 호출 지점이 늘면 복구 누락 위험

> RU-003-Q3의 Turn Runner를 도입하면, “취소 → 복구”를 Runner가 단일화하기 쉬워집니다.

---

## 📈 기대 효과

- ✅ 연결 상태 표시가 실제 동작과 일치(오프라인 이후에도 복구 가능)
- ✅ 에러/차단/신호 부족 Scene 플레이스홀더가 안정적으로 유지
- ✅ 향후 Cancel/Autopilot Pause 도입 시 “멈춘 화면” UX를 구조적으로 방지

---

## ⚠️ 주의사항 및 고려사항

- 이 변경은 “UI가 보이는 상태 전이”에 영향을 주므로, 반드시 RU-003-S3 수동 검증으로 확인해야 합니다.
- “final이 오지 않는 에러”에서도 UI가 복구되어야 하며, Economy 인바리언트(RULE-005)는 깨지지 않아야 합니다.

---

## 🧪 검증 방법 (수동 검증 중심)

1. **네트워크 오류 유도**: 백엔드 중지 후 턴 실행 → `offline` 플레이스홀더 유지 확인
2. **백엔드 복구 후 재시도**: 백엔드 재가동 후 턴 실행 → 연결 상태가 `online`으로 복구되는지 확인
3. **차단/신호 부족 코드**: `SAFETY_BLOCKED` / `INSUFFICIENT_BALANCE` 에러에서 상태가 유지되는지 확인

---

## 🔧 실행 가이드

1. `App.tsx`의 `onError/onComplete`에서 sceneState/connection 전이 규칙을 명시적으로 정리
2. (권장) RU-003-Q4(worldStore) 또는 RU-003-Q3(Turn Runner)로 책임을 이동해 누락 지점을 줄임
3. RU-003-S3 수동 시나리오 수행

---

## 📚 참고 자료

- `frontend/src/App.tsx` (콜백에서 연결/씬 상태를 직접 제어)
- `frontend/src/api/turnStream.ts` (Abort/onComplete 정책)
- `.cursor/rules/00-core-critical.mdc` RULE-004/005/008

---

## 🏷️ 태그

`#refactoring` `#stability` `#high` `#streaming` `#state-transition`

