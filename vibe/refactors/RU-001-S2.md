# [ID: RU-001-S2] RULE-011 포트 대역 “엣지 케이스” 방지: Vite `strictPort`와 루트 kill 스크립트 범위 정합화

## 📌 기본 정보

| 항목               | 내용                     |
| ------------------ | ------------------------ |
| **ID**             | RU-001-S2                |
| **심각도**         | Medium                   |
| **카테고리**       | 엣지 케이스 (Edge Cases) |
| **영향 범위**      | `frontend/vite.config.ts`, `package.json`, `vibe/roadmap.md`(포트 안내) |
| **예상 작업 시간** | 15~30분                  |

---

## 🔍 문제점 상세 분석

### 현재 상황

프론트는 `frontend/vite.config.ts`에서 기본 포트를 8001로 지정하고 있으나, `strictPort: false`로 인해 **포트 충돌 시 Vite가 임의의 다음 포트로 이동**합니다.

현재 설정:

```ts
server: {
  port: 8001,
  strictPort: false,
}
```

주석에는 “8002~8010 자동 할당”처럼 보이지만, Vite는 상한(8010)을 알지 못합니다. 즉 **8001~8010이 모두 사용 중이면 8011(백엔드 기본 포트) 이상으로 넘어갈 수 있습니다.**

또한 루트 `package.json`의 `kill:port`는 8001~8015까지만 나열되어 있어, RULE-011의 백엔드 대역(8011~8020)을 “부분만” 커버합니다.

### 문제가 되는 이유

1. **RULE-011 위반 가능**: 프론트가 허용 대역(8001~8010)을 벗어나 실행될 수 있습니다.
2. **CORS/연동 이슈가 “랜덤”하게 발생**: 프론트 포트가 예상과 다르면, 백엔드 CORS allowlist(8001~8010)와 어긋납니다.
3. **정리 스크립트가 불완전**: `kill:port`가 전 대역을 커버하지 않으면, 포트 점유 문제 해결이 더 느려집니다.

### 영향받는 코드 위치

- 파일: `frontend/vite.config.ts`
  - 라인: 7-10 (`server.port`, `strictPort`)
- 파일: `package.json`
  - 라인: 8-10 (`kill:port`/`kill:back`)

### 현재 코드 예시

```ts
// frontend/vite.config.ts
server: {
  port: 8001,
  strictPort: false, // 충돌 시 8002~8010 자동 할당 허용 (※ 실제로는 상한 없음)
},
```

```json
// package.json
"kill:port": "npx kill-port 8001 ... 8015"
```

---

## 💡 개선 방안

### 제안하는 접근법

엣지 케이스를 “발생 후 디버깅”이 아니라, **발생 자체를 막는 방향**으로 정리합니다.

- 프론트 포트는 규칙 대역 밖으로 나가지 않게 **fail-fast**
- 포트 정리 스크립트는 RULE-011 대역을 **정확히 커버**

### 구체적 실행 단계

#### Step 1: `frontend/vite.config.ts`에서 `strictPort: true`로 변경하고, “대역 내 수동 선택”을 문서화

**변경 전:**

```ts
strictPort: false
```

**변경 후(권장):**

```ts
strictPort: true
```

그리고 충돌 시에는:

```bash
pnpm -C frontend dev -- --port 8002
```

처럼 **8002~8010 중 하나를 명시적으로 선택**하도록 안내합니다.

#### Step 2: 루트 `kill:port`가 8001~8020을 커버하도록 정리

**변경 전:**

```json
"kill:port": "npx kill-port 8001 ... 8015"
```

**변경 후(권장):**

```json
"kill:port": "npx kill-port 8001 8002 8003 8004 8005 8006 8007 8008 8009 8010 8011 8012 8013 8014 8015 8016 8017 8018 8019 8020"
```

#### Step 3: `vibe/roadmap.md`의 “빠른 실행”에서 포트 안내를 RULE-011과 일치시키고, 충돌 시 대처를 명시

- 프론트: 8001(충돌 시 8002~8010)
- 백엔드: 8011(충돌 시 8012~8020)

### 대안적 접근법 (선택사항)

- **대안 1(현 상태 유지)**: `strictPort: false` 유지 + “현재는 대부분 8001~8010에서만 동작한다”로 합리화
  - 장점: 개발 편의(자동 포트 이동)
  - 단점: 엣지 케이스에서 RULE-011 위반 및 CORS 불일치가 “랜덤”하게 발생
- **대안 2(스크립트 자동 선택)**: `strictPort: true` + “8001~8010에서 비어있는 포트를 찾아 Vite를 실행”하는 스크립트 추가
  - 장점: 대역 준수 + 편의성 모두 확보
  - 단점: RU-001 범위를 약간 넘어설 수 있음(스크립트 합의 필요)

---

## 📈 기대 효과

### 즉각적 효과

- ✅ 프론트가 RULE-011 대역 밖으로 실행되는 엣지 케이스 제거
- ✅ CORS/연동 이슈가 “랜덤”하게 발생하는 상황 감소
- ✅ 포트 정리(킬) 스크립트의 신뢰도 상승

### 장기적 효과

- 🎯 팀/다중 프로세스 환경에서 “왜 오늘은 안 되지?” 유형의 시간 낭비 감소

### 정량적 개선 (가능한 경우)

| 지표                           | 현재                        | 개선 후                               | 변화율 |
| ------------------------------ | --------------------------- | ------------------------------------- | ------ |
| 포트/CORS 관련 “랜덤 실패” 빈도 | 중간(환경에 따라 재현 어려움) | 낮음(fail-fast + 대역 내 명시 실행)   | ↓      |
| 포트 정리(킬) 성공률           | 부분(8016~8020 누락 가능)   | 높음(8001~8020 전 대역 커버)          | ↑      |

---

## ⚠️ 주의사항 및 고려사항

### 리팩토링 시 주의할 점

1. `strictPort: true`는 “자동 포트 이동”을 막기 때문에, 충돌 시 개발자가 포트를 바꿔야 합니다(대신 예측 가능성이 올라갑니다).
2. 포트 대역은 RULE-011에 고정되어 있으므로, 임의로 5173/3000/8000을 문서에 다시 넣지 않도록 주의합니다.

### 영향받는 다른 모듈

- **Backend CORS 설정**: `backend/src/unknown_world/main.py`의 CORS allowlist는 8001~8010을 가정합니다(대역 밖 프론트 실행 시 실패).
- **Docs/Runbooks**: `vibe/roadmap.md`, U-003/U-004 런북의 “포트 안내”가 함께 정합화되어야 합니다.

### 호환성 체크리스트

- [ ] 8001이 사용 중일 때 프론트가 실패하고, 올바른 가이드(8002~8010)가 제공되는가?
- [ ] `kill:port`로 전체 대역 포트 점유를 정리할 수 있는가?

---

## 🧪 검증 방법 (수동 검증 중심)

### 변경 전 확인 사항

1. 8001이 점유된 상태에서 프론트가 8011 이상(백엔드 대역)으로 이동해 실행될 가능성이 있는지 확인
2. `pnpm kill:port`가 8016~8020을 커버하지 않는지 확인

### 변경 후 검증 시나리오

#### 시나리오 1: 포트 충돌 시 fail-fast 확인

- **실행 방법**:
  - 8001을 다른 프로세스가 점유한 상태에서:

```bash
pnpm -C frontend dev
```

- **기대 결과**:
  - 프론트가 “다른 포트로 몰래 이동”하지 않고, 충돌로 종료된다.

#### 시나리오 2: 대역 내 수동 포트로 재실행 확인

- **실행 방법**:

```bash
pnpm -C frontend dev -- --port 8002
```

- **기대 결과**:
  - 8002에서 정상 실행된다.

#### 시나리오 3: 포트 정리 스크립트 범위 확인

- **실행 방법**:

```bash
pnpm kill:port
```

- **기대 결과**:
  - 8001~8020 포트 점유 프로세스가 정리된다(환경에 따라 권한/프로세스 정책은 확인 필요).

### 회귀 확인 체크리스트

- [ ] 프론트가 대역 밖으로 실행되는 사례가 다시 생기지 않았는가?
- [ ] 문서/주석에서 5173/8000 같은 기본 포트 안내가 재등장하지 않았는가?

---

## 🔧 실행 가이드

### 개발자를 위한 실행 지침

1. **준비 사항**
   - RULE-011(포트 정책) 확인
   - 현재 점유 포트 확인(필요 시 `pnpm kill:port` 사용)

2. **실행 절차**

```bash
# 프론트(대역 내에서만)
pnpm -C frontend dev -- --port 8002

# 백엔드(기본 8011)
pnpm dev:back

# 전체 개발 포트 대역 정리(8001~8020)
pnpm kill:port
```

3. **검증 절차**
   - 프론트가 8001~8010 중 하나에서 실행되는지 확인
   - 백엔드 `/health`(8011) 정상 응답 확인

4. **롤백 계획** (필요시)
   - `frontend/vite.config.ts`의 `strictPort`를 원복
   - `package.json`의 `kill:port` 목록을 원복

### 예상 소요 시간

- 설정 수정: 10~15분
- 수동 검증: 10~15분
- 총 예상 시간: 15~30분

---

## 📚 참고 자료

- `.cursor/rules/00-core-critical.mdc` (RULE-011)
- `frontend/vite.config.ts`
- `package.json`

---

## 🏷️ 태그

`#refactoring` `#stability` `#edge-cases` `#ports` `#rule-011`

---

## 📝 노트

- 이 제안은 “편의(자동 포트 이동)”보다 “예측 가능성(대역 준수)”을 우선합니다. CORS/연동 문제는 랜덤하게 보일수록 해결 비용이 커지므로, fail-fast가 MVP 속도를 오히려 올립니다.


