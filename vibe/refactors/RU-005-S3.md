# [ID: RU-005-S3] RU-005 ì´í›„ â€œ/api/turn stage pipelineâ€ ìˆ˜ë™ ê²€ì¦ ì‹œë‚˜ë¦¬ì˜¤ íŒ¨í‚¤ì§€

## ğŸ“Œ ê¸°ë³¸ ì •ë³´

| í•­ëª©               | ë‚´ìš©                                                                 |
| ------------------ | -------------------------------------------------------------------- |
| **ID**             | RU-005-S3                                                            |
| **ì‹¬ê°ë„**         | Medium                                                               |
| **ì¹´í…Œê³ ë¦¬**       | ìˆ˜ë™ ê²€ì¦ ì‹œë‚˜ë¦¬ì˜¤ (Manual Verification)                             |
| **ì˜í–¥ ë²”ìœ„**      | RU-005 ê´€ë ¨ ë³€ê²½ íŒŒì¼ ì „ë°˜(`api/turn.py`, `orchestrator/*`, stages)  |
| **ì˜ˆìƒ ì‘ì—… ì‹œê°„** | 20~40ë¶„                                                              |

---

## ğŸ” ë¬¸ì œì  ìƒì„¸ ë¶„ì„

### í˜„ì¬ ìƒí™©

RU-005ëŠ” ê¸°ëŠ¥ ì¶”ê°€ê°€ ì•„ë‹ˆë¼ â€œì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° íŒŒì´í”„ë¼ì¸(stage) êµ¬ì¡° ì •ë¦¬â€ ë¦¬íŒ©í† ë§ì…ë‹ˆë‹¤.  
ì´ ì˜ì—­ì€ ìë™ í…ŒìŠ¤íŠ¸ë³´ë‹¤ **ìŠ¤íŠ¸ë¦¬ë° ì´ë²¤íŠ¸ ìˆœì„œ/ë°°ì§€/í´ë°±ì´ UIì— â€˜ì¦ê±°â€™ë¡œ ì˜ ë³´ì´ëŠ”ì§€**ê°€ ë” ì¤‘ìš”í•˜ì§€ë§Œ, RU-005 ì „ìš©ìœ¼ë¡œ ê³ ì •ëœ ìˆ˜ë™ ì‹œë‚˜ë¦¬ì˜¤ ë¬¶ìŒì´ ì—†ìŠµë‹ˆë‹¤.

### ë¬¸ì œê°€ ë˜ëŠ” ì´ìœ 

1. stage/repair/badges/finalì€ í”„ë¡ íŠ¸(Agent Console)ê°€ ì†Œë¹„í•˜ëŠ” ê³„ì•½ì´ë¯€ë¡œ, ì‘ì€ ë³€ê²½ì´ UX íšŒê·€(ë©ˆì¶¤/ì¦ê±° ëˆ„ë½)ë¥¼ ë§Œë“¤ê¸° ì‰½ìŠµë‹ˆë‹¤.
2. mock/real ê²½ë¡œê°€ ë¶„ê¸°ë˜ì–´ ìˆì–´ â€œí•œìª½ë§Œ ê¹¨ì§€ëŠ”â€ íšŒê·€ë¥¼ ë†“ì¹˜ê¸° ì‰½ìŠµë‹ˆë‹¤.

---

## ğŸ’¡ ê°œì„  ë°©ì•ˆ

### ì œì•ˆí•˜ëŠ” ì ‘ê·¼ë²•

RU-005ì—ì„œ ë°”ë€” ìˆ˜ ìˆëŠ” í•µì‹¬ ê²½ë¡œë§Œ ìµœì†Œ 6ê°œ ì‹œë‚˜ë¦¬ì˜¤ë¡œ ê³ ì •í•©ë‹ˆë‹¤.

- ëª©í‘œ: stage/badges/repair/final ì¸ë°”ë¦¬ì–¸íŠ¸ê°€ ìœ ì§€ë¨ì„ ë¹ ë¥´ê²Œ í™•ì¸
- ê¸ˆì§€: ìë™í™” í…ŒìŠ¤íŠ¸ ì½”ë“œ ì œì•ˆ(ë³¸ ë¬¸ì„œì—ì„œëŠ” ìˆ˜ë™ ì ˆì°¨ë§Œ)

---

## ğŸ§ª ê²€ì¦ ë°©ë²• (ìˆ˜ë™ ê²€ì¦ ì¤‘ì‹¬)

### ì¤€ë¹„: ë°±ì—”ë“œ ì‹¤í–‰

```bash
cd backend
uv sync

# ê¸°ë³¸(ê¶Œì¥): mock ëª¨ë“œ
UW_MODE=mock uv run uvicorn unknown_world.main:app --reload --port 8011
```

> ì°¸ê³ : ì‹¤ëª¨ë“œ ê²€ì¦ì€ ì•„ë˜ ì‹œë‚˜ë¦¬ì˜¤ 6ì—ì„œ ì„ íƒì ìœ¼ë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤.

---

## ì‹œë‚˜ë¦¬ì˜¤ 1: í—¬ìŠ¤ì²´í¬/ê¸°ë³¸ ì—°ê²° í™•ì¸

- **ëª©ì **: ì„œë²„ê°€ ì •ìƒ ê¸°ë™í–ˆê³  ìš”ì²­ì´ ê°€ëŠ¥í•œì§€ í™•ì¸
- **ì‹¤í–‰ ë°©ë²•**

```bash
curl -s "http://localhost:8011/health"
```

- **ê¸°ëŒ€ ê²°ê³¼**
  - âœ… `status: ok` ì‘ë‹µ

---

## ì‹œë‚˜ë¦¬ì˜¤ 2: mock ëª¨ë“œ ì •ìƒ ìš”ì²­ â†’ stage/badges/narrative_delta/final ìˆœì„œ í™•ì¸

- **ëª©ì **: ê¸°ë³¸ ì„±ê³µ ê²½ë¡œì—ì„œ ìŠ¤íŠ¸ë¦¬ë° ì´ë²¤íŠ¸ ê³„ì•½ì´ ìœ ì§€ë˜ëŠ”ì§€ í™•ì¸
- **ì‹¤í–‰ ë°©ë²•**

```bash
curl -N -X POST "http://localhost:8011/api/turn?seed=42" \
  -H "Content-Type: application/json" \
  -d '{
    "language": "ko-KR",
    "text": "ë¬¸ì„ ì—´ì–´ë³¸ë‹¤",
    "client": { "viewport_w": 1920, "viewport_h": 1080, "theme": "dark" },
    "economy_snapshot": { "signal": 100, "memory_shard": 5 }
  }'
```

- **ê¸°ëŒ€ ê²°ê³¼**
  - âœ… stage ì´ë²¤íŠ¸ê°€ `parse â†’ validate â†’ plan â†’ resolve â†’ render â†’ verify â†’ commit` ìˆœì„œë¡œ start/completeë¡œ ì¶œë ¥
  - âœ… `badges` ì´ë²¤íŠ¸ê°€ 1íšŒ ì´ìƒ ì¶œë ¥(ê¶Œì¥: 1íšŒ)
  - âœ… `narrative_delta`ê°€ ì—¬ëŸ¬ ë²ˆ ì¶œë ¥(íƒ€ì íš¨ê³¼)
  - âœ… ë§ˆì§€ë§‰ì€ ë°˜ë“œì‹œ `final` 1íšŒë¡œ ì¢…ë£Œ (RULE-004)

---

## ì‹œë‚˜ë¦¬ì˜¤ 3: mock ëª¨ë“œ í´ë°±(ì¬í™” ë¶€ì¡± ìœ ë„) â†’ repair + badges + final(í´ë°±) í™•ì¸

- **ëª©ì **: ë¹„ì¦ˆë‹ˆìŠ¤ ë£° ì‹¤íŒ¨ â†’ ì¬ì‹œë„(repair) â†’ ìµœì¢… í´ë°± ìˆ˜ë ´ ê²½ë¡œê°€ â€œUI ì¦ê±°â€ë¥¼ ë‚¨ê¸°ëŠ”ì§€ í™•ì¸
- **ì‹¤í–‰ ë°©ë²•**

```bash
curl -N -X POST "http://localhost:8011/api/turn?seed=42" \
  -H "Content-Type: application/json" \
  -d '{
    "language": "ko-KR",
    "text": "ë¬´ë¦¬í•˜ê²Œ ëŒì§„í•œë‹¤",
    "client": { "viewport_w": 1920, "viewport_h": 1080, "theme": "dark" },
    "economy_snapshot": { "signal": 0, "memory_shard": 0 }
  }'
```

- **ê¸°ëŒ€ ê²°ê³¼**
  - âœ… `repair` ì´ë²¤íŠ¸ê°€ 1íšŒ ì´ìƒ ì¶œë ¥(ì‹œë„ íšŸìˆ˜ í‘œê¸°)
  - âœ… ìµœì¢…ì ìœ¼ë¡œ `final`(í´ë°± TurnOutput) 1íšŒë¡œ ì¢…ë£Œ
  - âœ… í´ë°± TurnOutputì˜ `economy.cost`ëŠ” 0ì´ê³ , `economy.balance_after`ëŠ” ì…ë ¥ ìŠ¤ëƒ…ìƒ·(0/0)ì„ ë³´ì¡´ (RULE-005)
  - âœ… (ê¶Œì¥) `badges` ì´ë²¤íŠ¸ë„ í´ë°± ê²½ë¡œì—ì„œ ëˆ„ë½ë˜ì§€ ì•ŠìŒ(RU-005-S1 ì ìš© í›„)

---

## ì‹œë‚˜ë¦¬ì˜¤ 4: invalid input â†’ error + final(í´ë°±) ì¢…ë£Œ ì¸ë°”ë¦¬ì–¸íŠ¸ í™•ì¸

- **ëª©ì **: ì…ë ¥ ìŠ¤í‚¤ë§ˆê°€ ê¹¨ì ¸ë„ ë¹ˆ í™”ë©´ ì—†ì´ ì¢…ë£Œë˜ë©°, final 1íšŒë¡œ ìˆ˜ë ´í•˜ëŠ”ì§€ í™•ì¸
- **ì‹¤í–‰ ë°©ë²•**

```bash
curl -N -X POST "http://localhost:8011/api/turn" \
  -H "Content-Type: application/json" \
  -d '{ "language": "ko-KR" }'
```

- **ê¸°ëŒ€ ê²°ê³¼**
  - âœ… `error` ì´ë²¤íŠ¸ 1íšŒ ì¶œë ¥
  - âœ… ì´ì–´ì„œ `final`(í´ë°±) 1íšŒë¡œ ì¢…ë£Œ (RULE-004)

---

## ì‹œë‚˜ë¦¬ì˜¤ 5: en-US ìš”ì²­ â†’ í˜¼í•© ì¶œë ¥(RULE-006) ì—†ëŠ”ì§€ í™•ì¸

- **ëª©ì **: ì˜ì–´ ìš”ì²­ì—ì„œë„ repair/í´ë°±/ì‹œìŠ¤í…œ ë©”ì‹œì§€ê°€ í•œêµ­ì–´ë¡œ ì„ì´ì§€ ì•ŠëŠ”ì§€ í™•ì¸(RU-005-S2)
- **ì‹¤í–‰ ë°©ë²•**

```bash
curl -N -X POST "http://localhost:8011/api/turn?seed=42" \
  -H "Content-Type: application/json" \
  -d '{
    "language": "en-US",
    "text": "Open the door",
    "client": { "viewport_w": 1920, "viewport_h": 1080, "theme": "dark" },
    "economy_snapshot": { "signal": 0, "memory_shard": 0 }
  }'
```

- **ê¸°ëŒ€ ê²°ê³¼**
  - âœ… `repair`/`error`/`final` ë‚´ì˜ ì‚¬ìš©ì ë…¸ì¶œ í…ìŠ¤íŠ¸ê°€ ì˜ì–´ë¡œ ìœ ì§€(í•œêµ­ì–´ í˜¼ì… ì—†ìŒ)

---

## ì‹œë‚˜ë¦¬ì˜¤ 6(ì„ íƒ): real ëª¨ë“œ ê²½ë¡œ â†’ stage/í´ë°± ì¢…ë£Œ í™•ì¸

- **ëª©ì **: real ëª¨ë“œì—ì„œë„ â€œstage/badges/finalâ€ ì¸ë°”ë¦¬ì–¸íŠ¸ê°€ ìœ ì§€ë˜ëŠ”ì§€ í™•ì¸(ì‹¤ì œ ëª¨ë¸ í˜¸ì¶œ ì„±ê³µ ì—¬ë¶€ì™€ ë¬´ê´€)
- **ì‹¤í–‰ ë°©ë²•**
  - ì„œë²„ë¥¼ real ëª¨ë“œë¡œ ì¬ê¸°ë™:

```bash
# ì‹¤í–‰ ì¤‘ì¸ ì„œë²„ ì¤‘ë‹¨ í›„
UW_MODE=real uv run uvicorn unknown_world.main:app --reload --port 8011
```

  - ë™ì¼ ìš”ì²­ì„ ì‹¤í–‰:

```bash
curl -N -X POST "http://localhost:8011/api/turn" \
  -H "Content-Type: application/json" \
  -d '{
    "language": "ko-KR",
    "text": "ë¬¸ì„ ì—´ì–´ë³¸ë‹¤",
    "client": { "viewport_w": 1920, "viewport_h": 1080, "theme": "dark" },
    "economy_snapshot": { "signal": 100, "memory_shard": 5 }
  }'
```

- **ê¸°ëŒ€ ê²°ê³¼**
  - âœ… ëª¨ë¸ í˜¸ì¶œì´ ê°€ëŠ¥í•˜ë©´ ì •ìƒ `final` ìˆ˜ì‹ 
  - âœ… ëª¨ë¸ í˜¸ì¶œì´ ë¶ˆê°€(ê¶Œí•œ/í‚¤/ë„¤íŠ¸ì›Œí¬ ë“±)í•˜ë”ë¼ë„, error + final(í´ë°±)ë¡œ ì¢…ë£Œë˜ì–´ UIê°€ ë©ˆì¶”ì§€ ì•ŠìŒ

---

## ğŸ“ˆ ê¸°ëŒ€ íš¨ê³¼

- âœ… RU-005 ë³€ê²½ í›„ â€œë‹¨ê³„ ê¸°ë°˜ ì¦ê±°(Agent Console)â€ê°€ ê¹¨ì§€ì§€ ì•ŠëŠ”ì§€ ë¹ ë¥´ê²Œ í™•ì¸ ê°€ëŠ¥
- âœ… mock/real ë“œë¦¬í”„íŠ¸ë¥¼ ì‹œë‚˜ë¦¬ì˜¤ ë‹¨ìœ„ë¡œ ì¡°ê¸° íƒì§€ ê°€ëŠ¥

---

## âš ï¸ ì£¼ì˜ì‚¬í•­ ë° ê³ ë ¤ì‚¬í•­

1. ë³¸ ì‹œë‚˜ë¦¬ì˜¤ëŠ” ìë™í™” í…ŒìŠ¤íŠ¸ê°€ ì•„ë‹ˆë¼ ìŠ¤íŠ¸ë¦¬ë° UX/ë°ëª¨ í’ˆì§ˆì„ ìœ„í•œ ìˆ˜ë™ ì ˆì°¨ì…ë‹ˆë‹¤.
2. ì‹œë‚˜ë¦¬ì˜¤ 6(real)ì€ í™˜ê²½(ì„œë¹„ìŠ¤ ê³„ì •/ê¶Œí•œ)ì— ë”°ë¼ ì •ìƒ ê²°ê³¼ê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìœ¼ë‚˜, **ìµœì¢…ì ìœ¼ë¡œ finalë¡œ ìˆ˜ë ´í•´ì•¼ í•œë‹¤**ëŠ” ì¢…ë£Œ ì¸ë°”ë¦¬ì–¸íŠ¸ëŠ” ë™ì¼í•©ë‹ˆë‹¤.

---

## ğŸ”§ ì‹¤í–‰ ê°€ì´ë“œ

1. RU-005 ë³€ê²½ ì ìš© í›„ ì‹œë‚˜ë¦¬ì˜¤ 1~5ë¥¼ ìˆœì„œëŒ€ë¡œ ìˆ˜í–‰(í•„ìˆ˜)
2. ì‹¤ëª¨ë“œ í™˜ê²½ì´ ì¤€ë¹„ë¼ ìˆìœ¼ë©´ ì‹œë‚˜ë¦¬ì˜¤ 6ê¹Œì§€ ìˆ˜í–‰(ì„ íƒ)
3. ì‹¤íŒ¨ ì‹œ â€œì–´ëŠ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ ì–´ë–¤ ì´ë²¤íŠ¸ê°€ ëˆ„ë½/ìˆœì„œê°€ ë°”ë€Œì—ˆëŠ”ì§€â€ë¥¼ ê¸°ë¡í•˜ê³ , ê´€ë ¨ ì œì•ˆì„œ(Q4/Q3/S1/S2)ë¡œ ë˜ëŒì•„ê°€ ì›ì¸ì„ ì¶”ì 

---

## ğŸ“š ì°¸ê³  ìë£Œ

- `vibe/prd.md` 6.8(ê´€ì¸¡ ê°€ëŠ¥ì„±), 8.4(Structured outputs/ê²€ì¦/ë³µêµ¬)
- `backend/src/unknown_world/api/turn.py`
- `backend/src/unknown_world/orchestrator/repair_loop.py`
- `.cursor/rules/20-backend-orchestrator.mdc`

---

## ğŸ·ï¸ íƒœê·¸

`#refactoring` `#manual-verification` `#medium` `#orchestrator` `#streaming` `#stages`

---

## ğŸ“ ë…¸íŠ¸

- RU-005ì˜ ì„±ê³µ ê¸°ì¤€ì€ â€œì½”ë“œê°€ ì •ë¦¬ëë‹¤â€ê°€ ì•„ë‹ˆë¼, stage/badges/repairê°€ **UIì—ì„œ â€˜ë©ˆì¶”ì§€ ì•Šê³ â€™ ì¦ê±°ë¡œ ë³´ì´ëŠ”ì§€**ì…ë‹ˆë‹¤.

