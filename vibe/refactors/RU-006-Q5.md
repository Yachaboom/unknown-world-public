# [ID: RU-006-Q5] 저장 경로 및 URL 하드코딩 제거

## 📌 기본 정보

| 항목 | 내용 |
|:---|:---|
| **ID** | RU-006-Q5 |
| **심각도** | Medium |
| **카테고리** | 하드코딩 (Q5) |
| **영향 범위** | `services/image_generation.py`, `api/image.py`, `main.py`, `storage/` |
| **예상 작업 시간** | 20분 |

---

## 🔍 문제점 상세 분석

### 현재 상황

저장 경로(`generated_images/`), 정적 파일 URL 프리픽스(`/static/images/`), 파일 확장자(`.png`) 등이 여러 파일에 하드코딩되어 있습니다. 경로 정책 변경 시 여러 파일을 동시에 수정해야 하며, 프론트엔드 URL과의 일관성 유지가 어렵습니다.

### 문제가 되는 이유

1. **변경 파급 효과**: 경로 변경 시 최소 4개 파일 수정 필요
2. **불일치 위험**: URL 프리픽스가 서비스마다 다르게 정의될 수 있음
3. **테스트 어려움**: 경로가 하드코딩되어 테스트 환경 격리가 어려움

### 영향받는 코드 위치

**image_generation.py:**
```python
# 라인 55
DEFAULT_OUTPUT_DIR = Path("generated_images")

# 라인 283
image_url = f"/static/images/{final_file_name}"

# 라인 511
image_url = f"/static/images/{final_file_name}"
```

**api/image.py:**
```python
# 라인 250
file_path = DEFAULT_OUTPUT_DIR / f"{image_id}.png"

# 라인 256
image_url=f"/static/images/{image_id}.png" if exists else None

# 라인 280
file_path = DEFAULT_OUTPUT_DIR / f"{image_id}.png"
```

**main.py:**
```python
# 라인 196-197
DEFAULT_OUTPUT_DIR.mkdir(parents=True, exist_ok=True)
app.mount("/static/images", StaticFiles(directory=str(DEFAULT_OUTPUT_DIR)), name="images")
```

### 현재 코드 예시

```python
# image_generation.py:55
DEFAULT_OUTPUT_DIR = Path("generated_images")

# image_generation.py:283
image_url = f"/static/images/{final_file_name}"

# main.py:197
app.mount("/static/images", StaticFiles(directory=str(DEFAULT_OUTPUT_DIR)), name="images")
```

---

## 💡 개선 방안

### 제안하는 접근법

스토리지 모듈(RU-006-Q4)에 경로 상수와 URL 생성 헬퍼를 통합하고, 모든 서비스와 API에서 이를 참조하도록 합니다. 스토리지 인터페이스의 `get_url()` 메서드를 통해 URL을 생성하여 일관성을 보장합니다.

### 구체적 실행 단계

#### Step 1: 경로 상수 중앙화

`backend/src/unknown_world/storage/paths.py` 생성:

**변경 후:**

```python
"""Unknown World - 스토리지 경로 상수.

모든 저장 경로 및 URL 관련 상수를 중앙 관리합니다.
MVP: 로컬 파일 시스템 경로
MMP: GCS 버킷 경로로 확장 예정

페어링 질문 Q1 결정: Option A (backend/.data/ 전용 폴더)
"""

from __future__ import annotations

from pathlib import Path
from typing import Final

# =============================================================================
# 기본 디렉토리 (MVP: 로컬)
# =============================================================================

# 페어링 질문 Q1: Option A - backend/.data/ 전용 폴더
# .gitignore에 .data/ 추가 필수
BASE_DATA_DIR: Final[Path] = Path(".data")
"""모든 데이터 파일의 루트 디렉토리."""

# 하위 호환성을 위한 레거시 경로 (deprecated, 마이그레이션용)
LEGACY_OUTPUT_DIR: Final[Path] = Path("generated_images")
"""[Deprecated] 기존 이미지 저장 경로. .data/로 마이그레이션 권장."""

# =============================================================================
# 카테고리별 서브 경로
# =============================================================================

IMAGES_GENERATED_SUBDIR: Final[str] = "images/generated"
"""생성된 이미지 저장 서브 디렉토리."""

IMAGES_UPLOADED_SUBDIR: Final[str] = "images/uploaded"
"""업로드된 이미지 저장 서브 디렉토리."""

ARTIFACTS_SUBDIR: Final[str] = "artifacts"
"""게임 아티팩트 저장 서브 디렉토리."""

# =============================================================================
# URL 프리픽스
# =============================================================================

STATIC_URL_PREFIX: Final[str] = "/static"
"""정적 파일 서빙 URL 프리픽스."""

# 전체 경로 (자주 사용되는 조합)
STATIC_IMAGES_URL_PREFIX: Final[str] = f"{STATIC_URL_PREFIX}/images"
"""이미지 파일 URL 프리픽스 (예: /static/images/generated/xxx.png)."""

# =============================================================================
# 파일 확장자
# =============================================================================

DEFAULT_IMAGE_EXTENSION: Final[str] = "png"
"""기본 이미지 파일 확장자."""

# =============================================================================
# 경로 헬퍼 함수
# =============================================================================


def get_generated_images_dir() -> Path:
    """생성된 이미지 저장 디렉토리 경로를 반환합니다."""
    return BASE_DATA_DIR / IMAGES_GENERATED_SUBDIR


def get_uploaded_images_dir() -> Path:
    """업로드된 이미지 저장 디렉토리 경로를 반환합니다."""
    return BASE_DATA_DIR / IMAGES_UPLOADED_SUBDIR


def get_artifacts_dir() -> Path:
    """아티팩트 저장 디렉토리 경로를 반환합니다."""
    return BASE_DATA_DIR / ARTIFACTS_SUBDIR


def build_image_url(
    filename: str,
    *,
    category: str = "generated",
) -> str:
    """이미지 파일의 서빙 URL을 생성합니다.

    Args:
        filename: 파일명 (확장자 포함)
        category: 이미지 카테고리 ("generated" 또는 "uploaded")

    Returns:
        서빙 URL (예: /static/images/generated/img_abc123.png)
    """
    return f"{STATIC_URL_PREFIX}/images/{category}/{filename}"


def build_legacy_image_url(filename: str) -> str:
    """[Deprecated] 레거시 이미지 URL을 생성합니다.

    기존 코드 호환성을 위해 유지. 신규 코드에서는 build_image_url() 사용.

    Args:
        filename: 파일명 (확장자 포함)

    Returns:
        레거시 URL (예: /static/images/img_abc123.png)
    """
    return f"/static/images/{filename}"
```

#### Step 2: main.py StaticFiles 마운트 수정

**변경 전:**
```python
from unknown_world.services.image_generation import DEFAULT_OUTPUT_DIR
DEFAULT_OUTPUT_DIR.mkdir(parents=True, exist_ok=True)
app.mount("/static/images", StaticFiles(directory=str(DEFAULT_OUTPUT_DIR)), name="images")
```

**변경 후:**
```python
from unknown_world.storage.paths import BASE_DATA_DIR, STATIC_URL_PREFIX

# 데이터 디렉토리 생성
BASE_DATA_DIR.mkdir(parents=True, exist_ok=True)

# 정적 파일 마운트 (전체 .data 디렉토리를 /static으로 서빙)
app.mount(STATIC_URL_PREFIX, StaticFiles(directory=str(BASE_DATA_DIR)), name="static")
```

#### Step 3: image_generation.py 경로 참조 수정

**변경 전:**
```python
DEFAULT_OUTPUT_DIR = Path("generated_images")
...
image_url = f"/static/images/{final_file_name}"
```

**변경 후:**
```python
from unknown_world.storage.paths import (
    get_generated_images_dir,
    build_image_url,
    LEGACY_OUTPUT_DIR as DEFAULT_OUTPUT_DIR,  # 하위 호환
)

# 생성 시
output_dir = get_generated_images_dir()
output_dir.mkdir(parents=True, exist_ok=True)
...
image_url = build_image_url(final_file_name, category="generated")
```

#### Step 4: api/image.py 경로 참조 수정

**변경 전:**
```python
from unknown_world.services.image_generation import DEFAULT_OUTPUT_DIR
...
file_path = DEFAULT_OUTPUT_DIR / f"{image_id}.png"
image_url=f"/static/images/{image_id}.png"
```

**변경 후:**
```python
from unknown_world.storage.paths import (
    get_generated_images_dir,
    build_image_url,
    DEFAULT_IMAGE_EXTENSION,
)

def get_image_status(image_id: str) -> ImageStatusResponse:
    output_dir = get_generated_images_dir()
    file_path = output_dir / f"{image_id}.{DEFAULT_IMAGE_EXTENSION}"
    exists = file_path.exists()

    return ImageStatusResponse(
        image_id=image_id,
        exists=exists,
        image_url=build_image_url(f"{image_id}.{DEFAULT_IMAGE_EXTENSION}") if exists else None,
    )
```

---

## 📈 기대 효과

### 즉각적 효과

- ✅ 경로 상수가 단일 파일에서 관리됨
- ✅ URL 생성 로직 통일로 불일치 방지
- ✅ 레거시 호환성 유지하면서 점진적 마이그레이션 가능

### 장기적 효과

- 🎯 경로 정책 변경 시 한 곳만 수정
- 🎯 테스트 환경에서 경로 오버라이드 용이
- 🎯 MMP GCS 전환 시 URL 생성 로직만 수정

### 정량적 개선 (가능한 경우)

| 지표 | 현재 | 개선 후 | 변화율 |
|:---|:---:|:---:|:---:|
| 경로 하드코딩 | 6곳 | 1곳 | -83% |
| URL 하드코딩 | 4곳 | 0곳 | -100% |
| 경로 변경 시 수정 파일 | 4 | 1 | -75% |

---

## ⚠️ 주의사항 및 고려사항

### 리팩토링 시 주의할 점

1. 기존 `generated_images/` 디렉토리의 파일 처리 정책 결정 필요
2. StaticFiles 마운트 경로 변경 시 기존 URL 호환성 검토
3. 프론트엔드에서 하드코딩된 `/static/images/` 경로 동기화

### 영향받는 다른 모듈

- **frontend/**: 이미지 URL 경로가 변경되면 프론트엔드도 수정 필요
- **tests/**: 테스트에서 사용하는 경로 상수 import 변경

### 호환성 체크리스트

- [ ] 기존 `/static/images/xxx.png` URL 계속 동작 (레거시 지원)
- [ ] 새로운 `/static/images/generated/xxx.png` URL 추가
- [ ] StaticFiles 마운트 정상 동작

---

## 🧪 검증 방법 (수동 검증 중심)

### 변경 전 확인 사항

1. 기존 생성 이미지가 `/static/images/{id}.png`로 접근 가능한지 확인
2. 이미지 생성 API 응답의 `image_url` 형식 기록

### 변경 후 검증 시나리오

#### 시나리오 1: 새 이미지 생성 및 접근

- **실행 방법**: Mock 모드에서 `/api/image/generate` 호출
- **기대 결과**:
  - 파일이 `.data/images/generated/` 에 저장됨
  - 응답 `image_url`이 `/static/images/generated/xxx.png` 형식
- **확인 사항**:
  - ✅ 해당 URL로 이미지 접근 가능
  - ✅ 파일이 올바른 디렉토리에 생성됨

#### 시나리오 2: 이미지 상태 조회

- **테스트 입력**: `GET /api/image/status/{image_id}`
- **기대 동작**: `image_url` 필드가 새 URL 형식 반환
- **확인 사항**: URL 형식 일관성

### 회귀 확인 체크리스트

- [ ] 이미지 생성 API 정상 동작
- [ ] 이미지 파일 API 정상 동작
- [ ] 정적 파일 서빙 정상 동작

---

## 🔧 실행 가이드

### 개발자를 위한 실행 지침

1. **준비 사항**
   - RU-006-Q4 (스토리지 인터페이스) 완료 필수
   - `.data/` 디렉토리를 `.gitignore`에 추가

2. **실행 절차**
   - `storage/paths.py` 생성
   - `main.py` StaticFiles 마운트 수정
   - `image_generation.py` 경로 참조 수정
   - `api/image.py` 경로 참조 수정

3. **검증 절차**
   - 서버 재시작 후 `/static/` 경로 접근 테스트
   - 이미지 생성 후 URL 확인

4. **롤백 계획** (필요시)
   - `paths.py` 삭제
   - 기존 `DEFAULT_OUTPUT_DIR` 참조 복원

### 예상 소요 시간

- 코드 수정: 15분
- 검증: 5분
- 총 예상 시간: 20분

---

## 📚 참고 자료

- 관련 설계 패턴: Configuration Object Pattern
- 관련 문서: `vibe/unit-plans/RU-006[Mvp].md`
- FastAPI StaticFiles: https://fastapi.tiangolo.com/tutorial/static-files/

---

## 🏷️ 태그

`#refactoring` `#hardcoding` `#medium` `#paths` `#configuration`

---

## 📝 노트

- 기존 `generated_images/` 디렉토리는 `.data/` 마이그레이션 후 삭제 가능
- 프론트엔드의 이미지 URL 참조도 동기화 필요 (별도 작업)
- MMP에서 GCS URL로 전환 시 `build_image_url()` 함수만 수정
