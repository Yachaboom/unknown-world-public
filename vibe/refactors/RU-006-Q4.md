# [ID: RU-006-Q4] 스토리지 인터페이스 추상화 도입

## 📌 기본 정보

| 항목 | 내용 |
|:---|:---|
| **ID** | RU-006-Q4 |
| **심각도** | High |
| **카테고리** | 모듈 설계 (Q4) |
| **영향 범위** | `backend/src/unknown_world/storage/` (신규), `services/image_generation.py`, `services/image_understanding.py`, `api/image.py`, `main.py` |
| **예상 작업 시간** | 45분 |

---

## 🔍 문제점 상세 분석

### 현재 상황

이미지 생성 서비스(`image_generation.py`)와 이미지 이해 서비스(`image_understanding.py`)가 각각 독립적으로 파일 저장/조회 로직을 구현하고 있습니다. MVP에서는 로컬 파일 시스템만 사용하지만, MMP에서 GCS(Google Cloud Storage) 확장이 예정되어 있어 통합된 스토리지 인터페이스가 필요합니다.

### 문제가 되는 이유

1. **확장성 부족**: GCS 전환 시 여러 서비스 파일을 동시에 수정해야 함
2. **중복 로직**: 파일 저장, URL 생성, 경로 관리 코드가 2곳에 분산됨
3. **일관성 위험**: 저장 경로 정책(세션/턴/타입별 분류)이 표준화되지 않음

### 영향받는 코드 위치

- 파일: `backend/src/unknown_world/services/image_generation.py`
- 라인: 54-56, 234-243, 467-470
- 함수: `MockImageGenerator.generate()`, `ImageGenerator.generate()`

- 파일: `backend/src/unknown_world/main.py`
- 라인: 196-197
- 코드: `app.mount("/static/images", ...)`

### 현재 코드 예시

```python
# image_generation.py:54-56
DEFAULT_OUTPUT_DIR = Path("generated_images")

# image_generation.py:234-243
file_name = f"{image_id}.png"
file_path = self._output_dir / file_name
file_path.write_bytes(placeholder_png)
...
image_url = f"/static/images/{final_file_name}"
```

```python
# main.py:196-197
DEFAULT_OUTPUT_DIR.mkdir(parents=True, exist_ok=True)
app.mount("/static/images", StaticFiles(directory=str(DEFAULT_OUTPUT_DIR)), name="images")
```

---

## 💡 개선 방안

### 제안하는 접근법

스토리지 추상화 계층을 도입하여 `put/get/exists/delete` 인터페이스를 정의하고, MVP에서는 `LocalStorage` 구현체만 제공합니다. MMP에서 `GCSStorage` 구현체를 추가하면 서비스 코드 변경 없이 확장이 가능합니다.

### 구체적 실행 단계

#### Step 1: 스토리지 인터페이스 정의

`backend/src/unknown_world/storage/storage.py` 생성:

**변경 후:**

```python
"""Unknown World - 스토리지 추상화 인터페이스.

MVP에서는 로컬 파일 시스템, MMP에서는 GCS로 확장 가능한 구조.

설계 원칙:
    - RULE-007: 파일 내용/경로 로깅 시 메타만 기록
    - RULE-010: DB 대신 파일 기반 저장 우선
"""

from __future__ import annotations

from abc import ABC, abstractmethod
from dataclasses import dataclass
from datetime import datetime
from enum import StrEnum
from pathlib import Path


class StorageCategory(StrEnum):
    """저장 카테고리."""

    GENERATED_IMAGE = "generated_image"
    """생성된 이미지 (U-019)"""

    UPLOADED_IMAGE = "uploaded_image"
    """업로드된 이미지 (U-021, 선택적)"""

    ARTIFACT = "artifact"
    """게임 아티팩트 (엔딩 리포트, 리플레이 등)"""


@dataclass
class StorageMetadata:
    """저장된 파일 메타데이터."""

    key: str
    """스토리지 내 고유 키"""

    category: StorageCategory
    """저장 카테고리"""

    size_bytes: int
    """파일 크기"""

    content_type: str
    """MIME 타입"""

    created_at: datetime
    """생성 시각"""

    url: str
    """접근 URL"""

    session_id: str | None = None
    """세션 ID (선택)"""


@dataclass
class PutResult:
    """저장 결과."""

    success: bool
    key: str
    url: str
    metadata: StorageMetadata | None = None
    error: str | None = None


class StorageInterface(ABC):
    """스토리지 인터페이스 (추상 클래스).

    MVP: LocalStorage 구현
    MMP: GCSStorage 구현 예정
    """

    @abstractmethod
    async def put(
        self,
        data: bytes,
        *,
        category: StorageCategory,
        content_type: str = "image/png",
        file_id: str | None = None,
        session_id: str | None = None,
    ) -> PutResult:
        """파일을 저장합니다.

        Args:
            data: 파일 바이트 데이터
            category: 저장 카테고리
            content_type: MIME 타입
            file_id: 파일 ID (없으면 자동 생성)
            session_id: 세션 ID (경로 분류용)

        Returns:
            PutResult: 저장 결과
        """
        ...

    @abstractmethod
    async def get(self, key: str) -> bytes | None:
        """파일을 조회합니다.

        Args:
            key: 스토리지 키

        Returns:
            파일 바이트 데이터 (없으면 None)
        """
        ...

    @abstractmethod
    async def exists(self, key: str) -> bool:
        """파일 존재 여부를 확인합니다.

        Args:
            key: 스토리지 키

        Returns:
            존재 여부
        """
        ...

    @abstractmethod
    async def delete(self, key: str) -> bool:
        """파일을 삭제합니다.

        Args:
            key: 스토리지 키

        Returns:
            삭제 성공 여부
        """
        ...

    @abstractmethod
    def get_url(self, key: str) -> str:
        """파일 접근 URL을 반환합니다.

        Args:
            key: 스토리지 키

        Returns:
            접근 URL
        """
        ...
```

#### Step 2: LocalStorage 구현체 생성

`backend/src/unknown_world/storage/local_storage.py` 생성:

**변경 후:**

```python
"""Unknown World - 로컬 파일 시스템 스토리지 구현.

MVP 단계에서 사용하는 로컬 저장소 구현체.
페어링 질문 Q1: Option A (backend/.data/ 전용 폴더)

참조:
    - vibe/unit-plans/RU-006[Mvp].md
"""

from __future__ import annotations

import logging
import uuid
from datetime import UTC, datetime
from pathlib import Path

from unknown_world.storage.storage import (
    PutResult,
    StorageCategory,
    StorageInterface,
    StorageMetadata,
)

logger = logging.getLogger(__name__)

# MVP 기본 저장 경로 (Option A: backend/.data/)
DEFAULT_BASE_DIR = Path(".data")

# 카테고리별 서브디렉토리 매핑
CATEGORY_DIRS: dict[StorageCategory, str] = {
    StorageCategory.GENERATED_IMAGE: "images/generated",
    StorageCategory.UPLOADED_IMAGE: "images/uploaded",
    StorageCategory.ARTIFACT: "artifacts",
}

# 정적 파일 서빙 URL 프리픽스
STATIC_URL_PREFIX = "/static"


class LocalStorage(StorageInterface):
    """로컬 파일 시스템 스토리지.

    MVP에서 사용하는 로컬 저장소 구현체.
    """

    def __init__(self, base_dir: Path | None = None) -> None:
        """LocalStorage를 초기화합니다.

        Args:
            base_dir: 기본 저장 디렉토리 (기본값: .data)
        """
        self._base_dir = base_dir or DEFAULT_BASE_DIR
        self._ensure_directories()

        logger.info(
            "[LocalStorage] 초기화 완료",
            extra={"base_dir": str(self._base_dir)},
        )

    def _ensure_directories(self) -> None:
        """카테고리별 디렉토리를 생성합니다."""
        for category, subdir in CATEGORY_DIRS.items():
            dir_path = self._base_dir / subdir
            dir_path.mkdir(parents=True, exist_ok=True)

    def _get_category_dir(self, category: StorageCategory) -> Path:
        """카테고리에 해당하는 디렉토리 경로를 반환합니다."""
        subdir = CATEGORY_DIRS.get(category, "misc")
        return self._base_dir / subdir

    def _generate_key(
        self,
        category: StorageCategory,
        file_id: str | None,
        extension: str = "png",
    ) -> str:
        """스토리지 키를 생성합니다."""
        actual_id = file_id or f"file_{uuid.uuid4().hex[:12]}"
        subdir = CATEGORY_DIRS.get(category, "misc")
        return f"{subdir}/{actual_id}.{extension}"

    async def put(
        self,
        data: bytes,
        *,
        category: StorageCategory,
        content_type: str = "image/png",
        file_id: str | None = None,
        session_id: str | None = None,
    ) -> PutResult:
        """파일을 저장합니다."""
        try:
            # 확장자 추출
            ext_map = {
                "image/png": "png",
                "image/jpeg": "jpg",
                "image/gif": "gif",
                "image/webp": "webp",
                "application/json": "json",
            }
            extension = ext_map.get(content_type, "bin")

            # 키 및 경로 생성
            key = self._generate_key(category, file_id, extension)
            file_path = self._base_dir / key
            file_path.parent.mkdir(parents=True, exist_ok=True)

            # 파일 저장
            file_path.write_bytes(data)

            # URL 생성
            url = self.get_url(key)

            # 메타데이터 생성
            metadata = StorageMetadata(
                key=key,
                category=category,
                size_bytes=len(data),
                content_type=content_type,
                created_at=datetime.now(UTC),
                url=url,
                session_id=session_id,
            )

            logger.debug(
                "[LocalStorage] 파일 저장 완료",
                extra={
                    "key": key,
                    "size_bytes": len(data),
                    "category": category.value,
                },
            )

            return PutResult(
                success=True,
                key=key,
                url=url,
                metadata=metadata,
            )

        except Exception as e:
            error_msg = f"파일 저장 실패: {type(e).__name__}"
            logger.error(
                "[LocalStorage] 저장 실패",
                extra={"error_type": type(e).__name__},
            )
            return PutResult(
                success=False,
                key="",
                url="",
                error=error_msg,
            )

    async def get(self, key: str) -> bytes | None:
        """파일을 조회합니다."""
        file_path = self._base_dir / key
        if not file_path.exists():
            return None
        return file_path.read_bytes()

    async def exists(self, key: str) -> bool:
        """파일 존재 여부를 확인합니다."""
        file_path = self._base_dir / key
        return file_path.exists()

    async def delete(self, key: str) -> bool:
        """파일을 삭제합니다."""
        file_path = self._base_dir / key
        if not file_path.exists():
            return False
        file_path.unlink()
        return True

    def get_url(self, key: str) -> str:
        """파일 접근 URL을 반환합니다."""
        # 로컬 환경에서는 /static 프리픽스로 서빙
        return f"{STATIC_URL_PREFIX}/{key}"

    @property
    def base_dir(self) -> Path:
        """기본 저장 디렉토리."""
        return self._base_dir
```

#### Step 3: 팩토리 및 내보내기 설정

`backend/src/unknown_world/storage/__init__.py` 생성:

```python
"""Unknown World - 스토리지 모듈.

스토리지 추상화 계층을 제공합니다.
MVP: LocalStorage, MMP: GCSStorage(예정)
"""

from unknown_world.storage.local_storage import LocalStorage
from unknown_world.storage.storage import (
    PutResult,
    StorageCategory,
    StorageInterface,
    StorageMetadata,
)

__all__ = [
    "LocalStorage",
    "PutResult",
    "StorageCategory",
    "StorageInterface",
    "StorageMetadata",
    "get_storage",
]

# 싱글톤 인스턴스 캐시
_storage_instance: StorageInterface | None = None


def get_storage(*, force_new: bool = False) -> StorageInterface:
    """스토리지 인스턴스를 반환합니다.

    환경변수에 따라 LocalStorage 또는 GCSStorage를 반환합니다.
    MVP에서는 LocalStorage만 사용합니다.

    Args:
        force_new: True면 캐시를 무시하고 새 인스턴스 생성

    Returns:
        StorageInterface 구현체
    """
    global _storage_instance

    if not force_new and _storage_instance is not None:
        return _storage_instance

    # MVP: LocalStorage만 사용
    # MMP: 환경변수로 GCS 전환 예정
    _storage_instance = LocalStorage()
    return _storage_instance
```

### 대안적 접근법 (선택사항)

- **대안 1**: 환경변수(`STORAGE_BACKEND=local|gcs`)로 런타임 전환
  - 장점: 코드 변경 없이 배포 환경별 전환
  - 단점: 추가 설정 복잡도

- **대안 2**: 의존성 주입(DI) 프레임워크 활용
  - 장점: 테스트 모킹 용이
  - 단점: MVP에서 오버엔지니어링

---

## 📈 기대 효과

### 즉각적 효과

- ✅ 파일 저장 로직이 단일 모듈로 통합됨
- ✅ 서비스 코드에서 파일 시스템 의존성 제거
- ✅ 저장 경로 정책(카테고리별 분류)이 표준화됨

### 장기적 효과

- 🎯 MMP에서 GCS 확장 시 `GCSStorage` 구현체만 추가하면 됨
- 🎯 새로운 저장 카테고리(엔딩 리포트, 리플레이) 추가가 용이함
- 🎯 스토리지 관련 정책(TTL, 용량 제한) 중앙 관리 가능

### 정량적 개선 (가능한 경우)

| 지표 | 현재 | 개선 후 | 변화율 |
|:---|:---:|:---:|:---:|
| 저장 로직 중복 | 2곳 | 1곳 | -50% |
| 경로 하드코딩 | 4곳 | 1곳 | -75% |
| GCS 확장 시 수정 파일 | 5+ | 1 | -80% |

---

## ⚠️ 주의사항 및 고려사항

### 리팩토링 시 주의할 점

1. `DEFAULT_OUTPUT_DIR` 상수를 사용하는 기존 코드 점진적 마이그레이션
2. `main.py`의 StaticFiles 마운트 경로 변경 시 프론트엔드 URL 동기화 필요
3. 기존 `generated_images/` 디렉토리의 파일은 마이그레이션 또는 그대로 유지

### 영향받는 다른 모듈

- **api/image.py**: `DEFAULT_OUTPUT_DIR` 직접 참조 부분 수정
- **main.py**: StaticFiles 마운트 경로를 스토리지 base_dir 기준으로 변경
- **image_generation.py**: `_output_dir` 대신 스토리지 인터페이스 사용

### 호환성 체크리스트

- [ ] 기존 API 계약 유지 (`/static/images/` URL 형식)
- [ ] 하위 호환성 보장 (기존 생성 이미지 접근 가능)
- [ ] 외부 의존성 버전 호환 (신규 패키지 없음)

---

## 🧪 검증 방법 (수동 검증 중심)

### 변경 전 확인 사항

1. `backend/generated_images/` 디렉토리에 기존 이미지 파일 확인
2. `/static/images/{image_id}.png` URL로 이미지 접근 가능 여부 확인

### 변경 후 검증 시나리오

#### 시나리오 1: 이미지 생성 저장 확인

- **실행 방법**: Mock 모드에서 `/api/image/generate` 호출
- **기대 결과**: `.data/images/generated/` 디렉토리에 파일 생성
- **확인 사항**:
  - ✅ 응답의 `image_url`이 `/static/images/generated/...` 형식
  - ✅ 해당 URL로 이미지 접근 가능

#### 시나리오 2: 스토리지 인터페이스 직접 테스트

- **테스트 입력**: `storage.put(b"test", category=StorageCategory.GENERATED_IMAGE)`
- **기대 동작**: `.data/images/generated/` 에 파일 생성 및 URL 반환
- **확인 사항**: `storage.exists(key)` 가 True 반환

### 회귀 확인 체크리스트

- [ ] 기존 기능 정상 동작 (이미지 생성 API)
- [ ] 성능 저하 없음 (파일 I/O 오버헤드 측정)
- [ ] 에러 처리 정상 (저장 실패 시 폴백)

---

## 🔧 실행 가이드

### 개발자를 위한 실행 지침

1. **준비 사항**
   - `backend/src/unknown_world/storage/` 디렉토리 생성
   - 기존 `generated_images/` 파일 백업 (선택)

2. **실행 절차**
   - Step 1~3의 파일 생성
   - `image_generation.py`에서 스토리지 인터페이스 사용으로 점진적 전환
   - `main.py` StaticFiles 마운트 경로 조정

3. **검증 절차**
   - Mock 모드로 서버 실행
   - 이미지 생성 API 호출 후 저장 경로 확인
   - 생성된 URL로 이미지 접근 테스트

4. **롤백 계획** (필요시)
   - 스토리지 모듈 삭제 후 기존 코드 복원
   - `generated_images/` 경로로 StaticFiles 복원

### 예상 소요 시간

- 코드 수정: 30분
- 검증: 15분
- 총 예상 시간: 45분

---

## 📚 참고 자료

- 관련 설계 패턴: Repository Pattern, Abstract Factory
- 관련 문서: `vibe/unit-plans/RU-006[Mvp].md`
- 관련 이슈: MMP U-102 (GCS 스토리지 확장)
- 학습 자료: FastAPI StaticFiles 문서

---

## 🏷️ 태그

`#refactoring` `#module-design` `#high` `#storage` `#extensibility`

---

## 📝 노트

- MMP에서 GCS 확장 시 `backend/src/unknown_world/storage/gcs_storage.py` 추가 예정
- 환경변수 `STORAGE_BACKEND=gcs` 로 런타임 전환 지원 계획
- `.data/` 디렉토리는 `.gitignore`에 추가 필수
