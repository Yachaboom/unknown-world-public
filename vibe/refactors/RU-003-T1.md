# [ID: RU-003-T1] 회기 기술 부채(TODO) 정리: SceneCanvas의 `scene(imageUrl)` 전이 SSOT 확정

## 📌 기본 정보

| 항목               | 내용                         |
| ------------------ | ---------------------------- |
| **ID**             | RU-003-T1                    |
| **심각도**         | Medium                       |
| **카테고리**       | 회기 기록 부채 해결 (Recorded Debt) |
| **영향 범위**      | `frontend/src/App.tsx`, `frontend/src/types/scene.ts`, (조건부) `shared/schemas/turn/turn_output.schema.json`, `frontend/src/schemas/turn.ts` |
| **예상 작업 시간** | 30~75분(백엔드/스키마 연동 여부에 따라) |

---

## 🔍 문제점 상세 분석

### 현재 상황

`frontend/src/App.tsx`에는 SceneCanvas의 `scene` 상태 전이를 위한 TODO가 남아 있습니다.

- TODO 위치: `App.tsx` 440  
  - “TurnOutput에 scene.imageUrl이 있으면 scene 상태로 전환”

하지만 현재 클라이언트 TurnOutput 스키마(`frontend/src/schemas/turn.ts`)에는 “scene image URL”이 SSOT로 정의되어 있지 않고, `SceneCanvasState`(`frontend/src/types/scene.ts`)는 `imageUrl?: string`만 보유합니다.

즉, “무엇을 기준으로 scene 상태로 전환할지”가 **계약 레벨에서 확정되지 않은 상태**입니다.

### 문제가 되는 이유

1. **Scene 상태 전이 규칙이 불명확**  
   지금은 스트리밍 시작 시 `loading`, 종료 시 `default`로 돌아가며(`App.tsx` 412~442), “이미지 존재”를 표현하는 `scene` 상태가 사실상 도달 불가능합니다.
2. **후속 기능(이미지 생성/편집) 도입 시 결합 폭발**  
   이미지 생성이 도입되면 “이미지 URL의 출처(backend? storage? local?)”를 늦게 결정할수록 수정 범위가 커집니다.
3. **상태 경계 정리(RU-003)와 연결됨**  
   Scene 상태는 UI의 핵심 표면(중앙 캔버스)이므로, App local state에 TODO로 남기기보다 worldStore/TurnOutput 계약으로 고정하는 편이 안전합니다.

---

## 💡 개선 방안

### 제안하는 접근법

“Scene 이미지의 SSOT가 무엇인지”를 계약(TurnOutput) 레벨에서 먼저 확정하고, 프론트는 그 계약에만 의존해 `SceneCanvasState`를 전이하도록 정리합니다.

### 구체적 실행 단계

#### Step 1: TurnOutput에 “Scene 이미지 표시 정보”를 넣을지 결정

권장(선택지):

- **Option A(권장)**: TurnOutput에 `ui.scene` 또는 `render.scene` 같은 필드를 추가해 **이미지 URL(또는 asset id)** 를 제공  
  - 예: `turn_output.ui.scene.image_url`  
  - 장점: 프론트는 단순(SSOT가 응답에 있음)
  - 단점: 백엔드/스토리지 설계가 필요
- **Option B(임시/저장소 미도입)**: TurnOutput에는 이미지 “요청”(`render.image_job`)만 두고, 클라이언트는 당분간 placeholder만 유지  
  - 장점: 현재 아키텍처 유지
  - 단점: `scene` 상태는 당분간 사용 불가(기술 부채 유지)

#### Step 2: Scene 상태 전이 규칙을 “한 곳”으로 이동

RU-003-Q4(worldStore) 기준으로, 아래를 `worldStore.applyTurnOutput` 또는 전용 reducer 함수로 고정합니다.

- safety.blocked → `sceneState.status='blocked'`
- error/offline → `sceneState.status='offline'`
- balance 부족 → `sceneState.status='low_signal'`
- 성공 + 이미지 URL 존재(Option A) → `sceneState.status='scene'` + `imageUrl`
- 성공 + 이미지 URL 없음 → `sceneState.status='default'`

#### Step 3: TODO 제거(근거 있는 설계로 대체)

`App.tsx`의 TODO는 “미정”이 아니라, 위 정책에 따라 **명시적인 분기**로 대체합니다.

---

## 📈 기대 효과

- ✅ SceneCanvas의 상태 전이가 계약 기반으로 명확해짐(placeholder ↔ scene)
- ✅ 이미지 생성/편집 기능 확장 시 수정 범위 축소
- ✅ RU-003의 “경계 정리” 목표에 맞게 핵심 UI 표면을 안정화

---

## ⚠️ 주의사항 및 고려사항

- Option A는 백엔드/저장소/URL 수명 정책까지 연결되므로, MVP에서 “즉시 구현”이 아니라도 **계약 방향성만 먼저 합의**하는 것이 중요합니다.
- RULE-008(프롬프트 노출 금지)와 달리, 이미지 URL/asset id는 사용자에게 노출돼도 무방하지만 보안/권한 정책은 별도로 고려해야 합니다.

---

## 🧪 검증 방법 (수동 검증 중심)

- (Option A 구현 시) final 수신 후 SceneCanvas가 `scene` 상태로 전환되고 이미지가 표시되는지 확인
- (Option B 유지 시) 스트리밍 완료 후 SceneCanvas가 의도한 placeholder 상태를 유지하는지 확인(에러/차단/오프라인 포함)

---

## 🔧 실행 가이드

1. “Scene 이미지 SSOT” 선택(Option A/B)
2. 선택한 방향에 맞춰 TurnOutput/스키마/상태 전이 위치를 고정
3. App.tsx의 TODO 제거

---

## 📚 참고 자료

- `frontend/src/types/scene.ts` (`SceneCanvasState.imageUrl`)
- `frontend/src/App.tsx` (sceneState 전이 + TODO)
- `vibe/prd.md` 6.3(멀티모달 렌더링 파이프라인), 6.7/6.8(데모 표면)

---

## 🏷️ 태그

`#refactoring` `#tech-debt` `#medium` `#scene-canvas` `#turnoutput`

