# [ID: RU-001-Q5] 버전 고정(SSOT) 강화: 루트 `packageManager`/엔진 명시 + backend dev 의존성 pin(uv.lock 기준)

## 📌 기본 정보

| 항목               | 내용                     |
| ------------------ | ------------------------ |
| **ID**             | RU-001-Q5                |
| **심각도**         | Medium                   |
| **카테고리**       | 하드코딩 (Hard-coded Values) |
| **영향 범위**      | `package.json`, `backend/pyproject.toml`, `backend/uv.lock`, `vibe/tech-stack.md` |
| **예상 작업 시간** | 20~40분                  |

---

## 🔍 문제점 상세 분석

### 현재 상황

`vibe/tech-stack.md`는 “버전 고정/lockfile 기반 재현성”을 SSOT로 강제합니다(RULE-010).

현재 프론트는 `frontend/package.json`에 `packageManager: "pnpm@10.27.0"`가 명시되어 있으나, **루트 `package.json`에는 packageManager/engine 정보가 없습니다.**  
또한 백엔드는 `backend/pyproject.toml`의 dev dependency가 `>=` 형태로 되어 있어, lockfile(`backend/uv.lock`)과 실제 설치 버전이 **드리프트**할 여지가 있습니다.

### 문제가 되는 이유

1. **도구 버전 드리프트**: 루트에서 `pnpm` 버전이 달라지면 실행 스크립트/lockfile 해석이 달라질 수 있습니다.
2. **RULE-010 위반 위험**: “최신이라서” 도구/의존성이 올라가면 데모 재현성이 깨집니다.
3. **backend dev dependency는 실제로 실행 흐름에 영향**: 예를 들어 `pytest`/`httpx`는 통합 검증 및 개발 루프에서 사용되며, 버전 상승은 예상치 않은 실패/경고를 유발할 수 있습니다.

### 영향받는 코드 위치

- 파일: `package.json`
  - 라인: 1-14 (루트 packageManager 미기재)
- 파일: `backend/pyproject.toml`
  - 라인: 22-28 (dev deps가 `>=`)
- 파일: `backend/uv.lock`
  - 라인: (패키지 엔트리) `pytest 9.0.2`, `httpx 0.28.1` (해결된 버전 확인 가능)

### 현재 코드 예시

```toml
# backend/pyproject.toml (발췌)
[dependency-groups]
dev = [
    "ruff==0.14.10",
    "pyright==1.1.407",
    "pytest>=9.0.2",
    "httpx>=0.28.1",
]
```

```toml
# backend/uv.lock (발췌)
name = "pytest"
version = "9.0.2"
...
name = "httpx"
version = "0.28.1"
```

---

## 💡 개선 방안

### 제안하는 접근법

**“SSOT(tech-stack) + lockfile(uv.lock/pnpm-lock)”를 기준으로, 루트에도 동일한 고정 신호를 준다**가 목표입니다.

즉:

- 루트에 `packageManager`를 명시하여 pnpm 버전을 고정
- 백엔드 dev deps는 `uv.lock`에 이미 해결된 버전으로 pin(드리프트 방지)
- (선택) `engines`로 Node 버전도 명시하여 팀 온보딩 비용 감소

### 구체적 실행 단계

#### Step 1: 루트 `package.json`에 `packageManager`를 추가 (pnpm 버전 SSOT 신호)

**변경 전:**

```json
{
  "name": "unknown-world",
  "version": "0.1.0",
  "private": true
}
```

**변경 후(권장):**

```json
{
  "name": "unknown-world",
  "version": "0.1.0",
  "private": true,
  "packageManager": "pnpm@10.27.0"
}
```

> 근거: `vibe/tech-stack.md` 1.1에서 pnpm `10.27.0` 권장.

#### Step 2: `backend/pyproject.toml` dev deps를 `uv.lock` 해결 버전으로 pin

**변경 전:**

```toml
"pytest>=9.0.2",
"httpx>=0.28.1",
```

**변경 후(권장):**

```toml
"pytest==9.0.2",
"httpx==0.28.1",
```

> 근거: `backend/uv.lock`에 이미 `pytest 9.0.2`, `httpx 0.28.1`로 해결되어 있음.

#### Step 3(선택): 루트에 `engines`를 추가해 Node 버전 편차를 줄이기

`vibe/tech-stack.md`의 Node 버전(24.12.0)을 팀 표준으로 사용할 경우:

```json
"engines": {
  "node": "24.12.0"
}
```

> Windows 개발 환경에서 강제 도구를 추가하지 않고도 “권장 버전”을 명시하는 효과가 있습니다.

### 대안적 접근법 (선택사항)

- **대안 1**: dev deps `>=` 유지 + `uv.lock`만 신뢰
  - 장점: pyproject 변경이 적음
  - 단점: “사람이 lockfile을 항상 지킨다”는 가정이 필요(드리프트 가능)
- **대안 2**: tech-stack에 pytest/httpx 버전까지 SSOT로 추가하고 전부 pin
  - 장점: 문서-코드 정합성 최대
  - 단점: tech-stack의 유지보수 범위가 커짐(하지만 장기적으로는 더 안정적)

---

## 📈 기대 효과

### 즉각적 효과

- ✅ 개발 환경에서 pnpm 버전 혼선 감소(루트에서도 고정 신호)
- ✅ 백엔드 dev deps 드리프트 제거(uv.lock과 일치)
- ✅ RULE-010(임의 업그레이드 금지) 준수 강화

### 장기적 효과

- 🎯 데모 재현성/온보딩 성공률 향상(“환경이 달라서 안 됨” 유형 감소)

### 정량적 개선 (가능한 경우)

| 지표                    | 현재               | 개선 후                  | 변화율 |
| ----------------------- | ------------------ | ------------------------ | ------ |
| 의존성/도구 버전 편차   | 발생 가능           | 낮음(pin + packageManager) | ↓      |
| 실행 환경 이슈(재현성)  | 중간               | 낮음                     | ↓      |

---

## ⚠️ 주의사항 및 고려사항

### 리팩토링 시 주의할 점

1. “pin”은 안정성을 주지만, 업데이트 시에는 반드시 `tech-stack` 근거와 함께 진행해야 합니다.
2. `engines`는 강제보다 “경고/가이드” 목적이므로, 팀 도구(Volta 등) 도입은 RU-001 범위를 넘지 않게 합니다.

### 영향받는 다른 모듈

- **U-003(UV 기반 백엔드)**: `uv sync` 재현성 강화
- **프론트 빌드/개발 스크립트**: pnpm 버전 일관성 확보

### 호환성 체크리스트

- [ ] 루트에서 `pnpm -v`가 기대 버전인지 확인 가능한가?
- [ ] `uv sync`가 lockfile 기준으로 동일 버전을 설치하는가?

---

## 🧪 검증 방법 (수동 검증 중심)

### 변경 전 확인 사항

1. 루트 `package.json`에 `packageManager`가 없어도 개발이 “되는 것처럼 보이지만”, 팀/환경에 따라 pnpm 버전이 달라질 수 있음을 확인
2. `backend/pyproject.toml`의 dev deps가 `>=`라서, lockfile 업데이트 없이도 설치 버전이 바뀔 가능성이 있음을 확인

### 변경 후 검증 시나리오

#### 시나리오 1: 루트 packageManager 표시 확인

- **실행 방법**:

```bash
node -v
pnpm -v
cat package.json | head -40
```

- **기대 결과**:
  - 루트 `package.json`에 `packageManager: "pnpm@10.27.0"`가 존재

#### 시나리오 2: backend dev deps가 lockfile과 일치하는지 확인

- **실행 방법**:

```bash
cd backend
uv sync
```

- **기대 결과**:
  - `pytest==9.0.2`, `httpx==0.28.1` 기준으로 설치가 재현됨

### 회귀 확인 체크리스트

- [ ] 루트 `packageManager` 값이 임의로 변경/삭제되지 않았는가?
- [ ] backend dev deps가 다시 `>=` 형태로 돌아가지 않았는가?
- [ ] `uv.lock` 갱신 없이 의존성 버전이 드리프트하지 않는가?

---

## 🔧 실행 가이드

### 개발자를 위한 실행 지침

1. **준비 사항**
   - `vibe/tech-stack.md`의 pnpm 버전(10.27.0) 확인
   - backend는 `uv` 기반(uv.lock 존재)임을 확인

2. **실행 절차**

```bash
# 루트: pnpm 버전 확인(팀 표준)
pnpm -v

# 백엔드: lockfile 기반 설치
cd backend
uv sync
```

3. **검증 절차**
   - 루트 `package.json`에 `packageManager`가 존재하는지 확인
   - `backend/uv.lock`의 해결 버전(예: pytest 9.0.2, httpx 0.28.1)과 일치하는지 확인

4. **롤백 계획** (필요시)
   - `package.json`의 `packageManager`/`engines` 변경을 원복
   - `backend/pyproject.toml` dev deps pin 변경을 원복(단, 재현성 저하를 감수)

### 예상 소요 시간

- 설정 수정: 10~20분
- 수동 검증: 10~20분
- 총 예상 시간: 20~40분

---

## 📚 참고 자료

- `vibe/tech-stack.md` (pnpm/Node/Python SSOT)
- `.cursor/rules/00-core-critical.mdc` (RULE-010)
- `backend/uv.lock` (해결 버전 근거)

---

## 🏷️ 태그

`#refactoring` `#hardcoded` `#versions` `#ssot` `#reproducibility`

---

## 📝 노트

- RU-001의 목적은 “기능 구현 속도”를 늦추는 것이 아니라, **데모/개발 재현성(동일한 커맨드가 동일한 결과를 내는 것)**을 빠르게 확보하는 것입니다. MVP일수록 pinning의 가치가 큽니다.


