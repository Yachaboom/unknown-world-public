# [ID: RU-001-S1] `.gitignore`의 광범위 `*.json` 차단으로 스키마 SSOT(Option B) 및 안전한 설정 파일 커밋이 “조용히 실패”하는 문제

## 📌 기본 정보

| 항목               | 내용                     |
| ------------------ | ------------------------ |
| **ID**             | RU-001-S1                |
| **심각도**         | Critical                 |
| **카테고리**       | 잠재적 오류 (Potential Bugs) |
| **영향 범위**      | `.gitignore`, (예정) `shared/**/*.json`, 추후 U-005~U-008(스키마/스트리밍) |
| **예상 작업 시간** | 20~40분                  |

---

## 🔍 문제점 상세 분석

### 현재 상황

현재 레포의 `.gitignore`는 보안(RULE-007)을 이유로 **모든 `*.json` 파일을 기본적으로 ignore**하고 일부 파일만 예외 처리하고 있습니다. 이 방식은 초기에는 안전해 보이지만, RU-001의 페어링 결정(**Q1 Option B: `shared/` JSON Schema SSOT**)과 정면 충돌하며, “필수 JSON 파일(스키마/설정)”이 **Git에 추가되지 않는 상태가 정상처럼 보이는** 위험한 형태가 됩니다.

### 문제가 되는 이유

1. **SSOT(스키마) 도입이 구조적으로 막힘**: `shared/schemas/*.json` 같은 “커밋되어야 하는 JSON”이 기본 ignore 됩니다. (RU-001 Q1 Option B 불가)
2. **실패가 조용히 발생**: 개발자가 JSON 스키마 파일을 추가해도 `git status`에 나타나지 않아, 이후 유닛(U-005/U-006)에서 “파일이 없다/스키마가 없다” 같은 문제로 이어집니다.
3. **예외 목록이 계속 늘어나는 유지보수 지옥**: JSON 기반 설정/아티팩트가 늘어날수록 `!xxx.json` 예외를 계속 추가해야 하고, 팀 합의 없이도 쉽게 누락됩니다.

### 영향받는 코드 위치

- 파일: `.gitignore`
- 라인: 11-21
- 함수/클래스: N/A

### 현재 코드 예시

```gitignore
# Vertex AI / GCP Service Account Keys
*.json
!package.json
!tsconfig.json
!pyrightconfig.json
**/service-account*.json
**/credentials*.json
**/keyfile*.json
**/gcp-*.json
**/vertex-*.json
```

또한 현재 레포에는 생성물로 보이는 `frontend/vite.config.d.ts.map`이 Git에 추적되고 있습니다(정리 대상이지만, 지금 상태로는 “무엇이 생성물/무엇이 소스인지” 판단이 더 어려워집니다).

---

## 💡 개선 방안

### 제안하는 접근법

**“JSON 전체 차단” 대신 “비밀 JSON만 강차단 + 스키마/설정 JSON은 허용”** 구조로 바꿉니다.

핵심은 2가지입니다:

- **(A) 위험한 JSON(서비스계정/크리덴셜 등)은 강하게 차단**
- **(B) SSOT에 필요한 JSON(스키마)은 명시적으로 허용**

### 구체적 실행 단계

#### Step 1: `.gitignore`의 `*.json` 전역 차단을 제거/완화하고, 스키마 디렉토리를 allowlist로 허용

**변경 전:**

```gitignore
*.json
!package.json
!tsconfig.json
!pyrightconfig.json
```

**변경 후(권장안):**

```gitignore
# JSON 전체 차단 금지: 스키마/설정 JSON이 늘어나는 프로젝트 특성상 불가
# 대신 "비밀 JSON"을 파일명/경로 기반으로 강차단한다.

# ✅ Shared JSON Schema SSOT (RU-001 Q1 Option B)
!shared/**/*.json

# 🔐 Credential-like JSONs (RULE-007) - 강차단 유지/확대
**/service-account*.json
**/*service_account*.json
**/credentials*.json
**/*credential*.json
**/keyfile*.json
**/gcp-*.json
**/vertex-*.json
```

> 참고: 위 “변경 후”는 예시이며, 실제 적용 시에는 `shared/` 폴더 도입과 함께 병행하는 것이 안전합니다.

#### Step 2: “키 파일은 오직 `secrets/`에만 둔다” 규칙을 문서로 고정하고(README/roadmap), 해당 경로는 계속 ignore

이미 `.gitignore`에 존재하는:

```gitignore
secrets/
.secrets/
```

를 **팀 표준**으로 격상합니다.

#### Step 3: 생성물/산출물 누락 방지(소스 오염 차단) — `*.d.ts.map` 같은 생성물 ignore 보강

현재 `frontend/vite.config.d.ts.map`는 Git에 추적 중입니다.

예시 보강:

```gitignore
# TS build artifacts (frontend)
frontend/*.d.ts.map
frontend/*.d.ts
frontend/*.js.map
```

### 대안적 접근법 (선택사항)

- **대안 1(보수적)**: `*.json` 차단을 유지하되, `!shared/**/*.json`만 추가
  - 장점: 보안 측면에서 “기본 차단” 유지
  - 단점: JSON 설정/아티팩트가 늘어날 때마다 예외가 계속 필요(누락 위험 지속)
- **대안 2(강경)**: 서비스계정 키 파일 커밋 방지용으로 `.gitignore`가 아니라 “Pre-commit/secret scan” 도입
  - 장점: 파일 확장자 기반 차단에서 벗어남
  - 단점: RU-001 범위를 넘어설 수 있음(추후 MMP로 미루는 게 현실적)

---

## 📈 기대 효과

### 즉각적 효과

- ✅ RU-001 페어링 결정(Option B: `shared/` JSON Schema SSOT) 실행 가능
- ✅ “스키마 파일이 Git에 안 들어간 채로 진행”되는 조용한 실패 차단
- ✅ 생성물(예: `*.d.ts.map`)의 오염을 구조적으로 감소

### 장기적 효과

- 🎯 U-005~U-008(스키마/스트리밍)에서 “SSOT 부재/불일치”로 낭비되는 시간을 크게 줄임
- 🎯 보안(RULE-007)과 개발 생산성을 동시에 만족하는 ignore 정책으로 안정화

### 정량적 개선 (가능한 경우)

| 지표                     | 현재                         | 개선 후                              | 변화율 |
| ------------------------ | ---------------------------- | ------------------------------------ | ------ |
| 스키마 파일 커밋 성공률  | 낮음(기본 ignore로 누락 가능) | 높음(`shared/**/*.json` 허용/가드)   | ↑      |
| 신규 JSON 추가 시 실수율 | 예외 추가 누락 가능           | “스키마/설정 허용 + 비밀만 차단”로 ↓ | ↓      |

---

## ⚠️ 주의사항 및 고려사항

### 리팩토링 시 주의할 점

1. `.gitignore` 변경은 “보안 정책”이므로 PRD/RULE 근거를 함께 남겨야 합니다.
2. `shared/` allowlist를 열면, **키 파일이 `shared/`에 들어가는 실수**를 막기 위한 팀 규칙(README 경고)이 필요합니다.
3. `*.json` 전역 차단을 제거할 경우, credential 패턴을 충분히 촘촘하게 유지해야 합니다.

### 영향받는 다른 모듈

- **U-005/U-006**: TurnInput/TurnOutput 스키마 파일 위치가 SSOT가 되므로, 향후 경로 고정에 직접 영향
- **RU-010[Mmp]**: “스키마/상수 SSOT 강화”의 선행 기반이 됨

### 호환성 체크리스트

- [ ] 기존 파일 추적 상태(Tracked files)가 예상치 않게 변하지 않는지 확인
- [ ] 서비스 계정/크리덴셜 JSON이 Git에 올라갈 가능성이 없는지 확인
- [ ] `shared/**/*.json`이 정상적으로 add 되는지 확인

---

## 🧪 검증 방법 (수동 검증 중심)

### 변경 전 확인 사항

1. (예정) `shared/schemas/turn_output.schema.json`을 만들어도 `git status`에 나타나지 않는 현상이 있는지 확인
2. `git check-ignore -v <파일경로>`로 ignore 근거를 확인

### 변경 후 검증 시나리오

#### 시나리오 1: 스키마 JSON이 정상적으로 커밋 대상이 되는지 확인

- **실행 방법**:

```bash
mkdir -p shared/schemas
echo "{\"type\":\"object\"}" > shared/schemas/_ignore-check.schema.json
git check-ignore -v shared/schemas/_ignore-check.schema.json || echo "NOT IGNORED ✅"
git status --porcelain
```

- **기대 결과**:
  - `git check-ignore`가 출력되지 않거나 “NOT IGNORED ✅”가 찍힌다.
  - `git status`에 새 파일이 표시된다.

#### 시나리오 2: 서비스 계정 JSON이 계속 ignore 되는지 확인

- **실행 방법**:

```bash
mkdir -p secrets
echo "{\"type\":\"service_account\"}" > secrets/service-account.json
git check-ignore -v secrets/service-account.json
```

- **기대 결과**:
  - `secrets/service-account.json`은 ignore 근거가 출력된다.

### 회귀 확인 체크리스트

- [ ] 기존 설정 파일들이 갑자기 unignore 되어 노이즈가 증가하지 않았는가?
- [ ] 보안 관련 JSON이 추적 상태로 바뀌지 않았는가?

---

## 🔧 실행 가이드

### 개발자를 위한 실행 지침

1. **준비 사항**
   - `.cursor/rules/00-core-critical.mdc`의 RULE-007/010 확인
   - RU-001 페어링 결정(Q1 Option B) 재확인

2. **실행 절차**

```bash
# 1) .gitignore 수정
# 2) ignore 동작 확인
git check-ignore -v shared/schemas/_ignore-check.schema.json || true
git check-ignore -v secrets/service-account.json || true
```

3. **검증 절차**
   - 위 “수동 검증 시나리오” 2개 수행

4. **롤백 계획** (필요시)
   - `.gitignore` 변경만 되돌리면 됨(파일 추적 상태 변화는 `git rm --cached` 등으로 복구 가능)

### 예상 소요 시간

- 설정 수정: 10~15분
- 수동 검증: 10~15분
- 총 예상 시간: 20~30분

---

## 📚 참고 자료

- 관련 문서: `.cursor/rules/00-core-critical.mdc` (RULE-007/010)
- 관련 문서: `vibe/unit-plans/RU-001[Mvp].md` (페어링 Q1 Option B)
- 관련 문서: `vibe/tech-stack.md` (SSOT, 버전 고정)

---

## 🏷️ 태그

`#refactoring` `#stability` `#critical` `#gitignore` `#security` `#schema-ssot`

---

## 📝 노트

- 이 제안은 “보안 강화”를 약화시키려는 것이 아니라, **스키마 SSOT를 가능하게 하면서도 RULE-007을 더 정확하게 강제**하기 위한 정책 재설계입니다.


