# [ID: RU-006-S1] ì—…ë¡œë“œ ì´ë¯¸ì§€ ì„ì‹œ ì €ì¥ ì •ì±… ëª…í™•í™”

## ğŸ“Œ ê¸°ë³¸ ì •ë³´

| í•­ëª© | ë‚´ìš© |
|:---|:---|
| **ID** | RU-006-S1 |
| **ì‹¬ê°ë„** | Medium |
| **ì¹´í…Œê³ ë¦¬** | ì ì¬ì  ì˜¤ë¥˜ (S1) |
| **ì˜í–¥ ë²”ìœ„** | `services/image_understanding.py`, `api/scanner.py`, `storage/` |
| **ì˜ˆìƒ ì‘ì—… ì‹œê°„** | 20ë¶„ |

---

## ğŸ” ë¬¸ì œì  ìƒì„¸ ë¶„ì„

### í˜„ì¬ ìƒí™©

Scanner ì—”ë“œí¬ì¸íŠ¸(`/api/scan`)ì—ì„œ ì—…ë¡œë“œëœ ì´ë¯¸ì§€ëŠ” ë©”ëª¨ë¦¬ì—ì„œ ì¦‰ì‹œ ì²˜ë¦¬ë˜ê³  ë¹„ì „ ëª¨ë¸ í˜¸ì¶œ í›„ íê¸°ë©ë‹ˆë‹¤. ë¶„ì„ ê²°ê³¼ì—ì„œ ì¶”ì¶œëœ ì•„ì´í…œ í›„ë³´ì˜ `source_object_index`ê°€ ì›ë³¸ ì´ë¯¸ì§€ì™€ ì—°ê²°ë˜ì§€ë§Œ, ì›ë³¸ ì´ë¯¸ì§€ ìì²´ëŠ” ì €ì¥ë˜ì§€ ì•Šì•„ ë‚˜ì¤‘ì— ì¬ë¶„ì„í•˜ê±°ë‚˜ ë””ë²„ê¹…í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

### ë¬¸ì œê°€ ë˜ëŠ” ì´ìœ 

1. **ë””ë²„ê¹… ì–´ë ¤ì›€**: ë¶„ì„ ê²°ê³¼ì— ë¬¸ì œê°€ ìˆì„ ë•Œ ì›ë³¸ ì´ë¯¸ì§€ë¥¼ í™•ì¸í•  ë°©ë²•ì´ ì—†ìŒ
2. **ì¬ì²˜ë¦¬ ë¶ˆê°€**: ëª¨ë¸ ì—…ê·¸ë ˆì´ë“œ í›„ ê¸°ì¡´ ì—…ë¡œë“œ ì´ë¯¸ì§€ ì¬ë¶„ì„ ë¶ˆê°€
3. **ì•„ì´í…œ-ì´ë¯¸ì§€ ì—°ê²° ìƒì‹¤**: ì¸ë²¤í† ë¦¬ì— ì¶”ê°€ëœ ì•„ì´í…œì˜ ì¶œì²˜ ì´ë¯¸ì§€ ì¶”ì  ë¶ˆê°€

### ì˜í–¥ë°›ëŠ” ì½”ë“œ ìœ„ì¹˜

**api/scanner.py:**
```python
# ë¼ì¸ 181-183
try:
    content = await file.read()  # ë©”ëª¨ë¦¬ì— ë¡œë“œ
except Exception as e:
    ...
```

**services/image_understanding.py:**
```python
# ë¼ì¸ 537-565
async def analyze(
    self,
    image_content: bytes,  # ë°”ì´íŠ¸ ë°ì´í„°ë¡œ ì§ì ‘ ì „ë‹¬
    content_type: str,
    language: Language = Language.KO,
) -> ScanResult:
    ...
    # ë¶„ì„ ì™„ë£Œ í›„ image_contentëŠ” GC ëŒ€ìƒ
```

### í˜„ì¬ ì½”ë“œ ì˜ˆì‹œ

```python
# api/scanner.py:181-226
try:
    content = await file.read()  # ë©”ëª¨ë¦¬ì—ë§Œ ë¡œë“œ
except Exception as e:
    ...

# ë¶„ì„ ìˆ˜í–‰ (ë©”ëª¨ë¦¬ì˜ content ì‚¬ìš©)
result: ScanResult = await service.analyze(
    image_content=content,
    content_type=content_type,
    language=lang,
)
# í•¨ìˆ˜ ì¢…ë£Œ ì‹œ contentëŠ” GC ëŒ€ìƒ - ì›ë³¸ ì´ë¯¸ì§€ ì˜êµ¬ ì†ì‹¤
```

---

## ğŸ’¡ ê°œì„  ë°©ì•ˆ

### ì œì•ˆí•˜ëŠ” ì ‘ê·¼ë²•

MVPì—ì„œëŠ” ì—…ë¡œë“œ ì´ë¯¸ì§€ì˜ **ì„ íƒì  ì„ì‹œ ì €ì¥**ì„ ì§€ì›í•©ë‹ˆë‹¤. ë¶„ì„ ìš”ì²­ ì‹œ `preserve_original` í”Œë˜ê·¸ë¥¼ ì¶”ê°€í•˜ì—¬, í•„ìš”í•œ ê²½ìš°ì—ë§Œ `.data/images/uploaded/` ë””ë ‰í† ë¦¬ì— ì €ì¥í•©ë‹ˆë‹¤. ì €ì¥ëœ ì´ë¯¸ì§€ëŠ” ì„¸ì…˜ ì¢…ë£Œ ì‹œ ë˜ëŠ” TTL(Time-To-Live) ë§Œë£Œ ì‹œ ì •ë¦¬ë©ë‹ˆë‹¤.

### êµ¬ì²´ì  ì‹¤í–‰ ë‹¨ê³„

#### Step 1: ScanResultì— ì›ë³¸ ì´ë¯¸ì§€ ì°¸ì¡° í•„ë“œ ì¶”ê°€

**backend/src/unknown_world/models/scanner.py ìˆ˜ì •:**

```python
class ScanResult(BaseModel):
    """ìŠ¤ìº” ê²°ê³¼."""

    status: ScanStatus
    caption: str = ""
    objects: list[DetectedObject] = Field(default_factory=list)
    item_candidates: list[ItemCandidate] = Field(default_factory=list)
    message: str | None = None
    analysis_time_ms: int = 0

    # ì‹ ê·œ í•„ë“œ (RU-006-S1)
    original_image_key: str | None = Field(
        default=None,
        description="ì €ì¥ëœ ì›ë³¸ ì´ë¯¸ì§€ì˜ ìŠ¤í† ë¦¬ì§€ í‚¤ (ì„ íƒì  ì €ì¥ ì‹œ)",
    )
    original_image_url: str | None = Field(
        default=None,
        description="ì €ì¥ëœ ì›ë³¸ ì´ë¯¸ì§€ì˜ ì ‘ê·¼ URL (ì„ íƒì  ì €ì¥ ì‹œ)",
    )
```

#### Step 2: ìŠ¤ìºë„ˆ APIì— preserve_original ì˜µì…˜ ì¶”ê°€

**api/scanner.py ìˆ˜ì •:**

```python
@router.post(
    "",
    response_model=ScannerResponse,
    summary="ì´ë¯¸ì§€ ìŠ¤ìº”",
)
async def scan_image(
    file: Annotated[UploadFile, File(description="ë¶„ì„í•  ì´ë¯¸ì§€ íŒŒì¼")],
    language: Annotated[str, Form(description="ì‘ë‹µ ì–¸ì–´")] = "ko-KR",
    preserve_original: Annotated[
        bool,
        Form(description="ì›ë³¸ ì´ë¯¸ì§€ ì €ì¥ ì—¬ë¶€ (ë””ë²„ê¹…/ì¬ë¶„ì„ìš©)"),
    ] = False,
    session_id: Annotated[
        str | None,
        Form(description="ì„¸ì…˜ ID (ì´ë¯¸ì§€ ê·¸ë£¹í™”ìš©)"),
    ] = None,
    service: ImageUnderstandingService = Depends(get_scanner_service),
) -> ScannerResponse:
    ...
```

#### Step 3: ImageUnderstandingServiceì— ì €ì¥ ë¡œì§ ì¶”ê°€

**services/image_understanding.py ìˆ˜ì •:**

```python
async def analyze(
    self,
    image_content: bytes,
    content_type: str,
    language: Language = Language.KO,
    *,
    preserve_original: bool = False,
    session_id: str | None = None,
) -> ScanResult:
    """ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.

    Args:
        image_content: ì´ë¯¸ì§€ ë°”ì´íŠ¸ ë°ì´í„°
        content_type: MIME íƒ€ì…
        language: ì‘ë‹µ ì–¸ì–´
        preserve_original: ì›ë³¸ ì´ë¯¸ì§€ ì €ì¥ ì—¬ë¶€ (ì‹ ê·œ, RU-006-S1)
        session_id: ì„¸ì…˜ ID (ì €ì¥ ì‹œ ê·¸ë£¹í™”ìš©)

    Returns:
        ScanResult: ë¶„ì„ ê²°ê³¼ (ì €ì¥ ì‹œ original_image_key í¬í•¨)
    """
    start_time = time.time()

    # ì›ë³¸ ì´ë¯¸ì§€ ì €ì¥ (ì„ íƒì )
    original_image_key: str | None = None
    original_image_url: str | None = None

    if preserve_original:
        try:
            from unknown_world.storage import StorageCategory, get_storage

            storage = get_storage()
            put_result = await storage.put(
                data=image_content,
                category=StorageCategory.UPLOADED_IMAGE,
                content_type=content_type,
                session_id=session_id,
            )

            if put_result.success:
                original_image_key = put_result.key
                original_image_url = put_result.url
                logger.debug(
                    "[ImageUnderstanding] ì›ë³¸ ì´ë¯¸ì§€ ì €ì¥ ì™„ë£Œ",
                    extra={
                        "key": original_image_key,
                        "size_kb": len(image_content) // 1024,
                    },
                )
        except Exception as e:
            # ì €ì¥ ì‹¤íŒ¨í•´ë„ ë¶„ì„ì€ ê³„ì† (RULE-004)
            logger.warning(
                "[ImageUnderstanding] ì›ë³¸ ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨",
                extra={"error_type": type(e).__name__},
            )

    # ê¸°ì¡´ ë¶„ì„ ë¡œì§ ìˆ˜í–‰...
    result = await self._perform_analysis(image_content, content_type, language)

    # ì €ì¥ ì •ë³´ ì¶”ê°€
    result.original_image_key = original_image_key
    result.original_image_url = original_image_url
    result.analysis_time_ms = int((time.time() - start_time) * 1000)

    return result
```

#### Step 4: ì‘ë‹µ ìŠ¤í‚¤ë§ˆì— ì €ì¥ ì •ë³´ ì¶”ê°€

**api/scanner.pyì˜ ScannerResponse ìˆ˜ì •:**

```python
class ScannerResponse(BaseModel):
    """Scanner API ì‘ë‹µ."""

    success: bool
    status: ScanStatus
    caption: str = ""
    objects: list[DetectedObject] = Field(default_factory=list)
    item_candidates: list[ItemCandidate] = Field(default_factory=list)
    message: str | None = None
    analysis_time_ms: int = 0
    language: Language

    # ì‹ ê·œ í•„ë“œ (RU-006-S1)
    original_image_key: str | None = Field(
        default=None,
        description="ì €ì¥ëœ ì›ë³¸ ì´ë¯¸ì§€ ìŠ¤í† ë¦¬ì§€ í‚¤",
    )
    original_image_url: str | None = Field(
        default=None,
        description="ì €ì¥ëœ ì›ë³¸ ì´ë¯¸ì§€ URL",
    )
```

### ëŒ€ì•ˆì  ì ‘ê·¼ë²• (ì„ íƒì‚¬í•­)

- **ëŒ€ì•ˆ 1**: ëª¨ë“  ì—…ë¡œë“œ ì´ë¯¸ì§€ë¥¼ í•­ìƒ ì €ì¥
  - ì¥ì : ë””ë²„ê¹…/ì¬ë¶„ì„ í•­ìƒ ê°€ëŠ¥
  - ë‹¨ì : ìŠ¤í† ë¦¬ì§€ ìš©ëŸ‰ ê¸‰ì¦, ê°œì¸ì •ë³´ ë³´ê´€ ì´ìŠˆ

- **ëŒ€ì•ˆ 2**: ë¶„ì„ ì‹¤íŒ¨ ì‹œì—ë§Œ ì €ì¥
  - ì¥ì : ë””ë²„ê¹…ì— í•„ìš”í•œ ì¼€ì´ìŠ¤ë§Œ ì €ì¥
  - ë‹¨ì : ì„±ê³µ ì¼€ì´ìŠ¤ ì¬ë¶„ì„ ë¶ˆê°€

---

## ğŸ“ˆ ê¸°ëŒ€ íš¨ê³¼

### ì¦‰ê°ì  íš¨ê³¼

- âœ… í•„ìš” ì‹œ ì—…ë¡œë“œ ì´ë¯¸ì§€ ë³´ì¡´ ê°€ëŠ¥
- âœ… ë¶„ì„ ê²°ê³¼ì™€ ì›ë³¸ ì´ë¯¸ì§€ ì—°ê²° ê´€ê³„ ìœ ì§€
- âœ… ë””ë²„ê¹… ì‹œ ì›ë³¸ ì´ë¯¸ì§€ í™•ì¸ ê°€ëŠ¥

### ì¥ê¸°ì  íš¨ê³¼

- ğŸ¯ ëª¨ë¸ ì—…ê·¸ë ˆì´ë“œ í›„ ê¸°ì¡´ ì´ë¯¸ì§€ ì¬ë¶„ì„ ê°€ëŠ¥
- ğŸ¯ ë¶„ì„ í’ˆì§ˆ ê°œì„ ì„ ìœ„í•œ ë°ì´í„° ì¶•ì 
- ğŸ¯ ì•„ì´í…œ ì¶œì²˜ ì¶”ì  ê¸°ëŠ¥ ê¸°ë°˜ ë§ˆë ¨

### ì •ëŸ‰ì  ê°œì„  (ê°€ëŠ¥í•œ ê²½ìš°)

| ì§€í‘œ | í˜„ì¬ | ê°œì„  í›„ | ë³€í™” |
|:---|:---:|:---:|:---:|
| ì›ë³¸ ì´ë¯¸ì§€ ë³´ì¡´ | ë¶ˆê°€ | ì„ íƒì  ê°€ëŠ¥ | âœ… |
| ì¬ë¶„ì„ ê°€ëŠ¥ ì—¬ë¶€ | ë¶ˆê°€ | ê°€ëŠ¥ | âœ… |
| ë””ë²„ê¹… ë°ì´í„° | ì—†ìŒ | ì œê³µ | âœ… |

---

## âš ï¸ ì£¼ì˜ì‚¬í•­ ë° ê³ ë ¤ì‚¬í•­

### ë¦¬íŒ©í† ë§ ì‹œ ì£¼ì˜í•  ì 

1. ì—…ë¡œë“œ ì´ë¯¸ì§€ëŠ” ì‚¬ìš©ì ë°ì´í„°ì´ë¯€ë¡œ RULE-007(ë¹„ë°€ì •ë³´ ë³´í˜¸) ì¤€ìˆ˜ í•„ìˆ˜
2. ì €ì¥ëœ ì´ë¯¸ì§€ì— ëŒ€í•œ TTL/ì •ë¦¬ ì •ì±… ì •ì˜ í•„ìš” (MMPì—ì„œ êµ¬ì²´í™”)
3. `preserve_original=true` ì‹œ ì‘ë‹µ ì‹œê°„ ì•½ê°„ ì¦ê°€ ê°€ëŠ¥

### ì˜í–¥ë°›ëŠ” ë‹¤ë¥¸ ëª¨ë“ˆ

- **frontend/src/api/scanner.ts**: `preserve_original` ì˜µì…˜ ì „ë‹¬ ë¡œì§ ì¶”ê°€ í•„ìš”
- **ScannerSlot.tsx**: ë””ë²„ê¹… ëª¨ë“œì—ì„œ ì €ì¥ ì˜µì…˜ í™œì„±í™” UI (ì„ íƒì )

### í˜¸í™˜ì„± ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ê¸°ì¡´ API í˜¸ì¶œ í˜¸í™˜ (`preserve_original` ê¸°ë³¸ê°’ false)
- [ ] ì‘ë‹µ ìŠ¤í‚¤ë§ˆ í™•ì¥ í˜¸í™˜ (ì‹ ê·œ í•„ë“œ optional)
- [ ] í”„ë¡ íŠ¸ì—”ë“œ Zod ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸

---

## ğŸ§ª ê²€ì¦ ë°©ë²• (ìˆ˜ë™ ê²€ì¦ ì¤‘ì‹¬)

### ë³€ê²½ ì „ í™•ì¸ ì‚¬í•­

1. Scanner API í˜¸ì¶œ í›„ ì—…ë¡œë“œ ì´ë¯¸ì§€ ì €ì¥ ì—¬ë¶€ í™•ì¸ (í˜„ì¬: ì €ì¥ ì•ˆ ë¨)
2. ì‘ë‹µì— ì›ë³¸ ì´ë¯¸ì§€ ì°¸ì¡° í•„ë“œ ì—†ìŒ í™•ì¸

### ë³€ê²½ í›„ ê²€ì¦ ì‹œë‚˜ë¦¬ì˜¤

#### ì‹œë‚˜ë¦¬ì˜¤ 1: preserve_original=false (ê¸°ë³¸)

- **ì‹¤í–‰ ë°©ë²•**: `POST /api/scan` with ì´ë¯¸ì§€, `preserve_original=false`
- **ê¸°ëŒ€ ê²°ê³¼**:
  - ë¶„ì„ ì„±ê³µ
  - `original_image_key: null`
  - `.data/images/uploaded/` ì— íŒŒì¼ ì—†ìŒ
- **í™•ì¸ ì‚¬í•­**:
  - âœ… ê¸°ì¡´ ë™ì‘ê³¼ ë™ì¼
  - âœ… ì„±ëŠ¥ ì €í•˜ ì—†ìŒ

#### ì‹œë‚˜ë¦¬ì˜¤ 2: preserve_original=true

- **ì‹¤í–‰ ë°©ë²•**: `POST /api/scan` with ì´ë¯¸ì§€, `preserve_original=true`
- **ê¸°ëŒ€ ê²°ê³¼**:
  - ë¶„ì„ ì„±ê³µ
  - `original_image_key: "images/uploaded/file_xxx.png"`
  - `original_image_url: "/static/images/uploaded/file_xxx.png"`
  - í•´ë‹¹ URLë¡œ ì´ë¯¸ì§€ ì ‘ê·¼ ê°€ëŠ¥
- **í™•ì¸ ì‚¬í•­**:
  - âœ… íŒŒì¼ì´ ì˜¬ë°”ë¥¸ ê²½ë¡œì— ì €ì¥ë¨
  - âœ… URLë¡œ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥

#### ì‹œë‚˜ë¦¬ì˜¤ 3: ì €ì¥ ì‹¤íŒ¨ ì‹œ í´ë°±

- **í…ŒìŠ¤íŠ¸ ë°©ë²•**: ì €ì¥ì†Œ ì“°ê¸° ê¶Œí•œ ì œê±° í›„ `preserve_original=true` í˜¸ì¶œ
- **ê¸°ëŒ€ ë™ì‘**: ë¶„ì„ì€ ì„±ê³µ, `original_image_key: null`, ê²½ê³  ë¡œê·¸ ì¶œë ¥
- **í™•ì¸ ì‚¬í•­**: RULE-004 í´ë°± ì •ìƒ ë™ì‘

### íšŒê·€ í™•ì¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ê¸°ì¡´ Scanner API í˜¸ì¶œ ì •ìƒ ë™ì‘
- [ ] ì‘ë‹µ í˜•ì‹ í•˜ìœ„ í˜¸í™˜
- [ ] ì—ëŸ¬ ì²˜ë¦¬ ì •ìƒ

---

## ğŸ”§ ì‹¤í–‰ ê°€ì´ë“œ

### ê°œë°œìë¥¼ ìœ„í•œ ì‹¤í–‰ ì§€ì¹¨

1. **ì¤€ë¹„ ì‚¬í•­**
   - RU-006-Q4 (ìŠ¤í† ë¦¬ì§€ ì¸í„°í˜ì´ìŠ¤) ì™„ë£Œ ê¶Œì¥
   - `.data/images/uploaded/` ë””ë ‰í† ë¦¬ ìƒì„± í™•ì¸

2. **ì‹¤í–‰ ì ˆì°¨**
   - `models/scanner.py`ì— ì‹ ê·œ í•„ë“œ ì¶”ê°€
   - `api/scanner.py`ì— `preserve_original` íŒŒë¼ë¯¸í„° ì¶”ê°€
   - `services/image_understanding.py`ì— ì €ì¥ ë¡œì§ ì¶”ê°€
   - ì‘ë‹µ ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸

3. **ê²€ì¦ ì ˆì°¨**
   - `preserve_original=false`ë¡œ ê¸°ì¡´ ë™ì‘ í™•ì¸
   - `preserve_original=true`ë¡œ ì €ì¥ ë™ì‘ í™•ì¸
   - ì €ì¥ëœ ì´ë¯¸ì§€ URL ì ‘ê·¼ í…ŒìŠ¤íŠ¸

### ì˜ˆìƒ ì†Œìš” ì‹œê°„

- ì½”ë“œ ìˆ˜ì •: 15ë¶„
- ê²€ì¦: 5ë¶„
- ì´ ì˜ˆìƒ ì‹œê°„: 20ë¶„

---

## ğŸ“š ì°¸ê³  ìë£Œ

- ê´€ë ¨ ì„¤ê³„ íŒ¨í„´: Optional Feature Pattern
- ê´€ë ¨ ë¬¸ì„œ: `vibe/unit-plans/RU-006[Mvp].md`
- ì°¸ì¡°: RULE-007 (ë¹„ë°€ì •ë³´ ë³´í˜¸)

---

## ğŸ·ï¸ íƒœê·¸

`#refactoring` `#stability` `#medium` `#scanner` `#storage`

---

## ğŸ“ ë…¸íŠ¸

- MMPì—ì„œ ì €ì¥ëœ ì´ë¯¸ì§€ì— ëŒ€í•œ TTL ì •ì±… êµ¬ì²´í™” í•„ìš”
- ì €ì¥ëœ ì´ë¯¸ì§€ì˜ ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼ ê¸°ëŠ¥ ê³ ë ¤
- ê°œì¸ì •ë³´ ë³´í˜¸ë¥¼ ìœ„í•´ ì—…ë¡œë“œ ì´ë¯¸ì§€ ë³´ê´€ ê¸°ê°„ ì •ì±… ìˆ˜ë¦½ í•„ìš”
- í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ë””ë²„ê¹… ëª¨ë“œ í† ê¸€ UI ì¶”ê°€ ê²€í† 
