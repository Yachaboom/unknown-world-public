# [ID: RU-005-Q4] ëª¨ë“ˆ ì„¤ê³„: orchestrator pipelineì„ stage ëª¨ë“ˆ + ì‹¤í–‰ê¸°(Option A)ë¡œ SSOTí™”

## ğŸ“Œ ê¸°ë³¸ ì •ë³´

| í•­ëª©               | ë‚´ìš©                                                                                                      |
| ------------------ | --------------------------------------------------------------------------------------------------------- |
| **ID**             | RU-005-Q4                                                                                                 |
| **ì‹¬ê°ë„**         | High                                                                                                      |
| **ì¹´í…Œê³ ë¦¬**       | ëª¨ë“ˆ ì„¤ê³„ (Module Design)                                                                                 |
| **ì˜í–¥ ë²”ìœ„**      | `backend/src/unknown_world/api/turn.py`, (ì‹ ê·œ) `backend/src/unknown_world/orchestrator/stages/*`, (ì‹ ê·œ) `backend/src/unknown_world/orchestrator/pipeline.py`, (ì—°ë™) `backend/src/unknown_world/orchestrator/repair_loop.py` |
| **ì˜ˆìƒ ì‘ì—… ì‹œê°„** | 60~120ë¶„                                                                                                  |

---

## ğŸ” ë¬¸ì œì  ìƒì„¸ ë¶„ì„

### í˜„ì¬ ìƒí™©

í˜„ì¬ `/api/turn` ì²˜ë¦¬ íë¦„ì€ `backend/src/unknown_world/api/turn.py`ì— í¬ê²Œ ì§‘ì¤‘ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

- stage ì´ë²¤íŠ¸ ì†¡ì¶œ(ê´€ì¸¡): `StageEvent` / `BadgesEvent` / `RepairEvent` / `FinalEvent`
- mock/real ë¶„ê¸°: `UW_MODE` ê¸°ë°˜ìœ¼ë¡œ `_stream_turn_events_mock` vs `_stream_turn_events_real`
- repair/fallback ì œì–´: mockëŠ” `turn.py` ë‚´ë¶€ì— ë³„ë„ ë£¨í”„ë¥¼ ê°€ì§€ê³ , realì€ `orchestrator/repair_loop.py`ë¥¼ í˜¸ì¶œ
- Plan/Resolve/Render/Verify/Commit ë‹¨ê³„ëŠ” (ì‹¤ì œ ì‘ì—…ì´ ì•„ë‹ˆë¼) â€œsleep ê¸°ë°˜ ì‹œë®¬ë ˆì´ì…˜â€ìœ¼ë¡œ ë‚¨ì•„ ìˆìŒ

PRD/RULE-008ì€ â€œë‹¨ê³„ ê¸°ë°˜ ì‹œìŠ¤í…œâ€ì´ UIë¡œ ë³´ì´ê¸¸ ìš”êµ¬í•˜ì§€ë§Œ, í˜„ êµ¬ì¡°ì—ì„œëŠ” â€œì½”ë“œ êµ¬ì¡°â€ê°€ ë‹¨ê³„ë¥¼ í‘œí˜„í•˜ì§€ ëª»í•´ ì´í›„ í™•ì¥ ì‹œ ë“œë¦¬í”„íŠ¸ê°€ ë°œìƒí•˜ê¸° ì‰½ìŠµë‹ˆë‹¤.

### ë¬¸ì œê°€ ë˜ëŠ” ì´ìœ 

1. **ì±…ì„ ê²½ê³„ ë¶•ê´´**: API ê³„ì¸µ(`api/turn.py`)ì´ transport + ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ì‹¤í–‰ + ì •ì±…(ë³µêµ¬/í´ë°±)ê¹Œì§€ ë“¤ê³  ìˆì–´ ë³€ê²½ ë°˜ê²½ì´ ì»¤ì§‘ë‹ˆë‹¤.
2. **ëª¨ë“œ ê°„ ë“œë¦¬í”„íŠ¸ ìœ„í—˜**: mockì™€ realì´ ì„œë¡œ ë‹¤ë¥¸ ê²½ë¡œì—ì„œ repair/ë°°ì§€/ë‹¨ê³„ë¥¼ ì²˜ë¦¬í•˜ì—¬, â€œë™ì‘ì€ ê°™ì•„ì•¼ í•œë‹¤â€ëŠ” Behavior Preservation ìš”êµ¬ë¥¼ ê¹¨ëœ¨ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
3. **ë‹¨ê³„ í™•ì¥ ë‚œì´ë„ ì¦ê°€**: ì´í›„ U-024(Autopilot), ì´ë¯¸ì§€/ìŠ¤ìºë„ˆ ë“±ì´ ë“¤ì–´ì˜¤ë©´, ë‹¨ê³„ê°€ ëŠ˜ì–´ë‚˜ê±°ë‚˜ ë‹¨ê³„ ë‚´ë¶€ ë¡œì§ì´ ìƒê¸°ëŠ”ë° í˜„ì¬ëŠ” â€œì‹œë®¬ë ˆì´ì…˜â€ê³¼ â€œì‹¤ì œ ë¡œì§â€ì´ ì„ì—¬ ìì—°ìŠ¤ëŸ½ê²Œ í™•ì¥í•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤.

### ì˜í–¥ë°›ëŠ” ì½”ë“œ ìœ„ì¹˜

- `backend/src/unknown_world/api/turn.py`
  - ë‹¨ê³„ ëª©ë¡/ì‹œë®¬ë ˆì´ì…˜: `ORCHESTRATOR_PHASES`, `PHASE_DELAYS_MS`
  - mock/real íŒŒì´í”„ë¼ì¸: `_stream_turn_events_mock`, `_stream_turn_events_real`
- `backend/src/unknown_world/orchestrator/repair_loop.py`
  - â€œê²€ì¦/ë³µêµ¬/í´ë°±â€ì˜ í•µì‹¬(í˜„ì¬ëŠ” real ê²½ë¡œ ì¤‘ì‹¬)

---

## ğŸ’¡ ê°œì„  ë°©ì•ˆ

### ì œì•ˆí•˜ëŠ” ì ‘ê·¼ë²•

RU-005ì˜ í˜ì–´ë§ ê²°ì •(Q1: Option A)ì— ë§ì¶°, **í´ë˜ìŠ¤ ë„ì… ì—†ì´** ë‹¤ìŒ êµ¬ì¡°ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.

- `orchestrator/stages/`ì— stage í•¨ìˆ˜ë¥¼ ë¶„ë¦¬(ë‹¨ê³„ë³„ ì…ë ¥/ì¶œë ¥/ì±…ì„ ëª…í™•í™”)
- `orchestrator/pipeline.py`ì—ì„œ stageë“¤ì„ **í•¨ìˆ˜ ì²´ì¸**ìœ¼ë¡œ ì¡°í•©í•´ ì‹¤í–‰(= SSOT)
- API(`api/turn.py`)ëŠ” â€œìŠ¤íŠ¸ë¦¬ë° ì§ë ¬í™”/ì „ì†¡â€ì— ì§‘ì¤‘í•˜ê³ , stage ì‹¤í–‰ì€ pipelineì— ìœ„ì„

í•µì‹¬ ì„¤ê³„ ëª©í‘œ:

- **ë™ì‘ ë³´ì¡´**: í˜„ì¬ mock/realì´ ë°˜í™˜í•˜ëŠ” TurnOutput/ìŠ¤íŠ¸ë¦¼ ì´ë²¤íŠ¸ì˜ ì˜ë¯¸ë¥¼ ìœ ì§€
- **ê´€ì¸¡ ê°€ëŠ¥ì„± SSOT**: stage start/complete/fail, badges, repair íŠ¸ë ˆì´ìŠ¤ë¥¼ pipeline ìˆ˜ì¤€ì—ì„œ ì¼ê´€ë˜ê²Œ ìƒì„±
- **ë ˆì´ì–´ë§ ë³´í˜¸**: ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ê°€ FastAPIì— ì§ì ‘ ì˜ì¡´í•˜ì§€ ì•Šë„ë¡(ê°€ëŠ¥í•œ ë²”ìœ„ì—ì„œ) â€œemit ì½œë°±â€ì„ ì‚¬ìš©

### êµ¬ì²´ì  ì‹¤í–‰ ë‹¨ê³„

#### Step 1: stage ì»¨í…ìŠ¤íŠ¸/ì¸í„°í˜ì´ìŠ¤ ì •ì˜(`stages/types.py`)

ê¶Œì¥ ì»¨ì…‰(ì˜ˆì‹œ):

```python
# stages/types.py (ê°œë… ì˜ˆì‹œ)
from dataclasses import dataclass, field
from collections.abc import Awaitable, Callable
from unknown_world.models.turn import AgentPhase, CurrencyAmount, TurnInput, TurnOutput, ValidationBadge

EmitFn = Callable[[dict], Awaitable[None]]  # API ë ˆì´ì–´ì—ì„œ StageEvent/BadgesEventë¡œ ë³€í™˜í•˜ì—¬ ìŠ¤íŠ¸ë¦¼

@dataclass
class PipelineContext:
    turn_input: TurnInput
    economy_snapshot: CurrencyAmount
    output: TurnOutput | None = None
    badges: list[ValidationBadge] = field(default_factory=list)
    repair_messages: list[str] = field(default_factory=list)
    current_phase: AgentPhase = AgentPhase.PARSE
```

í¬ì¸íŠ¸:

- stage í•¨ìˆ˜ëŠ” `ctx`ë§Œ ë°›ì•„/ë°˜í™˜(Option A)
- ìŠ¤íŠ¸ë¦¬ë° ì´ë²¤íŠ¸ëŠ” `emit` ì½œë°±ìœ¼ë¡œ â€œê´€ì¸¡ë§Œâ€ ì™¸ë¶€ë¡œ ë‚´ë³´ëƒ„(ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° â†’ API ì˜ì¡´ ìµœì†Œí™”)

#### Step 2: stage ëª¨ë“ˆ ìƒì„±(`stages/parse.py`, `validate.py`, ...)

ê¶Œì¥ stage ì±…ì„(í˜„ MVP ìˆ˜ì¤€ì—ì„œ â€œì‹¤ì œ ë¡œì§ì´ ì—†ëŠ” stageâ€ëŠ” pass-throughë¡œ ìœ ì§€):

- `parse`: ì…ë ¥ì€ ì´ë¯¸ TurnInputìœ¼ë¡œ íŒŒì‹±ë˜ì—ˆë”ë¼ë„, stage ì´ë²¤íŠ¸ SSOTë¥¼ ìœ„í•´ â€œphase ì „ì´â€ë§Œ ë‹´ë‹¹(ë˜ëŠ” API íŒŒì‹±ì„ stageë¡œ í¬í•¨ì‹œì¼œë„ ë¨)
- `validate`: U-018ì˜ `run_repair_loop()`ë¥¼ í˜¸ì¶œí•´ output/badges/repair_countë¥¼ ê²°ì •(ê°€ì¥ í•µì‹¬)
- `plan/resolve/render/verify/commit`: í˜„ì¬ëŠ” ì‹¤ì§ˆ ì²˜ë¦¬ ì—†ìŒ â†’ â€œë‹¨ê³„ ì´ë²¤íŠ¸ ì¼ê´€ì„±â€ì„ ìœ„í•´ ìµœì†Œ ë‹¨ê³„í™”(ì¶”í›„ ë¡œì§ì„ ìì—°ìŠ¤ëŸ½ê²Œ ë¼ìš¸ ìë¦¬ í™•ë³´)

#### Step 3: pipeline ì‹¤í–‰ê¸° ë„ì…(`orchestrator/pipeline.py`)

pipelineì€ â€œstage ë°°ì—´ + ì‹¤í–‰ ë£¨í”„â€ë§Œì„ ë“¤ê³ , stage wrapperì—ì„œ ê³µí†µ ì •ì±…(ë‹¨ê³„ ì´ë²¤íŠ¸/ì˜ˆì™¸/í´ë°±)ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.

```python
# pipeline.py (ê°œë… ì˜ˆì‹œ)
from unknown_world.models.turn import AgentPhase
from unknown_world.orchestrator.stages.types import PipelineContext, EmitFn

async def run_pipeline(ctx: PipelineContext, *, emit: EmitFn) -> PipelineContext:
    for stage in [parse_stage, validate_stage, plan_stage, resolve_stage, render_stage, verify_stage, commit_stage]:
        ctx = await stage(ctx, emit=emit)
    return ctx
```

#### Step 4: `/api/turn`ì€ â€œpipeline + ì§ë ¬í™”â€ë¡œ ë‹¨ìˆœí™”

- ê¸°ì¡´: `_stream_turn_events_mock/_real`ì— ì„ì—¬ ìˆë˜ stage/repair/badges/final ë¡œì§ì„ pipeline ê¸°ë°˜ìœ¼ë¡œ í¡ìˆ˜
- APIëŠ” `emit`ì´ ë°›ì€ â€œë„ë©”ì¸ ì´ë²¤íŠ¸(ë‹¨ìˆœ dict)â€ë¥¼ `turn_stream_events.py`ì˜ `StageEvent/BadgesEvent/...`ë¡œ ë³€í™˜í•´ NDJSONë¡œ ì†¡ì¶œ

### ëŒ€ì•ˆì  ì ‘ê·¼ë²• (ì„ íƒì‚¬í•­)

- **ëŒ€ì•ˆ 1(í´ë˜ìŠ¤ ê¸°ë°˜ Pipeline)**: stage í™•ì¥ì—ëŠ” ìœ ë¦¬í•˜ì§€ë§Œ RU-005ì˜ â€œ60ë¶„â€ ëª©í‘œì™€ Q1 ê²°ì •(Option A)ì— ë°˜í•¨
- **ëŒ€ì•ˆ 2(ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ê°€ StreamEvent ëª¨ë¸ì„ ì§ì ‘ ìƒì„±)**: êµ¬í˜„ì€ ë¹ ë¥¼ ìˆ˜ ìˆìœ¼ë‚˜ `orchestrator â†’ api` ì˜ì¡´ì´ ìƒê²¨ ë ˆì´ì–´ë§ì´ ì•…í™”ë  ìˆ˜ ìˆìŒ

---

## ğŸ“ˆ ê¸°ëŒ€ íš¨ê³¼

### ì¦‰ê°ì  íš¨ê³¼

- âœ… stageê°€ ì½”ë“œ êµ¬ì¡°ë¡œ ê³ ì •ë˜ì–´, PRDì˜ â€œParseâ†’Validateâ†’Planâ†’Resolveâ†’Renderâ†’Verifyâ†’Commitâ€ ìš”êµ¬ë¥¼ êµ¬í˜„ êµ¬ì¡°ë¡œ ë°˜ì˜
- âœ… mock/real ê²½ë¡œì—ì„œ ë™ì¼í•œ pipeline ê³¨ê²©ì„ ê³µìœ  â†’ ë“œë¦¬í”„íŠ¸ ìœ„í—˜ ê°ì†Œ
- âœ… `api/turn.py`ì˜ ë³€ê²½ ë°˜ê²½ ê°ì†Œ(transport/ì§ë ¬í™”ì— ì§‘ì¤‘)

### ì¥ê¸°ì  íš¨ê³¼

- ğŸ¯ Autopilot(U-024), ì´ë¯¸ì§€ íŒŒì´í”„ë¼ì¸(U-019~) ë“± í›„ì† ê¸°ëŠ¥ì´ stageì— â€œë¼ì›Œë„£ê¸°â€ í˜•íƒœë¡œ í™•ì¥ ê°€ëŠ¥
- ğŸ¯ ê´€ì¸¡ ê°€ëŠ¥ì„±(ë°°ì§€/ë³µêµ¬/ë‹¨ê³„)ì„ pipelineì—ì„œ SSOTë¡œ ê´€ë¦¬í•˜ì—¬ UI ì¦ê±° í’ˆì§ˆì´ ì•ˆì •í™”

---

## âš ï¸ ì£¼ì˜ì‚¬í•­ ë° ê³ ë ¤ì‚¬í•­

### ë¦¬íŒ©í† ë§ ì‹œ ì£¼ì˜í•  ì 

1. RU-005ëŠ” ê¸°ëŠ¥ ì¶”ê°€ê°€ ì•„ë‹ˆë¼ â€œêµ¬ì¡° ì •ë¦¬â€ì…ë‹ˆë‹¤. mock/realì˜ ê²°ê³¼(JSON) ì˜ë¯¸ë¥¼ ë°”ê¾¸ì§€ ì•ŠìŠµë‹ˆë‹¤.
2. ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ëŠ” FastAPIë¥¼ ì§ì ‘ import í•˜ì§€ ì•Šë„ë¡(ê°€ëŠ¥í•œ ë²”ìœ„ì—ì„œ) `emit` ì½œë°± ê²½ê³„ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
3. í”„ë¡¬í”„íŠ¸ ì›ë¬¸/ë‚´ë¶€ ì¶”ë¡ /ë¹„ë°€ì •ë³´ëŠ” ì–´ë–¤ stageì—ì„œë„ ìŠ¤íŠ¸ë¦¼/ë¡œê·¸ë¡œ ë‚´ë³´ë‚´ì§€ ì•ŠìŠµë‹ˆë‹¤(RULE-007/008).

### í˜¸í™˜ì„± ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] stage ì´ë²¤íŠ¸ ìˆœì„œ/ì´ë¦„ì´ ê¸°ì¡´ê³¼ ë™ì¼í•œê°€? (`parseâ†’...â†’commit`)
- [ ] ëª¨ë“  ê²½ë¡œì—ì„œ ìŠ¤íŠ¸ë¦¼ì´ ì •í™•íˆ 1ê°œì˜ `final` ì´ë²¤íŠ¸ë¡œ ì¢…ë£Œë˜ëŠ”ê°€? (RULE-004)
- [ ] í´ë°± ì‹œì—ë„ ì¬í™” ì”ì•¡ì´ ë³´ì¡´ë˜ëŠ”ê°€? (RULE-005)

---

## ğŸ§ª ê²€ì¦ ë°©ë²• (ìˆ˜ë™ ê²€ì¦ ì¤‘ì‹¬)

> ìƒì„¸ ì‹œë‚˜ë¦¬ì˜¤ëŠ” `RU-005-S3.md`ë¥¼ ì°¸ì¡°í•©ë‹ˆë‹¤.

í•µì‹¬ë§Œ ë¹ ë¥´ê²Œ í™•ì¸:

1. mock ëª¨ë“œì—ì„œ ì •ìƒ ìš”ì²­: stageâ†’badgesâ†’narrative_deltaâ†’final ìˆœì„œ ìœ ì§€
2. mock ëª¨ë“œì—ì„œ ì¬í™” ë¶€ì¡± ìœ ë„(ì˜ˆ: signal=0): repair ì´ë²¤íŠ¸ + final(í´ë°±) ì •ìƒ ì¢…ë£Œ
3. invalid input: error + final(í´ë°±)ë¡œ ì¢…ë£Œ

---

## ğŸ”§ ì‹¤í–‰ ê°€ì´ë“œ

### ê°œë°œìë¥¼ ìœ„í•œ ì‹¤í–‰ ì§€ì¹¨

1. **ì¤€ë¹„ ì‚¬í•­**
   - í˜„ì¬ `api/turn.py`ì—ì„œ â€œstage/repair/badges/finalâ€ ìƒì„± ì§€ì ì„ ëª©ë¡í™”
2. **ì‹¤í–‰ ì ˆì°¨**
   - `orchestrator/stages/` + `orchestrator/pipeline.py`ë¥¼ ë¨¼ì € ë§Œë“¤ê³ , ê¸°ì¡´ ì½”ë“œë¥¼ â€œì˜®ê¸°ê¸°â€ë³´ë‹¤ â€œê°ì‹¸ê¸°(wrapper)â€ë¶€í„° ì‹œì‘
   - ë§ˆì§€ë§‰ì— `api/turn.py`ë¥¼ pipeline í˜¸ì¶œ í˜•íƒœë¡œ ë°”ê¾¸ë©° ì¤‘ë³µ í•¨ìˆ˜(mock/real) ì¶•ì†Œ
3. **ê²€ì¦ ì ˆì°¨**
   - `RU-005-S3.md` ìˆ˜ë™ ì‹œë‚˜ë¦¬ì˜¤ ìˆ˜í–‰
4. **ë¡¤ë°± ê³„íš**
   - pipeline ê²½ë¡œëŠ” ìƒˆë¡œìš´ íŒŒì¼ì— ì§‘ì¤‘ë˜ë¯€ë¡œ, ë¬¸ì œê°€ ìƒê¸°ë©´ `api/turn.py`ì˜ ê¸°ì¡´ êµ¬í˜„ìœ¼ë¡œ ë˜ëŒë¦¬ê¸° ì‰¬ì›€

---

## ğŸ“š ì°¸ê³  ìë£Œ

- `vibe/unit-plans/RU-005[Mvp].md`
- `vibe/unit-results/U-018[Mvp].md`
- `backend/src/unknown_world/api/turn.py`
- `backend/src/unknown_world/orchestrator/repair_loop.py`
- `.cursor/rules/20-backend-orchestrator.mdc`

---

## ğŸ·ï¸ íƒœê·¸

`#refactoring` `#module-design` `#high` `#orchestrator` `#pipeline` `#stages` `#ssot`

---

## ğŸ“ ë…¸íŠ¸

- RU-005ëŠ” â€œë‹¨ê³„ ê°€ì‹œí™”â€ë¥¼ UIì—ë§Œ ë‚¨ê¸°ì§€ ì•Šê³ , **ì½”ë“œ êµ¬ì¡°(í´ë”/ëª¨ë“ˆ)ë¡œë„ ë‹¨ê³„ê°€ ë³´ì´ê²Œ** ë§Œë“œëŠ” ì‘ì—…ì…ë‹ˆë‹¤.

