# [ID: RU-005-S1] ì ì¬ì  ì˜¤ë¥˜: badges/ë‹¨ê³„ ì´ë²¤íŠ¸ ì¸ë°”ë¦¬ì–¸íŠ¸ ì •í•©ì„±(Consistency ì‹¤íŒ¨ í¬í•¨)

## ğŸ“Œ ê¸°ë³¸ ì •ë³´

| í•­ëª©               | ë‚´ìš©                                                                                          |
| ------------------ | --------------------------------------------------------------------------------------------- |
| **ID**             | RU-005-S1                                                                                     |
| **ì‹¬ê°ë„**         | High                                                                                          |
| **ì¹´í…Œê³ ë¦¬**       | ì ì¬ì  ì˜¤ë¥˜ (Potential Bugs)                                                                  |
| **ì˜í–¥ ë²”ìœ„**      | `backend/src/unknown_world/orchestrator/repair_loop.py`, `backend/src/unknown_world/api/turn.py`, `backend/src/unknown_world/api/turn_stream_events.py`, `backend/src/unknown_world/validation/business_rules.py`, `backend/src/unknown_world/models/turn.py` |
| **ì˜ˆìƒ ì‘ì—… ì‹œê°„** | 45~90ë¶„                                                                                       |

---

## ğŸ” ë¬¸ì œì  ìƒì„¸ ë¶„ì„

### í˜„ì¬ ìƒí™©

U-018ë¡œ â€œë¹„ì¦ˆë‹ˆìŠ¤ ë£° ê²€ì¦ + repair/fallbackâ€ì´ ë“¤ì–´ì˜¤ë©´ì„œ ë°°ì§€(ValidationBadge)ëŠ” ë‹¤ìŒ ì˜ë¯¸ë¥¼ ê°–ìŠµë‹ˆë‹¤.

- `schema_ok/fail`
- `economy_ok/fail`
- `safety_ok/safety_blocked`
- `consistency_ok/fail` (ì–¸ì–´/ì¢Œí‘œ ë“±)

í•˜ì§€ë§Œ í˜„ì¬ êµ¬í˜„ì—ì„œëŠ” ì•„ë˜ì™€ ê°™ì€ â€œí‘œê¸°/ì†¡ì¶œ ë¶ˆì¼ì¹˜â€ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.

### ë¬¸ì œê°€ ë˜ëŠ” ì´ìœ 

1. **Consistency ì‹¤íŒ¨ê°€ `consistency_fail`ë¡œ í‘œê¸°ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ**
   - `validation/business_rules.py`ëŠ” `language_mismatch`, `box2d_*` ê°™ì€ ì˜¤ë¥˜ íƒ€ì…ì„ ë§Œë“¤ì§€ë§Œ,
   - `repair_loop.py`ì˜ ë°°ì§€ ë§¤í•‘ì€ economy/safetyë§Œ ê°ì§€í•˜ì—¬ consistency ê³„ì—´ ì‹¤íŒ¨ë¥¼ ëˆ„ë½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
2. **mock ê²½ë¡œì—ì„œ `BadgesEvent`ê°€ í´ë°± ì‹œ ëˆ„ë½ë  ìˆ˜ ìˆìŒ**
   - mockì˜ while ë£¨í”„ëŠ” ì„±ê³µ ì‹œì—ë§Œ `collected_badges`ë¥¼ ì±„ìš°ê³  ì „ì†¡í•©ë‹ˆë‹¤.
   - ìµœì¢… í´ë°±ì´ ë°œìƒí•˜ë©´ `TurnOutput.agent_console.badges`ì—ëŠ” ì‹¤íŒ¨ ë°°ì§€ê°€ ë“¤ì–´ê°€ë„, ìŠ¤íŠ¸ë¦¼ `badges` ì´ë²¤íŠ¸ëŠ” ë¹„ì–´ UI ì¦ê±°ê°€ ì•½í•´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
3. **ë‹¨ê³„ ì‹¤íŒ¨(status=fail) ì˜ë¯¸ê°€ ì‚¬ìš©ë˜ì§€ ì•ŠìŒ**
   - `turn_stream_events.py`ì—ëŠ” `StageStatus.FAIL`ì´ ì •ì˜ë¼ ìˆì§€ë§Œ, ì‹¤ì œ ì†¡ì¶œì—ì„œ ê±°ì˜ ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
   - ì˜ˆì™¸/í´ë°±ì´ ë‚˜ë”ë¼ë„ stageëŠ” â€œcompleteâ€ë¡œë§Œ ë³´ì´ê±°ë‚˜(ë˜ëŠ” ì•„ì˜ˆ í‘œì‹œê°€ ì• ë§¤í•´) Agent Console ì‹ ë¢°ë„ê°€ ë–¨ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ì˜í–¥ë°›ëŠ” ì½”ë“œ ìœ„ì¹˜

- `backend/src/unknown_world/orchestrator/repair_loop.py`
  - `_add_business_badges()`ì—ì„œ economy/safety ìœ„ì£¼ë¡œë§Œ ë°°ì§€ ê²°ì •ì„ ìˆ˜í–‰
- `backend/src/unknown_world/api/turn.py`
  - mock ê²½ë¡œì˜ badges ì†¡ì¶œ ì¡°ê±´(ì„±ê³µ ì‹œì—ë§Œ)
  - stage fail ë¯¸ì‚¬ìš©(ì˜ˆì™¸ ì‹œ error+finalë§Œ ì†¡ì¶œ)
- `backend/src/unknown_world/api/turn_stream_events.py`
  - `StageStatus.FAIL` ì •ì˜(í™œìš©ë„ ë‚®ìŒ)

---

## ğŸ’¡ ê°œì„  ë°©ì•ˆ

### ì œì•ˆí•˜ëŠ” ì ‘ê·¼ë²•

ë°°ì§€/ë‹¨ê³„ ì´ë²¤íŠ¸ëŠ” â€œUX ì¥ì‹â€ì´ ì•„ë‹ˆë¼ RULE-008ì˜ **ì¦ê±°(Proof of System)** ì…ë‹ˆë‹¤.  
ë”°ë¼ì„œ ì•„ë˜ 2ê°€ì§€ë¥¼ ì¸ë°”ë¦¬ì–¸íŠ¸ë¡œ ê³ ì •í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.

1) **BadgesEventëŠ” (ê°€ëŠ¥í•˜ë©´) í„´ë‹¹ 1íšŒ ì´ìƒ, ëª¨ë“œ/ì„±ê³µ/í´ë°±ê³¼ ë¬´ê´€í•˜ê²Œ ì¼ê´€ë˜ê²Œ ì†¡ì¶œ**  
2) **final TurnOutputì˜ `agent_console.badges`ì™€ ìŠ¤íŠ¸ë¦¼ `badges` ì´ë²¤íŠ¸ì˜ ì˜ë¯¸ê°€ ë™ì¼**í•´ì•¼ í•¨

### êµ¬ì²´ì  ì‹¤í–‰ ë‹¨ê³„

#### Step 1: BusinessRuleError â†’ ValidationBadge ë§¤í•‘ì„ ì™„ì „í•˜ê²Œ ë§Œë“¤ê¸°

ê¶Œì¥ ë¡œì§(ê°œë…):

- `economy_*` ì—ëŸ¬ê°€ ìˆìœ¼ë©´ `economy_fail`, ì—†ìœ¼ë©´ `economy_ok`
- `safety_*` ì—ëŸ¬ê°€ ìˆìœ¼ë©´ `safety_blocked`, ì—†ìœ¼ë©´ `safety_ok`
- `language_*` ë˜ëŠ” `box2d_*` ì—ëŸ¬ê°€ ìˆìœ¼ë©´ `consistency_fail`, ì—†ìœ¼ë©´ `consistency_ok`

í˜„ì¬ `repair_loop.py`ì˜ `_add_business_badges()`ë¥¼ ìœ„ í˜•íƒœë¡œ í™•ì¥í•©ë‹ˆë‹¤.

#### Step 2: mock ê²½ë¡œì—ì„œë„ â€œë°°ì§€ ì†¡ì¶œ 1íšŒâ€ë¥¼ ë³´ì¥

mock ê²½ë¡œì—ì„œ ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¡œ ì •ë¦¬í•©ë‹ˆë‹¤.

- **ê¶Œì¥**: ìµœì¢… `turn_output`ì´ í™•ì •ë˜ëŠ” ì§€ì ì—ì„œ, `turn_output.agent_console.badges`ë¥¼ ê¸°ì¤€ìœ¼ë¡œ `BadgesEvent`ë¥¼ 1íšŒ ì†¡ì¶œ
- **ëŒ€ì•ˆ**: ì„±ê³µ/ì‹¤íŒ¨ ê°ê°ì˜ ë¶„ê¸°ì—ì„œ ë°°ì§€ë¥¼ ê³„ì‚°í•´ ì†¡ì¶œí•˜ë˜, â€œí´ë°±ì—ì„œëŠ” ëˆ„ë½â€ë˜ëŠ” ì¼€ì´ìŠ¤ê°€ ì—†ë„ë¡ ê°•ì œ

#### Step 3: stage ì‹¤íŒ¨(status=fail) í‘œê¸° ì •ì±…ì„ ì •í•˜ê¸°

â€œì–´ë–¤ ê²½ìš°ì— stage failì„ ë³´ì¼ì§€â€ëŠ” íŒ€ UX ì„ íƒì´ì§€ë§Œ, ìµœì†Œ ì •ì±…ì„ ê¶Œì¥í•©ë‹ˆë‹¤.

- íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì¤‘ ì˜ˆì™¸ë¡œ í´ë°±ì— ì§„ì…í•œ ê²½ìš°:
  - ë§ˆì§€ë§‰ìœ¼ë¡œ ì§„í–‰ ì¤‘ì´ë˜ stageì— ëŒ€í•´ `status=fail` ì†¡ì¶œ
  - ì´í›„ `commit`ì€ â€œcompleteâ€(í˜¹ì€ fail)ë¡œ ì •ë¦¬ í›„ `final` ì†¡ì¶œ

ì´ ì •ì±…ì€ RU-005-Q4ì˜ pipeline wrapperì—ì„œ êµ¬í˜„í•˜ë©´ ê°€ì¥ ìì—°ìŠ¤ëŸ½ìŠµë‹ˆë‹¤.

---

## ğŸ“ˆ ê¸°ëŒ€ íš¨ê³¼

### ì¦‰ê°ì  íš¨ê³¼

- âœ… `consistency_fail` ëˆ„ë½ ë°©ì§€(ì–¸ì–´/ì¢Œí‘œ ê·œì•½ ìœ„ë°˜ì„ UIì—ì„œ ì¦‰ì‹œ í™•ì¸ ê°€ëŠ¥)
- âœ… mock/real/í´ë°± ëª¨ë“  ê²½ë¡œì—ì„œ ë°°ì§€/ì¦ê±°ê°€ ì•ˆì •ì ìœ¼ë¡œ í‘œì‹œë¨
- âœ… â€œì™œ í´ë°±ì´ ë‚¬ëŠ”ì§€â€ê°€ stage/badgesë¡œ ì„¤ëª… ê°€ëŠ¥í•´ì ¸ ë°ëª¨ ì„¤ë“ë ¥ ìƒìŠ¹

### ì¥ê¸°ì  íš¨ê³¼

- ğŸ¯ í›„ì† stage í™•ì¥(verify/commit ì„¸ë¶„í™” ë“±) ì‹œì—ë„ ë°°ì§€ ì˜ë¯¸ë¡ ì´ í”ë“¤ë¦¬ì§€ ì•ŠìŒ

---

## âš ï¸ ì£¼ì˜ì‚¬í•­ ë° ê³ ë ¤ì‚¬í•­

### ë¦¬íŒ©í† ë§ ì‹œ ì£¼ì˜í•  ì 

1. ë°°ì§€/ë‹¨ê³„ ì´ë²¤íŠ¸ëŠ” í”„ë¡ íŠ¸ ê³„ì•½ì…ë‹ˆë‹¤. ì´ë²¤íŠ¸ í•„ë“œ/íƒ€ì…ì„ ë°”ê¾¸ê¸°ë³´ë‹¤ â€œì–¸ì œ ë¬´ì—‡ì„ ë³´ë‚´ëŠ”ì§€â€ë¥¼ ì•ˆì •í™”í•©ë‹ˆë‹¤.
2. ë°°ì§€ ê³„ì‚°ì„ â€œì—¬ëŸ¬ ê³³â€ì—ì„œ í•˜ë©´ ë‹¤ì‹œ ë“œë¦¬í”„íŠ¸ê°€ ìƒê¹ë‹ˆë‹¤. ê°€ëŠ¥í•œ í•œ 1ê³³(verify/validate ë‹¨ê³„)ìœ¼ë¡œ ëª¨ìë‹ˆë‹¤.

### í˜¸í™˜ì„± ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ë¹„ì¦ˆë‹ˆìŠ¤ ë£° ìœ„ë°˜(ì–¸ì–´/ì¢Œí‘œ/ê²½ì œ/ì•ˆì „)ì´ ê°ê° ì˜¬ë°”ë¥¸ badgeë¡œ í‘œì‹œë˜ëŠ”ê°€?
- [ ] í´ë°±ì—ì„œë„ BadgesEventê°€ ëˆ„ë½ë˜ì§€ ì•ŠëŠ”ê°€?
- [ ] ì˜ˆì™¸ ë°œìƒ ì‹œì—ë„ stage fail(ì •ì±… ì ìš© ì‹œ)ì´ UIì—ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ë³´ì´ëŠ”ê°€?

---

## ğŸ§ª ê²€ì¦ ë°©ë²• (ìˆ˜ë™ ê²€ì¦ ì¤‘ì‹¬)

> ìƒì„¸ëŠ” `RU-005-S3.md` ì°¸ì¡°.

- mock ëª¨ë“œì—ì„œ â€œì¬í™” ë¶€ì¡±â€ ìœ ë„ â†’ `economy_fail`(ë˜ëŠ” í´ë°± ë°°ì§€)ì´ ìŠ¤íŠ¸ë¦¼ì— í‘œì‹œë˜ëŠ”ì§€ í™•ì¸
- invalid input â†’ error + final(í´ë°±) ë¿ ì•„ë‹ˆë¼ â€œë°°ì§€/ë‹¨ê³„ í‘œê¸° ì •ì±…â€ì´ ê¹¨ì§€ì§€ ì•ŠëŠ”ì§€ í™•ì¸

---

## ğŸ”§ ì‹¤í–‰ ê°€ì´ë“œ

### ê°œë°œìë¥¼ ìœ„í•œ ì‹¤í–‰ ì§€ì¹¨

1. `BusinessRuleError` íƒ€ì… ì ‘ë‘ì–´ì™€ ValidationBadgeì˜ ì˜ë¯¸ë¡ ì„ í‘œë¡œ ì •ë¦¬(ë¬¸ì„œë¡œ ë‚¨ê¸°ê¸°)
2. `repair_loop`ì˜ badge ê²°ì • ë¡œì§ì„ ë‹¨ì¼í™”í•˜ê³ , API(mock/real)ëŠ” ê·¸ ê²°ê³¼ë¥¼ ê·¸ëŒ€ë¡œ ìŠ¤íŠ¸ë¦¼ì— ë°˜ì˜
3. pipeline(stage wrapper)ì—ì„œ fail í‘œê¸° ì •ì±…ì„ ì ìš©(ê°€ëŠ¥í•˜ë©´ Q4 ì´í›„)

---

## ğŸ“š ì°¸ê³  ìë£Œ

- `backend/src/unknown_world/models/turn.py` (ValidationBadge, AgentPhase)
- `backend/src/unknown_world/validation/business_rules.py` (BusinessRuleError)
- `backend/src/unknown_world/orchestrator/repair_loop.py`
- `backend/src/unknown_world/api/turn.py`

---

## ğŸ·ï¸ íƒœê·¸

`#refactoring` `#bugs` `#high` `#observability` `#badges` `#stages`

