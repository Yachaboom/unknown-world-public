# [ID: RU-002-Q2] PRD Turn Stream Protocol(SSOT)과 구현 계약의 정합성 확보: 프로토콜 버전/필드 별칭/용어 통일

## 📌 기본 정보

| 항목               | 내용                     |
| ------------------ | ------------------------ |
| **ID**             | RU-002-Q2                |
| **심각도**         | High                     |
| **카테고리**       | 네이밍 (Naming)          |
| **영향 범위**      | `vibe/prd.md`(프로토콜 명세), `vibe/unit-runbooks/U-007-mock-orchestrator-runbook.md`, `vibe/unit-runbooks/U-008-http-streaming-client-runbook.md`, `backend/src/unknown_world/api/turn.py`, `frontend/src/api/turnStream.ts` |
| **예상 작업 시간** | 45~90분                  |

---

## 🔍 문제점 상세 분석

### 현재 상황

PRD(SSOT)에는 “Turn Stream Protocol(초안)”이 정의되어 있으나, 현재 구현(U-007/U-008) 및 런북 예시는 **다른 필드/용어를 사용**합니다.

예시(SSOT):

- `stage.name`: `"Parse"` (대문자 표기)  
- `stage.status`: `"start"|"ok"|"fail"`  
- `badges`: `{schema:"ok|fail", economy:"ok|fail", ...}`  
- `final`: `{"type":"final","turn_output":{...}}`

반면 현재 구현/런북은:

- `stage.name`: `"parse"` (소문자, enum 값)  
- `stage.status`: `"start"|"complete"`  
- `badges`: `{badges:["schema_ok", ...]}` (리스트)  
- `final`: `{"type":"final","data":{...}}`  
- 추가로 `error` 이벤트가 존재(PRD 명세에는 없음)

즉, **PRD(SSOT) ↔ 코드/런북(현실)** 간에 “계약 표기”가 어긋나, RU-002의 “용어/이벤트 타입 통일”을 막는 상태입니다.

### 문제가 되는 이유

1. **SSOT 혼선은 곧 통합 리스크**: 향후 실모델 연동(U-016~) 시 다른 사람이 PRD를 보고 구현/디버깅하면 즉시 헷갈립니다.  
2. **계약 변경의 비용이 폭증**: 어떤 문서를 믿어야 하는지 불명확하면, 변경할 때마다 프론트/백/문서가 같이 흔들립니다.  
3. **관측(Agent Console) 용어가 흔들리면 데모 신뢰가 깨짐**: PRD는 “단계/배지/복구”가 일관된 용어로 보이길 요구합니다(RULE-008).

### 영향받는 코드 위치

- PRD: `vibe/prd.md` 241-246 (Turn Stream Protocol(초안) 섹션)
- 서버: `backend/src/unknown_world/api/turn.py` 218-223(설명), 160-163(final.data)
- 클라: `frontend/src/api/turnStream.ts` 65-76(final.data), 34-39(status=complete)
- 런북: U-007 runbook 84-96, U-008 runbook 전반(현 구현 계약 기반)

### 현재 코드 예시

```md
<!-- vibe/prd.md -->
- {"type":"final","turn_output":{...}}
```

```ts
// frontend/src/api/turnStream.ts
export interface FinalEvent {
  type: typeof StreamEventType.FINAL;
  data: TurnOutput;
}
```

---

## 💡 개선 방안

### 제안하는 접근법

**“프로토콜 버전(Protocol Versioning) + 필드/용어 별칭(Backward-compatible alias)”**으로 PRD(SSOT)와 현 구현을 안전하게 정렬합니다.

권장 정책:

- **단기(MVP 안정화)**: 현 구현을 `protocol_version: "1"`로 명시하고, PRD/런북을 이에 맞게 정리(문서-코드 정합성 회복).  
- **중기(품질 개선)**: PRD의 더 좋은 형태(`ok/fail`, map badges, `turn_output`)를 `protocol_version: "2"`로 정의하고, 서버/클라가 점진적으로 마이그레이션.

> 핵심은 “한 번 정한 계약은 자주 바꾸지 않는다”를 지키되, **버전과 별칭으로 확장을 열어두는 것**입니다.

### 구체적 실행 단계

#### Step 1: 스트림 프로토콜 버전 정의 + 시작 메타 이벤트(선택)

서버가 첫 이벤트로 아래를 보낼 수 있게 합니다(선택):

```json
{"type":"protocol","version":"1"}
```

- 장점: 런타임에서 어떤 계약인지 즉시 판별 가능
- 클라는 없으면 v1로 가정(폴백)

#### Step 2: PRD의 Turn Stream Protocol 섹션을 “v1(현행) + v2(목표)”로 재정리

- PRD 8.4.3의 “초안”을 다음 중 하나로 정리:
  - **(권장) v1을 현행 계약으로 명시**하고, v2를 목표로 분리
  - 또는 “초안”을 현행으로 바꾸고, 별도 문서(예: `vibe/ref/structured-outputs-guide.md`)에 목표 프로토콜을 기록

#### Step 3: 클라이언트 디코더에서 필드/용어 별칭을 지원(하위호환)

예시(개념):

- `final.data` **또는** `final.turn_output` 둘 다 수용
- `stage.status`는 `complete`를 `ok`로 간주(또는 alias)
- `badges`는
  - v1: `badges: string[]`
  - v2: `{schema:"ok|fail", ...}`
  - 둘 다 받아서 내부 표현으로 정규화

#### Step 4: 런북(U-007/U-008) 예시 출력/설명을 PRD/코드와 같은 용어로 맞춤

- U-007 runbook 예시가 현행과 일치하므로, PRD를 맞추는 쪽이 당장 비용이 낮습니다.
- 단, “목표 프로토콜(v2)”을 도입한다면 runbook에도 v2 예시를 추가합니다.

### 대안적 접근법 (선택사항)

- **대안 1(문서만 변경)**: PRD의 프로토콜 초안을 현 구현으로 바꾸고 버전 개념은 생략
  - 장점: 빠름
  - 단점: 향후 개선 시 “또 바꾸기”가 발생하기 쉬움
- **대안 2(코드만 변경)**: 즉시 PRD 형태로 코드 계약을 바꿈
  - 장점: SSOT 준수 명확
  - 단점: 변경 범위가 크고, 중간에 클라/서버 동기화 실패 위험

---

## 📈 기대 효과

### 즉각적 효과

- ✅ PRD(SSOT) ↔ 코드/런북이 같은 계약을 말하게 되어 혼선 제거
- ✅ RU-002의 “용어 통일”을 실제로 달성 가능한 형태로 고정

### 장기적 효과

- 🎯 스트림 이벤트 확장(Repair loop, 추가 배지 등) 시에도 호환성 유지
- 🎯 문서-구현 drift로 인한 “디버깅 낭비” 감소

---

## ⚠️ 주의사항 및 고려사항

### 리팩토링 시 주의할 점

1. PRD는 SSOT이므로, “코드가 맞으니 PRD를 바꾼다”가 아니라 **왜 현 계약이 MVP에 적합한지 근거(운영/안정성/범위)를 함께 기록**해야 합니다.  
2. 프로토콜 버전 이벤트를 도입할 경우, 프론트가 이를 모르면 무시해도 되도록 “추가 이벤트는 무시 가능” 설계를 유지합니다.

### 호환성 체크리스트

- [ ] PRD 8.4.3에 “현행 계약”이 명시되어 있는가?
- [ ] 서버/클라가 `final` payload 키(alias 포함)를 일치하게 처리하는가?
- [ ] `stage.status`/`badges` 구조가 버전별로 명확히 문서화되어 있는가?

---

## 🧪 검증 방법 (수동 검증 중심)

### 변경 전 확인 사항

- 현재 런북(U-007/U-008) 시나리오를 1회 수행해 “현행 계약(v1)”을 기준으로 확보

### 변경 후 검증 시나리오

#### 시나리오 1: 문서 정합성 검증(PRD ↔ 런북 ↔ 코드)

- **실행 방법**:
  - PRD 8.4.3의 프로토콜 예시가 U-007 runbook 예시와 동일한지 확인
  - 프론트/백 코드의 `final` 이벤트 키가 문서와 일치하는지 확인
- **기대 결과**:
  - ✅ 동일한 키/값/용어로 기술됨

#### 시나리오 2: 별칭 허용(하위호환) 검증(선택)

- **실행 방법**: 서버가 임시로 `final.turn_output`(v2) 형태를 송출해도 클라에서 정상 처리되는지 확인
- **기대 결과**:
  - ✅ 클라가 alias를 수용하고 TurnOutput을 반영

---

## 🔧 실행 가이드

### 개발자를 위한 실행 지침

1. **준비 사항**
   - PRD: `vibe/prd.md` 8.4.3
   - 런북: U-007/U-008
2. **실행 절차**
   - (권장) PRD에 v1/v2 프로토콜을 명시
   - (선택) protocol 이벤트/alias 디코딩 도입
3. **검증 절차**
   - 런북 기반 수동 검증 2개 수행

---

## 📚 참고 자료

- `vibe/prd.md` 8.4.3
- `.cursor/rules/00-core-critical.mdc` (SSOT, RULE-008)
- `vibe/unit-runbooks/U-007-mock-orchestrator-runbook.md`
- `vibe/unit-runbooks/U-008-http-streaming-client-runbook.md`

---

## 🏷️ 태그

`#refactoring` `#naming` `#high` `#protocol` `#ssot`

---

## 📝 노트

- 참고로 `shared/schemas/turn/turn_input.schema.json`는 현재 구현(backend/frontend의 TurnInput)과 일부 불일치(예: `click.box_2d` 형식) 징후가 있어, “계약 정합성” 관점에서 후속 점검이 필요합니다.


