# [ID: RU-003-Q3] App.tsx ë³µì¡ë„ ì¶•ì†Œ: Turn ì‹¤í–‰/ìŠ¤íŠ¸ë¦¬ë° ê²°í•©ì„ â€œTurn Runnerâ€ ëª¨ë“ˆë¡œ ë¶„ë¦¬

## ğŸ“Œ ê¸°ë³¸ ì •ë³´

| í•­ëª©               | ë‚´ìš©                     |
| ------------------ | ------------------------ |
| **ID**             | RU-003-Q3                |
| **ì‹¬ê°ë„**         | High                     |
| **ì¹´í…Œê³ ë¦¬**       | ë³µì¡ë„ (Complexity)      |
| **ì˜í–¥ ë²”ìœ„**      | `frontend/src/App.tsx`, `frontend/src/api/turnStream.ts`, (ê¶Œì¥) `frontend/src/i18n.ts`, (ì‹ ê·œ ê¶Œì¥) `frontend/src/turn/turnRunner.ts` ë˜ëŠ” `frontend/src/turn/useTurnRunner.ts` |
| **ì˜ˆìƒ ì‘ì—… ì‹œê°„** | 30~60ë¶„                  |

---

## ğŸ” ë¬¸ì œì  ìƒì„¸ ë¶„ì„

### í˜„ì¬ ìƒí™©

`frontend/src/App.tsx`ëŠ” ê³ ì • ê²Œì„ UI ë ˆì´ì•„ì›ƒì„ ì œê³µí•˜ë©´ì„œë„, ë™ì‹œì— ì•„ë˜ â€œì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜â€ ì±…ì„ì„ ì§ì ‘ ìˆ˜í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤.

- TurnInput ì¡°í•©(ì–¸ì–´/í´ë¦­/ë“œë¡­/í´ë¼ ì •ë³´/ì¬í™” ìŠ¤ëƒ…ìƒ·) (`App.tsx` 387~407)
- ìŠ¤íŠ¸ë¦¼ ì‹œì‘/ì·¨ì†Œ ref ê´€ë¦¬ (`App.tsx` 341~342, 445~447, 513~518)
- ìŠ¤íŠ¸ë¦¼ ì½œë°± ì—°ê²°(Agent Store + UI ìƒíƒœ ê°±ì‹  + Scene ìƒíƒœ ì²˜ë¦¬) (`App.tsx` 415~443)

ì´ëŠ” U-009~U-012ì—ì„œ ê¸°ëŠ¥ì´ ë¹ ë¥´ê²Œ ë¶™ëŠ” ë™ì•ˆì€ ê´œì°®ì§€ë§Œ, RU-003 ì´í›„ Quest/Rule/SaveGame/Scannerê°€ ì¶”ê°€ë˜ë©´ `App.tsx`ê°€ **â€œë ˆì´ì•„ì›ƒ íŒŒì¼â€ì´ ì•„ë‹ˆë¼ â€œì»¨íŠ¸ë¡¤ëŸ¬â€ë¡œ ë¹„ëŒ€í•´ì§€ëŠ” ë°©í–¥**ìœ¼ë¡œ êµ³ì–´ì§‘ë‹ˆë‹¤.

### ë¬¸ì œê°€ ë˜ëŠ” ì´ìœ 

1. **ì½œë°± ê²°í•©ì´ ê°•í•´ì ¸ ë³€ê²½ ë°˜ê²½ì´ ì»¤ì§**  
   ì‘ì€ ê³„ì•½ ë³€ê²½(ì˜ˆ: TurnInput í•„ë“œ í™•ì¥, ì—ëŸ¬ ì½”ë“œ ì¶”ê°€)ì´ ê³§ë°”ë¡œ Appì˜ ì—¬ëŸ¬ í•¸ë“¤ëŸ¬/ìƒíƒœì— ì˜í–¥ì„ ì¤ë‹ˆë‹¤.
2. **ìŠ¤í† ì–´/ë¡œì»¬ ìƒíƒœ ê²½ê³„ ì •ë¦¬(RU-003-Q4)ì™€ ì¶©ëŒ**  
   worldStore ë„ì… ì „/í›„ ëª¨ë‘ Appì˜ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ì½”ë“œê°€ ë¹„ëŒ€í•˜ë©´, ê²½ê³„ ì •ë¦¬ í›„ì—ë„ â€œí•µì‹¬ ê²°í•© ì§€ì â€ì´ ë‚¨ì•„ ë¦¬íŒ©í† ë§ íš¨ê³¼ê°€ ë°˜ê°ë©ë‹ˆë‹¤.
3. **ì‹¤íŒ¨/ì·¨ì†Œ/ì¬ì‹œë„ UX í™•ì¥ ì—¬ì§€ê°€ ë¶€ì¡±**  
   í–¥í›„ â€œCancel/Pause/Autopilotâ€ ê°™ì€ UXê°€ ë“¤ì–´ì˜¬ ë•Œ, í˜„ì¬ êµ¬ì¡°ëŠ” ìƒíƒœ/ì·¨ì†Œ ì „íŒŒ ê·œì¹™ì„ App ì•ˆì—ì„œ ê³„ì† ëŠ˜ë¦¬ê²Œ ë©ë‹ˆë‹¤.

### ì˜í–¥ë°›ëŠ” ì½”ë“œ ìœ„ì¹˜

- `frontend/src/App.tsx`: `executeTurn` ì „ì²´(383~462), ì½œë°± êµ¬ì„±(415~443)
- `frontend/src/api/turnStream.ts`: `startTurnStream`/ì½œë°± ê³„ì•½(464~470)

---

## ğŸ’¡ ê°œì„  ë°©ì•ˆ

### ì œì•ˆí•˜ëŠ” ì ‘ê·¼ë²•

Turn ì‹¤í–‰/ìŠ¤íŠ¸ë¦¬ë° ê²°í•©ì„ â€œTurn Runnerâ€ë¡œ ë¶„ë¦¬í•´ **Appì€ UI ì´ë²¤íŠ¸ë¥¼ â€˜runTurnâ€™ì— ë¼ìš°íŒ…**í•˜ê³ , Turn RunnerëŠ” **ìŠ¤íŠ¸ë¦¼ IO + ì½œë°± ë¶„ë°° + ì·¨ì†Œ**ë¥¼ ë‹´ë‹¹í•˜ë„ë¡ ì—­í• ì„ ì¬ë°°ì¹˜í•©ë‹ˆë‹¤.

ê¶Œì¥ êµ¬ì¡°:

- `frontend/src/turn/turnRunner.ts` (ë˜ëŠ” `useTurnRunner.ts`): TurnInput ìƒì„± + startTurnStream í˜¸ì¶œ + ì½œë°± ë¼ìš°íŒ…
- `worldStore.applyTurnOutput` (RU-003-Q4): TurnOutput ë°˜ì˜ SSOT
- `agentStore`: stage/badges/narrative_delta/final/error ìƒíƒœ ì €ì¥

> ì´ ì œì•ˆì€ RU-003-Q4(worldStore)ì™€ í•¨ê»˜ ì ìš©ë  ë•Œ íš¨ê³¼ê°€ ìµœëŒ€ì…ë‹ˆë‹¤.

### êµ¬ì²´ì  ì‹¤í–‰ ë‹¨ê³„

#### Step 1: TurnInput ìƒì„± ë¡œì§ì„ Turn Runnerë¡œ ì´ë™

**ë³€ê²½ ì „**: Appì—ì„œ TurnInput ì§ì ‘ êµ¬ì„± (`App.tsx` 387~407)

**ë³€ê²½ í›„(ê¶Œì¥)**: Turn Runnerì—ì„œ ë‹¤ìŒ í˜•íƒœë¡œ ë‹¨ì¼í™”

```ts
// frontend/src/turn/turnRunner.ts (ê°œë… ì˜ˆì‹œ)
import type { TurnInput, DropInput } from '../schemas/turn';
import type { HotspotClickData } from '../components/SceneCanvas';
import { getResolvedLanguage } from '../i18n';

export function buildTurnInput(params: {
  text: string;
  actionId?: string;
  click?: HotspotClickData;
  drop?: DropInput;
  economySnapshot: { signal: number; memory_shard: number };
  theme: 'dark' | 'light';
}): TurnInput {
  return {
    language: getResolvedLanguage(),
    text: params.text,
    action_id: params.actionId ?? null,
    click: params.click
      ? { object_id: params.click.object_id, box_2d: params.click.box_2d }
      : null,
    drop: params.drop ?? null,
    client: {
      viewport_w: window.innerWidth,
      viewport_h: window.innerHeight,
      theme: params.theme,
    },
    economy_snapshot: params.economySnapshot,
  };
}
```

#### Step 2: â€œìŠ¤íŠ¸ë¦¼ ì‹œì‘/ì·¨ì†Œ/ì½œë°± ë¼ìš°íŒ…â€ì„ Turn Runnerë¡œ ì´ë™

Turn RunnerëŠ” `startTurnStream`ì„ í˜¸ì¶œí•˜ê³ , **Appì´ í•„ìš”ë¡œ í•˜ëŠ” ìµœì†Œ ê²°ê³¼ë§Œ ë…¸ì¶œ**í•©ë‹ˆë‹¤.

ê¶Œì¥ ì¸í„°í˜ì´ìŠ¤:

- `runTurn({ text, actionId, click, drop }): void`
- `cancel(): void` (ì¶”í›„ Cancel UXë¥¼ ìœ„í•´ ê¸°ë³¸ ê³¨ê²©ë§Œ)

ì½œë°± ë¼ìš°íŒ… ì •ì±…(ê¶Œì¥):

- `onStage/onBadges/onNarrativeDelta/onError` â†’ `agentStore`ë¡œë§Œ ì „ë‹¬
- `onFinal` â†’ `agentStore.handleFinal` + `worldStore.applyTurnOutput`
- `onComplete` â†’ `agentStore.completeStream` + (í•„ìš” ì‹œ) `worldStore`ì˜ ì”¬ ìƒíƒœ ë³µêµ¬

#### Step 3: App.tsxëŠ” â€œì´ë²¤íŠ¸ ë¼ìš°íŒ…â€ìœ¼ë¡œ ë‹¨ìˆœí™”

Appì—ì„œ ë‚¨ëŠ” ì½”ë“œëŠ”:

- ì¹´ë“œ í´ë¦­ â†’ `runTurn({ text: card.label, actionId: card.id })`
- í•«ìŠ¤íŒŸ í´ë¦­ â†’ `runTurn({ text: clickText, click })`
- ë“œë¡­ ì„±ê³µ/ì‹¤íŒ¨ â†’ ì„±ê³µì´ë©´ `runTurn({ text: dropText, drop })`, ì‹¤íŒ¨ë©´ `worldStore.appendSystemNarrative(...)`

> ì´ë ‡ê²Œ í•˜ë©´ Appì€ â€œíŒ¨ë„ ë°°ì¹˜ + ì‚¬ìš©ì ì…ë ¥ ì´ë²¤íŠ¸ ë¼ìš°íŒ…â€ë§Œ ë‚¨ê³ , ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ì˜ ìƒì„¸ëŠ” Turn Runnerê°€ ë‹´ë‹¹í•©ë‹ˆë‹¤.

### ëŒ€ì•ˆì  ì ‘ê·¼ë²• (ì„ íƒì‚¬í•­)

- **ëŒ€ì•ˆ 1(ë” ë‹¨ìˆœ)**: Turn Runnerë¥¼ í›…ì´ ì•„ë‹ˆë¼ â€œì¼ë°˜ í•¨ìˆ˜ ëª¨ë“ˆâ€ë¡œ ë‘ê³ , Appì—ì„œ í•„ìš”í•œ store ì•¡ì…˜ì„ ë„˜ê¸°ëŠ” DI í˜•íƒœë¡œ êµ¬í˜„  
  - ì¥ì : React í›… ê·œì¹™ì— ëœ ë¬¶ì„
  - ë‹¨ì : DI íŒŒë¼ë¯¸í„°ê°€ ëŠ˜ë©´ í˜¸ì¶œë¶€ê°€ ë‹¤ì‹œ ì§€ì €ë¶„í•´ì§ˆ ìˆ˜ ìˆìŒ

---

## ğŸ“ˆ ê¸°ëŒ€ íš¨ê³¼

### ì¦‰ê°ì  íš¨ê³¼

- âœ… App.tsx ë³€ê²½ ë°˜ê²½ ì¶•ì†Œ(ë ˆì´ì•„ì›ƒ/ìƒíƒœ/ìŠ¤íŠ¸ë¦¬ë°ì´ ë¶„ë¦¬ë¨)
- âœ… ì·¨ì†Œ/ì¬ì‹œë„/Autopilot ê°™ì€ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ UX í™•ì¥ ì‹œ êµ¬ì¡°ì  ì—¬ì§€ í™•ë³´

### ì¥ê¸°ì  íš¨ê³¼

- ğŸ¯ TurnInput/TurnOutput ì ìš© ê·œì¹™ì´ í•œ ê³³ì— ëª¨ì—¬ drift/ì¤‘ë³µ ê°ì†Œ
- ğŸ¯ â€œê²Œì„ UI ê³ ì •â€ì„ ìœ ì§€í•˜ë©´ì„œë„ ê¸°ëŠ¥ ì¶”ê°€ ì†ë„ë¥¼ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€

---

## âš ï¸ ì£¼ì˜ì‚¬í•­ ë° ê³ ë ¤ì‚¬í•­

1. **í”„ë¡œë•ì…˜ ì•ˆì „ì„±**: Turn Runner ë¶„ë¦¬ëŠ” ë¡œì§ ì´ë™ì´ë¯€ë¡œ â€œë™ì¼ ì…ë ¥ â†’ ë™ì¼ ìš”ì²­/ë™ì¼ UI ê²°ê³¼â€ê°€ ìœ ì§€ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
2. **ì·¨ì†Œ UX ë„ì… ì „ ê°€ë“œ**: í˜„ì¬ `executeTurnStream`ì€ Abort ì‹œ `onComplete`ë¥¼ í˜¸ì¶œí•˜ì§€ ì•ŠëŠ” ì •ì±…ì´ë¯€ë¡œ, Cancel ë²„íŠ¼ì„ ë„£ì„ ê³„íšì´ë¼ë©´ â€œì·¨ì†Œ ì‹œ UI ë³µêµ¬ ì •ì±…â€ì„ ë³„ë„ë¡œ ëª…ì‹œí•´ì•¼ í•©ë‹ˆë‹¤(RU-003-S1 ì°¸ê³ ).

---

## ğŸ§ª ê²€ì¦ ë°©ë²• (ìˆ˜ë™ ê²€ì¦ ì¤‘ì‹¬)

- Action Deck í´ë¦­/Hotspot í´ë¦­/ë“œë¡­ ì„±ê³µ/ë“œë¡­ ì‹¤íŒ¨ê°€ ëª¨ë‘ â€œë¬´ë°˜ì‘ ì—†ì´â€ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸
- ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì—ëŠ” í´ë¦­/ë“œë˜ê·¸/ì¹´ë“œê°€ ë™ì¼í•˜ê²Œ ë¹„í™œì„±í™”ë˜ëŠ”ì§€ í™•ì¸

> ìƒì„¸ ì ˆì°¨ëŠ” `RU-003-S3`ë¥¼ ë”°ë¦…ë‹ˆë‹¤.

---

## ğŸ”§ ì‹¤í–‰ ê°€ì´ë“œ

```bash
# í”„ë¡ íŠ¸ ê°œë°œ ì„œë²„ ì‹¤í–‰(ì˜ˆì‹œ)
pnpm -C frontend dev --port 8001
```

- Turn Runner ë„ì… í›„, RU-003-S3 ìˆ˜ë™ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ 1íšŒ ì´ìƒ ìˆ˜í–‰í•´ íšŒê·€ í™•ì¸

---

## ğŸ“š ì°¸ê³  ìë£Œ

- `vibe/unit-plans/RU-003[Mvp].md` (TurnOutput ë°˜ì˜ ê²½ë¡œ ë‹¨ì¼í™”/selector ê¸°ë°˜ êµ¬ë…)
- `frontend/src/App.tsx` (executeTurn ë° ì½œë°± ê²°í•© ì§€ì )

---

## ğŸ·ï¸ íƒœê·¸

`#refactoring` `#complexity` `#high` `#streaming` `#orchestration` `#frontend`

