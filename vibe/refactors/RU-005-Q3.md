# [ID: RU-005-Q3] ë³µì¡ë„: `api/turn.py` ìŠ¤íŠ¸ë¦¬ë° ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ì¶•ì†Œ(ì¤‘ë³µ ì œê±° + íŒŒì´í”„ë¼ì¸ ìœ„ì„)

## ğŸ“Œ ê¸°ë³¸ ì •ë³´

| í•­ëª©               | ë‚´ìš©                                                                                          |
| ------------------ | --------------------------------------------------------------------------------------------- |
| **ID**             | RU-005-Q3                                                                                     |
| **ì‹¬ê°ë„**         | High                                                                                          |
| **ì¹´í…Œê³ ë¦¬**       | ë³µì¡ë„ (Complexity)                                                                           |
| **ì˜í–¥ ë²”ìœ„**      | `backend/src/unknown_world/api/turn.py`, (ì—°ë™) `backend/src/unknown_world/api/turn_stream_events.py`, (ê¶Œì¥ ì‹ ê·œ) `backend/src/unknown_world/api/turn_streaming_helpers.py` ë˜ëŠ” `orchestrator/pipeline.py` |
| **ì˜ˆìƒ ì‘ì—… ì‹œê°„** | 45~90ë¶„                                                                                       |

---

## ğŸ” ë¬¸ì œì  ìƒì„¸ ë¶„ì„

### í˜„ì¬ ìƒí™©

`backend/src/unknown_world/api/turn.py`ëŠ” í•œ íŒŒì¼ ì•ˆì—ì„œ ë‹¤ìŒì„ ëª¨ë‘ ìˆ˜í–‰í•©ë‹ˆë‹¤.

- ì…ë ¥ íŒŒì‹±/ê²€ì¦(`_validate_and_parse_input`)
- mock/real ë¶„ê¸°(`_is_mock_mode`)
- stage ì´ë²¤íŠ¸ ì†¡ì¶œ + ë”œë ˆì´ ì‹œë®¬ë ˆì´ì…˜(Plan~Commit)
- narrative_delta íƒ€ì íš¨ê³¼ ìŠ¤íŠ¸ë¦¬ë°
- repair ì´ë²¤íŠ¸ ì†¡ì¶œ(U-018)
- error + final(í´ë°±) ì¢…ë£Œ ì¸ë°”ë¦¬ì–¸íŠ¸(RULE-004)

íŠ¹íˆ `_stream_turn_events_mock`ê³¼ `_stream_turn_events_real`ì€ â€œí•´ì•¼ í•˜ëŠ” ì¼â€ì´ ìƒë‹¹íˆ ê²¹ì¹˜ì§€ë§Œ, êµ¬í˜„ì´ ê°ˆë¼ì ¸ ìˆì–´ ë³€ê²½ ì‹œ ë‘ ê²½ë¡œë¥¼ ë™ì‹œì— ë§ì¶”ê¸° ì–´ë µìŠµë‹ˆë‹¤.

### ë¬¸ì œê°€ ë˜ëŠ” ì´ìœ 

1. **ì½ê¸°/ìˆ˜ì • ë¹„ìš© ì¦ê°€**: stage/repair/badges/narrative/finalì´ í•œ íŒŒì¼ì— ì„ì—¬ ìˆì–´, ì‘ì€ ë³€ê²½ë„ íšŒê·€ ë¦¬ìŠ¤í¬ê°€ ì»¤ì§‘ë‹ˆë‹¤.
2. **ì¤‘ë³µìœ¼ë¡œ ì¸í•œ ë¶ˆì¼ì¹˜**: mock/realì´ ê°ì stage/ë°°ì§€/ë³µêµ¬ë¥¼ ì²˜ë¦¬í•˜ë©´ì„œ â€œí•œìª½ë§Œ ìˆ˜ì •â€ë˜ëŠ” ìˆœê°„ ë“œë¦¬í”„íŠ¸ê°€ ë°œìƒí•©ë‹ˆë‹¤.
3. **RU-005 ëª©í‘œì™€ ë¶ˆì¼ì¹˜**: â€œstage ê¸°ë°˜ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°â€ë¥¼ ë§Œë“¤ë ¤ë©´ APIëŠ” transport(ìŠ¤íŠ¸ë¦¼ ì§ë ¬í™”)ì— ì§‘ì¤‘í•˜ê³ , stage ì‹¤í–‰ì€ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ë¡œ ë‚´ë ¤ê°€ëŠ” í¸ì´ ì•ˆì •ì ì…ë‹ˆë‹¤.

### ì˜í–¥ë°›ëŠ” ì½”ë“œ ìœ„ì¹˜

- `backend/src/unknown_world/api/turn.py`
  - `_stream_turn_events_mock` (ëŒ€ê·œëª¨ ë£¨í”„ + ìì²´ repair loop)
  - `_stream_turn_events_real` (validate ì´í›„ ë‹¨ê³„ ì‹œë®¬ë ˆì´ì…˜ + íƒ€ì íš¨ê³¼)
  - `ORCHESTRATOR_PHASES`, `PHASE_DELAYS_MS`(ë‹¨ê³„/ë”œë ˆì´ ì •ì˜ê°€ APIì— ì¡´ì¬)

---

## ğŸ’¡ ê°œì„  ë°©ì•ˆ

### ì œì•ˆí•˜ëŠ” ì ‘ê·¼ë²•

í•µì‹¬ì€ â€œAPIê°€ pipelineì„ ì‹¤í–‰í•œë‹¤â€ê°€ ì•„ë‹ˆë¼, **APIëŠ” â€˜ìŠ¤íŠ¸ë¦¼ ì´ë²¤íŠ¸ë¥¼ ì§ë ¬í™”í•´ í˜ë ¤ë³´ë‚´ëŠ” ì—­í• â€™ë§Œ ë‚¨ê¸°ëŠ” ê²ƒ**ì…ë‹ˆë‹¤.

RU-005-Q4ì˜ pipelineì„ ì±„íƒí•œë‹¤ë©´ ê°€ì¥ ê¹”ë”í•˜ì§€ë§Œ, ê·¸ ì´ì „ ë‹¨ê³„ë¡œë„ ë‹¤ìŒì„ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- ì¤‘ë³µë˜ëŠ” ìŠ¤íŠ¸ë¦¬ë° ì¡°ê°ì„ helperë¡œ ì¶”ì¶œ
- mock/realì´ ê³µìœ í•˜ëŠ” â€œstage ì´ë²¤íŠ¸ ì†¡ì¶œ/íƒ€ì íš¨ê³¼/ì—ëŸ¬+finalâ€ ê²½ë¡œë¥¼ ë‹¨ì¼í™”
- ìµœì¢…ì ìœ¼ë¡œëŠ” pipeline(ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°)ë¡œ ìœ„ì„í•˜ëŠ” êµ¬ì¡°ë¡œ ìˆ˜ë ´

### êµ¬ì²´ì  ì‹¤í–‰ ë‹¨ê³„

#### Step 1: ìŠ¤íŠ¸ë¦¬ë° ê³µí†µ í—¬í¼ ì¶”ì¶œ

ë‹¤ìŒ 3ê°œëŠ” mock/real ëª¨ë‘ì—ì„œ ë°˜ë³µë©ë‹ˆë‹¤.

- stage start/complete(ë˜ëŠ” fail) ì†¡ì¶œ
- narrative_delta â€œchunking + ë”œë ˆì´â€
- error + final(í´ë°±) ì¢…ë£Œ ì¸ë°”ë¦¬ì–¸íŠ¸

ê¶Œì¥: `backend/src/unknown_world/api/turn_streaming_helpers.py` ê°™ì€ ëª¨ë“ˆë¡œ ì¶”ì¶œ(ì´ë¦„ì€ íŒ€ ê·œì¹™ì— ë§ê²Œ ì¡°ì •).

```python
# turn_streaming_helpers.py (ê°œë… ì˜ˆì‹œ)
from collections.abc import AsyncGenerator
from unknown_world.api.turn_stream_events import StageEvent, StageStatus, StreamEventType, serialize_event

def emit_stage(name: str, status: str) -> str:
    return serialize_event(StageEvent(type=StreamEventType.STAGE, name=name, status=status).model_dump())
```

#### Step 2: `_stream_turn_events_mock/_real`ì˜ ê³µí†µ ê³¨ê²© í†µí•©

í˜„ì¬ëŠ” mock/realì´ ì„œë¡œ ë‹¤ë¥¸ ìˆœì„œ/í˜•íƒœë¡œ ë™ì‘í•©ë‹ˆë‹¤.

- mock: ë‹¨ê³„ ì‹œë®¬ë ˆì´ì…˜ â†’ ë‚´ë¶€ whileë¡œ repair ì‹œë„ â†’ (ì„±ê³µ ì‹œ) badges ì „ì†¡ â†’ narrative_delta â†’ final
- real: parse ì™„ë£Œ â†’ validate start â†’ `run_repair_loop()` ì‹¤í–‰ â†’ repair ì´ë²¤íŠ¸(ì‚¬í›„ ì†¡ì¶œ) â†’ validate complete â†’ badges â†’ ë‚˜ë¨¸ì§€ ë‹¨ê³„ ì‹œë®¬ë ˆì´ì…˜ â†’ narrative_delta â†’ final

ê¶Œì¥ ê³¨ê²©(ê°œë…):

1) stage ì´ë²¤íŠ¸ëŠ” ê³µí†µ í•¨ìˆ˜ë¡œ ì†¡ì¶œ  
2) â€œì¶œë ¥ ìƒì„±/ê²€ì¦/ë³µêµ¬â€ëŠ” mock/real ê°ê°ì˜ providerë¡œ ë¶„ë¦¬  
3) narrative/final ì†¡ì¶œì€ ê³µí†µ í•¨ìˆ˜ë¡œ í•©ì¹˜ê¸°

#### Step 3: ë‹¨ê³„/ë”œë ˆì´ ì •ì˜ì˜ ìœ„ì¹˜ ì •ë¦¬(SSOTë¡œ ì´ë™)

`ORCHESTRATOR_PHASES`/`PHASE_DELAYS_MS`ëŠ” APIì— ë‘ê¸°ë³´ë‹¤, ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°(pipeline) ë˜ëŠ” â€œê³µìœ  ìƒìˆ˜ ëª¨ë“ˆâ€ë¡œ ì´ë™í•˜ëŠ” í¸ì´ ë“œë¦¬í”„íŠ¸ ë°©ì§€ì— ìœ ë¦¬í•©ë‹ˆë‹¤.

ë‹¨, RU-005ëŠ” ë™ì‘ ë³´ì¡´ì´ ìš°ì„ ì´ë¯€ë¡œ:

- ë¨¼ì € â€œì •ì˜ ìœ„ì¹˜ë§Œ ì´ë™â€
- ë‹¤ìŒì— â€œì‹¤ì œ ë¡œì§ì´ ë¶™ëŠ” stageâ€ëŠ” pipelineì—ì„œ ì±…ì„ì§€ë„ë¡ ìˆ˜ë ´

#### Step 4: ìµœì¢…ì ìœ¼ë¡œ pipeline ìœ„ì„(RU-005-Q4ì™€ í•©ë¥˜)

Q4ì˜ pipelineì´ ë“¤ì–´ì˜¤ë©´, `api/turn.py`ëŠ” ì•„ë˜ í˜•íƒœë¡œ ë§¤ìš° ì–‡ì•„ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- request â†’ TurnInput íŒŒì‹±
- `emit` ì½œë°± ì¤€ë¹„(ì´ë²¤íŠ¸ë¥¼ NDJSONë¡œ ë³€í™˜í•˜ì—¬ yield)
- `run_pipeline(ctx, emit=emit)` ì‹¤í–‰
- final ì´ë²¤íŠ¸ 1íšŒë¡œ ì¢…ë£Œ

### ëŒ€ì•ˆì  ì ‘ê·¼ë²• (ì„ íƒì‚¬í•­)

- **ëŒ€ì•ˆ 1(í˜„ êµ¬ì¡° ìœ ì§€ + ë¶€ë¶„ ì¶”ì¶œ)**: helperë§Œ ì¶”ì¶œí•˜ê³  mock/real í•¨ìˆ˜ëŠ” ìœ ì§€  
  - ì¥ì : ë³€ê²½ ë²”ìœ„ ìµœì†Œ
  - ë‹¨ì : í•µì‹¬ ë¬¸ì œ(ë“œë¦¬í”„íŠ¸/ì±…ì„ ê²½ê³„)ëŠ” ë‚¨ìŒ
- **ëŒ€ì•ˆ 2(Generator ê¸°ë°˜ pipeline)**: pipeline ìì²´ê°€ `yield`ë¡œ ì´ë²¤íŠ¸ë¥¼ ë‚´ë³´ë‚´ê²Œ ì„¤ê³„  
  - ì¥ì : API ì½”ë“œê°€ ë” ì–‡ì•„ì§
  - ë‹¨ì : ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ê°€ transport í¬ë§·(NDJSON/StreamEvent ëª¨ë¸)ì— ëŒë ¤ê°ˆ ìœ„í—˜

---

## ğŸ“ˆ ê¸°ëŒ€ íš¨ê³¼

### ì¦‰ê°ì  íš¨ê³¼

- âœ… `api/turn.py` ìˆ˜ì • ë‚œì´ë„/íšŒê·€ ë¦¬ìŠ¤í¬ ê°ì†Œ
- âœ… mock/real ê²½ë¡œì—ì„œ ê³µí†µ ë¡œì§ì´ ëŠ˜ì–´ë‚˜ â€œí•œìª½ë§Œ ê³ ì³ì„œ ê¹¨ì§€ëŠ”â€ ìƒí™© ê°ì†Œ
- âœ… ë‹¨ê³„/ë°°ì§€/ì—ëŸ¬/í´ë°± ì†¡ì¶œ ê·œì¹™ì´ í•œ ê³³ìœ¼ë¡œ ëª¨ì—¬ ê´€ì¸¡ í’ˆì§ˆ ìƒìŠ¹

### ì¥ê¸°ì  íš¨ê³¼

- ğŸ¯ RU-005-Q4 stage pipelineìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ìˆ˜ë ´
- ğŸ¯ ì´í›„ ê¸°ëŠ¥(ì´ë¯¸ì§€/Autopilot) ì¶”ê°€ ì‹œ, API ê³„ì¸µ ë³€ê²½ì„ ìµœì†Œí™” ê°€ëŠ¥

---

## âš ï¸ ì£¼ì˜ì‚¬í•­ ë° ê³ ë ¤ì‚¬í•­

### ë¦¬íŒ©í† ë§ ì‹œ ì£¼ì˜í•  ì 

1. NDJSON ì´ë²¤íŠ¸ íƒ€ì…/í•„ë“œëª…ì€ í”„ë¡ íŠ¸(Agent Console)ê°€ ì†Œë¹„í•˜ëŠ” ê³„ì•½ì…ë‹ˆë‹¤. ê³„ì•½ì„ ë°”ê¾¸ì§€ ì•Šê³  ë‚´ë¶€ êµ¬ì¡°ë§Œ ì •ë¦¬í•©ë‹ˆë‹¤.
2. ì—ëŸ¬ ê²½ë¡œì—ì„œë„ `final` 1íšŒ ì¢…ë£Œ ì¸ë°”ë¦¬ì–¸íŠ¸ë¥¼ ì ˆëŒ€ ê¹¨ì§€ ì•ŠìŠµë‹ˆë‹¤(RULE-004).
3. í”„ë¡¬í”„íŠ¸ ì›ë¬¸/ë‚´ë¶€ ì¶”ë¡ /ë¯¼ê°ì •ë³´ë¥¼ ìŠ¤íŠ¸ë¦¼ì— ì„ì§€ ì•ŠìŠµë‹ˆë‹¤(RULE-007/008).

### í˜¸í™˜ì„± ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] mock/real ëª¨ë‘ stageâ†’badgesâ†’narrative_deltaâ†’final íë¦„ì´ ìœ ì§€ë˜ëŠ”ê°€?
- [ ] ì˜ˆì™¸ê°€ ë°œìƒí•´ë„ error + final(í´ë°±)ë¡œ ì¢…ë£Œë˜ëŠ”ê°€?
- [ ] stage ì´ë¦„/ìˆœì„œê°€ PRD(AgentPhase)ì™€ ì¼ì¹˜í•˜ëŠ”ê°€?

---

## ğŸ§ª ê²€ì¦ ë°©ë²• (ìˆ˜ë™ ê²€ì¦ ì¤‘ì‹¬)

> ìƒì„¸ëŠ” `RU-005-S3.md` ì°¸ê³ .

1. mock ëª¨ë“œ ì •ìƒ ìš”ì²­ 1íšŒ
2. mock ëª¨ë“œ â€œì¬í™” ë¶€ì¡±â€ ìœ ë„ ìš”ì²­ 1íšŒ(í´ë°± í™•ì¸)
3. invalid input ìš”ì²­ 1íšŒ(error+final í™•ì¸)

---

## ğŸ”§ ì‹¤í–‰ ê°€ì´ë“œ

### ê°œë°œìë¥¼ ìœ„í•œ ì‹¤í–‰ ì§€ì¹¨

1. **ì¤€ë¹„ ì‚¬í•­**
   - `api/turn.py`ì—ì„œ â€œì¤‘ë³µâ€ë˜ëŠ” ì†¡ì¶œ ë¡œì§(ë‹¨ê³„/íƒ€ì/ì—ëŸ¬+final)ì„ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¡œ ì¶”ì¶œ
2. **ì‹¤í–‰ ì ˆì°¨**
   - helper ì¶”ì¶œ â†’ mock/realì—ì„œ í˜¸ì¶œí•˜ë„ë¡ ë³€ê²½ â†’ ë§ˆì§€ë§‰ì— pipelineìœ¼ë¡œ í•©ë¥˜(Q4)
3. **ê²€ì¦ ì ˆì°¨**
   - `RU-005-S3.md` ìˆ˜ë™ ì‹œë‚˜ë¦¬ì˜¤ ìˆ˜í–‰
4. **ë¡¤ë°± ê³„íš**
   - helper ë„ì… ì»¤ë°‹ë§Œ ë˜ëŒë¦¬ë©´ ì›ë³µ ê°€ëŠ¥(ë¦¬íŒ©í† ë§ì„ ì‘ì€ ë‹¨ìœ„ë¡œ ìª¼ê°œëŠ” ê²ƒì´ í•µì‹¬)

---

## ğŸ“š ì°¸ê³  ìë£Œ

- `backend/src/unknown_world/api/turn.py`
- `backend/src/unknown_world/api/turn_stream_events.py`
- `.cursor/rules/20-backend-orchestrator.mdc`
- `vibe/refactors/RU-005-Q4.md` (pipeline ìœ„ì„ ì„¤ê³„)

---

## ğŸ·ï¸ íƒœê·¸

`#refactoring` `#complexity` `#high` `#backend` `#streaming` `#orchestrator`

