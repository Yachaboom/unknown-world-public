# [ID: RU-003-S2] 엣지 케이스: Hotspot 오버레이 × DnD 드롭 × 스트리밍 비활성화의 일관성 강화

## 📌 기본 정보

| 항목               | 내용                     |
| ------------------ | ------------------------ |
| **ID**             | RU-003-S2                |
| **심각도**         | Medium                   |
| **카테고리**       | 엣지 케이스 (Edge Cases) |
| **영향 범위**      | `frontend/src/App.tsx`, `frontend/src/components/SceneCanvas.tsx`, `frontend/src/components/InventoryPanel.tsx` |
| **예상 작업 시간** | 20~40분                  |

---

## 🔍 문제점 상세 분석

### 현재 상황

기본 흐름(카드/클릭/드롭)은 동작하지만, DnD와 핫스팟 오버레이는 UI 상호작용 특성상 “경계 상황”에서 쉽게 사용자에게 **무반응/헷갈림**을 줄 수 있습니다.

현재 구현에서 특히 주의할 지점:

1. **겹치는 핫스팟**  
   `dnd-kit`의 기본 충돌 판정에 따라 가장 가까운 droppable이 선택됩니다. 오브젝트가 겹치면 “의도한 대상이 아닌” 곳에 드롭될 수 있습니다.
2. **placeholder 상태에서도 핫스팟이 렌더될 수 있음**  
   `SceneCanvas`는 `(isSceneActive || status === 'default')` 조건으로 핫스팟을 렌더합니다(`SceneCanvas.tsx` 255~258).  
   데모 목적이라면 괜찮지만, “실제 장면이 아닌데 드롭 가능한 것처럼 보이는” 혼란이 발생할 수 있습니다.
3. **리사이즈/레이아웃 변화 중 드래그**  
   `ResizeObserver`로 캔버스 크기가 변하며(`SceneCanvas.tsx` 211~232), 드래그 중 핫스팟 영역이 움직이면 사용자는 드롭 타겟을 놓치기 쉽습니다.
4. **스트리밍 중 비활성화의 일관성**  
   현재는 `disabled={isStreaming}`으로 draggable/droppable/click을 차단하지만(App → SceneCanvas/InventoryPanel), 추후 worldStore/Turn Runner 도입 시 이 플래그의 출처가 분산되면 “어떤 요소는 비활성, 어떤 요소는 활성”처럼 보일 수 있습니다.

### 문제가 되는 이유

- 게임 UX에서 “드롭이 안 됐는지/안 먹혔는지”는 치명적입니다.  
  RU-003 목적(경계 정리)은 기능 안정성을 올리는 것이므로, 엣지 케이스에서의 피드백/정책을 함께 고정하는 게 효과적입니다.

---

## 💡 개선 방안

### 제안하는 접근법

엣지 케이스를 “기능 추가”로 해결하기보다, **정책(Policy)과 조건(Guard)을 명시**해 일관성을 확보합니다.

권장 정책:

- **인터랙션 가능 조건**을 SSOT로 둔다: `isStreaming === false` && `sceneStatus`가 인터랙션 허용 상태(예: `scene` 또는 `default(데모)`로 제한)
- **겹침 해결 전략**을 명시한다: 우선순위(레이어), 또는 드롭 타겟 확정 방식(hover 시 ‘대상 고정’)
- **피드백은 즉시 제공**: 드롭 실패/대상 모호 시 내러티브/툴팁으로 이유를 명확히 표시

### 구체적 실행 단계

#### Step 1: 핫스팟 렌더/드롭 허용 조건을 명시적으로 고정

현재:

- placeholder(`default`)에서도 핫스팟 렌더 가능

권장(택1):

- **Option A(데모 유지)**: `default`에서 핫스팟을 보여주되, 툴팁/라벨에 “데모 대상”임을 표시(혼란 감소)
- **Option B(엄격)**: `status === 'scene'`일 때만 핫스팟 렌더/드롭 허용

#### Step 2: 겹치는 핫스팟의 “드롭 타겟 결정” 정책 추가

가능한 접근(도입 비용 낮은 순):

- **A) 시각적 우선순위**: 겹침이 있는 오브젝트에 우선순위(예: 더 작은 bbox 우선, 또는 명시 priority)를 두고, hover 시 우선 대상만 하이라이트
- **B) 사용자 확정**: hover 중 툴팁에서 대상 이름을 명확히 보여주고, 드롭 시 그 대상이 확정되도록 처리
- **C) dnd-kit collisionDetection 커스터마이즈**(선택): 프로젝트가 커질 때만 고려

#### Step 3: 리사이즈 중 드래그 UX 안전장치(간단)

권장(단순):

- 드래그 중에는 핫스팟 bbox 리렌더가 과도하게 흔들리지 않도록 “캔버스 사이즈 변동 폭이 큰 경우”에만 재계산하거나(디바운스), 드래그가 끝난 뒤에만 정밀 재계산

> 과도한 최적화는 RU-003 범위를 넘길 수 있으니, “정책 고정 + 최소 안정장치” 수준을 권장합니다.

#### Step 4: disabled(스트리밍) 플래그의 SSOT 고정

RU-003-Q4의 worldStore 또는 RU-003-Q3의 Turn Runner가 들어오면, `disabled` 판단은 다음처럼 한 곳에서 결정되게 고정합니다.

- `isStreaming`은 `agentStore`(또는 Turn Runner)에서만 SSOT로 제공
- 패널들은 `disabled` prop 또는 selector를 통해 동일 플래그를 공유

---

## 📈 기대 효과

- ✅ DnD/핫스팟 상호작용의 “무반응/혼란” 감소
- ✅ 이후 확장(Quest/Rule/Scanner) 시에도 인터랙션 정책이 흔들리지 않음

---

## ⚠️ 주의사항 및 고려사항

- 겹치는 핫스팟 문제는 UI/데이터 설계의 교차 영역입니다. RU-003에서는 “정책 고정”을 우선하고, 정교한 충돌 판정 커스터마이즈는 후순위로 미루는 것이 안전합니다.

---

## 🧪 검증 방법 (수동 검증 중심)

1. 여러 핫스팟이 서로 겹치는 상태에서 드래그/드롭을 반복해 대상이 일관되게 선택되는지 확인
2. 창 크기를 바꾸며(ResizeObserver 작동) 드래그/드롭이 심하게 흔들리지 않는지 확인
3. 스트리밍 중에는 드롭/클릭이 확실히 차단되는지 확인(어느 패널도 예외 없이)

---

## 🔧 실행 가이드

1. “인터랙션 가능 조건”을 코드/주석으로 명시(SSOT)
2. 핫스팟 렌더/드롭 허용 조건을 Option A/B 중 택1로 고정
3. RU-003-S3 수동 시나리오 수행

---

## 📚 참고 자료

- `vibe/unit-results/U-010[Mvp].md`, `vibe/unit-results/U-011[Mvp].md`, `vibe/unit-results/U-012[Mvp].md`
- `frontend/src/components/SceneCanvas.tsx` (ResizeObserver + droppable)
- `.cursor/rules/10-frontend-game-ui.mdc` (DnD/핫스팟 UX 규칙)

---

## 🏷️ 태그

`#refactoring` `#edge-cases` `#medium` `#dnd-kit` `#hotspot`

