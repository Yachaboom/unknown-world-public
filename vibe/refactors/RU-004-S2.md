# [ID: RU-004-S2] 엣지 케이스: Continue/Reset에서 profileId·저장 키·스토어 상태 드리프트(데모 반복성 붕괴)

## 📌 기본 정보

| 항목               | 내용                                                                                          |
| ------------------ | --------------------------------------------------------------------------------------------- |
| **ID**             | RU-004-S2                                                                                     |
| **심각도**         | High                                                                                          |
| **카테고리**       | 엣지 케이스 (Edge Cases)                                                                      |
| **영향 범위**      | `frontend/src/App.tsx`, `frontend/src/save/saveGame.ts`, `frontend/src/data/demoProfiles.ts`, (관련 store) `actionDeckStore`, `agentStore`, `economyStore`, `worldStore`, `inventoryStore` |
| **예상 작업 시간** | 30~75분                                                                                       |

---

## 🔍 문제점 상세 분석

### 현재 상황

U-015의 데모 플로우는 정상 경로에서는 잘 동작하지만, 다음과 같은 “현실적인 사용자/브라우저 상태”에서 **게임이 playing 화면으로 진입한 뒤 리셋/저장이 불가능해지거나, 이전 세션 UI가 남는** 문제가 발생할 수 있습니다.

#### (1) `hasSaveGame()`이 “유효한 세이브”를 의미하지 않음 → Continue 버튼/초기 진입이 잘못될 수 있음

- `hasSaveGame()`은 localStorage에 키가 존재하는지만 확인합니다.
- 반면 `loadSaveGame()`은 JSON 파싱 + Zod 스키마 검증 실패 시 null을 반환합니다.

즉,

- localStorage에 **깨진 JSON / 구버전 필드 / strict 불일치**가 남아 있으면
  - `hasSaveGame() === true` (Continue 노출)
  - `loadSaveGame() === null` (복원 불가)

이때 UI는 “Continue가 보이는데 눌러도 아무 변화 없음” 또는 “초기 진입이 playing인데 상태는 비어있음”으로 보일 수 있습니다.

#### (2) profileId SSOT가 이중화되어 드리프트 가능 (CURRENT_PROFILE_KEY vs SaveGame.profileId)

현재 “현재 프로필”은 두 경로에 존재합니다.

- `localStorage: unknown_world_current_profile` (`CURRENT_PROFILE_KEY`)
- `SaveGame.profileId` (SaveGame 안에 포함)

드리프트가 발생하는 예:

- 사용자가 개발자 도구로 `unknown_world_current_profile`만 삭제했는데 `unknown_world_savegame`은 남아있는 경우
  - Profile Select 화면에서 Continue가 노출되며 복원은 가능할 수 있으나,
  - App의 `currentProfileId`가 null로 남아:
    - **Reset이 동작하지 않음** (`handleReset`이 profileId를 찾지 못함)
    - **자동 저장이 동작하지 않음** (`saveCurrentState`가 currentProfileId 없으면 return)

#### (3) 프로필 선택/복원/리셋 시 Action Deck/Agent Console이 “이전 세션 상태”를 유지할 수 있음

U-015의 초기화는 world/inventory/economy를 주로 리셋하지만, 다음 store는 명시적으로 초기화되지 않습니다.

- `actionDeckStore` (이전 턴의 카드가 남아 있으면, 새 세션 시작 직후 Action Deck이 **이전 카드**를 노출할 수 있음)
- `agentStore` (이전 에러/배지/단계 상태가 남아 있으면, 새 세션에서 “이미 실패한 것처럼” 보일 수 있음)

이는 “데모 반복성” 관점에서 치명적입니다(Reset 직후 화면이 이상해 보임).

#### (4) SaveGame 버전 마이그레이션 훅이 존재하지만 실제 로드 경로에서 사용되지 않음

`save/saveGame.ts`에 `migrateSaveGame()`이 존재하지만 `loadSaveGame()`은 이를 호출하지 않습니다.  
결과적으로 “버전 불일치 → null”로 귀결되며, (1)의 `hasSaveGame` 문제와 결합하면 UX가 더 악화됩니다.

### 문제가 되는 이유

1. **PRD 6.9(데모 프로필/즉시 리셋) 위반 체감**: Reset/Continue가 1번이라도 삐끗하면 데모는 즉시 무너집니다.
2. **상태 기반 시스템 신뢰도 하락**: “저장 있음 → Continue → 복원 실패/리셋 불가/이전 UI 잔존”은 심사자에게 시스템 일관성 결함으로 보입니다.
3. **이후 유닛(U-025 엔딩 리포트/U-026 리플레이) 확장 리스크**: profile/seed/version이 흔들리면 아티팩트 기반 기능이 불안정해집니다.

### 영향받는 코드 위치

- `frontend/src/App.tsx`
  - 초기 phase 결정이 `loadCurrentProfileId() && hasSaveGame()`에 의존
  - Continue 핸들러가 `currentProfileId`를 갱신하지 않음(저장/리셋 경로와 충돌 가능)
  - 프로필 선택/복원 시 하위 스토어 초기화 범위가 불완전할 수 있음
- `frontend/src/save/saveGame.ts`
  - `hasSaveGame()`은 키 존재만 확인
  - `migrateSaveGame()`은 있으나 로드 경로에서 미사용

---

## 💡 개선 방안

### 제안하는 접근법

“데모 반복성”을 최우선으로 다음 원칙을 고정합니다.

1. **유효한 SaveGame만 ‘세이브가 있다’로 취급**한다 (`hasSaveGame` → `getValidSaveGame()` 형태로 대체)
2. **profileId SSOT는 1곳으로 고정**한다  
   - 권장: `SaveGame.profileId`를 SSOT로 두고, `CURRENT_PROFILE_KEY`는 제거하거나 캐시(derived)로만 사용
3. **세션 초기화/복원/리셋 시 초기화 대상 store를 명시적으로 표준화**한다  
   - world/inventory/economy/actionDeck/agent를 “세션 경계”로 묶어 초기화
4. **로드 시 migrate를 적용**하고, 실패 시 “명시적 클린업 + profile_select로 폴백”한다

### 구체적 실행 단계

#### Step 1: “유효한 세이브 여부” API로 전환

- `hasSaveGame()` 대신 다음 형태를 도입합니다.
  - `loadSaveGame()` → `loadAndMigrateSaveGame()` (migrate 포함)
  - `getValidSaveGameOrNull()` (검증/마이그레이션 실패 시 null)

**변경 전(문제):**

```ts
hasSaveGame() ? onContinue : undefined
```

**변경 후(권장 개념):**

```ts
const saved = getValidSaveGameOrNull();
const hasSavedGame = saved !== null;
```

#### Step 2: Continue 성공 시 `currentProfileId`를 SaveGame으로부터 확정

- Continue는 “프로필 키”가 아니라 “SaveGame.profileId”로 세션을 확정해야 합니다.
- SaveGame.profileId가 null이면, Continue를 제공하지 않거나 profile_select로 폴백합니다.

#### Step 3: 세션 초기화 표준(Reset/Select/Restore)에서 store 초기화 범위를 확정

권장 세션 경계 store:

- `worldStore.reset()`
- `inventoryStore.reset()` 또는 `setItems(...)`
- `economyStore.reset()` + (S1) hydrate/재계산
- `actionDeckStore.reset()` (또는 기본 카드로 표시되게 cards 비움)
- `agentStore.reset()` (배지/에러/phase 초기화)

> 핵심은 “프로필 시작 직후(턴 0)”에도 UI가 이전 세션의 잔재를 보여주지 않는 것입니다.

#### Step 4: 로드 실패(검증/마이그레이션 실패) 시 클린업 정책 고정

- 저장된 데이터가 유효하지 않으면 다음을 수행:
  - `clearSaveGame()` + (있다면) `clearCurrentProfileId()`
  - `gamePhase`를 `profile_select`로 이동
  - “세이브가 손상되어 새로 시작한다”는 시스템 내러티브 또는 UI 안내(채팅 버블 금지, 게임 HUD/랜딩에서 안내)

### 대안적 접근법 (선택사항)

- **대안 1(유지보수 우선)**: `CURRENT_PROFILE_KEY`를 완전히 제거하고, SaveGame만 SSOT로 사용  
  - 장점: 드리프트 클래스 자체가 사라짐
  - 단점: “프로필만 저장해두고 세이브는 없는” 같은 조합 UX를 지원하려면 추가 설계 필요
- **대안 2(빠른 패치)**: CURRENT_PROFILE_KEY는 유지하되, Continue 성공 시 항상 `setCurrentProfileId(saveGame.profileId)` + `saveCurrentProfileId(profileId)`로 복구  
  - 장점: 변경 범위 최소
  - 단점: 이중 SSOT 유지로 드리프트 리스크가 남음

---

## 📈 기대 효과

### 즉각적 효과

- ✅ Continue 버튼이 “정말로 복원 가능한 경우에만” 노출되어 데모 UX가 안정화
- ✅ profileId 드리프트로 인해 Reset/Autosave가 죽는 케이스 제거
- ✅ Reset/프로필 변경 직후 Action Deck/Agent Console 잔재가 남지 않아 “데모 반복성” 강화

### 장기적 효과

- 🎯 SaveGame/version/seed/profile 경계가 단단해져 U-025/U-026에서 아티팩트 기반 확장이 쉬워짐

---

## ⚠️ 주의사항 및 고려사항

### 리팩토링 시 주의할 점

1. UI는 반드시 게임 UI 형태를 유지(RULE-002). 복원 실패 안내도 채팅 버블 형태로 추가하지 않습니다.
2. “유효하지 않은 세이브”를 발견했을 때 자동 삭제하는 정책은 사용자를 놀라게 할 수 있으므로, 최소한 랜딩 화면에서 명시적 안내를 권장합니다(데모 환경 기준).
3. store reset 범위를 늘리면 “보이던 카드/배지”가 사라지지만, 이는 Reset/프로필 변경 UX에서는 오히려 기대 동작입니다.

### 호환성 체크리스트

- [ ] SaveGame이 깨져 있으면 Continue가 숨겨지거나, 눌러도 profile_select로 안전 폴백되는가?
- [ ] Continue 성공 후 Reset/Autosave가 항상 동작하는가?
- [ ] Reset/프로필 변경 직후 Action Deck/Agent Console 잔재가 없는가?

---

## 🧪 검증 방법 (수동 검증 중심)

#### 시나리오 1: profileId 키 드리프트 복구

- **실행 방법**
  - 세이브가 있는 상태에서 `unknown_world_current_profile`만 삭제(개발자 도구 localStorage)
  - 앱 새로고침 → Continue
- **기대 결과**
  - ✅ Continue 후 Reset이 정상 동작
  - ✅ Autosave가 계속 동작(턴 진행 후 새로고침 시 복원 가능)

#### 시나리오 2: 손상된 세이브 처리

- **실행 방법**
  - `unknown_world_savegame`에 깨진 JSON 또는 스키마 불일치 데이터를 저장
  - 앱 새로고침
- **기대 결과**
  - ✅ profile_select로 진입(playing으로 잘못 진입하지 않음)
  - ✅ Continue 버튼이 숨겨지거나, 클릭 시 안전 폴백

#### 시나리오 3: Reset 후 UI 잔재 없음

- **실행 방법**
  - 몇 턴 진행하여 Action Deck 카드가 서버/Mock 카드로 바뀐 상태에서 Reset 실행
- **기대 결과**
  - ✅ Reset 직후 Action Deck이 초기 상태(기본 카드 or 빈 상태)로 정상화
  - ✅ Agent Console이 초기 상태로 돌아감

---

## 🔧 실행 가이드

### 개발자를 위한 실행 지침

1. **준비 사항**
   - 관련 파일: `App.tsx`, `saveGame.ts`, (권장) 세션 초기화 유틸 모듈(RU-004-Q4)
2. **실행 절차**
   - “유효 SaveGame만 Continue” 정책 도입
   - Continue 성공 시 profileId 확정/저장 정책 고정
   - 세션 초기화(store reset) 범위 표준화
   - 로드 실패 시 클린업 + profile_select 폴백
3. **검증 절차**
   - 위 시나리오 1~3 수행

---

## 📚 참고 자료

- `vibe/prd.md` 6.6(세이브/로드), 6.9(데모 프로필/리셋)
- `vibe/unit-results/U-015[Mvp].md`
- `frontend/src/App.tsx`
- `frontend/src/save/saveGame.ts`
- `.cursor/rules/00-core-critical.mdc` (RULE-002/006/010)

---

## 🏷️ 태그

`#refactoring` `#stability` `#edge-cases` `#high` `#savegame` `#demo-profiles`

---

## 📝 노트

- 이 제안은 “지금은 잘 되는데 가끔 깨지는” 류의 데모 리스크를 제거하는 것이 목적입니다. 특히 localStorage는 외부 요인(시크릿 모드, 브라우저 정책, 개발자 도구 수정)으로 쉽게 비정상 상태가 되므로, **유효성 기반으로 부팅/Continue를 설계**하는 것이 안전합니다.

