# [ID: RU-005-Q1] ì½”ë“œ ì¤‘ë³µ: fallback/phase/repair ë¡œì§ì˜ ì¤‘ë³µ ì œê±°ë¡œ ë“œë¦¬í”„íŠ¸ ë°©ì§€

## ğŸ“Œ ê¸°ë³¸ ì •ë³´

| í•­ëª©               | ë‚´ìš©                                                                                                  |
| ------------------ | ----------------------------------------------------------------------------------------------------- |
| **ID**             | RU-005-Q1                                                                                             |
| **ì‹¬ê°ë„**         | Medium                                                                                                |
| **ì¹´í…Œê³ ë¦¬**       | ì½”ë“œ ì¤‘ë³µ (Duplication)                                                                               |
| **ì˜í–¥ ë²”ìœ„**      | `backend/src/unknown_world/api/turn.py`, `backend/src/unknown_world/orchestrator/fallback.py`, `backend/src/unknown_world/orchestrator/repair_loop.py`, `backend/src/unknown_world/orchestrator/generate_turn_output.py`, `backend/src/unknown_world/orchestrator/mock.py` |
| **ì˜ˆìƒ ì‘ì—… ì‹œê°„** | 30~75ë¶„                                                                                               |

---

## ğŸ” ë¬¸ì œì  ìƒì„¸ ë¶„ì„

### í˜„ì¬ ìƒí™©

ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° ì˜ì—­ì—ì„œ â€œê°™ì€ ëª©ì ì˜ ë¡œì§â€ì´ ì—¬ëŸ¬ ê³³ì— ì¡´ì¬í•©ë‹ˆë‹¤.

1) **Safe Fallback ìƒì„± ë¡œì§ ì¤‘ë³µ**

- SSOT í›„ë³´: `backend/src/unknown_world/orchestrator/fallback.py:create_safe_fallback`
- ì¤‘ë³µ/ìœ ì‚¬ êµ¬í˜„:
  - `backend/src/unknown_world/orchestrator/generate_turn_output.py:TurnOutputGenerator.create_safe_fallback`
  - `backend/src/unknown_world/orchestrator/mock.py:MockOrchestrator.create_safe_fallback`

2) **Repair loop(ì¬ì‹œë„) ë¡œì§ ì¤‘ë³µ**

- SSOT í›„ë³´: `backend/src/unknown_world/orchestrator/repair_loop.py:run_repair_loop` (U-018)
- ì¤‘ë³µ/ìœ ì‚¬ êµ¬í˜„:
  - `backend/src/unknown_world/api/turn.py`ì˜ mock ê²½ë¡œ ë‚´ë¶€ while ë£¨í”„(ValidationError + business_rules + fallback ì²˜ë¦¬)

3) **ë‹¨ê³„(phase) ëª©ë¡ ì •ì˜ ì¤‘ë³µ**

- `backend/src/unknown_world/models/turn.py:AgentPhase`ëŠ” SSOT enumì´ì§€ë§Œ,
- ë¦¬ìŠ¤íŠ¸/ìˆœì„œëŠ” ì—¬ëŸ¬ ê³³ì— ë¶„ì‚°:
  - `api/turn.py:ORCHESTRATOR_PHASES`
  - `mock.py:MockOrchestrator.PHASES`

### ë¬¸ì œê°€ ë˜ëŠ” ì´ìœ 

1. **ë“œë¦¬í”„íŠ¸ê°€ â€œìì—°ìŠ¤ëŸ½ê²Œâ€ ë°œìƒ**: ì¤‘ë³µëœ fallback/repair/phaseê°€ í•œ ê³³ë§Œ ìˆ˜ì •ë˜ë©´, mock/real í˜¹ì€ generator/mock ê°„ì˜ ë™ì‘ì´ í‹€ì–´ì§‘ë‹ˆë‹¤.
2. **ë¦¬íŒ©í† ë§ ë‚œì´ë„ ì¦ê°€**: RU-005ì˜ ëª©í‘œ(ë‹¨ê³„ ê¸°ë°˜ pipeline)ë¡œ ì •ë¦¬í•˜ë ¤ë©´ â€œì–´ë””ê°€ SSOTì¸ì§€â€ ë¨¼ì € ê³ ì •ë¼ì•¼ í•©ë‹ˆë‹¤.
3. **ê´€ì¸¡(ë°°ì§€/ë‹¨ê³„) ì‹ ë¢°ë„ ì €í•˜**: ì¤‘ë³µ ê²½ë¡œê°€ ì„œë¡œ ë‹¤ë¥¸ ë°°ì§€/í´ë°± UIë¥¼ ë§Œë“¤ë©´ Agent Consoleì´ â€œì¦ê±°â€ë¡œì„œ ì•½í•´ì§‘ë‹ˆë‹¤(RULE-008).

### ì˜í–¥ë°›ëŠ” ì½”ë“œ ìœ„ì¹˜

- `backend/src/unknown_world/orchestrator/fallback.py`
- `backend/src/unknown_world/orchestrator/generate_turn_output.py` (fallback ìœ ì‚¬ í•¨ìˆ˜)
- `backend/src/unknown_world/orchestrator/mock.py` (fallback ìœ ì‚¬ í•¨ìˆ˜, phases ë¦¬ìŠ¤íŠ¸)
- `backend/src/unknown_world/api/turn.py` (mock ì „ìš© repair loop)

---

## ğŸ’¡ ê°œì„  ë°©ì•ˆ

### ì œì•ˆí•˜ëŠ” ì ‘ê·¼ë²•

ì¤‘ë³µ ì œê±°ì˜ ì›ì¹™ì€ ë‹¨ìˆœí•©ë‹ˆë‹¤.

- **fallback SSOTëŠ” `orchestrator/fallback.py`ë¡œ ê³ ì •**í•˜ê³ , ë‹¤ë¥¸ fallback ìœ ì‚¬ êµ¬í˜„ì€ ì œê±°/ìœ„ì„
- **repair SSOTëŠ” `orchestrator/repair_loop.py`ë¡œ ê³ ì •**í•˜ê³ , mockë„ ë™ì¼í•œ ë£¨í”„ë¥¼ ì¬ì‚¬ìš©(ë˜ëŠ” â€œmock providerâ€ë¥¼ ì£¼ì…í•´ ê°™ì€ ë£¨í”„ ì‚¬ìš©)
- **phase ìˆœì„œ SSOTë¥¼ í•œ ê³³ìœ¼ë¡œ ì´ë™**í•´ API/Mockì´ ë™ì¼í•œ ë¦¬ìŠ¤íŠ¸ë¥¼ ì°¸ì¡°

### êµ¬ì²´ì  ì‹¤í–‰ ë‹¨ê³„

#### Step 1: fallback SSOT ë‹¨ì¼í™”

- `TurnOutputGenerator.create_safe_fallback`ëŠ” ì‚¬ìš©ì²˜ê°€ ì—†ë‹¤ë©´ ì œê±°(ë˜ëŠ” ë‚´ë¶€ì—ì„œ `fallback.create_safe_fallback` í˜¸ì¶œë¡œ ìœ„ì„)
- `MockOrchestrator.create_safe_fallback`ë„ ë™ì¼í•˜ê²Œ ì œê±°/ìœ„ì„

ëª©í‘œ: â€œí´ë°±ì˜ UI ìµœì†Œ êµ¬ì„±/ë°°ì§€/ì¬í™” ë³´ì¡´â€ ì •ì±…ì´ 1ê³³ì—ì„œë§Œ ê´€ë¦¬ë˜ê²Œ í•˜ê¸°.

#### Step 2: mock ê²½ë¡œì˜ repair loop ì¤‘ë³µ ì œê±°

`api/turn.py`ì˜ mock ê²½ë¡œê°€ ê°–ê³  ìˆëŠ” while ë£¨í”„ë¥¼ ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¡œ ì •ë¦¬í•©ë‹ˆë‹¤.

- **ê¶Œì¥**: `run_repair_loop(turn_input, force_mock=True)`ë¥¼ ì¬ì‚¬ìš©í•˜ê³ , mock providerëŠ” `get_genai_client(force_mock=True)`ë¡œ ì´ë¯¸ ì§€ì›ë˜ëŠ” êµ¬ì¡°ë¡œ ìˆ˜ë ´
- **ëŒ€ì•ˆ**: `run_repair_loop`ì— â€œìƒì„± í•¨ìˆ˜(provider) ì£¼ì…â€ì„ í—ˆìš©í•´, realì€ Gemini generator, mockì€ `MockOrchestrator.generate_turn_output`ì„ ì‚¬ìš©

#### Step 3: phase ë¦¬ìŠ¤íŠ¸ SSOT ê³ ì •

- `AgentPhase` enumì€ ê·¸ëŒ€ë¡œ ë‘ë˜,
- **ë‹¨ê³„ ì‹¤í–‰ ìˆœì„œ(list)**ë¥¼ `orchestrator/pipeline.py` ë˜ëŠ” `orchestrator/stages/__init__.py` ê°™ì€ ê³³ì— ê³ ì •í•˜ê³  API/Mockì´ ì¬ì‚¬ìš©

---

## ğŸ“ˆ ê¸°ëŒ€ íš¨ê³¼

### ì¦‰ê°ì  íš¨ê³¼

- âœ… mock/real ê²½ë¡œì˜ ë“œë¦¬í”„íŠ¸ ìœ„í—˜ ê°ì†Œ(ë™ì‘/í´ë°±/ë°°ì§€ ì •ì±…ì´ í•œ ê³³ìœ¼ë¡œ ëª¨ì„)
- âœ… RU-005 pipeline ë¦¬íŒ©í† ë§ì´ ì‰¬ì›Œì§(SSOT ê²½ê³„ê°€ ëª…í™•)

### ì¥ê¸°ì  íš¨ê³¼

- ğŸ¯ í›„ì† ìœ ë‹›ì—ì„œ stageê°€ ëŠ˜ì–´ë‚˜ë„ â€œë‹¨ê³„ ë¦¬ìŠ¤íŠ¸/í´ë°± ì •ì±…/ë³µêµ¬ ì •ì±…â€ì´ í•œ ê³³ì— ìˆì–´ ìœ ì§€ë³´ìˆ˜ ë¹„ìš©ì´ ë‚®ì•„ì§

---

## âš ï¸ ì£¼ì˜ì‚¬í•­ ë° ê³ ë ¤ì‚¬í•­

### ë¦¬íŒ©í† ë§ ì‹œ ì£¼ì˜í•  ì 

1. â€œì¤‘ë³µ ì œê±°â€ëŠ” ì‘ì€ ë³€ê²½ ê°™ì§€ë§Œ, ì‹¤ì œë¡œëŠ” fallback UI/ë°°ì§€/repair_count ê°™ì€ ì‚¬ìš©ì ë…¸ì¶œ ê²°ê³¼ê°€ ë°”ë€” ìˆ˜ ìˆìŠµë‹ˆë‹¤. (â†’ `RU-005-S3`ë¡œ íšŒê·€ í™•ì¸)
2. ì œê±°ê°€ ë¶€ë‹´ìŠ¤ëŸ¬ìš°ë©´, ë¨¼ì € â€œìœ„ì„â€ìœ¼ë¡œ ì‹œì‘í•´ ì½”ë“œ ì¤‘ë³µì„ 0ì— ê°€ê¹ê²Œ ë§Œë“  ë’¤ ì •ë¦¬í•©ë‹ˆë‹¤.

### í˜¸í™˜ì„± ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] mock/real ëª¨ë‘ ë™ì¼í•œ fallback ì •ì±…(ì¬í™” ë³´ì¡´/ì•¡ì…˜ ì¹´ë“œ ëŒ€ì•ˆ/ë°°ì§€)ì„ ë”°ë¥´ëŠ”ê°€?
- [ ] repair ì‹œë„ íšŸìˆ˜/í‘œê¸°ê°€ ëª¨ë“œ ê°„ ë™ì¼ ì˜ë¯¸ë¥¼ ê°€ì§€ëŠ”ê°€?
- [ ] phase ìˆœì„œê°€ í•œ ê³³ì—ì„œë§Œ ì •ì˜ë˜ëŠ”ê°€?

---

## ğŸ§ª ê²€ì¦ ë°©ë²• (ìˆ˜ë™ ê²€ì¦ ì¤‘ì‹¬)

> `RU-005-S3.md` ì°¸ê³ .  
ì¤‘ë³µ ì œê±° í›„ì—ëŠ” íŠ¹íˆ â€œí´ë°± ê²°ê³¼ê°€ ë‹¬ë¼ì§€ì§€ ì•ŠëŠ”ì§€â€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.

---

## ğŸ”§ ì‹¤í–‰ ê°€ì´ë“œ

### ê°œë°œìë¥¼ ìœ„í•œ ì‹¤í–‰ ì§€ì¹¨

1. **ì¤€ë¹„ ì‚¬í•­**
   - â€œfallback ìƒì„± í•¨ìˆ˜â€ì™€ â€œrepair loopâ€ì˜ ì‹¤ì œ í˜¸ì¶œ ê·¸ë˜í”„ë¥¼ ê°„ë‹¨íˆ ê·¸ë ¤ SSOT í›„ë³´ë¥¼ í™•ì •
2. **ì‹¤í–‰ ì ˆì°¨**
   - (1) fallback ìœ„ì„ â†’ (2) mock repair loop ì¬ì‚¬ìš© â†’ (3) phase ë¦¬ìŠ¤íŠ¸ SSOT ì´ë™ ìˆœìœ¼ë¡œ ë‹¨ê³„í™”
3. **ê²€ì¦ ì ˆì°¨**
   - í´ë°±/ì •ìƒ ì¼€ì´ìŠ¤ë¥¼ ê°ê° 1íšŒ ì´ìƒ ìˆ˜ë™ ì¬í˜„(`RU-005-S3`)
4. **ë¡¤ë°± ê³„íš**
   - ìœ„ì„ ë‹¨ê³„(ì‚­ì œ ì „)ì—ì„œ ë¬¸ì œê°€ ìƒê¸°ë©´ ì¦‰ì‹œ ì›ë³µ ê°€ëŠ¥í•˜ë„ë¡ â€œì‚­ì œëŠ” ë§ˆì§€ë§‰â€ì— ìˆ˜í–‰

---

## ğŸ“š ì°¸ê³  ìë£Œ

- `backend/src/unknown_world/orchestrator/fallback.py`
- `backend/src/unknown_world/orchestrator/repair_loop.py`
- `backend/src/unknown_world/api/turn.py`
- `backend/src/unknown_world/orchestrator/mock.py`

---

## ğŸ·ï¸ íƒœê·¸

`#refactoring` `#duplication` `#medium` `#orchestrator` `#fallback` `#repair-loop`

