# [ID: RU-002-S3] RU-002 리팩토링 이후 “스트리밍/검증/폴백/용어 통일” 수동 검증 시나리오 패키지(데모 체감 중심)

## 📌 기본 정보

| 항목               | 내용                           |
| ------------------ | ------------------------------ |
| **ID**             | RU-002-S3                      |
| **심각도**         | Medium                         |
| **카테고리**       | 수동 검증 시나리오 (Manual Verification) |
| **영향 범위**      | (가이드) `vibe/unit-runbooks/U-007-mock-orchestrator-runbook.md`, `vibe/unit-runbooks/U-008-http-streaming-client-runbook.md`, RU-002 리팩토링 적용 파일 전반 |
| **예상 작업 시간** | 20~40분                        |

---

## 🔍 문제점 상세 분석

### 현재 상황

U-007/U-008 런북은 각각의 유닛 요구사항을 검증하는 데는 충분하지만, RU-002의 목표인:

- 이벤트 타입/용어 통일,
- 실패 시 폴백으로 “정상 종료”,
- Agent Console 관측 UX의 일관성,

을 한 번에 확인하는 **통합 시나리오**는 별도로 정리되어 있지 않습니다.

### 문제가 되는 이유

1. 리팩토링은 “작은 변경이 큰 회귀”를 만들 수 있는데, 통합 시나리오가 없으면 데모 직전에 깨짐을 발견할 수 있습니다.  
2. RU-002는 PRD 하드 게이트(검증/복구/관측)와 직결되므로, “수동 검증 체크리스트”가 사실상 품질 게이트 역할을 합니다.

---

## 💡 개선 방안

### 제안하는 접근법

RU-002 전용 “수동 검증 패키지”를 정의합니다.

- 기존 런북(U-007/U-008)을 **참조**하되,
- RU-002에서 바뀌는 포인트(종료 규칙, 폴백, 프로토콜 버전/alias, 용어) 중심으로 **최소 6개 시나리오**만 고정합니다.

### 구체적 실행 단계

#### Step 1: 통합 검증 체크리스트(시나리오 1~6) 수행

아래 시나리오를 순서대로 수행하고, “기대 결과”를 만족하면 RU-002를 통과로 판단합니다.

#### Step 2: 런북 문서에 링크 추가(선택)

- U-007/U-008 runbook 말미에 “RU-002 통합 검증: vibe/refactors/RU-002-S3.md 참조” 링크를 추가하면 재사용성이 좋아집니다.

---

## 🧪 검증 방법 (수동 검증 중심)

## 시나리오 1: 정상 스트리밍(기본 턴)

- **목적**: 이벤트 시퀀스/Agent Console/최종 TurnOutput 반영이 정상인지 확인
- **실행 방법**: U-007 runbook 시나리오 A + U-008 runbook 시나리오 A/B
- **기대 결과**:
  - ✅ Queue 단계가 Parse→Commit 순서로 진행
  - ✅ Badges가 4종(Schema/Economy/Safety/Consistency)로 표시
  - ✅ final TurnOutput 적용 후 내러티브/액션 덱/경제 HUD가 갱신

## 시나리오 2: 입력 검증 실패(잘못된 payload)

- **목적**: 입력 검증 실패도 “안전 종료(폴백 final)”로 처리되는지 확인(RU-002-S1 권장)
- **실행 방법**: U-007 runbook 시나리오 D에 준해 잘못된 payload 전송
- **기대 결과**:
  - ✅ error(선택) 표시
  - ✅ final(폴백 TurnOutput)로 종료
  - ✅ 프론트 UI가 멈추지 않고 IDLE로 복귀

## 시나리오 3: 서버 내부 예외(강제 실패)

- **목적**: 서버 내부 오류에서도 “final(폴백)로 종료”되는지 확인
- **실행 방법**: 개발자 로컬에서 예외를 강제로 발생시키는 임시 훅으로 확인
- **기대 결과**:
  - ✅ error 표시(프롬프트/내부추론 노출 없음)
  - ✅ final 폴백 도착

## 시나리오 4: 네트워크 실패(백엔드 OFFLINE)

- **목적**: 프론트가 네트워크 실패를 감지하고 UI가 멈추지 않는지 확인
- **실행 방법**: U-008 runbook 시나리오 E
- **기대 결과**:
  - ✅ Agent Console에 에러 표시
  - ✅ 입력/카드가 영구 disable 되지 않고 복구 가능
  - ✅ 연결 상태가 OFFLINE로 표시

## 시나리오 5: 프로토콜 alias/버전(선택)

- **목적**: PRD 정합성/전방 호환을 위해 alias(`final.data`/`final.turn_output`, `complete`/`ok`)가 안전한지 확인
- **실행 방법**: 서버가 임시로 다른 키/값을 송출하도록 변경(개발자용)
- **기대 결과**:
  - ✅ 클라가 정상 처리 또는 “무시 + 경고(관측)”로 안전하게 동작

## 시나리오 6: Economy 폴백 정책(잔액 왜곡 방지)

- **목적**: 폴백 발생 시에도 economy.balance_after가 합리적으로 유지되는지 확인(RULE-005)
- **실행 방법**: 시나리오 2 또는 4에서 폴백/에러를 발생시키고 HUD 확인
- **기대 결과**:
  - ✅ 잔액이 갑자기 0/0 또는 기본값으로 덮어써지지 않음(권장: 요청 직전 스냅샷 유지)

---

## 📈 기대 효과

### 즉각적 효과

- ✅ 리팩토링 직후 “데모 체감 품질”을 빠르게 확인 가능
- ✅ RU-002의 완료 기준을 체크리스트로 고정(팀 합의 비용↓)

### 장기적 효과

- 🎯 향후 실모델/리페어 루프 확장 시에도 회귀 포인트가 명확

---

## ⚠️ 주의사항 및 고려사항

### 리팩토링 시 주의할 점

1. 이 문서는 “자동화 테스트 제안”이 아니라, **데모/플레이어 관점의 수동 검증 절차**입니다.  
2. 시나리오 3/5는 개발자용(임시 훅)이며, 배포/데모 빌드에는 포함하지 않는 것을 권장합니다.

---

## 🔧 실행 가이드

### 개발자를 위한 실행 지침

1. **준비 사항**
   - 백엔드/프론트 실행은 각 런북(U-007/U-008)의 Quick Start를 따른다.
2. **실행 절차**
   - 시나리오 1~6을 순서대로 수행
3. **검증 절차**
   - 각 시나리오의 “기대 결과” 체크박스를 팀이 함께 확인

---

## 📚 참고 자료

- `vibe/unit-runbooks/U-007-mock-orchestrator-runbook.md`
- `vibe/unit-runbooks/U-008-http-streaming-client-runbook.md`
- `vibe/prd.md` 6.8/8.4.3/10장
- `.cursor/rules/00-core-critical.mdc` (RULE-004/005/008)

---

## 🏷️ 태그

`#refactoring` `#manual-verification` `#medium` `#runbook` `#streaming`

---

## 📝 노트

- RU-002가 목표로 하는 “validation/폴백/이벤트 타입 통일”은 코드만 바꿔서는 완성되지 않고, **사용자 눈에 보이는 ‘멈춤/깨짐’이 없어야** 완료로 판단할 수 있습니다.


