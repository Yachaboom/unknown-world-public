# CP-MVP-05: 체크포인트 - 멀티모달 이미지 게이트(텍스트 우선/폴백/비용)

## 메타데이터

| 항목      | 내용             |
| --------- | ---------------- |
| Unit ID   | CP-MVP-05        |
| Phase     | MVP              |
| 예상 소요 | 60분             |
| 의존성    | U-035[Mvp],U-036[Mvp] |
| 우선순위  | ⚡ Critical      |

## 작업 목표

“텍스트 우선 + (조건부) 이미지 생성/편집” 파이프라인이 실제 UX에서 안정적으로 동작하는지 수동 검증하고, 실패 시에도 **폴백/복구**로 플레이가 이어지도록 보장한다.

**배경**: 멀티모달은 지연/비용/실패 확률이 높아, 검증 없이 기능을 누적하면 기술 부채(예외 처리 누락, UI 멈춤, 비용 폭증)가 빠르게 쌓인다. (PRD 6.3/10장, RULE-004/005)

**완료 기준**:

- 텍스트-only 경로에서 이미지가 없어도 UI/상태/배지가 정상 갱신된다(빈 화면/멈춤 금지).
- 이미지 생성이 트리거된 경우, UI는 **placeholder → 이미지(성공)** 또는 **placeholder → 텍스트 폴백(실패)** 로 안정적으로 전이한다. (RULE-004)
- 비용/지연이 통제된다: 행동 전 **예상 비용(최소/최대)** 가 노출되고, 부족 시 텍스트-only 등 대체 행동이 제안된다. (RULE-005)
- 프롬프트 파일(ko/en)이 분리/로드되며, 언어 혼합 출력이 발생하지 않는다. 프롬프트 원문/내부 추론은 노출되지 않는다. (RULE-006/008)
- 실시간 이미지 생성 결과에 대해 (조건부) rembg 배경 제거가 적용되거나, 실패해도 안전 폴백으로 종료된다. (U-035)
- 발견된 결함/임시 대응은 `vibe/debt-log.md`에 기록된다.

## 영향받는 파일

**생성**:

- `vibe/unit-runbooks/CP-MVP-05.md` - 멀티모달 검증 런북(시나리오/체크리스트)
- `vibe/unit-results/CP-MVP-05.md` - 실행 결과/관측값/증거(스크린샷/로그 요약)

**수정**:

- 없음(검증 단계)

**참조**:

- `vibe/prd.md` - 6.3(멀티모달), 8.5(이미지), 10장(Replay/게이트)
- `vibe/tech-stack.md` - 이미지 모델(`gemini-3-pro-image-preview`) 및 정책(FAST/QUALITY/REF)
- `.cursor/rules/00-core-critical.mdc` - RULE-004/005/006/008
- `.cursor/rules/10-frontend-game-ui.mdc` - placeholder/폴백/게임 UI 규칙

## 구현 흐름

### 1단계: 텍스트 우선 경로(이미지 미생성)

- 이미지 생성이 트리거되지 않는 턴을 1회 실행한다.
- `stage/badges/final`이 정상적으로 도착하고, UI가 자연스럽게 갱신되는지 확인한다.

### 2단계: 이미지 생성 경로(성공/실패/폴백)

- 이미지 생성이 트리거되는 턴을 1회 실행한다(정책/프롬프트/테스트 훅 등 팀 기준 방식 사용).
- 아래 전이를 확인한다:
  - 요청 중: placeholder가 표시되고 사용자는 “멈춤”이 아닌 “진행”으로 인식한다.
  - 성공: 이미지가 표시되고, overlay(핫스팟) 등 기존 UI 계약이 유지된다.
  - 실패: 안전한 텍스트 폴백으로 종료되며, UI/상태가 깨지지 않는다.

### 3단계: 비용/언어/보안 인바리언트 확인

- 예산 부족 케이스에서 “대체 행동 제안”이 동작하는지 확인한다.
- 언어 혼합 출력이 없는지 확인한다(ko-KR/en-US 고정).
- 프롬프트 원문/내부 추론이 UI/로그/콘솔에 노출되지 않는지 확인한다.
- 발견된 문제는 `vibe/debt-log.md`에 기록한다.

## 의존성 & 연결

**이전 작업에서 가져올 것**:

- **계획서**: [U-035[Mvp]](U-035[Mvp].md) - rembg 배경 제거 통합(조건부)
- **계획서**: [U-036[Mvp]](U-036[Mvp].md) - 프롬프트 파일 분리(ko/en) + 핫리로드
- **계획서**: [U-020[Mvp]](U-020[Mvp].md) - 프론트 이미지 Lazy Render/placeholder/폴백

**다음 작업에 전달할 것**:

- Scanner(업로드) 및 10분 데모 루프(CP-MVP-03)에서 사용할 “멀티모달 안정성 기준선”
- 멀티모달 관련 기술 부채 항목(debt-log)

## 주의사항

**기술적 고려사항**:

- 이미지 실패는 “에러”가 아니라 “정상 흐름”으로 취급하고, 반드시 폴백 UX를 유지한다. (RULE-004)
- 이미지 생성은 비용/지연이 크므로, Economy HUD의 “예상 비용” 노출이 사실상 UX의 일부다. (RULE-005)

**잠재적 리스크**:

- 이미지 경로의 예외 처리가 누락되면 최종 CP(10분 데모 루프)에서 회복 불가능한 회귀가 발생할 수 있음 → 이 CP에서 반드시 실패 케이스를 포함한다.

## 페어링 질문 (결정 필요)

- [ ] **Q1**: “이미지 생성 트리거”의 MVP 기준은 무엇으로 고정할까?
  - Option A: 특정 Action Deck 카드에만 `should_generate=true`를 허용(예측 가능, 권장)
  - Option B: 내러티브 키워드 기반 자동 트리거(몰입감↑, 비용/지연 변동↑)

## 참고 자료

- `vibe/prd.md` - 멀티모달(텍스트 우선 + Lazy 이미지), Economy UX
- `vibe/tech-stack.md` - 이미지 모델/티어링/정책
- `.cursor/rules/00-core-critical.mdc` - RULE-004/005/006/008
