# U-094[Mvp]: ImageUnderstanding 응답 파싱 예외 시 자동 재시도

## 메타데이터

| 항목      | 내용                                                  |
| --------- | ----------------------------------------------------- |
| Unit ID   | U-094[Mvp]                                            |
| Phase     | MVP                                                   |
| 예상 소요 | 30분                                                  |
| 의존성    | U-021[Mvp]                                            |
| 우선순위  | High (Scanner 안정성/UX 개선)                         |

## 작업 목표

Scanner(`POST /api/scan`)의 **이미지 이해(ImageUnderstanding) 응답 파싱 중 예외가 발생하면 자동으로 재시도**하여, 사용자에게 "분석 실패"가 노출되는 빈도를 줄인다. Structured Outputs 파싱 에러에 대한 Repair loop를 Scanner 파이프라인에도 적용한다.

**배경**: Gemini 비전 모델의 응답이 간헐적으로 JSON Schema를 벗어나거나, 부분적으로 깨진 JSON을 반환하여 파싱 예외가 발생한다. 현재는 파싱 실패 시 즉시 에러를 반환하지만, 재시도하면 대부분 성공한다. GM 턴 파이프라인에서는 이미 Repair loop(U-018)가 존재하지만, Scanner 엔드포인트에는 적용되지 않았다.

**완료 기준**:

- `POST /api/scan` 응답 파싱 실패 시 **최대 2회 자동 재시도** (총 3회 시도)
- 재시도 시 동일 이미지/프롬프트로 재요청
- 재시도 간 백오프(1초, 2초) 적용
- 모든 재시도 실패 시 **안전한 폴백 응답** 반환 (빈 아이템 목록 + 에러 메시지)
- 재시도 횟수가 로그에 기록됨 (관측 가능성)
- 성공 시 정상 아이템 반환 (기존 동작 유지)

## 영향받는 파일

**수정**:

- `backend/src/unknown_world/api/scan.py` (또는 해당 엔드포인트) - 파싱 예외 시 재시도 로직 추가
- `backend/src/unknown_world/services/image_understanding.py` (또는 해당 서비스) - 응답 파싱 + 재시도 래퍼

**참조**:

- `vibe/unit-results/U-021[Mvp].md` - 이미지 이해 엔드포인트 구현
- `vibe/unit-results/U-018[Mvp].md` - Repair loop 패턴 참조
- `vibe/prd.md` - 8.6(이미지 이해), 8.4(구조화 출력/검증/복구)

## 구현 흐름

### 1단계: 파싱 예외 분류

- 재시도 대상 예외: `json.JSONDecodeError`, `pydantic.ValidationError`, 부분 JSON, 빈 응답
- 재시도 제외 예외: API 인증 실패(401), quota 초과(429), 안전 차단(safety block)

### 2단계: 재시도 래퍼 구현

- `image_understanding.py`(또는 scan 서비스)에 재시도 데코레이터/유틸 추가:
  - 최대 재시도: 2회 (총 3회)
  - 백오프: 1초, 2초
  - 파싱 실패 시 "repair 프롬프트"를 추가하여 재요청 (선택)

### 3단계: 폴백 응답 구현

- 모든 재시도 실패 시:
  - HTTP 200 + 빈 아이템 목록 반환 (에러 코드 포함)
  - `{ "items": [], "error": "analysis_failed", "message": "이미지 분석에 실패했습니다. 다시 시도해주세요." }`
  - 프론트엔드에서 에러 메시지 표시 (기존 폴백 UX)

### 4단계: 관측 가능성 로그

- 각 시도 결과를 로그에 기록:
  - `[Scan] 파싱 실패, 재시도 1/2 (ValidationError: ...)`
  - `[Scan] 재시도 성공 (2/3 시도)`
  - `[Scan] 모든 재시도 실패 (3/3 시도), 폴백 응답 반환`

## 의존성 & 연결

**이전 작업에서 가져올 것**:

- **결과물**: [U-021[Mvp]](../unit-results/U-021[Mvp].md) - 이미지 이해 엔드포인트
- **참조**: [U-018[Mvp]](../unit-results/U-018[Mvp].md) - Repair loop 패턴

**다음 작업에 전달할 것**:

- U-095: Scanner 아이템 생성 개수 랜덤화에서 안정적인 파싱 결과 전제
- CP-MVP-03: Scanner 업로드 데모 안정성

## 주의사항

**기술적 고려사항**:

- (RULE-004) 재시도 실패 시에도 안전한 대체 결과 제공 (빈 아이템 목록)
- (RULE-007) 파싱 에러 로그에 프롬프트 원문/이미지 바이트 포함 금지
- 재시도 시 동일 이미지를 재전송하므로 추가 비용 발생 → FAST 모델 사용으로 최소화
- 안전 차단(safety block)은 재시도해도 동일 결과이므로 즉시 폴백

**잠재적 리스크**:

- 재시도 3회 모두 실패하면 사용자 경험 저하 → 폴백 메시지로 "다시 시도" 안내
- 비전 모델 응답 형식이 근본적으로 깨진 경우 → MMP에서 프롬프트 튜닝

## 페어링 질문 (결정 필요)

- [ ] **Q1**: 재시도 시 프롬프트 변경?
  - Option A: 동일 프롬프트로 재요청 (비결정성 활용)
  - Option B: "JSON 형식으로 반드시 응답하세요" 추가 지시 포함
  - Option C: temperature를 낮춰서 재시도 (0.5 → 0.3)

## 참고 자료

- `vibe/unit-results/U-021[Mvp].md` - 이미지 이해 엔드포인트
- `vibe/unit-results/U-018[Mvp].md` - Repair loop 구현
- `vibe/prd.md` - 8.4(구조화 출력/검증/복구), 8.6(이미지 이해)
