# U-101[Mmp]: Cloud Run 배포 구성 + env/secret 가이드

## 메타데이터

| 항목      | 내용        |
| --------- | ----------- |
| Unit ID   | U-101[Mmp]  |
| Phase     | MMP         |
| 예상 소요 | 75분        |
| 의존성    | U-100       |
| 우선순위  | ⚡ Critical |

## 작업 목표

Cloud Run에 배포 가능한 형태로 백엔드(오케스트레이터)를 구성하고, Vertex 인증/환경변수/Secret 관리 가이드를 정리한다.

**배경**: MVP는 로컬 데모를 목표로 하지만, MMP에서는 “운영 가능한 데모”를 위해 배포/권한/secret 관리가 필요하다. (RULE-007)

**완료 기준**:

- Cloud Run에서 백엔드가 실행되고(헬스체크), 프론트가 이를 호출할 수 있다.
- 서비스 계정 권한(최소 권한)과 환경변수/secret 주입 방식이 문서화된다.
- BYOK(사용자 API 키 입력) 흐름이 포함되지 않는다. (RULE-007)

## 영향받는 파일

**생성**:

- (선택) `infra/cloud-run/` - 배포 스크립트/메모
- `vibe/unit-runbooks/U-101[Mmp].md` - 배포 런북(필수 권장)

**수정**:

- `backend/Dockerfile` - Cloud Run 실행에 맞는 엔트리/포트/헬스(필요 시)

**참조**:

- `vibe/tech-stack.md` - Cloud Run 권장, 서비스 계정 기반
- `.cursor/rules/00-core-critical.mdc` - RULE-007/010

## 구현 흐름

### 1단계: Cloud Run 실행 요구사항 정리

- 포트, 헬스 체크 경로, CORS, 타임아웃 등 기본 설정을 정한다.

### 2단계: IAM/서비스 계정 권한 최소화

- Vertex AI 호출에 필요한 권한만 부여한다(최소 권한).
- 키 파일을 배포 아티팩트에 포함하지 않는다(Cloud Run SA 권한 사용).

### 3단계: 런북 작성(재현 가능한 배포)

- 빌드→배포→검증(헬스/TTFB/기본 턴 실행) 절차를 런북으로 남긴다.

## 의존성 & 연결

**이전 작업에서 가져올 것**:

- **계획서**: [U-100[Mmp]](U-100[Mmp].md) - Docker 기반 표준 실행 환경

**다음 작업에 전달할 것**:

- CP-MMP-01에서 “배포/관측 게이트” 체크를 수행할 기반
- U-102(GCS) 연동을 위한 권한/환경 기반

## 주의사항

**기술적 고려사항**:

- (RULE-007) secret(키/토큰/쿠키) 로그 출력 금지: 배포 런북에도 민감값을 남기지 않는다.
- (RULE-010) 런타임/버전 임의 변경 금지: tech-stack 기준 유지.

**잠재적 리스크**:

- 권한 설정/네트워크로 배포가 지연될 수 있음 → 런북에 “필수 권한/진단 체크리스트”를 포함한다.

## 페어링 질문 (결정 필요)

- [ ] **Q1**: 프론트 배포는 어떻게 둘까?
  - Option A: 프론트는 정적 호스팅(별도) + 백엔드 Cloud Run(권장)
  - Option B: 프론트도 Cloud Run 컨테이너로 서빙(단순하지만 비용/캐시 전략 필요)

## 참고 자료

- `vibe/tech-stack.md` - Cloud Run/Vertex 인증
- `.cursor/rules/00-core-critical.mdc` - RULE-007/010
