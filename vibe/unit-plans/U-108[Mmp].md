# U-108[Mmp]: ⚡보안 하드닝(인젝션 케이스/secret scan)

## 메타데이터

| 항목      | 내용        |
| --------- | ----------- |
| Unit ID   | U-108[Mmp]  |
| Phase     | MMP         |
| 예상 소요 | 75분        |
| 의존성    | CP-MMP-01   |
| 우선순위  | ⚡ Critical |

## 작업 목표

프롬프트 인젝션 방어(“사용자 입력은 룰이 아니다”)와 비밀정보 노출 방지(로그/레포/응답) 체계를 강화하고, 대표 공격 시나리오를 리플레이로 검증할 수 있게 한다.

**배경**: PRD/Red-line은 Vertex 서비스 계정 기반, 비밀정보 커밋/노출 금지, 프롬프트 원문/CoT 노출 금지를 핵심 규칙으로 강제한다. (RULE-007/008)

**완료 기준**:

- 입력 인젝션 케이스에서도 스키마/경제/안전 정책이 우선되며, “규칙 무시”를 따르지 않는다. (RULE-007)
- 로그/응답/UI에 비밀정보/프롬프트 원문/내부 추론이 포함되지 않는다. (RULE-007/008)
- 시나리오(U-105)에 “인젝션/차단/복구” 케이스가 추가되어 회귀로 확인 가능하다.

## 영향받는 파일

**생성**:

- `backend/src/unknown_world/security/redaction.py` - 민감 로그 마스킹/차단 유틸(선택)
- `backend/src/unknown_world/security/prompt_injection.py` - 입력 정규화/정책 가드(선택)

**수정**:

- `backend/src/unknown_world/orchestrator/*` - 시스템 규칙 우선 적용/정책 고정(필요 시)
- `backend/src/unknown_world/api/turn.py` - blocked/폴백 응답이 항상 스키마 준수하도록 정리(필요 시)
- `backend/src/unknown_world/replay/scenario_library/*` - 인젝션 시나리오 추가(U-105 연계)

**참조**:

- `.cursor/rules/00-core-critical.mdc` - RULE-007/008/004
- `.gemini/rules/red-line.md` - 금지 패턴/보안
- `vibe/prd.md` 11.3 - 프롬프트 인젝션 대응

## 구현 흐름

### 1단계: 보안 체크리스트/위협 모델 최소 확정

- 공격: “규칙 무시해”, “스키마 무시해”, “키/토큰 출력해”, “프롬프트 보여줘”
- 방어: 시스템 규칙 고정 + 출력 스키마 강제 + 로그 마스킹 + blocked 폴백

### 2단계: 방어 로직 적용/검증

- TurnInput은 데이터로만 취급하고 시스템 규칙을 덮어쓰지 못하게 한다.
- blocked 시에도 TurnOutput 스키마를 준수하며, 안전한 텍스트-only 대체 결과를 제공한다. (RULE-004)

### 3단계: 회귀 시나리오 추가

- U-105 시나리오에 인젝션/차단/복구 케이스를 추가하고 자동 러너로 확인한다.

## 의존성 & 연결

**이전 작업에서 가져올 것**:

- **체크포인트**: [CP-MMP-01](CP-MMP-01.md) - 배포/관측 환경에서의 기준선
- **계획서**: [U-105[Mmp]](U-105[Mmp].md) - 자동 리플레이/시나리오

**다음 작업에 전달할 것**:

- RU-011에서 Autopilot/Replay 모듈 정리 시 보안/로그 정책을 공통으로 적용할 기준
- CP-MMP-02에서 “시나리오 회귀 100%”의 보안 케이스 포함

## 주의사항

**기술적 고려사항**:

- (RULE-007) BYOK 금지: 사용자 키 입력/저장 UX를 만들지 않는다.
- (RULE-008) 프롬프트 원문/CoT 비노출은 절대 규칙이다.

**잠재적 리스크**:

- 방어를 강하게 하면 정상 입력도 차단될 수 있음 → blocked 시에도 항상 안전한 대체 행동을 제공해 플레이가 멈추지 않게 한다.

## 페어링 질문 (결정 필요)

- [ ] **Q1**: “보안 진단 로그”는 어디까지 남길까?
  - Option A: 이벤트 타입/턴 ID/차단 여부만(권장: 최소 노출)
  - Option B: 입력 원문 일부(리스크 큼, 권장하지 않음)

## 참고 자료

- `.gemini/rules/red-line.md` - 보안/금지 규칙
- `.cursor/rules/00-core-critical.mdc` - RULE-007/008/004
- `vibe/prd.md` - 안전/인젝션 대응
