# U-025[Mvp]: 엔딩 리포트 + 리플레이/시나리오 하네스 (U-026 흡수)

## 메타데이터

| 항목      | 내용        |
| --------- | ----------- |
| Unit ID   | U-025[Mvp]  |
| Phase     | MVP         |
| 예상 소요 | 120분 (엔딩 75분 + 리플레이 45분) |
| 의존성    | U-018,U-024 |
| 우선순위  | High        |

## 작업 목표

세션이 엔딩(또는 데모 종료 조건)에 도달했을 때, 플레이 로그 기반으로 **엔딩 리포트 아티팩트**(요약/룰 변형 타임라인/경제 결산/대표 이미지 링크)를 생성한다.

**배경**: PRD는 “동적 엔딩 생성기”와 “아티팩트(리포트/이미지/로그)”를 시스템의 필수 요소로 요구한다. (PRD 6.5, RULE-001)

**완료 기준**:

- 엔딩 조건(데모용이라도)을 만족하면 “엔딩 리포트”가 생성되어 UI에서 열람/저장 가능하다.
- 리포트에는 최소 다음이 포함된다:
  - 내러티브 요약(언어 고정)
  - 룰 변형 타임라인(핵심 이벤트)
  - 퀘스트 달성도(완료율) 또는 주요 목표 결과
  - 재화 결산(ledger 기반)
- 이미지가 없거나 실패해도 텍스트-only 리포트로 완료된다. (RULE-004)

## 영향받는 파일

**생성**:

- `backend/src/unknown_world/artifacts/ending_report.py` - 엔딩 리포트 생성기(데이터 조합/요약)
- `frontend/src/components/EndingReportModal.tsx` - 리포트 표시 UI
- `frontend/src/stores/artifactsStore.ts` - (선택) 아티팩트 상태/리포트 저장

**수정**:

- `frontend/src/App.tsx` - 엔딩 상태 감지/리포트 UI 오픈/저장 연결
- `frontend/src/save/saveGame.ts` - (필요 시) 엔딩 리포트 메타 저장

**참조**:

- `vibe/prd.md` 6.5 - 동적 엔딩 생성기 요구
- `.cursor/rules/00-core-critical.mdc` - RULE-001/004/006/005

## 구현 흐름

### 1단계: 엔딩 조건과 리포트 데이터 소스 확정

- MVP에서는 데모용 “엔딩 트리거”를 정의한다(예: 특정 퀘스트 완료/턴 수/사용자 종료 버튼).
- 데이터 소스는 SaveGame/WorldState/history/economy ledger에서 가져온다.

### 2단계: 리포트 생성(서버 또는 클라) 결정

- 서버 생성 시: 요약/정합성을 중앙에서 보장 가능
- 클라 생성 시: MVP 단순하지만 모델 호출/검증 경계가 애매해질 수 있음  
  → 기본 권장: 서버에서 생성(스키마/언어/경제 정합성 유지)

### 3단계: UI 표시/저장(아티팩트화)

- 리포트를 “게임 아티팩트”로 보여주고, SaveGame에 링크(또는 본문)를 저장한다.
- 리포트에서 “10분 데모 루프”의 핵심 증거(룰 변형/경제/검증 배지)를 한눈에 확인 가능하게 한다.

## 의존성 & 연결

**이전 작업에서 가져올 것**:

- **계획서**: [U-015[Mvp]](U-015[Mvp].md) - SaveGame/ledger/히스토리
- **계획서**: [U-018[Mvp]](U-018[Mvp].md) - 검증/언어/경제 인바리언트

**다음 작업에 전달할 것**:

- U-026에서 리플레이/회귀 시 “기대 아티팩트”로 활용할 엔딩 리포트
- CP-MVP-03에서 데모 종료 시 “결과물”로 제출/설득에 사용

## 주의사항

**기술적 고려사항**:

- (RULE-006) 리포트 언어는 TurnInput.language와 동일하게 고정한다(혼합 금지).
- (RULE-005) 결산은 ledger 기반이며, 비용/잔액 불일치가 있으면 리포트 생성 시점에라도 표시/복구한다.

**잠재적 리스크**:

- 리포트가 너무 길어지면 가독성이 떨어짐 → MVP는 핵심 카드(요약/타임라인/결산) 중심으로 “짧고 강한” 형태로 유지한다.

## 페어링 질문 (결정 필요)

- [ ] **Q1**: 엔딩 리포트 생성 위치는?
  - Option A: 서버 생성(권장: 검증/정합성, 추후 저장 확장 용이)
  - Option B: 클라 생성(초기 단순, 하지만 기준선 흔들림)

## 추가 작업: 리플레이/시나리오 하네스 (구 U-026)

### 구현 흐름 (리플레이)

1. **시나리오 저장 형식**: seed + 사용자 액션(TurnInput) 시퀀스를 JSON으로 직렬화
2. **수동 러너**: 저장된 시나리오를 입력으로 받아 자동 재생, 각 턴의 Hard Gate(Schema/Economy/Safety/Consistency) 결과를 수집
3. **결과 요약**: 턴별 게이트 통과/실패를 표시, 실패 시 diff/context 포함
4. 데모프로필별 "기본 시나리오 1개" 번들 (CP-MVP-03에서 검증)

**영향받는 파일**:
- `backend/src/unknown_world/harness/replay_runner.py` - 리플레이 실행 엔진
- `backend/src/unknown_world/harness/scenario.py` - 시나리오 스키마/직렬화
- `frontend/src/components/ReplayPanel.tsx` - (선택) 리플레이 결과 표시 UI

**참조**: `vibe/unit-plans/U-026[Mvp].md` (본 유닛에 흡수)

## 참고 자료

- `vibe/prd.md` - 엔딩 리포트/아티팩트/리플레이 요구
- `vibe/unit-plans/U-026[Mvp].md` - 리플레이 상세 (흡수됨)
- `.cursor/rules/00-core-critical.mdc` - RULE-001/004/005/006
