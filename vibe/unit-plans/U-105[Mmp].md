# U-105[Mmp]: Scenario Library(5) + 자동 리플레이 확장

## 메타데이터

| 항목      | 내용                              |
| --------- | --------------------------------- |
| Unit ID   | U-105[Mmp]                        |
| Phase     | MMP                               |
| 예상 소요 | 75분                              |
| 의존성    | U-026                             |
| 우선순위  | ⚡ Critical                        |

## 작업 목표

대표 시나리오 5개를 Scenario Library로 정리하고, 이를 자동으로 반복 실행해 Hard Gate 인바리언트 회귀를 지속적으로 잡는다.

**배경**: PRD는 “리플레이/시나리오 하네스”를 핵심 개발 방식으로 채택하고, 비결정성은 허용하되 인바리언트는 항상 유지하라고 명시한다. (PRD 10.3)

**완료 기준**:

- 최소 5개의 대표 시나리오가 정의된다(온보딩/퍼즐(DnD)/룰 변형/스캐너/자동 복구).
- 자동 러너가 시나리오를 순회 실행하고, 각 실행에서 Hard Gate 체크 결과(pass/fail)를 남긴다.
- 실패 시 “어디서 깨졌는지(턴/인바리언트)”만 남기고 프롬프트 원문/내부 추론은 기록하지 않는다. (RULE-008)

## 영향받는 파일

**생성**:

- `backend/src/unknown_world/replay/scenario_library/*.json` - 시나리오 5개 이상
- `backend/src/unknown_world/replay/auto_runner.py` - 자동 러너(배치 실행)
- (선택) `backend/src/unknown_world/replay/report.py` - 실행 결과 요약 리포트 생성

**수정**:

- `backend/src/unknown_world/replay/runner.py` - 수동 러너와 코드 공유/정리(필요 시)

**참조**:

- `vibe/prd.md` 10.3 - Scenario Library/Replay Runner 요구
- `.cursor/rules/00-core-critical.mdc` - RULE-004/005/008

## 구현 흐름

### 1단계: 시나리오 5개 선정/정의

- 온보딩(기본 텍스트+액션덱)
- 퍼즐(DnD 드롭 성공/실패)
- 룰 변형(타임라인 업데이트)
- 스캐너(업로드→아이템화)
- 자동 복구(의도적 스키마/룰 실패 유도 → repair/폴백 확인)

### 2단계: 자동 러너 구현(배치 실행)

- 시나리오를 순차 실행하며 각 턴의 인바리언트를 체크한다.
- 실패 시 즉시 종료/다음 시나리오로 넘어가는 정책을 정한다(옵션).

### 3단계: 결과 리포트/아티팩트 남기기

- 실행 결과(pass/fail, 실패 원인, 첫 실패 턴)를 파일로 남긴다.
- UI(데모 모드)에서 실행 결과를 요약으로 볼 수 있게 하는 옵션을 둔다.

## 의존성 & 연결

**이전 작업에서 가져올 것**:

- **계획서**: [U-026[Mvp]](U-026[Mvp].md) - 리플레이/시나리오 하네스(수동)

**다음 작업에 전달할 것**:

- CP-MMP-02에서 “시나리오 회귀 100%” 체크포인트를 수행할 자동화 기반
- U-108(보안 하드닝)에서 인젝션/차단 케이스를 시나리오로 추가할 기반

## 주의사항

**기술적 고려사항**:

- (RULE-004) 비결정성은 인정하되, 인바리언트는 100% 통과가 목표다.
- (RULE-008) 리포트/로그에 프롬프트 원문/내부 추론/비밀정보를 남기지 않는다.

**잠재적 리스크**:

- 멀티모달 업로드 자동화는 환경 의존성이 큼 → 업로드 시나리오는 “고정 테스트 이미지”로 관리하거나 수동 보조 옵션을 둔다.

## 페어링 질문 (결정 필요)

- [ ] **Q1**: 자동 러너의 실패 정책은?
  - Option A: 실패 즉시 중단(빠른 피드백)
  - Option B: 끝까지 실행 후 요약(권장: 전체 상태 파악)

## 참고 자료

- `vibe/prd.md` - Scenario Harness/Replay Runner
- `.cursor/rules/00-core-critical.mdc` - RULE-004/005/008


