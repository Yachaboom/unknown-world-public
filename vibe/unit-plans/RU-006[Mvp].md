# RU-006[Mvp]: 리팩토링 - media/artifacts 스토리지 추상화

## 메타데이터

| 항목      | 내용        |
| --------- | ----------- |
| Unit ID   | RU-006[Mvp] |
| Phase     | MVP         |
| 예상 소요 | 60분        |
| 의존성    | U-022       |
| 우선순위  | High        |

## 작업 목표

이미지 생성/스캐너 업로드가 추가되며 생기는 저장/서빙/제한 로직을 정리해, 로컬(MVP)과 GCS(MMP) 확장을 대비한 **스토리지 추상화**를 만든다(동작 보존).

**배경**: 멀티모달은 파일/에셋이 필연적으로 늘어나며, 이를 정리하지 않으면 보안/용량/운영 문제가 빠르게 생긴다. (RULE-007)

**완료 기준**:

- 백엔드에 media/artifacts 저장 인터페이스(로컬 구현)가 도입되어, 이미지 생성/스캐너가 동일 경로로 저장한다.
- 파일 크기/타입 제한과 안전한 에러 응답이 일관되게 적용된다.
- 비밀정보/프롬프트 원문/사용자 업로드 원본이 로그에 노출되지 않는다(메타만). (RULE-007/008)

## 영향받는 파일

**생성**:

- `backend/src/unknown_world/storage/storage.py` - 스토리지 인터페이스(put/get)
- `backend/src/unknown_world/storage/local_storage.py` - 로컬 저장 구현(MVP)

**수정**:

- `backend/src/unknown_world/services/image_generation.py` - 저장 경로를 스토리지로 통일
- `backend/src/unknown_world/services/image_understanding.py` - 업로드 처리/임시 저장 정리(필요 시)

**참조**:

- `.cursor/rules/00-core-critical.mdc` - RULE-007/010
- `vibe/tech-stack.md` - MMP에서 GCS 확장 가능성

## 구현 흐름

### 1단계: 저장 대상/수명 정책 확정

- 저장 대상: 생성 이미지, 업로드 이미지(선택), 엔딩 리포트/리플레이 아티팩트(추후)
- 수명: MVP는 로컬 개발 중심(임시 폴더/데모 유지), 운영은 MMP에서 GCS로 확장

### 2단계: 스토리지 인터페이스 도입

- put/get 기반 최소 인터페이스를 만들고, 파일명 규칙(세션/턴/타입)을 정한다.
- 외부로 노출되는 것은 URL/핸들뿐이며, 원본/민감 메타를 노출하지 않는다.

### 3단계: 공통 제한/보안 적용

- 파일 크기/타입 제한을 중앙에서 관리한다.
- 로깅은 라벨/크기/처리 시간 등 메타만 남긴다(내용/원본/키/프롬프트 금지).

## 의존성 & 연결

**이전 작업에서 가져올 것**:

- **계획서**: [U-019[Mvp]](U-019[Mvp].md) - 이미지 생성
- **계획서**: [U-021[Mvp]](U-021[Mvp].md) - 스캐너 백엔드
- **계획서**: [U-022[Mvp]](U-022[Mvp].md) - 스캐너 UI 연동(업로드 경로 확인)

**다음 작업에 전달할 것**:

- U-102(MMP)에서 GCS 스토리지 어댑터로 자연스럽게 확장할 구조
- U-025/U-026(엔딩/리플레이) 아티팩트 저장 기반

## 주의사항

**기술적 고려사항**:

- (RULE-007) 사용자 업로드/생성 에셋 처리에서 비밀정보/PII 노출을 방지한다.
- (RULE-010) “저장은 DB” 같은 방향 전환 금지: 파일/SaveGame 기반으로 우선 구성한다.

**잠재적 리스크**:

- 너무 이른 추상화로 속도가 느려질 수 있음 → MVP는 로컬 구현만, 인터페이스는 최소로 제한한다.

## 페어링 질문 (결정 필요)

- [ ] **Q1**: MVP 로컬 저장 경로 정책은?
  - Option A: `backend/.data/` 같은 전용 폴더(권장: 정리 용이, gitignore 필요)
  - Option B: OS temp 디렉토리(자동 정리되지만 디버깅 어려움)

## 참고 자료

- `.cursor/rules/00-core-critical.mdc` - RULE-007/010
- `vibe/tech-stack.md` - (선택) GCS 확장
