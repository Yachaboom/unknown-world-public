# U-068[Mvp] 참조 이미지 연결성 강화 실행 가이드

## 1. 개요

이전 턴에서 생성된 장면 이미지를 다음 턴의 **참조 이미지(reference image)**로 전달하여, 연속된 장면 간 시각적 일관성(캐릭터/오브젝트/톤)을 유지하고 몰입감을 강화합니다.

**예상 소요 시간**: 10분

**의존성**:

- 의존 유닛: U-080[Mvp] (API 키 인증), U-066[Mvp] (이미지 지연 흡수 플로우)
- 선행 완료 필요: 백엔드/프론트엔드 서버 실행

---

## 2. 빠른 시작 (Quick Start)

### 2.1 환경 준비

```bash
# 백엔드 의존성 설치 (backend 디렉토리에서)
cd backend
uv sync

# 프론트엔드 의존성 설치 (frontend 디렉토리에서)
cd frontend
pnpm install
```

### 2.2 환경 변수 설정

```bash
# backend/.env 파일에 GOOGLE_API_KEY 설정 확인
# .env 파일 예시:
# GOOGLE_API_KEY=your_api_key_here
```

### 2.3 서버 실행

```bash
# 터미널 1: 백엔드 서버 (포트 8011)
cd backend
uv run uvicorn src.unknown_world.main:app --host 0.0.0.0 --port 8011 --reload

# 터미널 2: 프론트엔드 서버 (포트 8001)
cd frontend
pnpm dev
```

### 2.4 첫 화면/결과 확인

- 브라우저에서 `http://localhost:8001` 접속
- 프로필 선택 후 게임 시작
- 성공 지표: 내러티브와 이미지가 정상적으로 표시됨

---

## 3. 핵심 기능 시나리오

### 시나리오 A: 참조 이미지 연결성 확인

**목적**: 연속된 턴에서 이미지 스타일 일관성 확인

**실행**:

1. 게임을 시작하고 첫 번째 턴을 진행
2. 이미지가 생성되면 해당 이미지의 스타일/톤 확인
3. 두 번째 턴을 진행 (액션 카드 선택 또는 텍스트 입력)
4. 새 이미지 생성 결과 확인

**기대 결과**:

- 두 번째 이미지가 첫 번째 이미지의 스타일/톤과 유사해야 함
- 캐릭터나 주요 오브젝트의 외형이 일관되게 유지

**확인 포인트**:

- ✅ 두 이미지 간 색상 팔레트 유사성
- ✅ 캐릭터/오브젝트 디자인 일관성
- ✅ 전반적인 아트 스타일 일관성

---

### 시나리오 B: 첫 턴 (참조 이미지 없음) vs 연속 턴 비교

**목적**: 참조 이미지 유무에 따른 차이 확인

**전제 조건**:

- 게임 세션 초기화 상태에서 시작

**실행**:

1. **첫 턴**: 프로필 선택 후 게임 시작
   - 참조 이미지 없이 생성됨 (예상)
2. **두 번째 턴**: 액션 수행
   - 이전 이미지를 참조로 사용하여 생성됨 (예상)
3. **세 번째 턴**: 다른 액션 수행
   - 계속해서 연속성 유지 확인

**결과 비교**:
| 턴 | 참조 이미지 | 기대 결과 |
|------|------------|-----------|
| 1 | 없음 | 독립적 이미지 생성 |
| 2 | 턴1 이미지 | 스타일 연속성 유지 |
| 3 | 턴2 이미지 | 스타일 연속성 유지 |

**확인 포인트**:

- ✅ 턴 1→2 스타일 연속성
- ✅ 턴 2→3 스타일 연속성
- ✅ 전체 세션 내 일관된 시각적 경험

---

### 시나리오 C: 백엔드 로그 확인

**목적**: 참조 이미지 처리 로직 동작 확인

**실행**:

1. 백엔드 터미널에서 로그 모니터링
2. 게임에서 연속 2턴 이상 진행

**로그 확인**:

```
# 참조 이미지가 있을 때 예상 로그:
[ImageGen] 이미지 생성 요청 ... has_reference=True

# 참조 이미지가 없을 때 예상 로그:
[ImageGen] 이미지 생성 요청 ... has_reference=False
```

**확인 포인트**:

- ✅ `has_reference=True` 로그 확인 (두 번째 턴부터)
- ✅ 참조 이미지 로드 성공 로그 확인
- ✅ 이미지 생성 완료 로그 확인

---

### 시나리오 D: FAST 모델 참조 이미지 테스트

**목적**: FAST 모델에서도 참조 이미지가 적용되는지 확인

**전제 조건**:

- 이미지 생성 시 FAST 모델이 선택되는 조건 (예: 저비용 행동)

**실행**:

1. 연속 턴 진행 시 FAST 모델 사용 케이스 발생
2. 백엔드 로그에서 `model_label=FAST` 확인
3. 참조 이미지 적용 여부 확인

**확인 포인트**:

- ✅ FAST 모델에서도 `has_reference=True` 로그 확인
- ✅ Q2 결정 적용 확인: FAST 모델도 1장 제한으로 참조 사용

---

## 4. 실행 결과 확인

### 4.1 로그 확인

- 위치: 백엔드 터미널 출력
- 주요 로그 메시지:
  - `[ImageGen] 이미지 생성 요청 ... has_reference=True`: 참조 이미지 사용
  - `[ImageGen] 로컬 참조 이미지 로드 성공`: 캐시/로컬 파일에서 로드
  - `[ImageGen] 이미지 생성 완료`: 정상 완료

### 4.2 생성 파일

- `.data/images/generated/*.png`: 생성된 이미지 파일

### 4.3 성공/실패 판단 기준

**성공**:

- ✅ 연속 턴에서 참조 이미지 사용 로그 확인
- ✅ 이미지 간 시각적 일관성 유지
- ✅ 에러 없이 이미지 생성 완료

**실패 시 확인**:

- ❌ `has_reference=False`가 계속 표시 → 프론트엔드에서 URL 전달 확인
- ❌ 참조 이미지 로드 실패 → 이미지 파일 경로/권한 확인
- ❌ 이미지 생성 타임아웃 → API 키 및 네트워크 연결 확인

---

## 5. 문제 해결 (Troubleshooting)

### 5.1 일반적인 오류

**오류**: `참조 이미지 로드 실패`

- **원인**: 이미지 파일이 삭제되었거나 경로 불일치
- **해결**: `.data/images/generated/` 디렉토리 확인, 파일 존재 여부 점검

**오류**: `이미지 생성 타임아웃`

- **원인**: Gemini API 응답 지연
- **해결**: 네트워크 연결 확인, API 키 유효성 확인

**오류**: 참조 이미지가 적용되지 않음 (스타일 일관성 없음)

- **원인**: 프론트엔드에서 `referenceImageUrl`이 전달되지 않음
- **해결**:
  1. 브라우저 개발자 도구 → Network 탭에서 `/api/image/generate` 요청 확인
  2. 요청 body에 `reference_image_url` 필드 포함 여부 확인
  3. `worldStore.sceneState.imageUrl` 값 확인

### 5.2 환경별 주의사항

- **Windows**: 경로 구분자 주의 (백슬래시 vs 슬래시)
- **macOS/Linux**: 파일 권한 확인 (.data 디렉토리 쓰기 권한)

---

## 6. 다음 단계

이 유닛 완료 후:

- **MMP U-103**: 이미지 편집/멀티턴 플로우 (참조 이미지 기반 편집)
- **CP-MVP-03**: 시각적 연속성이 있는 데모 시나리오
