# U-090 핫스팟 생성 정밀분석 전용 제한 실행 가이드

## 1. 개요

핫스팟(SceneObject/ui.objects[])이 오직 "정밀분석" 액션을 통해서만 생성되도록 제한하고, 일반 턴에서 GM이 핫스팟을 임의로 생성하는 것을 서버에서 강제로 차단하며, 프론트엔드에서 핫스팟 상태를 지능적으로 관리(유지/병합/초기화)하는 기능을 구현했습니다.

**예상 소요 시간**: 10분

**의존성**:

- 의존 유닛: U-076[Mvp] (정밀분석 파이프라인), U-010[Mvp] (Scene Canvas + Hotspot Overlay)
- 선행 완료 필요: U-076, U-010 런북 실행 완료

---

## 2. 빠른 시작 (Quick Start)

### 2.1 환경 준비

```bash
cd d:\Dev\unknown-world\frontend
pnpm install
```

```bash
cd d:\Dev\unknown-world\backend
uv sync
```

### 2.2 의존 유닛 확인

- U-076: 정밀분석 서비스 (`backend/src/unknown_world/services/agentic_vision.py`) 존재 확인
- U-010: SceneCanvas 핫스팟 오버레이 (`frontend/src/components/SceneCanvas.tsx`) 존재 확인

### 2.3 즉시 실행

```bash
# Backend (포트 8011)
cd d:\Dev\unknown-world\backend
cp .env.example .env  # 필요 시
uv run uvicorn unknown_world.main:app --reload --port 8011
```

```bash
# Frontend (포트 8001)
cd d:\Dev\unknown-world\frontend
pnpm dev
```

### 2.4 첫 화면/결과 확인

- 브라우저에서 `http://localhost:8001` 접근
- 게임 UI가 정상 로드되는지 확인
- 성공 지표: 고정 게임 UI 레이아웃 렌더, 채팅 버블 없음

---

## 3. 핵심 기능 시나리오

### 시나리오 A: 일반 턴에서 핫스팟 미생성 확인

**목적**: 정밀분석이 아닌 일반 턴에서 핫스팟이 생성되지 않는지 검증

**실행**:

1. 데모 프로필 선택하여 게임 시작
2. 일반 액션 카드 선택 (예: "들어간다", "살펴본다" 등)
3. 턴 완료 후 Scene Canvas 확인

**기대 결과**:

- Scene Canvas에 핫스팟 오버레이가 **표시되지 않음**
- 이전에 핫스팟이 없었으면 계속 없음

**확인 포인트**:

- ✅ 일반 턴 후 핫스팟이 새로 생성되지 않음
- ✅ 백엔드 로그에 "비정밀분석 턴에서 GM 생성 핫스팟 N개 제거됨" 경고가 나타나면 필터링 동작 확인

---

### 시나리오 B: 정밀분석 턴에서 핫스팟 정상 생성

**목적**: 정밀분석 액션에서는 핫스팟이 정상 생성되는지 검증

**전제 조건**:

- Scene 이미지가 존재하는 상태 (이미지 생성 턴 완료 후)

**실행**:

1. Scene 이미지가 있는 상태에서 ActionDeck의 "정밀분석" 카드 클릭
2. 분석 완료 대기 (5~10초)
3. Scene Canvas 확인

**기대 결과**:

- "장면을 자세히 살펴봅니다..." 내러티브 출력
- Scene Canvas에 핫스팟 오버레이 표시 (bbox 영역 하이라이트)
- 핫스팟 호버 시 라벨/힌트 툴팁 표시

**확인 포인트**:

- ✅ 정밀분석 후 핫스팟이 정상 추가됨
- ✅ bbox 좌표가 이미지 내 오브젝트 위치와 일치함
- ✅ 호버/클릭 인터랙션 동작

---

### 시나리오 C: 일반 턴에서 기존 핫스팟 유지

**목적**: 정밀분석으로 생성된 핫스팟이 다음 일반 턴에서도 유지되는지 검증

**실행 순서**:

1. **Step 1**: 시나리오 B 완료 (핫스팟이 있는 상태)
2. **Step 2**: 일반 액션 카드 선택 (예: "주변을 탐색한다")
3. **Step 3**: 턴 완료 후 Scene Canvas 확인

**기대 결과**:

- 이전 정밀분석에서 추가된 핫스팟이 **그대로 유지**됨
- 새 핫스팟이 추가되지 않음

**확인 포인트**:

- ✅ 기존 핫스팟 유지
- ✅ 핫스팟 개수 변화 없음
- ✅ 호버/클릭 여전히 동작

---

### 시나리오 D: 장면 전환 시 핫스팟 초기화

**목적**: 새 이미지가 생성되는 턴(장면 전환)에서 핫스팟이 초기화되는지 검증

**실행 순서**:

1. **Step 1**: 시나리오 B 완료 (핫스팟이 있는 상태)
2. **Step 2**: 장면이 바뀌는 액션 선택 (예: "다른 방으로 이동한다" - 이미지 생성을 트리거하는 액션)
3. **Step 3**: 새 이미지 생성 완료 후 Scene Canvas 확인

**기대 결과**:

- 이전 핫스팟이 **모두 제거**됨
- 새 장면에는 핫스팟 없음 (정밀분석을 다시 해야 함)

**확인 포인트**:

- ✅ 새 이미지 생성 후 핫스팟 전체 초기화 (Q1: Option A)
- ✅ "정밀분석" 카드가 다시 ActionDeck에 등장

---

### 시나리오 E: 추가 정밀분석 시 핫스팟 병합

**목적**: 동일 장면에서 정밀분석을 두 번 수행하면 핫스팟이 병합되는지 검증

**실행 순서**:

1. **Step 1**: 첫 번째 정밀분석 실행 → 핫스팟 A, B 추가
2. **Step 2**: 두 번째 정밀분석 실행 → 핫스팟 C 추가 (또는 A 업데이트)

**기대 결과**:

- 기존 핫스팟(A, B)이 유지되면서 새 핫스팟(C)이 추가됨
- 동일 ID의 핫스팟은 bbox가 업데이트됨

**확인 포인트**:

- ✅ 핫스팟 병합 동작 확인
- ✅ 중복 핫스팟 없음

---

## 4. 실행 결과 확인

### 4.1 로그 확인

- **백엔드 콘솔**:
  - `[Resolve] U-090: 비정밀분석 턴에서 GM 생성 핫스팟 N개 제거됨` → 필터링 동작
  - `[Verify] U-090: 비정밀분석 턴에서 핫스팟 N개 누출 감지, 강제 제거` → 이중 안전장치 동작 (정상 시 미출력)
  - `[Resolve] 정밀분석 성공 (U-076)` → 정밀분석 성공

### 4.2 성공/실패 판단 기준

**성공**:

- ✅ 일반 턴에서 핫스팟 미생성
- ✅ 정밀분석 턴에서 핫스팟 정상 추가
- ✅ 일반 턴에서 기존 핫스팟 유지
- ✅ 장면 전환 시 핫스팟 초기화
- ✅ 추가 정밀분석 시 핫스팟 병합

**실패 시 확인**:

- ❌ 일반 턴에서 핫스팟 표시 → 백엔드 로그에서 필터링 여부 확인
- ❌ 정밀분석 후 핫스팟 미표시 → U-076 서비스 동작 확인
- ❌ 장면 전환 후 핫스팟 잔류 → worldStore.ts의 isNewImageGeneration 로직 확인

---

## 5. 문제 해결 (Troubleshooting)

### 5.1 일반적인 오류

**오류**: 일반 턴에서도 핫스팟이 표시됨

- **원인**: resolve.py 필터링이 동작하지 않음
- **해결**: `_is_vision_trigger()` 반환값 확인, action_id가 정밀분석 ID와 겹치지 않는지 확인

**오류**: 정밀분석 후 핫스팟이 사라짐

- **원인**: worldStore.ts에서 빈 objects를 받아 초기화됨
- **해결**: 서버가 정밀분석 턴에서 objects를 정상 반환하는지 확인

**오류**: 장면 전환 후에도 핫스팟이 남음

- **원인**: `render.image_job.should_generate`가 true로 설정되지 않음
- **해결**: 이미지 생성 트리거가 정상 동작하는지 확인

---

## 6. 다음 단계

- U-089: 정밀분석 전용 UX와 함께 일관된 핫스팟 정책 완성
- CP-MVP-03: "핫스팟은 정밀분석에서만" 데모 시나리오
