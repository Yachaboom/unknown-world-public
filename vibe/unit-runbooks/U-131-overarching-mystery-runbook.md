# U-131 추상적 최종 목표(Overarching Mystery) 시스템 실행 가이드

## 1. 개요

모든 프로필에 공통된 **추상적 최종 목표(Overarching Mystery — "메아리/Echo")**를 시스템 프롬프트에 주입하여, GM이 매 턴 내러티브와 퀘스트 생성 시 일관된 방향성을 유지하도록 합니다. 이를 통해 턴이 진행될수록 스토리와 퀘스트가 발산하는 문제를 구조적으로 해결합니다.

**예상 소요 시간**: 10분

**의존성**:

- 의존 유닛: U-078[Mvp] (게임 목표 시스템 — 주 목표/서브 목표 구조)
- 선행 완료 필요: 없음 (단독 검증 가능)

---

## 2. 빠른 시작 (Quick Start)

### 2.1 환경 준비

```bash
cd frontend
pnpm install
```

### 2.2 즉시 실행

백엔드 서버 시작:

```bash
cd backend
uv run uvicorn unknown_world.main:app --reload --port 8011
```

프론트엔드 서버 시작 (별도 터미널):

```bash
cd frontend
pnpm dev --port 8001
```

### 2.3 첫 화면 확인

- 브라우저에서 http://localhost:8001 접속
- 성공 지표:
  - 프로필 선택 화면 표시
  - 아무 프로필 선택 후 게임 화면 진입

---

## 3. 핵심 기능 시나리오

### 시나리오 A: Overarching Mystery 내러티브 반영 확인

**목적**: GM이 매 턴 내러티브에 메아리(Echo)의 분위기/힌트를 은은하게 반영하는지 확인

**실행**:

1. "탐험가" 프로필 선택
2. "탐색하기" 액션 선택 (T1)
3. 이후 4턴 추가 진행 (T2~T5)

**기대 결과**:

- 내러티브에 "공명", "잊힌 기억", "희미한 진동", "보랏빛 맥동" 등 미스터리 힌트가 매 턴 은은하게 포함됨
- "메아리"나 "Echo"라는 단어가 직접 언급되지 않음
- 턴이 누적될수록 미스터리 요소가 점진적으로 강화됨

**확인 포인트**:

- ✅ T1~T2: 은은한 수준의 분위기 도입 (공명음, 희미한 진동 등)
- ✅ T3~T5: 점진적 강화 (시각적 요소, 기억 테마 심화)
- ✅ 어떤 턴에서도 "메아리" 또는 "Echo" 직접 언급 없음

---

### 시나리오 B: Quest/스토리 방향성 정렬 확인

**목적**: 주 목표와 스토리가 발산하지 않고 일관된 방향을 유지하는지 확인

**실행**:

1. "탐험가" 프로필로 시작
2. 5턴 이상 진행하며 주 목표와 내러티브 관찰
3. (선택) 주 목표가 완료되면 새 주 목표가 미스터리와 연결되는지 확인

**기대 결과**:

- 주 목표 "탈출구 찾기"가 유지되며, 내러티브가 이 목표와 관련된 탐색을 중심으로 전개
- 미스터리 요소가 탈출 여정에 자연스럽게 융합 (공명음이 탈출 방향을 암시하는 등)
- 스토리가 주 목표와 무관한 방향으로 발산하지 않음

**확인 포인트**:

- ✅ 주 목표와 내러티브가 같은 방향을 가리킴
- ✅ 미스터리 요소가 목표 달성의 단서/동기 역할
- ✅ 서브 목표가 주 목표의 구체적 행동으로 유지 (U-078 정책)

---

### 시나리오 C: 다른 프로필에서도 동작 확인

**목적**: 3종 프로필 모두에서 Overarching Mystery가 동작하는지 확인

**실행**:

1. "프로필 변경" → "서사꾼" 선택
2. 3턴 이상 진행, 내러티브 관찰
3. "프로필 변경" → "기술 전문가" 선택
4. 3턴 이상 진행, 내러티브 관찰

**기대 결과**:

- 서사꾼: 이야기 완성 주제 + 미스터리 분위기 반영
- 기술 전문가: 시스템 해킹/분석 주제 + 미스터리 분위기 반영
- 각 프로필별 장르와 무관하게 미스터리가 자연스럽게 해석됨

**확인 포인트**:

- ✅ 프로필별 고유 스토리에 미스터리 분위기가 자연스럽게 스며듦
- ✅ "메아리"/"Echo" 직접 언급 없음

---

### 시나리오 D: 프롬프트 원문 미노출 확인

**목적**: Overarching Mystery 프롬프트 원문이 UI에 노출되지 않는지 확인 (RULE-007/008)

**실행**:

1. 게임 진행 중 에이전트 콘솔(우측 패널) 확인
2. 브라우저 DevTools → Network 탭에서 API 응답 확인
3. 내러티브/액션 카드/퀘스트에서 프롬프트 원문 검색

**기대 결과**:

- 에이전트 콘솔에 "Overarching Mystery", "메아리", "Echo" 텍스트 없음
- API 응답(TurnOutput)에 프롬프트 원문 포함되지 않음
- UI 어디에서도 `<overarching_mystery>` 태그나 원문 노출 없음

**확인 포인트**:

- ✅ 에이전트 콘솔: Plan/Queue/Badges만 표시
- ✅ API 응답: narrative/ui/world/economy 필드만 포함
- ✅ 프롬프트 원문 미노출

---

### 시나리오 E: i18n (영어) 확인

**목적**: 영어 모드에서도 Overarching Mystery가 동일하게 동작하는지 확인

**실행**:

1. 프로필 선택 화면에서 "한국어" 버튼 클릭 → 영어로 전환
2. 영어 프로필 선택
3. 3턴 이상 진행, 영어 내러티브 관찰

**기대 결과**:

- 영어 내러티브에 "resonance", "forgotten", "pulse", "echo" 등의 힌트가 은은하게 포함
- "Echo" 또는 "the Echo"가 대문자 고유명사로 직접 언급되지 않음
- 미스터리 분위기가 한국어와 동일한 수준으로 유지

**확인 포인트**:

- ✅ 영어 내러티브에 미스터리 힌트 포함
- ✅ 프롬프트 원문 미노출
- ✅ ko/en 양 언어에서 동일한 미스터리 체험

---

## 4. 실행 결과 확인

### 4.1 변경 파일 확인

| 파일 | 변경 내용 |
| --- | --- |
| `backend/prompts/system/game_master.ko.md` | `<overarching_mystery>` 섹션 추가 (v0.3.0) |
| `backend/prompts/system/game_master.en.md` | `<overarching_mystery>` 섹션 추가 (v0.3.0) |
| `backend/prompts/turn/turn_output_instructions.ko.md` | 목표 관리 규칙 8번(Mystery 연결) 추가 (v0.3.0) |
| `backend/prompts/turn/turn_output_instructions.en.md` | 목표 관리 규칙 8번(Mystery 연결) 추가 (v0.3.0) |

### 4.2 성공/실패 판단 기준

**성공**:

- ✅ 5턴 이상 진행 시 매 턴 내러티브에 미스터리 힌트 은은하게 반영
- ✅ 스토리와 퀘스트 방향이 발산하지 않고 일관됨
- ✅ "메아리"/"Echo" 직접 언급 없음 (노골적 언급 금지)
- ✅ 프롬프트 원문 UI 미노출 (RULE-007/008)
- ✅ ko/en 양 언어에서 동일하게 동작
- ✅ Schema OK / Economy OK / Safety OK / Consistency OK 배지 통과

**실패 시 확인**:

- ❌ 미스터리 힌트가 너무 노골적 → `game_master.{ko,en}.md`의 GM 지침 1번(은은한 반영) 강도 조절
- ❌ 미스터리 힌트가 전혀 나타나지 않음 → 시스템 프롬프트 로딩 확인 (백엔드 로그)
- ❌ 스토리가 발산함 → `turn_output_instructions`의 8번 규칙 강화

---

## 5. 문제 해결 (Troubleshooting)

### 5.1 일반적인 오류

**증상**: 내러티브에 미스터리 힌트가 전혀 나타나지 않음

- **원인**: 시스템 프롬프트 파일이 제대로 로드되지 않음
- **해결**: 백엔드 로그에서 프롬프트 파일 경로 확인, `game_master.ko.md` 파일이 올바르게 수정되었는지 확인

**증상**: "메아리"나 "Echo"가 직접 언급됨

- **원인**: GM이 지침의 "노골적 언급 금지"를 무시
- **해결**: `game_master.{ko,en}.md`의 GM 지침 1번에 부정 예시 추가, 또는 프롬프트 강화

**증상**: 미스터리가 특정 장르에만 맞는 표현으로 나옴

- **원인**: GM이 장르 독립성 지침을 무시
- **해결**: `game_master.{ko,en}.md`의 GM 지침 5번(장르 독립성) 강화

### 5.2 환경별 주의사항

- **Windows**: 프롬프트 `.md` 파일의 인코딩이 UTF-8인지 확인
- **macOS/Linux**: 특이사항 없음

---

## 6. 다음 단계

- U-133[Mvp]: 프로필 시작 이미지-스토리 정합성에서 Overarching Mystery를 첫 턴 맥락으로 활용
- CP-MVP-03: 데모 루프에서 "스토리-퀘스트 일관성" 검증
