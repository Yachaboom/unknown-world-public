# U-095 Scanner 아이템 생성 개수 랜덤화 실행 가이드

## 1. 개요

Scanner로 이미지를 업로드할 때 아이템 생성 개수가 1~3개 범위에서 가중치 랜덤(1개=60%, 2개=30%, 3개=10%)으로 결정되도록 구현했습니다. 서버에서 개수를 확정적으로 결정한 뒤 프롬프트에 지시하며, 프론트엔드에서는 발견 개수에 따른 피드백 메시지를 표시합니다.

**예상 소요 시간**: 5분

**의존성**:
- 의존 유닛: U-022[Mvp] (Scanner 아이템화), U-094[Mvp] (파싱 재시도)
- 선행 완료 필요: 백엔드/프론트엔드 서버 구동

---

## 2. 빠른 시작 (Quick Start)

### 2.1 환경 준비

```bash
# 프론트엔드 의존성 설치
pnpm -C frontend install

# 백엔드 의존성 설치
cd backend
uv sync
```

### 2.2 서버 시작

```bash
# 터미널 1: 백엔드 시작 (mock 모드)
cd backend
cp .env.example .env  # UW_MODE=mock 설정
uv run uvicorn unknown_world.main:app --reload --port 8011

# 터미널 2: 프론트엔드 시작
pnpm -C frontend dev
```

### 2.3 접근

- 프론트엔드: http://localhost:8001
- 백엔드 헬스: http://localhost:8011/health

---

## 3. 핵심 기능 시나리오

### 시나리오 A: Mock 모드 - 랜덤 아이템 수 확인

**목적**: Mock 모드에서도 1~3개 아이템이 랜덤으로 생성되는지 확인

**실행**:
1. 브라우저에서 http://localhost:8001 접근
2. Scanner 슬롯에 아무 이미지를 드롭/업로드 (5~10회 반복)

**기대 결과**:
- 매번 1~3개의 아이템 후보가 표시됨
- 1개가 가장 빈번 (~60%), 3개가 가장 드묾 (~10%)
- 아이템 수에 따른 피드백 메시지:
  - 1개: "아이템을 발견했습니다!"
  - 2개: "두 가지를 발견했습니다!"
  - 3개: "세 가지를 발견했습니다! 대단한 발견이네요!"

**확인 포인트**:
- ✅ 아이템 수가 1~3개 범위에서 변동
- ✅ 각 아이템이 고유한 이름/설명을 가짐
- ✅ 피드백 메시지가 아이템 수에 맞게 표시됨
- ✅ 비용 정책 변화 없음 (기존과 동일)

---

### 시나리오 B: Real 모드 - 비전 모델 연동

**목적**: 실제 Gemini 비전 모델에서 지시된 개수만큼 아이템이 생성되는지 확인

**전제 조건**:
- `.env`에 `UW_MODE=real`, `GOOGLE_API_KEY` 설정 완료

**실행**:
1. 백엔드 real 모드로 재시작
2. Scanner에 실제 사진 업로드 (3~5회 반복)

**확인 포인트**:
- ✅ 서버 로그에 `아이템 생성 개수 결정: item_count=N` 기록
- ✅ 반환된 아이템 수가 target_count 이하
- ✅ 중복 이름 아이템 없음

---

### 시나리오 C: 영어 언어 설정 확인

**목적**: 언어 설정에 따라 i18n 메시지가 올바르게 표시되는지 확인

**실행**:
1. 프론트엔드에서 언어를 English로 변경
2. Scanner에 이미지 업로드

**기대 결과**:
- 1개: "You found an item!"
- 2개: "You found two items!"
- 3개: "You found three items! What an amazing discovery!"

**확인 포인트**:
- ✅ 영문 피드백 메시지 정상 표시
- ✅ 아이템 이름/설명도 영문으로 생성

---

### 시나리오 D: 백엔드 로그 확인

**목적**: 아이템 수 결정/조정 로그가 기록되는지 확인

**실행**:
1. 백엔드 서버 로그를 관찰하며 Scanner 업로드 수행

**기대 결과**:
```
[ImageUnderstanding] 아이템 생성 개수 결정 | item_count=2
[Scan] 아이템 수 조정: 5 → 2 (목표: 2)    ← 모델이 초과 생성 시
```

**확인 포인트**:
- ✅ `item_count` 로그 기록됨
- ✅ 조정 발생 시 조정 로그 기록됨

---

## 4. 실행 결과 확인

### 4.1 로그 확인

- 백엔드 콘솔 출력에서 `[ImageUnderstanding]`, `[Scan]` 로그 확인
- 주요 로그:
  - `[INFO] 아이템 생성 개수 결정`: 정상 (랜덤 결정)
  - `[INFO] 아이템 수 조정`: 모델 응답이 목표와 다를 때
  - `[WARNING] 파싱 실패, 재시도`: U-094 재시도 발생 시

### 4.2 성공/실패 판단 기준

**성공**:
- ✅ Mock/Real 모두에서 1~3개 아이템이 랜덤 생성
- ✅ 프론트엔드에서 피드백 메시지 표시 (i18n ko/en 모두)
- ✅ 각 아이템이 고유한 이름/설명을 가짐
- ✅ 비용 정책 불변 (1회 스캔 비용, 아이템 수와 무관)

**실패 시 확인**:
- ❌ 항상 같은 수의 아이템 → `determine_item_count()` 호출 여부 확인
- ❌ 피드백 메시지 미표시 → i18n 키 확인 (`scanner.discovery_message.*`)
- ❌ 모델이 지시 무시 → 서버 로그에서 조정 로그 확인

---

## 5. 문제 해결 (Troubleshooting)

### 5.1 일반적인 오류

**오류**: 항상 2개 아이템만 반환됨 (Mock 모드)
- **원인**: `_create_mock_scan_result()`에 `item_count` 전달 누락
- **해결**: `analyze()`에서 `item_count=determine_item_count()` 확인

**오류**: Real 모드에서 아이템 수가 지시와 다름
- **원인**: LLM이 프롬프트 지시를 완벽히 따르지 않을 수 있음
- **해결**: `_adjust_item_count()`가 초과분을 자동 트림함 (정상 동작)

**오류**: 피드백 메시지가 키 이름 그대로 표시됨
- **원인**: i18n 리소스 키 누락
- **해결**: `ko-KR/translation.json`, `en-US/translation.json`에 `scanner.discovery_message.*` 키 확인

### 5.2 환경별 주의사항

- **Windows**: 경로 구분자 이슈 없음 (파일 수정만)
- **macOS/Linux**: 동일하게 동작

---

## 6. 다음 단계

- U-096: 아이템 사용 시 소비(삭제) 로직
- CP-MVP-03: Scanner 데모 시나리오 풍부화
