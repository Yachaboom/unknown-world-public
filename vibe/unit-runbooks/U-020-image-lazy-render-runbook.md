# U-020[Mvp] 이미지 Lazy Render 실행 가이드

## 1. 개요

Scene Canvas에 조건부 장면 이미지를 표시하되, 이미지 생성 지연/실패가 UX를 망치지 않도록 **Lazy loading + placeholder + 텍스트-only 폴백**을 구현했습니다.

- **Q1 결정 (Option A)**: 새 이미지 로딩 중에도 이전 이미지를 유지하고, 로딩 인디케이터로 진행 상황을 표시합니다.
- **RULE-004/008 준수**: 이미지 실패 시에도 핫스팟/패널/로그는 계속 동작하며, 텍스트-only로 안전하게 진행됩니다.
- **RULE-009 준수**: 핫스팟 좌표(0~1000 정규화)는 이미지 유무와 무관하게 정확히 렌더됩니다.

**예상 소요 시간**: 10분

**의존성**:
- 의존 유닛: U-010 (핫스팟 오버레이), U-019 (이미지 생성 엔드포인트)
- 선행 완료 필요: 백엔드 서버 실행 중

---

## 2. 빠른 시작 (Quick Start)

### 2.1 환경 준비

```bash
# 프론트엔드 의존성 설치
cd frontend && pnpm install

# 백엔드 의존성 설치 (필요 시)
cd backend && pip install -e .
```

### 2.2 개발 서버 시작

```bash
# 백엔드 서버 (포트 8011)
cd backend/src && python -m uvicorn unknown_world.main:app --host 0.0.0.0 --port 8011 --reload

# 프론트엔드 서버 (포트 8001)
cd frontend && pnpm dev --port 8001
```

### 2.3 즉시 실행

브라우저에서 `http://localhost:8001` 접속

### 2.4 첫 화면/결과 확인

- Scene Canvas에 placeholder 이미지와 "NO SIGNAL DATA" 또는 유사한 상태 라벨이 표시됩니다.
- 핫스팟(녹색 테두리의 클릭 가능 영역)이 placeholder 위에 렌더됩니다.

---

## 3. 핵심 기능 시나리오

### 시나리오 A: Placeholder 표시 (이미지 없음)

**목적**: 이미지 URL이 없을 때 적절한 placeholder가 표시되는지 검증

**실행**:
1. 프로필을 선택하여 게임 시작
2. Scene Canvas 영역 확인

**기대 결과**:
- "NO SIGNAL DATA" 또는 프로필별 기본 placeholder 이미지 표시
- 핫스팟이 있다면 placeholder 위에 오버레이로 표시됨

**확인 포인트**:
- ✅ Placeholder 이미지/라벨 표시
- ✅ 핫스팟 클릭 가능 (disabled 상태가 아닌 경우)

---

### 시나리오 B: 스트리밍 중 로딩 상태 표시

**목적**: 턴 실행 중 적절한 로딩 상태가 표시되는지 검증

**실행**:
1. Action Deck에서 "EXPLORE" 또는 다른 액션 카드 클릭
2. Scene Canvas 영역 즉시 관찰

**기대 결과**:
- "SYNCHRONIZING..." + "Synchronizing data..." 메시지 표시
- Agent Console이 "PROCESSING" 상태로 전환
- 모든 버튼이 disabled 상태

**확인 포인트**:
- ✅ 로딩 상태 메시지 표시
- ✅ 스트리밍 중 상호작용 차단

---

### 시나리오 C: 이미지 로딩 중 이전 이미지 유지 (Q1 Option A)

**목적**: 새 이미지 로딩 중에도 이전 이미지가 유지되는지 검증

**전제 조건**:
- 이미 표시된 장면 이미지가 있어야 함 (실제 이미지 생성 API 필요)
- Mock 모드에서는 이미지가 생성되지 않으므로 실제 API 환경 필요

**실행**:
1. 이미지가 있는 상태에서 새 턴 실행
2. Scene Canvas 관찰

**기대 결과**:
- 새 이미지 로딩 중에도 이전 이미지가 계속 표시됨
- 우하단에 로딩 인디케이터 표시 (스피너 + "장면 이미지 로딩 중...")
- 하단에 로딩 진행 바(progress bar) 애니메이션

**확인 포인트**:
- ✅ 이전 이미지 유지
- ✅ 로딩 인디케이터 표시
- ✅ 로딩 완료 시 새 이미지로 페이드 인 전환

---

### 시나리오 D: 이미지 로드 실패 시 폴백 (RULE-004)

**목적**: 이미지 로드 실패 시에도 게임이 계속 진행되는지 검증

**실행**:
1. 네트워크 탭에서 이미지 요청을 차단하거나
2. 잘못된 이미지 URL이 반환되는 상황 시뮬레이션

**기대 결과**:
- 이미지 에러 배지 표시 (우상단, "⚠️ 장면 이미지를 불러올 수 없습니다.")
- 이전 이미지가 있으면 계속 표시
- 이전 이미지가 없으면 placeholder 표시
- 핫스팟/내러티브/액션 카드는 정상 동작

**확인 포인트**:
- ✅ 에러 배지 표시
- ✅ 게임 진행 계속 가능
- ✅ 핫스팟 상호작용 정상

---

### 시나리오 E: 핫스팟 이미지 무관 동작 (RULE-009)

**목적**: 이미지 유무와 무관하게 핫스팟이 정상 렌더/동작하는지 검증

**실행**:
1. 핫스팟이 있는 턴 실행 (프로필 초기 상태에서 확인 가능)
2. 핫스팟 호버 및 클릭

**기대 결과**:
- 핫스팟(녹색 테두리)이 Scene Canvas 위에 표시
- 호버 시 하이라이트 + 툴팁 표시
- 클릭 시 해당 오브젝트와 상호작용 실행

**확인 포인트**:
- ✅ 핫스팟 렌더링 (이미지 유무 무관)
- ✅ 호버 효과 정상
- ✅ 클릭 이벤트 정상

---

## 4. 실행 결과 확인

### 4.1 CSS 클래스 확인 (개발자 도구)

- `.scene-canvas.image-loading`: 이미지 로딩 중 상태
- `.scene-loading-indicator`: 로딩 인디케이터 컨테이너
- `.scene-loading-spinner`: 로딩 스피너
- `.scene-error-badge`: 이미지 에러 배지
- `.scene-image.scene-image-loaded`: 로드 완료된 이미지 (페이드 인)

### 4.2 상태 확인 (React DevTools)

SceneCanvas 컴포넌트에서 확인할 수 있는 상태:
- `displayImageUrl`: 현재 표시 중인 이미지 URL
- `loadingImageUrl`: 현재 로딩 중인 이미지 URL
- `imageError`: 이미지 로드 에러 여부
- `imageLoadingState`: 파생 상태 ('idle' | 'loading' | 'loaded' | 'error')

### 4.3 성공/실패 판단 기준

**성공**:
- ✅ 이미지 없을 때 placeholder 표시
- ✅ 이미지 로딩 중 인디케이터 표시 (Option A: 이전 이미지 유지)
- ✅ 이미지 로드 실패 시 에러 배지 + 게임 진행 계속
- ✅ 핫스팟이 이미지 유무와 무관하게 동작

**실패 시 확인**:
- ❌ 이미지 로딩이 시작되지 않음 → 네트워크/API 확인
- ❌ 핫스팟이 표시되지 않음 → `sceneObjects` 상태 확인
- ❌ 로딩 인디케이터가 표시되지 않음 → CSS 클래스 확인

---

## 5. 문제 해결 (Troubleshooting)

### 5.1 일반적인 오류

**오류**: 이미지가 전혀 로드되지 않음
- **원인**: Mock 모드에서는 실제 이미지가 생성되지 않음
- **해결**: `UW_MODE=real` 환경변수와 함께 실제 Gemini API 사용

**오류**: 로딩 인디케이터가 표시되지 않음
- **원인**: CSS 파일이 로드되지 않았거나 클래스 누락
- **해결**: 개발자 도구에서 `.scene-loading-indicator` 클래스 존재 확인

**오류**: 핫스팟이 클릭되지 않음
- **원인**: 스트리밍 중 disabled 상태이거나 z-index 문제
- **해결**: Agent Console이 IDLE 상태인지 확인

### 5.2 환경별 주의사항

- **Windows**: 파일 경로에 한글 포함 시 문제 발생 가능
- **macOS/Linux**: 포트 충돌 시 8002~8010 범위 사용

---

## 6. 다음 단계

이 유닛을 기반으로:
1. **U-022**: Scanner 슬롯에서 "이미지 기반 상호작용" 추가
2. **U-035**: rembg 배경 제거 파이프라인 통합
3. **CP-MVP-03**: 데모에서 "이미지 실패해도 진행되는" 안정성 증거로 활용
