# U-063[Mvp] 프론트엔드 턴 실행 후 재화 잔액 버그 수정 실행 가이드

## 1. 개요

턴 실행 후 재화(Signal/Shard)가 0으로 초기화되는 버그를 수정했습니다. 이 버그는 Zod 스키마 검증 실패 시 폴백 TurnOutput에서 `balance_after`가 `{ signal: 0, memory_shard: 0 }`으로 하드코딩되어 있어 발생했습니다.

**예상 소요 시간**: 10분

**의존성**:
- 의존 유닛: U-055[Mvp] (이미지 파이프라인 통합 검증에서 발견된 이슈)
- 선행 완료 필요: 없음 (독립 실행 가능)

---

## 2. 빠른 시작 (Quick Start)

### 2.1 환경 준비

```bash
# 프로젝트 루트에서 의존성 설치
pnpm install
```

### 2.2 개발 서버 시작

```bash
# 프로젝트 루트에서 실행
pnpm dev
```

또는 별도로:

```bash
# 백엔드 (포트 8011)
pnpm dev:back

# 프론트엔드 (포트 8001)
pnpm dev:front
```

### 2.3 첫 화면 확인

- 브라우저에서 http://localhost:8001 접속
- 프로필 선택 화면이 표시됨
- 성공 지표: "프로필을 선택하세요" 메시지 표시

---

## 3. 핵심 기능 시나리오

### 시나리오 A: 정상 턴 실행 후 재화 차감 확인

**목적**: 턴 실행 후 재화가 올바르게 차감되는지 확인

**실행**:
1. "서사꾼" 프로필 선택
2. 게임 화면에서 초기 재화 확인: Signal: 200, Shard: 10
3. "탐색하기" 액션 카드 클릭
4. 턴 완료 후 재화 확인

**기대 결과**:
- 턴 완료 후 Signal이 차감됨 (예: 200 → 196~199)
- Shard는 유지됨 (10)
- "잔액이 부족합니다" 경고 미표시
- 거래 장부에 새 엔트리 추가됨

**확인 포인트**:
- ✅ Signal이 0이 아닌 차감된 값으로 표시
- ✅ Shard가 0이 아닌 유지된 값으로 표시
- ✅ 액션 카드들이 "잔액 부족"으로 비활성화되지 않음

---

### 시나리오 B: 폴백 응답에서 재화 유지 확인

**목적**: 스키마 검증 실패 시 폴백 응답에서도 재화가 유지되는지 확인

**실행**:
1. "서사꾼" 프로필 선택 (Signal: 200, Shard: 10)
2. 텍스트 입력창에 임의 텍스트 입력 후 "실행" 클릭
3. 턴 완료 후 재화 확인

**전제 조건**:
- Mock 모드에서 실행 (UW_MODE=mock)
- 스키마 검증 실패가 발생하면 폴백 응답 사용

**기대 결과**:
- 폴백 응답이 반환되더라도 Signal/Shard가 0이 아님
- 이전 재화 스냅샷이 유지됨 (200, 10)
- "잔액이 부족합니다" 경고 미표시

**확인 포인트**:
- ✅ 폴백 응답 시에도 재화가 유지됨
- ✅ 게임 진행 가능 (카드 활성화)

---

### 시나리오 C: 여러 턴 연속 실행

**목적**: 여러 턴을 연속 실행해도 재화가 일관되게 차감되는지 확인

**실행 순서**:
1. **Step 1**: "서사꾼" 프로필 선택
   - 결과: Signal: 200, Shard: 10

2. **Step 2**: "탐색하기" 클릭
   - 결과: Signal 차감 (예: 196)

3. **Step 3**: "조사하기" 클릭
   - 결과: Signal 추가 차감 (예: 194)

4. **Step 4**: "대화하기" 클릭
   - 최종 산출물: Signal이 일관되게 차감됨, 0으로 초기화되지 않음

---

## 4. 실행 결과 확인

### 4.1 로그 확인

브라우저 개발자 도구 콘솔에서 확인:
- `[TurnStream]` 프리픽스 로그: 스트림 이벤트 처리 상태
- 경고 메시지: `[TurnStream] TurnOutput validation failed` (폴백 사용 시)

### 4.2 성공/실패 판단 기준

**성공**:
- ✅ 턴 실행 후 재화가 0이 아닌 차감된 값으로 표시
- ✅ 폴백 응답에서도 재화가 유지됨
- ✅ 여러 턴 연속 실행 시 일관된 차감
- ✅ "잔액이 부족합니다" 경고가 실제 부족 시에만 표시

**실패 시 확인**:
- ❌ Signal/Shard가 0으로 표시 → 수정 누락 확인
- ❌ 폴백 응답에서 재화가 0 → `createFallbackTurnOutput` 함수 확인
- ❌ 턴이 완료되지 않음 → 백엔드 로그 확인

---

## 5. 문제 해결 (Troubleshooting)

### 5.1 일반적인 오류

**오류**: 턴 실행 후 재화가 여전히 0으로 표시됨
- **원인**: 브라우저 캐시에 이전 코드가 남아있음
- **해결**: 
  1. 브라우저 하드 리프레시 (Ctrl+Shift+R)
  2. localStorage 삭제 (DevTools > Application > Local Storage > Clear)
  3. 프론트엔드 서버 재시작

**오류**: 턴이 완료되지 않고 멈춤
- **원인**: 백엔드 응답 지연 또는 네트워크 오류
- **해결**: 
  1. 백엔드 로그 확인 (`pnpm dev:back` 터미널)
  2. CORS 설정 확인 (프론트 8001, 백엔드 8011)
  3. 서버 재시작

### 5.2 환경별 주의사항

- **Windows**: 포트 충돌 시 `pnpm kill` 실행 후 재시작
- **macOS/Linux**: 특이사항 없음

---

## 6. 수정된 파일

| 파일 경로 | 변경 유형 | 설명 |
|----------|----------|------|
| `frontend/src/schemas/turn.ts` | 수정 | `createFallbackTurnOutput`, `safeParseTurnOutput`에 `economySnapshot` 파라미터 추가 |
| `frontend/src/api/turnStream.ts` | 수정 | `createFallbackTurnOutput`, `dispatchEvent`에 `economySnapshot` 파라미터 추가 |
| `vibe/debt-log.md` | 수정 | 해당 이슈 ✅ 해결됨으로 표시 |

---

## 7. 검증 체크리스트

- [ ] 프로필 선택 후 초기 재화 정상 표시 (200, 10)
- [ ] 첫 번째 턴 실행 후 재화 차감 (0이 아님)
- [ ] 두 번째 턴 실행 후 재화 추가 차감
- [ ] 폴백 응답에서도 재화 유지
- [ ] "잔액이 부족합니다" 경고 정상 동작
- [ ] 거래 장부에 비용 기록됨
