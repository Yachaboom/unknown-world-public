# U-045[Mvp]: Backend 시작 시 rembg/모델 사전 점검 + 다운로드(preflight) 개발 완료 보고서

## 메타데이터

- **작업 ID**: U-045[Mvp]
- **단계 번호**: 3.5
- **작성 일시**: 2026-01-28 15:30
- **담당**: AI Agent

---

## 1. 작업 요약

백엔드 서버 시작 시점에 `rembg` 설치 상태와 필수 모델(`birefnet-general`) 캐시를 점검하고, 부재 시 자동 다운로드를 수행하는 프리플라이트(Preflight) 시스템을 구축했습니다. 이를 통해 첫 이미지 생성/후처리 시 발생하는 대용량 모델 다운로드 지연을 제거하고 서비스 안정성을 확보했습니다.

---

## 2. 작업 범위

- [x] **Preflight 서비스 구축**: `rembg` 설치 여부 및 모델 캐시 경로(`.u2net/`) 점검 로직 구현
- [x] **자동 다운로드 통합**: 모델 부재 시 `rembg d <model>` 명령어를 서브프로세스로 실행하여 사전 확보
- [x] **FastAPI Lifespan 연동**: 서버 부팅 시 비동기적으로 프리플라이트를 실행하고 결과를 `app.state`에 저장
- [x] **Health 엔드포인트 확장**: `/health` 호출 시 `rembg` 준비 상태(ready/degraded/unavailable) 및 상세 정보 반환
- [x] **런타임 가드 로직 적용**: 이미지 후처리 시 프리플라이트 성공 여부를 확인하여 요청 중 다운로드 발생 원천 차단 (실패 시 즉시 안전 폴백)

---

## 3. 생성/수정 파일

| 파일 경로 | 유형 | 목적 |
| --- | --- | --- |
| `backend/src/unknown_world/services/rembg_preflight.py` | 신규 | 프리플라이트 점검 및 다운로드 핵심 엔진 |
| `backend/src/unknown_world/main.py` | 수정 | Lifespan 연동 및 Health 엔드포인트 확장 |
| `backend/src/unknown_world/services/image_postprocess.py` | 수정 | 프리플라이트 상태 기반 런타임 가드 추가 |
| `backend/tests/unit/services/test_rembg_preflight.py` | 신규 | 프리플라이트 로직 단위 테스트 |
| `backend/tests/unit/test_image_postprocess.py` | 수정 | 프리플라이트 미준비 시 폴백 인바리언트 검증 추가 |
| `vibe/unit-runbooks/U-045-rembg-preflight-runbook.md` | 신규 | 프리플라이트 실행 및 검증 가이드 |

---

## 4. 구현 상세

### 4.1 핵심 설계

**주요 계약**:

- `run_preflight_async(config?) -> RembgPreflightResult`: 서버 시작 시 호출되는 메인 진입점
- `is_rembg_available() -> bool`: 후처리 서비스에서 런타임 가드를 위해 참조하는 상태 함수

**설계 패턴/원칙**:

- **Option A (Timeout-based Degraded)**: 부팅 지연 최소화를 위해 짧은 타임아웃(120s)을 적용하고, 실패 시 서비스를 중단하는 대신 'degraded' 모드로 시작 (RULE-004 준수)
- **Lazy Initialization**: 프리플라이트 인스턴스를 싱글톤으로 관리하여 중복 실행 방지 및 상태 공유

### 4.2 외부 영향 분석

- **데이터/파일 시스템**: 유저 홈 디렉토리의 `.u2net/` 폴더에 모델 파일(약 100MB)이 생성됩니다.
- **네트워크**: 첫 실행 시 또는 모델 부재 시 모델 다운로드를 위해 외부망 연결이 필요합니다.
- **부팅 속도**: 모델 다운로드 시 네트워크 속도에 따라 초기 구동 시간이 최대 2분까지 증가할 수 있습니다.

### 4.3 가정 및 제약사항

- `rembg` 명령어가 시스템 경로(PATH)에 등록되어 있어야 합니다. (uv 환경 권장)
- 모델 다운로드 성공 여부는 `.onnx` 파일의 존재 여부로 최종 판단합니다.

---

## 5. 런북(Runbook) 정보

- **파일 경로**: `vibe/unit-runbooks/U-045-rembg-preflight-runbook.md`
- **실행 결과**: 정상 설치 환경에서 "READY" 상태 확인 및 모델 부재 시 자동 다운로드 후 정상 서비스됨을 검증 완료

---

## 6. 리스크 및 주의사항

- **배포 환경**: Docker 환경 등에서 쓰기 권한이 없는 경우 모델 다운로드에 실패할 수 있으므로, 빌드 시점에 모델을 미리 포함하거나 런타임 볼륨 마운트가 필요할 수 있습니다.
- **네트워크 차단**: 폐쇄망 환경에서는 프리플라이트가 실패하므로 수동으로 모델을 배치해야 합니다.

---

## 7. 다음 단계 안내

### 7.1 후속 작업

1. **U-046[Mvp]**: 분리 프롬프트(.md) XML 태그 규격 통일 및 로더 파싱 단일화
2. **CP-MVP-05**: 멀티모달 이미지 게이트 통합 검증

---

## 8. 자체 점검 결과

- [x] 런북 기반 요구사항 충족 확인
- [x] 프리플라이트 실패 시에도 서버는 정상 기동됨 (RULE-004)
- [x] `/health` 엔드포인트에서 상세 상태 확인 가능
- [x] 런타임 중 대용량 다운로드 발생 차단 확인

---

_본 보고서는 AI Agent에 의해 자동 생성되었습니다._
