# U-094[Mvp]: ImageUnderstanding 응답 파싱 예외 시 자동 재시도 개발 완료 보고서

## 메타데이터

- **작업 ID**: U-094[Mvp]
- **단계 번호**: 2.3
- **작성 일시**: 2026-02-07 15:45
- **담당**: AI Agent

---

## 1. 작업 요약

Scanner(`POST /api/scan`)의 핵심 서비스인 `ImageUnderstandingService`에 응답 파싱 실패 시 자동 재시도 로직(Repair loop)을 구현했습니다. 이를 통해 Gemini 비전 모델의 간헐적인 형식 오류에 대한 복원력을 확보하고 사용자에게 노출되는 분석 실패 빈도를 최소화했습니다.

---

## 2. 작업 범위

- **재시도 메커니즘 구현**: 최대 2회 자동 재시도 (총 3회 시도) 및 지수 백오프(1초, 2초) 적용
- **프롬프트 강화**: 재시도 시 JSON 형식을 강제하는 보정 지시어(`SCAN_RETRY_REINFORCEMENT`) 동적 추가
- **예외 필터링**: 안전 차단(Safety Block), 인증 실패(401), 할당량 초과(429) 등 재시도가 불필요한 경우 즉시 폴백 처리
- **안전한 폴백**: 모든 시도 실패 시 i18n 메시지를 포함한 표준화된 폴백 응답(`ScanResult`) 반환
- **관측 가능성 확보**: 재시도 횟수, 백오프 시간, 최종 결과 등을 구조화된 로그로 기록

---

## 3. 생성/수정 파일

| 파일 경로 | 유형 | 목적 |
| --- | --- | --- |
| `backend/src/unknown_world/services/image_understanding.py` | 수정 | 재시도 로직(`_call_vision_model`) 및 파싱 보정 기능 추가 |
| `backend/src/unknown_world/api/scanner.py` | 참조 | 엔드포인트에서 서비스의 재시도 로직 활용 확인 |
| `vibe/unit-runbooks/U-094-scan-retry-runbook.md` | 신규 | 기능 검증을 위한 런북 작성 |

---

## 4. 구현 상세

### 4.1 핵심 설계

**주요 로직**:
- `_call_vision_model(image_content, content_type, language)`: 
  - 루프를 통해 `_execute_single_vision_call`을 호출하며 `SCAN_MAX_RETRIES`만큼 재시도.
  - 파싱 성공(`ScanStatus.COMPLETED`) 시 즉시 반환.
  - 안전 차단(`ScanStatus.BLOCKED`) 시 재시도 중단.

**설계 패턴/원칙**:
- **Repair Loop**: U-018의 비즈니스 룰 복구 패턴을 비전 파이프라인에 맞게 변형 적용.
- **Fail-fast**: 재시도 불가 에러를 조기에 판별하여 불필요한 지연과 비용 발생 방지.

### 4.2 외부 영향 분석

- **데이터/파일 시스템**: 변경 없음.
- **비용**: 재시도 시 동일 이미지 데이터가 전송되므로 토큰 비용 발생 (Flash 모델 사용으로 비용 최적화).
- **성능**: 파싱 실패 시 백오프로 인해 응답 지연이 발생할 수 있으나, 완전 실패 대신 성공 확률을 높이는 UX적 이득이 큼.

### 4.3 가정 및 제약사항

- 재시도 시 온도(Temperature) 등의 하이퍼파라미터는 변경하지 않고, 비결정성과 프롬프트 강화에 의존함.
- `google-genai` SDK의 `response_mime_type="application/json"` 설정을 기본으로 사용함.

---

## 5. 런북(Runbook) 정보

- **파일 경로**: `vibe/unit-runbooks/U-094-scan-retry-runbook.md`
- **실행 결과**: 런북에 정의된 시나리오(정상 스캔, 영어 스캔, 재시도 로그 확인)를 통해 기능 검증 완료.

---

## 6. 리스크 및 주의사항

- **안전 정책 차단**: 재시도로 해결되지 않는 'Safety Block' 발생 시 즉시 사용자에게 안내 필요 (현재 폴백 메시지로 처리됨).
- **무한 루프 방지**: `SCAN_MAX_RETRIES` 상수를 통해 엄격하게 시도 횟수 제한.

---

## 7. 다음 단계 안내

### 7.1 후속 작업

1. **U-095**: Scanner 아이템 생성 개수 랜덤화 (안정적인 파싱 결과 기반)
2. **부하 테스트**: 동시 요청 시 재시도 로직이 서버 자원에 미치는 영향 모니터링

---

## 8. 자체 점검 결과

- [x] 런북 기반 요구사항 충족 확인
- [x] Repomix 최신 구조 반영 확인
- [x] 아키텍처/네이밍/경로 일관성 유지
- [x] 파괴적 변경/리스크/가정 명시

---

_본 보고서는 AI Agent에 의해 자동 생성되었습니다._
