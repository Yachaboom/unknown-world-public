# U-054[Mvp] 이미지 생성 폴백 및 실패 복구 체계 강화 개발 완료 보고서

## 메타데이터

- **작업 ID**: U-054[Mvp]
- **단계 번호**: 2.3
- **작성 일시**: 2026-02-01 17:30
- **담당**: AI Agent

---

## 1. 작업 요약

이미지 생성 중 발생할 수 있는 다양한 예외(안전 정책 차단, 타임아웃, 네트워크 오류 등) 상황에서 RULE-004에 따라 시스템이 중단되지 않고 안전하게 "텍스트 전용 모드"로 폴백되는 체계를 강화했습니다. 재시도 없이 즉시 폴백(Option A)하여 사용자 지연을 최소화합니다.

---

## 2. 작업 범위

- **예외 처리 구조화**: `render_stage` 내 이미지 생성 호출 시 `TimeoutError`, `ValueError`, `TypeError` 및 일반 예외에 대한 포괄적 가드 구축
- **안전 정책 차단(Safety Blocked) 감지**: 응답 메시지 내 키워드 분석을 통해 안전 차단 여부를 판별하고 `TurnOutput.safety` 필드 동기화
- **다국어 폴백 메시지**: `ko-KR`, `en-US` 언어 정책(RULE-006)에 따른 전용 폴백 메시지 반환 로직 구현
- **배지 시스템 연동**: 안전 차단 시 `SAFETY_OK` 배지를 제거하고 `SAFETY_BLOCKED` 배지를 즉시 반영하는 관측성 강화
- **재화 부족 폴백**: Signal 잔액 부족 시 내러티브 하단에 폴백 안내 문구를 자동 삽입하는 로직 구현

---

## 3. 생성/수정 파일

| 파일 경로 | 유형 | 목적 |
| --- | --- | --- |
| `backend/src/unknown_world/orchestrator/stages/render.py` | 수정 | 예외 처리 로직 통합 및 폴백 실행 제어 |
| `backend/src/unknown_world/orchestrator/stages/render_helpers.py` | 수정 | 폴백 결과 생성, 안전 차단 감지 및 i18n 메시지 헬퍼 추가 |
| `backend/tests/unit/orchestrator/test_u054_image_fallback.py` | 신규 | 폴백 시나리오(성공/차단/실패/타임아웃/잔액부족) 단위 테스트 |
| `vibe/unit-runbooks/U-054-image-fallback-recovery-runbook.md` | 신규 | 폴백 동작 수동 검증 가이드 |

---

## 4. 구현 상세

### 4.1 핵심 설계

**폴백 데이터 모델**:
- `ImageFallbackResult`: 폴백 사유, 메시지, 안전 업데이트 여부를 포함한 불변 데이터 클래스

**주요 함수**:
- `create_image_fallback_result(status_message, language)`: 실패 원인에 따른 최적의 폴백 객체 생성
- `is_safety_blocked(message)`: "safety", "blocked", "policy" 등 키워드 기반 안전 차단 판별
- `_apply_image_fallback(ctx, fallback_result)`: 파이프라인 컨텍스트에 안전 정보 및 배지 반영

### 4.2 외부 영향 분석

- **데이터/파일 시스템**: 이미지 생성 실패 시 `image_url`이 `None`으로 설정되나 프론트엔드(U-020)에서 이미 이를 처리하도록 구현되어 있음
- **권한/보안**: 안전 차단 시 사용자에게 차단 사실을 명확히 알리되, RULE-007에 따라 상세 원인이나 프롬프트 내용은 노출하지 않음
- **빌드/의존성**: 신규 의존성 없음

### 4.3 가정 및 제약사항

- **재시도 정책**: 지연 시간 최소화를 위해 MVP에서는 재시도 없이 즉시 폴백함 (Q1: Option A)
- **메시지 기반 감지**: 현재 안전 차단 감지는 텍스트 메시지 키워드 매칭에 의존함 (추후 모델 응답의 Enum 값으로 고도화 가능)

---

## 5. 런북(Runbook) 정보

- **파일 경로**: `vibe/unit-runbooks/U-054-image-fallback-recovery-runbook.md`
- **실행 결과**: 정상 이미지 생성, 안전 차단, 일반 실패, 타임아웃, 언어별 메시지 등 5대 시나리오 검증 완료
- **참조**: 상세 실행 방법은 위 런북 파일 참조

---

## 6. 리스크 및 주의사항

- **차단 사유 오판정**: 일반 오류 메시지에 "policy" 등의 단어가 포함될 경우 안전 차단으로 오판정할 수 있으나, 시스템의 안정성 측면에서는 보수적 처리가 더 안전함

---

## 7. 다음 단계 안내

### 7.1 후속 작업

1. **U-055**: Mock/Real 모드에서 폴백 시나리오 통합 검증
2. **린트 및 타입 체크 실행**

### 7.2 의존 단계 확인

- **선행 단계**: U-053[Mvp] 완료
- **후속 단계**: U-055[Mvp] (이미지 파이프라인 통합 검증)

---

## 8. 자체 점검 결과

- [x] 런북 기반 요구사항 충족 확인
- [x] Repomix 최신 구조 반영 확인
- [x] 아키텍처/네이밍/경로 일관성 유지
- [x] 파괴적 변경/리스크/가정 명시

---

_본 보고서는 AI Agent에 의해 자동 생성되었습니다._
