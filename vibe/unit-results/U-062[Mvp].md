# U-062[Mvp]: MockOrchestrator 영어 입력 시 LanguageGate 수정 개발 완료 보고서

## 메타데이터

- **작업 ID**: U-062[Mvp]
- **단계 번호**: MVP
- **작성 일시**: 2026-02-01 22:30
- **담당**: AI Agent

---

## 1. 작업 요약

MockOrchestrator에서 사용자 입력 텍스트가 행동 로그 프리픽스에 포함되어 발생하는 언어 혼합 문제(한국어 세션에 영어 입력 등)를 해결하였습니다. 사용자 입력 텍스트를 프리픽스에서 제외함으로써 LanguageGate의 언어 일관성 검증(`CONSISTENCY_FAIL`)을 안정적으로 통과하게 되었습니다.

---

## 2. 작업 범위

- **MockOrchestrator 프리픽스 로직 수정**: `KO_ACTION_LOG_PREFIXES`, `EN_ACTION_LOG_PREFIXES` 및 `_format_action_log_prefix` 함수를 수정하여 사용자 입력 텍스트(`text`, `action_id`)를 포함하지 않도록 변경.
- **언어 정합성 확보**: 시스템이 생성한 오브젝트 ID(DROP/CLICK 시)는 유지하되, 언어 혼합의 원인이 되는 자유 텍스트 입력을 차단하여 RULE-006 준수.
- **결정적 다양성 유지**: 사용자 입력 텍스트는 프리픽스에서는 제외되지만, `_compute_turn_seed`에는 여전히 포함되어 입력별로 다른 내러티브가 생성되는 결정적 다양성은 보존됨.

---

## 3. 생성/수정 파일

| 파일 경로 | 유형 | 목적 |
| --------- | ---- | ---- |
| `backend/src/unknown_world/orchestrator/mock.py` | 수정 | 행동 로그 프리픽스 생성 로직 수정 (사용자 입력 텍스트 제외) |

---

## 4. 구현 상세

### 4.1 핵심 설계

**언어 혼합 방지 정책 (Option A)**:
- 사용자 입력 텍스트가 영어이고 세션 언어가 한국어일 경우, `[시도] explore the cave: ...`와 같이 출력되어 LanguageGate에서 실패하던 현상을 해결하기 위해 프리픽스를 `[시도] ...`로 단순화함.
- **예외**: `DROP` 및 `CLICK` 인터랙션 시 사용되는 `item_id`와 `object_id`는 시스템이 정의한 식별자이므로 언어 혼합 위험이 낮아 프리픽스에 유지함.

**코드 변경점**:
- `_format_action_log_prefix` 함수에서 `format_args` 구성 시 `turn_input.text` 및 `turn_input.action_id` 사용을 중단함.

### 4.2 외부 영향 분석

- **검증 파이프라인**: LanguageGate의 `CONSISTENCY_FAIL` 발생 빈도가 낮아져 불필요한 repair loop 및 폴백 전이가 감소함.
- **이미지 생성**: 정상적인 턴 응답이 반환됨에 따라, 이미지 생성 지침(`scene_prompt`)이 포함된 `image_job`이 정상적으로 생성 및 실행됨.

### 4.3 가정 및 제약사항

- 사용자 입력 텍스트가 프리픽스에서 사라짐에 따라 "내가 무엇을 입력했는지"에 대한 명시적 Echo가 내러티브 상단에서 사라짐. 이는 향후 별도의 Action Log UI 요소로 보완할 것을 권장함.

---

## 5. 런북(Runbook) 정보

- **파일 경로**: `vibe/unit-runbooks/U-062-runbook.md` (계획서 내 시나리오 기반 수동 검증 완료)
- **실행 결과**: 영어 입력 시 한국어 세션에서 LanguageGate "OK" 확인 및 정상 스트리밍 완료.

---

## 6. 리스크 및 주의사항

- **Real 모드 적용**: Mock 모드뿐만 아니라 Real 모드(Gemini)에서도 시스템 프롬프트를 통해 사용자 입력을 그대로 인용하지 않도록 지침이 강화되어야 함 (U-061에서 일부 반영됨).

---

## 7. 다음 단계 안내

### 7.1 후속 작업

1. **U-063[Mvp]**: 프론트엔드 턴 실행 후 재화 잔액 버그 수정
2. **U-064[Mvp]**: Gemini 이미지 생성 API 호출 방식 수정

### 7.2 의존 단계 확인

- **선행 단계**: U-055[Mvp] (이미지 파이프라인 통합) 완료
- **후속 단계**: CP-MVP-03 (10분 데모 루프)

---

## 8. 자체 점검 결과

- [x] 런북 기반 요구사항 충족 확인
- [x] Repomix 최신 구조 반영 확인
- [x] 언어 혼합 방지 (RULE-006) 준수 확인
- [x] 결정적 다양성 유지 확인

---

_본 보고서는 AI Agent에 의해 자동 생성되었습니다._
