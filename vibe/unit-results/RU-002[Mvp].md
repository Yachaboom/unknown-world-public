# [RU-002[Mvp]: 리팩토링 - validation/폴백/이벤트 타입 통일] 개발 완료 보고서

## 메타데이터

- **작업 ID**: RU-002[Mvp]
- **단계 번호**: 1.2
- **작성 일시**: 2026-01-10 11:30
- **담당**: AI Agent

---

## 1. 작업 요약

스트림 이벤트(NDJSON), 검증, 폴백 로직이 분산되어 발생하던 불일치를 해결하고, "스키마/경제/안전" 하드 게이트 실패 시에도 일관된 방식으로 표시 및 복구가 가능하도록 서버와 클라이언트의 이벤트 계약을 단일 SSOT로 통합했습니다.

---

## 2. 작업 범위

- **이벤트 계약 통합 (SSOT)**: 서버(`turn_stream_events.py`)와 클라이언트(`turn_stream.ts`) 간의 공통 이벤트 모델 정의
- **서버측 스트리밍 강화**: 입력 검증 실패 시에도 안전한 폴백과 에러 이벤트를 송출하도록 `turn.py` 리팩토링
- **클라이언트측 파서 및 핸들러 개선**: Zod를 사용한 수신 이벤트 이중 검증 및 네트워크 단절 시 클라이언트측 폴백 생성 로직 추가
- **용어 및 라벨 통일**: `AgentPhase` 및 `ValidationBadge` 상수를 사용하여 UI와 백엔드 간의 라벨 정합성 확보

---

## 3. 생성/수정 파일

| 파일 경로 | 유형 | 목적 |
| --------- | ---- | ---- |
| `backend/src/unknown_world/api/turn_stream_events.py` | 신규 | 스트림 이벤트 타입 및 Pydantic 모델 정의 (서버 SSOT) |
| `frontend/src/types/turn_stream.ts` | 신규 | Zod 기반 스트림 이벤트 스키마 및 타입 정의 (클라이언트 SSOT) |
| `backend/src/unknown_world/api/turn.py` | 수정 | 리팩토링된 이벤트를 사용한 스트리밍 및 에러 처리 강화 |
| `frontend/src/api/turnStream.ts` | 수정 | Zod 검증 기반 이벤트 디스패처 및 클라이언트 폴백 로직 적용 |
| `backend/src/unknown_world/orchestrator/mock.py` | 수정 | 폴백 생성 로직 고도화 |

---

## 4. 구현 상세

### 4.1 핵심 설계

**이벤트 계약 (RU-002-Q4)**:
- `StreamEventType`: `stage`, `badges`, `narrative_delta`, `final`, `error`, `repair` 6종으로 표준화.
- `StageStatus`: `start`, `complete`, `fail` 상태로 명확히 분리.

**서버측 견고성**:
- `_validate_and_parse_input`: 요청 본문 파싱 실패 시에도 `language`와 `economy_snapshot`을 최대한 추출하여 문맥에 맞는 폴백 제공.
- `RepairEvent`: 모델 검증 실패 시 `Auto-repair #n` 이벤트를 송출하여 사용자에게 복구 과정을 시각화.

**클라이언트측 안전 장치**:
- `NDJSONParser`: 라인 단위 버퍼링 파서로 네트워크 지연 및 파싱 실패에 강인한 구조 유지.
- `dispatchEvent`: 수신된 모든 이벤트를 Zod로 검증하며, 유효하지 않거나 알 수 없는 이벤트는 무시하고 로그만 기록 (전체 루프 보호).
- **클라이언트측 폴백**: 서버 응답이 `final`에 도달하지 못하고 끊길 경우, 요청 시점의 경제 스냅샷을 유지하며 안전하게 종료하는 기능 추가.

### 4.2 외부 영향 분석

- **UX**: Agent Console에서 표시되는 단계와 배지가 백엔드의 실제 검증 단계와 1:1로 일치하게 됨.
- **안정성**: 어떠한 예외 상황(입력 오류, 네트워크 오류, 모델 검증 실패)에서도 시스템이 멈추지 않고 항상 `final` 결과(폴백 포함)로 수렴함.

### 4.3 가정 및 제약사항

- NDJSON 이벤트의 순서는 기본적으로 서버의 송출 순서를 따르나, 클라이언트는 `final` 수신 전까지 모든 데이터를 축적/처리할 수 있어야 함.

---

## 5. 런북(Runbook) 정보

- **검증 절차**:
  1. 잘못된 JSON 본문으로 `POST /api/turn` 호출 -> `error` 및 `final`(폴백) 수신 확인.
  2. 정상 요청 시 `stage` 순서 및 `narrative_delta` 타자 효과 확인.
  3. 스트리밍 중간에 연결 강제 종료 -> 클라이언트 콘솔에서 에러 로그 및 폴백 UI 노출 확인.

---

## 6. 리스크 및 주의사항

- **이벤트 확장성**: 신규 이벤트 타입 추가 시 반드시 `turn_stream_events.py`와 `turn_stream.ts` 양쪽에 동기화가 필요함.
- **버전 호환성**: MVP에서는 최소 이벤트 셋을 유지하며, 향후 확장 시 하위 호환성을 고려한 Zod 스키마 설계 필요.

---

## 7. 다음 단계 안내

### 7.1 후속 작업

1. **CP-MVP-01**: 전체 시스템의 마일스톤 체크포인트 검증.
2. **U-016[Mvp]**: 실제 Gemini 모델 연동을 위한 Orchestrator 확장.

### 7.2 의존 단계 확인

- **선행 단계**: U-007, U-008 완료
- **후속 단계**: CP-MVP-01, U-016

---

## 8. 자체 점검 결과

- [x] 서버/클라이언트 간 이벤트 계약 통일 완료
- [x] 에러/폴백 시나리오에서도 스키마 준수 및 종료 보장
- [x] Zod 및 Pydantic을 이용한 이중 검증 구조 확립
- [x] 프롬프트/내부 추론 정보의 외부 노출 차단 확인

---

_본 보고서는 AI Agent에 의해 자동 생성되었습니다._
