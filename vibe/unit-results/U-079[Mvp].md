# U-079[Mvp]: 재화 부족 시 이미지 생성 허용 + 재화 획득 경로 다양화 개발 완료 보고서

## 메타데이터

- **작업 ID**: U-079[Mvp]
- **단계 번호**: 2.3
- **작성 일시**: 2026-02-08 15:45
- **담당**: AI Agent

---

## 1. 작업 요약

재화(Signal) 부족으로 인해 게임 흐름이 끊기는 문제를 해결하기 위해 경제 정책을 완화하고 재화 획득 경로를 다양화했습니다. 잔액 부족 시 이미지를 저해상도(FAST) 모델로 무료 생성하며, 아이템 판매 및 전용 액션 카드를 통해 플레이어가 능동적으로 재화를 회복할 수 있는 루프를 완성했습니다.

---

## 2. 작업 범위

- **경제 정책 완화**: 잔액 부족 시 이미지 생성 모델을 `QUALITY`에서 `FAST`로 자동 폴백 및 비용 0 처리
- **아이템 판매 시스템**: 인벤토리 아이템을 Signal로 환전할 수 있는 기능 추가
- **재화 획득 액션 카드**: `earn_` 접두사가 붙은 액션 카드에 특수 시각 효과(배지, 금색 테두리) 부여
- **GM 프롬프트 강화**: 잔액 부족 시 재화 획득 힌트 및 액션 카드를 생성하도록 지침 업데이트
- **UI/UX 개선**: Economy HUD 내 잔액 부족 경고 및 대안 안내 섹션 추가, 아이템 판매 토스트 알림 구현

---

## 3. 생성/수정 파일

| 파일 경로 | 유형 | 목적 |
| --- | --- | --- |
| `backend/src/unknown_world/config/economy.py` | 신규 | 경제 정책 관련 상수(`LOW_BALANCE_THRESHOLD` 등) 정의 |
| `backend/src/unknown_world/orchestrator/stages/render_helpers.py` | 수정 | 잔액 기반 모델 폴백 판정 로직 구현 |
| `backend/prompts/turn/turn_output_instructions.ko.md` | 수정 | GM의 재화 획득 액션 및 힌트 생성 지침 추가 |
| `frontend/src/components/EconomyHud.tsx` | 수정 | 잔액 부족 안내 및 대안(FAST 모델) 안내 UI 추가 |
| `frontend/src/components/InventoryPanel.tsx` | 수정 | 아이템 판매(Sell) 버튼 및 애니메이션 추가 |
| `frontend/src/components/ActionDeck.tsx` | 수정 | `earn_` 카드 특수 배지 및 스타일 적용 |
| `frontend/src/stores/economyStore.ts` | 수정 | 잔액 상태 감지 및 `isLowBalance` 플래그 관리 |
| `frontend/src/stores/worldStore.ts` | 수정 | `sellItem` 액션 및 토스트 메시지 시스템 연동 |

---

## 4. 구현 상세

### 4.1 핵심 설계

**주요 로직**:

- **백엔드 폴백**: `determine_image_model_and_cost` 함수에서 플레이어 잔액을 체크하여 `cost > balance`일 경우 `FAST` 모델을 선택하고 비용을 `0`으로 오버라이드합니다.
- **아이템 판매**: 프론트엔드 `worldStore`에서 `sellItem` 호출 시 아이템 삭제 후 Signal을 증가시키며, `ledger`에 "아이템 판매" 기록을 남깁니다.
- **GM 힌트**: `turn_output_instructions`에 "플레이어 잔액이 낮을 때 내러티브에 획득 경로 힌트를 포함하라"는 강한 지침을 삽입하여 자연스러운 가이드를 유도합니다.

**설계 패턴/원칙**:

- **Graceful Degradation**: 기능 차단 대신 품질을 낮춰(FAST 모델) 서비스 연속성을 보장합니다.
- **Visual Feedback**: 경고 아이콘, 색상 변화, 토스트 알림을 통해 경제 상태 변화를 명확히 인지시킵니다.

### 4.2 외부 영향 분석

- **데이터/파일 시스템**: `saveGame.ts`에 잔액 부족 상태 및 판매 기록이 저장되어 세이브 로드 시에도 유지됩니다.
- **빌드/의존성**: 추가적인 외부 라이브러리 도입 없이 기존 기술 스택 내에서 구현되었습니다.

### 4.3 가정 및 제약사항

- **아이템 가격**: 현재 MVP 단계에서는 모든 아이템의 판매 가격이 `5 Signal`로 고정되어 있습니다. (MMP에서 차등화 예정)
- **크레딧 상한**: 현재는 무제한 FAST 생성이 가능하지만, 남용 방지를 위해 향후 횟수 제한이나 크레딧 시스템 고도화가 필요할 수 있습니다.

---

## 5. 런북(Runbook) 정보

- **파일 경로**: `vibe/unit-runbooks/U-079-low-balance-image-currency-runbook.md`
- **실행 결과**: 런북에 정의된 4가지 시나리오(잔액 부족 안내, 아이템 판매, 액션 카드 배지, 백엔드 폴백) 검증 완료.

---

## 6. 리스크 및 주의사항

- **경제 밸런스**: 아이템 판매가 너무 쉬울 경우 게임의 긴장감이 낮아질 수 있으므로 향후 드롭률과 가격의 밸런싱이 중요합니다.
- **GM 의존성**: 재화 획득 액션 카드 생성은 GM의 판단에 의존하므로, 완전 고갈 상황을 대비한 고정 시스템(휴식 등)과의 조화가 필요합니다.

---

## 7. 다음 단계 안내

### 7.1 후속 작업

1. **경제 밸런스 테스트**: 다양한 시나리오에서 재화 고갈 및 회복 속도 측정.
2. **MMP 확장**: 아이템 등급별 판매 가격 차등화 및 "크레딧(빚)" 시스템 도입 검토.

### 7.2 의존 단계 확인

- **선행 단계**: U-014, U-019, U-078 완료됨.
- **후속 단계**: CP-MVP-03 (경제 루프 통합 데모)

---

## 8. 자체 점검 결과

- [x] 런북 기반 요구사항 충족 확인
- [x] Repomix 최신 구조 반영 확인
- [x] 아키텍처/네이밍/경로 일관성 유지
- [x] 파괴적 변경/리스크/가정 명시

---

_본 보고서는 AI Agent에 의해 자동 생성되었습니다._
