# U-048[Mvp]: Mock Orchestrator - 액션 echo/내러티브 템플릿 개선 개발 완료 보고서

## 메타데이터

- **작업 ID**: U-048[Mvp]
- **단계 번호**: 4.8 (MVP)
- **작성 일시**: 2026-01-30 14:30
- **담당**: AI Agent

---

## 1. 작업 요약

Mock 모드에서 내러티브가 `...라고 말했습니다`와 같은 고정 대사 템플릿으로 출력되던 문제를 해결하고, 입력 타입(클릭, 드롭, 액션 카드 등)에 맞는 **행동 로그 프리픽스**를 도입하였습니다. 또한, 동일 입력에 대해 동일 문장이 반복되는 것을 완화하기 위해 **결정적 다양성(Deterministic Diversity)**을 확보하는 per-turn RNG 로직을 구현하였습니다.

---

## 2. 작업 범위

- **입력 타입 분류 시스템 도입**: DROP, CLICK, ACTION, FREE_TEXT로 입력 유형을 자동 감지.
- **행동 로그 템플릿 정의**: 각 언어(KO/EN) 및 입력 타입별로 다양한 프리픽스 템플릿(예: `[조사]`, `[실행]`, `[사용]`)을 정의.
- **결정적 다양성(Deterministic Diversity) 구현**: base seed와 입력 특징(text, action_id, object_id 등)을 해시하여 per-turn seed를 생성, 입력이 조금만 달라져도 문장과 비용/리스크가 결정적으로 변화하도록 개선.
- **종합 유닛 테스트**: 새로운 내러티브 로직 및 인바리언트(경제, 좌표, 언어)를 검증하는 600라인 이상의 테스트 코드 작성.

---

## 3. 생성/수정 파일

| 파일 경로 | 유형 | 목적 |
| --- | --- | --- |
| `backend/src/unknown_world/orchestrator/mock.py` | 수정 | 내러티브 템플릿 분리 및 per-turn RNG 로직 적용 |
| `backend/tests/unit/orchestrator/test_mock_orchestrator.py` | 신규 | 프리픽스, 결정적 다양성, 인바리언트 검증 테스트 |
| `vibe/unit-runbooks/U-048-mock-narrative-improvement-runbook.md` | 신규 | 수동 검증 및 시나리오 테스트 런북 |
| `vibe/commands/test-exec.md` (외 2건) | 수정 | 테스트 실행 명령 가이드의 경로 및 규칙 현행화 |

---

## 4. 구현 상세

### 4.1 핵심 설계

**주요 함수 및 로직**:

- `_detect_input_type(turn_input)`: `TurnInput`의 필드를 분석하여 우선순위(DROP > CLICK > ACTION > FREE_TEXT)에 따라 타입을 반환합니다.
- `_compute_turn_seed(base_seed, turn_input)`: SHA-256 해시를 사용하여 입력값에 따른 고유 시드를 생성합니다. 이는 재현성을 유지하면서도 입력별 변화를 제공합니다.
- `_format_action_log_prefix(...)`: RNG를 사용하여 정의된 템플릿 중 하나를 선택하고, 아이템/오브젝트 ID를 삽입하여 내러티브를 구성합니다.

**설계 패턴/원칙**:
- **RULE-002 (채팅 UX 금지)**: "...말했습니다" 대신 "[행동] ..." 형태의 로그 방식을 사용하여 게임 시스템 느낌을 강화함.
- **결정적 재현성**: 무작위 랜덤이 아닌 시드 기반 난수를 사용하여 디버깅 및 시나리오 재현이 가능하게 함.

### 4.2 외부 영향 분석

- **데이터/파일 시스템**: 영향 없음 (메모리 내 연산).
- **권한/보안**: 영향 없음.
- **빌드/의존성**: Python 표준 라이브러리(`hashlib`) 사용으로 추가 의존성 없음.

---

## 5. 런북(Runbook) 정보

- **파일 경로**: `vibe/unit-runbooks/U-048-mock-narrative-improvement-runbook.md`
- **실행 결과**: `action_id`, `click`, `drop` 등 각 시나리오별로 의도한 프리픽스가 정상 출력됨을 확인.
- **참조**: 상세 테스트 절차는 위 런북 파일 참조.

---

## 6. 리스크 및 주의사항

- **내러티브 고갈**: 현재 Mock 데이터셋이 고정되어 있어 장기 플레이 시 여전히 반복을 느낄 수 있으나, 프리픽스 조합을 통해 체감 반복율을 대폭 낮춤.

---

## 7. 다음 단계 안내

### 7.1 후속 작업

1. **U-049[Mvp]**: UI Narrative Feed 컴포넌트 개선 (프리픽스 강조 렌더링)
2. **U-050[Mvp]**: 전체 통합 데모 시나리오 검증

### 7.2 의존 단계 확인

- **선행 단계**: U-007[Mvp] (완료)
- **후속 단계**: UI/UX 폴리시 적용 및 시나리오 리플레이 단계

---

## 8. 자체 점검 결과

- [x] 런북 기반 요구사항 충족 확인
- [x] Repomix 최신 구조 반영 확인
- [x] 아키텍처/네이밍/경로 일관성 유지
- [x] 파괴적 변경/리스크/가정 명시

---

_본 보고서는 AI Agent에 의해 자동 생성되었습니다._
