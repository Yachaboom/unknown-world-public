# U-124[Mvp]: 프로필별 첫 번째 씬 이미지 사전 생성 개발 완료 보고서

## 메타데이터

- **작업 ID**: U-124[Mvp]
- **단계 번호**: 2.4
- **작성 일시**: 2026-02-09 10:15
- **담당**: AI Agent

---

## 1. 작업 요약

데모 프로필 3종(Narrator, Explorer, Tech)의 첫 번째 씬 이미지를 `nanobanana-mcp`를 활용하여 사전 생성하고, 프로필 시작 즉시 Scene Canvas에 표시되도록 구현했습니다. 이를 통해 첫 턴의 이미지 생성 지연(10~20초) 없이 즉각적인 게임 몰입감을 제공하며, 백엔드 참조 이미지 파이프라인을 통해 첫 턴과의 시각적 연속성을 확보했습니다.

---

## 2. 작업 범위

- **이미지 에셋 생성**: `nanobanana-mcp`를 활용하여 프로필별 분위기에 맞는 1024x576 WebP 이미지 3종 생성
- **프론트엔드 데이터 연동**: `demoProfiles.ts`에 `initialSceneImageUrl` 필드 추가 및 경로 할당
- **세션 라이프사이클 수정**: `sessionLifecycle.ts`에서 프로필 시작 시 `sceneState`를 사전 생성 이미지로 즉시 초기화
- **참조 이미지 파이프라인 연결**: `turnRunner.ts`에 `toBackendReferenceUrl()` 변환 로직을 추가하여 정적 에셋을 백엔드 참조 이미지로 활용
- **백엔드 자동 시드**: `backend/src/unknown_world/storage/seed.py`에서 WebP → PNG 변환 및 `main.py` lifespan 연동
- **에셋 최적화**: WebP Q80 포맷을 적용하여 이미지당 200KB 이하(실측 43~58KB) 성능 예산 준수

---

## 3. 생성/수정 파일

| 파일 경로 | 유형 | 목적 |
| --- | --- | --- |
| `frontend/public/ui/scenes/scene-narrator-start.webp` | **신규** | Narrator 프로필 첫 씬 이미지 (서재) |
| `frontend/public/ui/scenes/scene-explorer-start.webp` | **신규** | Explorer 프로필 첫 씬 이미지 (동굴) |
| `frontend/public/ui/scenes/scene-tech-start.webp` | **신규** | Tech 프로필 첫 씬 이미지 (실험실) |
| `frontend/src/data/demoProfiles.ts` | 수정 | 프로필 초기 상태에 `initialSceneImageUrl` 필드 추가 |
| `frontend/src/save/sessionLifecycle.ts` | 수정 | 세션 시작 시 `sceneState`를 사전 이미지로 초기화 |
| `frontend/src/turn/turnRunner.ts` | 수정 | 프론트엔드 URL → 백엔드 API 참조 URL 변환 로직 추가 |
| `backend/src/unknown_world/storage/seed.py` | 신규 | WebP를 백엔드용 PNG로 자동 변환하는 시드 기능 |
| `backend/src/unknown_world/main.py` | 수정 | 서버 시작(lifespan) 시 `seed_scene_images()` 호출 추가 |
| `frontend/public/ui/manifest.json` | 수정 | 신규 씬 이미지 에셋 등록 |

---

## 4. 구현 상세

### 4.1 핵심 설계

- **Visual Continuity (시각적 연속성)**: `toBackendReferenceUrl()`은 `/ui/scenes/scene-xxx.webp` 형식을 `/api/image/file/scene-xxx`로 변환합니다. 이를 통해 첫 턴 전송 시 `previous_image_url`로 전달되어 Gemini가 이전 장면을 참조할 수 있게 합니다.
- **Zustand State Safety**: `sessionLifecycle.ts`에서 `sceneState`를 교체할 때 `processingPhase: 'idle'`, `imageLoading: false` 등 필수 필드를 명시적으로 포함하여, shallow merge로 인한 입력 잠금(Input Lock) 현상을 방지했습니다.
- **Dual-Format Pipeline**: 사용자는 고효율 WebP를 보고, Gemini는 백엔드에서 시딩된 무손실/표준 PNG를 참조하는 이중 구조를 채택했습니다.

### 4.2 외부 영향 분석

- **에셋 예산**: 전체 이미지 합산 156KB로, PRD 9.7 에셋 예산(1MB)의 15.6%만 사용하여 매우 효율적입니다.
- **첫인상 개선**: "채팅 앱"이 아닌 "그래픽 기반 게임"으로서의 정체성을 프로필 선택 직후 즉시 어필합니다.

### 4.3 가정 및 제약사항

- **ImageMagick/Pillow**: 백엔드 시딩을 위해 `Pillow` 라이브러리가 필요하며, `backend/pyproject.toml`에 반영되었습니다.
- **정적 경로**: `/ui/scenes/` 경로는 Vite public 디렉토리 구조와 일치해야 합니다.

---

## 5. 런북(Runbook) 정보

- **파일 경로**: `vibe/unit-runbooks/U-124-profile-scene-images-runbook.md`
- **실행 결과**: 3종 프로필 각각의 이미지 즉시 표시 및 첫 턴 참조 이미지 전환 정상 작동 확인.

---

## 6. 리스크 및 주의사항

- **스타일 불일치**: 사전 생성 이미지(oil-painting 스타일)와 Gemini 런타임 생성 이미지의 화풍 차이가 발생할 수 있으나, 참조 이미지 전달을 통해 이를 최소화했습니다.

---

## 7. 다음 단계 안내

### 7.1 후속 작업

1. **U-119[Mmp]**: WIG 폴리시 기반 이미지 품질 및 스타일 최종 점검
2. **CP-MVP-03**: 데모 통합 테스트 시 "즉시 로딩" 경험 검증

---

## 8. 자체 점검 결과

- [x] 3종 프로필 고유 이미지 표시 확인
- [x] 1024x576 (Gemini 1K 매칭) 해상도 준수
- [x] WebP 최적화 및 에셋 예산 준수
- [x] 첫 턴 참조 이미지 URL 변환 로직 검증

---

_본 보고서는 AI Agent에 의해 자동 생성되었습니다._
