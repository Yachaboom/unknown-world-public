# U-063[Mvp] 프론트엔드 턴 실행 후 재화 잔액 버그 수정 개발 완료 보고서

## 메타데이터

- **작업 ID**: U-063[Mvp]
- **단계 번호**: 2.3 (품질 개선 및 버그 수정)
- **작성 일시**: 2026-02-02 14:15
- **담당**: AI Agent

---

## 1. 작업 요약

턴 실행 중 스키마 검증 실패 시 호출되는 폴백 응답에서 재화 잔액(Signal/Shard)이 0으로 초기화되는 버그를 수정했습니다. 이제 폴백 응답 생성 시 현재 재화 스냅샷을 참조하여 잔액을 안전하게 유지합니다.

---

## 2. 작업 범위

- [x] **스키마 폴백 로직 수정**: `createFallbackTurnOutput` 함수에 `economySnapshot` 파라미터 추가 및 적용
- [x] **스트리밍 클라이언트 연동**: `dispatchEvent`에서 현재 재화 스냅샷을 폴백 생성기로 전달하도록 수정
- [x] **안전 파이프라인 강화**: 네트워크 에러 시 생성되는 클라이언트 측 폴백에서도 잔액 보존 정책 적용
- [x] **부채 로그 동기화**: `vibe/debt-log.md`에 해결 완료 상태 반영

---

## 3. 생성/수정 파일

_(Repomix 결과 및 실제 파일 시스템 분석 기반)_

| 파일 경로 | 유형 | 목적 |
| --- | --- | --- |
| `frontend/src/schemas/turn.ts` | 수정 | 폴백 생성 함수 및 안전 파싱 함수에 `economySnapshot` 파라미터 추가 |
| `frontend/src/api/turnStream.ts` | 수정 | 스트림 이벤트 분배 시 현재 재화 스냅샷을 폴백 로직에 주입 |
| `vibe/debt-log.md` | 수정 | 해당 이슈 해결 완료 표시 및 상세 내용 기록 |

---

## 4. 구현 상세

### 4.1 핵심 설계

**폴백 재화 보존 정책 (RULE-005)**:
- 검증 실패(`schema_fail`)는 시스템의 일시적인 오류일 뿐 사용자의 재화 권리를 박탈해서는 안 됩니다.
- 턴 입력 시 서버로 보낸 `economy_snapshot`을 로컬 메모리에 유지했다가, 폴백 응답 구성 시 `balance_after` 값으로 재사용합니다.

**주요 함수 변경**:
- `createFallbackTurnOutput(language, repairCount, errorMessage, economySnapshot)`
- `safeParseTurnOutput(data, language, repairCount, economySnapshot)`

### 4.2 외부 영향 분석

- **데이터/파일 시스템**: 영향 없음 (메모리 내 상태 관리 개선)
- **권한/보안**: 영향 없음
- **빌드/의존성**: 영향 없음

---

## 5. 런북(Runbook) 정보

- **파일 경로**: `vibe/unit-runbooks/U-063-economy-balance-fix-runbook.md`
- **실행 결과**: 런북의 시나리오 A(정상 차감), B(폴백 시 유지), C(연속 실행)를 통해 재화 정합성 검증 완료
- **참조**: 상세 실행 방법은 위 런북 파일 참조

---

## 6. 리스크 및 주의사항

- **재화 동기화 시점**: 현재는 "입력 시점의 스냅샷"을 폴백의 "결과 잔액"으로 사용하므로, 폴백이 발생한 턴의 비용은 0으로 처리됩니다 (사용자에게 유리한 정책).

---

## 7. 다음 단계 안내

### 7.1 후속 작업

1. **U-064[Mvp]**: ⚡Gemini 이미지 생성 API 호출 방식 수정 (Real 모드)
2. **U-065[Mvp]**: ⚡TurnOutput 스키마 단순화 (Gemini API 제한 대응)

### 7.2 의존 단계 확인

- **선행 단계**: U-055[Mvp] (이슈 발견)
- **후속 단계**: CP-MVP-03 (10분 데모 루프에서 최종 확인)

---

## 8. 자체 점검 결과

- [x] 런북 기반 요구사항 충족 확인 (재화 0 리셋 방지)
- [x] Repomix 최신 구조 반영 확인
- [x] 아키텍처/네이밍/경로 일관성 유지
- [x] RULE-005 재화 인바리언트 준수

---

_본 보고서는 AI Agent에 의해 자동 생성되었습니다._
