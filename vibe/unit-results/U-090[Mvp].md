# U-090[Mvp]: 핫스팟 생성을 정밀분석 전용으로 제한 (기본 턴 핫스팟 생성 금지) 개발 완료 보고서

## 메타데이터

- **작업 ID**: U-090[Mvp]
- **단계 번호**: 2.3
- **작성 일시**: 2026-02-07 16:50
- **담당**: AI Agent

---

## 1. 작업 요약

핫스팟(SceneObject/ui.objects[])의 생성을 "정밀분석" 액션 전용으로 제한하여 이미지-핫스팟 간의 시각적 정합성을 확보했습니다. 일반 턴에서 GM이 임의로 핫스팟을 생성하는 것을 서버에서 강제 필터링하고, 프론트엔드에서는 장면 전환 시 핫스팟을 초기화하며 정밀분석 결과만 유지/병합하는 지능형 상태 관리 정책을 적용했습니다.

---

## 2. 작업 범위

- **GM 프롬프트 강화**: 일반 턴에서 `ui.objects` 생성을 금지하고 정밀분석을 통해서만 생성하도록 지침 추가
- **서버 측 강제 필터링**: `resolve.py` 및 `verify.py`에서 비정밀분석 턴의 핫스팟 생성을 감지하여 제거하는 안전장치 구현
- **프론트엔드 상태 정책**: `worldStore.ts`에서 장면 전환(새 이미지 생성) 시 핫스팟 초기화, 일반 턴 유지, 정밀분석 결과 병합 로직 구현
- **검증 체계**: 백엔드/프론트엔드 단위 테스트를 통해 정책 준수 여부 전수 검증

---

## 3. 생성/수정 파일

| 파일 경로 | 유형 | 목적 |
| --- | --- | --- |
| `backend/src/unknown_world/orchestrator/stages/resolve.py` | 수정 | 비정밀분석 턴의 핫스팟 생성 강제 필터링 (Option A) |
| `backend/src/unknown_world/orchestrator/stages/verify.py` | 수정 | 핫스팟 누출 감지 및 제거 (이중 안전장치) |
| `frontend/src/stores/worldStore.ts` | 수정 | 장면 전환 시 초기화 및 핫스팟 병합/유지 정책 반영 |
| `backend/prompts/turn/turn_output_instructions.ko.md` | 수정 | GM 핫스팟 생성 정책 지침 추가 |
| `backend/prompts/turn/turn_output_instructions.en.md` | 수정 | 동일 지침 영문 추가 |
| `backend/tests/unit/orchestrator/test_u090_hotspot_restriction.py` | 신규 | 서버 필터링 로직 단위 테스트 |
| `frontend/src/stores/worldStore.test.ts` | 수정 | 프론트엔드 핫스팟 관리 정책 테스트 추가 |

---

## 4. 구현 상세

### 4.1 핵심 설계

**서버 필터링 (Resolve Stage)**:
- `_is_vision_trigger(ctx)`를 통해 정밀분석 액션 여부를 판별합니다.
- 정밀분석이 아닌 턴에서 `ctx.output.ui.objects`가 존재할 경우, 이를 조용히 제거(`[]`)하고 경고 로그를 남깁니다.

**프론트엔드 상태 정책 (WorldStore)**:
- `isNewImageGeneration` 판정: `render.image_url`이 있거나 `image_job.should_generate`가 `true`인 경우 장면 전환으로 간주합니다.
- **장면 전환 시**: `newSceneObjects = []` (초기화)
- **정밀분석 결과 수신 시**: 기존 `sceneObjects`와 새 `objects`를 ID 기준으로 병합합니다.
- **일반 턴 시**: 기존 `sceneObjects`를 그대로 유지합니다.

### 4.2 외부 영향 분석

- **데이터/파일 시스템**: 기존 세이브 데이터의 핫스팟 정보는 유지되나, 장면 전환 시 클라이언트 사이드에서 초기화됩니다.
- **UI/UX**: 사용자는 장면이 바뀌면 핫스팟이 사라지는 것을 보게 되며, "정밀분석"을 통해 다시 찾아내야 하는 게임 메커닉이 강화되었습니다.

### 4.3 가정 및 제약사항

- **장면 전환 판정**: `should_generate` 플래그를 기준으로 하므로, 이미지가 생성되지 않는 단순 이동 등에서는 핫스팟이 유지될 수 있습니다. (PRD 정책 준수)
- **ID 기반 병합**: 정밀분석을 여러 번 수행할 경우 동일한 ID의 오브젝트는 최신 정보로 덮어씌워집니다.

---

## 5. 런북(Runbook) 정보

- **파일 경로**: `vibe/unit-runbooks/U-090-hotspot-restriction-runbook.md`
- **실행 결과**: 일반 턴 필터링, 정밀분석 추가, 장면 전환 초기화 시나리오 모두 검증 완료

---

## 6. 리스크 및 주의사항

- GM이 프롬프트를 무시하고 핫스팟을 생성하려 할 때 서버가 이를 차단하므로, 내러티브에서 언급된 오브젝트가 핫스팟으로 나타나지 않을 수 있습니다. 이는 "정밀분석 권장" 내러티브로 유도됩니다.

---

## 7. 다음 단계 안내

### 7.1 후속 작업

1. **U-091**: 런타임 rembg 파이프라인 제거 및 단순화
2. **CP-MVP-03**: 10분 데모 루프에서 정밀분석-핫스팟 정책 최종 확인

### 7.2 의존 단계 확인

- **선행 단계**: U-076[Mvp] 완료
- **후속 단계**: U-091[Mvp]

---

## 8. 자체 점검 결과

- [x] 런북 기반 요구사항 충족 확인
- [x] Repomix 최신 구조 반영 확인
- [x] 서버 필터링 및 프론트 상태 정책 일치 확인
- [x] ko/en 지침 동시 업데이트 완료

---

_본 보고서는 AI Agent에 의해 자동 생성되었습니다._
