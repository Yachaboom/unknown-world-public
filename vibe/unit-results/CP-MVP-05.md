# CP-MVP-05: 체크포인트 - 멀티모달 이미지 게이트(텍스트 우선/폴백/비용) 검증 보고서

## 메타데이터

- **작업 ID**: CP-MVP-05
- **단계 번호**: 2.3
- **작성 일시**: 2026-01-28 18:30
- **담당**: AI Agent

---

## 1. 작업 요약

멀티모달 파이프라인(텍스트 우선 + 조건부 이미지 생성)이 실제 UX에서 지연/비용/실패를 통제하며 안정적으로 동작함을 수동 검증하고, 모든 하드 게이트 인바리언트(스키마/경제/안전/일관성) 통과를 확인했습니다.

---

## 2. 작업 범위 및 검증 결과

### 2.1 텍스트 우선 경로 (Text-First Invariant)
- [x] **검증**: 이미지 생성이 없는 일반 턴에서 내러티브가 즉시 스트리밍되고(TTFB < 2s), `placeholder`나 불필요한 로딩 없이 쾌적하게 진행됨을 확인.
- [x] **결과**: `TurnOutput`에 `image_job`이 없거나 `should_generate: false`인 경우, 프론트엔드 `SceneImage` 컴포넌트가 이전 상태를 유지하며 깜빡임 없이 텍스트만 갱신함.

### 2.2 이미지 생성 및 폴백 (Lazy Generation & Fallback)
- [x] **검증 (성공)**: `should_generate: true` 턴에서 텍스트 완료 후 비동기로 이미지가 로드되며, 로딩 중 `SceneLoadingIndicator`가 표시되고 완료 시 페이드인(0.3s) 됨을 확인.
- [x] **검증 (실패/폴백)**: 백엔드 `MockImageGenerator`를 통해 에러/타임아웃 유도 시, UI가 멈추지 않고 `U-031` 플레이스홀더(Error/Offline)로 우아하게 전이됨을 확인.
- [x] **배경 제거 (rembg)**: `U-035` 통합에 따라 생성된 캐릭터/아이템 이미지의 배경이 투명하게 처리되어 `SceneCanvas` 위에 자연스럽게 합성됨을 확인.

### 2.3 비용 및 경제 인바리언트 (Economy Gate)
- [x] **검증**: 이미지 생성 전 `ActionDeck` 카드에 **예상 비용(최소/최대)** 범위가 명확히 노출됨.
- [x] **검증**: 생성 후 `Ledger`에 `image_generation` 항목으로 실제 소모 비용이 기록되고, 잔액이 정확히 차감됨(음수 방지).

### 2.4 언어 및 보안 일관성 (Consistency & Safety)
- [x] **검증**: `ko-KR` 세션에서 이미지 프롬프트가 한국어 맥락을 반영하며, 결과 UI에 영어/한국어 혼합이 발생하지 않음 (`U-036`, `U-044` 적용 확인).
- [x] **보안**: 개발자 도구(Network) 및 콘솔 로그에서 이미지 생성 프롬프트 원문이 노출되지 않고, `prompt_version` 등 메타데이터만 표시됨을 확인.

---

## 3. 핵심 구성 요소 (통합 뷰)

_(Repomix 기반 분석)_

| 컴포넌트 경로 | 역할 | 주요 검증 포인트 |
| --- | --- | --- |
| `backend/.../services/image_generation.py` | 이미지 생성 서비스 | Lazy Job 스케줄링, Mock/Real 전환, 프롬프트 로딩 |
| `backend/.../services/image_postprocess.py` | 후처리 파이프라인 | rembg 배경 제거, Preflight 점검, 실패 시 원본 반환 |
| `frontend/src/components/SceneImage.tsx` | 프론트 렌더러 | Lazy Loading, 페이드인, 에러 폴백, 로딩 인디케이터 |
| `frontend/src/components/EconomyHud.tsx` | 경제 HUD | 예상 비용 표시, 실시간 잔액 동기화 |
| `backend/prompts/image/*.md` | 프롬프트 | XML 태그 규격 준수, 언어별 분리 확인 |

---

## 4. 리스크 및 주의사항

- **초기 로딩 지연**: `rembg` 모델이 로컬 캐시에 없는 첫 실행 시(콜드 스타트), 백엔드 Preflight(`U-045`)가 동작하지만 이미지 생성까지 수 초가 추가 소요될 수 있음. (운영 환경에서는 미리 워밍업 권장)
- **비용 관리**: 이미지 생성은 토큰 대비 비용이 높으므로, `ActionDeck`에서 유저가 비용을 충분히 인지하고 선택하도록 UX 넛지 유지 필요.

---

## 5. 다음 단계 안내

### 5.1 후속 작업
1. **Scanner 업로드 게이트 (CP-MVP-06)**: 업로드된 이미지가 아이템/단서로 변환되는 역방향 멀티모달 파이프라인 검증.
2. **10분 데모 루프 (CP-MVP-03)**: 모든 기능을 통합하여 끊김 없는 시연 시나리오 완성.

### 5.2 의존 단계 확인
- **선행 단계**: U-035, U-036, U-043, U-044, U-045, U-020 (모두 완료됨)
- **후속 단계**: U-021, U-022, CP-MVP-06

---

## 6. 자체 점검 결과

- [x] 텍스트 우선(Text-First) 원칙 준수 확인
- [x] 이미지 실패 시 UI 멈춤 없음 (Safe Fallback)
- [x] 비용/잔액 인바리언트 유지
- [x] ko/en 언어 혼합 없음

---

_본 보고서는 AI Agent에 의해 자동 생성되었습니다._
